<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Content-Centric Networking in C: lib/encodedecodetest.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_3670a7f7f4c45e09473a6615bf7486a4.html">lib</a>
  </div>
</div>
<div class="contents">
<h1>encodedecodetest.c</h1><a href="encodedecodetest_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**</span>
<a name="l00002"></a>00002 <span class="comment"> * @file encodedecodetest.c</span>
<a name="l00003"></a>00003 <span class="comment"> * Unit tests for CCNx C library.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * A CCNx program.</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright (C) 2009-2010 Palo Alto Research Center, Inc.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This work is free software; you can redistribute it and/or modify it under</span>
<a name="l00010"></a>00010 <span class="comment"> * the terms of the GNU General Public License version 2 as published by the</span>
<a name="l00011"></a>00011 <span class="comment"> * Free Software Foundation.</span>
<a name="l00012"></a>00012 <span class="comment"> * This work is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<a name="l00013"></a>00013 <span class="comment"> * WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<a name="l00014"></a>00014 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * for more details. You should have received a copy of the GNU General Public</span>
<a name="l00016"></a>00016 <span class="comment"> * License along with this program; if not, write to the</span>
<a name="l00017"></a>00017 <span class="comment"> * Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,</span>
<a name="l00018"></a>00018 <span class="comment"> * Boston, MA 02110-1301, USA.</span>
<a name="l00019"></a>00019 <span class="comment"> */</span>
<a name="l00020"></a>00020  
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="code" href="ccn_8h.html" title="This is the low-level interface for CCNx clients.">ccn/ccn.h</a>&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="code" href="bloom_8h.html" title="Bloom filters.">ccn/bloom.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="uri_8h.html" title="ccn-scheme uri conversions.">ccn/uri.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="digest_8h.html" title="Message digest interface.">ccn/digest.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="code" href="keystore_8h.html" title="KEYSTORE interface.">ccn/keystore.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="signing_8h.html" title="Message signing interface.">ccn/signing.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="random_8h.html" title="Pseudo-random number generation.">ccn/random.h</a>&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="keyword">struct </span>path {
<a name="l00038"></a>00038     <span class="keywordtype">int</span> count;
<a name="l00039"></a>00039     <span class="keywordtype">char</span> * comps[];
<a name="l00040"></a>00040 };
<a name="l00041"></a><a class="code" href="encodedecodetest_8c.html#a7e81156d9f005b0e25e37d4444cb60d3">00041</a> <span class="keyword">struct </span>path * <a class="code" href="encodedecodetest_8c.html#a7e81156d9f005b0e25e37d4444cb60d3">path_create</a>(<span class="keywordtype">char</span> * strpath) {
<a name="l00042"></a>00042     <span class="keywordtype">char</span> * p = strpath;
<a name="l00043"></a>00043     <span class="keywordtype">int</span> slash_count = 0;
<a name="l00044"></a>00044     <span class="keywordtype">int</span> i = 0;
<a name="l00045"></a>00045     <span class="keyword">struct </span>path * path;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <span class="keywordflow">if</span> (strlen(strpath) &lt; 1) {
<a name="l00048"></a>00048         <span class="keywordflow">return</span> NULL;
<a name="l00049"></a>00049     }
<a name="l00050"></a>00050     <span class="keywordflow">while</span> (*p != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l00051"></a>00051         <span class="keywordflow">if</span> (*p++ == <span class="charliteral">&apos;/&apos;</span>) slash_count++;
<a name="l00052"></a>00052     }
<a name="l00053"></a>00053     path = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) + <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)*(slash_count+1));
<a name="l00054"></a>00054     path-&gt;comps[0] = strtok(strdup(strpath), <span class="stringliteral">&quot;/&quot;</span>);
<a name="l00055"></a>00055     path-&gt;count = 0;
<a name="l00056"></a>00056     <span class="keywordflow">while</span> (path-&gt;comps[i++]) {
<a name="l00057"></a>00057         path-&gt;comps[i] = strtok(NULL, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l00058"></a>00058         path-&gt;count++;
<a name="l00059"></a>00059     }
<a name="l00060"></a>00060     <span class="keywordflow">return</span> path;
<a name="l00061"></a>00061 }
<a name="l00062"></a><a class="code" href="encodedecodetest_8c.html#a2b07b81d00b3e3f34913d651bf068e48">00062</a> <span class="keywordtype">void</span> <a class="code" href="encodedecodetest_8c.html#a2b07b81d00b3e3f34913d651bf068e48">path_destroy</a>(<span class="keyword">struct</span> path **path) {
<a name="l00063"></a>00063     free(*path);
<a name="l00064"></a>00064     *path = NULL;
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="keywordtype">int</span> 
<a name="l00068"></a><a class="code" href="encodedecodetest_8c.html#a67f1e872f0736c6acc80d66da7ea0cf2">00068</a> <a class="code" href="encodedecodetest_8c.html#a67f1e872f0736c6acc80d66da7ea0cf2">encode_message</a>(<span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *message, <span class="keyword">struct</span> path * name_path, <span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> len, <span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *signed_info, <span class="keyword">const</span> <span class="keywordtype">void</span> *pkey) {
<a name="l00069"></a>00069     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *path = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00070"></a>00070     <span class="keywordtype">int</span> i;
<a name="l00071"></a>00071     <span class="keywordtype">int</span> res;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     <span class="keywordflow">if</span> (path == NULL || <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(path) == -1) {
<a name="l00074"></a>00074         fprintf(stderr, <span class="stringliteral">&quot;Failed to allocate or initialize content path\n&quot;</span>);
<a name="l00075"></a>00075         <span class="keywordflow">return</span> -1;
<a name="l00076"></a>00076     }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     <span class="keywordflow">for</span> (i = 0; i &lt; name_path-&gt;count; i++) {
<a name="l00079"></a>00079         <a class="code" href="ccn_8h.html#aec5620dc4689a663ea7181cdebeda4d0" title="Add a Component that is a NUL-terminated string.">ccn_name_append_str</a>(path, name_path-&gt;comps[i]);
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     res = <a class="code" href="ccn_8h.html#a4f098bd83d6b576455bd62b6a3233492" title="Encode and sign a ContentObject.">ccn_encode_ContentObject</a>(message, path, signed_info, data, len, NULL, pkey);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="keywordflow">if</span> (res != 0) {
<a name="l00085"></a>00085         fprintf(stderr, <span class="stringliteral">&quot;Failed to encode ContentObject\n&quot;</span>);
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;path);
<a name="l00089"></a>00089     <span class="keywordflow">return</span> (res);
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="keywordtype">int</span> 
<a name="l00093"></a><a class="code" href="encodedecodetest_8c.html#acb58d3170eda3600d8769be8882116eb">00093</a> <a class="code" href="encodedecodetest_8c.html#acb58d3170eda3600d8769be8882116eb">decode_message</a>(<span class="keyword">struct</span> <a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *message, <span class="keyword">struct</span> path * name_path, <span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> len, <span class="keyword">const</span> <span class="keywordtype">void</span> *verkey) {
<a name="l00094"></a>00094     <span class="keyword">struct </span><a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> content;
<a name="l00095"></a>00095     <span class="keyword">struct </span><a class="code" href="structccn__indexbuf.html">ccn_indexbuf</a> *comps = <a class="code" href="indexbuf_8h.html#a00ef00b3c7cbd2122bcdad019bd285c6" title="Create a new indexbuf.">ccn_indexbuf_create</a>();
<a name="l00096"></a>00096     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * content_value;
<a name="l00097"></a>00097     <span class="keywordtype">size_t</span> content_length;
<a name="l00098"></a>00098     
<a name="l00099"></a>00099     <span class="keywordtype">int</span> res = 0;
<a name="l00100"></a>00100     <span class="keywordtype">int</span> i;
<a name="l00101"></a>00101     
<a name="l00102"></a>00102     memset(&amp;content, 0x33, <span class="keyword">sizeof</span>(content));
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a464e10bcdb62aa8821df3ce27eb8c5aa">ccn_parse_ContentObject</a>(message-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, message-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, &amp;content, comps) != 0) {
<a name="l00105"></a>00105         printf(<span class="stringliteral">&quot;Decode failed to parse object\n&quot;</span>);
<a name="l00106"></a>00106         res = -1;
<a name="l00107"></a>00107     }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (comps-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a>-1 != name_path-&gt;count) {
<a name="l00110"></a>00110         printf(<span class="stringliteral">&quot;Decode got wrong number of path components: %d vs. %d\n&quot;</span>, 
<a name="l00111"></a>00111                (<span class="keywordtype">int</span>)(comps-&gt;<a class="code" href="structccn__indexbuf.html#abdce3277d696961e60056bfbceced220">n</a>-1), name_path-&gt;count);
<a name="l00112"></a>00112         res = -1;
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114     <span class="keywordflow">for</span> (i=0; i&lt;name_path-&gt;count; i++) {
<a name="l00115"></a>00115         <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#a8b35775b22257b33832776c661e8b39a">ccn_name_comp_strcmp</a>(message-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, comps, i, name_path-&gt;comps[i]) != 0) {
<a name="l00116"></a>00116             printf(<span class="stringliteral">&quot;Decode mismatch on path component %d\n&quot;</span>, i);
<a name="l00117"></a>00117             res = -1;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (<a class="code" href="ccn_8h.html#ac3a7a8cad96caf34fc73240b20f07cd2">ccn_content_get_value</a>(message-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, message-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, &amp;content,
<a name="l00121"></a>00121                               &amp;content_value, &amp;content_length) != 0) {
<a name="l00122"></a>00122         printf(<span class="stringliteral">&quot;Cannot retrieve content value\n&quot;</span>);
<a name="l00123"></a>00123         res = -1;
<a name="l00124"></a>00124     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (content_length != len) {
<a name="l00125"></a>00125         printf(<span class="stringliteral">&quot;Decode mismatch on content length %d vs. %d\n&quot;</span>, 
<a name="l00126"></a>00126                (<span class="keywordtype">int</span>)content_length, (<span class="keywordtype">int</span>)len);
<a name="l00127"></a>00127         res = -1;
<a name="l00128"></a>00128     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (memcmp(content_value, data, len) != 0) {
<a name="l00129"></a>00129         printf(<span class="stringliteral">&quot;Decode mismatch of content\n&quot;</span>);
<a name="l00130"></a>00130         res = -1;
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="keywordflow">if</span> (<a class="code" href="signing_8h.html#a6be6dfd02bb112b68eb2c291bccc3669">ccn_verify_signature</a>(message-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, message-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, &amp;content, verkey) != 1) {
<a name="l00134"></a>00134         printf(<span class="stringliteral">&quot;Signature did not verify\n&quot;</span>);
<a name="l00135"></a>00135         res = -1;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <a class="code" href="indexbuf_8h.html#a85816e7765050ed93ccdd29210dabfaf" title="Deallocate indexbuf.">ccn_indexbuf_destroy</a>(&amp;comps);
<a name="l00139"></a>00139     <span class="keywordflow">return</span> res;
<a name="l00140"></a>00140     
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="keywordtype">int</span>
<a name="l00144"></a><a class="code" href="encodedecodetest_8c.html#a8dc44e1a115a66d6c6fcc825dd197acd">00144</a> <a class="code" href="encodedecodetest_8c.html#a8dc44e1a115a66d6c6fcc825dd197acd">expected_res</a>(<span class="keywordtype">int</span> res, <span class="keywordtype">char</span> code)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (code == <span class="charliteral">&apos;*&apos;</span>)
<a name="l00147"></a>00147         <span class="keywordflow">return</span>(1);
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (code == <span class="charliteral">&apos;-&apos;</span>)
<a name="l00149"></a>00149         <span class="keywordflow">return</span>(res &lt; 0);
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (code == <span class="charliteral">&apos;+&apos;</span>)
<a name="l00151"></a>00151         <span class="keywordflow">return</span>(res &gt; 0);
<a name="l00152"></a>00152     <span class="keywordflow">if</span> (<span class="charliteral">&apos;0&apos;</span> &lt;= code &amp;&amp; code &lt;= <span class="charliteral">&apos;9&apos;</span>)
<a name="l00153"></a>00153         <span class="keywordflow">return</span>(res == (code - <span class="charliteral">&apos;0&apos;</span>));
<a name="l00154"></a>00154     abort(); <span class="comment">// test program bug!!!</span>
<a name="l00155"></a>00155     <span class="comment">/* NOTREACHED */</span>
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="encodedecodetest_8c.html#a0a1157e936aeda10e5acdce4e65e42e2">00158</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="encodedecodetest_8c.html#a0a1157e936aeda10e5acdce4e65e42e2">all_chars_percent_encoded</a>[256 * 3 + 1]; <span class="comment">/* Computed */</span>
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="encodedecodetest_8c.html#a8927f47b943267dcba0ad87ecfb6f774">00160</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="encodedecodetest_8c.html#a8927f47b943267dcba0ad87ecfb6f774">init_all_chars_percent_encoded</a>(<span class="keywordtype">void</span>) {
<a name="l00161"></a>00161     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *c;
<a name="l00162"></a>00162     <span class="keywordtype">int</span> i;
<a name="l00163"></a>00163     c = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00164"></a>00164     <span class="keywordflow">for</span> (i = 0; i &lt; 256; i+=2) {
<a name="l00165"></a>00165         <a class="code" href="charbuf_8h.html#a942c4bc14fffdbacfbc0fb477b01125e">ccn_charbuf_putf</a>(c, <span class="stringliteral">&quot;%%%02x%%%02X&quot;</span>, i, i+1);
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167     <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt;= <span class="keyword">sizeof</span>(<a class="code" href="encodedecodetest_8c.html#a0a1157e936aeda10e5acdce4e65e42e2">all_chars_percent_encoded</a>))
<a name="l00168"></a>00168         c-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = <span class="keyword">sizeof</span>(<a class="code" href="encodedecodetest_8c.html#a0a1157e936aeda10e5acdce4e65e42e2">all_chars_percent_encoded</a>) - 1;
<a name="l00169"></a>00169     memcpy(<a class="code" href="encodedecodetest_8c.html#a0a1157e936aeda10e5acdce4e65e42e2">all_chars_percent_encoded</a>, c-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, c-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00170"></a>00170     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;c);
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="encodedecodetest_8c.html#a7c2689d8b87ae43af924e994230b80ef">00173</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="encodedecodetest_8c.html#a7c2689d8b87ae43af924e994230b80ef">all_chars_percent_encoded_canon</a> =
<a name="l00174"></a>00174  <span class="stringliteral">&quot;ccnx:/&quot;</span>
<a name="l00175"></a>00175  <span class="stringliteral">&quot;%00%01%02%03%04%05%06%07%08%09%0A%0B%0C%0D%0E%0F&quot;</span>
<a name="l00176"></a>00176  <span class="stringliteral">&quot;%10%11%12%13%14%15%16%17%18%19%1A%1B%1C%1D%1E%1F&quot;</span>
<a name="l00177"></a>00177  <span class="stringliteral">&quot;%20%21%22%23%24%25%26%27%28%29%2A%2B%2C-.%2F&quot;</span>
<a name="l00178"></a>00178  <span class="stringliteral">&quot;0123456789%3A%3B%3C%3D%3E%3F&quot;</span>
<a name="l00179"></a>00179  <span class="stringliteral">&quot;%40ABCDEFGHIJKLMNOPQRSTUVWXYZ%5B%5C%5D%5E_&quot;</span>
<a name="l00180"></a>00180  <span class="stringliteral">&quot;%60abcdefghijklmnopqrstuvwxyz%7B%7C%7D~%7F&quot;</span>
<a name="l00181"></a>00181  <span class="stringliteral">&quot;%80%81%82%83%84%85%86%87%88%89%8A%8B%8C%8D%8E%8F&quot;</span>
<a name="l00182"></a>00182  <span class="stringliteral">&quot;%90%91%92%93%94%95%96%97%98%99%9A%9B%9C%9D%9E%9F&quot;</span>
<a name="l00183"></a>00183  <span class="stringliteral">&quot;%A0%A1%A2%A3%A4%A5%A6%A7%A8%A9%AA%AB%AC%AD%AE%AF&quot;</span>
<a name="l00184"></a>00184  <span class="stringliteral">&quot;%B0%B1%B2%B3%B4%B5%B6%B7%B8%B9%BA%BB%BC%BD%BE%BF&quot;</span>
<a name="l00185"></a>00185  <span class="stringliteral">&quot;%C0%C1%C2%C3%C4%C5%C6%C7%C8%C9%CA%CB%CC%CD%CE%CF&quot;</span>
<a name="l00186"></a>00186  <span class="stringliteral">&quot;%D0%D1%D2%D3%D4%D5%D6%D7%D8%D9%DA%DB%DC%DD%DE%DF&quot;</span>
<a name="l00187"></a>00187  <span class="stringliteral">&quot;%E0%E1%E2%E3%E4%E5%E6%E7%E8%E9%EA%EB%EC%ED%EE%EF&quot;</span>
<a name="l00188"></a>00188  <span class="stringliteral">&quot;%F0%F1%F2%F3%F4%F5%F6%F7%F8%F9%FA%FB%FC%FD%FE%FF&quot;</span>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 <span class="keywordtype">int</span>
<a name="l00191"></a><a class="code" href="encodedecodetest_8c.html#a0ddf1224851353fc92bfbff6f499fa97">00191</a> <a class="code" href="basicparsetest_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="This is for testing.">main</a> (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {
<a name="l00192"></a>00192     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *buffer = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00193"></a>00193     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *signed_info = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00194"></a>00194     <span class="keyword">struct </span><a class="code" href="structccn__skeleton__decoder.html">ccn_skeleton_decoder</a> dd = {0};
<a name="l00195"></a>00195     ssize_t res;
<a name="l00196"></a>00196     <span class="keywordtype">char</span> *outname = NULL;
<a name="l00197"></a>00197     <span class="keywordtype">int</span> fd;
<a name="l00198"></a>00198     <span class="keywordtype">int</span> result = 0;
<a name="l00199"></a>00199     <span class="keywordtype">char</span> * contents[] = {<span class="stringliteral">&quot;INVITE sip:foo@parc.com SIP/2.0\nVia: SIP/2.0/UDP 127.0.0.1:5060;rport;branch=z9hG4bK519044721\nFrom: &lt;sip:jthornto@13.2.117.52&gt;;tag=2105643453\nTo: Test User &lt;sip:foo@parc.com&gt;\nCall-ID: 119424355@127.0.0.1\nCSeq: 20 INVITE\nContact: &lt;sip:jthornto@127.0.0.1:5060&gt;\nMax-Forwards: 70\nUser-Agent: Linphone-1.7.1/eXosip\nSubject: Phone call\nExpires: 120\nAllow: INVITE, ACK, CANCEL, BYE, OPTIONS, REFER, SUBSCRIBE, NOTIFY, MESSAGE\nContent-Type: application/sdp\nContent-Length:   448\n\nv=0\no=jthornto 123456 654321 IN IP4 127.0.0.1\ns=A conversation\nc=IN IP4 127.0.0.1\nt=0 0\nm=audio 7078 RTP/AVP 111 110 0 3 8 101\na=rtpmap:111 speex/16000/1\na=rtpmap:110 speex/8000/1\na=rtpmap:0 PCMU/8000/1\na=rtpmap:3 GSM/8000/1\na=rtpmap:8 PCMA/8000/1\na=rtpmap:101 telephone-event/8000\na=fmtp:101 0-11\nm=video 9078 RTP/AVP 97 98 99\na=rtpmap:97 theora/90000\na=rtpmap:98 H263-1998/90000\na=fmtp:98 CIF=1;QCIF=1\na=rtpmap:99 MP4V-ES/90000\n&quot;</span>, 
<a name="l00200"></a>00200  
<a name="l00201"></a>00201                          <span class="stringliteral">&quot;Quaer #%2d zjduer  badone&quot;</span>,
<a name="l00202"></a>00202                          <span class="stringliteral">&quot;&quot;</span>,
<a name="l00203"></a>00203                          NULL};
<a name="l00204"></a>00204     <span class="keywordtype">char</span> * paths[] = { <span class="stringliteral">&quot;/sip/protocol/parc.com/domain/foo/principal/invite/verb/119424355@127.0.0.1/id&quot;</span>, 
<a name="l00205"></a>00205                        <span class="stringliteral">&quot;/d/e/f&quot;</span>,
<a name="l00206"></a>00206                        <span class="stringliteral">&quot;/zero/length/content&quot;</span>,
<a name="l00207"></a>00207                        NULL};
<a name="l00208"></a>00208     <span class="keyword">struct </span>path * cur_path = NULL;
<a name="l00209"></a>00209     <span class="keyword">struct </span>ccn_keystore *keystore = <a class="code" href="keystore_8h.html#ab290abef9ae215c79bb8d05057792387">ccn_keystore_create</a>();
<a name="l00210"></a>00210     <span class="keywordtype">char</span> *home = getenv(<span class="stringliteral">&quot;HOME&quot;</span>);
<a name="l00211"></a>00211     <span class="keywordtype">char</span> *keystore_suffix = <span class="stringliteral">&quot;/.ccnx/.ccnx_keystore&quot;</span>;
<a name="l00212"></a>00212     <span class="keywordtype">char</span> *keystore_name = NULL;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keywordtype">int</span> i;
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (argc == 3 &amp;&amp; strcmp(argv[1], <span class="stringliteral">&quot;-o&quot;</span>) == 0) {
<a name="l00217"></a>00217         outname = argv[2];
<a name="l00218"></a>00218     } <span class="keywordflow">else</span> {
<a name="l00219"></a>00219         printf(<span class="stringliteral">&quot;Usage: %s -o &lt;outfilename&gt;\n&quot;</span>, argv[0]);
<a name="l00220"></a>00220         exit(1);
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordflow">if</span> (home == NULL) {
<a name="l00224"></a>00224         printf(<span class="stringliteral">&quot;Unable to determine home directory for keystore\n&quot;</span>);
<a name="l00225"></a>00225         exit(1);
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227     keystore_name = calloc(1, strlen(home) + strlen(keystore_suffix) + 1);
<a name="l00228"></a>00228     
<a name="l00229"></a>00229     strcat(keystore_name, home);
<a name="l00230"></a>00230     strcat(keystore_name, keystore_suffix);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (0 != <a class="code" href="keystore_8h.html#acd9b668c96ad13459787a1b298d10003">ccn_keystore_init</a>(keystore, keystore_name, <span class="stringliteral">&quot;Th1s1sn0t8g00dp8ssw0rd.&quot;</span>)) {
<a name="l00233"></a>00233         printf(<span class="stringliteral">&quot;Failed to initialize keystore\n&quot;</span>);
<a name="l00234"></a>00234         exit(1);
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     printf(<span class="stringliteral">&quot;Creating signed_info\n&quot;</span>);
<a name="l00238"></a>00238     res = <a class="code" href="ccn_8h.html#a4b792d695de5e7664ffe17b5fc79e6ee" title="Create SignedInfo.">ccn_signed_info_create</a>(signed_info,
<a name="l00239"></a>00239                                  <span class="comment">/*pubkeyid*/</span><a class="code" href="keystore_8h.html#afca2e4ee544383bd2f18ec67b340fc0f">ccn_keystore_public_key_digest</a>(keystore),
<a name="l00240"></a>00240                                  <span class="comment">/*publisher_key_id_size*/</span><a class="code" href="keystore_8h.html#ace23b0b60b0409c236411ad16d6e41e3">ccn_keystore_public_key_digest_length</a>(keystore),
<a name="l00241"></a>00241                                  <span class="comment">/*datetime*/</span>NULL,
<a name="l00242"></a>00242                                  <span class="comment">/*type*/</span><a class="code" href="ccn_8h.html#a5ac452b850189ae724c4ff89ae81c702a73b644ea179c5d4145072df836092a1f">CCN_CONTENT_GONE</a>,
<a name="l00243"></a>00243                                  <span class="comment">/*freshness*/</span> 42,
<a name="l00244"></a>00244                                  <span class="comment">/*finalblockid*/</span>NULL,
<a name="l00245"></a>00245                                  <span class="comment">/*keylocator*/</span>NULL);
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00247"></a>00247         printf(<span class="stringliteral">&quot;Failed to create signed_info!\n&quot;</span>);
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249     
<a name="l00250"></a>00250     res = <a class="code" href="coding_8h.html#a8e7167e6faac030987bbaafb0d23c4e0" title="Decodes ccnb decoded data.">ccn_skeleton_decode</a>(&amp;dd, signed_info-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, signed_info-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00251"></a>00251     <span class="keywordflow">if</span> (!(res == signed_info-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &amp;&amp; dd.<a class="code" href="structccn__skeleton__decoder.html#a59243d42e65373a2946e57137e244389" title="Decoder state.">state</a> == 0)) {
<a name="l00252"></a>00252         printf(<span class="stringliteral">&quot;Failed to decode signed_info!  Result %d State %d\n&quot;</span>, (<span class="keywordtype">int</span>)res, dd.<a class="code" href="structccn__skeleton__decoder.html#a59243d42e65373a2946e57137e244389" title="Decoder state.">state</a>);
<a name="l00253"></a>00253         result = 1;
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255     memset(&amp;dd, 0, <span class="keyword">sizeof</span>(dd));
<a name="l00256"></a>00256     printf(<span class="stringliteral">&quot;Done with signed_info\n&quot;</span>);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     printf(<span class="stringliteral">&quot;Encoding sample message data length %d\n&quot;</span>, (<span class="keywordtype">int</span>)strlen(contents[0]));
<a name="l00259"></a>00259     cur_path = <a class="code" href="encodedecodetest_8c.html#a7e81156d9f005b0e25e37d4444cb60d3">path_create</a>(paths[0]);
<a name="l00260"></a>00260     <span class="keywordflow">if</span> (<a class="code" href="encodedecodetest_8c.html#a67f1e872f0736c6acc80d66da7ea0cf2">encode_message</a>(buffer, cur_path, contents[0], strlen(contents[0]), signed_info, <a class="code" href="keystore_8h.html#ad8902b49084661be59f28978dc8f9da3">ccn_keystore_private_key</a>(keystore))) {
<a name="l00261"></a>00261         printf(<span class="stringliteral">&quot;Failed to encode message!\n&quot;</span>);
<a name="l00262"></a>00262     } <span class="keywordflow">else</span> {
<a name="l00263"></a>00263         printf(<span class="stringliteral">&quot;Encoded sample message length is %d\n&quot;</span>, (<span class="keywordtype">int</span>)buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         res = <a class="code" href="coding_8h.html#a8e7167e6faac030987bbaafb0d23c4e0" title="Decodes ccnb decoded data.">ccn_skeleton_decode</a>(&amp;dd, buffer-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00266"></a>00266         <span class="keywordflow">if</span> (!(res == buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &amp;&amp; dd.<a class="code" href="structccn__skeleton__decoder.html#a59243d42e65373a2946e57137e244389" title="Decoder state.">state</a> == 0)) {
<a name="l00267"></a>00267             printf(<span class="stringliteral">&quot;Failed to decode!  Result %d State %d\n&quot;</span>, (<span class="keywordtype">int</span>)res, dd.<a class="code" href="structccn__skeleton__decoder.html#a59243d42e65373a2946e57137e244389" title="Decoder state.">state</a>);
<a name="l00268"></a>00268             result = 1;
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270         <span class="keywordflow">if</span> (outname != NULL) {
<a name="l00271"></a>00271             fd = open(outname, O_WRONLY|O_CREAT|O_TRUNC, S_IRWXU);
<a name="l00272"></a>00272             <span class="keywordflow">if</span> (fd == -1)
<a name="l00273"></a>00273                 perror(outname);
<a name="l00274"></a>00274             (void)write(fd, buffer-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>);
<a name="l00275"></a>00275             close(fd);
<a name="l00276"></a>00276         }
<a name="l00277"></a>00277         <span class="keywordflow">if</span> (<a class="code" href="encodedecodetest_8c.html#acb58d3170eda3600d8769be8882116eb">decode_message</a>(buffer, cur_path, contents[0], strlen(contents[0]), <a class="code" href="keystore_8h.html#a354d2e82c92b7a504070b0daf1484215">ccn_keystore_public_key</a>(keystore)) != 0) {
<a name="l00278"></a>00278             result = 1;
<a name="l00279"></a>00279         }
<a name="l00280"></a>00280         printf(<span class="stringliteral">&quot;Expect signature verification failure: &quot;</span>);
<a name="l00281"></a>00281         <span class="keywordflow">if</span> (buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> &gt;= 20)
<a name="l00282"></a>00282             buffer-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>[buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> - 20] += 1;
<a name="l00283"></a>00283         <span class="keywordflow">if</span> (<a class="code" href="encodedecodetest_8c.html#acb58d3170eda3600d8769be8882116eb">decode_message</a>(buffer, cur_path, contents[0], strlen(contents[0]), <a class="code" href="keystore_8h.html#a354d2e82c92b7a504070b0daf1484215">ccn_keystore_public_key</a>(keystore)) == 0) {
<a name="l00284"></a>00284             result = 1;
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287     <a class="code" href="encodedecodetest_8c.html#a2b07b81d00b3e3f34913d651bf068e48">path_destroy</a>(&amp;cur_path);
<a name="l00288"></a>00288     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;buffer);
<a name="l00289"></a>00289     printf(<span class="stringliteral">&quot;Done with sample message\n&quot;</span>);
<a name="l00290"></a>00290     
<a name="l00291"></a>00291     <span class="comment">/* Now exercise as unit tests */</span>
<a name="l00292"></a>00292     
<a name="l00293"></a>00293     <span class="keywordflow">for</span> (i = 0; paths[i] != NULL &amp;&amp; contents[i] != NULL; i++) {
<a name="l00294"></a>00294         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i);
<a name="l00295"></a>00295         cur_path = <a class="code" href="encodedecodetest_8c.html#a7e81156d9f005b0e25e37d4444cb60d3">path_create</a>(paths[i]);
<a name="l00296"></a>00296         buffer = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00297"></a>00297         <span class="keywordflow">if</span> (<a class="code" href="encodedecodetest_8c.html#a67f1e872f0736c6acc80d66da7ea0cf2">encode_message</a>(buffer, cur_path, contents[i], strlen(contents[i]), signed_info, <a class="code" href="keystore_8h.html#ad8902b49084661be59f28978dc8f9da3">ccn_keystore_private_key</a>(keystore))) {
<a name="l00298"></a>00298             printf(<span class="stringliteral">&quot;Failed encode\n&quot;</span>);
<a name="l00299"></a>00299             result = 1;
<a name="l00300"></a>00300         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="encodedecodetest_8c.html#acb58d3170eda3600d8769be8882116eb">decode_message</a>(buffer, cur_path, contents[i], strlen(contents[i]), <a class="code" href="keystore_8h.html#a354d2e82c92b7a504070b0daf1484215">ccn_keystore_public_key</a>(keystore))) {
<a name="l00301"></a>00301             printf(<span class="stringliteral">&quot;Failed decode\n&quot;</span>);
<a name="l00302"></a>00302             result = 1;
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304         <a class="code" href="encodedecodetest_8c.html#a2b07b81d00b3e3f34913d651bf068e48">path_destroy</a>(&amp;cur_path);
<a name="l00305"></a>00305         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;buffer);
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     
<a name="l00308"></a>00308     <span class="comment">/* Test the uri encode / decode routines */</span>
<a name="l00309"></a>00309         
<a name="l00310"></a>00310     <a class="code" href="encodedecodetest_8c.html#a8927f47b943267dcba0ad87ecfb6f774">init_all_chars_percent_encoded</a>();
<a name="l00311"></a>00311     <span class="keyword">const</span> <span class="keywordtype">char</span> *uri_tests[] = {
<a name="l00312"></a>00312         <span class="stringliteral">&quot;_+4&quot;</span>, <span class="stringliteral">&quot;ccnx:/this/is/a/test&quot;</span>,       <span class="stringliteral">&quot;&quot;</span>,     <span class="stringliteral">&quot;ccnx:/this/is/a/test&quot;</span>,
<a name="l00313"></a>00313         <span class="stringliteral">&quot;.+4&quot;</span>, <span class="stringliteral">&quot;../test2?x=2&quot;</span>,              <span class="stringliteral">&quot;?x=2&quot;</span>, <span class="stringliteral">&quot;ccnx:/this/is/a/test2&quot;</span>,
<a name="l00314"></a>00314         <span class="stringliteral">&quot;_-X&quot;</span>, <span class="stringliteral">&quot;../should/error&quot;</span>,           <span class="stringliteral">&quot;&quot;</span>,     <span class="stringliteral">&quot;&quot;</span>,
<a name="l00315"></a>00315         <span class="stringliteral">&quot;_+2&quot;</span>, <span class="stringliteral">&quot;/missing/scheme&quot;</span>,           <span class="stringliteral">&quot;&quot;</span>,     <span class="stringliteral">&quot;ccnx:/missing/scheme&quot;</span>,
<a name="l00316"></a>00316         <span class="stringliteral">&quot;.+0&quot;</span>, <span class="stringliteral">&quot;../../../../../././#/&quot;</span>,     <span class="stringliteral">&quot;#/&quot;</span>,   <span class="stringliteral">&quot;ccnx:/&quot;</span>,
<a name="l00317"></a>00317         <span class="stringliteral">&quot;.+1&quot;</span>, <a class="code" href="encodedecodetest_8c.html#a0a1157e936aeda10e5acdce4e65e42e2">all_chars_percent_encoded</a>,   <span class="stringliteral">&quot;&quot;</span>,     <a class="code" href="encodedecodetest_8c.html#a7c2689d8b87ae43af924e994230b80ef">all_chars_percent_encoded_canon</a>,
<a name="l00318"></a>00318         <span class="stringliteral">&quot;_+1&quot;</span>, all_chars_percent_encoded_canon, <span class="stringliteral">&quot;&quot;</span>, all_chars_percent_encoded_canon,
<a name="l00319"></a>00319         <span class="stringliteral">&quot;.+4&quot;</span>, <span class="stringliteral">&quot;ccnx:/.../.%2e./...././.....///?...&quot;</span>, <span class="stringliteral">&quot;?...&quot;</span>, <span class="stringliteral">&quot;ccnx:/.../.../..../.....&quot;</span>,
<a name="l00320"></a>00320         <span class="stringliteral">&quot;_-X&quot;</span>, <span class="stringliteral">&quot;/%3G?bad-pecent-encode&quot;</span>,    <span class="stringliteral">&quot;&quot;</span>,     <span class="stringliteral">&quot;&quot;</span>,
<a name="l00321"></a>00321         <span class="stringliteral">&quot;_-X&quot;</span>, <span class="stringliteral">&quot;/%3?bad-percent-encode&quot;</span>,    <span class="stringliteral">&quot;&quot;</span>,     <span class="stringliteral">&quot;&quot;</span>,
<a name="l00322"></a>00322         <span class="stringliteral">&quot;_-X&quot;</span>, <span class="stringliteral">&quot;/%#bad-percent-encode&quot;</span>,    <span class="stringliteral">&quot;&quot;</span>,     <span class="stringliteral">&quot;&quot;</span>,
<a name="l00323"></a>00323         <span class="stringliteral">&quot;_+3&quot;</span>, <span class="stringliteral">&quot;ccnx://joe@example.com:42/ignore/host/part of uri&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;ccnx:/ignore/host/part%20of%20uri&quot;</span>,
<a name="l00324"></a>00324         NULL, NULL, NULL, NULL
<a name="l00325"></a>00325     };
<a name="l00326"></a>00326     <span class="keyword">const</span> <span class="keywordtype">char</span> **u;
<a name="l00327"></a>00327     <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *uri_out = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00328"></a>00328     buffer = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00329"></a>00329     <span class="keywordflow">for</span> (u = uri_tests; *u != NULL; u += 4, i++) {
<a name="l00330"></a>00330         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i);
<a name="l00331"></a>00331         <span class="keywordflow">if</span> (u[0][0] != <span class="charliteral">&apos;.&apos;</span>)
<a name="l00332"></a>00332             buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l00333"></a>00333         res = <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(buffer, u[1]);
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (!<a class="code" href="encodedecodetest_8c.html#a8dc44e1a115a66d6c6fcc825dd197acd">expected_res</a>(res, u[0][1])) {
<a name="l00335"></a>00335             printf(<span class="stringliteral">&quot;Failed: ccn_name_from_uri wrong res %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00336"></a>00336             result = 1;
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338         <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l00339"></a>00339             <span class="keywordflow">if</span> (res &gt; strlen(u[1])) {
<a name="l00340"></a>00340                 printf(<span class="stringliteral">&quot;Failed: ccn_name_from_uri long res %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00341"></a>00341                 result = 1;
<a name="l00342"></a>00342             }
<a name="l00343"></a>00343             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 != strcmp(u[1] + res, u[2])) {
<a name="l00344"></a>00344                 printf(<span class="stringliteral">&quot;Failed: ccn_name_from_uri expecting leftover &apos;%s&apos;, got &apos;%s&apos;\n&quot;</span>, u[2], u[1] + res);
<a name="l00345"></a>00345                 result = 1;
<a name="l00346"></a>00346             }
<a name="l00347"></a>00347             uri_out-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l00348"></a>00348             res = <a class="code" href="uri_8h.html#a46512a74f8d78b3e01fbc115f652ae8d" title="This appends to c a URI representation of the ccnb-encoded Name element passed in...">ccn_uri_append</a>(uri_out, buffer-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1);
<a name="l00349"></a>00349             <span class="keywordflow">if</span> (!<a class="code" href="encodedecodetest_8c.html#a8dc44e1a115a66d6c6fcc825dd197acd">expected_res</a>(res, u[0][2])) {
<a name="l00350"></a>00350                 printf(<span class="stringliteral">&quot;Failed: ccn_uri_append wrong res %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00351"></a>00351                 result = 1;
<a name="l00352"></a>00352             }
<a name="l00353"></a>00353             <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l00354"></a>00354                 <span class="keywordflow">if</span> (uri_out-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> != strlen(u[3])) {
<a name="l00355"></a>00355                     printf(<span class="stringliteral">&quot;Failed: ccn_uri_append produced wrong number of characters\n&quot;</span>);
<a name="l00356"></a>00356                     result = 1;
<a name="l00357"></a>00357                 }
<a name="l00358"></a>00358                 <a class="code" href="charbuf_8h.html#a3e0e15f90919b9a4da02704830f09717">ccn_charbuf_reserve</a>(uri_out, 1)[0] = 0;
<a name="l00359"></a>00359                 <span class="keywordflow">if</span> (0 != strcmp((<span class="keyword">const</span> <span class="keywordtype">char</span> *)uri_out-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, u[3])) {
<a name="l00360"></a>00360                     printf(<span class="stringliteral">&quot;Failed: ccn_uri_append produced wrong output\n&quot;</span>);
<a name="l00361"></a>00361                     printf(<span class="stringliteral">&quot;Expected: %s\n&quot;</span>, u[3]);
<a name="l00362"></a>00362                     printf(<span class="stringliteral">&quot;  Actual: %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)uri_out-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>);
<a name="l00363"></a>00363                     result = 1;
<a name="l00364"></a>00364                 }
<a name="l00365"></a>00365             }
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;buffer);
<a name="l00369"></a>00369     <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uri_out);
<a name="l00370"></a>00370     printf(<span class="stringliteral">&quot;Name marker tests\n&quot;</span>);
<a name="l00371"></a>00371     <span class="keywordflow">do</span> {
<a name="l00372"></a>00372         <span class="keyword">const</span> <span class="keywordtype">char</span> *expected_uri = <span class="stringliteral">&quot;ccnx:/example.com/.../%01/%FE/%01%02%03%04%05%06%07%08/%FD%10%10%10%10%1F%FF/%00%81&quot;</span>;
<a name="l00373"></a>00373         <span class="keyword">const</span> <span class="keywordtype">char</span> *expected_chopped_uri = <span class="stringliteral">&quot;ccnx:/example.com/.../%01/%FE&quot;</span>;
<a name="l00374"></a>00374         <span class="keyword">const</span> <span class="keywordtype">char</span> *expected_bumped_uri = <span class="stringliteral">&quot;ccnx:/example.com/.../%01/%FF&quot;</span>;
<a name="l00375"></a>00375         <span class="keyword">const</span> <span class="keywordtype">char</span> *expected_bumped2_uri = <span class="stringliteral">&quot;ccnx:/example.com/.../%01/%00%00&quot;</span>;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00378"></a>00378         buffer = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00379"></a>00379         uri_out = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00380"></a>00380         res = <a class="code" href="ccn_8h.html#a4aa75ce6fc675e7a4c4c6d65e68817bd" title="Reset charbuf to represent an empty Name in binary format.">ccn_name_init</a>(buffer);
<a name="l00381"></a>00381         res |= <a class="code" href="ccn_8h.html#aec5620dc4689a663ea7181cdebeda4d0" title="Add a Component that is a NUL-terminated string.">ccn_name_append_str</a>(buffer, <span class="stringliteral">&quot;example.com&quot;</span>);
<a name="l00382"></a>00382         res |= <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(buffer, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a36371d18c0c5a44e25c6863d74ca842a">CCN_MARKER_NONE</a>, 0);
<a name="l00383"></a>00383         res |= <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(buffer, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a36371d18c0c5a44e25c6863d74ca842a">CCN_MARKER_NONE</a>, 1);
<a name="l00384"></a>00384         res |= <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(buffer, 0xFE, 0);
<a name="l00385"></a>00385         res |= <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(buffer, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a36371d18c0c5a44e25c6863d74ca842a">CCN_MARKER_NONE</a>, 0x0102030405060708ULL);
<a name="l00386"></a>00386         res |= <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(buffer, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399a8b7274d49f90dd8d37f86d1ee8a20c6e" title="timestamp-based versioning">CCN_MARKER_VERSION</a>, 0x101010101FFFULL);
<a name="l00387"></a>00387         res |= <a class="code" href="ccn_8h.html#a3b95a770555b90f43d4876bea62c202d" title="Add a binary Component to a ccnb-encoded Name.">ccn_name_append_numeric</a>(buffer, <a class="code" href="ccn_8h.html#afec910e39c89dcf24a44f93e97032399af3eb8e7fa3a938a5bcc6c1f141357d71" title="consecutive block sequence numbers">CCN_MARKER_SEQNUM</a>, 129);
<a name="l00388"></a>00388         res |= <a class="code" href="uri_8h.html#a46512a74f8d78b3e01fbc115f652ae8d" title="This appends to c a URI representation of the ccnb-encoded Name element passed in...">ccn_uri_append</a>(uri_out, buffer-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1);
<a name="l00389"></a>00389         <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00390"></a>00390             printf(<span class="stringliteral">&quot;Failed: name marker tests had negative res\n&quot;</span>);
<a name="l00391"></a>00391             result = 1;
<a name="l00392"></a>00392         }
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (0 != strcmp(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uri_out), expected_uri)) {
<a name="l00394"></a>00394             printf(<span class="stringliteral">&quot;Failed: name marker tests produced wrong output\n&quot;</span>);
<a name="l00395"></a>00395             printf(<span class="stringliteral">&quot;Expected: %s\n&quot;</span>, expected_uri);
<a name="l00396"></a>00396             printf(<span class="stringliteral">&quot;  Actual: %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)uri_out-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>);
<a name="l00397"></a>00397             result = 1;
<a name="l00398"></a>00398         }
<a name="l00399"></a>00399         res = <a class="code" href="ccn_8h.html#a79ca5ab3dd25aa67bf1949a440284978" title="Chop the name down to n components.">ccn_name_chop</a>(buffer, NULL, 100);
<a name="l00400"></a>00400         <span class="keywordflow">if</span> (res != -1) {
<a name="l00401"></a>00401             printf(<span class="stringliteral">&quot;Failed: ccn_name_chop did not produce error \n&quot;</span>);
<a name="l00402"></a>00402             result = 1;
<a name="l00403"></a>00403         }
<a name="l00404"></a>00404         res = <a class="code" href="ccn_8h.html#a79ca5ab3dd25aa67bf1949a440284978" title="Chop the name down to n components.">ccn_name_chop</a>(buffer, NULL, 4);
<a name="l00405"></a>00405         <span class="keywordflow">if</span> (res != 4) {
<a name="l00406"></a>00406             printf(<span class="stringliteral">&quot;Failed: ccn_name_chop got wrong length\n&quot;</span>);
<a name="l00407"></a>00407             result = 1;
<a name="l00408"></a>00408         }
<a name="l00409"></a>00409         uri_out-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l00410"></a>00410         <a class="code" href="uri_8h.html#a46512a74f8d78b3e01fbc115f652ae8d" title="This appends to c a URI representation of the ccnb-encoded Name element passed in...">ccn_uri_append</a>(uri_out, buffer-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1);
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (0 != strcmp(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uri_out), expected_chopped_uri)) {
<a name="l00412"></a>00412             printf(<span class="stringliteral">&quot;Failed: ccn_name_chop botch\n&quot;</span>);
<a name="l00413"></a>00413             printf(<span class="stringliteral">&quot;Expected: %s\n&quot;</span>, expected_chopped_uri);
<a name="l00414"></a>00414             printf(<span class="stringliteral">&quot;  Actual: %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)uri_out-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>);
<a name="l00415"></a>00415             result = 1;
<a name="l00416"></a>00416         }
<a name="l00417"></a>00417         res = <a class="code" href="ccn_8h.html#af81a071aeb0de5f014552e137fc2444a" title="Advance the last Component of a Name to the next possible value.">ccn_name_next_sibling</a>(buffer);
<a name="l00418"></a>00418         <span class="keywordflow">if</span> (res != 4) {
<a name="l00419"></a>00419             printf(<span class="stringliteral">&quot;Failed: ccn_name_next_sibling got wrong length\n&quot;</span>);
<a name="l00420"></a>00420             result = 1;
<a name="l00421"></a>00421         }
<a name="l00422"></a>00422         uri_out-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l00423"></a>00423         <a class="code" href="uri_8h.html#a46512a74f8d78b3e01fbc115f652ae8d" title="This appends to c a URI representation of the ccnb-encoded Name element passed in...">ccn_uri_append</a>(uri_out, buffer-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1);
<a name="l00424"></a>00424         <span class="keywordflow">if</span> (0 != strcmp(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uri_out), expected_bumped_uri)) {
<a name="l00425"></a>00425             printf(<span class="stringliteral">&quot;Failed: ccn_name_next_sibling botch\n&quot;</span>);
<a name="l00426"></a>00426             printf(<span class="stringliteral">&quot;Expected: %s\n&quot;</span>, expected_bumped_uri);
<a name="l00427"></a>00427             printf(<span class="stringliteral">&quot;  Actual: %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)uri_out-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>);
<a name="l00428"></a>00428             result = 1;
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430         <a class="code" href="ccn_8h.html#af81a071aeb0de5f014552e137fc2444a" title="Advance the last Component of a Name to the next possible value.">ccn_name_next_sibling</a>(buffer);
<a name="l00431"></a>00431         uri_out-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a> = 0;
<a name="l00432"></a>00432         <a class="code" href="uri_8h.html#a46512a74f8d78b3e01fbc115f652ae8d" title="This appends to c a URI representation of the ccnb-encoded Name element passed in...">ccn_uri_append</a>(uri_out, buffer-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, buffer-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, 1);
<a name="l00433"></a>00433         <span class="keywordflow">if</span> (0 != strcmp(<a class="code" href="charbuf_8h.html#a36e1d775f3526c0b1f0bae4f3734b5ec">ccn_charbuf_as_string</a>(uri_out), expected_bumped2_uri)) {
<a name="l00434"></a>00434             printf(<span class="stringliteral">&quot;Failed: ccn_name_next_sibling botch\n&quot;</span>);
<a name="l00435"></a>00435             printf(<span class="stringliteral">&quot;Expected: %s\n&quot;</span>, expected_bumped2_uri);
<a name="l00436"></a>00436             printf(<span class="stringliteral">&quot;  Actual: %s\n&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)uri_out-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>);
<a name="l00437"></a>00437             result = 1;
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;buffer);
<a name="l00440"></a>00440         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;uri_out);
<a name="l00441"></a>00441     } <span class="keywordflow">while</span> (0);
<a name="l00442"></a>00442     printf(<span class="stringliteral">&quot;Message digest tests\n&quot;</span>);
<a name="l00443"></a>00443     <span class="keywordflow">do</span> {
<a name="l00444"></a>00444         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00445"></a>00445         <span class="keyword">struct </span>ccn_digest *dg = <a class="code" href="digest_8h.html#a84e53fb02b4aa2097fe7279df658cf3e">ccn_digest_create</a>(<a class="code" href="digest_8h.html#aa78356f84244471f2bfc8dc5c1420027a2bafd2fe41ce4e90759841114bf671ff">CCN_DIGEST_SHA256</a>);
<a name="l00446"></a>00446         <span class="keywordflow">if</span> (dg == NULL) {
<a name="l00447"></a>00447             printf(<span class="stringliteral">&quot;Failed: ccn_digest_create returned NULL\n&quot;</span>);
<a name="l00448"></a>00448             result = 1;
<a name="l00449"></a>00449             <span class="keywordflow">break</span>;
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00452"></a>00452         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> expected_digest[] = {
<a name="l00453"></a>00453             0xb3, 0x82, 0xcd, 0xb0, 0xe9, 0x5d, 0xf7, 0x3b, 0xe7, 0xdc, 0x19, 0x81, 0x3a, 0xfd, 0xdf, 0x89, 0xfb, 0xd4, 0xd4, 0xa0, 0xdb, 0x11, 0xa6, 0xba, 0x24, 0x16, 0x5b, 0xad, 0x9d, 0x90, 0x72, 0xb0
<a name="l00454"></a>00454         };
<a name="l00455"></a>00455         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> actual_digest[<span class="keyword">sizeof</span>(expected_digest)] = {0};
<a name="l00456"></a>00456         <span class="keyword">const</span> <span class="keywordtype">char</span> *data = <span class="stringliteral">&quot;Content-centric&quot;</span>;
<a name="l00457"></a>00457         <span class="keywordflow">if</span> (<a class="code" href="digest_8h.html#ae3d1b5dbce5b9ff5d4cad6a56a3e93e5">ccn_digest_size</a>(dg) != <span class="keyword">sizeof</span>(expected_digest)) {
<a name="l00458"></a>00458             printf(<span class="stringliteral">&quot;Failed: wrong digest size\n&quot;</span>);
<a name="l00459"></a>00459             result = 1;
<a name="l00460"></a>00460             <span class="keywordflow">break</span>;
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00463"></a>00463         <a class="code" href="digest_8h.html#a8afbfaa6688046c374afc2018a062d8a">ccn_digest_init</a>(dg);
<a name="l00464"></a>00464         res = <a class="code" href="digest_8h.html#af81dac9e7af9b986ee37c714b283edb4">ccn_digest_update</a>(dg, data, strlen(data));
<a name="l00465"></a>00465         <span class="keywordflow">if</span> (res != 0)
<a name="l00466"></a>00466             printf(<span class="stringliteral">&quot;Warning: check res %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00467"></a>00467         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00468"></a>00468         res = <a class="code" href="digest_8h.html#ab2aab2f4798076d6798ffb7b1db5639c">ccn_digest_final</a>(dg, actual_digest, <span class="keyword">sizeof</span>(expected_digest));
<a name="l00469"></a>00469         <span class="keywordflow">if</span> (res != 0)
<a name="l00470"></a>00470             printf(<span class="stringliteral">&quot;Warning: check res %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00471"></a>00471         <span class="keywordflow">if</span> (0 != memcmp(actual_digest, expected_digest, <span class="keyword">sizeof</span>(expected_digest))) {
<a name="l00472"></a>00472             printf(<span class="stringliteral">&quot;Failed: wrong digest\n&quot;</span>);
<a name="l00473"></a>00473             result = 1;
<a name="l00474"></a>00474             <span class="keywordflow">break</span>;
<a name="l00475"></a>00475         }
<a name="l00476"></a>00476     } <span class="keywordflow">while</span> (0);
<a name="l00477"></a>00477     printf(<span class="stringliteral">&quot;Really basic PRNG test\n&quot;</span>);
<a name="l00478"></a>00478     <span class="keywordflow">do</span> {
<a name="l00479"></a>00479         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> r1[42];
<a name="l00480"></a>00480         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> r2[42];
<a name="l00481"></a>00481         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00482"></a>00482         <a class="code" href="random_8h.html#ab1c18a8b1a04a6256ba7417bd42a3713" title="Feed some entropy to the random number generator.">ccn_add_entropy</a>(&amp;i, <span class="keyword">sizeof</span>(i), 0); <span class="comment">/* Not much entropy, really. */</span>
<a name="l00483"></a>00483         <a class="code" href="random_8h.html#a18cfdcbebc2ee6cfcd261817e8b85f37" title="Generate pseudo-random bytes.">ccn_random_bytes</a>(r1, <span class="keyword">sizeof</span>(r1));
<a name="l00484"></a>00484         memcpy(r2, r1, <span class="keyword">sizeof</span>(r2));
<a name="l00485"></a>00485         <a class="code" href="random_8h.html#a18cfdcbebc2ee6cfcd261817e8b85f37" title="Generate pseudo-random bytes.">ccn_random_bytes</a>(r2, <span class="keyword">sizeof</span>(r2));
<a name="l00486"></a>00486         <span class="keywordflow">if</span> (0 == memcmp(r1, r2, <span class="keyword">sizeof</span>(r2))) {
<a name="l00487"></a>00487             printf(<span class="stringliteral">&quot;Failed: badly broken PRNG\n&quot;</span>);
<a name="l00488"></a>00488             result = 1;
<a name="l00489"></a>00489             <span class="keywordflow">break</span>;
<a name="l00490"></a>00490         }
<a name="l00491"></a>00491     } <span class="keywordflow">while</span> (0);
<a name="l00492"></a>00492     printf(<span class="stringliteral">&quot;Bloom filter tests\n&quot;</span>);
<a name="l00493"></a>00493     <span class="keywordflow">do</span> {
<a name="l00494"></a>00494         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> seed1[4] = <span class="stringliteral">&quot;1492&quot;</span>;
<a name="l00495"></a>00495         <span class="keyword">const</span> <span class="keywordtype">char</span> *a[13] = {
<a name="l00496"></a>00496             <span class="stringliteral">&quot;one&quot;</span>, <span class="stringliteral">&quot;two&quot;</span>, <span class="stringliteral">&quot;three&quot;</span>, <span class="stringliteral">&quot;four&quot;</span>,
<a name="l00497"></a>00497             <span class="stringliteral">&quot;five&quot;</span>, <span class="stringliteral">&quot;six&quot;</span>, <span class="stringliteral">&quot;seven&quot;</span>, <span class="stringliteral">&quot;eight&quot;</span>,
<a name="l00498"></a>00498             <span class="stringliteral">&quot;nine&quot;</span>, <span class="stringliteral">&quot;ten&quot;</span>, <span class="stringliteral">&quot;eleven&quot;</span>, <span class="stringliteral">&quot;twelve&quot;</span>,
<a name="l00499"></a>00499             <span class="stringliteral">&quot;thirteen&quot;</span>
<a name="l00500"></a>00500         };
<a name="l00501"></a>00501         <span class="keyword">struct </span>ccn_bloom *b1 = NULL;
<a name="l00502"></a>00502         <span class="keyword">struct </span>ccn_bloom *b2 = NULL;
<a name="l00503"></a>00503         <span class="keywordtype">int</span> j, k, t1, t2;
<a name="l00504"></a>00504         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> us;
<a name="l00505"></a>00505         
<a name="l00506"></a>00506         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00507"></a>00507         b1 = <a class="code" href="bloom_8h.html#a1eb649dba6fdef0dc81940f58b111f34" title="Create an empty Bloom filter constructor.">ccn_bloom_create</a>(13, seed1);
<a name="l00508"></a>00508         
<a name="l00509"></a>00509         <span class="keywordflow">for</span> (j = 0; j &lt; 13; j++)
<a name="l00510"></a>00510             <span class="keywordflow">if</span> (<a class="code" href="bloom_8h.html#a202b830c7d8ee3ebd5822306f2e75e98">ccn_bloom_match</a>(b1, a[j], strlen(a[j]))) <span class="keywordflow">break</span>;
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (j &lt; 13) {
<a name="l00512"></a>00512             printf(<span class="stringliteral">&quot;Failed: \&quot;%s\&quot; matched empty Bloom filter\n&quot;</span>, a[j]);
<a name="l00513"></a>00513             result = 1;
<a name="l00514"></a>00514             <span class="keywordflow">break</span>;
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00517"></a>00517         <span class="keywordflow">for</span> (j = 0; j &lt; 13; j++)
<a name="l00518"></a>00518             <a class="code" href="bloom_8h.html#a60c799f2fd17ef0a929674bd9f6e0523">ccn_bloom_insert</a>(b1, a[j], strlen(a[j]));
<a name="l00519"></a>00519         <span class="keywordflow">for</span> (j = 0; j &lt; 13; j++)
<a name="l00520"></a>00520             <span class="keywordflow">if</span> (!<a class="code" href="bloom_8h.html#a202b830c7d8ee3ebd5822306f2e75e98">ccn_bloom_match</a>(b1, a[j], strlen(a[j]))) <span class="keywordflow">break</span>;
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (j &lt; 13) {
<a name="l00522"></a>00522             printf(<span class="stringliteral">&quot;Failed: \&quot;%s\&quot; not found when it should have been\n&quot;</span>, a[j]);
<a name="l00523"></a>00523             result = 1;
<a name="l00524"></a>00524             <span class="keywordflow">break</span>;
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00527"></a>00527         <span class="keywordflow">for</span> (j = 0, k = 0; j &lt; 13; j++)
<a name="l00528"></a>00528             <span class="keywordflow">if</span> (<a class="code" href="bloom_8h.html#a202b830c7d8ee3ebd5822306f2e75e98">ccn_bloom_match</a>(b1, a[j]+1, strlen(a[j]+1)))
<a name="l00529"></a>00529                 k++;
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (k &gt; 0) {
<a name="l00531"></a>00531             printf(<span class="stringliteral">&quot;Mmm, found %d false positives\n&quot;</span>, k);
<a name="l00532"></a>00532             <span class="keywordflow">if</span> (k &gt; 2) {
<a name="l00533"></a>00533                 result = 1;
<a name="l00534"></a>00534                 <span class="keywordflow">break</span>;
<a name="l00535"></a>00535             }
<a name="l00536"></a>00536         }
<a name="l00537"></a>00537         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> seed2[5] = <span class="stringliteral">&quot;aqfb\0&quot;</span>;
<a name="l00538"></a>00538         <span class="keywordflow">for</span> (; seed2[3] &lt;= <span class="charliteral">&apos;f&apos;</span>; seed2[3]++) {
<a name="l00539"></a>00539             printf(<span class="stringliteral">&quot;Unit test case %d (%4s)    &quot;</span>, i++, seed2);
<a name="l00540"></a>00540             b2 = <a class="code" href="bloom_8h.html#a1eb649dba6fdef0dc81940f58b111f34" title="Create an empty Bloom filter constructor.">ccn_bloom_create</a>(13, seed2);
<a name="l00541"></a>00541             <span class="keywordflow">for</span> (j = 0; j &lt; 13; j++)
<a name="l00542"></a>00542                 <a class="code" href="bloom_8h.html#a60c799f2fd17ef0a929674bd9f6e0523">ccn_bloom_insert</a>(b2, a[j], strlen(a[j]));
<a name="l00543"></a>00543             <span class="keywordflow">for</span> (j = 0, k = 0, us = ~0; us &gt; 0; us--) {
<a name="l00544"></a>00544                 t1 = <a class="code" href="bloom_8h.html#a202b830c7d8ee3ebd5822306f2e75e98">ccn_bloom_match</a>(b1, &amp;us, <span class="keyword">sizeof</span>(us));
<a name="l00545"></a>00545                 t2 = <a class="code" href="bloom_8h.html#a202b830c7d8ee3ebd5822306f2e75e98">ccn_bloom_match</a>(b2, &amp;us, <span class="keyword">sizeof</span>(us));
<a name="l00546"></a>00546                 j += (t1 | t2);
<a name="l00547"></a>00547                 k += (t1 &amp; t2);
<a name="l00548"></a>00548             }
<a name="l00549"></a>00549             printf(<span class="stringliteral">&quot;either=%d both=%d wiresize=%d\n&quot;</span>, j, k, <a class="code" href="bloom_8h.html#af7917f9362226d9b53a33ed668c5bea5">ccn_bloom_wiresize</a>(b1));
<a name="l00550"></a>00550             <span class="keywordflow">if</span> (k &gt; 12) {
<a name="l00551"></a>00551                 printf(<span class="stringliteral">&quot;Failed: Bloom seeding may not be effective\n&quot;</span>);
<a name="l00552"></a>00552                 result = 1;
<a name="l00553"></a>00553             }
<a name="l00554"></a>00554             <a class="code" href="bloom_8h.html#a7fe40a44e6ea4fcbbe2a595ed9ed8229">ccn_bloom_destroy</a>(&amp;b2);
<a name="l00555"></a>00555         }
<a name="l00556"></a>00556         <a class="code" href="bloom_8h.html#a7fe40a44e6ea4fcbbe2a595ed9ed8229">ccn_bloom_destroy</a>(&amp;b1);
<a name="l00557"></a>00557     } <span class="keywordflow">while</span> (0);
<a name="l00558"></a>00558     printf(<span class="stringliteral">&quot;ccn_sign_content() tests\n&quot;</span>);
<a name="l00559"></a>00559     <span class="keywordflow">do</span> {
<a name="l00560"></a>00560         <span class="keyword">struct </span>ccn *h = <a class="code" href="ccn_8h.html#aabd4b8732f28cfec43435b455a6eec7e" title="Create a client handle.">ccn_create</a>();
<a name="l00561"></a>00561         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *co = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00562"></a>00562         <span class="keyword">struct </span><a class="code" href="structccn__signing__params.html" title="Parameters for creating signed content objects.">ccn_signing_params</a> sparm = <a class="code" href="ccn_8h.html#a4ff046ac820ac0f2ef6acb912a03b328">CCN_SIGNING_PARAMS_INIT</a>;
<a name="l00563"></a>00563         <span class="keyword">struct </span><a class="code" href="structccn__parsed___content_object.html">ccn_parsed_ContentObject</a> pco = {0};
<a name="l00564"></a>00564         <span class="keyword">struct </span><a class="code" href="structccn__charbuf.html">ccn_charbuf</a> *name = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00565"></a>00565         
<a name="l00566"></a>00566         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00567"></a>00567         <a class="code" href="uri_8h.html#a7b960a7f4f9e3f8175ff05f191452104" title="Convert a ccnx-scheme URI to a ccnb-encoded Name.">ccn_name_from_uri</a>(name, <span class="stringliteral">&quot;ccnx:/test/data/%00%42&quot;</span>);
<a name="l00568"></a>00568         res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(h, co, name, NULL, <span class="stringliteral">&quot;DATA&quot;</span>, 4);
<a name="l00569"></a>00569         <span class="keywordflow">if</span> (res != 0) {
<a name="l00570"></a>00570             printf(<span class="stringliteral">&quot;Failed: res == %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00571"></a>00571             result = 1;
<a name="l00572"></a>00572         }
<a name="l00573"></a>00573         sparm.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a> = <a class="code" href="charbuf_8h.html#a6db2918ed16206ad07920ab26aac9da6">ccn_charbuf_create</a>();
<a name="l00574"></a>00574         res = <a class="code" href="ccn_8h.html#a464e10bcdb62aa8821df3ce27eb8c5aa">ccn_parse_ContentObject</a>(co-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a>, co-&gt;<a class="code" href="structccn__charbuf.html#a8847707f323a0aa35e2a81001a2d1fbf">length</a>, &amp;pco, NULL);
<a name="l00575"></a>00575         <span class="keywordflow">if</span> (res != 0) {
<a name="l00576"></a>00576             printf(<span class="stringliteral">&quot;Failed: ccn_parse_ContentObject res == %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00577"></a>00577             result = 1;
<a name="l00578"></a>00578             <span class="keywordflow">break</span>;
<a name="l00579"></a>00579         }
<a name="l00580"></a>00580         <a class="code" href="charbuf_8h.html#a5cc5c1412e38c015951394fcd79e2f6e">ccn_charbuf_append</a>(sparm.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>,
<a name="l00581"></a>00581             co-&gt;<a class="code" href="structccn__charbuf.html#af24075ee3911a992d0dda6f449f3b3b3">buf</a> + pco.<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a227917e4ffee91710eba075b7c1a58cb">CCN_PCO_B_SignedInfo</a>],
<a name="l00582"></a>00582             pco.<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a683027f393128bb5f171854c663e1193">CCN_PCO_E_SignedInfo</a>] - pco.<a class="code" href="structccn__parsed___content_object.html#a9812a65809374954710cb98556230d19">offset</a>[<a class="code" href="ccn_8h.html#a8bb16876590e11ec0ef1af93415b0387a227917e4ffee91710eba075b7c1a58cb">CCN_PCO_B_SignedInfo</a>]);
<a name="l00583"></a>00583         sparm.<a class="code" href="structccn__signing__params.html#a2b9c1f834abea9bd43f1d901e852802e">sp_flags</a> = <a class="code" href="ccn_8h.html#a404524db7af5360092c6a78bd0754645">CCN_SP_TEMPL_TIMESTAMP</a>;
<a name="l00584"></a>00584         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00585"></a>00585         res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(h, co, name, &amp;sparm, <span class="stringliteral">&quot;DATA&quot;</span>, 4);
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (res != 0) {
<a name="l00587"></a>00587             printf(<span class="stringliteral">&quot;Failed: res == %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00588"></a>00588             result = 1;
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590         printf(<span class="stringliteral">&quot;Unit test case %d\n&quot;</span>, i++);
<a name="l00591"></a>00591         sparm.<a class="code" href="structccn__signing__params.html#a2b9c1f834abea9bd43f1d901e852802e">sp_flags</a> = -1;
<a name="l00592"></a>00592         res = <a class="code" href="ccn_8h.html#a95240bd470b549c89a5e0fd72fa34d45" title="Create a signed ContentObject.">ccn_sign_content</a>(h, co, name, &amp;sparm, <span class="stringliteral">&quot;DATA&quot;</span>, 4);
<a name="l00593"></a>00593         <span class="keywordflow">if</span> (res != -1) {
<a name="l00594"></a>00594             printf(<span class="stringliteral">&quot;Failed: res == %d\n&quot;</span>, (<span class="keywordtype">int</span>)res);
<a name="l00595"></a>00595             result = 1;
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;name);
<a name="l00598"></a>00598         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;sparm.<a class="code" href="structccn__signing__params.html#a5feb999d270877e7b926d9a917f296a2">template_ccnb</a>);
<a name="l00599"></a>00599         <a class="code" href="charbuf_8h.html#a699030e7cb3c51ca2cde46af0ba6e1bb">ccn_charbuf_destroy</a>(&amp;co);
<a name="l00600"></a>00600         <a class="code" href="ccn_8h.html#adac19e5f8dd6cf3ecd73b85f77f161ae">ccn_destroy</a>(&amp;h);
<a name="l00601"></a>00601     } <span class="keywordflow">while</span> (0);
<a name="l00602"></a>00602     exit(result);
<a name="l00603"></a>00603 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Thu Nov 4 13:34:08 2010 for Content-Centric Networking in C by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
