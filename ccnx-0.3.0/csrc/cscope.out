cscope 15 $HOME/code/ccnx-0.3.0/csrc -q 0000002648 0000625648
	@ccnd/android_main.c

21 
	~<¡d¬g.h
>

22 
	~<ªdroid/log.h
>

23 
	~<cúd_´iv©e.h
>

26 
	$logg”
(*
logg”d©a
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

28 
	`__ªdroid_log_v´št
(
ANDROID_LOG_INFO
, "CCND", 
fÜm©
, 
­
);

29 
	}
}

32 
	$¡¬t_cúd
()

34 
cúd_hªdË
 *
h
 = 
NULL
;

36 
h
 = 
	`cúd_ü—‹
("cúd", &
logg”
, 
NULL
);

37 
	`cúd_msg
(
h
, "ccnd_create h=%p", h);

38 
	`cúd_run
(
h
);

39 
	`cúd_msg
(
h
, "exiting.");

40 
	}
}

	@ccnd/android_msg.c

23 
	~<¡dio.h
>

24 
	~<sys/time.h
>

25 
	~<¡d¬g.h
>

26 
	~<time.h
>

27 
	~<uni¡d.h
>

29 
	~<cú/cú.h
>

30 
	~<cú/cúd.h
>

31 
	~<cú/ch¬buf.h
>

32 
	~<cú/uri.h
>

34 
	~"cúd_´iv©e.h
"

36 
	~<ªdroid/log.h
>

47 
	$cúd_msg
(
cúd_hªdË
 *
h
, cÚ¡ *
fmt
, ...)

49 
timev®
 
t
;

50 
va_li¡
 
­
;

51 
cú_ch¬buf
 *
b
;

53 ià(
h
 !ğ
NULL
 && h->
debug
 == 0)

56 
b
 = 
	`cú_ch¬buf_ü—‹
();

58 
	`g‘timeofday
(&
t
, 
NULL
);

59 
	`cú_ch¬buf_putf
(
b
, "%ld.%06u ccnd[%d]: %s\n",

60 ()
t
.
tv_£c
, (é.
tv_u£c
, ()
	`g‘pid
(), 
fmt
);

61 
	`va_¡¬t
(
­
, 
fmt
);

63 
	`__ªdroid_log_v´št
(
ANDROID_LOG_INFO
, "CCND", (cÚ¡ *)
b
->
buf
, 
­
);

64 
	`va_’d
(
­
);

65 
	`cú_ch¬buf_de¡roy
(&
b
);

66 
	}
}

79 
	$cúd_debug_cúb
(
cúd_hªdË
 *
h
,

80 
lš’o
,

81 cÚ¡ *
msg
,

82 
çû
 *face,

83 cÚ¡ *
cúb
,

84 
size_t
 
cúb_size
)

86 
cú_ch¬buf
 *
c
;

87 
cú_·r£d_š‹»¡
 
pi
;

88 cÚ¡ *
nÚû
 = 
NULL
;

89 
size_t
 
nÚû_size
 = 0;

90 
size_t
 
i
;

92 ià(
h
 !ğ
NULL
 && h->
debug
 == 0)

94 
c
 = 
	`cú_ch¬buf_ü—‹
();

95 
	`cú_ch¬buf_putf
(
c
, "debug.%d % ", 
lš’o
, 
msg
);

96 ià(
çû
 !ğ
NULL
)

97 
	`cú_ch¬buf_putf
(
c
, "%u ", 
çû
->
çûid
);

98 
	`cú_uri_­³nd
(
c
, 
cúb
, 
cúb_size
, 1);

99 
	`cú_ch¬buf_putf
(
c
, " (%u by‹s)", ()
cúb_size
);

100 ià(
	`cú_·r£_š‹»¡
(
cúb
, 
cúb_size
, &
pi
, 
NULL
) >= 0) {

101 
	`cú_»f_gged_BLOB
(
CCN_DTAG_NÚû
, 
cúb
,

102 
pi
.
off£t
[
CCN_PI_B_NÚû
],

103 
pi
.
off£t
[
CCN_PI_E_NÚû
],

104 &
nÚû
,

105 &
nÚû_size
);

106 ià(
nÚû_size
 > 0) {

107 
	`cú_ch¬buf_putf
(
c
, " ");

108 
i
 = 0; i < 
nÚû_size
; i++)

109 
	`cú_ch¬buf_putf
(
c
, "%02X", 
nÚû
[
i
]);

112 
	`cúd_msg
(
h
, "%s", 
	`cú_ch¬buf_as_¡ršg
(
c
));

113 
	`cú_ch¬buf_de¡roy
(&
c
);

114 
	}
}

122 
	$cúd_u§ge
()

124 cÚ¡ 
cúd_u§ge_mes§ge
[] =

153 
	`årštf
(
¡d”r
, 
cúd_u§ge_mes§ge
, 
CCN_DEFAULT_UNICAST_PORT
);

154 
	}
}

	@ccnd/ccnd.c

20 
	~<”ºo.h
>

21 
	~<fú.h
>

22 
	~<lim™s.h
>

23 
	~<Ãtdb.h
>

24 
	~<pŞl.h
>

25 
	~<sigÇl.h
>

26 
	~<¡ddef.h
>

27 
	~<¡dšt.h
>

28 
	~<¡dio.h
>

29 
	~<¡dlib.h
>

30 
	~<¡ršg.h
>

31 
	~<time.h
>

32 
	~<uni¡d.h
>

33 
	~<¬·/š‘.h
>

34 
	~<sys/time.h
>

35 
	~<sys/sock‘.h
>

36 
	~<sys/¡©.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/un.h
>

39 
	~<Ãtš‘/š.h
>

41 #ià
defšed
(
NEED_GETADDRINFO_COMPAT
)

42 
	~"g‘addršfo.h
"

43 
	~"dummyš6.h
"

46 
	~<cú/bloom.h
>

47 
	~<cú/cú.h
>

48 
	~<cú/cú_´iv©e.h
>

49 
	~<cú/cúd.h
>

50 
	~<cú/ch¬buf.h
>

51 
	~<cú/çû_mgmt.h
>

52 
	~<cú/hashtb.h
>

53 
	~<cú/šdexbuf.h
>

54 
	~<cú/scheduË.h
>

55 
	~<cú/»g_mgmt.h
>

56 
	~<cú/uri.h
>

58 
	~"cúd_´iv©e.h
"

59 
	#GOT_HERE
 
	`cúd_msg
(
h
, "© cúd.c:%d", 
__LINE__
);

	)

61 
ş—nup_©_ex™
();

62 
uÆšk_©_ex™
(cÚ¡ *
·th
);

63 
ü—‹_loÿl_li¡’”
(
cúd_hªdË
 *
h
, cÚ¡ *
sockÇme
, 
backlog
);

64 
çû
 *
»cÜd_cÚÃùiÚ
(
cúd_hªdË
 *
h
,

65 
fd
,

66 
sockaddr
 *
who
,

67 
sockËn_t
 
whŞ’
,

68 
£tæags
);

69 
´oûss_šput_mes§ge
(
cúd_hªdË
 *
h
, 
çû
 *face,

70 *
msg
, 
size_t
 
size
, 
pdu_ok
);

71 
´oûss_šput
(
cúd_hªdË
 *
h
, 
fd
);

72 
cú_¡uff_š‹»¡
(
cúd_hªdË
 *
h
,

73 
çû
 *çû, 
cú_ch¬buf
 *
c
);

74 
do_deã¼ed_wr™e
(
cúd_hªdË
 *
h
, 
fd
);

75 
ş—n_Ãeded
(
cúd_hªdË
 *
h
);

76 
çû
 *
g‘_dg¿m_sourû
(
cúd_hªdË
 *
h
, face *face,

77 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
,

78 
why
);

79 
cÚ‹Á_skli¡_š£¹
(
cúd_hªdË
 *
h
,

80 
cÚ‹Á_’Œy
 *
cÚ‹Á
);

81 
cÚ‹Á_skli¡_»move
(
cúd_hªdË
 *
h
,

82 
cÚ‹Á_’Œy
 *
cÚ‹Á
);

83 
m¬k_¡®e
(
cúd_hªdË
 *
h
,

84 
cÚ‹Á_’Œy
 *
cÚ‹Á
);

85 
cú_acûssiÚ_t
 
cÚ‹Á_skli¡_Ãxt
(
cúd_hªdË
 *
h
,

86 
cÚ‹Á_’Œy
 *
cÚ‹Á
);

87 
»­_Ãeded
(
cúd_hªdË
 *
h
, 
š™_d–ay_u£c
);

88 
check_comm_fe
(
cúd_hªdË
 *
h
);

89 cÚ¡ *
	guÆšk_this_©_ex™
 = 
NULL
;

90 
Çm•»fix_’Œy
 *
Çm•»fix_fÜ_³
(
cúd_hªdË
 *
h
,

91 
´İag©šg_’Œy
 *
³
);

92 
Çm•»fix_£ek
(
cúd_hªdË
 *
h
,

93 
hashtb_’um”©Ü
 *
e
,

94 cÚ¡ *
msg
,

95 
cú_šdexbuf
 *
comps
,

96 
ncomps
);

97 
»gi¡”_Ãw_çû
(
cúd_hªdË
 *
h
, 
çû
 *face);

98 
upd©e_fÜw¬d_to
(
cúd_hªdË
 *
h
,

99 
Çm•»fix_’Œy
 *
Åe
);

101 
	$ş—nup_©_ex™
()

103 ià(
uÆšk_this_©_ex™
 !ğ
NULL
) {

104 
	`uÆšk
(
uÆšk_this_©_ex™
);

105 
uÆšk_this_©_ex™
 = 
NULL
;

107 
	}
}

110 
	$hªdË_çl_sigÇl
(
sig
)

112 
	`ş—nup_©_ex™
();

113 
	`_ex™
(
sig
);

114 
	}
}

117 
	$uÆšk_©_ex™
(cÚ¡ *
·th
)

119 ià(
uÆšk_this_©_ex™
 =ğ
NULL
) {

120 
Çm¡Ü
[(
sockaddr_un
)];

121 
	`¡ºıy
(
Çm¡Ü
, 
·th
, (namstor));

122 
uÆšk_this_©_ex™
 = 
Çm¡Ü
;

123 
	`sigÇl
(
SIGTERM
, &
hªdË_çl_sigÇl
);

124 
	`sigÇl
(
SIGINT
, &
hªdË_çl_sigÇl
);

125 
	`sigÇl
(
SIGHUP
, &
hªdË_çl_sigÇl
);

126 
	`©ex™
(&
ş—nup_©_ex™
);

128 
	}
}

131 
	$comm_fe_ok
()

133 
¡©
 
¡©buf
;

134 
»s
;

135 ià(
uÆšk_this_©_ex™
 =ğ
NULL
)

137 
»s
 = 
	`¡©
(
uÆšk_this_©_ex™
, &
¡©buf
);

138 ià(
»s
 == -1)

141 
	}
}

143 
cú_ch¬buf
 *

144 
	$ch¬buf_obš
(
cúd_hªdË
 *
h
)

146 
cú_ch¬buf
 *
c
 = 
h
->
sü©ch_ch¬buf
;

147 ià(
c
 =ğ
NULL
)

148 (
	`cú_ch¬buf_ü—‹
());

149 
h
->
sü©ch_ch¬buf
 = 
NULL
;

150 
c
->
Ëngth
 = 0;

151 (
c
);

152 
	}
}

155 
	$ch¬buf_»Ëa£
(
cúd_hªdË
 *
h
, 
cú_ch¬buf
 *
c
)

157 
c
->
Ëngth
 = 0;

158 ià(
h
->
sü©ch_ch¬buf
 =ğ
NULL
)

159 
h
->
sü©ch_ch¬buf
 = 
c
;

161 
	`cú_ch¬buf_de¡roy
(&
c
);

162 
	}
}

164 
cú_šdexbuf
 *

165 
	$šdexbuf_obš
(
cúd_hªdË
 *
h
)

167 
cú_šdexbuf
 *
c
 = 
h
->
sü©ch_šdexbuf
;

168 ià(
c
 =ğ
NULL
)

169 (
	`cú_šdexbuf_ü—‹
());

170 
h
->
sü©ch_šdexbuf
 = 
NULL
;

171 
c
->
n
 = 0;

172 (
c
);

173 
	}
}

176 
	$šdexbuf_»Ëa£
(
cúd_hªdË
 *
h
, 
cú_šdexbuf
 *
c
)

178 
c
->
n
 = 0;

179 ià(
h
->
sü©ch_šdexbuf
 =ğ
NULL
)

180 
h
->
sü©ch_šdexbuf
 = 
c
;

182 
	`cú_šdexbuf_de¡roy
(&
c
);

183 
	}
}

188 
çû
 *

189 
	$çû_äom_çûid
(
cúd_hªdË
 *
h
, 
çûid
)

191 
¦Ù
 = 
çûid
 & 
MAXFACES
;

192 
çû
 *çû = 
NULL
;

193 ià(
¦Ù
 < 
h
->
çû_lim™
) {

194 
çû
 = 
h
->
çûs_by_çûid
[
¦Ù
];

195 ià(
çû
 !ğ
NULL
 && faû->
çûid
 != faceid)

196 
çû
 = 
NULL
;

198 (
çû
);

199 
	}
}

204 
çû
 *

205 
	$cúd_çû_äom_çûid
(
cúd_hªdË
 *
h
, 
çûid
)

207 (
	`çû_äom_çûid
(
h
, 
çûid
));

208 
	}
}

215 
	$’rŞl_çû
(
cúd_hªdË
 *
h
, 
çû
 *face)

217 
i
;

218 
n
 = 
h
->
çû_lim™
;

219 
çû
 **
a
 = 
h
->
çûs_by_çûid
;

220 
i
 = 
h
->
çû_rov”
; i < 
n
; i++)

221 ià(
a
[
i
] =ğ
NULL
è
u£_i
;

222 
i
 = 0; i < 
n
; i++)

223 ià(
a
[
i
] =ğ
NULL
) {

225 
h
->
çû_g’
 +ğ
MAXFACES
 + 1;

226 
u£_i
;

228 
i
 = (
n
 + 1) * 3 / 2;

229 ià(
i
 > 
MAXFACES
) i = MAXFACES;

230 ià(
i
 <ğ
n
)

232 
a
 = 
	`»®loc
×, 
i
 * (
çû
 *));

233 ià(
a
 =ğ
NULL
)

235 
h
->
çû_lim™
 = 
i
;

236 --
i
 > 
n
)

237 
a
[
i
] = 
NULL
;

238 
h
->
çûs_by_çûid
 = 
a
;

239 
u£_i
:

240 
a
[
i
] = 
çû
;

241 
h
->
çû_rov”
 = 
i
 + 1;

242 
çû
->
çûid
 = 
i
 | 
h
->
çû_g’
;

243 
	`»gi¡”_Ãw_çû
(
h
, 
çû
);

244  (
çû
->
çûid
);

245 
	}
}

248 
	$choo£_çû_d–ay
(
cúd_hªdË
 *
h
, 
çû
 *çû, 
cq_d–ay_şass
 
c
)

250 
shiá
 = (
c
 =ğ
CCN_CQ_SLOW
) ? 2 : 0;

251 ià(
c
 =ğ
CCN_CQ_ASAP
)

253 ià((
çû
->
æags
 & 
CCN_FACE_LINK
) != 0)

254 ((
h
->
d©a_·u£_miüo£c
è<< 
shiá
);

255 ià((
çû
->
æags
 & 
CCN_FACE_LOCAL
) != 0)

257 ià((
çû
->
æags
 & 
CCN_FACE_MCAST
) != 0)

258 ((
h
->
d©a_·u£_miüo£c
è<< 
shiá
);

259 ià((
çû
->
æags
 & 
CCN_FACE_GG
) != 0)

260 (100 << 
shiá
);

261 ià((
çû
->
æags
 & 
CCN_FACE_DGRAM
) != 0)

262 (500 << 
shiá
);

264 
	}
}

266 
cÚ‹Á_queue
 *

267 
	$cÚ‹Á_queue_ü—‹
(
cúd_hªdË
 *
h
, 
çû
 *çû, 
cq_d–ay_şass
 
c
)

269 
cÚ‹Á_queue
 *
q
;

270 
u£c
;

271 
q
 = 
	`ÿÎoc
(1, (*q));

272 ià(
q
 !ğ
NULL
) {

273 
u£c
 = 
	`choo£_çû_d–ay
(
h
, 
çû
, 
c
);

274 
q
->
bur¡_n£c
 = (
u£c
 <= 500 ? 500 : 150000);

275 
q
->
mš_u£c
 = 
u£c
;

276 
q
->
¿nd_u£c
 = 2 * 
u£c
;

277 
q
->
Äun
 = 0;

278 
q
->
£nd_queue
 = 
	`cú_šdexbuf_ü—‹
();

279 ià(
q
->
£nd_queue
 =ğ
NULL
) {

280 
	`ä“
(
q
);

281 (
NULL
);

283 
q
->
£nd”
 = 
NULL
;

285 (
q
);

286 
	}
}

289 
	$cÚ‹Á_queue_de¡roy
(
cúd_hªdË
 *
h
, 
cÚ‹Á_queue
 **
pq
)

291 
cÚ‹Á_queue
 *
q
;

292 ià(*
pq
 !ğ
NULL
) {

293 
q
 = *
pq
;

294 
	`cú_šdexbuf_de¡roy
(&
q
->
£nd_queue
);

295 ià(
q
->
£nd”
 !ğ
NULL
) {

296 
	`cú_scheduË_ÿnûl
(
h
->
sched
, 
q
->
£nd”
);

297 
q
->
£nd”
 = 
NULL
;

299 
	`ä“
(
q
);

300 *
pq
 = 
NULL
;

302 
	}
}

308 
	$şo£_fd
(*
pfd
)

310 ià(*
pfd
 != -1) {

311 
	`şo£
(*
pfd
);

312 *
pfd
 = -1;

314 
	}
}

320 
	$cúd_şo£_fd
(
cúd_hªdË
 *
h
, 
çûid
, *
pfd
)

322 
»s
;

324 ià(*
pfd
 != -1) {

325 
lšg”
 = 0;

326 
	`£tsockİt
(*
pfd
, 
SOL_SOCKET
, 
SO_LINGER
,

327 &
lšg”
, (linger));

328 
»s
 = 
	`şo£
(*
pfd
);

329 ià(
»s
 == -1)

330 
	`cúd_msg
(
h
, "close failed for face %u fd=%d: %s (errno=%d)",

331 
çûid
, *
pfd
, 
	`¡»¼Ü
(
”ºo
),ƒrrno);

333 
	`cúd_msg
(
h
, "şosšg fd %d whfš®izšg faû %u", *
pfd
, 
çûid
);

334 *
pfd
 = -1;

336 
	}
}

339 
	$fš®ize_çû
(
hashtb_’um”©Ü
 *
e
)

341 
cúd_hªdË
 *
h
 = 
	`hashtb_g‘_·¿m
(
e
->
ht
, 
NULL
);

342 
çû
 *çû = 
e
->
d©a
;

343 
i
 = 
çû
->
çûid
 & 
MAXFACES
;

344 
cq_d–ay_şass
 
c
;

345 
»cyşe
 = 0;

347 ià(
i
 < 
h
->
çû_lim™
 && h->
çûs_by_çûid
[i] =ğ
çû
) {

348 ià((
çû
->
æags
 & 
CCN_FACE_UNDECIDED
) == 0)

349 
	`cúd_çû_¡©us_chªge
(
h
, 
çû
->
çûid
);

350 ià(
e
->
ht
 =ğ
h
->
çûs_by_fd
)

351 
	`cúd_şo£_fd
(
h
, 
çû
->
çûid
, &çû->
»cv_fd
);

352 
h
->
çûs_by_çûid
[
i
] = 
NULL
;

353 ià((
çû
->
æags
 & 
CCN_FACE_UNDECIDED
) != 0 &&

354 
çû
->
çûid
 =ğ((
h
->
çû_rov”
 - 1è| h->
çû_g’
)) {

356 
»cyşe
 = 1;

357 
h
->
çû_rov”
--;

359 
c
 = 0; c < 
CCN_CQ_N
; c++)

360 
	`cÚ‹Á_queue_de¡roy
(
h
, &(
çû
->
q
[
c
]));

361 
	`cúd_msg
(
h
, "%s face id %u (slot %u)",

362 
»cyşe
 ? "recycling" : "releasing",

363 
çû
->
çûid
, faû->çûid & 
MAXFACES
);

366 ià(
çû
->
çûid
 !ğ
CCN_NOFACEID
)

367 
	`cúd_msg
(
h
, "Üphªed faû %u", 
çû
->
çûid
);

368 
	`cú_ch¬buf_de¡roy
(&
çû
->
šbuf
);

369 
	`cú_ch¬buf_de¡roy
(&
çû
->
outbuf
);

370 
	}
}

372 
cÚ‹Á_’Œy
 *

373 
	$cÚ‹Á_äom_acûssiÚ
(
cúd_hªdË
 *
h
, 
cú_acûssiÚ_t
 
acûssiÚ
)

375 
cÚ‹Á_’Œy
 *
ªs
 = 
NULL
;

376 ià(
acûssiÚ
 < 
h
->
acûssiÚ_ba£
) {

377 
¥¬£_¡¿ggËr_’Œy
 *
’Œy
;

378 
’Œy
 = 
	`hashtb_lookup
(
h
->
¥¬£_¡¿ggËr_b
,

379 &
acûssiÚ
, (accession));

380 ià(
’Œy
 !ğ
NULL
)

381 
ªs
 = 
’Œy
->
cÚ‹Á
;

383 ià(
acûssiÚ
 < 
h
->
acûssiÚ_ba£
 + h->
cÚ‹Á_by_acûssiÚ_wšdow
) {

384 
ªs
 = 
h
->
cÚ‹Á_by_acûssiÚ
[
acûssiÚ
 - h->
acûssiÚ_ba£
];

385 ià(
ªs
 !ğ
NULL
 &&‡ns->
acûssiÚ
 !=‡ccession)

386 
ªs
 = 
NULL
;

388 (
ªs
);

389 
	}
}

392 
	$ş—nout_¡¿ggËrs
(
cúd_hªdË
 *
h
)

394 
cú_acûssiÚ_t
 
acûssiÚ
;

395 
hashtb_’um”©Ü
 
“
;

396 
hashtb_’um”©Ü
 *
e
 = &
“
;

397 
¥¬£_¡¿ggËr_’Œy
 *
’Œy
 = 
NULL
;

398 
cÚ‹Á_’Œy
 **
a
 = 
h
->
cÚ‹Á_by_acûssiÚ
;

399 
n_dœeù
;

400 
n_occup›d
;

401 
wšdow
;

402 
i
;

403 ià(
h
->
acûssiÚ
 <ğh->
acûssiÚ_ba£
 || 
a
[0] =ğ
NULL
)

405 
n_dœeù
 = 
h
->
acûssiÚ
 - h->
acûssiÚ_ba£
;

406 ià(
n_dœeù
 < 1000)

408 
n_occup›d
 = 
	`hashtb_n
(
h
->
cÚ‹Á_b
è- hashtb_n(h->
¥¬£_¡¿ggËr_b
);

409 ià(
n_occup›d
 >ğ(
n_dœeù
 / 8))

412 
	`hashtb_¡¬t
(
h
->
¥¬£_¡¿ggËr_b
, 
e
);

413 
wšdow
 = 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
;

414 
i
 = 0; i < 
wšdow
; i++) {

415 ià(
a
[
i
] !ğ
NULL
) {

416 ià(
n_occup›d
 >ğ((
wšdow
 - 
i
) / 8))

418 
acûssiÚ
 = 
h
->
acûssiÚ_ba£
 + 
i
;

419 
	`hashtb_£ek
(
e
, &
acûssiÚ
, (accession), 0);

420 
’Œy
 = 
e
->
d©a
;

421 ià(
’Œy
 !ğ
NULL
 &&ƒÁry->
cÚ‹Á
 == NULL) {

422 
’Œy
->
cÚ‹Á
 = 
a
[
i
];

423 
a
[
i
] = 
NULL
;

424 
n_occup›d
 -= 1;

428 
	`hashtb_’d
(
e
);

429 
	}
}

432 
	$ş—nout_em±›s
(
cúd_hªdË
 *
h
)

434 
i
 = 0;

435 
j
 = 0;

436 
cÚ‹Á_’Œy
 **
a
 = 
h
->
cÚ‹Á_by_acûssiÚ
;

437 
wšdow
 = 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
;

438 ià(
a
 =ğ
NULL
)

440 
	`ş—nout_¡¿ggËrs
(
h
);

441 
i
 < 
wšdow
 && 
a
[i] =ğ
NULL
)

442 
i
++;

443 ià(
i
 == 0)

445 
h
->
acûssiÚ_ba£
 +ğ
i
;

446 
i
 < 
wšdow
)

447 
a
[
j
++] =‡[
i
++];

448 
j
 < 
wšdow
)

449 
a
[
j
++] = 
NULL
;

451 
	}
}

454 
	$’rŞl_cÚ‹Á
(
cúd_hªdË
 *
h
, 
cÚ‹Á_’Œy
 *
cÚ‹Á
)

456 
Ãw_wšdow
;

457 
cÚ‹Á_’Œy
 **
Ãw_¬¿y
;

458 
cÚ‹Á_’Œy
 **
Şd_¬¿y
;

459 
i
 = 0;

460 
j
 = 0;

461 
wšdow
 = 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
;

462 ià((
cÚ‹Á
->
acûssiÚ
 - 
h
->
acûssiÚ_ba£
è>ğ
wšdow
 &&

463 
	`ş—nout_em±›s
(
h
) < 0) {

464 ià(
cÚ‹Á
->
acûssiÚ
 < 
h
->
acûssiÚ_ba£
)

466 
wšdow
 = 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
;

467 
Şd_¬¿y
 = 
h
->
cÚ‹Á_by_acûssiÚ
;

468 
Ãw_wšdow
 = ((
wšdow
 + 20) * 3 / 2);

469 ià(
Ãw_wšdow
 < 
wšdow
)

471 
Ãw_¬¿y
 = 
	`ÿÎoc
(
Ãw_wšdow
, (new_array[0]));

472 ià(
Ãw_¬¿y
 =ğ
NULL
)

474 
i
 < 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
 && 
Şd_¬¿y
[i] =ğ
NULL
)

475 
i
++;

476 
h
->
acûssiÚ_ba£
 +ğ
i
;

477 
h
->
cÚ‹Á_by_acûssiÚ
 = 
Ãw_¬¿y
;

478 
i
 < 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
)

479 
Ãw_¬¿y
[
j
++] = 
Şd_¬¿y
[
i
++];

480 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
 = 
Ãw_wšdow
;

481 
	`ä“
(
Şd_¬¿y
);

483 
h
->
cÚ‹Á_by_acûssiÚ
[
cÚ‹Á
->
acûssiÚ
 - h->
acûssiÚ_ba£
] = content;

484 
	}
}

487 
	$fš®ize_cÚ‹Á
(
hashtb_’um”©Ü
 *
cÚ‹Á_’um”©Ü
)

489 
cúd_hªdË
 *
h
 = 
	`hashtb_g‘_·¿m
(
cÚ‹Á_’um”©Ü
->
ht
, 
NULL
);

490 
cÚ‹Á_’Œy
 *
’Œy
 = 
cÚ‹Á_’um”©Ü
->
d©a
;

491 
i
 = 
’Œy
->
acûssiÚ
 - 
h
->
acûssiÚ_ba£
;

492 ià(
i
 < 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
 &&

493 
h
->
cÚ‹Á_by_acûssiÚ
[
i
] =ğ
’Œy
) {

494 
	`cÚ‹Á_skli¡_»move
(
h
, 
’Œy
);

495 
h
->
cÚ‹Á_by_acûssiÚ
[
i
] = 
NULL
;

498 
hashtb_’um”©Ü
 
“
;

499 
hashtb_’um”©Ü
 *
e
 = &
“
;

500 
	`hashtb_¡¬t
(
h
->
¥¬£_¡¿ggËr_b
, 
e
);

501 ià(
	`hashtb_£ek
(
e
, &
’Œy
->
acûssiÚ
, (entry->accession), 0) ==

502 
HT_NEW_ENTRY
) {

503 
	`cúd_msg
(
h
, "orphaned content %llu",

504 ()(
’Œy
->
acûssiÚ
));

505 
	`hashtb_d–‘e
(
e
);

506 
	`hashtb_’d
(
e
);

509 
	`cÚ‹Á_skli¡_»move
(
h
, 
’Œy
);

510 
	`hashtb_d–‘e
(
e
);

511 
	`hashtb_’d
(
e
);

513 ià(
’Œy
->
comps
 !ğ
NULL
) {

514 
	`ä“
(
’Œy
->
comps
);

515 
’Œy
->
comps
 = 
NULL
;

517 
	}
}

520 
	$cÚ‹Á_skli¡_fšdbefÜe
(
cúd_hªdË
 *
h
,

521 cÚ¡ *
key
,

522 
size_t
 
keysize
,

523 
cÚ‹Á_’Œy
 *
wª‹d_Şd
,

524 
cú_šdexbuf
 **
ªs
)

526 
i
;

527 
n
 = 
h
->
sklšks
->n;

528 
cú_šdexbuf
 *
c
;

529 
cÚ‹Á_’Œy
 *
cÚ‹Á
;

530 
Üd”
;

531 
size_t
 
¡¬t
;

532 
size_t
 
’d
;

534 
c
 = 
h
->
sklšks
;

535 
i
 = 
n
 - 1; i >= 0; i--) {

537 ià(
c
->
buf
[
i
] == 0)

539 
cÚ‹Á
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
c
->
buf
[
i
]);

540 ià(
cÚ‹Á
 =ğ
NULL
)

541 
	`abÜt
();

542 
¡¬t
 = 
cÚ‹Á
->
comps
[0];

543 
’d
 = 
cÚ‹Á
->
comps
[cÚ‹Á->
ncomps
 - 1];

544 
Üd”
 = 
	`cú_com·»_Çmes
(
cÚ‹Á
->
key
 + 
¡¬t
 - 1, 
’d
 - start + 2,

545 
key
, 
keysize
);

546 ià(
Üd”
 > 0)

548 ià(
Üd”
 =ğ0 && (
wª‹d_Şd
 =ğ
cÚ‹Á
 || wª‹d_Şd =ğ
NULL
))

550 ià(
cÚ‹Á
->
sklšks
 =ğ
NULL
 || 
i
 >ğcÚ‹Á->sklšks->
n
)

551 
	`abÜt
();

552 
c
 = 
cÚ‹Á
->
sklšks
;

554 
ªs
[
i
] = 
c
;

556 (
n
);

557 
	}
}

559 
	#CCN_SKIPLIST_MAX_DEPTH
 30

	)

561 
	$cÚ‹Á_skli¡_š£¹
(
cúd_hªdË
 *
h
, 
cÚ‹Á_’Œy
 *
cÚ‹Á
)

563 
d
;

564 
i
;

565 
size_t
 
¡¬t
;

566 
size_t
 
’d
;

567 
cú_šdexbuf
 *
´ed
[
CCN_SKIPLIST_MAX_DEPTH
] = {
NULL
};

568 ià(
cÚ‹Á
->
sklšks
 !ğ
NULL
è
	`abÜt
();

569 
d
 = 1; d < 
CCN_SKIPLIST_MAX_DEPTH
 - 1; d++)

570 ià((
	`Äªd48
(
h
->
£ed
) & 3) != 0) ;

571 
h
->
sklšks
->
n
 < 
d
)

572 
	`cú_šdexbuf_­³nd_–em’t
(
h
->
sklšks
, 0);

573 
¡¬t
 = 
cÚ‹Á
->
comps
[0];

574 
’d
 = 
cÚ‹Á
->
comps
[cÚ‹Á->
ncomps
 - 1];

575 
i
 = 
	`cÚ‹Á_skli¡_fšdbefÜe
(
h
,

576 
cÚ‹Á
->
key
 + 
¡¬t
 - 1,

577 
’d
 - 
¡¬t
 + 2, 
NULL
, 
´ed
);

578 ià(
i
 < 
d
)

579 
d
 = 
i
;

580 
cÚ‹Á
->
sklšks
 = 
	`cú_šdexbuf_ü—‹
();

581 
i
 = 0; i < 
d
; i++) {

582 
	`cú_šdexbuf_­³nd_–em’t
(
cÚ‹Á
->
sklšks
, 
´ed
[
i
]->
buf
[i]);

583 
´ed
[
i
]->
buf
[i] = 
cÚ‹Á
->
acûssiÚ
;

585 
	}
}

588 
	$cÚ‹Á_skli¡_»move
(
cúd_hªdË
 *
h
, 
cÚ‹Á_’Œy
 *
cÚ‹Á
)

590 
i
;

591 
d
;

592 
size_t
 
¡¬t
;

593 
size_t
 
’d
;

594 
cú_šdexbuf
 *
´ed
[
CCN_SKIPLIST_MAX_DEPTH
] = {
NULL
};

595 ià(
cÚ‹Á
->
sklšks
 =ğ
NULL
è
	`abÜt
();

596 
¡¬t
 = 
cÚ‹Á
->
comps
[0];

597 
’d
 = 
cÚ‹Á
->
comps
[cÚ‹Á->
ncomps
 - 1];

598 
d
 = 
	`cÚ‹Á_skli¡_fšdbefÜe
(
h
,

599 
cÚ‹Á
->
key
 + 
¡¬t
 - 1,

600 
’d
 - 
¡¬t
 + 2, 
cÚ‹Á
, 
´ed
);

601 ià(
d
 > 
cÚ‹Á
->
sklšks
->
n
)

602 
d
 = 
cÚ‹Á
->
sklšks
->
n
;

603 
i
 = 0; i < 
d
; i++) {

604 
´ed
[
i
]->
buf
[i] = 
cÚ‹Á
->
sklšks
->buf[i];

606 
	`cú_šdexbuf_de¡roy
(&
cÚ‹Á
->
sklšks
);

607 
	}
}

609 
cÚ‹Á_’Œy
 *

610 
	$fšd_fœ¡_m©ch_ÿndid©e
(
cúd_hªdË
 *
h
,

611 cÚ¡ *
š‹»¡_msg
,

612 cÚ¡ 
cú_·r£d_š‹»¡
 *
pi
)

614 
»s
;

615 
cú_šdexbuf
 *
´ed
[
CCN_SKIPLIST_MAX_DEPTH
] = {
NULL
};

616 
size_t
 
¡¬t
 = 
pi
->
off£t
[
CCN_PI_B_Name
];

617 
size_t
 
’d
 = 
pi
->
off£t
[
CCN_PI_E_Name
];

618 
cú_ch¬buf
 *
Çmebuf
 = 
NULL
;

619 ià(
pi
->
off£t
[
CCN_PI_B_Exşude
] <…i->off£t[
CCN_PI_E_Exşude
]) {

621 
cú_buf_decod”
 
decod”
;

622 
cú_buf_decod”
 *
d
;

623 
size_t
 
ex1¡¬t
;

624 
size_t
 
ex1’d
;

625 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
,

626 
š‹»¡_msg
 + 
pi
->
off£t
[
CCN_PI_B_Exşude
],

627 
pi
->
off£t
[
CCN_PI_E_Exşude
] -

628 
pi
->
off£t
[
CCN_PI_B_Exşude
]);

629 
	`cú_buf_advªû
(
d
);

630 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Any
)) {

631 
	`cú_buf_advªû
(
d
);

632 
	`cú_buf_check_şo£
(
d
);

633 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

634 
ex1¡¬t
 = 
pi
->
off£t
[
CCN_PI_B_Exşude
] + 
d
->
decod”
.
tok’_šdex
;

635 
	`cú_buf_advªû_·¡_–em’t
(
d
);

636 
ex1’d
 = 
pi
->
off£t
[
CCN_PI_B_Exşude
] + 
d
->
decod”
.
tok’_šdex
;

637 ià(
d
->
decod”
.
¡©e
 >= 0) {

638 
Çmebuf
 = 
	`cú_ch¬buf_ü—‹
();

639 
	`cú_ch¬buf_­³nd
(
Çmebuf
,

640 
š‹»¡_msg
 + 
¡¬t
,

641 
’d
 - 
¡¬t
);

642 
Çmebuf
->
Ëngth
--;

643 
	`cú_ch¬buf_­³nd
(
Çmebuf
,

644 
š‹»¡_msg
 + 
ex1¡¬t
,

645 
ex1’d
 - 
ex1¡¬t
);

646 
	`cú_ch¬buf_­³nd_şo£r
(
Çmebuf
);

647 ià(
h
->
debug
 & 8)

648 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "ç¡ex", 
NULL
,

649 
Çmebuf
->
buf
,‚amebuf->
Ëngth
);

654 ià(
Çmebuf
 =ğ
NULL
) {

655 
»s
 = 
	`cÚ‹Á_skli¡_fšdbefÜe
(
h
, 
š‹»¡_msg
 + 
¡¬t
, 
’d
 - start,

656 
NULL
, 
´ed
);

659 
»s
 = 
	`cÚ‹Á_skli¡_fšdbefÜe
(
h
, 
Çmebuf
->
buf
,‚amebuf->
Ëngth
,

660 
NULL
, 
´ed
);

661 
	`cú_ch¬buf_de¡roy
(&
Çmebuf
);

663 ià(
»s
 == 0)

664 (
NULL
);

665 (
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
´ed
[0]->
buf
[0]));

666 
	}
}

669 
	$cÚ‹Á_m©ches_š‹»¡_´efix
(
cúd_hªdË
 *
h
,

670 
cÚ‹Á_’Œy
 *
cÚ‹Á
,

671 cÚ¡ *
š‹»¡_msg
,

672 
cú_šdexbuf
 *
comps
,

673 
´efix_comps
)

675 
size_t
 
´efixËn
;

676 ià(
´efix_comps
 < 0 ||…»fix_comp >ğ
comps
->
n
)

677 
	`abÜt
();

679 ià(
cÚ‹Á
->
ncomps
 < 
´efix_comps
 + 1)

681 
´efixËn
 = 
comps
->
buf
[
´efix_comps
] - comps->buf[0];

682 ià(
cÚ‹Á
->
comps
[
´efix_comps
] - cÚ‹Á->comps[0] !ğ
´efixËn
)

684 ià(0 !ğ
	`memcmp
(
cÚ‹Á
->
key
 + cÚ‹Á->
comps
[0],

685 
š‹»¡_msg
 + 
comps
->
buf
[0],

686 
´efixËn
))

689 
	}
}

691 
cú_acûssiÚ_t


692 
	$cÚ‹Á_skli¡_Ãxt
(
cúd_hªdË
 *
h
, 
cÚ‹Á_’Œy
 *
cÚ‹Á
)

694 ià(
cÚ‹Á
 =ğ
NULL
)

696 ià(
cÚ‹Á
->
sklšks
 =ğ
NULL
 || cÚ‹Á->sklšks->
n
 < 1)

698 (
cÚ‹Á
->
sklšks
->
buf
[0]);

699 
	}
}

702 
	$cÚsume
(
cúd_hªdË
 *
h
, 
´İag©šg_’Œy
 *
³
)

704 
çû
 *çû = 
NULL
;

705 
	`cú_šdexbuf_de¡roy
(&
³
->
outbound
);

706 ià(
³
->
š‹»¡_msg
 !ğ
NULL
) {

707 
	`ä“
(
³
->
š‹»¡_msg
);

708 
³
->
š‹»¡_msg
 = 
NULL
;

709 
çû
 = 
	`çû_äom_çûid
(
h
, 
³
->
çûid
);

710 ià(
çû
 !ğ
NULL
)

711 
çû
->
³ndšg_š‹»¡s
 -= 1;

713 ià(
³
->
Ãxt
 !ğ
NULL
) {

714 
³
->
Ãxt
->
´ev
 =…e->prev;

715 
³
->
´ev
->
Ãxt
 =…e->next;

716 
³
->
Ãxt
 =…e->
´ev
 = 
NULL
;

718 
³
->
u£c
 = 0;

719 
	}
}

722 
	$fš®ize_Çm•»fix
(
hashtb_’um”©Ü
 *
e
)

724 
cúd_hªdË
 *
h
 = 
	`hashtb_g‘_·¿m
(
e
->
ht
, 
NULL
);

725 
Çm•»fix_’Œy
 *
Åe
 = 
e
->
d©a
;

726 
´İag©šg_’Œy
 *
h—d
 = &
Åe
->
³_h—d
;

727 ià(
h—d
->
Ãxt
 !ğ
NULL
) {

728 
h—d
->
Ãxt
 != head)

729 
	`cÚsume
(
h
, 
h—d
->
Ãxt
);

731 
	`cú_šdexbuf_de¡roy
(&
Åe
->
fÜw¬d_to
);

732 
	`cú_šdexbuf_de¡roy
(&
Åe
->
p
);

733 
Åe
->
fÜw¬dšg
 !ğ
NULL
) {

734 
cú_fÜw¬dšg
 *
f
 = 
Åe
->
fÜw¬dšg
;

735 
Åe
->
fÜw¬dšg
 = 
f
->
Ãxt
;

736 
	`ä“
(
f
);

738 
	}
}

741 
	$lšk_´İag©šg_š‹»¡_to_Çm•»fix
(
cúd_hªdË
 *
h
,

742 
´İag©šg_’Œy
 *
³
, 
Çm•»fix_’Œy
 *
Åe
)

744 
´İag©šg_’Œy
 *
h—d
 = &
Åe
->
³_h—d
;

745 
³
->
Ãxt
 = 
h—d
;

746 
³
->
´ev
 = 
h—d
->prev;

747 
³
->
´ev
->
Ãxt
 =…e->next->prev =…e;

748 
	}
}

751 
	$fš®ize_´İag©šg
(
hashtb_’um”©Ü
 *
e
)

753 
cúd_hªdË
 *
h
 = 
	`hashtb_g‘_·¿m
(
e
->
ht
, 
NULL
);

754 
	`cÚsume
(
h
, 
e
->
d©a
);

755 
	}
}

758 
	$ü—‹_loÿl_li¡’”
(
cúd_hªdË
 *
h
, cÚ¡ *
sockÇme
, 
backlog
)

760 
»s
;

761 
§vedmask
;

762 
sock
;

763 
sockaddr_un
 
a
 = { 0 };

764 
»s
 = 
	`uÆšk
(
sockÇme
);

765 ià(
»s
 == 0) {

766 
	`cúd_msg
(
NULL
, "uÆšked old %s,…Ëa£ wa™", 
sockÇme
);

767 
	`¦“p
(9);

769 ià(!(
»s
 =ğ0 || 
”ºo
 =ğ
ENOENT
))

770 
	`cúd_msg
(
NULL
, "çedØuÆšk %s", 
sockÇme
);

771 
a
.
sun_çmy
 = 
AF_UNIX
;

772 
	`¡ºıy
(
a
.
sun_·th
, 
sockÇme
, (a.sun_path));

773 
sock
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

774 ià(
sock
 == -1)

775 (
sock
);

776 
§vedmask
 = 
	`umask
(0111);

777 
»s
 = 
	`bšd
(
sock
, (
sockaddr
 *)&
a
, (a));

778 
	`umask
(
§vedmask
);

779 ià(
»s
 == -1) {

780 
	`şo£
(
sock
);

783 
	`uÆšk_©_ex™
(
sockÇme
);

784 
»s
 = 
	`li¡’
(
sock
, 
backlog
);

785 ià(
»s
 == -1) {

786 
	`şo£
(
sock
);

789 
	`»cÜd_cÚÃùiÚ
(
h
, 
sock
, (
sockaddr
 *)&
a
, (a),

790 (
CCN_FACE_LOCAL
 | 
CCN_FACE_PASSIVE
));

791 (
sock
);

792 
	}
}

795 
	$e¡ablish_mš_»cv_bufsize
(
cúd_hªdË
 *
h
, 
fd
, 
mšsize
)

797 
»s
;

798 
rcvbuf
;

799 
sockËn_t
 
rcvbuf_sz
;

801 
rcvbuf_sz
 = (
rcvbuf
);

802 
»s
 = 
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
rcvbuf
, &
rcvbuf_sz
);

803 ià(
»s
 == -1)

804  (
»s
);

805 ià(
rcvbuf
 < 
mšsize
) {

806 
rcvbuf
 = 
mšsize
;

807 
»s
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
rcvbuf
, (rcvbuf));

808 ià(
»s
 == -1)

809 (
»s
);

811 
	`cúd_msg
(
h
, "SO_RCVBUF fÜ fd %d i %d", 
fd
, 
rcvbuf
);

812 (
rcvbuf
);

813 
	}
}

820 
	$š™_çû_æags
(
cúd_hªdË
 *
h
, 
çû
 *çû, 
£tæags
)

822 cÚ¡ 
sockaddr
 *
addr
 = 
çû
->addr;

823 cÚ¡ *
¿waddr
 = 
NULL
;

825 ià(
addr
->
§_çmy
 =ğ
AF_INET6
) {

826 cÚ¡ 
sockaddr_š6
 *
addr6
 = (sockaddr_š6 *)
addr
;

827 
çû
->
æags
 |ğ
CCN_FACE_INET6
;

828 #ifdeà
IN6_IS_ADDR_LOOPBACK


829 ià(
	`IN6_IS_ADDR_LOOPBACK
(&
addr6
->
sš6_addr
))

830 
çû
->
æags
 |ğ
CCN_FACE_LOOPBACK
;

833 ià(
addr
->
§_çmy
 =ğ
AF_INET
) {

834 cÚ¡ 
sockaddr_š
 *
addr4
 = (sockaddr_š *)
addr
;

835 
¿waddr
 = (cÚ¡ *)&
addr4
->
sš_addr
.
s_addr
;

836 
çû
->
æags
 |ğ
CCN_FACE_INET
;

837 ià(
¿waddr
[0] == 127)

838 
çû
->
æags
 |ğ
CCN_FACE_LOOPBACK
;

840 ià(
addr
->
§_çmy
 =ğ
AF_UNIX
)

841 
çû
->
æags
 |ğ(
CCN_FACE_GG
 | 
CCN_FACE_LOCAL
);

842 
çû
->
æags
 |ğ
£tæags
;

843 
	}
}

848 
çû
 *

849 
	$»cÜd_cÚÃùiÚ
(
cúd_hªdË
 *
h
, 
fd
,

850 
sockaddr
 *
who
, 
sockËn_t
 
whŞ’
,

851 
£tæags
)

853 
hashtb_’um”©Ü
 
“
;

854 
hashtb_’um”©Ü
 *
e
 = &
“
;

855 
»s
;

856 
çû
 *çû = 
NULL
;

857 *
addr¥aû
;

859 
»s
 = 
	`fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
);

860 ià(
»s
 == -1)

861 
	`cúd_msg
(
h
, "fú: %s", 
	`¡»¼Ü
(
”ºo
));

862 
	`hashtb_¡¬t
(
h
->
çûs_by_fd
, 
e
);

863 ià(
	`hashtb_£ek
(
e
, &
fd
, (fd), 
whŞ’
è=ğ
HT_NEW_ENTRY
) {

864 
çû
 = 
e
->
d©a
;

865 
çû
->
»cv_fd
 = 
fd
;

866 
çû
->
£ndçû
 = 
CCN_NOFACEID
;

867 
çû
->
add¾’
 = 
e
->
extsize
;

868 
addr¥aû
 = ((*)
e
->
key
è+ƒ->
keysize
;

869 
çû
->
addr
 = (
sockaddr
 *)
addr¥aû
;

870 
	`memıy
(
addr¥aû
, 
who
, 
e
->
extsize
);

871 
	`š™_çû_æags
(
h
, 
çû
, 
£tæags
);

872 
»s
 = 
	`’rŞl_çû
(
h
, 
çû
);

873 ià(
»s
 == -1) {

874 
	`hashtb_d–‘e
(
e
);

875 
çû
 = 
NULL
;

878 
	`hashtb_’d
(
e
);

879 (
çû
);

880 
	}
}

887 
	$acû±_cÚÃùiÚ
(
cúd_hªdË
 *
h
, 
li¡’”_fd
)

889 
sockaddr_¡Üage
 
who
;

890 
sockËn_t
 
whŞ’
 = (
who
);

891 
fd
;

892 
çû
 *face;

894 
fd
 = 
	`acû±
(
li¡’”_fd
, (
sockaddr
 *)&
who
, &
whŞ’
);

895 ià(
fd
 == -1) {

896 
	`cúd_msg
(
h
, "acû±: %s", 
	`¡»¼Ü
(
”ºo
));

899 
çû
 = 
	`»cÜd_cÚÃùiÚ
(
h
, 
fd
,

900 (
sockaddr
 *)&
who
, 
whŞ’
,

901 
CCN_FACE_UNDECIDED
);

902 ià(
çû
 =ğ
NULL
)

903 
	`şo£_fd
(&
fd
);

905 
	`cúd_msg
(
h
, "acû±ed cl›Á fd=%d id=%u", 
fd
, 
çû
->
çûid
);

906 (
fd
);

907 
	}
}

912 
çû
 *

913 
	$make_cÚÃùiÚ
(
cúd_hªdË
 *
h
,

914 
sockaddr
 *
who
, 
sockËn_t
 
whŞ’
,

915 
£tæags
)

917 
hashtb_’um”©Ü
 
“
;

918 
hashtb_’um”©Ü
 *
e
 = &
“
;

919 
fd
;

920 
»s
;

921 
çû
 *face;

922 cÚ¡ 
checkæags
 = 
CCN_FACE_LINK
 | 
CCN_FACE_DGRAM
 | 
CCN_FACE_LOCAL
 |

923 
CCN_FACE_NOSEND
 | 
CCN_FACE_UNDECIDED
;

924 cÚ¡ 
wªtæags
 = 0;

927 
	`hashtb_¡¬t
(
h
->
çûs_by_fd
, 
e
);ƒ->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

928 
çû
 = 
e
->
d©a
;

929 ià(
çû
->
addr
 !ğ
NULL
 && faû->
add¾’
 =ğ
whŞ’
 &&

930 ((
çû
->
æags
 & 
checkæags
è=ğ
wªtæags
) &&

931 0 =ğ
	`memcmp
(
çû
->
addr
, 
who
, 
whŞ’
)) {

932 
	`hashtb_’d
(
e
);

933 (
çû
);

936 
çû
 = 
NULL
;

937 
	`hashtb_’d
(
e
);

939 
fd
 = 
	`sock‘
(
who
->
§_çmy
, 
SOCK_STREAM
, 0);

940 ià(
fd
 == -1) {

941 
	`cúd_msg
(
h
, "sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

942 (
NULL
);

944 
»s
 = 
	`fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
);

945 ià(
»s
 == -1)

946 
	`cúd_msg
(
h
, "cÚÃù fú: %s", 
	`¡»¼Ü
(
”ºo
));

947 
£tæags
 &ğ~
CCN_FACE_CONNECTING
;

948 
»s
 = 
	`cÚÃù
(
fd
, 
who
, 
whŞ’
);

949 ià(
»s
 =ğ-1 && 
”ºo
 =ğ
EINPROGRESS
) {

950 
»s
 = 0;

951 
£tæags
 |ğ
CCN_FACE_CONNECTING
;

953 ià(
»s
 == -1) {

954 
	`cúd_msg
(
h
, "cÚÃù faed: % Ó¼nØğ%d)", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

955 
	`şo£
(
fd
);

956 (
NULL
);

958 
çû
 = 
	`»cÜd_cÚÃùiÚ
(
h
, 
fd
, 
who
, 
whŞ’
, 
£tæags
);

959 ià(
çû
 =ğ
NULL
) {

960 
	`şo£
(
fd
);

961 (
NULL
);

963 ià((
çû
->
æags
 & 
CCN_FACE_CONNECTING
) != 0) {

964 
	`cúd_msg
(
h
, "cÚÃùšgØş›Á fd=%d id=%u", 
fd
, 
çû
->
çûid
);

965 
çû
->
outbufšdex
 = 0;

966 
çû
->
outbuf
 = 
	`cú_ch¬buf_ü—‹
();

969 
	`cúd_msg
(
h
, "cÚÃùed cl›Á fd=%d id=%u", 
fd
, 
çû
->
çûid
);

970 (
çû
);

971 
	}
}

974 
	$cúd_g‘boundsock‘
(*
d©
, 
sockaddr
 *
who
, 
sockËn_t
 
whŞ’
)

976 
cúd_hªdË
 *
h
 = 
d©
;

977 
hashtb_’um”©Ü
 
“
;

978 
hashtb_’um”©Ü
 *
e
 = &
“
;

979 
yes
 = 1;

980 
»s
;

981 
ªs
 = -1;

982 
wªtæags
 = (
CCN_FACE_DGRAM
 | 
CCN_FACE_PASSIVE
);

983 
	`hashtb_¡¬t
(
h
->
çûs_by_fd
, 
e
);ƒ->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

984 
çû
 *çû = 
e
->
d©a
;

985 ià((
çû
->
æags
 & 
wªtæags
) == wantflags &&

986 
whŞ’
 =ğ
çû
->
add¾’
 &&

987 0 =ğ
	`memcmp
(
who
, 
çû
->
addr
, 
whŞ’
)) {

988 
ªs
 = 
çû
->
»cv_fd
;

992 
	`hashtb_’d
(
e
);

993 ià(
ªs
 != -1)

994 (
ªs
);

995 
ªs
 = 
	`sock‘
(
who
->
§_çmy
, 
SOCK_DGRAM
, 0);

996 ià(
ªs
 == -1)

997 (
ªs
);

998 
	`£tsockİt
(
ªs
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes));

999 
»s
 = 
	`bšd
(
ªs
, 
who
, 
whŞ’
);

1000 ià(
»s
 == -1) {

1001 
	`cúd_msg
(
h
, "bšd faed: % Ó¼nØğ%d)", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

1002 
	`şo£
(
ªs
);

1005 
	`»cÜd_cÚÃùiÚ
(
h
, 
ªs
, 
who
, 
whŞ’
,

1006 
CCN_FACE_DGRAM
 | 
CCN_FACE_PASSIVE
 | 
CCN_FACE_NORECV
);

1007 (
ªs
);

1008 
	}
}

1011 
	$çûid_äom_fd
(
cúd_hªdË
 *
h
, 
fd
)

1013 
çû
 *çû = 
	`hashtb_lookup
(
h
->
çûs_by_fd
, &
fd
, (fd));

1014 ià(
çû
 !ğ
NULL
)

1015 (
çû
->
çûid
);

1016 (
CCN_NOFACEID
);

1017 
	}
}

1019 (*
	tlogg”´oc
)(*, const *, ...);

1020 
çû
 *

1021 
	$£tup_muÉiÿ¡
(
cúd_hªdË
 *
h
, 
cú_çû_š¡ªû
 *
çû_š¡ªû
,

1022 
sockaddr
 *
who
, 
sockËn_t
 
whŞ’
)

1024 
hashtb_’um”©Ü
 
“
;

1025 
hashtb_’um”©Ü
 *
e
 = &
“
;

1026 
cú_sock‘s
 
socks
 = { -1, -1 };

1027 
»s
;

1028 
çû
 *çû = 
NULL
;

1029 cÚ¡ 
checkæags
 = 
CCN_FACE_LINK
 | 
CCN_FACE_DGRAM
 | 
CCN_FACE_MCAST
 |

1030 
CCN_FACE_LOCAL
 | 
CCN_FACE_NOSEND
;

1031 cÚ¡ 
wªtæags
 = 
CCN_FACE_DGRAM
 | 
CCN_FACE_MCAST
;

1035 
	`hashtb_¡¬t
(
h
->
çûs_by_fd
, 
e
);ƒ->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

1036 
çû
 = 
e
->
d©a
;

1037 ià(
çû
->
addr
 !ğ
NULL
 && faû->
add¾’
 =ğ
whŞ’
 &&

1038 ((
çû
->
æags
 & 
checkæags
è=ğ
wªtæags
) &&

1039 0 =ğ
	`memcmp
(
çû
->
addr
, 
who
, 
whŞ’
)) {

1040 
	`hashtb_’d
(
e
);

1041 (
çû
);

1044 
çû
 = 
NULL
;

1045 
	`hashtb_’d
(
e
);

1047 
»s
 = 
	`cú_£tup_sock‘
(&
çû_š¡ªû
->
desü
,

1048 (
logg”´oc
)&
cúd_msg
, (*)
h
,

1049 &
cúd_g‘boundsock‘
, (*)
h
,

1050 &
socks
);

1051 ià(
»s
 < 0)

1052 (
NULL
);

1053 
	`e¡ablish_mš_»cv_bufsize
(
h
, 
socks
.
»cvšg
, 128*1024);

1054 
çû
 = 
	`»cÜd_cÚÃùiÚ
(
h
, 
socks
.
»cvšg
, 
who
, 
whŞ’
,

1055 (
CCN_FACE_MCAST
 | 
CCN_FACE_DGRAM
));

1056 ià(
çû
 =ğ
NULL
) {

1057 
	`şo£
(
socks
.
»cvšg
);

1058 ià(
socks
.
£ndšg
 !ğsocks.
»cvšg
)

1059 
	`şo£
(
socks
.
£ndšg
);

1060 (
NULL
);

1062 
çû
->
£ndçû
 = 
	`çûid_äom_fd
(
h
, 
socks
.
£ndšg
);

1063 
	`cúd_msg
(
h
, "multicast on fd=%d id=%u, sending on face %u",

1064 
çû
->
»cv_fd
, faû->
çûid
, faû->
£ndçû
);

1065 (
çû
);

1066 
	}
}

1069 
	$shutdown_ş›Á_fd
(
cúd_hªdË
 *
h
, 
fd
)

1071 
hashtb_’um”©Ü
 
“
;

1072 
hashtb_’um”©Ü
 *
e
 = &
“
;

1073 
çû
 *çû = 
NULL
;

1074 
çûid
 = 
CCN_NOFACEID
;

1075 
	`hashtb_¡¬t
(
h
->
çûs_by_fd
, 
e
);

1076 ià(
	`hashtb_£ek
(
e
, &
fd
, (fd), 0è=ğ
HT_OLD_ENTRY
) {

1077 
çû
 = 
e
->
d©a
;

1078 ià(
çû
->
»cv_fd
 !ğ
fd
è
	`abÜt
();

1079 
çûid
 = 
çû
->faceid;

1080 ià(
çûid
 =ğ
CCN_NOFACEID
) {

1081 
	`cúd_msg
(
h
, "”rÜ indiÿtiÚ oÀfd %d ignÜed", 
fd
);

1082 
	`hashtb_’d
(
e
);

1085 
	`şo£
(
fd
);

1086 
çû
->
»cv_fd
 = -1;

1087 
	`cúd_msg
(
h
, "shutdowÀş›Á fd=%d id=%u", 
fd
, 
çûid
);

1088 
	`cú_ch¬buf_de¡roy
(&
çû
->
šbuf
);

1089 
	`cú_ch¬buf_de¡roy
(&
çû
->
outbuf
);

1090 
çû
 = 
NULL
;

1092 
	`hashtb_d–‘e
(
e
);

1093 
	`hashtb_’d
(
e
);

1094 
	`check_comm_fe
(
h
);

1095 
	`»­_Ãeded
(
h
, 250000);

1096 
	}
}

1099 
	$£nd_cÚ‹Á
(
cúd_hªdË
 *
h
, 
çû
 *çû, 
cÚ‹Á_’Œy
 *
cÚ‹Á
)

1101 
cú_ch¬buf
 *
c
 = 
	`ch¬buf_obš
(
h
);

1102 
n
, 
a
, 
b
, 
size
;

1103 ià((
çû
->
æags
 & 
CCN_FACE_NOSEND
) != 0)

1105 
size
 = 
cÚ‹Á
->size;

1106 ià(
h
->
debug
 & 4)

1107 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "cÚ‹Á_to", 
çû
,

1108 
cÚ‹Á
->
key
, 
size
);

1109 ià((
çû
->
æags
 & 
CCN_FACE_LINK
) != 0)

1110 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_CCNPrÙocŞD©aUn™
, 
CCN_DTAG
);

1112 
n
 = 
cÚ‹Á
->
ncomps
;

1113 ià(
n
 < 2è
	`abÜt
();

1114 
a
 = 
cÚ‹Á
->
comps
[
n
 - 2];

1115 
b
 = 
cÚ‹Á
->
comps
[
n
 - 1];

1116 ià(
b
 - 
a
 != 36)

1117 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "¡¿nge_dige¡", 
çû
, 
cÚ‹Á
->
key
, 
size
);

1118 
	`cú_ch¬buf_­³nd
(
c
, 
cÚ‹Á
->
key
, 
a
);

1119 
	`cú_ch¬buf_­³nd
(
c
, 
cÚ‹Á
->
key
 + 
b
, 
size
 - b);

1120 
	`cú_¡uff_š‹»¡
(
h
, 
çû
, 
c
);

1121 ià((
çû
->
æags
 & 
CCN_FACE_LINK
) != 0)

1122 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

1123 
	`cúd_£nd
(
h
, 
çû
, 
c
->
buf
, c->
Ëngth
);

1124 
h
->
cÚ‹Á_™ems_£Á
 += 1;

1125 
	`ch¬buf_»Ëa£
(
h
, 
c
);

1126 
	}
}

1128 
cq_d–ay_şass


1129 
	$choo£_cÚ‹Á_d–ay_şass
(
cúd_hªdË
 *
h
, 
çûid
, 
cÚ‹Á_æags
)

1131 
çû
 *çû = 
	`çû_äom_çûid
(
h
, 
çûid
);

1132 ià(
çû
 =ğ
NULL
)

1133 (
CCN_CQ_ASAP
);

1134 ià((
çû
->
æags
 & (
CCN_FACE_LINK
 | 
CCN_FACE_MCAST
)) != 0)

1135 ((
cÚ‹Á_æags
 & 
CCN_CONTENT_ENTRY_SLOWSEND
è? 
CCN_CQ_SLOW
 : 
CCN_CQ_NORMAL
);

1136 ià((
çû
->
æags
 & 
CCN_FACE_DGRAM
) != 0)

1137 (
CCN_CQ_NORMAL
);

1138 ià((
çû
->
æags
 & (
CCN_FACE_GG
 | 
CCN_FACE_LOCAL
)) != 0)

1139 (
CCN_CQ_ASAP
);

1140 (
CCN_CQ_NORMAL
);

1141 
	}
}

1144 
	$¿ndomize_cÚ‹Á_d–ay
(
cúd_hªdË
 *
h
, 
cÚ‹Á_queue
 *
q
)

1146 
u£c
;

1148 
u£c
 = 
q
->
mš_u£c
 + q->
¿nd_u£c
;

1149 ià(
u£c
 < 2)

1151 ià(
u£c
 <ğ20 || 
q
->
¿nd_u£c
 < 2)

1152 (
u£c
);

1153 
u£c
 = 
q
->
mš_u£c
 + (
	`Äªd48
(
h
->
£ed
è% q->
¿nd_u£c
);

1154 ià(
u£c
 < 2)

1156 (
u£c
);

1157 
	}
}

1160 
	$cÚ‹Á_£nd”
(
cú_scheduË
 *
sched
,

1161 *
ş›Áh
,

1162 
cú_scheduËd_ev’t
 *
ev
,

1163 
æags
)

1165 
i
, 
j
;

1166 
d–ay
;

1167 
n£c
;

1168 
bur¡_n£c
;

1169 
bur¡_max
;

1170 
cúd_hªdË
 *
h
 = 
ş›Áh
;

1171 
cÚ‹Á_’Œy
 *
cÚ‹Á
 = 
NULL
;

1172 
çûid
 = 
ev
->
evšt
;

1173 
çû
 *çû = 
NULL
;

1174 
cÚ‹Á_queue
 *
q
 = 
ev
->
evd©a
;

1175 ()
sched
;

1177 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) != 0)

1178 
Ba
;

1179 
çû
 = 
	`çû_äom_çûid
(
h
, 
çûid
);

1180 ià(
çû
 =ğ
NULL
)

1181 
Ba
;

1182 ià(
q
->
£nd_queue
 =ğ
NULL
)

1183 
Ba
;

1184 ià((
çû
->
æags
 & 
CCN_FACE_NOSEND
) != 0)

1185 
Ba
;

1187 ià(
q
->
»ady
 > q->
£nd_queue
->
n
 ||

1188 (
q
->
»ady
 =ğ0 && q->
Äun
 >= 12 && q->nrun < 120))

1189 
q
->
»ady
 = q->
£nd_queue
->
n
;

1190 
n£c
 = 0;

1191 
bur¡_n£c
 = 
q
->burst_nsec;

1192 
bur¡_max
 = 2;

1193 ià(
q
->
»ady
 < 
bur¡_max
)

1194 
bur¡_max
 = 
q
->
»ady
;

1195 ià(
bur¡_max
 == 0)

1196 
q
->
Äun
 = 0;

1197 
i
 = 0; i < 
bur¡_max
 && 
n£c
 < 1000000; i++) {

1198 
cÚ‹Á
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
q
->
£nd_queue
->
buf
[
i
]);

1199 ià(
cÚ‹Á
 =ğ
NULL
)

1200 
q
->
Äun
 = 0;

1202 
	`£nd_cÚ‹Á
(
h
, 
çû
, 
cÚ‹Á
);

1204 ià(
	`çû_äom_çûid
(
h
, 
çûid
è=ğ
NULL
)

1205 
Ba
;

1206 
n£c
 +ğ
bur¡_n£c
 * ()((
cÚ‹Á
->
size
 + 1023) / 1024);

1207 
q
->
Äun
++;

1210 ià(
q
->
»ady
 < 
i
è
	`abÜt
();

1211 
q
->
»ady
 -ğ
i
;

1213 
j
 = 0; 
i
 < 
q
->
£nd_queue
->
n
; i++, j++)

1214 
q
->
£nd_queue
->
buf
[
j
] = q->£nd_queue->buf[
i
];

1215 
q
->
£nd_queue
->
n
 = 
j
;

1217 
d–ay
 = (
n£c
 + 499) / 1000 + 1;

1218 ià(
q
->
»ady
 > 0) {

1219 ià(
h
->
debug
 & 8)

1220 
	`cúd_msg
(
h
, "face %u„eady %u delay %i‚run %u",

1221 
çûid
, 
q
->
»ady
, 
d–ay
, q->
Äun
, 
çû
->
su½lus
);

1222 (
d–ay
);

1224 
q
->
»ady
 = 
j
;

1225 ià(
q
->
Äun
 >= 12 && q->nrun < 120) {

1227 ià(
j
 == 0)

1228 
d–ay
 +ğ
bur¡_n£c
 / 50;

1229 ià(
h
->
debug
 & 8)

1230 
	`cúd_msg
(
h
, "face %u„eady %u delay %i‚run %u surplus %u",

1231 ()
ev
->
evšt
, 
q
->
»ady
, 
d–ay
, q->
Äun
, 
çû
->
su½lus
);

1232 (
d–ay
);

1235 
i
 = 0; i < 
q
->
£nd_queue
->
n
; i++) {

1236 
cÚ‹Á
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
q
->
£nd_queue
->
buf
[
i
]);

1237 ià(
cÚ‹Á
 !ğ
NULL
) {

1238 
q
->
Äun
 = 0;

1239 
d–ay
 = 
	`¿ndomize_cÚ‹Á_d–ay
(
h
, 
q
);

1240 ià(
h
->
debug
 & 8)

1241 
	`cúd_msg
(
h
, "face %u queued %u delay %i",

1242 ()
ev
->
evšt
, 
q
->
»ady
, 
d–ay
);

1243 (
d–ay
);

1246 
q
->
£nd_queue
->
n
 = q->
»ady
 = 0;

1247 
Ba
:

1248 
q
->
£nd”
 = 
NULL
;

1250 
	}
}

1253 
	$çû_£nd_queue_š£¹
(
cúd_hªdË
 *
h
,

1254 
çû
 *çû, 
cÚ‹Á_’Œy
 *
cÚ‹Á
)

1256 
ªs
;

1257 
d–ay
;

1258 
cq_d–ay_şass
 
c
;

1259 
cq_d–ay_şass
 
k
;

1260 
cÚ‹Á_queue
 *
q
;

1261 ià(
çû
 =ğ
NULL
 || 
cÚ‹Á
 =ğNULL || (çû->
æags
 & 
CCN_FACE_NOSEND
) != 0)

1263 
c
 = 
	`choo£_cÚ‹Á_d–ay_şass
(
h
, 
çû
->
çûid
, 
cÚ‹Á
->
æags
);

1264 ià(
çû
->
q
[
c
] =ğ
NULL
)

1265 
çû
->
q
[
c
] = 
	`cÚ‹Á_queue_ü—‹
(
h
, face, c);

1266 
q
 = 
çû
->q[
c
];

1267 ià(
q
 =ğ
NULL
)

1270 
k
 = 0; k < 
CCN_CQ_N
; k++) {

1271 ià(
k
 !ğ
c
 && 
çû
->
q
[k] !ğ
NULL
) {

1272 
ªs
 = 
	`cú_šdexbuf_memb”
(
çû
->
q
[
k
]->
£nd_queue
, 
cÚ‹Á
->
acûssiÚ
);

1273 ià(
ªs
 >= 0) {

1274 ià(
h
->
debug
 & 8)

1275 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "cÚ‹Á_Ùh”q", 
çû
,

1276 
cÚ‹Á
->
key
, cÚ‹Á->
size
);

1277 (
ªs
);

1281 
ªs
 = 
	`cú_šdexbuf_£t_š£¹
(
q
->
£nd_queue
, 
cÚ‹Á
->
acûssiÚ
);

1282 ià(
q
->
£nd”
 =ğ
NULL
) {

1283 
d–ay
 = 
	`¿ndomize_cÚ‹Á_d–ay
(
h
, 
q
);

1284 
q
->
»ady
 = q->
£nd_queue
->
n
;

1285 
q
->
£nd”
 = 
	`cú_scheduË_ev’t
(
h
->
sched
, 
d–ay
,

1286 
cÚ‹Á_£nd”
, 
q
, 
çû
->
çûid
);

1287 ià(
h
->
debug
 & 8)

1288 
	`cúd_msg
(
h
, "çû %u q %d d–ay %d u£c", 
çû
->
çûid
, 
c
, 
d–ay
);

1290  (
ªs
);

1291 
	}
}

1300 
	$´omÙe_outbound
(
´İag©šg_’Œy
 *
³
, 
çûid
)

1302 
cú_šdexbuf
 *
ob
 = 
³
->
outbound
;

1303 
lb
 = 
³
->
£Á
;

1304 
i
;

1305 ià(
ob
 =ğ
NULL
 || ob->
n
 <ğ
lb
 ||†b < 0)

1307 
i
 = 
ob
->
n
 - 1; i >ğ
lb
; i--)

1308 ià(
ob
->
buf
[
i
] =ğ
çûid
)

1310 ià(
i
 < 
lb
)

1312 ; 
i
 > 
lb
; i--)

1313 
ob
->
buf
[
i
] = ob->buf[i-1];

1314 
ob
->
buf
[
lb
] = 
çûid
;

1315 (
lb
);

1316 
	}
}

1328 
	$cÚsume_m©chšg_š‹»¡s
(
cúd_hªdË
 *
h
,

1329 
Çm•»fix_’Œy
 *
Åe
,

1330 
cÚ‹Á_’Œy
 *
cÚ‹Á
,

1331 
cú_·r£d_CÚ‹ÁObjeù
 *
pc
,

1332 
çû
 *face)

1334 
m©ches
 = 0;

1335 
´İag©šg_’Œy
 *
h—d
;

1336 
´İag©šg_’Œy
 *
Ãxt
;

1337 
´İag©šg_’Œy
 *
p
;

1338 cÚ¡ *
cÚ‹Á_msg
;

1339 
size_t
 
cÚ‹Á_size
;

1340 
çû
 *
f
;

1342 
h—d
 = &
Åe
->
³_h—d
;

1343 
cÚ‹Á_msg
 = 
cÚ‹Á
->
key
;

1344 
cÚ‹Á_size
 = 
cÚ‹Á
->
size
;

1345 
f
 = 
çû
;

1346 
p
 = 
h—d
->
Ãxt
;… != head;… =‚ext) {

1347 
Ãxt
 = 
p
->next;

1348 ià(
p
->
š‹»¡_msg
 !ğ
NULL
 &&

1349 ((
çû
 =ğ
NULL
 && (
f
 = 
	`çû_äom_çûid
(
h
, 
p
->
çûid
)) != NULL) ||

1350 (
çû
 !ğ
NULL
 && 
p
->
çûid
 == face->faceid))) {

1351 ià(
	`cú_cÚ‹Á_m©ches_š‹»¡
(
cÚ‹Á_msg
, 
cÚ‹Á_size
, 0, 
pc
,

1352 
p
->
š‹»¡_msg
,…->
size
, 
NULL
)) {

1353 
	`çû_£nd_queue_š£¹
(
h
, 
f
, 
cÚ‹Á
);

1354 ià(
h
->
debug
 & (32 | 8))

1355 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "cÚsume", 
f
,

1356 
p
->
š‹»¡_msg
,…->
size
);

1357 
m©ches
 += 1;

1358 
	`cÚsume
(
h
, 
p
);

1362 (
m©ches
);

1363 
	}
}

1366 
	$adju¡_Åe_´ediùed_»¥Ú£
(
cúd_hªdË
 *
h
,

1367 
Çm•»fix_’Œy
 *
Åe
, 
up
)

1369 
t
 = 
Åe
->
u£c
;

1370 ià(
up
)

1371 
t
 = + (t >> 3);

1373 
t
 = - (t >> 7);

1374 ià(
t
 < 127)

1375 
t
 = 127;

1376 ià(
t
 > 1000000)

1377 
t
 = 1000000;

1378 
Åe
->
u£c
 = 
t
;

1379 
	}
}

1382 
	$adju¡_´ediùed_»¥Ú£
(
cúd_hªdË
 *
h
,

1383 
´İag©šg_’Œy
 *
³
, 
up
)

1385 
Çm•»fix_’Œy
 *
Åe
;

1387 
Åe
 = 
	`Çm•»fix_fÜ_³
(
h
, 
³
);

1388 ià(
Åe
 =ğ
NULL
)

1390 
	`adju¡_Åe_´ediùed_»¥Ú£
(
h
, 
Åe
, 
up
);

1391 ià(
Åe
->
·»Á
 !ğ
NULL
)

1392 
	`adju¡_Åe_´ediùed_»¥Ú£
(
h
, 
Åe
->
·»Á
, 
up
);

1393 
	}
}

1399 
	$nÙe_cÚ‹Á_äom
(
cúd_hªdË
 *
h
,

1400 
Çm•»fix_’Œy
 *
Åe
,

1401 
äom_çûid
,

1402 
´efix_comps
)

1404 ià(
Åe
->
¤c
 =ğ
äom_çûid
)

1405 
	`adju¡_Åe_´ediùed_»¥Ú£
(
h
, 
Åe
, 0);

1406 ià(
Åe
->
¤c
 =ğ
CCN_NOFACEID
)

1407 
Åe
->
¤c
 = 
äom_çûid
;

1409 
Åe
->
o¤c
 =‚³->
¤c
;

1410 
Åe
->
¤c
 = 
äom_çûid
;

1412 ià(
h
->
debug
 & 8)

1413 
	`cúd_msg
(
h
, "¦.%d %u ci=%d o¤c=%u src=%u u£c=%d", 
__LINE__
,

1414 
äom_çûid
, 
´efix_comps
, 
Åe
->
o¤c
,‚³->
¤c
,‚³->
u£c
);

1415 
	}
}

1423 
	$»Üd”_outbound_usšg_hi¡Üy
(
cúd_hªdË
 *
h
,

1424 
Çm•»fix_’Œy
 *
Åe
,

1425 
´İag©šg_’Œy
 *
³
)

1427 
Á­
 = 0;

1428 
i
;

1430 ià(
Åe
->
o¤c
 !ğ
CCN_NOFACEID
)

1431 
	`´omÙe_outbound
(
³
, 
Åe
->
o¤c
);

1433 ià(
Åe
->
¤c
 !ğ
CCN_NOFACEID
)

1434 
	`´omÙe_outbound
(
³
, 
Åe
->
¤c
);

1436 ià(
Åe
->
p
 !ğ
NULL
) {

1437 
Á­
 = 
Åe
->
p
->
n
;

1438 
i
 = 0; i < 
Á­
; i++)

1439 
	`´omÙe_outbound
(
³
, 
Åe
->
p
->
buf
[
i
]);

1441 (
Á­
);

1442 
	}
}

1455 
	$m©ch_š‹»¡s
(
cúd_hªdË
 *
h
, 
cÚ‹Á_’Œy
 *
cÚ‹Á
,

1456 
cú_·r£d_CÚ‹ÁObjeù
 *
pc
,

1457 
çû
 *çû, çû *
äom_çû
)

1459 
n_m©ched
 = 0;

1460 
Ãw_m©ches
;

1461 
ci
;

1462 
cm
 = 0;

1463 
c0
 = 
cÚ‹Á
->
comps
[0];

1464 cÚ¡ *
key
 = 
cÚ‹Á
->key + 
c0
;

1465 
Çm•»fix_’Œy
 *
Åe
 = 
NULL
;

1466 
ci
 = 
cÚ‹Á
->
ncomps
 - 1; ci >= 0; ci--) {

1467 
size
 = 
cÚ‹Á
->
comps
[
ci
] - 
c0
;

1468 
Åe
 = 
	`hashtb_lookup
(
h
->
Çm•»fix_b
, 
key
, 
size
);

1469 ià(
Åe
 !ğ
NULL
)

1472 ; 
Åe
 !ğ
NULL
;‚³ =‚³->
·»Á
, 
ci
--) {

1473 ià(
Åe
->
fg’
 !ğ
h
->
fÜw¬d_to_g’
)

1474 
	`upd©e_fÜw¬d_to
(
h
, 
Åe
);

1475 ià(
äom_çû
 !ğ
NULL
 && (
Åe
->
æags
 & 
CCN_FORW_LOCAL
) != 0 &&

1476 (
äom_çû
->
æags
 & 
CCN_FACE_GG
) == 0)

1478 
Ãw_m©ches
 = 
	`cÚsume_m©chšg_š‹»¡s
(
h
, 
Åe
, 
cÚ‹Á
, 
pc
, 
çû
);

1479 ià(
äom_çû
 !ğ
NULL
 && (
Ãw_m©ches
 !ğ0 || 
ci
 + 1 =ğ
cm
))

1480 
	`nÙe_cÚ‹Á_äom
(
h
, 
Åe
, 
äom_çû
->
çûid
, 
ci
);

1481 ià(
Ãw_m©ches
 != 0) {

1482 
cm
 = 
ci
;

1483 
n_m©ched
 +ğ
Ãw_m©ches
;

1486 (
n_m©ched
);

1487 
	}
}

1493 
	$¡uff_ªd_£nd
(
cúd_hªdË
 *
h
, 
çû
 *face,

1494 *
d©a
, 
size_t
 
size
) {

1495 
cú_ch¬buf
 *
c
 = 
NULL
;

1497 ià((
çû
->
æags
 & 
CCN_FACE_LINK
) != 0) {

1498 
c
 = 
	`ch¬buf_obš
(
h
);

1499 
	`cú_ch¬buf_»£rve
(
c
, 
size
 + 5);

1500 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_CCNPrÙocŞD©aUn™
, 
CCN_DTAG
);

1501 
	`cú_ch¬buf_­³nd
(
c
, 
d©a
, 
size
);

1502 
	`cú_¡uff_š‹»¡
(
h
, 
çû
, 
c
);

1503 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

1505 ià(
h
->
mtu
 > 
size
) {

1506 
c
 = 
	`ch¬buf_obš
(
h
);

1507 
	`cú_ch¬buf_­³nd
(
c
, 
d©a
, 
size
);

1508 
	`cú_¡uff_š‹»¡
(
h
, 
çû
, 
c
);

1512 
	`cúd_£nd
(
h
, 
çû
, 
d©a
, 
size
);

1515 
	`cúd_£nd
(
h
, 
çû
, 
c
->
buf
, c->
Ëngth
);

1516 
	`ch¬buf_»Ëa£
(
h
, 
c
);

1518 
	}
}

1527 
	$cú_¡uff_š‹»¡
(
cúd_hªdË
 *
h
,

1528 
çû
 *çû, 
cú_ch¬buf
 *
c
)

1530 
hashtb_’um”©Ü
 
“
;

1531 
hashtb_’um”©Ü
 *
e
 = &
“
;

1532 
n_¡ufãd
 = 0;

1533 
»maššg_¥aû
 = 
h
->
mtu
 - 
c
->
Ëngth
;

1534 ià(
»maššg_¥aû
 < 20 || 
çû
 =ğ
h
->
çû0
)

1536 
	`hashtb_¡¬t
(
h
->
Çm•»fix_b
, 
e
);

1537 
»maššg_¥aû
 >ğ20 && 
e
->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

1538 
Çm•»fix_’Œy
 *
Åe
 = 
e
->
d©a
;

1539 
´İag©šg_’Œy
 *
h—d
 = &
Åe
->
³_h—d
;

1540 
´İag©šg_’Œy
 *
p
;

1541 
p
 = 
h—d
->
´ev
;… != head;… =…->prev) {

1542 ià(
p
->
outbound
 !ğ
NULL
 &&

1543 
p
->
outbound
->
n
 >…->
£Á
 &&

1544 
p
->
size
 <ğ
»maššg_¥aû
 &&

1545 
p
->
š‹»¡_msg
 !ğ
NULL
 &&

1546 ((
p
->
æags
 & (
CCN_PR_STUFFED1
 | 
CCN_PR_WAIT1
)) == 0) &&

1547 ((
p
->
æags
 & 
CCN_PR_UNSENT
) == 0 ||

1548 
p
->
outbound
->
buf
[p->
£Á
] =ğ
çû
->
çûid
) &&

1549 
	`´omÙe_outbound
(
p
, 
çû
->
çûid
) != -1) {

1550 
»maššg_¥aû
 -ğ
p
->
size
;

1551 ià((
p
->
æags
 & 
CCN_PR_UNSENT
) != 0) {

1552 
p
->
æags
 &ğ~
CCN_PR_UNSENT
;

1553 
p
->
æags
 |ğ
CCN_PR_STUFFED1
;

1555 
p
->
£Á
++;

1556 
n_¡ufãd
++;

1557 
	`cú_ch¬buf_­³nd
(
c
, 
p
->
š‹»¡_msg
,…->
size
);

1558 
h
->
š‹»¡s_¡ufãd
++;

1559 ià(
h
->
debug
 & 2)

1560 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "¡uff_š‹»¡_to", 
çû
,

1561 
p
->
š‹»¡_msg
,…->
size
);

1570 
	`hashtb_’d
(
e
);

1571 (
n_¡ufãd
);

1572 
	}
}

1579 
	$check_dg¿m_çûs
(
cúd_hªdË
 *
h
)

1581 
hashtb_’um”©Ü
 
“
;

1582 
hashtb_’um”©Ü
 *
e
 = &
“
;

1583 
couÁ
 = 0;

1584 
checkæags
 = 
CCN_FACE_DGRAM
 | 
CCN_FACE_PERMANENT
;

1585 
wªtæags
 = 
CCN_FACE_DGRAM
;

1587 
	`hashtb_¡¬t
(
h
->
dg¿m_çûs
, 
e
);

1588 
e
->
d©a
 !ğ
NULL
) {

1589 
çû
 *çû = 
e
->
d©a
;

1590 ià(
çû
->
addr
 !ğ
NULL
 && (çû->
æags
 & 
checkæags
è=ğ
wªtæags
) {

1591 ià(
çû
->
»cvcouÁ
 == 0) {

1592 
couÁ
 += 1;

1593 
	`hashtb_d–‘e
(
e
);

1596 
çû
->
»cvcouÁ
 = (face->recvcount > 1);

1598 
	`hashtb_Ãxt
(
e
);

1600 
	`hashtb_’d
(
e
);

1601 (
couÁ
);

1602 
	}
}

1609 
	$cúd_de¡roy_çû
(
cúd_hªdË
 *
h
, 
çûid
)

1611 
hashtb_’um”©Ü
 
“
;

1612 
hashtb_’um”©Ü
 *
e
 = &
“
;

1613 
çû
 *face;

1614 
dg¿m_chk
 = 
CCN_FACE_DGRAM
 | 
CCN_FACE_MCAST
;

1615 
dg¿m_wªt
 = 
CCN_FACE_DGRAM
;

1617 
çû
 = 
	`çû_äom_çûid
(
h
, 
çûid
);

1618 ià(
çû
 =ğ
NULL
)

1620 ià((
çû
->
æags
 & 
dg¿m_chk
è=ğ
dg¿m_wªt
) {

1621 
	`hashtb_¡¬t
(
h
->
dg¿m_çûs
, 
e
);

1622 
	`hashtb_£ek
(
e
, 
çû
->
addr
, faû->
add¾’
, 0);

1623 ià(
e
->
d©a
 =ğ
çû
)

1624 
çû
 = 
NULL
;

1625 
	`hashtb_d–‘e
(
e
);

1626 
	`hashtb_’d
(
e
);

1627 ià(
çû
 =ğ
NULL
)

1630 
	`shutdown_ş›Á_fd
(
h
, 
çû
->
»cv_fd
);

1631 
çû
 = 
NULL
;

1633 
	}
}

1639 
	$check_fÜw¬d_to
(
cúd_hªdË
 *
h
, 
Çm•»fix_’Œy
 *
Åe
)

1641 
cú_šdexbuf
 *
á
 = 
Åe
->
fÜw¬d_to
;

1642 
i
;

1643 
j
;

1644 ià(
á
 =ğ
NULL
)

1646 
i
 = 0; i < 
á
->
n
; i++)

1647 ià(
	`çû_äom_çûid
(
h
, 
á
->
buf
[
i
]è=ğ
NULL
)

1649 
j
 = 
i
 + 1; j < 
á
->
n
; j++)

1650 ià(
	`çû_äom_çûid
(
h
, 
á
->
buf
[
j
]è!ğ
NULL
)

1651 
á
->
buf
[
i
++] = ft->buf[
j
];

1652 ià(
i
 == 0)

1653 
	`cú_šdexbuf_de¡roy
(&
Åe
->
fÜw¬d_to
);

1654 ià(
i
 < 
á
->
n
)

1655 
á
->
n
 = 
i
;

1656 
	}
}

1663 
	$check_´İag©šg
(
cúd_hªdË
 *
h
)

1665 
couÁ
 = 0;

1666 
hashtb_’um”©Ü
 
“
;

1667 
hashtb_’um”©Ü
 *
e
 = &
“
;

1668 
´İag©šg_’Œy
 *
³
;

1670 
	`hashtb_¡¬t
(
h
->
´İag©šg_b
, 
e
);

1671 
³
 = 
e
->
d©a
;…!ğ
NULL
;…e =ƒ->data) {

1672 ià(
³
->
š‹»¡_msg
 =ğ
NULL
) {

1673 ià(
³
->
size
 == 0) {

1674 
couÁ
 += 1;

1675 
	`hashtb_d–‘e
(
e
);

1678 
³
->
size
 = (pe->size > 1);

1681 
	`hashtb_Ãxt
(
e
);

1683 
	`hashtb_’d
(
e
);

1684 (
couÁ
);

1685 
	}
}

1692 
	$check_Çm•»fix_’Œ›s
(
cúd_hªdË
 *
h
)

1694 
couÁ
 = 0;

1695 
hashtb_’um”©Ü
 
“
;

1696 
hashtb_’um”©Ü
 *
e
 = &
“
;

1697 
´İag©šg_’Œy
 *
h—d
;

1698 
Çm•»fix_’Œy
 *
Åe
;

1700 
	`hashtb_¡¬t
(
h
->
Çm•»fix_b
, 
e
);

1701 
Åe
 = 
e
->
d©a
;‚³ !ğ
NULL
;‚pe =ƒ->data) {

1702 ià(
Åe
->
fÜw¬d_to
 !ğ
NULL
)

1703 
	`check_fÜw¬d_to
(
h
, 
Åe
);

1704 iàĞ
Åe
->
¤c
 =ğ
CCN_NOFACEID
 &&

1705 
Åe
->
chd»n
 == 0 &&

1706 
Åe
->
fÜw¬dšg
 =ğ
NULL
) {

1707 
h—d
 = &
Åe
->
³_h—d
;

1708 ià(
h—d
 =ğh—d->
Ãxt
) {

1709 
couÁ
 += 1;

1710 ià(
Åe
->
·»Á
 !ğ
NULL
) {

1711 
Åe
->
·»Á
->
chd»n
--;

1712 
Åe
->
·»Á
 = 
NULL
;

1714 
	`hashtb_d–‘e
(
e
);

1718 
Åe
->
o¤c
 =‚³->
¤c
;

1719 
Åe
->
¤c
 = 
CCN_NOFACEID
;

1720 
	`hashtb_Ãxt
(
e
);

1722 
	`hashtb_’d
(
e
);

1723 (
couÁ
);

1724 
	}
}

1727 
	$check_comm_fe
(
cúd_hªdË
 *
h
)

1729 ià(!
	`comm_fe_ok
()) {

1730 
	`cúd_msg
(
h
, "¡İpšg (% gÚe)", 
uÆšk_this_©_ex™
);

1731 
uÆšk_this_©_ex™
 = 
NULL
;

1732 
h
->
ruÂšg
 = 0;

1734 
	}
}

1740 
	$»­
(

1741 
cú_scheduË
 *
sched
,

1742 *
ş›Áh
,

1743 
cú_scheduËd_ev’t
 *
ev
,

1744 
æags
)

1746 
cúd_hªdË
 *
h
 = 
ş›Áh
;

1747 ()(
sched
);

1748 ()(
ev
);

1749 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) != 0) {

1750 
h
->
»­”
 = 
NULL
;

1753 
	`check_dg¿m_çûs
(
h
);

1754 
	`check_´İag©šg
(
h
);

1755 
	`check_Çm•»fix_’Œ›s
(
h
);

1756 
	`check_comm_fe
(
h
);

1757 (2 * 
CCN_INTEREST_LIFETIME_MICROSEC
);

1758 
	}
}

1761 
	$»­_Ãeded
(
cúd_hªdË
 *
h
, 
š™_d–ay_u£c
)

1763 ià(
h
->
»­”
 =ğ
NULL
)

1764 
h
->
»­”
 = 
	`cú_scheduË_ev’t
(h->
sched
, 
š™_d–ay_u£c
, 
»­
, 
NULL
, 0);

1765 
	}
}

1768 
	$»move_cÚ‹Á
(
cúd_hªdË
 *
h
, 
cÚ‹Á_’Œy
 *
cÚ‹Á
)

1770 
hashtb_’um”©Ü
 
“
;

1771 
hashtb_’um”©Ü
 *
e
 = &
“
;

1772 
»s
;

1773 ià(
cÚ‹Á
 =ğ
NULL
)

1775 
	`hashtb_¡¬t
(
h
->
cÚ‹Á_b
, 
e
);

1776 
»s
 = 
	`hashtb_£ek
(
e
, 
cÚ‹Á
->
key
,

1777 
cÚ‹Á
->
key_size
, cÚ‹Á->
size
 - content->key_size);

1778 ià(
»s
 !ğ
HT_OLD_ENTRY
)

1779 
	`abÜt
();

1780 ià((
cÚ‹Á
->
æags
 & 
CCN_CONTENT_ENTRY_STALE
) != 0)

1781 
h
->
n_¡®e
--;

1782 ià(
h
->
debug
 & 4)

1783 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "»move", 
NULL
,

1784 
cÚ‹Á
->
key
, cÚ‹Á->
size
);

1785 
	`hashtb_d–‘e
(
e
);

1786 
	`hashtb_’d
(
e
);

1788 
	}
}

1794 
	$ş—n_d—mÚ
(
cú_scheduË
 *
sched
,

1795 *
ş›Áh
,

1796 
cú_scheduËd_ev’t
 *
ev
,

1797 
æags
)

1799 
cúd_hªdË
 *
h
 = 
ş›Áh
;

1800 ()(
sched
);

1801 ()(
ev
);

1802 
n
;

1803 
cú_acûssiÚ_t
 
lim™
;

1804 
cú_acûssiÚ_t
 
a
;

1805 
cú_acûssiÚ_t
 
mš_¡®e
;

1806 
check_lim™
 = 500;

1807 
cÚ‹Á_’Œy
 *
cÚ‹Á
 = 
NULL
;

1808 
»s
 = 0;

1809 
ignÜe
;

1810 
i
;

1817 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) != 0) {

1818 
h
->
ş—n
 = 
NULL
;

1821 
n
 = 
	`hashtb_n
(
h
->
cÚ‹Á_b
);

1822 ià(
n
 <ğ
h
->
ÿ·c™y
)

1825 
i
 = 0; i < 
h
->
unsŞ
->
n
; i++) {

1826 ià(
i
 =ğ
check_lim™
) {

1827 
i
 = 
check_lim™
; i < 
h
->
unsŞ
->
n
; i++)

1828 
h
->
unsŞ
->
buf
[
i
-
check_lim™
] = h->unsol->buf[i];

1829 
h
->
unsŞ
->
n
 -ğ
check_lim™
;

1832 
a
 = 
h
->
unsŞ
->
buf
[
i
];

1833 
cÚ‹Á
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
a
);

1834 ià(
cÚ‹Á
 !ğ
NULL
 &&

1835 (
cÚ‹Á
->
æags
 & 
CCN_CONTENT_ENTRY_PRECIOUS
) == 0)

1836 
	`»move_cÚ‹Á
(
h
, 
cÚ‹Á
);

1838 
n
 = 
	`hashtb_n
(
h
->
cÚ‹Á_b
);

1839 
h
->
unsŞ
->
n
 = 0;

1840 ià(
h
->
mš_¡®e
 <ğh->
max_¡®e
) {

1842 
lim™
 = 
h
->
max_¡®e
;

1843 ià(
lim™
 > 
h
->
acûssiÚ
)

1844 
lim™
 = 
h
->
acûssiÚ
;

1845 
mš_¡®e
 = ~0;

1846 
a
 = 
ev
->
evšt
;

1847 ià(
a
 <ğ
h
->
mš_¡®e
 ||‡ > h->
max_¡®e
)

1848 
a
 = 
h
->
mš_¡®e
;

1850 
mš_¡®e
 = 
h
->min_stale;

1851 ; 
a
 <ğ
lim™
 && 
n
 > 
h
->
ÿ·c™y
;‡++) {

1852 ià(
check_lim™
-- <= 0) {

1853 
ev
->
evšt
 = 
a
;

1856 
cÚ‹Á
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
a
);

1857 ià(
cÚ‹Á
 !ğ
NULL
 &&

1858 (
cÚ‹Á
->
æags
 & 
CCN_CONTENT_ENTRY_STALE
) != 0) {

1859 
»s
 = 
	`»move_cÚ‹Á
(
h
, 
cÚ‹Á
);

1860 ià(
»s
 < 0) {

1861 ià(
a
 < 
mš_¡®e
)

1862 
mš_¡®e
 = 
a
;

1865 
cÚ‹Á
 = 
NULL
;

1866 
n
 -= 1;

1870 ià(
mš_¡®e
 < 
a
)

1871 
h
->
mš_¡®e
 = min_stale;

1872 ià(
a
 > 
lim™
) {

1873 
h
->
mš_¡®e
 = ~0;

1874 
h
->
max_¡®e
 = 0;

1877 
h
->
mš_¡®e
 = 
a
;

1878 ià(
check_lim™
 <= 0)

1883 
lim™
 = 
h
->
acûssiÚ
;

1884 
ignÜe
 = 
CCN_CONTENT_ENTRY_STALE
 | 
CCN_CONTENT_ENTRY_PRECIOUS
;

1885 
a
 = 
h
->
acûssiÚ_ba£
;‡ <ğ
lim™
 && 
n
 > h->
ÿ·c™y
;‡++) {

1886 
cÚ‹Á
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
a
);

1887 ià(
cÚ‹Á
 !ğ
NULL
 && (cÚ‹Á->
æags
 & 
ignÜe
) == 0) {

1888 
	`m¬k_¡®e
(
h
, 
cÚ‹Á
);

1889 
n
--;

1892 
ev
->
evšt
 = 0;

1895 
ev
->
evšt
 = 0;

1897 
	}
}

1900 
	$ş—n_Ãeded
(
cúd_hªdË
 *
h
)

1902 ià(
h
->
ş—n
 =ğ
NULL
)

1903 
h
->
ş—n
 = 
	`cú_scheduË_ev’t
(h->
sched
, 1000000, 
ş—n_d—mÚ
, 
NULL
, 0);

1904 
	}
}

1910 
	$age_fÜw¬dšg
(
cú_scheduË
 *
sched
,

1911 *
ş›Áh
,

1912 
cú_scheduËd_ev’t
 *
ev
,

1913 
æags
)

1915 
cúd_hªdË
 *
h
 = 
ş›Áh
;

1916 
hashtb_’um”©Ü
 
“
;

1917 
hashtb_’um”©Ü
 *
e
 = &
“
;

1918 
cú_fÜw¬dšg
 *
f
;

1919 
cú_fÜw¬dšg
 *
Ãxt
;

1920 
cú_fÜw¬dšg
 **
p
;

1921 
Çm•»fix_’Œy
 *
Åe
;

1923 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) != 0) {

1924 
h
->
age_fÜw¬dšg
 = 
NULL
;

1927 
	`hashtb_¡¬t
(
h
->
Çm•»fix_b
, 
e
);

1928 
Åe
 = 
e
->
d©a
;‚³ !ğ
NULL
;‚pe =ƒ->data) {

1929 
p
 = &
Åe
->
fÜw¬dšg
;

1930 
f
 = 
Åe
->
fÜw¬dšg
; f !ğ
NULL
; f = 
Ãxt
) {

1931 
Ãxt
 = 
f
->next;

1932 ià((
f
->
æags
 & 
CCN_FORW_REFRESHED
) == 0 ||

1933 
	`çû_äom_çûid
(
h
, 
f
->
çûid
è=ğ
NULL
) {

1934 ià(
h
->
debug
 & 2) {

1935 
çû
 *çû = 
	`çû_äom_çûid
(
h
, 
f
->
çûid
);

1936 ià(
çû
 !ğ
NULL
) {

1937 
cú_ch¬buf
 *
´efix
 = 
	`cú_ch¬buf_ü—‹
();

1938 
	`cú_Çme_š™
(
´efix
);

1939 
	`cú_Çme_­³nd_compÚ’ts
(
´efix
, 
e
->
key
, 0,ƒ->
keysize
);

1940 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "´efix_expœy", 
çû
,

1941 
´efix
->
buf
,

1942 
´efix
->
Ëngth
);

1943 
	`cú_ch¬buf_de¡roy
(&
´efix
);

1946 *
p
 = 
Ãxt
;

1947 
	`ä“
(
f
);

1948 
f
 = 
NULL
;

1951 
f
->
expœes
 -ğ
CCN_FWU_SECS
;

1952 ià(
f
->
expœes
 <= 0)

1953 
f
->
æags
 &ğ~
CCN_FORW_REFRESHED
;

1954 
p
 = &(
f
->
Ãxt
);

1956 
	`hashtb_Ãxt
(
e
);

1958 
	`hashtb_’d
(
e
);

1959 
h
->
fÜw¬d_to_g’
 += 1;

1960 (
CCN_FWU_SECS
*1000000);

1961 
	}
}

1964 
	$age_fÜw¬dšg_Ãeded
(
cúd_hªdË
 *
h
)

1966 ià(
h
->
age_fÜw¬dšg
 =ğ
NULL
)

1967 
h
->
age_fÜw¬dšg
 = 
	`cú_scheduË_ev’t
(h->
sched
,

1968 
CCN_FWU_SECS
*1000000,

1969 
age_fÜw¬dšg
,

1970 
NULL
, 0);

1971 
	}
}

1973 
cú_fÜw¬dšg
 *

1974 
	$£ek_fÜw¬dšg
(
cúd_hªdË
 *
h
,

1975 
Çm•»fix_’Œy
 *
Åe
, 
çûid
)

1977 
cú_fÜw¬dšg
 *
f
;

1979 
f
 = 
Åe
->
fÜw¬dšg
; f !ğ
NULL
; f = f->
Ãxt
)

1980 ià(
f
->
çûid
 == faceid)

1981 (
f
);

1982 
f
 = 
	`ÿÎoc
(1, (*f));

1983 ià(
f
 !ğ
NULL
) {

1984 
f
->
çûid
 = faceid;

1985 
f
->
æags
 = (
CCN_FORW_CHILD_INHERIT
 | 
CCN_FORW_ACTIVE
);

1986 
f
->
expœes
 = 0x7FFFFFFF;

1987 
f
->
Ãxt
 = 
Åe
->
fÜw¬dšg
;

1988 
Åe
->
fÜw¬dšg
 = 
f
;

1990 (
f
);

1991 
	}
}

2007 
	$cúd_»g_´efix
(
cúd_hªdË
 *
h
,

2008 cÚ¡ *
msg
,

2009 
cú_šdexbuf
 *
comps
,

2010 
ncomps
,

2011 
çûid
,

2012 
æags
,

2013 
expœes
)

2015 
hashtb_’um”©Ü
 
“
;

2016 
hashtb_’um”©Ü
 *
e
 = &
“
;

2017 
cú_fÜw¬dšg
 *
f
 = 
NULL
;

2018 
Çm•»fix_’Œy
 *
Åe
 = 
NULL
;

2019 
»s
;

2020 
çû
 *çû = 
NULL
;

2022 ià(
æags
 >= 0 &&

2023 (
æags
 & 
CCN_FORW_PUBMASK
) != flags)

2025 
çû
 = 
	`çû_äom_çûid
(
h
, 
çûid
);

2026 ià(
çû
 =ğ
NULL
)

2029 ià(
æags
 >ğ0 && (æag & 
CCN_FORW_LAST
) != 0) {

2030 
çû
->
æags
 |ğ
CCN_FACE_DC
;

2031 ià((
çû
->
æags
 & 
CCN_FACE_GG
) != 0) {

2032 
çû
->
æags
 &ğ~
CCN_FACE_GG
;

2033 
çû
->
æags
 |ğ
CCN_FACE_REGOK
;

2036 
	`hashtb_¡¬t
(
h
->
Çm•»fix_b
, 
e
);

2037 
»s
 = 
	`Çm•»fix_£ek
(
h
, 
e
, 
msg
, 
comps
, 
ncomps
);

2038 ià(
»s
 >= 0) {

2039 
»s
 = (» =ğ
HT_OLD_ENTRY
è? 
CCN_FORW_REFRESHED
 : 0;

2040 
Åe
 = 
e
->
d©a
;

2041 
f
 = 
	`£ek_fÜw¬dšg
(
h
, 
Åe
, 
çûid
);

2042 ià(
f
 !ğ
NULL
) {

2043 
h
->
fÜw¬d_to_g’
 += 1;

2044 
f
->
expœes
 =ƒxpires;

2045 ià(
æags
 < 0)

2046 
æags
 = 
f
->æag & 
CCN_FORW_PUBMASK
;

2047 
f
->
æags
 = (
CCN_FORW_REFRESHED
 | flags);

2048 
»s
 |ğ
æags
;

2049 ià(
h
->
debug
 & (2 | 4)) {

2050 
cú_ch¬buf
 *
´efix
 = 
	`cú_ch¬buf_ü—‹
();

2051 
cú_ch¬buf
 *
debugg
 = 
	`cú_ch¬buf_ü—‹
();

2052 
	`cú_ch¬buf_putf
(
debugg
, "prefix,ff=%s%x",

2053 
æags
 > 9 ? "0x" : "", flags);

2054 ià(
f
->
expœes
 < (1 << 30))

2055 
	`cú_ch¬buf_putf
(
debugg
, ",£c=%d", 
expœes
);

2056 
	`cú_Çme_š™
(
´efix
);

2057 
	`cú_Çme_­³nd_compÚ’ts
(
´efix
, 
msg
,

2058 
comps
->
buf
[0], comps->buf[
ncomps
]);

2059 
	`cúd_debug_cúb
(
h
, 
__LINE__
,

2060 
	`cú_ch¬buf_as_¡ršg
(
debugg
),

2061 
çû
,

2062 
´efix
->
buf
,

2063 
´efix
->
Ëngth
);

2064 
	`cú_ch¬buf_de¡roy
(&
´efix
);

2065 
	`cú_ch¬buf_de¡roy
(&
debugg
);

2069 
»s
 = -1;

2071 
	`hashtb_’d
(
e
);

2072 (
»s
);

2073 
	}
}

2080 
	$cúd_»g_uri
(
cúd_hªdË
 *
h
,

2081 cÚ¡ *
uri
,

2082 
çûid
,

2083 
æags
,

2084 
expœes
)

2086 
cú_ch¬buf
 *
Çme
;

2087 
cú_buf_decod”
 
decod”
;

2088 
cú_buf_decod”
 *
d
;

2089 
cú_šdexbuf
 *
comps
;

2090 
»s
;

2092 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

2093 
	`cú_Çme_š™
(
Çme
);

2094 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
uri
);

2095 ià(
»s
 < 0)

2096 
Ba
;

2097 
comps
 = 
	`cú_šdexbuf_ü—‹
();

2098 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
Çme
->
buf
,‚ame->
Ëngth
);

2099 
»s
 = 
	`cú_·r£_Name
(
d
, 
comps
);

2100 ià(
»s
 < 0)

2101 
Ba
;

2102 
»s
 = 
	`cúd_»g_´efix
(
h
, 
Çme
->
buf
, 
comps
, comps->
n
 - 1,

2103 
çûid
, 
æags
, 
expœes
);

2104 
Ba
:

2105 
	`cú_ch¬buf_de¡roy
(&
Çme
);

2106 
	`cú_šdexbuf_de¡roy
(&
comps
);

2107 (
»s
);

2108 
	}
}

2115 
	$cúd_»g_uri_li¡
(
cúd_hªdË
 *
h
,

2116 
cú_ch¬buf
 *
uris
,

2117 
çûid
,

2118 
æags
,

2119 
expœes
)

2121 
size_t
 
i
;

2122 cÚ¡ *
s
;

2123 
s
 = 
	`cú_ch¬buf_as_¡ršg
(
uris
);

2124 
i
 = 0; i + 1 < 
uris
->
Ëngth
; i +ğ
	`¡¾’
(
s
 + i) + 1)

2125 
	`cúd_»g_uri
(
h
, 
s
 + 
i
, 
çûid
, 
æags
, 
expœes
);

2126 
	}
}

2133 
	$»gi¡”_Ãw_çû
(
cúd_hªdË
 *
h
, 
çû
 *face)

2135 ià(
çû
->
çûid
 !ğ0 && (çû->
æags
 & (
CCN_FACE_UNDECIDED
 | 
CCN_FACE_PASSIVE
)) == 0) {

2136 
	`cúd_çû_¡©us_chªge
(
h
, 
çû
->
çûid
);

2137 ià(
h
->
æood
 && h->
autÜeg
 !ğ
NULL
 && (
çû
->
æags
 & 
CCN_FACE_GG
) == 0)

2138 
	`cúd_»g_uri_li¡
(
h
, h->
autÜeg
, 
çû
->
çûid
,

2139 
CCN_FORW_CHILD_INHERIT
 | 
CCN_FORW_ACTIVE
,

2142 
	}
}

2158 
cú_ch¬buf
 *

2159 
	$cúd_»q_Ãwçû
(
cúd_hªdË
 *
h
, cÚ¡ *
msg
, 
size_t
 
size
)

2161 
cú_·r£d_CÚ‹ÁObjeù
 
pco
 = {0};

2162 
»s
;

2163 cÚ¡ *
»q
;

2164 
size_t
 
»q_size
;

2165 
cú_ch¬buf
 *
»suÉ
 = 
NULL
;

2166 
cú_çû_š¡ªû
 *
çû_š¡ªû
 = 
NULL
;

2167 
addršfo
 
hšts
 = {0};

2168 
addršfo
 *addršfØğ
NULL
;

2169 
fd
 = -1;

2170 
mÿ¡
;

2171 
çû
 *çû = 
NULL
;

2172 
çû
 *
»qçû
 = 
NULL
;

2173 
çû
 *
Ãwçû
 = 
NULL
;

2174 
§ve
;

2176 
§ve
 = 
h
->
æood
;

2177 
h
->
æood
 = 0;

2178 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
msg
, 
size
, &
pco
, 
NULL
);

2179 ià(
»s
 < 0)

2180 
Fšish
;

2181 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
msg
, 
size
, &
pco
, &
»q
, &
»q_size
);

2182 ià(
»s
 < 0)

2183 
Fšish
;

2184 
çû_š¡ªû
 = 
	`cú_çû_š¡ªû_·r£
(
»q
, 
»q_size
);

2185 ià(
çû_š¡ªû
 =ğ
NULL
 || faû_š¡ªû->
aùiÚ
 == NULL)

2186 
Fšish
;

2188 ià(
	`¡rcmp
(
çû_š¡ªû
->
aùiÚ
, "newface") != 0)

2189 
Fšish
;

2190 ià(
çû_š¡ªû
->
cúd_id_size
 =ğ(
h
->
cúd_id
)) {

2191 ià(
	`memcmp
(
çû_š¡ªû
->
cúd_id
, 
h
->ccnd_id, (h->ccnd_id)) != 0)

2192 
Fšish
;

2194 ià(
çû_š¡ªû
->
cúd_id_size
 |= 0)

2195 
Fšish
;

2196 ià(
çû_š¡ªû
->
desü
.
´Ùo
 !ğ
IPPROTO_UDP
 &&

2197 
çû_š¡ªû
->
desü
.
´Ùo
 !ğ
IPPROTO_TCP
)

2198 
Fšish
;

2199 ià(
çû_š¡ªû
->
desü
.
add»ss
 =ğ
NULL
)

2200 
Fšish
;

2201 ià(
çû_š¡ªû
->
desü
.
pÜt
 =ğ
NULL
)

2202 
Fšish
;

2204 
»qçû
 = 
	`çû_äom_çûid
(
h
, h->
š‹»¡_çûid
);

2205 ià(
»qçû
 =ğ
NULL
 || (»qçû->
æags
 & 
CCN_FACE_GG
) == 0)

2206 
Fšish
;

2207 
hšts
.
ai_æags
 |ğ
AI_NUMERICHOST
;

2208 
hšts
.
ai_´ÙocŞ
 = 
çû_š¡ªû
->
desü
.
´Ùo
;

2209 
hšts
.
ai_sockty³
 = (hšts.
ai_´ÙocŞ
 =ğ
IPPROTO_UDP
è? 
SOCK_DGRAM
 : 
SOCK_STREAM
;

2210 
»s
 = 
	`g‘addršfo
(
çû_š¡ªû
->
desü
.
add»ss
,

2211 
çû_š¡ªû
->
desü
.
pÜt
,

2212 &
hšts
,

2213 &
addršfo
);

2214 ià(
»s
 !ğ0 || (
h
->
debug
 & 128) != 0)

2215 
	`cúd_msg
(
h
, "ccnd_req_newface from %u: getaddrinfo(%s, %s, ...)„eturned %d",

2216 
h
->
š‹»¡_çûid
,

2217 
çû_š¡ªû
->
desü
.
add»ss
,

2218 
çû_š¡ªû
->
desü
.
pÜt
,

2219 
»s
);

2220 ià(
»s
 !ğ0 || 
addršfo
 =ğ
NULL
)

2221 
Fšish
;

2222 ià(
addršfo
->
ai_Ãxt
 !ğ
NULL
)

2223 
	`cúd_msg
(
h
, "ccnd_req_newface: (addrinfo->ai_next != NULL) ? ?");

2224 ià(
çû_š¡ªû
->
desü
.
´Ùo
 =ğ
IPPROTO_UDP
) {

2225 
fd
 = -1;

2226 
mÿ¡
 = 0;

2227 ià(
addršfo
->
ai_çmy
 =ğ
AF_INET
) {

2228 
çû
 = 
	`çû_äom_çûid
(
h
, h->
v4_çûid
);

2229 
mÿ¡
 = 
	`IN_MULTICAST
(
	`Áohl
(((
sockaddr_š
 *)(
addršfo
->
ai_addr
))->
sš_addr
.
s_addr
));

2231 ià(
addršfo
->
ai_çmy
 =ğ
AF_INET6
) {

2232 
çû
 = 
	`çû_äom_çûid
(
h
, h->
v6_çûid
);

2233 
mÿ¡
 = 
	`IN6_IS_ADDR_MULTICAST
(&((
sockaddr_š6
 *)
addršfo
->
ai_addr
)->
sš6_addr
);

2235 ià(
mÿ¡
)

2236 
çû
 = 
	`£tup_muÉiÿ¡
(
h
, 
çû_š¡ªû
,

2237 
addršfo
->
ai_addr
,

2238 
addršfo
->
ai_add¾’
);

2239 ià(
çû
 =ğ
NULL
)

2240 
Fšish
;

2241 
Ãwçû
 = 
	`g‘_dg¿m_sourû
(
h
, 
çû
,

2242 
addršfo
->
ai_addr
,

2243 
addršfo
->
ai_add¾’
,

2246 ià(
addršfo
->
ai_sockty³
 =ğ
SOCK_STREAM
) {

2247 
Ãwçû
 = 
	`make_cÚÃùiÚ
(
h
,

2248 
addršfo
->
ai_addr
,

2249 
addršfo
->
ai_add¾’
,

2252 ià(
Ãwçû
 !ğ
NULL
) {

2253 
Ãwçû
->
æags
 |ğ
CCN_FACE_PERMANENT
;

2254 
»suÉ
 = 
	`cú_ch¬buf_ü—‹
();

2255 
çû_š¡ªû
->
aùiÚ
 = 
NULL
;

2256 
çû_š¡ªû
->
cúd_id
 = 
h
->ccnd_id;

2257 
çû_š¡ªû
->
cúd_id_size
 = (
h
->
cúd_id
);

2258 
çû_š¡ªû
->
çûid
 = 
Ãwçû
->faceid;

2259 
çû_š¡ªû
->
liãtime
 = 0x7FFFFFFF;

2260 
»s
 = 
	`cúb_­³nd_çû_š¡ªû
(
»suÉ
, 
çû_š¡ªû
);

2261 ià(
»s
 < 0)

2262 
	`cú_ch¬buf_de¡roy
(&
»suÉ
);

2264 
Fšish
:

2265 
h
->
æood
 = 
§ve
;

2266 
	`cú_çû_š¡ªû_de¡roy
(&
çû_š¡ªû
);

2267 ià(
addršfo
 !ğ
NULL
)

2268 
	`ä“addršfo
(
addršfo
);

2269 (
»suÉ
);

2270 
	}
}

2284 
cú_ch¬buf
 *

2285 
	$cúd_»q_de¡royçû
(
cúd_hªdË
 *
h
, cÚ¡ *
msg
, 
size_t
 
size
)

2287 
cú_·r£d_CÚ‹ÁObjeù
 
pco
 = {0};

2288 
»s
;

2289 
©
 = 0;

2290 cÚ¡ *
»q
;

2291 
size_t
 
»q_size
;

2292 
cú_ch¬buf
 *
»suÉ
 = 
NULL
;

2293 
cú_çû_š¡ªû
 *
çû_š¡ªû
 = 
NULL
;

2294 
çû
 *
»qçû
 = 
NULL
;

2296 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
msg
, 
size
, &
pco
, 
NULL
);

2297 ià(
»s
 < 0è{ 
©
 = 
__LINE__
; 
Fšish
; }

2298 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
msg
, 
size
, &
pco
, &
»q
, &
»q_size
);

2299 ià(
»s
 < 0è{ 
©
 = 
__LINE__
; 
Fšish
; }

2300 
çû_š¡ªû
 = 
	`cú_çû_š¡ªû_·r£
(
»q
, 
»q_size
);

2301 ià(
çû_š¡ªû
 =ğ
NULL
è{ 
©
 = 
__LINE__
; 
Fšish
; }

2302 ià(
çû_š¡ªû
->
aùiÚ
 =ğ
NULL
è{ 
©
 = 
__LINE__
; 
Fšish
; }

2303 ià(
	`¡rcmp
(
çû_š¡ªû
->
aùiÚ
, "destroyface") != 0)

2304 { 
©
 = 
__LINE__
; 
Fšish
; }

2305 ià(
çû_š¡ªû
->
cúd_id_size
 =ğ(
h
->
cúd_id
)) {

2306 ià(
	`memcmp
(
çû_š¡ªû
->
cúd_id
, 
h
->ccnd_id, (h->ccnd_id)) != 0)

2307 { 
©
 = 
__LINE__
; 
Fšish
; }

2309 ià(
çû_š¡ªû
->
cúd_id_size
 |ğ0è{ 
©
 = 
__LINE__
; 
Fšish
; }

2310 ià(
çû_š¡ªû
->
çûid
 =ğ0è{ 
©
 = 
__LINE__
; 
Fšish
; }

2312 
»qçû
 = 
	`çû_äom_çûid
(
h
, h->
š‹»¡_çûid
);

2313 ià(
»qçû
 =ğ
NULL
è{ 
©
 = 
__LINE__
; 
Fšish
; }

2314 ià((
»qçû
->
æags
 & 
CCN_FACE_GG
è=ğ0è{ 
©
 = 
__LINE__
; 
Fšish
; }

2315 
»s
 = 
	`cúd_de¡roy_çû
(
h
, 
çû_š¡ªû
->
çûid
);

2316 ià(
»s
 < 0è{ 
©
 = 
__LINE__
; 
Fšish
; }

2317 
»suÉ
 = 
	`cú_ch¬buf_ü—‹
();

2318 
çû_š¡ªû
->
aùiÚ
 = 
NULL
;

2319 
çû_š¡ªû
->
cúd_id
 = 
h
->ccnd_id;

2320 
çû_š¡ªû
->
cúd_id_size
 = (
h
->
cúd_id
);

2321 
çû_š¡ªû
->
liãtime
 = 0;

2322 
»s
 = 
	`cúb_­³nd_çû_š¡ªû
(
»suÉ
, 
çû_š¡ªû
);

2323 ià(
»s
 < 0) {

2324 
©
 = 
__LINE__
;

2325 
	`cú_ch¬buf_de¡roy
(&
»suÉ
);

2327 
Fšish
:

2328 ià(
©
 != 0)

2329 
	`cúd_msg
(
h
, "cúd_»q_de¡royçû faed (lš%d,„e %d)", 
©
, 
»s
);

2330 
	`cú_çû_š¡ªû_de¡roy
(&
çû_š¡ªû
);

2331 (
»suÉ
);

2332 
	}
}

2337 
cú_ch¬buf
 *

2338 
	$cúd_»q_´efix_Ü_£lf_»g
(
cúd_hªdË
 *
h
,

2339 cÚ¡ *
msg
, 
size_t
 
size
, 
£läeg
)

2341 
cú_·r£d_CÚ‹ÁObjeù
 
pco
 = {0};

2342 
»s
;

2343 cÚ¡ *
»q
;

2344 
size_t
 
»q_size
;

2345 
cú_ch¬buf
 *
»suÉ
 = 
NULL
;

2346 
cú_fÜw¬dšg_’Œy
 *
fÜw¬dšg_’Œy
 = 
NULL
;

2347 
çû
 *çû = 
NULL
;

2348 
çû
 *
»qçû
 = 
NULL
;

2349 
cú_šdexbuf
 *
comps
 = 
NULL
;

2351 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
msg
, 
size
, &
pco
, 
NULL
);

2352 ià(
»s
 < 0)

2353 
Fšish
;

2354 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
msg
, 
size
, &
pco
, &
»q
, &
»q_size
);

2355 ià(
»s
 < 0)

2356 
Fšish
;

2357 
fÜw¬dšg_’Œy
 = 
	`cú_fÜw¬dšg_’Œy_·r£
(
»q
, 
»q_size
);

2358 ià(
fÜw¬dšg_’Œy
 =ğ
NULL
 || fÜw¬dšg_’Œy->
aùiÚ
 == NULL)

2359 
Fšish
;

2360 ià(
£läeg
) {

2361 ià(
	`¡rcmp
(
fÜw¬dšg_’Œy
->
aùiÚ
, "selfreg") != 0)

2362 
Fšish
;

2363 ià(
fÜw¬dšg_’Œy
->
çûid
 =ğ
CCN_NOFACEID
)

2364 
fÜw¬dšg_’Œy
->
çûid
 = 
h
->
š‹»¡_çûid
;

2365 ià(
fÜw¬dšg_’Œy
->
çûid
 !ğ
h
->
š‹»¡_çûid
)

2366 
Fšish
;

2369 ià(
	`¡rcmp
(
fÜw¬dšg_’Œy
->
aùiÚ
, "prefixreg") != 0)

2370 
Fšish
;

2372 ià(
fÜw¬dšg_’Œy
->
Çme_´efix
 =ğ
NULL
)

2373 
Fšish
;

2374 ià(
fÜw¬dšg_’Œy
->
cúd_id_size
 =ğ(
h
->
cúd_id
)) {

2375 ià(
	`memcmp
(
fÜw¬dšg_’Œy
->
cúd_id
,

2376 
h
->
cúd_id
, (h->ccnd_id)) != 0)

2377 
Fšish
;

2379 ià(
fÜw¬dšg_’Œy
->
cúd_id_size
 != 0)

2380 
Fšish
;

2381 
çû
 = 
	`çû_äom_çûid
(
h
, 
fÜw¬dšg_’Œy
->
çûid
);

2382 ià(
çû
 =ğ
NULL
)

2383 
Fšish
;

2385 
»qçû
 = 
	`çû_äom_çûid
(
h
, h->
š‹»¡_çûid
);

2386 ià(
»qçû
 =ğ
NULL
)

2387 
Fšish
;

2388 ià((
»qçû
->
æags
 & (
CCN_FACE_GG
 | 
CCN_FACE_REGOK
)) == 0)

2389 
Fšish
;

2390 ià(
fÜw¬dšg_’Œy
->
liãtime
 < 0)

2391 
fÜw¬dšg_’Œy
->
liãtime
 = 60;

2392 ià(
fÜw¬dšg_’Œy
->
liãtime
 > 3600 &&

2393 
fÜw¬dšg_’Œy
->
liãtime
 < (1 << 30))

2394 
fÜw¬dšg_’Œy
->
liãtime
 = 300;

2395 
comps
 = 
	`cú_šdexbuf_ü—‹
();

2396 
»s
 = 
	`cú_Çme_¥l™
(
fÜw¬dšg_’Œy
->
Çme_´efix
, 
comps
);

2397 ià(
»s
 < 0)

2398 
Fšish
;

2399 
»s
 = 
	`cúd_»g_´efix
(
h
,

2400 
fÜw¬dšg_’Œy
->
Çme_´efix
->
buf
, 
comps
, 
»s
,

2401 
çû
->
çûid
,

2402 
fÜw¬dšg_’Œy
->
æags
,

2403 
fÜw¬dšg_’Œy
->
liãtime
);

2404 ià(
»s
 < 0)

2405 
Fšish
;

2406 
fÜw¬dšg_’Œy
->
æags
 = 
»s
;

2407 
»suÉ
 = 
	`cú_ch¬buf_ü—‹
();

2408 
fÜw¬dšg_’Œy
->
aùiÚ
 = 
NULL
;

2409 
fÜw¬dšg_’Œy
->
cúd_id
 = 
h
->ccnd_id;

2410 
fÜw¬dšg_’Œy
->
cúd_id_size
 = (
h
->
cúd_id
);

2411 
»s
 = 
	`cúb_­³nd_fÜw¬dšg_’Œy
(
»suÉ
, 
fÜw¬dšg_’Œy
);

2412 ià(
»s
 < 0)

2413 
	`cú_ch¬buf_de¡roy
(&
»suÉ
);

2414 
Fšish
:

2415 
	`cú_fÜw¬dšg_’Œy_de¡roy
(&
fÜw¬dšg_’Œy
);

2416 
	`cú_šdexbuf_de¡roy
(&
comps
);

2417 (
»suÉ
);

2418 
	}
}

2430 
cú_ch¬buf
 *

2431 
	$cúd_»q_´efix»g
(
cúd_hªdË
 *
h
, cÚ¡ *
msg
, 
size_t
 
size
)

2433 (
	`cúd_»q_´efix_Ü_£lf_»g
(
h
, 
msg
, 
size
, 0));

2434 
	}
}

2446 
cú_ch¬buf
 *

2447 
	$cúd_»q_£läeg
(
cúd_hªdË
 *
h
, cÚ¡ *
msg
, 
size_t
 
size
)

2449 (
	`cúd_»q_´efix_Ü_£lf_»g
(
h
, 
msg
, 
size
, 1));

2450 
	}
}

2462 
cú_ch¬buf
 *

2463 
	$cúd_»q_uÄeg
(
cúd_hªdË
 *
h
, cÚ¡ *
msg
, 
size_t
 
size
)

2465 
cú_ch¬buf
 *
»suÉ
 = 
NULL
;

2466 
cú_·r£d_CÚ‹ÁObjeù
 
pco
 = {0};

2467 
n_Çme_comp
 = 0;

2468 
»s
;

2469 cÚ¡ *
»q
;

2470 
size_t
 
»q_size
;

2471 
size_t
 
¡¬t
;

2472 
size_t
 
¡İ
;

2473 
found
;

2474 
cú_fÜw¬dšg_’Œy
 *
fÜw¬dšg_’Œy
 = 
NULL
;

2475 
çû
 *çû = 
NULL
;

2476 
çû
 *
»qçû
 = 
NULL
;

2477 
cú_šdexbuf
 *
comps
 = 
NULL
;

2478 
cú_fÜw¬dšg
 **
p
 = 
NULL
;

2479 
cú_fÜw¬dšg
 *
f
 = 
NULL
;

2480 
Çm•»fix_’Œy
 *
Åe
 = 
NULL
;

2482 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
msg
, 
size
, &
pco
, 
NULL
);

2483 ià(
»s
 < 0)

2484 
Fšish
;

2485 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
msg
, 
size
, &
pco
, &
»q
, &
»q_size
);

2486 ià(
»s
 < 0)

2487 
Fšish
;

2488 
fÜw¬dšg_’Œy
 = 
	`cú_fÜw¬dšg_’Œy_·r£
(
»q
, 
»q_size
);

2489 ià(
fÜw¬dšg_’Œy
 =ğ
NULL
 || fÜw¬dšg_’Œy->
aùiÚ
 == NULL)

2490 
Fšish
;

2491 ià(
	`¡rcmp
(
fÜw¬dšg_’Œy
->
aùiÚ
, "unreg") != 0)

2492 
Fšish
;

2493 ià(
fÜw¬dšg_’Œy
->
çûid
 =ğ
CCN_NOFACEID
)

2494 
Fšish
;

2495 ià(
fÜw¬dšg_’Œy
->
Çme_´efix
 =ğ
NULL
)

2496 
Fšish
;

2498 ià(
fÜw¬dšg_’Œy
->
cúd_id_size
 =ğ(
h
->
cúd_id
)) {

2499 ià(
	`memcmp
(
fÜw¬dšg_’Œy
->
cúd_id
,

2500 
h
->
cúd_id
, (h->ccnd_id)) != 0)

2501 
Fšish
;

2503 ià(
fÜw¬dšg_’Œy
->
cúd_id_size
 != 0)

2504 
Fšish
;

2505 
çû
 = 
	`çû_äom_çûid
(
h
, 
fÜw¬dšg_’Œy
->
çûid
);

2506 ià(
çû
 =ğ
NULL
)

2507 
Fšish
;

2509 
»qçû
 = 
	`çû_äom_çûid
(
h
, h->
š‹»¡_çûid
);

2510 ià(
»qçû
 =ğ
NULL
 || (»qçû->
æags
 & 
CCN_FACE_GG
) == 0)

2511 
Fšish
;

2512 
comps
 = 
	`cú_šdexbuf_ü—‹
();

2513 
n_Çme_comp
 = 
	`cú_Çme_¥l™
(
fÜw¬dšg_’Œy
->
Çme_´efix
, 
comps
);

2514 ià(
n_Çme_comp
 < 0)

2515 
Fšish
;

2516 ià(
n_Çme_comp
 + 1 > 
comps
->
n
)

2517 
Fšish
;

2518 
¡¬t
 = 
comps
->
buf
[0];

2519 
¡İ
 = 
comps
->
buf
[
n_Çme_comp
];

2520 
Åe
 = 
	`hashtb_lookup
(
h
->
Çm•»fix_b
,

2521 
fÜw¬dšg_’Œy
->
Çme_´efix
->
buf
 + 
¡¬t
,

2522 
¡İ
 - 
¡¬t
);

2523 ià(
Åe
 =ğ
NULL
)

2524 
Fšish
;

2525 
found
 = 0;

2526 
p
 = &
Åe
->
fÜw¬dšg
;

2527 
f
 = 
Åe
->
fÜw¬dšg
; f !ğ
NULL
; f = f->
Ãxt
) {

2528 ià(
f
->
çûid
 =ğ
fÜw¬dšg_’Œy
->faceid) {

2529 
found
 = 1;

2530 ià(
h
->
debug
 & (2 | 4))

2531 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "´efix_uÄeg", 
çû
,

2532 
fÜw¬dšg_’Œy
->
Çme_´efix
->
buf
,

2533 
fÜw¬dšg_’Œy
->
Çme_´efix
->
Ëngth
);

2534 *
p
 = 
f
->
Ãxt
;

2535 
	`ä“
(
f
);

2536 
f
 = 
NULL
;

2537 
h
->
fÜw¬d_to_g’
 += 1;

2540 
p
 = &(
f
->
Ãxt
);

2542 ià(!
found
)

2543 
Fšish
;

2544 
»suÉ
 = 
	`cú_ch¬buf_ü—‹
();

2545 
fÜw¬dšg_’Œy
->
aùiÚ
 = 
NULL
;

2546 
fÜw¬dšg_’Œy
->
cúd_id
 = 
h
->ccnd_id;

2547 
fÜw¬dšg_’Œy
->
cúd_id_size
 = (
h
->
cúd_id
);

2548 
»s
 = 
	`cúb_­³nd_fÜw¬dšg_’Œy
(
»suÉ
, 
fÜw¬dšg_’Œy
);

2549 ià(
»s
 < 0)

2550 
	`cú_ch¬buf_de¡roy
(&
»suÉ
);

2551 
Fšish
:

2552 
	`cú_fÜw¬dšg_’Œy_de¡roy
(&
fÜw¬dšg_’Œy
);

2553 
	`cú_šdexbuf_de¡roy
(&
comps
);

2554 (
»suÉ
);

2555 
	}
}

2562 
	$upd©e_fÜw¬d_to
(
cúd_hªdË
 *
h
, 
Çm•»fix_’Œy
 *
Åe
)

2564 
cú_šdexbuf
 *
x
 = 
NULL
;

2565 
cú_šdexbuf
 *
p
 = 
NULL
;

2566 
cú_fÜw¬dšg
 *
f
 = 
NULL
;

2567 
Çm•»fix_’Œy
 *
p
 = 
NULL
;

2568 
wªtæags
;

2569 
mÜeæags
;

2570 
Ï¡çûid
;

2571 
Çme¥aû_æags
;

2573 
x
 = 
Åe
->
fÜw¬d_to
;

2574 ià(
x
 =ğ
NULL
)

2575 
Åe
->
fÜw¬d_to
 = 
x
 = 
	`cú_šdexbuf_ü—‹
();

2577 
x
->
n
 = 0;

2578 
wªtæags
 = 
CCN_FORW_ACTIVE
;

2579 
Ï¡çûid
 = 
CCN_NOFACEID
;

2580 
Çme¥aû_æags
 = 0;

2581 
p
 = 
Åe
;… !ğ
NULL
;… =…->
·»Á
) {

2582 
mÜeæags
 = 
CCN_FORW_CHILD_INHERIT
;

2583 
f
 = 
p
->
fÜw¬dšg
; f !ğ
NULL
; f = f->
Ãxt
) {

2584 ià((
f
->
æags
 & 
wªtæags
) == wantflags &&

2585 
	`çû_äom_çûid
(
h
, 
f
->
çûid
è!ğ
NULL
) {

2586 
Çme¥aû_æags
 |ğ
f
->
æags
;

2587 ià(
h
->
debug
 & 32)

2588 
	`cúd_msg
(
h
, "fwd.%d‡ddšg %u", 
__LINE__
, 
f
->
çûid
);

2589 
	`cú_šdexbuf_£t_š£¹
(
x
, 
f
->
çûid
);

2590 ià((
f
->
æags
 & 
CCN_FORW_TAP
) != 0) {

2591 ià(
p
 =ğ
NULL
)

2592 
p
 = 
	`cú_šdexbuf_ü—‹
();

2593 
	`cú_šdexbuf_£t_š£¹
(
p
, 
f
->
çûid
);

2595 ià((
f
->
æags
 & 
CCN_FORW_LAST
) != 0)

2596 
Ï¡çûid
 = 
f
->
çûid
;

2598 ià((
f
->
æags
 & 
CCN_FORW_CAPTURE
) != 0)

2599 
mÜeæags
 |ğ
CCN_FORW_LAST
;

2601 
wªtæags
 |ğ
mÜeæags
;

2603 ià(
Ï¡çûid
 !ğ
CCN_NOFACEID
)

2604 
	`cú_šdexbuf_move_to_’d
(
x
, 
Ï¡çûid
);

2605 
Åe
->
æags
 = 
Çme¥aû_æags
;

2606 
Åe
->
fg’
 = 
h
->
fÜw¬d_to_g’
;

2607 ià(
x
->
n
 == 0)

2608 
	`cú_šdexbuf_de¡roy
(&
Åe
->
fÜw¬d_to
);

2609 
	`cú_šdexbuf_de¡roy
(&
Åe
->
p
);

2610 
Åe
->
p
 =ap;

2611 
	}
}

2622 
cú_šdexbuf
 *

2623 
	$g‘_outbound_çûs
(
cúd_hªdË
 *
h
,

2624 
çû
 *
äom
,

2625 *
msg
,

2626 
cú_·r£d_š‹»¡
 *
pi
,

2627 
Çm•»fix_’Œy
 *
Åe
)

2629 
checkmask
 = 0;

2630 
cú_šdexbuf
 *
x
;

2631 
çû
 *face;

2632 
i
;

2633 
n
;

2634 
çûid
;

2636 
Åe
->
·»Á
 !ğ
NULL
 &&‚³->
fÜw¬dšg
 == NULL)

2637 
Åe
 =‚³->
·»Á
;

2638 ià(
Åe
->
fg’
 !ğ
h
->
fÜw¬d_to_g’
)

2639 
	`upd©e_fÜw¬d_to
(
h
, 
Åe
);

2640 
x
 = 
	`cú_šdexbuf_ü—‹
();

2641 ià(
pi
->
scİe
 =ğ0 || 
Åe
->
fÜw¬d_to
 =ğ
NULL
 ||‚³->fÜw¬d_to->
n
 == 0)

2642 (
x
);

2643 ià((
Åe
->
æags
 & 
CCN_FORW_LOCAL
) != 0)

2644 
checkmask
 = (
äom
 !ğ
NULL
 && (äom->
æags
 & 
CCN_FACE_GG
) != 0) ? CCN_FACE_GG : (~0);

2645 ià(
pi
->
scİe
 == 1)

2646 
checkmask
 = 
CCN_FACE_GG
;

2647 ià(
pi
->
scİe
 == 2)

2648 
checkmask
 = 
äom
 ? (
CCN_FACE_GG
 & ~(äom->
æags
)) : ~0;

2649 
n
 = 
Åe
->
fÜw¬d_to
->n, 
i
 = 0; i <‚; i++) {

2650 
çûid
 = 
Åe
->
fÜw¬d_to
->
buf
[
i
];

2651 
çû
 = 
	`çû_äom_çûid
(
h
, 
çûid
);

2652 ià(
çû
 !ğ
NULL
 && faû !ğ
äom
 &&

2653 ((
çû
->
æags
 & 
checkmask
) == checkmask)) {

2654 ià(
h
->
debug
 & 32)

2655 
	`cúd_msg
(
h
, "outbound.%d‡ddšg %u", 
__LINE__
, 
çû
->
çûid
);

2656 
	`cú_šdexbuf_­³nd_–em’t
(
x
, 
çû
->
çûid
);

2659 (
x
);

2660 
	}
}

2663 
	$³_Ãxt_u£c
(
cúd_hªdË
 *
h
,

2664 
´İag©šg_’Œy
 *
³
, 
Ãxt_d–ay
, 
lš’o
)

2666 ià(
Ãxt_d–ay
 > 
³
->
u£c
)

2667 
Ãxt_d–ay
 = 
³
->
u£c
;

2668 
³
->
u£c
 -ğ
Ãxt_d–ay
;

2669 ià(
h
->
debug
 & 32) {

2670 
cú_ch¬buf
 *
c
 = 
	`cú_ch¬buf_ü—‹
();

2671 
	`cú_ch¬buf_putf
(
c
, "%p.%dof%d,usec=%d+%d",

2672 (*)
³
,

2673 
³
->
£Á
,

2674 
³
->
outbound
 ?…e->outbound->
n
 : -1,

2675 
Ãxt_d–ay
, 
³
->
u£c
);

2676 ià(
³
->
š‹»¡_msg
 !ğ
NULL
) {

2677 
	`cúd_debug_cúb
(
h
, 
lš’o
, 
	`cú_ch¬buf_as_¡ršg
(
c
),

2678 
	`çû_äom_çûid
(
h
, 
³
->
çûid
),

2679 
³
->
š‹»¡_msg
,…e->
size
);

2681 
	`cú_ch¬buf_de¡roy
(&
c
);

2683 (
Ãxt_d–ay
);

2684 
	}
}

2686 
»¶ª_´İag©iÚ
(
cúd_hªdË
 *, 
´İag©šg_’Œy
 *);

2689 
	$do_´İag©e
(
cú_scheduË
 *
sched
,

2690 *
ş›Áh
,

2691 
cú_scheduËd_ev’t
 *
ev
,

2692 
æags
)

2694 
cúd_hªdË
 *
h
 = 
ş›Áh
;

2695 
´İag©šg_’Œy
 *
³
 = 
ev
->
evd©a
;

2696 ()(
sched
);

2697 
Ãxt_d–ay
 = 1;

2698 
¥ecŸl_d–ay
 = 0;

2699 ià(
³
->
š‹»¡_msg
 =ğ
NULL
)

2701 ià(
æags
 & 
CCN_SCHEDULE_CANCEL
) {

2702 
	`cÚsume
(
h
, 
³
);

2705 ià((
³
->
æags
 & 
CCN_PR_WAIT1
) != 0) {

2706 
³
->
æags
 &ğ~
CCN_PR_WAIT1
;

2707 
	`adju¡_´ediùed_»¥Ú£
(
h
, 
³
, 1);

2709 ià(
³
->
u£c
 <= 0) {

2710 ià(
h
->
debug
 & 2)

2711 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "interest_expiry",

2712 
	`çû_äom_çûid
(
h
, 
³
->
çûid
),

2713 
³
->
š‹»¡_msg
,…e->
size
);

2714 
	`cÚsume
(
h
, 
³
);

2715 
	`»­_Ãeded
(
h
, 0);

2718 ià((
³
->
æags
 & 
CCN_PR_STUFFED1
) != 0) {

2719 
³
->
æags
 &ğ~
CCN_PR_STUFFED1
;

2720 
³
->
æags
 |ğ
CCN_PR_WAIT1
;

2721 
Ãxt_d–ay
 = 
¥ecŸl_d–ay
 = 
ev
->
evšt
;

2723 ià(
³
->
outbound
 !ğ
NULL
 &&…e->
£Á
 <…e->outbound->
n
) {

2724 
çûid
 = 
³
->
outbound
->
buf
[³->
£Á
];

2725 
çû
 *çû = 
	`çû_äom_çûid
(
h
, 
çûid
);

2726 ià(
çû
 !ğ
NULL
 && (çû->
æags
 & 
CCN_FACE_NOSEND
) == 0) {

2727 ià(
h
->
debug
 & 2)

2728 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "š‹»¡_to", 
çû
,

2729 
³
->
š‹»¡_msg
,…e->
size
);

2730 
³
->
£Á
++;

2731 
h
->
š‹»¡s_£Á
 += 1;

2732 
h
->
š‹»¡_çûid
 = 
³
->
çûid
;

2733 
Ãxt_d–ay
 = 
	`Äªd48
(
h
->
£ed
) % 8192 + 500;

2734 ià(((
³
->
æags
 & 
CCN_PR_TAP
) != 0) &&

2735 
	`cú_šdexbuf_memb”
(
	`Çm•»fix_fÜ_³
(
h
, 
³
)->
p
,…e->
çûid
)) {

2736 
Ãxt_d–ay
 = 
¥ecŸl_d–ay
 = 1;

2738 ià((
³
->
æags
 & 
CCN_PR_UNSENT
) != 0) {

2739 
³
->
æags
 &ğ~
CCN_PR_UNSENT
;

2740 
³
->
æags
 |ğ
CCN_PR_WAIT1
;

2741 
Ãxt_d–ay
 = 
¥ecŸl_d–ay
 = 
ev
->
evšt
;

2743 
	`¡uff_ªd_£nd
(
h
, 
çû
, 
³
->
š‹»¡_msg
,…e->
size
);

2746 
	`cú_šdexbuf_»move_fœ¡_m©ch
(
³
->
outbound
, 
çûid
);

2749 ià(
³
->
outbound
 =ğ
NULL
)

2750 
Ãxt_d–ay
 = 
CCN_INTEREST_LIFETIME_MICROSEC
;

2751 ià(
³
->
£Á
 =ğ³->
outbound
->
n
) {

2752 ià(
³
->
u£c
 <ğ
CCN_INTEREST_LIFETIME_MICROSEC
 / 4)

2753 
Ãxt_d–ay
 = 
CCN_INTEREST_LIFETIME_MICROSEC
;

2754 ià(
¥ecŸl_d–ay
 == 0)

2755 
Ãxt_d–ay
 = 
CCN_INTEREST_LIFETIME_MICROSEC
 / 16;

2756 ià(
³
->
fg’
 !ğ
h
->
fÜw¬d_to_g’
)

2757 
	`»¶ª_´İag©iÚ
(
h
, 
³
);

2760 
çûid
 = 
³
->
outbound
->
buf
[³->
£Á
];

2761 
çû
 *çû = 
	`çû_äom_çûid
(
h
, 
çûid
);

2763 ià(
çû
 !ğ
NULL
 && (çû->
æags
 & 
CCN_FACE_DC
) != 0)

2764 
Ãxt_d–ay
 += 60000;

2766 
Ãxt_d–ay
 = 
	`³_Ãxt_u£c
(
h
, 
³
,‚ext_d–ay, 
__LINE__
);

2767 (
Ãxt_d–ay
);

2768 
	}
}

2780 
	$adju¡_outbound_fÜ_exi¡šg_š‹»¡s
(
cúd_hªdË
 *
h
, 
çû
 *face,

2781 *
msg
,

2782 
cú_·r£d_š‹»¡
 *
pi
,

2783 
Çm•»fix_’Œy
 *
Åe
,

2784 
cú_šdexbuf
 *
outbound
)

2786 
´İag©šg_’Œy
 *
h—d
 = &
Åe
->
³_h—d
;

2787 
´İag©šg_’Œy
 *
p
;

2788 
size_t
 
´esize
 = 
pi
->
off£t
[
CCN_PI_B_NÚû
];

2789 
size_t
 
po¡size
 = 
pi
->
off£t
[
CCN_PI_E
] -…i->off£t[
CCN_PI_E_NÚû
];

2790 
size_t
 
mšsize
 = 
´esize
 + 
po¡size
;

2791 *
po¡
 = 
msg
 + 
pi
->
off£t
[
CCN_PI_E_NÚû
];

2792 
k
 = 0;

2793 
max_»dundªt
 = 3;

2794 
i
;

2795 
n
;

2796 
çû
 *
Ùh”çû
;

2797 
exŒa_d–ay
 = 0;

2799 ià((
çû
->
æags
 & (
CCN_FACE_MCAST
 | 
CCN_FACE_LINK
)) != 0)

2800 
max_»dundªt
 = 0;

2801 ià(
outbound
 !ğ
NULL
) {

2802 
p
 = 
h—d
->
Ãxt
;… !ğh—d && 
outbound
->
n
 > 0;… =…->next) {

2803 ià(
p
->
size
 > 
mšsize
 &&

2804 
p
->
š‹»¡_msg
 !ğ
NULL
 &&

2805 
p
->
u£c
 > 0 &&

2806 0 =ğ
	`memcmp
(
msg
, 
p
->
š‹»¡_msg
, 
´esize
) &&

2807 0 =ğ
	`memcmp
(
po¡
, 
p
->
š‹»¡_msg
 +…->
size
 - 
po¡size
,…ostsize)) {

2809 ià(
h
->
debug
 & 32)

2810 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "similar_interest",

2811 
	`çû_äom_çûid
(
h
, 
p
->
çûid
),

2812 
p
->
š‹»¡_msg
,…->
size
);

2813 ià(
çû
->
çûid
 =ğ
p
->faceid) {

2821 
exŒa_d–ay
 +ğ
Åe
->
u£c
 + 20000;

2822 ià((++
k
è< 
max_»dundªt
)

2824 
outbound
->
n
 = 0;

2841 
Ùh”çû
 = 
	`çû_äom_çûid
(
h
, 
p
->
çûid
);

2842 ià(
Ùh”çû
 =ğ
NULL
)

2848 ià(
pi
->
scİe
 == 2 &&

2849 ((
Ùh”çû
->
æags
 ^ 
çû
->æagsè& 
CCN_FACE_GG
) != 0)

2851 
n
 = 
outbound
->n;

2852 
outbound
->
n
 = 0;

2853 
i
 = 0; i < 
n
; i++) {

2854 ià(
p
->
çûid
 =ğ
outbound
->
buf
[
i
]) {

2855 
outbound
->
buf
[0] = 
p
->
çûid
;

2856 
outbound
->
n
 = 1;

2857 ià((
Ùh”çû
->
æags
 & (
CCN_FACE_MCAST
 | 
CCN_FACE_LINK
)) != 0)

2858 
exŒa_d–ay
 +ğ
Åe
->
u£c
 + 10000;

2862 
p
->
æags
 |ğ
CCN_PR_EQV
;

2866 (
exŒa_d–ay
);

2867 
	}
}

2870 
	$cúd_­³nd_debug_nÚû
(
cúd_hªdË
 *
h
, 
çû
 *çû, 
cú_ch¬buf
 *
cb
) {

2871 
s
[12];

2872 
i
;

2874 
i
 = 0; i < 3; i++)

2875 
s
[
i
] = 
h
->
cúd_id
[i];

2876 
s
[
i
++] = 
h
->
logpid
 >> 8;

2877 
s
[
i
++] = 
h
->
logpid
;

2878 
s
[
i
++] = 
çû
->
çûid
 >> 8;

2879 
s
[
i
++] = 
çû
->
çûid
;

2880 
s
[
i
++] = 
h
->
£c
;

2881 
s
[
i
++] = 
h
->
u£c
 * 256 / 1000000;

2882 ; 
i
 < (
s
); i++)

2883 
s
[
i
] = 
	`Äªd48
(
h
->
£ed
);

2884 
	`cúb_­³nd_gged_blob
(
cb
, 
CCN_DTAG_NÚû
, 
s
, 
i
);

2885 
	}
}

2888 
	$cúd_­³nd_¶aš_nÚû
(
cúd_hªdË
 *
h
, 
çû
 *çû, 
cú_ch¬buf
 *
cb
) {

2889 
nÚûby‹s
 = 6;

2890 *
s
 = 
NULL
;

2891 
i
;

2893 
	`cú_ch¬buf_­³nd_‰
(
cb
, 
CCN_DTAG_NÚû
, 
CCN_DTAG
);

2894 
	`cú_ch¬buf_­³nd_‰
(
cb
, 
nÚûby‹s
, 
CCN_BLOB
);

2895 
s
 = 
	`cú_ch¬buf_»£rve
(
cb
, 
nÚûby‹s
);

2896 
i
 = 0; i < 
nÚûby‹s
; i++)

2897 
s
[
i
] = 
	`Äªd48
(
h
->
£ed
) >> i;

2898 
cb
->
Ëngth
 +ğ
nÚûby‹s
;

2899 
	`cú_ch¬buf_­³nd_şo£r
(
cb
);

2900 
	}
}

2906 
	$´İag©e_š‹»¡
(
cúd_hªdË
 *
h
,

2907 
çû
 *face,

2908 *
msg
,

2909 
cú_·r£d_š‹»¡
 *
pi
,

2910 
Çm•»fix_’Œy
 *
Åe
)

2912 
hashtb_’um”©Ü
 
“
;

2913 
hashtb_’um”©Ü
 *
e
 = &
“
;

2914 *
nÚû
;

2915 
size_t
 
nÚûsize
;

2916 
cú_ch¬buf
 *
cb
 = 
NULL
;

2917 
»s
;

2918 
´İag©šg_’Œy
 *
³
 = 
NULL
;

2919 *
msg_out
 = 
msg
;

2920 
size_t
 
msg_out_size
 = 
pi
->
off£t
[
CCN_PI_E
];

2921 
u£c
;

2922 
Á­
;

2923 
d–aymask
;

2924 
exŒa_d–ay
 = 0;

2925 
cú_šdexbuf
 *
outbound
 = 
NULL
;

2926 
štmax_t
 
liãtime
;

2928 
liãtime
 = 
	`cú_š‹»¡_liãtime
(
msg
, 
pi
);

2929 
outbound
 = 
	`g‘_outbound_çûs
(
h
, 
çû
, 
msg
, 
pi
, 
Åe
);

2930 ià(
outbound
->
n
 != 0) {

2931 
exŒa_d–ay
 = 
	`adju¡_outbound_fÜ_exi¡šg_š‹»¡s
(
h
, 
çû
, 
msg
, 
pi
, 
Åe
, 
outbound
);

2932 ià(
exŒa_d–ay
 < 0) {

2938 ià(
h
->
debug
 & 16)

2939 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "š‹»¡_subsumed", 
çû
,

2940 
msg_out
, 
msg_out_size
);

2941 
h
->
š‹»¡s_drİ³d
 += 1;

2942 
	`cú_šdexbuf_de¡roy
(&
outbound
);

2946 ià(
pi
->
off£t
[
CCN_PI_B_NÚû
] =ğpi->off£t[
CCN_PI_E_NÚû
]) {

2948 
size_t
 
nÚû_¡¬t
 = 0;

2949 
cb
 = 
	`ch¬buf_obš
(
h
);

2950 
	`cú_ch¬buf_­³nd
(
cb
, 
msg
, 
pi
->
off£t
[
CCN_PI_B_NÚû
]);

2951 
nÚû_¡¬t
 = 
cb
->
Ëngth
;

2952 (
h
->
­²Úû
)(h, 
çû
, 
cb
);

2953 
nÚûsize
 = 
cb
->
Ëngth
 - 
nÚû_¡¬t
;

2954 
	`cú_ch¬buf_­³nd
(
cb
, 
msg
 + 
pi
->
off£t
[
CCN_PI_B_OTHER
],

2955 
pi
->
off£t
[
CCN_PI_E
] -…i->off£t[
CCN_PI_B_OTHER
]);

2956 
nÚû
 = 
cb
->
buf
 + 
nÚû_¡¬t
;

2957 
msg_out
 = 
cb
->
buf
;

2958 
msg_out_size
 = 
cb
->
Ëngth
;

2961 
nÚû
 = 
msg
 + 
pi
->
off£t
[
CCN_PI_B_NÚû
];

2962 
nÚûsize
 = 
pi
->
off£t
[
CCN_PI_E_NÚû
] -…i->off£t[
CCN_PI_B_NÚû
];

2964 
	`hashtb_¡¬t
(
h
->
´İag©šg_b
, 
e
);

2965 
»s
 = 
	`hashtb_£ek
(
e
, 
nÚû
, 
nÚûsize
, 0);

2966 
³
 = 
e
->
d©a
;

2967 ià(
³
 !ğ
NULL
 &&…e->
š‹»¡_msg
 == NULL) {

2968 *
m
;

2969 
m
 = 
	`ÿÎoc
(1, 
msg_out_size
);

2970 ià(
m
 =ğ
NULL
) {

2971 
»s
 = -1;

2972 
³
 = 
NULL
;

2973 
	`hashtb_d–‘e
(
e
);

2976 
	`memıy
(
m
, 
msg_out
, 
msg_out_size
);

2977 
³
->
š‹»¡_msg
 = 
m
;

2978 
³
->
size
 = 
msg_out_size
;

2979 
³
->
çûid
 = 
çû
->faceid;

2980 
çû
->
³ndšg_š‹»¡s
 += 1;

2981 ià(
liãtime
 < 
INT_MAX
 / (1000000 >> 6) * (4096 >> 6))

2982 
³
->
u£c
 = 
liãtime
 * (1000000 >> 6) / (4096 >> 6);

2984 
³
->
u£c
 = 
INT_MAX
;

2985 
d–aymask
 = 0xFFF;

2986 
³
->
£Á
 = 0;

2987 
³
->
outbound
 = outbound;

2988 
³
->
æags
 = 0;

2989 ià(
pi
->
scİe
 == 0)

2990 
³
->
æags
 |ğ
CCN_PR_SCOPE0
;

2991 ià(
pi
->
scİe
 == 1)

2992 
³
->
æags
 |ğ
CCN_PR_SCOPE1
;

2993 ià(
pi
->
scİe
 == 2)

2994 
³
->
æags
 |ğ
CCN_PR_SCOPE2
;

2995 
³
->
fg’
 = 
h
->
fÜw¬d_to_g’
;

2996 
	`lšk_´İag©šg_š‹»¡_to_Çm•»fix
(
h
, 
³
, 
Åe
);

2997 
Á­
 = 
	`»Üd”_outbound_usšg_hi¡Üy
(
h
, 
Åe
, 
³
);

2998 ià(
outbound
->
n
 > 
Á­
 &&

2999 
outbound
->
buf
[
Á­
] =ğ
Åe
->
¤c
 &&

3000 
exŒa_d–ay
 == 0) {

3001 
³
->
æags
 = 
CCN_PR_UNSENT
;

3002 
d–aymask
 = 0xFF;

3004 
outbound
 = 
NULL
;

3005 
»s
 = 0;

3006 ià(
Á­
 > 0)

3007 (
u£c
 = 1, 
³
->
æags
 |ğ
CCN_PR_TAP
);

3009 
u£c
 = (
	`Äªd48
(
h
->
£ed
è& 
d–aymask
è+ 1 + 
exŒa_d–ay
;

3010 
u£c
 = 
	`³_Ãxt_u£c
(
h
, 
³
, u£c, 
__LINE__
);

3011 
	`cú_scheduË_ev’t
(
h
->
sched
, 
u£c
, 
do_´İag©e
, 
³
, 
Åe
->usec);

3015 
	`cúd_msg
(
h
, "IÁ”e¡šg -hi shouldn'ˆh­³Àmuch - cúd.c:%d", 
__LINE__
);

3017 
»s
 = -1;

3019 
	`hashtb_’d
(
e
);

3020 ià(
cb
 !ğ
NULL
)

3021 
	`ch¬buf_»Ëa£
(
h
, 
cb
);

3022 
	`cú_šdexbuf_de¡roy
(&
outbound
);

3023 (
»s
);

3024 
	}
}

3026 
Çm•»fix_’Œy
 *

3027 
	$Çm•»fix_fÜ_³
(
cúd_hªdË
 *
h
, 
´İag©šg_’Œy
 *
³
)

3029 
Çm•»fix_’Œy
 *
Åe
;

3030 
´İag©šg_’Œy
 *
p
;

3033 
p
 = 
³
->
Ãxt
;…->
çûid
 !ğ
CCN_NOFACEID
;… =…->next)

3035 
Åe
 = (*)(((*)
p
è- 
	`off£tof
(
Çm•»fix_’Œy
, 
³_h—d
));

3036 (
Åe
);

3037 
	}
}

3040 
	$»¶ª_´İag©iÚ
(
cúd_hªdË
 *
h
, 
´İag©šg_’Œy
 *
³
)

3042 
Çm•»fix_’Œy
 *
Åe
 = 
NULL
;

3043 
cú_šdexbuf
 *
x
 = 
³
->
outbound
;

3044 
çû
 *çû = 
NULL
;

3045 
çû
 *
äom
 = 
NULL
;

3046 
i
;

3047 
k
;

3048 
n
;

3049 
çûid
;

3050 
checkmask
 = 0;

3052 
³
->
fg’
 = 
h
->
fÜw¬d_to_g’
;

3053 ià((
³
->
æags
 & (
CCN_PR_SCOPE0
 | 
CCN_PR_EQV
)) != 0)

3055 
äom
 = 
	`çû_äom_çûid
(
h
, 
³
->
çûid
);

3056 ià(
äom
 =ğ
NULL
)

3058 
Åe
 = 
	`Çm•»fix_fÜ_³
(
h
, 
³
);

3059 
Åe
->
·»Á
 !ğ
NULL
 &&‚³->
fÜw¬dšg
 == NULL)

3060 
Åe
 =‚³->
·»Á
;

3061 ià(
Åe
->
fg’
 !ğ
h
->
fÜw¬d_to_g’
)

3062 
	`upd©e_fÜw¬d_to
(
h
, 
Åe
);

3063 ià(
Åe
->
fÜw¬d_to
 =ğ
NULL
 ||‚³->fÜw¬d_to->
n
 == 0)

3065 ià((
³
->
æags
 & 
CCN_PR_SCOPE1
) != 0)

3066 
checkmask
 = 
CCN_FACE_GG
;

3067 ià((
³
->
æags
 & 
CCN_PR_SCOPE2
) != 0)

3068 
checkmask
 = 
CCN_FACE_GG
 & ~(
äom
->
æags
);

3069 ià((
Åe
->
æags
 & 
CCN_FORW_LOCAL
) != 0)

3070 
checkmask
 = ((
äom
->
æags
 & 
CCN_FACE_GG
) != 0) ? CCN_FACE_GG : (~0);

3071 
n
 = 
Åe
->
fÜw¬d_to
->n, 
i
 = 0; i <‚; i++) {

3072 
çûid
 = 
Åe
->
fÜw¬d_to
->
buf
[
i
];

3073 
çû
 = 
	`çû_äom_çûid
(
h
, 
çûid
);

3074 ià(
çû
 !ğ
NULL
 && 
çûid
 !ğ
³
->faceid &&

3075 ((
çû
->
æags
 & 
checkmask
) == checkmask)) {

3076 
k
 = 
x
->
n
;

3077 
	`cú_šdexbuf_£t_š£¹
(
x
, 
çûid
);

3078 ià(
x
->
n
 > 
k
 && (
h
->
debug
 & 32) != 0)

3079 
	`cúd_msg
(
h
, "© %d‡ddšg %u", 
__LINE__
, 
çûid
);

3083 
	}
}

3092 
	$is_du¶iÿ‹_æooded
(
cúd_hªdË
 *
h
, *
msg
,

3093 
cú_·r£d_š‹»¡
 *
pi
, 
çûid
)

3095 
hashtb_’um”©Ü
 
“
;

3096 
hashtb_’um”©Ü
 *
e
 = &
“
;

3097 
´İag©šg_’Œy
 *
³
 = 
NULL
;

3098 
»s
;

3099 
size_t
 
nÚû_¡¬t
 = 
pi
->
off£t
[
CCN_PI_B_NÚû
];

3100 
size_t
 
nÚû_size
 = 
pi
->
off£t
[
CCN_PI_E_NÚû
] - 
nÚû_¡¬t
;

3101 ià(
nÚû_size
 == 0)

3103 
	`hashtb_¡¬t
(
h
->
´İag©šg_b
, 
e
);

3104 
»s
 = 
	`hashtb_£ek
(
e
, 
msg
 + 
nÚû_¡¬t
, 
nÚû_size
, 0);

3105 ià(
»s
 =ğ
HT_OLD_ENTRY
) {

3106 
³
 = 
e
->
d©a
;

3107 ià(
	`´omÙe_outbound
(
³
, 
çûid
) != -1)

3108 
³
->
£Á
++;

3110 
	`hashtb_’d
(
e
);

3111 (
»s
 =ğ
HT_OLD_ENTRY
);

3112 
	}
}

3118 
	$Çm•»fix_lÚge¡_m©ch
(
cúd_hªdË
 *
h
, cÚ¡ *
msg
,

3119 
cú_šdexbuf
 *
comps
, 
ncomps
)

3121 
i
;

3122 
ba£
;

3123 
ªsw”
 = 0;

3124 
Çm•»fix_’Œy
 *
Åe
 = 
NULL
;

3126 ià(
ncomps
 + 1 > 
comps
->
n
)

3128 
ba£
 = 
comps
->
buf
[0];

3129 
i
 = 0; i <ğ
ncomps
; i++) {

3130 
Åe
 = 
	`hashtb_lookup
(
h
->
Çm•»fix_b
, 
msg
 + 
ba£
, 
comps
->
buf
[
i
] - base);

3131 ià(
Åe
 =ğ
NULL
)

3133 
ªsw”
 = 
i
;

3134 ià(
Åe
->
chd»n
 == 0)

3137 
	`cúd_msg
(
h
, "Çm•»fix_lÚge¡_m©ch„‘uºšg %d", 
ªsw”
);

3138 (
ªsw”
);

3139 
	}
}

3146 
	$Çm•»fix_£ek
(
cúd_hªdË
 *
h
, 
hashtb_’um”©Ü
 *
e
,

3147 cÚ¡ *
msg
, 
cú_šdexbuf
 *
comps
, 
ncomps
)

3149 
i
;

3150 
ba£
;

3151 
»s
 = -1;

3152 
Çm•»fix_’Œy
 *
·»Á
 = 
NULL
;

3153 
Çm•»fix_’Œy
 *
Åe
 = 
NULL
;

3154 
´İag©šg_’Œy
 *
h—d
 = 
NULL
;

3156 ià(
ncomps
 + 1 > 
comps
->
n
)

3158 
ba£
 = 
comps
->
buf
[0];

3159 
i
 = 0; i <ğ
ncomps
; i++) {

3160 
»s
 = 
	`hashtb_£ek
(
e
, 
msg
 + 
ba£
, 
comps
->
buf
[
i
] - base, 0);

3161 ià(
»s
 < 0)

3163 
Åe
 = 
e
->
d©a
;

3164 ià(
»s
 =ğ
HT_NEW_ENTRY
) {

3165 
h—d
 = &
Åe
->
³_h—d
;

3166 
h—d
->
Ãxt
 = head;

3167 
h—d
->
´ev
 = head;

3168 
h—d
->
çûid
 = 
CCN_NOFACEID
;

3169 
Åe
->
·»Á
 =…arent;

3170 
Åe
->
fÜw¬dšg
 = 
NULL
;

3171 
Åe
->
fg’
 = 
h
->
fÜw¬d_to_g’
 - 1;

3172 
Åe
->
fÜw¬d_to
 = 
NULL
;

3173 ià(
·»Á
 !ğ
NULL
) {

3174 
·»Á
->
chd»n
++;

3175 
Åe
->
æags
 = 
·»Á
->flags;

3176 
Åe
->
¤c
 = 
·»Á
->src;

3177 
Åe
->
o¤c
 = 
·»Á
->osrc;

3178 
Åe
->
u£c
 = 
·»Á
->usec;

3181 
Åe
->
¤c
 =‚³->
o¤c
 = 
CCN_NOFACEID
;

3182 
Åe
->
u£c
 = (
	`Äªd48
(
h
->
£ed
) % 4096U) + 8192;

3185 
·»Á
 = 
Åe
;

3187 (
»s
);

3188 
	}
}

3190 
cÚ‹Á_’Œy
 *

3191 
	$Ãxt_chd_©_Ëv–
(
cúd_hªdË
 *
h
,

3192 
cÚ‹Á_’Œy
 *
cÚ‹Á
, 
Ëv–
)

3194 
cÚ‹Á_’Œy
 *
Ãxt
 = 
NULL
;

3195 
cú_ch¬buf
 *
Çme
;

3196 
cú_šdexbuf
 *
´ed
[
CCN_SKIPLIST_MAX_DEPTH
] = {
NULL
};

3197 
d
;

3198 
»s
;

3200 ià(
cÚ‹Á
 =ğ
NULL
)

3201 (
NULL
);

3202 ià(
cÚ‹Á
->
ncomps
 <ğ
Ëv–
 + 1)

3203 (
NULL
);

3204 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

3205 
	`cú_Çme_š™
(
Çme
);

3206 
»s
 = 
	`cú_Çme_­³nd_compÚ’ts
(
Çme
, 
cÚ‹Á
->
key
,

3207 
cÚ‹Á
->
comps
[0],

3208 
cÚ‹Á
->
comps
[
Ëv–
 + 1]);

3209 ià(
»s
 < 0è
	`abÜt
();

3210 
»s
 = 
	`cú_Çme_Ãxt_siblšg
(
Çme
);

3211 ià(
»s
 < 0è
	`abÜt
();

3212 ià(
h
->
debug
 & 8)

3213 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "chd_sucûssÜ", 
NULL
,

3214 
Çme
->
buf
,‚ame->
Ëngth
);

3215 
d
 = 
	`cÚ‹Á_skli¡_fšdbefÜe
(
h
, 
Çme
->
buf
,‚ame->
Ëngth
,

3216 
NULL
, 
´ed
);

3217 
Ãxt
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
´ed
[0]->
buf
[0]);

3218 ià(
Ãxt
 =ğ
cÚ‹Á
) {

3220 
Ãxt
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
	`cÚ‹Á_skli¡_Ãxt
(h, 
cÚ‹Á
));

3221 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "bump", 
NULL
, 
Ãxt
->
key
,‚ext->
size
);

3223 
	`cú_ch¬buf_de¡roy
(&
Çme
);

3224 (
Ãxt
);

3225 
	}
}

3228 
	$´oûss_šcomšg_š‹»¡
(
cúd_hªdË
 *
h
, 
çû
 *face,

3229 *
msg
, 
size_t
 
size
)

3231 
hashtb_’um”©Ü
 
“
;

3232 
hashtb_’um”©Ü
 *
e
 = &
“
;

3233 
cú_·r£d_š‹»¡
 
·r£d_š‹»¡
 = {0};

3234 
cú_·r£d_š‹»¡
 *
pi
 = &
·r£d_š‹»¡
;

3235 
size_t
 
Çmesize
 = 0;

3236 
k
;

3237 
»s
;

3238 
Œy
;

3239 
m©ched
;

3240 
s_ok
;

3241 
Çm•»fix_’Œy
 *
Åe
 = 
NULL
;

3242 
cÚ‹Á_’Œy
 *
cÚ‹Á
 = 
NULL
;

3243 
cÚ‹Á_’Œy
 *
Ï¡_m©ch
 = 
NULL
;

3244 
cú_šdexbuf
 *
comps
 = 
	`šdexbuf_obš
(
h
);

3245 ià(
size
 > 65535)

3246 
»s
 = -
__LINE__
;

3248 
»s
 = 
	`cú_·r£_š‹»¡
(
msg
, 
size
, 
pi
, 
comps
);

3249 ià(
»s
 < 0) {

3250 
	`cúd_msg
(
h
, "”rÜ…¬sšg IÁ”e¡ - cod%d", 
»s
);

3252 ià(
pi
->
scİe
 >= 0 &&…i->scope < 2 &&

3253 (
çû
->
æags
 & 
CCN_FACE_GG
) == 0) {

3254 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "š‹»¡_outofscİe", 
çû
, 
msg
, 
size
);

3255 
h
->
š‹»¡s_drİ³d
 += 1;

3257 ià(
	`is_du¶iÿ‹_æooded
(
h
, 
msg
, 
pi
, 
çû
->
çûid
)) {

3258 ià(
h
->
debug
 & 16)

3259 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "š‹»¡_dup", 
çû
, 
msg
, 
size
);

3260 
h
->
š‹»¡s_drİ³d
 += 1;

3263 ià(
h
->
debug
 & (16 | 8 | 2))

3264 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "š‹»¡_äom", 
çû
, 
msg
, 
size
);

3265 ià(
h
->
debug
 & 16)

3266 
	`cúd_msg
(
h
,

3277 
pi
->
magic
,

3278 
pi
->
´efix_comps
,

3279 
pi
->
mš_suffix_comps
,

3280 
pi
->
max_suffix_comps
,

3281 
pi
->
Üd”´ef
,…i->
ªsw”äom
,…i->
scİe
,

3282 
	`cú_š‹»¡_liãtime_£cÚds
(
msg
, 
pi
),

3283 ()(
	`cú_š‹»¡_liãtime
(
msg
, 
pi
) & 0xFFF) * 10000 / 4096,

3284 
pi
->
off£t
[
CCN_PI_E_Exşude
] -…i->off£t[
CCN_PI_B_Exşude
],

3285 
pi
->
off£t
[
CCN_PI_E_OTHER
] -…i->off£t[
CCN_PI_B_OTHER
]);

3286 ià(
pi
->
magic
 < 20090701) {

3287 ià(++(
h
->
ŞdfÜm©š‹»¡s
è=ğh->
ŞdfÜm©š‹»¡grumbË
) {

3288 
h
->
ŞdfÜm©š‹»¡grumbË
 *= 2;

3289 
	`cúd_msg
(
h
, "downrev interests„eceived: %d (%d)",

3290 
h
->
ŞdfÜm©š‹»¡s
,

3291 
pi
->
magic
);

3294 
Çmesize
 = 
comps
->
buf
[
pi
->
´efix_comps
] - comps->buf[0];

3295 
h
->
š‹»¡s_acû±ed
 += 1;

3296 
s_ok
 = (
pi
->
ªsw”äom
 & 
CCN_AOK_STALE
) != 0;

3297 
m©ched
 = 0;

3298 
	`hashtb_¡¬t
(
h
->
Çm•»fix_b
, 
e
);

3299 
»s
 = 
	`Çm•»fix_£ek
(
h
, 
e
, 
msg
, 
comps
, 
pi
->
´efix_comps
);

3300 
Åe
 = 
e
->
d©a
;

3301 ià(
Åe
 =ğ
NULL
)

3302 
Ba
;

3303 ià((
Åe
->
æags
 & 
CCN_FORW_LOCAL
) != 0 &&

3304 (
çû
->
æags
 & 
CCN_FACE_GG
) == 0) {

3305 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "š‹»¡_nÚloÿl", 
çû
, 
msg
, 
size
);

3306 
h
->
š‹»¡s_drİ³d
 += 1;

3307 
Ba
;

3309 ià((
pi
->
ªsw”äom
 & 
CCN_AOK_CS
) != 0) {

3310 
Ï¡_m©ch
 = 
NULL
;

3311 
cÚ‹Á
 = 
	`fšd_fœ¡_m©ch_ÿndid©e
(
h
, 
msg
, 
pi
);

3312 ià(
cÚ‹Á
 !ğ
NULL
 && (
h
->
debug
 & 8))

3313 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "fœ¡_ÿndid©e", 
NULL
,

3314 
cÚ‹Á
->
key
,

3315 
cÚ‹Á
->
size
);

3316 ià(
cÚ‹Á
 !ğ
NULL
 &&

3317 !
	`cÚ‹Á_m©ches_š‹»¡_´efix
(
h
, 
cÚ‹Á
, 
msg
, 
comps
,

3318 
pi
->
´efix_comps
)) {

3319 ià(
h
->
debug
 & 8)

3320 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "´efix_mism©ch", 
NULL
,

3321 
msg
, 
size
);

3322 
cÚ‹Á
 = 
NULL
;

3324 
Œy
 = 0; 
cÚ‹Á
 !ğ
NULL
;ry++) {

3325 ià((
s_ok
 || (
cÚ‹Á
->
æags
 & 
CCN_CONTENT_ENTRY_STALE
) == 0) &&

3326 
	`cú_cÚ‹Á_m©ches_š‹»¡
(
cÚ‹Á
->
key
,

3327 
cÚ‹Á
->
size
,

3328 0, 
NULL
, 
msg
, 
size
, 
pi
)) {

3329 ià((
pi
->
Üd”´ef
 & 1) == 0 &&

3330 
pi
->
´efix_comps
 !ğ
comps
->
n
 - 1 &&

3331 
comps
->
n
 =ğ
cÚ‹Á
->
ncomps
 &&

3332 
	`cÚ‹Á_m©ches_š‹»¡_´efix
(
h
, 
cÚ‹Á
, 
msg
,

3333 
comps
, comps->
n
 - 1)) {

3334 ià(
h
->
debug
 & 8)

3335 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "sk_m©ch", 
NULL
,

3336 
cÚ‹Á
->
key
,

3337 
cÚ‹Á
->
size
);

3338 
move_®Úg
;

3340 ià(
h
->
debug
 & 8)

3341 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "m©ches", 
NULL
,

3342 
cÚ‹Á
->
key
,

3343 
cÚ‹Á
->
size
);

3344 ià((
pi
->
Üd”´ef
 & 1) == 0)

3346 
Ï¡_m©ch
 = 
cÚ‹Á
;

3347 
cÚ‹Á
 = 
	`Ãxt_chd_©_Ëv–
(
h
, cÚ‹Á, 
comps
->
n
 - 1);

3348 
check_Ãxt_´efix
;

3350 
move_®Úg
:

3351 
cÚ‹Á
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
	`cÚ‹Á_skli¡_Ãxt
(h, content));

3352 
check_Ãxt_´efix
:

3353 ià(
cÚ‹Á
 !ğ
NULL
 &&

3354 !
	`cÚ‹Á_m©ches_š‹»¡_´efix
(
h
, 
cÚ‹Á
, 
msg
,

3355 
comps
, 
pi
->
´efix_comps
)) {

3356 ià(
h
->
debug
 & 8)

3357 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "´efix_mism©ch", 
NULL
,

3358 
cÚ‹Á
->
key
,

3359 
cÚ‹Á
->
size
);

3360 
cÚ‹Á
 = 
NULL
;

3363 ià(
Ï¡_m©ch
 !ğ
NULL
)

3364 
cÚ‹Á
 = 
Ï¡_m©ch
;

3365 ià(
cÚ‹Á
 !ğ
NULL
) {

3367 
cq_d–ay_şass
 
c
;

3368 
c
 = 0, 
k
 = -1; c < 
CCN_CQ_N
 && k == -1; c++)

3369 ià(
çû
->
q
[
c
] !ğ
NULL
)

3370 
k
 = 
	`cú_šdexbuf_memb”
(
çû
->
q
[
c
]->
£nd_queue
, 
cÚ‹Á
->
acûssiÚ
);

3371 ià(
k
 == -1) {

3372 
k
 = 
	`çû_£nd_queue_š£¹
(
h
, 
çû
, 
cÚ‹Á
);

3373 ià(
k
 >= 0) {

3374 ià(
h
->
debug
 & (32 | 8))

3375 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "cÚsume", 
çû
, 
msg
, 
size
);

3378 
	`m©ch_š‹»¡s
(
h
, 
cÚ‹Á
, 
NULL
, 
çû
, NULL);

3380 ià((
pi
->
ªsw”äom
 & 
CCN_AOK_EXPIRE
) != 0)

3381 
	`m¬k_¡®e
(
h
, 
cÚ‹Á
);

3382 
m©ched
 = 1;

3385 ià(!
m©ched
 && 
pi
->
scİe
 !ğ0 && 
Åe
 !ğ
NULL
)

3386 
	`´İag©e_š‹»¡
(
h
, 
çû
, 
msg
, 
pi
, 
Åe
);

3387 
Ba
:

3388 
	`hashtb_’d
(
e
);

3390 
	`šdexbuf_»Ëa£
(
h
, 
comps
);

3391 
	}
}

3397 
	$m¬k_¡®e
(
cúd_hªdË
 *
h
, 
cÚ‹Á_’Œy
 *
cÚ‹Á
)

3399 
cú_acûssiÚ_t
 
acûssiÚ
 = 
cÚ‹Á
->accession;

3400 ià((
cÚ‹Á
->
æags
 & 
CCN_CONTENT_ENTRY_STALE
) != 0)

3402 ià(
h
->
debug
 & 4)

3403 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "¡®e", 
NULL
,

3404 
cÚ‹Á
->
key
, cÚ‹Á->
size
);

3405 
cÚ‹Á
->
æags
 |ğ
CCN_CONTENT_ENTRY_STALE
;

3406 
h
->
n_¡®e
++;

3407 ià(
acûssiÚ
 < 
h
->
mš_¡®e
)

3408 
h
->
mš_¡®e
 = 
acûssiÚ
;

3409 ià(
acûssiÚ
 > 
h
->
max_¡®e
)

3410 
h
->
max_¡®e
 = 
acûssiÚ
;

3411 
	}
}

3420 
	$expœe_cÚ‹Á
(
cú_scheduË
 *
sched
,

3421 *
ş›Áh
,

3422 
cú_scheduËd_ev’t
 *
ev
,

3423 
æags
)

3425 
cúd_hªdË
 *
h
 = 
ş›Áh
;

3426 
cú_acûssiÚ_t
 
acûssiÚ
 = 
ev
->
evšt
;

3427 
cÚ‹Á_’Œy
 *
cÚ‹Á
 = 
NULL
;

3428 
»s
;

3429 
n
;

3430 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) != 0)

3432 
cÚ‹Á
 = 
	`cÚ‹Á_äom_acûssiÚ
(
h
, 
acûssiÚ
);

3433 ià(
cÚ‹Á
 !ğ
NULL
) {

3434 
n
 = 
	`hashtb_n
(
h
->
cÚ‹Á_b
);

3436 ià((
n
 - (À>> 3)è> 
h
->
ÿ·c™y
 ||

3437 (
n
 > 
h
->
ÿ·c™y
 && h->
mš_¡®e
 > h->
max_¡®e
)) {

3438 
»s
 = 
	`»move_cÚ‹Á
(
h
, 
cÚ‹Á
);

3439 ià(
»s
 == 0)

3442 
	`m¬k_¡®e
(
h
, 
cÚ‹Á
);

3445 
	}
}

3452 
	$£t_cÚ‹Á_tim”
(
cúd_hªdË
 *
h
, 
cÚ‹Á_’Œy
 *
cÚ‹Á
,

3453 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
)

3455 
£cÚds
 = 0;

3456 
miüo£cÚds
 = 0;

3457 
size_t
 
¡¬t
 = 
pco
->
off£t
[
CCN_PCO_B_F»shÃssSecÚds
];

3458 
size_t
 
¡İ
 = 
pco
->
off£t
[
CCN_PCO_E_F»shÃssSecÚds
];

3459 ià(
h
->
fÜû_z”o_äeshÃss
) {

3461 
miüo£cÚds
 = 8 * 
h
->
d©a_·u£_miüo£c
 + 10000;

3462 
Fšish
;

3464 ià(
¡¬t
 =ğ
¡İ
)

3466 
£cÚds
 = 
	`cú_ãtch_gged_nÚNeg©iveIÁeg”
(

3467 
CCN_DTAG_F»shÃssSecÚds
,

3468 
cÚ‹Á
->
key
,

3469 
¡¬t
, 
¡İ
);

3470 ià(
£cÚds
 <= 0)

3472 ià(
£cÚds
 > ((1U<<31) / 1000000)) {

3473 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "F»shÃssSecÚds_too_Ïrge", 
NULL
,

3474 
cÚ‹Á
->
key
, 
pco
->
off£t
[
CCN_PCO_E
]);

3477 
miüo£cÚds
 = 
£cÚds
 * 1000000;

3478 
Fšish
:

3479 
	`cú_scheduË_ev’t
(
h
->
sched
, 
miüo£cÚds
,

3480 &
expœe_cÚ‹Á
, 
NULL
, 
cÚ‹Á
->
acûssiÚ
);

3481 
	}
}

3484 
	$´oûss_šcomšg_cÚ‹Á
(
cúd_hªdË
 *
h
, 
çû
 *face,

3485 *
wœe_msg
, 
size_t
 
wœe_size
)

3487 *
msg
;

3488 
size_t
 
size
;

3489 
hashtb_’um”©Ü
 
“
;

3490 
hashtb_’um”©Ü
 *
e
 = &
“
;

3491 
cú_·r£d_CÚ‹ÁObjeù
 
obj
 = {0};

3492 
»s
;

3493 
size_t
 
keysize
 = 0;

3494 
size_t
 
size
 = 0;

3495 *

 = 
NULL
;

3496 
cÚ‹Á_’Œy
 *
cÚ‹Á
 = 
NULL
;

3497 
i
;

3498 
cú_šdexbuf
 *
comps
 = 
	`šdexbuf_obš
(
h
);

3499 
cú_ch¬buf
 *
cb
 = 
	`ch¬buf_obš
(
h
);

3501 
msg
 = 
wœe_msg
;

3502 
size
 = 
wœe_size
;

3504 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
msg
, 
size
, &
obj
, 
comps
);

3505 ià(
»s
 < 0) {

3506 
	`cúd_msg
(
h
, "”rÜ…¬sšg CÚ‹ÁObjeù - cod%d", 
»s
);

3507 
Ba
;

3509 ià(
comps
->
n
 < 1 ||

3510 (
keysize
 = 
comps
->
buf
[comps->
n
 - 1]) > 65535 - 36) {

3511 
	`cúd_msg
(
h
, "ContentObject with keysize %lu discarded",

3512 ()
keysize
);

3513 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "ov”size", 
çû
, 
msg
, 
size
);

3514 
»s
 = -
__LINE__
;

3515 
Ba
;

3518 
	`cú_dige¡_CÚ‹ÁObjeù
(
msg
, &
obj
);

3519 ià(
obj
.
dige¡_by‹s
 != 32) {

3520 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "šdige¡ibË", 
çû
, 
msg
, 
size
);

3521 
Ba
;

3523 
i
 = 
comps
->
buf
[comps->
n
 - 1];

3524 
	`cú_ch¬buf_­³nd
(
cb
, 
msg
, 
i
);

3525 
	`cú_ch¬buf_­³nd_‰
(
cb
, 
CCN_DTAG_CompÚ’t
, 
CCN_DTAG
);

3526 
	`cú_ch¬buf_­³nd_‰
(
cb
, 
obj
.
dige¡_by‹s
, 
CCN_BLOB
);

3527 
	`cú_ch¬buf_­³nd
(
cb
, 
obj
.
dige¡
, obj.
dige¡_by‹s
);

3528 
	`cú_ch¬buf_­³nd_şo£r
(
cb
);

3529 
	`cú_ch¬buf_­³nd
(
cb
, 
msg
 + 
i
, 
size
 - i);

3530 
msg
 = 
cb
->
buf
;

3531 
size
 = 
cb
->
Ëngth
;

3532 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
msg
, 
size
, &
obj
, 
comps
);

3533 ià(
»s
 < 0è
	`abÜt
();

3535 ià(
obj
.
magic
 != 20090415) {

3536 ià(++(
h
->
ŞdfÜm©cÚ‹Á
è=ğh->
ŞdfÜm©cÚ‹ÁgrumbË
) {

3537 
h
->
ŞdfÜm©cÚ‹ÁgrumbË
 *= 10;

3538 
	`cúd_msg
(
h
, "downrev content items„eceived: %d (%d)",

3539 
h
->
ŞdfÜm©cÚ‹Á
,

3540 
obj
.
magic
);

3543 ià(
h
->
debug
 & 4)

3544 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "cÚ‹Á_äom", 
çû
, 
msg
, 
size
);

3545 
keysize
 = 
obj
.
off£t
[
CCN_PCO_B_CÚ‹Á
];

3546 

 = 
msg
 + 
keysize
;

3547 
size
 = 
size
 - 
keysize
;

3548 
	`hashtb_¡¬t
(
h
->
cÚ‹Á_b
, 
e
);

3549 
»s
 = 
	`hashtb_£ek
(
e
, 
msg
, 
keysize
, 
size
);

3550 
cÚ‹Á
 = 
e
->
d©a
;

3551 ià(
»s
 =ğ
HT_OLD_ENTRY
) {

3552 ià(
size
 !ğ
e
->
extsize
 ||

3553 0 !ğ
	`memcmp
(

, ((*)
e
->
key
è+ 
keysize
, 
size
)) {

3554 
	`cúd_msg
(
h
, "ContentObject‚ame collision!!!!!");

3555 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "Ãw", 
çû
, 
msg
, 
size
);

3556 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "Şd", 
NULL
, 
e
->
key
,ƒ->
keysize
 +ƒ->
extsize
);

3557 
cÚ‹Á
 = 
NULL
;

3558 
	`hashtb_d–‘e
(
e
);

3559 
»s
 = -
__LINE__
;

3561 ià((
cÚ‹Á
->
æags
 & 
CCN_CONTENT_ENTRY_STALE
) != 0) {

3564 
cÚ‹Á
->
æags
 &ğ~
CCN_CONTENT_ENTRY_STALE
;

3565 
h
->
n_¡®e
--;

3566 
	`£t_cÚ‹Á_tim”
(
h
, 
cÚ‹Á
, &
obj
);

3570 
h
->
cÚ‹Á_dups_»cvd
++;

3571 
	`cúd_msg
(
h
, "received duplicate ContentObject from %u (accession %llu)",

3572 
çû
->
çûid
, ()
cÚ‹Á
->
acûssiÚ
);

3573 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "dup", 
çû
, 
msg
, 
size
);

3576 ià(
»s
 =ğ
HT_NEW_ENTRY
) {

3577 
cÚ‹Á
->
acûssiÚ
 = ++(
h
->accession);

3578 
	`’rŞl_cÚ‹Á
(
h
, 
cÚ‹Á
);

3579 ià(
cÚ‹Á
 =ğ
	`cÚ‹Á_äom_acûssiÚ
(
h
, cÚ‹Á->
acûssiÚ
)) {

3580 
cÚ‹Á
->
ncomps
 = 
comps
->
n
;

3581 
cÚ‹Á
->
comps
 = 
	`ÿÎoc
(comps->
n
, (comps[0]));

3583 
cÚ‹Á
->
key_size
 = 
e
->
keysize
;

3584 
cÚ‹Á
->
size
 = 
e
->
keysize
 +ƒ->
extsize
;

3585 
cÚ‹Á
->
key
 = 
e
->key;

3586 ià(
cÚ‹Á
->
comps
 !ğ
NULL
) {

3587 
i
 = 0; i < 
comps
->
n
; i++)

3588 
cÚ‹Á
->
comps
[
i
] = comps->
buf
[i];

3589 
	`cÚ‹Á_skli¡_š£¹
(
h
, 
cÚ‹Á
);

3590 
	`£t_cÚ‹Á_tim”
(
h
, 
cÚ‹Á
, &
obj
);

3593 
	`cúd_msg
(
h
, "could‚otƒnroll ContentObject (accession %llu)",

3594 ()
cÚ‹Á
->
acûssiÚ
);

3595 
	`hashtb_d–‘e
(
e
);

3596 
»s
 = -
__LINE__
;

3597 
cÚ‹Á
 = 
NULL
;

3600 ià(
obj
.
ty³
 =ğ
CCN_CONTENT_KEY
 && 
cÚ‹Á
->
acûssiÚ
 <ğ(
h
->
ÿ·c™y
 + 7)/8)

3601 
cÚ‹Á
->
æags
 |ğ
CCN_CONTENT_ENTRY_PRECIOUS
;

3603 
	`hashtb_’d
(
e
);

3604 
Ba
:

3605 
	`šdexbuf_»Ëa£
(
h
, 
comps
);

3606 
	`ch¬buf_»Ëa£
(
h
, 
cb
);

3607 
cb
 = 
NULL
;

3608 ià(
»s
 >ğ0 && 
cÚ‹Á
 !ğ
NULL
) {

3609 
n_m©ches
;

3610 
cq_d–ay_şass
 
c
;

3611 
cÚ‹Á_queue
 *
q
;

3612 
n_m©ches
 = 
	`m©ch_š‹»¡s
(
h
, 
cÚ‹Á
, &
obj
, 
NULL
, 
çû
);

3613 ià(
»s
 =ğ
HT_NEW_ENTRY
) {

3614 ià(
n_m©ches
 < 0) {

3615 
	`»move_cÚ‹Á
(
h
, 
cÚ‹Á
);

3618 ià(
n_m©ches
 =ğ0 && (
çû
->
æags
 & 
CCN_FACE_GG
) == 0) {

3619 
cÚ‹Á
->
æags
 |ğ
CCN_CONTENT_ENTRY_SLOWSEND
;

3620 
	`cú_šdexbuf_­³nd_–em’t
(
h
->
unsŞ
, 
cÚ‹Á
->
acûssiÚ
);

3623 
c
 = 0; c < 
CCN_CQ_N
; c++) {

3624 
q
 = 
çû
->q[
c
];

3625 ià(
q
 !ğ
NULL
) {

3626 
i
 = 
	`cú_šdexbuf_memb”
(
q
->
£nd_queue
, 
cÚ‹Á
->
acûssiÚ
);

3627 ià(
i
 >= 0) {

3632 ià(
h
->
debug
 & 8)

3633 
	`cúd_debug_cúb
(
h
, 
__LINE__
, "cÚ‹Á_no£nd", 
çû
, 
msg
, 
size
);

3634 
q
->
£nd_queue
->
buf
[
i
] = 0;

3639 
	}
}

3642 
	$´oûss_šput_mes§ge
(
cúd_hªdË
 *
h
, 
çû
 *face,

3643 *
msg
, 
size_t
 
size
, 
pdu_ok
)

3645 
cú_sk–‘Ú_decod”
 
decod”
 = {0};

3646 
cú_sk–‘Ú_decod”
 *
d
 = &
decod”
;

3647 
ssize_t
 
d»s
;

3649 ià((
çû
->
æags
 & 
CCN_FACE_UNDECIDED
) != 0) {

3650 
çû
->
æags
 &ğ~
CCN_FACE_UNDECIDED
;

3651 ià((
çû
->
æags
 & 
CCN_FACE_LOOPBACK
) != 0)

3652 
çû
->
æags
 |ğ
CCN_FACE_GG
;

3653 
	`»gi¡”_Ãw_çû
(
h
, 
çû
);

3655 
d
->
¡©e
 |ğ
CCN_DSTATE_PAUSE
;

3656 
d»s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
msg
, 
size
);

3657 ià(
d
->
¡©e
 >ğ0 && 
	`CCN_GET_TT_FROM_DSTATE
(d->¡©eè=ğ
CCN_DTAG
) {

3658 ià(
pdu_ok
 && 
d
->
numv®
 =ğ
CCN_DTAG_CCNPrÙocŞD©aUn™
) {

3659 
size
 -ğ
d
->
šdex
;

3660 ià(
size
 > 0)

3661 
size
--;

3662 
msg
 +ğ
d
->
šdex
;

3663 
çû
->
æags
 |ğ
CCN_FACE_LINK
;

3664 
çû
->
æags
 &ğ~
CCN_FACE_GG
;

3665 
	`mem£t
(
d
, 0, (*d));

3666 
d
->
šdex
 < 
size
) {

3667 
d»s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
msg
 + d->
šdex
, 
size
 - d->index);

3668 ià(
d
->
¡©e
 != 0)

3671 
	`´oûss_šput_mes§ge
(
h
, 
çû
, 
msg
 + 
d
->
šdex
 - 
d»s
, dres, 0);

3675 ià(
d
->
numv®
 =ğ
CCN_DTAG_IÁ”e¡
) {

3676 
	`´oûss_šcomšg_š‹»¡
(
h
, 
çû
, 
msg
, 
size
);

3679 ià(
d
->
numv®
 =ğ
CCN_DTAG_CÚ‹ÁObjeù
) {

3680 
	`´oûss_šcomšg_cÚ‹Á
(
h
, 
çû
, 
msg
, 
size
);

3684 
	`cúd_msg
(
h
, "disÿrdšg unknowÀmes§ge; sizğ%lu", ()
size
);

3685 
	}
}

3688 
	$cúd_Ãw_çû_msg
(
cúd_hªdË
 *
h
, 
çû
 *face)

3690 cÚ¡ 
sockaddr
 *
addr
 = 
çû
->addr;

3691 
pÜt
 = 0;

3692 cÚ¡ *
¿waddr
 = 
NULL
;

3693 
´šbË
[80];

3694 cÚ¡ *
³”
 = 
NULL
;

3695 ià(
addr
->
§_çmy
 =ğ
AF_INET6
) {

3696 cÚ¡ 
sockaddr_š6
 *
addr6
 = (sockaddr_š6 *)
addr
;

3697 
¿waddr
 = (cÚ¡ *)&
addr6
->
sš6_addr
;

3698 
pÜt
 = 
	`htÚs
(
addr6
->
sš6_pÜt
);

3700 ià(
addr
->
§_çmy
 =ğ
AF_INET
) {

3701 cÚ¡ 
sockaddr_š
 *
addr4
 = (sockaddr_š *)
addr
;

3702 
¿waddr
 = (cÚ¡ *)&
addr4
->
sš_addr
.
s_addr
;

3703 
pÜt
 = 
	`htÚs
(
addr4
->
sš_pÜt
);

3705 ià(
¿waddr
 !ğ
NULL
)

3706 
³”
 = 
	`š‘_Áİ
(
addr
->
§_çmy
, 
¿waddr
, 
´šbË
, (printable));

3707 ià(
³”
 =ğ
NULL
)

3708 
³”
 = "(unknown)";

3709 
	`cúd_msg
(
h
,

3711 
çû
->
çûid
, faû->
æags
, 
³”
, 
pÜt
);

3712 
	}
}

3714 
çû
 *

3715 
	$g‘_dg¿m_sourû
(
cúd_hªdË
 *
h
, 
çû
 *face,

3716 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
, 
why
)

3718 
çû
 *
sourû
 = 
NULL
;

3719 
hashtb_’um”©Ü
 
“
;

3720 
hashtb_’um”©Ü
 *
e
 = &
“
;

3721 
»s
;

3722 ià((
çû
->
æags
 & 
CCN_FACE_DGRAM
) == 0)

3723 (
çû
);

3724 ià((
çû
->
æags
 & 
CCN_FACE_MCAST
) != 0)

3725 (
çû
);

3726 
	`hashtb_¡¬t
(
h
->
dg¿m_çûs
, 
e
);

3727 
»s
 = 
	`hashtb_£ek
(
e
, 
addr
, 
add¾’
, 0);

3728 ià(
»s
 >= 0) {

3729 
sourû
 = 
e
->
d©a
;

3730 
sourû
->
»cvcouÁ
++;

3731 ià(
sourû
->
addr
 =ğ
NULL
) {

3732 
sourû
->
addr
 = 
e
->
key
;

3733 
sourû
->
add¾’
 = 
e
->
keysize
;

3734 
sourû
->
»cv_fd
 = 
çû
->recv_fd;

3735 
sourû
->
£ndçû
 = 
çû
->
çûid
;

3736 
	`š™_çû_æags
(
h
, 
sourû
, 
CCN_FACE_DGRAM
);

3737 ià(
why
 =ğ1 && (
sourû
->
æags
 & 
CCN_FACE_LOOPBACK
) != 0)

3738 
sourû
->
æags
 |ğ
CCN_FACE_GG
;

3739 
»s
 = 
	`’rŞl_çû
(
h
, 
sourû
);

3740 ià(
»s
 == -1) {

3741 
	`hashtb_d–‘e
(
e
);

3742 
sourû
 = 
NULL
;

3745 
	`cúd_Ãw_çû_msg
(
h
, 
sourû
);

3746 
	`»­_Ãeded
(
h
, 
CCN_INTEREST_LIFETIME_MICROSEC
);

3750 
	`hashtb_’d
(
e
);

3751 (
sourû
);

3752 
	}
}

3755 
	$´oûss_šput_bufãr
(
cúd_hªdË
 *
h
, 
çû
 *face)

3757 *
msg
;

3758 
size_t
 
size
;

3759 
ssize_t
 
d»s
;

3760 
cú_sk–‘Ú_decod”
 *
d
;

3762 ià(
çû
 =ğ
NULL
 || faû->
šbuf
 == NULL)

3764 
d
 = &
çû
->
decod”
;

3765 
msg
 = 
çû
->
šbuf
->
buf
;

3766 
size
 = 
çû
->
šbuf
->
Ëngth
;

3767 
d
->
šdex
 < 
size
) {

3768 
d»s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
msg
 + d->
šdex
, 
size
 - d->index);

3769 ià(
d
->
¡©e
 != 0)

3771 
	`´oûss_šput_mes§ge
(
h
, 
çû
, 
msg
 + 
d
->
šdex
 - 
d»s
, dres, 0);

3773 ià(
d
->
šdex
 !ğ
size
) {

3774 
	`cúd_msg
(
h
, "protocolƒrror on face %u (state %d), discarding %d bytes",

3775 
çû
->
çûid
, 
d
->
¡©e
, ()(
size
 - d->
šdex
));

3778 
çû
->
šbuf
->
Ëngth
 = 0;

3779 
	`mem£t
(
d
, 0, (*d));

3780 
	}
}

3783 
	$´oûss_šput
(
cúd_hªdË
 *
h
, 
fd
)

3785 
çû
 *çû = 
NULL
;

3786 
çû
 *
sourû
 = 
NULL
;

3787 
ssize_t
 
»s
;

3788 
ssize_t
 
d»s
;

3789 
ssize_t
 
msg¡¬t
;

3790 *
buf
;

3791 
cú_sk–‘Ú_decod”
 *
d
;

3792 
sockaddr_¡Üage
 
s¡Ü
;

3793 
sockËn_t
 
add¾’
 = (
s¡Ü
);

3794 
sockaddr
 *
addr
 = (sockadd¸*)&
s¡Ü
;

3795 
”r
 = 0;

3796 
sockËn_t
 
”r_sz
;

3798 
çû
 = 
	`hashtb_lookup
(
h
->
çûs_by_fd
, &
fd
, (fd));

3799 ià(
çû
 =ğ
NULL
)

3801 ià((
çû
->
æags
 & (
CCN_FACE_DGRAM
 | 
CCN_FACE_PASSIVE
)) == CCN_FACE_PASSIVE) {

3802 
	`acû±_cÚÃùiÚ
(
h
, 
fd
);

3803 
	`check_comm_fe
(
h
);

3806 
”r_sz
 = (
”r
);

3807 
»s
 = 
	`g‘sockİt
(
çû
->
»cv_fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”r
, &
”r_sz
);

3808 ià(
»s
 >ğ0 && 
”r
 != 0) {

3809 
	`cúd_msg
(
h
, "”rÜ oÀçû %u: % (%d)", 
çû
->
çûid
, 
	`¡»¼Ü
(
”r
),ƒrr);

3810 ià(
”r
 =ğ
ETIMEDOUT
 && (
çû
->
æags
 & 
CCN_FACE_CONNECTING
) != 0) {

3811 
	`shutdown_ş›Á_fd
(
h
, 
fd
);

3815 
d
 = &
çû
->
decod”
;

3816 ià(
çû
->
šbuf
 =ğ
NULL
)

3817 
çû
->
šbuf
 = 
	`cú_ch¬buf_ü—‹
();

3818 ià(
çû
->
šbuf
->
Ëngth
 == 0)

3819 
	`mem£t
(
d
, 0, (*d));

3820 
buf
 = 
	`cú_ch¬buf_»£rve
(
çû
->
šbuf
, 8800);

3821 
»s
 = 
	`»cväom
(
çû
->
»cv_fd
, 
buf
, faû->
šbuf
->
lim™
 - faû->šbuf->
Ëngth
,

3822  0, 
addr
, &
add¾’
);

3823 ià(
»s
 == -1)

3824 
	`cúd_msg
(
h
, "recvfrom face %u :%s (errno = %d)",

3825 
çû
->
çûid
, 
	`¡»¼Ü
(
”ºo
),ƒrrno);

3826 ià(
»s
 =ğ0 && (
çû
->
æags
 & 
CCN_FACE_DGRAM
) == 0)

3827 
	`shutdown_ş›Á_fd
(
h
, 
fd
);

3829 
sourû
 = 
	`g‘_dg¿m_sourû
(
h
, 
çû
, 
addr
, 
add¾’
, (
»s
 == 1) ? 1 : 2);

3830 
sourû
->
»cvcouÁ
++;

3831 
sourû
->
su½lus
 = 0;

3832 ià(
»s
 <ğ1 && (
sourû
->
æags
 & 
CCN_FACE_DGRAM
) != 0) {

3833 ià(
h
->
debug
 & 128)

3834 
	`cúd_msg
(
h
, "%d-by‹ h—¹b—ˆÚ %d", ()
»s
, 
sourû
->
çûid
);

3837 
çû
->
šbuf
->
Ëngth
 +ğ
»s
;

3838 
msg¡¬t
 = 0;

3839 ià(((
çû
->
æags
 & 
CCN_FACE_UNDECIDED
) != 0 &&

3840 
çû
->
šbuf
->
Ëngth
 >= 6 &&

3841 0 =ğ
	`memcmp
(
çû
->
šbuf
->
buf
, "GET ", 4))) {

3842 
	`cúd_¡©s_hªdË_h‰p_cÚÃùiÚ
(
h
, 
çû
);

3845 
d»s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
buf
, 
»s
);

3846 
d
->
¡©e
 == 0) {

3847 
	`´oûss_šput_mes§ge
(
h
, 
sourû
,

3848 
çû
->
šbuf
->
buf
 + 
msg¡¬t
,

3849 
d
->
šdex
 - 
msg¡¬t
,

3850 (
çû
->
æags
 & 
CCN_FACE_LOCAL
) != 0);

3851 
msg¡¬t
 = 
d
->
šdex
;

3852 ià(
msg¡¬t
 =ğ
çû
->
šbuf
->
Ëngth
) {

3853 
çû
->
šbuf
->
Ëngth
 = 0;

3856 
d»s
 = 
	`cú_sk–‘Ú_decode
(
d
,

3857 
çû
->
šbuf
->
buf
 + 
d
->
šdex
,

3858 
»s
 = 
çû
->
šbuf
->
Ëngth
 - 
d
->
šdex
);

3860 ià((
çû
->
æags
 & 
CCN_FACE_DGRAM
) != 0) {

3861 
	`cúd_msg
(
h
, "protocolƒrror on face %u, discarding %u bytes",

3862 
sourû
->
çûid
,

3863 ()(
çû
->
šbuf
->
Ëngth
));

3864 
çû
->
šbuf
->
Ëngth
 = 0;

3868 ià(
d
->
¡©e
 < 0) {

3869 
	`cúd_msg
(
h
, "´ÙocŞƒ¼Ü oÀçû %u", 
sourû
->
çûid
);

3870 
	`shutdown_ş›Á_fd
(
h
, 
fd
);

3873 ià(
msg¡¬t
 < 
çû
->
šbuf
->
Ëngth
 && msgstart > 0) {

3875 
	`memmove
(
çû
->
šbuf
->
buf
, faû->šbuf->buà+ 
msg¡¬t
,

3876 
çû
->
šbuf
->
Ëngth
 - 
msg¡¬t
);

3877 
çû
->
šbuf
->
Ëngth
 -ğ
msg¡¬t
;

3878 
d
->
šdex
 -ğ
msg¡¬t
;

3881 
	}
}

3884 
	$´oûss_š‹º®_ş›Á_bufãr
(
cúd_hªdË
 *
h
)

3886 
çû
 *çû = 
h
->
çû0
;

3887 ià(
çû
 =ğ
NULL
)

3889 
çû
->
šbuf
 = 
	`cú_g¿b_bufã»d_ouut
(
h
->
š‹º®_ş›Á
);

3890 ià(
çû
->
šbuf
 =ğ
NULL
)

3892 
	`´oûss_šput_bufãr
(
h
, 
çû
);

3893 
	`cú_ch¬buf_de¡roy
(&(
çû
->
šbuf
));

3894 
	}
}

3901 
	$hªdË_£nd_”rÜ
(
cúd_hªdË
 *
h
, 
”ºum
, 
çû
 *face,

3902 cÚ¡ *
d©a
, 
size_t
 
size
)

3904 
»s
 = -1;

3905 ià(
”ºum
 =ğ
EAGAIN
) {

3906 
»s
 = 0;

3908 ià(
”ºum
 =ğ
EPIPE
) {

3909 
çû
->
æags
 |ğ
CCN_FACE_NOSEND
;

3910 
çû
->
outbufšdex
 = 0;

3911 
	`cú_ch¬buf_de¡roy
(&
çû
->
outbuf
);

3914 
	`cúd_msg
(
h
, "sendo face %u failed: %s (errno = %d)",

3915 
çû
->
çûid
, 
	`¡»¼Ü
(
”ºum
),ƒrrnum);

3916 ià(
”ºum
 =ğ
EISCONN
)

3917 
»s
 = 0;

3919 (
»s
);

3920 
	}
}

3923 
	$£ndšg_fd
(
cúd_hªdË
 *
h
, 
çû
 *face)

3925 
çû
 *
out
 = 
NULL
;

3926 ià(
çû
->
£ndçû
 =ğçû->
çûid
)

3927 (
çû
->
»cv_fd
);

3928 
out
 = 
	`çû_äom_çûid
(
h
, 
çû
->
£ndçû
);

3929 ià(
out
 !ğ
NULL
)

3930 (
out
->
»cv_fd
);

3931 
çû
->
£ndçû
 = 
CCN_NOFACEID
;

3932 ià(
çû
->
addr
 !ğ
NULL
) {

3933 
çû
->
addr
->
§_çmy
) {

3934 
AF_INET
:

3935 
çû
->
£ndçû
 = 
h
->
v4_çûid
;

3937 
AF_INET6
:

3938 
çû
->
£ndçû
 = 
h
->
v6_çûid
;

3944 
out
 = 
	`çû_äom_çûid
(
h
, 
çû
->
£ndçû
);

3945 ià(
out
 !ğ
NULL
)

3946 (
out
->
»cv_fd
);

3948 
	}
}

3956 
	$cúd_£nd
(
cúd_hªdË
 *
h
,

3957 
çû
 *face,

3958 cÚ¡ *
d©a
, 
size_t
 
size
)

3960 
ssize_t
 
»s
;

3961 ià((
çû
->
æags
 & 
CCN_FACE_NOSEND
) != 0)

3963 
çû
->
su½lus
++;

3964 ià(
çû
->
outbuf
 !ğ
NULL
) {

3965 
	`cú_ch¬buf_­³nd
(
çû
->
outbuf
, 
d©a
, 
size
);

3968 ià(
çû
 =ğ
h
->
çû0
) {

3969 
	`cú_di¥©ch_mes§ge
(
h
->
š‹º®_ş›Á
, (*)
d©a
, 
size
);

3970 
	`´oûss_š‹º®_ş›Á_bufãr
(
h
);

3973 ià((
çû
->
æags
 & 
CCN_FACE_DGRAM
) == 0)

3974 
»s
 = 
	`£nd
(
çû
->
»cv_fd
, 
d©a
, 
size
, 0);

3976 
»s
 = 
	`£ndto
(
	`£ndšg_fd
(
h
, 
çû
), 
d©a
, 
size
, 0,

3977 
çû
->
addr
, faû->
add¾’
);

3978 ià(
»s
 =ğ
size
)

3980 ià(
»s
 == -1) {

3981 
»s
 = 
	`hªdË_£nd_”rÜ
(
h
, 
”ºo
, 
çû
, 
d©a
, 
size
);

3982 ià(
»s
 == -1)

3985 ià((
çû
->
æags
 & 
CCN_FACE_DGRAM
) != 0) {

3986 
	`cúd_msg
(
h
, "sendto short");

3989 
çû
->
outbufšdex
 = 0;

3990 
çû
->
outbuf
 = 
	`cú_ch¬buf_ü—‹
();

3991 ià(
çû
->
outbuf
 =ğ
NULL
) {

3992 
	`cúd_msg
(
h
, "do_wr™e: %s", 
	`¡»¼Ü
(
”ºo
));

3995 
	`cú_ch¬buf_­³nd
(
çû
->
outbuf
,

3996 ((cÚ¡ *)
d©a
è+ 
»s
, 
size
 -„es);

3997 
	}
}

4000 
	$do_deã¼ed_wr™e
(
cúd_hªdË
 *
h
, 
fd
)

4003 
ssize_t
 
»s
;

4004 
çû
 *çû = 
	`hashtb_lookup
(
h
->
çûs_by_fd
, &
fd
, (fd));

4005 ià(
çû
 =ğ
NULL
)

4007 ià(
çû
->
outbuf
 !ğ
NULL
) {

4008 
ssize_t
 
£ndËn
 = 
çû
->
outbuf
->
Ëngth
 - faû->
outbufšdex
;

4009 ià(
£ndËn
 > 0) {

4010 
»s
 = 
	`£nd
(
fd
, 
çû
->
outbuf
->
buf
 + faû->
outbufšdex
, 
£ndËn
, 0);

4011 ià(
»s
 == -1) {

4012 ià(
”ºo
 =ğ
EPIPE
) {

4013 
çû
->
æags
 |ğ
CCN_FACE_NOSEND
;

4014 
çû
->
outbufšdex
 = 0;

4015 
	`cú_ch¬buf_de¡roy
(&
çû
->
outbuf
);

4018 
	`cúd_msg
(
h
, "£nd: % Ó¼nØğ%d)", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

4019 
	`shutdown_ş›Á_fd
(
h
, 
fd
);

4022 ià(
»s
 =ğ
£ndËn
) {

4023 
çû
->
outbufšdex
 = 0;

4024 
	`cú_ch¬buf_de¡roy
(&
çû
->
outbuf
);

4025 ià((
çû
->
æags
 & 
CCN_FACE_CLOSING
) != 0)

4026 
	`shutdown_ş›Á_fd
(
h
, 
fd
);

4029 
çû
->
outbufšdex
 +ğ
»s
;

4032 
çû
->
outbufšdex
 = 0;

4033 
	`cú_ch¬buf_de¡roy
(&
çû
->
outbuf
);

4035 ià((
çû
->
æags
 & 
CCN_FACE_CLOSING
) != 0)

4036 
	`shutdown_ş›Á_fd
(
h
, 
fd
);

4037 ià((
çû
->
æags
 & 
CCN_FACE_CONNECTING
) != 0)

4038 
çû
->
æags
 &ğ~
CCN_FACE_CONNECTING
;

4040 
	`cúd_msg
(
h
, "cúd:do_deã¼ed_wr™e: som‘hšg fishy oÀ%d", 
fd
);

4041 
	}
}

4051 
	$´•¬e_pŞl_fds
(
cúd_hªdË
 *
h
)

4053 
hashtb_’um”©Ü
 
“
;

4054 
hashtb_’um”©Ü
 *
e
 = &
“
;

4055 
i
, 
j
, 
k
;

4056 ià(
	`hashtb_n
(
h
->
çûs_by_fd
è!ğh->
nfds
) {

4057 
h
->
nfds
 = 
	`hashtb_n
(h->
çûs_by_fd
);

4058 
h
->
fds
 = 
	`»®loc
(h->fds, h->
nfds
 * (h->fds[0]));

4059 
	`mem£t
(
h
->
fds
, 0, h->
nfds
 * (h->fds[0]));

4061 
i
 = 0, 
k
 = 
h
->
nfds
, 
	`hashtb_¡¬t
(h->
çûs_by_fd
, 
e
);

4062 
i
 < 
k
 && 
e
->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

4063 
çû
 *çû = 
e
->
d©a
;

4064 ià(
çû
->
æags
 & 
CCN_FACE_MCAST
)

4065 
j
 = 
i
++;

4067 
j
 = --
k
;

4068 
h
->
fds
[
j
].
fd
 = 
çû
->
»cv_fd
;

4069 
h
->
fds
[
j
].
ev’ts
 = ((
çû
->
æags
 & 
CCN_FACE_NORECV
è=ğ0è? 
POLLIN
 : 0;

4070 ià((
çû
->
outbuf
 !ğ
NULL
 || (çû->
æags
 & 
CCN_FACE_CLOSING
) != 0))

4071 
h
->
fds
[
j
].
ev’ts
 |ğ
POLLOUT
;

4073 
	`hashtb_’d
(
e
);

4074 ià(
i
 < 
k
)

4075 
	`abÜt
();

4076 
	}
}

4082 
	$cúd_run
(
cúd_hªdË
 *
h
)

4084 
i
;

4085 
»s
;

4086 
timeout_ms
 = -1;

4087 
´ev_timeout_ms
 = -1;

4088 
u£c
;

4089 
h
->
ruÂšg
 = 1; h->running;) {

4090 
	`´oûss_š‹º®_ş›Á_bufãr
(
h
);

4091 
u£c
 = 
	`cú_scheduË_run
(
h
->
sched
);

4092 
timeout_ms
 = (
u£c
 < 0) ? -1 : ((usec + 960) / 1000);

4093 ià(
timeout_ms
 =ğ0 && 
´ev_timeout_ms
 == 0)

4094 
timeout_ms
 = 1;

4095 
	`´oûss_š‹º®_ş›Á_bufãr
(
h
);

4096 
	`´•¬e_pŞl_fds
(
h
);

4097 ià(0è
	`cúd_msg
(
h
, "© cúd.c:%d…Şl(h->fds, %d, %d)", 
__LINE__
, h->
nfds
, 
timeout_ms
);

4098 
»s
 = 
	`pŞl
(
h
->
fds
, h->
nfds
, 
timeout_ms
);

4099 
´ev_timeout_ms
 = ((
»s
 =ğ0è? 
timeout_ms
 : 1);

4100 ià(-1 =ğ
»s
) {

4101 
	`cúd_msg
(
h
, "pŞl: % Ó¼nØğ%d)", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

4102 
	`¦“p
(1);

4105 
i
 = 0; 
»s
 > 0 && i < 
h
->
nfds
; i++) {

4106 ià(
h
->
fds
[
i
].
»v’ts
 != 0) {

4107 
»s
--;

4108 ià(
h
->
fds
[
i
].
»v’ts
 & (
POLLERR
 | 
POLLNVAL
 | 
POLLHUP
)) {

4109 ià(
h
->
fds
[
i
].
»v’ts
 & (
POLLIN
))

4110 
	`´oûss_šput
(
h
, h->
fds
[
i
].
fd
);

4112 
	`shutdown_ş›Á_fd
(
h
, h->
fds
[
i
].
fd
);

4115 ià(
h
->
fds
[
i
].
»v’ts
 & (
POLLOUT
))

4116 
	`do_deã¼ed_wr™e
(
h
, h->
fds
[
i
].
fd
);

4117 ià(
h
->
fds
[
i
].
»v’ts
 & (
POLLIN
))

4118 
	`´oûss_šput
(
h
, h->
fds
[
i
].
fd
);

4122 
	}
}

4125 
	$cúd_»£ed
(
cúd_hªdË
 *
h
)

4127 
fd
;

4128 
ssize_t
 
»s
;

4130 
»s
 = -1;

4131 
fd
 = 
	`İ’
("/dev/u¿ndom", 
O_RDONLY
);

4132 ià(
fd
 != -1) {

4133 
»s
 = 
	`»ad
(
fd
, 
h
->
£ed
, (h->seed));

4134 
	`şo£
(
fd
);

4136 ià(
»s
 !ğ(
h
->
£ed
)) {

4137 
h
->
£ed
[1] = ()
	`g‘pid
();

4138 
h
->
£ed
[2] = ()
	`time
(
NULL
);

4144 
	`£ed48
(
h
->
£ed
);

4145 
	}
}

4148 
	$cúd_g‘_loÿl_sockÇme
()

4150 
sockaddr_un
 
§
;

4151 
	`cú_£tup_sockaddr_un
(
NULL
, &
§
);

4152 (
	`¡rdup
(
§
.
sun_·th
));

4153 
	}
}

4156 
	$cúd_g‘time
(cÚ¡ 
cú_g‘time
 *
£lf
, 
cú_timev®
 *
»suÉ
)

4158 
cúd_hªdË
 *
h
 = 
£lf
->
d©a
;

4159 
timev®
 
now
 = {0};

4160 
	`g‘timeofday
(&
now
, 0);

4161 
»suÉ
->
s
 = 
now
.
tv_£c
;

4162 
»suÉ
->
miüos
 = 
now
.
tv_u£c
;

4163 
h
->
£c
 = 
now
.
tv_£c
;

4164 
h
->
u£c
 = 
now
.
tv_u£c
;

4165 
	}
}

4168 
	$cúd_£tsockİt_v6Úly
(
cúd_hªdË
 *
h
, 
fd
)

4170 
yes
 = 1;

4171 
»s
 = 0;

4172 #ifdeà
IPV6_V6ONLY


4173 
»s
 = 
	`£tsockİt
(
fd
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
, &
yes
, (yes));

4175 ià(
»s
 == -1)

4176 
	`cúd_msg
(
h
, "warning - could‚ot set IPV6_V6ONLY on fd %d: %s",

4177 
fd
, 
	`¡»¼Ü
(
”ºo
));

4178 
	}
}

4181 
	$af_Çme
(
çmy
)

4183 
çmy
) {

4184 
AF_INET
:

4186 
AF_INET6
:

4191 
	}
}

4194 
	$cúd_li¡’_Ú_wdÿrds
(
cúd_hªdË
 *
h
)

4196 
fd
;

4197 
»s
;

4198 
whichpf
;

4199 
addršfo
 
hšts
 = {0};

4200 
addršfo
 *addršfØğ
NULL
;

4201 
addršfo
 *
a
;

4203 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

4204 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

4205 
whichpf
 = 0; whichpf < 2; whichpf++) {

4206 
hšts
.
ai_çmy
 = 
whichpf
 ? 
PF_INET6
 : 
PF_INET
;

4207 
»s
 = 
	`g‘addršfo
(
NULL
, 
h
->
pÜt¡r
, &
hšts
, &
addršfo
);

4208 ià(
»s
 == 0) {

4209 
a
 = 
addršfo
;‡ !ğ
NULL
;‡ =‡->
ai_Ãxt
) {

4210 
fd
 = 
	`sock‘
(
a
->
ai_çmy
, 
SOCK_DGRAM
, 0);

4211 ià(
fd
 != -1) {

4212 
çû
 *çû = 
NULL
;

4213 
yes
 = 1;

4214 
rcvbuf
 = 0;

4215 
sockËn_t
 
rcvbuf_sz
;

4216 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes));

4217 
rcvbuf_sz
 = (
rcvbuf
);

4218 
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
rcvbuf
, &
rcvbuf_sz
);

4219 ià(
a
->
ai_çmy
 =ğ
AF_INET6
)

4220 
	`cúd_£tsockİt_v6Úly
(
h
, 
fd
);

4221 
»s
 = 
	`bšd
(
fd
, 
a
->
ai_addr
,‡->
ai_add¾’
);

4222 ià(
»s
 != 0) {

4223 
	`şo£
(
fd
);

4226 
çû
 = 
	`»cÜd_cÚÃùiÚ
(
h
, 
fd
,

4227 
a
->
ai_addr
,‡->
ai_add¾’
,

4228 
CCN_FACE_DGRAM
 | 
CCN_FACE_PASSIVE
);

4229 ià(
çû
 =ğ
NULL
) {

4230 
	`şo£
(
fd
);

4233 ià(
a
->
ai_çmy
 =ğ
AF_INET
)

4234 
h
->
v4_çûid
 = 
çû
->
çûid
;

4236 
h
->
v6_çûid
 = 
çû
->
çûid
;

4237 
	`cúd_msg
(
h
, "accepting %s datagrams on fd %d„cvbuf %d",

4238 
	`af_Çme
(
a
->
ai_çmy
), 
fd
, 
rcvbuf
);

4241 
a
 = 
addršfo
;‡ !ğ
NULL
;‡ =‡->
ai_Ãxt
) {

4242 
fd
 = 
	`sock‘
(
a
->
ai_çmy
, 
SOCK_STREAM
, 0);

4243 ià(
fd
 != -1) {

4244 
yes
 = 1;

4245 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes));

4246 ià(
a
->
ai_çmy
 =ğ
AF_INET6
)

4247 
	`cúd_£tsockİt_v6Úly
(
h
, 
fd
);

4248 
»s
 = 
	`bšd
(
fd
, 
a
->
ai_addr
,‡->
ai_add¾’
);

4249 ià(
»s
 != 0) {

4250 
	`şo£
(
fd
);

4253 
»s
 = 
	`li¡’
(
fd
, 30);

4254 ià(
»s
 == -1) {

4255 
	`şo£
(
fd
);

4258 
	`»cÜd_cÚÃùiÚ
(
h
, 
fd
,

4259 
a
->
ai_addr
,‡->
ai_add¾’
,

4260 
CCN_FACE_PASSIVE
);

4261 
	`cúd_msg
(
h
, "accepting %s connections on fd %d",

4262 
	`af_Çme
(
a
->
ai_çmy
), 
fd
);

4265 
	`ä“addršfo
(
addršfo
);

4269 
	}
}

4272 
	$cúd_li¡’_Ú_add»ss
(
cúd_hªdË
 *
h
, cÚ¡ *
addr
)

4274 
fd
;

4275 
»s
;

4276 
addršfo
 
hšts
 = {0};

4277 
addršfo
 *addršfØğ
NULL
;

4278 
addršfo
 *
a
;

4279 
ok
 = 0;

4281 
	`cúd_msg
(
h
, "li¡’_Ú %s", 
addr
);

4282 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

4283 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

4284 
»s
 = 
	`g‘addršfo
(
addr
, 
h
->
pÜt¡r
, &
hšts
, &
addršfo
);

4285 ià(
»s
 == 0) {

4286 
a
 = 
addršfo
;‡ !ğ
NULL
;‡ =‡->
ai_Ãxt
) {

4287 
fd
 = 
	`sock‘
(
a
->
ai_çmy
, 
SOCK_DGRAM
, 0);

4288 ià(
fd
 != -1) {

4289 
çû
 *çû = 
NULL
;

4290 
yes
 = 1;

4291 
rcvbuf
 = 0;

4292 
sockËn_t
 
rcvbuf_sz
;

4293 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes));

4294 
rcvbuf_sz
 = (
rcvbuf
);

4295 
	`g‘sockİt
(
fd
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
rcvbuf
, &
rcvbuf_sz
);

4296 ià(
a
->
ai_çmy
 =ğ
AF_INET6
)

4297 
	`cúd_£tsockİt_v6Úly
(
h
, 
fd
);

4298 
»s
 = 
	`bšd
(
fd
, 
a
->
ai_addr
,‡->
ai_add¾’
);

4299 ià(
»s
 != 0) {

4300 
	`şo£
(
fd
);

4303 
çû
 = 
	`»cÜd_cÚÃùiÚ
(
h
, 
fd
,

4304 
a
->
ai_addr
,‡->
ai_add¾’
,

4305 
CCN_FACE_DGRAM
 | 
CCN_FACE_PASSIVE
);

4306 ià(
çû
 =ğ
NULL
) {

4307 
	`şo£
(
fd
);

4310 ià(
a
->
ai_çmy
 =ğ
AF_INET
)

4311 
h
->
v4_çûid
 = 
çû
->
çûid
;

4313 
h
->
v6_çûid
 = 
çû
->
çûid
;

4314 
	`cúd_msg
(
h
, "accepting %s datagrams on fd %d„cvbuf %d",

4315 
	`af_Çme
(
a
->
ai_çmy
), 
fd
, 
rcvbuf
);

4316 
ok
++;

4319 
a
 = 
addršfo
;‡ !ğ
NULL
;‡ =‡->
ai_Ãxt
) {

4320 
fd
 = 
	`sock‘
(
a
->
ai_çmy
, 
SOCK_STREAM
, 0);

4321 ià(
fd
 != -1) {

4322 
yes
 = 1;

4323 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
yes
, (yes));

4324 ià(
a
->
ai_çmy
 =ğ
AF_INET6
)

4325 
	`cúd_£tsockİt_v6Úly
(
h
, 
fd
);

4326 
»s
 = 
	`bšd
(
fd
, 
a
->
ai_addr
,‡->
ai_add¾’
);

4327 ià(
»s
 != 0) {

4328 
	`şo£
(
fd
);

4331 
»s
 = 
	`li¡’
(
fd
, 30);

4332 ià(
»s
 == -1) {

4333 
	`şo£
(
fd
);

4336 
	`»cÜd_cÚÃùiÚ
(
h
, 
fd
,

4337 
a
->
ai_addr
,‡->
ai_add¾’
,

4338 
CCN_FACE_PASSIVE
);

4339 
	`cúd_msg
(
h
, "accepting %s connections on fd %d",

4340 
	`af_Çme
(
a
->
ai_çmy
), 
fd
);

4341 
ok
++;

4344 
	`ä“addršfo
(
addršfo
);

4346 (
ok
 > 0 ? 0 : -1);

4347 
	}
}

4350 
	$cúd_li¡’_Ú
(
cúd_hªdË
 *
h
, cÚ¡ *
addrs
)

4352 
ch
;

4353 
dlm
;

4354 
»s
 = 0;

4355 
i
;

4356 
cú_ch¬buf
 *
addr
 = 
NULL
;

4358 ià(
addrs
 =ğ
NULL
 || !*addr || 0 =ğ
	`¡rcmp
(addrs, "*"))

4359 (
	`cúd_li¡’_Ú_wdÿrds
(
h
));

4360 
addr
 = 
	`cú_ch¬buf_ü—‹
();

4361 
i
 = 0, 
ch
 = 
addrs
[i];‡ddrs[i] != 0;) {

4362 
addr
->
Ëngth
 = 0;

4363 
dlm
 = 0;

4364 ià(
ch
 == '[') {

4365 
dlm
 = ']';

4366 
ch
 = 
addrs
[++
i
];

4368 ; 
ch
 > ' ' && ch !ğ',' && ch !ğ';' && ch !ğ
dlm
; ch = 
addrs
[++
i
])

4369 
	`cú_ch¬buf_­³nd_v®ue
(
addr
, 
ch
, 1);

4370 ià(
ch
 && ch =ğ
dlm
)

4371 
ch
 = 
addrs
[++
i
];

4372 ià(
addr
->
Ëngth
 > 0) {

4373 
»s
 |ğ
	`cúd_li¡’_Ú_add»ss
(
h
, 
	`cú_ch¬buf_as_¡ršg
(
addr
));

4375 (0 < 
ch
 && ch <= ' ') || ch == ',' || ch == ';')

4376 
ch
 = 
addrs
[++
i
];

4378 
	`cú_ch¬buf_de¡roy
(&
addr
);

4379 (
»s
);

4380 
	}
}

4382 
cú_ch¬buf
 *

4383 
	$cúd_·r£_uri_li¡
(
cúd_hªdË
 *
h
, cÚ¡ *
wh©
, cÚ¡ *
uris
)

4385 
cú_ch¬buf
 *
ªs
;

4386 
cú_ch¬buf
 *
Çme
;

4387 
i
;

4388 
size_t
 
j
;

4389 
»s
;

4390 
ch
;

4391 cÚ¡ *
uri
;

4393 ià(
uris
 =ğ
NULL
)

4394 (
NULL
);

4395 
ªs
 = 
	`cú_ch¬buf_ü—‹
();

4396 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

4397 
i
 = 0, 
ch
 = 
uris
[0]; ch != 0;) {

4398 (0 < 
ch
 && ch <= ' ') || ch == ',' || ch == ';')

4399 
ch
 = 
uris
[++
i
];

4400 
j
 = 
ªs
->
Ëngth
;

4401 
ch
 > ' ' && ch != ',' && ch != ';') {

4402 
	`cú_ch¬buf_­³nd_v®ue
(
ªs
, 
ch
, 1);

4403 
ch
 = 
uris
[++
i
];

4405 ià(
j
 < 
ªs
->
Ëngth
) {

4406 
	`cú_ch¬buf_­³nd_v®ue
(
ªs
, 0, 1);

4407 
uri
 = (cÚ¡ *)
ªs
->
buf
 + 
j
;

4408 
Çme
->
Ëngth
 = 0;

4409 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
uri
);

4410 ià(
»s
 < 0) {

4411 
	`cúd_msg
(
h
, "%s: inv®id cúx URI: %s", 
wh©
, 
uri
);

4412 
ªs
->
Ëngth
 = 
j
;

4416 
	`cú_ch¬buf_de¡roy
(&
Çme
);

4417 ià(
ªs
->
Ëngth
 == 0)

4418 
	`cú_ch¬buf_de¡roy
(&
ªs
);

4419 (
ªs
);

4420 
	}
}

4428 
cúd_hªdË
 *

4429 
	$cúd_ü—‹
(cÚ¡ *
´ogÇme
, 
cúd_logg”
 
logg”
, *
logg”d©a
)

4431 *
sockÇme
;

4432 cÚ¡ *
pÜt¡r
;

4433 cÚ¡ *
debug¡r
;

4434 cÚ¡ *
’Œylim™
;

4435 cÚ¡ *
mtu
;

4436 cÚ¡ *
d©a_·u£
;

4437 cÚ¡ *
autÜeg
;

4438 cÚ¡ *
li¡’_Ú
;

4439 
fd
;

4440 
cúd_hªdË
 *
h
;

4441 
hashtb_·¿m
 
·¿m
 = {0};

4443 
sockÇme
 = 
	`cúd_g‘_loÿl_sockÇme
();

4444 
h
 = 
	`ÿÎoc
(1, (*h));

4445 ià(
h
 =ğ
NULL
)

4446 (
h
);

4447 
h
->
logg”
 =†ogger;

4448 
h
->
logg”d©a
 =†oggerdata;

4449 
h
->
­²Úû
 = &
cúd_­³nd_¶aš_nÚû
;

4450 
h
->
logpid
 = ()
	`g‘pid
();

4451 
h
->
´ogÇme
 =…rogname;

4452 
h
->
debug
 = -1;

4453 
h
->
sklšks
 = 
	`cú_šdexbuf_ü—‹
();

4454 
·¿m
.
fš®ize_d©a
 = 
h
;

4455 
h
->
çû_lim™
 = 1024;

4456 
h
->
çûs_by_çûid
 = 
	`ÿÎoc
(h->
çû_lim™
, (h->faces_by_faceid[0]));

4457 
·¿m
.
fš®ize
 = &
fš®ize_çû
;

4458 
h
->
çûs_by_fd
 = 
	`hashtb_ü—‹
((
çû
), &
·¿m
);

4459 
h
->
dg¿m_çûs
 = 
	`hashtb_ü—‹
((
çû
), &
·¿m
);

4460 
·¿m
.
fš®ize
 = &
fš®ize_cÚ‹Á
;

4461 
h
->
cÚ‹Á_b
 = 
	`hashtb_ü—‹
((
cÚ‹Á_’Œy
), &
·¿m
);

4462 
·¿m
.
fš®ize
 = &
fš®ize_Çm•»fix
;

4463 
h
->
Çm•»fix_b
 = 
	`hashtb_ü—‹
((
Çm•»fix_’Œy
), &
·¿m
);

4464 
·¿m
.
fš®ize
 = &
fš®ize_´İag©šg
;

4465 
h
->
´İag©šg_b
 = 
	`hashtb_ü—‹
((
´İag©šg_’Œy
), &
·¿m
);

4466 
·¿m
.
fš®ize
 = 0;

4467 
h
->
¥¬£_¡¿ggËr_b
 = 
	`hashtb_ü—‹
((
¥¬£_¡¿ggËr_’Œy
), 
NULL
);

4468 
h
->
mš_¡®e
 = ~0;

4469 
h
->
max_¡®e
 = 0;

4470 
h
->
unsŞ
 = 
	`cú_šdexbuf_ü—‹
();

4471 
h
->
ticktock
.
desü
[0] = 'C';

4472 
h
->
ticktock
.
miüos_³r_ba£
 = 1000000;

4473 
h
->
ticktock
.
g‘time
 = &
cúd_g‘time
;

4474 
h
->
ticktock
.
d©a
 = h;

4475 
h
->
sched
 = 
	`cú_scheduË_ü—‹
(h, &h->
ticktock
);

4476 
h
->
ŞdfÜm©cÚ‹ÁgrumbË
 = 1;

4477 
h
->
ŞdfÜm©š‹»¡grumbË
 = 1;

4478 
h
->
d©a_·u£_miüo£c
 = 10000;

4479 
debug¡r
 = 
	`g‘’v
("CCND_DEBUG");

4480 ià(
debug¡r
 !ğ
NULL
 && debugstr[0] != 0) {

4481 
h
->
debug
 = 
	`©oi
(
debug¡r
);

4482 ià(
h
->
debug
 =ğ0 && 
debug¡r
[0] != '0')

4483 
h
->
debug
 = 1;

4486 
h
->
debug
 = 1;

4487 
pÜt¡r
 = 
	`g‘’v
(
CCN_LOCAL_PORT_ENVNAME
);

4488 ià(
pÜt¡r
 =ğ
NULL
 ||…Üt¡r[0] =ğ0 || 
	`¡¾’
(portstr) > 10)

4489 
pÜt¡r
 = 
CCN_DEFAULT_UNICAST_PORT
;

4490 
h
->
pÜt¡r
 =…ortstr;

4491 
’Œylim™
 = 
	`g‘’v
("CCND_CAP");

4492 
h
->
ÿ·c™y
 = ~0;

4493 ià(
’Œylim™
 !ğ
NULL
 &&ƒntrylimit[0] != 0) {

4494 
h
->
ÿ·c™y
 = 
	`©Ş
(
’Œylim™
);

4495 ià(
h
->
ÿ·c™y
 == 0)

4496 
h
->
fÜû_z”o_äeshÃss
 = 1;

4497 ià(
h
->
ÿ·c™y
 <= 0)

4498 
h
->
ÿ·c™y
 = 10;

4500 
h
->
mtu
 = 0;

4501 
mtu
 = 
	`g‘’v
("CCND_MTU");

4502 ià(
mtu
 !ğ
NULL
 && mtu[0] != 0) {

4503 
h
->
mtu
 = 
	`©Ş
(mtu);

4504 ià(
h
->
mtu
 < 0)

4505 
h
->
mtu
 = 0;

4506 ià(
h
->
mtu
 > 8800)

4507 
h
->
mtu
 = 8800;

4509 
d©a_·u£
 = 
	`g‘’v
("CCND_DATA_PAUSE_MICROSEC");

4510 ià(
d©a_·u£
 !ğ
NULL
 && data_pause[0] != 0) {

4511 
h
->
d©a_·u£_miüo£c
 = 
	`©Ş
(
d©a_·u£
);

4512 ià(
h
->
d©a_·u£_miüo£c
 == 0)

4513 
h
->
d©a_·u£_miüo£c
 = 1;

4514 ià(
h
->
d©a_·u£_miüo£c
 > 1000000)

4515 
h
->
d©a_·u£_miüo£c
 = 1000000;

4517 
li¡’_Ú
 = 
	`g‘’v
("CCND_LISTEN_ON");

4518 
autÜeg
 = 
	`g‘’v
("CCND_AUTOREG");

4519 
	`cúd_msg
(
h
, "CCND_DEBUG=%d CCND_CAP=%lu", h->
debug
, h->
ÿ·c™y
);

4520 ià(
autÜeg
 !ğ
NULL
 &&‡utoreg[0] != 0) {

4521 
h
->
autÜeg
 = 
	`cúd_·r£_uri_li¡
(h, "CCND_AUTOREG",‡utoreg);

4522 ià(
h
->
autÜeg
 !ğ
NULL
)

4523 
	`cúd_msg
(
h
, "CCND_AUTOREG=%s", 
autÜeg
);

4525 ià(
li¡’_Ú
 !ğ
NULL
 &&†isten_on[0] != 0)

4526 
	`cúd_msg
(
h
, "CCND_LISTEN_ON=%s", 
li¡’_Ú
);

4528 
h
->
­²Úû
 = &
cúd_­³nd_debug_nÚû
;

4530 
	`cúd_š™_š‹º®_key¡Üe
(
h
);

4531 
	`cúd_»£ed
(
h
);

4532 ià(
h
->
çû0
 =ğ
NULL
) {

4533 
çû
 *face;

4534 
çû
 = 
	`ÿÎoc
(1, (*face));

4535 
çû
->
»cv_fd
 = -1;

4536 
çû
->
£ndçû
 = 0;

4537 
çû
->
æags
 = (
CCN_FACE_GG
 | 
CCN_FACE_LOCAL
);

4538 
h
->
çû0
 = 
çû
;

4540 
	`’rŞl_çû
(
h
, h->
çû0
);

4541 
fd
 = 
	`ü—‹_loÿl_li¡’”
(
h
, 
sockÇme
, 42);

4542 ià(
fd
 == -1)

4543 
	`cúd_msg
(
h
, "%s: %s", 
sockÇme
, 
	`¡»¼Ü
(
”ºo
));

4545 
	`cúd_msg
(
h
, "li¡’šg oÀ%s", 
sockÇme
);

4546 
h
->
æood
 = (h->
autÜeg
 !ğ
NULL
);

4547 
h
->
v4_çûid
 = h->
v6_çûid
 = 
CCN_NOFACEID
;

4548 
	`cúd_li¡’_Ú
(
h
, 
li¡’_Ú
);

4549 
	`ş—n_Ãeded
(
h
);

4550 
	`age_fÜw¬dšg_Ãeded
(
h
);

4551 
	`cúd_š‹º®_ş›Á_¡¬t
(
h
);

4552 
	`ä“
(
sockÇme
);

4553 
sockÇme
 = 
NULL
;

4554 (
h
);

4555 
	}
}

4561 
	$cúd_shutdown_li¡’”s
(
cúd_hªdË
 *
h
)

4563 
hashtb_’um”©Ü
 
“
;

4564 
hashtb_’um”©Ü
 *
e
 = &
“
;

4565 
	`hashtb_¡¬t
(
h
->
çûs_by_fd
, 
e
);ƒ->
d©a
 !ğ
NULL
;) {

4566 
çû
 *çû = 
e
->
d©a
;

4567 ià((
çû
->
æags
 & (
CCN_FACE_MCAST
 | 
CCN_FACE_PASSIVE
)) != 0)

4568 
	`hashtb_d–‘e
(
e
);

4570 
	`hashtb_Ãxt
(
e
);

4572 
	`hashtb_’d
(
e
);

4573 
	}
}

4579 
	$cúd_de¡roy
(
cúd_hªdË
 **
pcúd
)

4581 
cúd_hªdË
 *
h
 = *
pcúd
;

4582 ià(
h
 =ğ
NULL
)

4584 
	`cúd_shutdown_li¡’”s
(
h
);

4585 
	`cúd_š‹º®_ş›Á_¡İ
(
h
);

4586 
	`cú_scheduË_de¡roy
(&
h
->
sched
);

4587 
	`hashtb_de¡roy
(&
h
->
dg¿m_çûs
);

4588 
	`hashtb_de¡roy
(&
h
->
çûs_by_fd
);

4589 
	`hashtb_de¡roy
(&
h
->
cÚ‹Á_b
);

4590 
	`hashtb_de¡roy
(&
h
->
´İag©šg_b
);

4591 
	`hashtb_de¡roy
(&
h
->
Çm•»fix_b
);

4592 
	`hashtb_de¡roy
(&
h
->
¥¬£_¡¿ggËr_b
);

4593 ià(
h
->
fds
 !ğ
NULL
) {

4594 
	`ä“
(
h
->
fds
);

4595 
h
->
fds
 = 
NULL
;

4596 
h
->
nfds
 = 0;

4598 ià(
h
->
çûs_by_çûid
 !ğ
NULL
) {

4599 
	`ä“
(
h
->
çûs_by_çûid
);

4600 
h
->
çûs_by_çûid
 = 
NULL
;

4601 
h
->
çû_lim™
 = h->
çû_g’
 = 0;

4603 ià(
h
->
cÚ‹Á_by_acûssiÚ
 !ğ
NULL
) {

4604 
	`ä“
(
h
->
cÚ‹Á_by_acûssiÚ
);

4605 
h
->
cÚ‹Á_by_acûssiÚ
 = 
NULL
;

4606 
h
->
cÚ‹Á_by_acûssiÚ_wšdow
 = 0;

4608 
	`cú_ch¬buf_de¡roy
(&
h
->
sü©ch_ch¬buf
);

4609 
	`cú_ch¬buf_de¡roy
(&
h
->
autÜeg
);

4610 
	`cú_šdexbuf_de¡roy
(&
h
->
sklšks
);

4611 
	`cú_šdexbuf_de¡roy
(&
h
->
sü©ch_šdexbuf
);

4612 
	`cú_šdexbuf_de¡roy
(&
h
->
unsŞ
);

4613 ià(
h
->
çû0
 !ğ
NULL
) {

4614 
	`cú_ch¬buf_de¡roy
(&
h
->
çû0
->
šbuf
);

4615 
	`cú_ch¬buf_de¡roy
(&
h
->
çû0
->
outbuf
);

4616 
	`ä“
(
h
->
çû0
);

4617 
h
->
çû0
 = 
NULL
;

4619 
	`ä“
(
h
);

4620 *
pcúd
 = 
NULL
;

4621 
	}
}

	@ccnd/ccnd_internal_client.c

24 
	~<”ºo.h
>

25 
	~<¡dšt.h
>

26 
	~<¡dlib.h
>

27 
	~<¡dio.h
>

28 
	~<¡ršg.h
>

29 
	~<sys/”ºo.h
>

30 
	~<sys/¡©.h
>

31 
	~<sys/ty³s.h
>

32 
	~<uni¡d.h
>

33 
	~<cú/cú.h
>

34 
	~<cú/ch¬buf.h
>

35 
	~<cú/cú_´iv©e.h
>

36 
	~<cú/scheduË.h
>

37 
	~<cú/sockaddrut.h
>

38 
	~<cú/uri.h
>

39 
	~"cúd_´iv©e.h
"

42 
	#GOT_HERE
 
	`cúd_msg
(
cúd
, "© cúd_š‹º®_ş›Á.c:%d", 
__LINE__
);

	)

44 
	#GOT_HERE


	)

46 
	#CCND_NOTICE_NAME
 "nÙiû.txt"

	)

48 #iâdeà
CCND_TEST_100137


49 
	#CCND_TEST_100137
 0

	)

52 
cúd_¡¬t_nÙiû
(
cúd_hªdË
 *
cúd
);

53 
cúd_š‹º®_ş›Á_»scheduË
(
cúd_hªdË
 *
cúd
);

56 
	$cúd_š™_£rviû_cúb
(
cúd_hªdË
 *
cúd
)

58 cÚ¡ *
ba£uri
 = "ccnx:/%C1.M.S.localhost/%C1.M.SRV/ccnd/KEY";

59 
cú_signšg_·¿ms
 
¥
 = 
CCN_SIGNING_PARAMS_INIT
;

60 
cú
 *
h
 = 
cúd
->
š‹º®_ş›Á
;

61 
cú_ch¬buf
 *
Çme
 = 
	`cú_ch¬buf_ü—‹
();

62 
cú_ch¬buf
 *
pubid
 = 
	`cú_ch¬buf_ü—‹
();

63 
cú_ch¬buf
 *
pubkey
 = 
	`cú_ch¬buf_ü—‹
();

64 
cú_ch¬buf
 *
keyid
 = 
	`cú_ch¬buf_ü—‹
();

65 
cú_ch¬buf
 *
cob
 = 
	`cú_ch¬buf_ü—‹
();

66 
»s
;

68 
»s
 = 
	`cú_g‘_public_key
(
h
, 
NULL
, 
pubid
, 
pubkey
);

69 ià(
»s
 < 0è
	`abÜt
();

70 
	`cú_Çme_äom_uri
(
Çme
, 
ba£uri
);

71 
	`cú_ch¬buf_­³nd_v®ue
(
keyid
, 
CCN_MARKER_CONTROL
, 1);

72 
	`cú_ch¬buf_­³nd_¡ršg
(
keyid
, ".M.K");

73 
	`cú_ch¬buf_­³nd_v®ue
(
keyid
, 0, 1);

74 
	`cú_ch¬buf_­³nd_ch¬buf
(
keyid
, 
pubid
);

75 
	`cú_Çme_­³nd
(
Çme
, 
keyid
->
buf
, keyid->
Ëngth
);

76 
	`cú_ü—‹_v”siÚ
(
h
, 
Çme
, 
CCN_V_NOW
, 0, 0);

77 
¥
.
‹m¶©e_cúb
 = 
	`cú_ch¬buf_ü—‹
();

78 
	`cú_ch¬buf_­³nd_‰
(
¥
.
‹m¶©e_cúb
, 
CCN_DTAG_SigÃdInfo
, 
CCN_DTAG
);

79 
	`cú_ch¬buf_­³nd_‰
(
¥
.
‹m¶©e_cúb
, 
CCN_DTAG_KeyLoÿtÜ
, 
CCN_DTAG
);

80 
	`cú_ch¬buf_­³nd_‰
(
¥
.
‹m¶©e_cúb
, 
CCN_DTAG_KeyName
, 
CCN_DTAG
);

81 
	`cú_ch¬buf_­³nd_ch¬buf
(
¥
.
‹m¶©e_cúb
, 
Çme
);

82 
	`cú_ch¬buf_­³nd_şo£r
(
¥
.
‹m¶©e_cúb
);

87 
	`cú_ch¬buf_­³nd_şo£r
(
¥
.
‹m¶©e_cúb
);

88 
	`cú_ch¬buf_­³nd_şo£r
(
¥
.
‹m¶©e_cúb
);

89 
¥
.
¥_æags
 |ğ
CCN_SP_TEMPL_KEY_LOCATOR
;

90 
	`cú_Çme_äom_uri
(
Çme
, "%00");

91 
¥
.
¥_æags
 |ğ
CCN_SP_FINAL_BLOCK
;

92 
¥
.
ty³
 = 
CCN_CONTENT_KEY
;

93 
¥
.
äeshÃss
 = 300;

94 
»s
 = 
	`cú_sign_cÚ‹Á
(
h
, 
cob
, 
Çme
, &
¥
, 
pubkey
->
buf
,…ubkey->
Ëngth
);

95 ià(
»s
 !ğ0è
	`abÜt
();

96 
cúd
->
£rviû_cúb
 = 
cob
;

97 
	`cú_ch¬buf_de¡roy
(&
Çme
);

98 
	`cú_ch¬buf_de¡roy
(&
pubid
);

99 
	`cú_ch¬buf_de¡roy
(&
pubkey
);

100 
	`cú_ch¬buf_de¡roy
(&
keyid
);

101 
	`cú_ch¬buf_de¡roy
(&
¥
.
‹m¶©e_cúb
);

102 
	}
}

107 
	#MORECOMPS_MASK
 0x007F

	)

108 
	#MUST_VERIFY
 0x0080

	)

109 
	#MUST_VERIFY1
 (
MUST_VERIFY
 + 1)

	)

110 
	#OPER_MASK
 0xFF00

	)

111 
	#OP_PING
 0x0000

	)

112 
	#OP_NEWFACE
 0x0200

	)

113 
	#OP_DESTROYFACE
 0x0300

	)

114 
	#OP_PREFIXREG
 0x0400

	)

115 
	#OP_SELFREG
 0x0500

	)

116 
	#OP_UNREG
 0x0600

	)

117 
	#OP_NOTICE
 0x0700

	)

118 
	#OP_SERVICE
 0x0800

	)

122 
cú_upÿÎ_»s


123 
	$cúd_ªsw”_»q
(
cú_şosu»
 *
£lå
,

124 
cú_upÿÎ_kšd
 
kšd
,

125 
cú_upÿÎ_šfo
 *
šfo
)

127 
cú_ch¬buf
 *
msg
 = 
NULL
;

128 
cú_ch¬buf
 *
Çme
 = 
NULL
;

129 
cú_ch¬buf
 *
keyloÿtÜ
 = 
NULL
;

130 
cú_ch¬buf
 *
sigÃd_šfo
 = 
NULL
;

131 
cú_ch¬buf
 *
»¶y_body
 = 
NULL
;

132 
cúd_hªdË
 *
cúd
 = 
NULL
;

133 
»s
 = 0;

134 
¡¬t
 = 0;

135 
’d
 = 0;

136 
mÜecomps
 = 0;

137 cÚ¡ *
fš®_comp
 = 
NULL
;

138 
size_t
 
fš®_size
 = 0;

139 
cú_signšg_·¿ms
 
¥
 = 
CCN_SIGNING_PARAMS_INIT
;

141 
kšd
) {

142 
CCN_UPCALL_FINAL
:

143 
	`ä“
(
£lå
);

144 (
CCN_UPCALL_RESULT_OK
);

145 
CCN_UPCALL_INTEREST
:

147 
CCN_UPCALL_CONSUMED_INTEREST
:

148 (
CCN_UPCALL_RESULT_OK
);

150 (
CCN_UPCALL_RESULT_ERR
);

152 
cúd
 = (
cúd_hªdË
 *)
£lå
->
d©a
;

153 ià((
cúd
->
debug
 & 128) != 0)

154 
	`cúd_debug_cúb
(
cúd
, 
__LINE__
, "cúd_ªsw”_»q", 
NULL
,

155 
šfo
->
š‹»¡_cúb
, info->
pi
->
off£t
[
CCN_PI_E
]);

156 
mÜecomps
 = 
£lå
->
štd©a
 & 
MORECOMPS_MASK
;

157 ià(
£lå
->
štd©a
 !ğ
OP_SERVICE
 &&

158 (
šfo
->
pi
->
ªsw”äom
 & 
CCN_AOK_NEW
) == 0)

159 (
CCN_UPCALL_RESULT_OK
);

160 ià(
šfo
->
m©ched_comps
 >ğšfo->
š‹»¡_comps
->
n
)

161 
Ba
;

162 ià(
£lå
->
štd©a
 !ğ
OP_PING
 &&

163 
£lå
->
štd©a
 !ğ
OP_NOTICE
 &&

164 
£lå
->
štd©a
 !ğ
OP_SERVICE
 &&

165 
šfo
->
pi
->
´efix_comps
 !ğšfo->
m©ched_comps
 + 
mÜecomps
)

166 
Ba
;

167 ià(
mÜecomps
 == 1) {

168 
»s
 = 
	`cú_Çme_comp_g‘
(
šfo
->
š‹»¡_cúb
, info->
š‹»¡_comps
,

169 
šfo
->
m©ched_comps
,

170 &
fš®_comp
, &
fš®_size
);

171 ià(
»s
 < 0)

172 
Ba
;

174 
GOT_HERE


175 ià((
£lå
->
štd©a
 & 
MUST_VERIFY
) != 0) {

176 
cú_·r£d_CÚ‹ÁObjeù
 
pco
 = {0};

178 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
fš®_comp
, 
fš®_size
, &
pco
, 
NULL
);

179 ià(
»s
 < 0) {

180 
	`cúd_debug_cúb
(
cúd
, 
__LINE__
, "co_·r£_çed", 
NULL
,

181 
šfo
->
š‹»¡_cúb
, info->
pi
->
off£t
[
CCN_PI_E
]);

182 
Ba
;

184 
»s
 = 
	`cú_v”ify_cÚ‹Á
(
šfo
->
h
, 
fš®_comp
, &
pco
);

185 ià(
»s
 != 0) {

186 
	`cúd_debug_cúb
(
cúd
, 
__LINE__
, "co_v”ify_çed", 
NULL
,

187 
šfo
->
š‹»¡_cúb
, info->
pi
->
off£t
[
CCN_PI_E
]);

188 
Ba
;

191 
¥
.
äeshÃss
 = 10;

192 
£lå
->
štd©a
 & 
OPER_MASK
) {

193 
OP_PING
:

194 
»¶y_body
 = 
	`cú_ch¬buf_ü—‹
();

195 
¥
.
äeshÃss
 = (
šfo
->
pi
->
´efix_comps
 =ğšfo->
m©ched_comps
) ? 60 : 5;

197 
OP_NEWFACE
:

198 
»¶y_body
 = 
	`cúd_»q_Ãwçû
(
cúd
, 
fš®_comp
, 
fš®_size
);

200 
OP_DESTROYFACE
:

201 
»¶y_body
 = 
	`cúd_»q_de¡royçû
(
cúd
, 
fš®_comp
, 
fš®_size
);

203 
OP_PREFIXREG
:

204 
»¶y_body
 = 
	`cúd_»q_´efix»g
(
cúd
, 
fš®_comp
, 
fš®_size
);

206 
OP_SELFREG
:

207 
»¶y_body
 = 
	`cúd_»q_£läeg
(
cúd
, 
fš®_comp
, 
fš®_size
);

209 
OP_UNREG
:

210 
»¶y_body
 = 
	`cúd_»q_uÄeg
(
cúd
, 
fš®_comp
, 
fš®_size
);

212 
OP_NOTICE
:

213 
	`cúd_¡¬t_nÙiû
(
cúd
);

214 
Ba
;

216 
OP_SERVICE
:

217 ià(
cúd
->
£rviû_cúb
 =ğ
NULL
)

218 
	`cúd_š™_£rviû_cúb
(
cúd
);

219 ià(
	`cú_cÚ‹Á_m©ches_š‹»¡
(

220 
cúd
->
£rviû_cúb
->
buf
,

221 
cúd
->
£rviû_cúb
->
Ëngth
,

223 
NULL
,

224 
šfo
->
š‹»¡_cúb
,

225 
šfo
->
pi
->
off£t
[
CCN_PI_E
],

226 
šfo
->
pi


228 
	`cú_put
(
šfo
->
h
, 
cúd
->
£rviû_cúb
->
buf
,

229 
cúd
->
£rviû_cúb
->
Ëngth
);

230 
»s
 = 
CCN_UPCALL_RESULT_INTEREST_CONSUMED
;

231 
Fšish
;

233 
Ba
;

236 
Ba
;

238 ià(
»¶y_body
 =ğ
NULL
)

239 
Ba
;

241 
msg
 = 
	`cú_ch¬buf_ü—‹
();

242 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

243 
¡¬t
 = 
šfo
->
pi
->
off£t
[
CCN_PI_B_Name
];

244 
’d
 = 
šfo
->
š‹»¡_comps
->
buf
[šfo->
pi
->
´efix_comps
];

245 
	`cú_ch¬buf_­³nd
(
Çme
, 
šfo
->
š‹»¡_cúb
 + 
¡¬t
, 
’d
 - start);

246 
	`cú_ch¬buf_­³nd_şo£r
(
Çme
);

247 
»s
 = 
	`cú_sign_cÚ‹Á
(
šfo
->
h
, 
msg
, 
Çme
, &
¥
,

248 
»¶y_body
->
buf
,„•ly_body->
Ëngth
);

249 ià(
»s
 < 0)

250 
Ba
;

251 ià((
cúd
->
debug
 & 128) != 0)

252 
	`cúd_debug_cúb
(
cúd
, 
__LINE__
, "cúd_ªsw”_»q_»¥Ú£", 
NULL
,

253 
msg
->
buf
, msg->
Ëngth
);

254 
»s
 = 
	`cú_put
(
šfo
->
h
, 
msg
->
buf
, msg->
Ëngth
);

255 ià(
»s
 < 0)

256 
Ba
;

257 ià(
CCND_TEST_100137
)

258 
	`cú_put
(
šfo
->
h
, 
msg
->
buf
, msg->
Ëngth
);

259 
»s
 = 
CCN_UPCALL_RESULT_INTEREST_CONSUMED
;

260 
Fšish
;

261 
Ba
:

262 
»s
 = 
CCN_UPCALL_RESULT_ERR
;

263 
Fšish
:

264 
	`cú_ch¬buf_de¡roy
(&
msg
);

265 
	`cú_ch¬buf_de¡roy
(&
Çme
);

266 
	`cú_ch¬buf_de¡roy
(&
keyloÿtÜ
);

267 
	`cú_ch¬buf_de¡roy
(&
»¶y_body
);

268 
	`cú_ch¬buf_de¡roy
(&
sigÃd_šfo
);

269 (
»s
);

270 
	}
}

273 
	$cúd_š‹º®_ş›Á_»äesh
(
cú_scheduË
 *
sched
,

274 *
ş›Áh
,

275 
cú_scheduËd_ev’t
 *
ev
,

276 
æags
)

278 
cúd_hªdË
 *
cúd
 = 
ş›Áh
;

279 
miüo£c
 = 0;

280 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) == 0 &&

281 
cúd
->
š‹º®_ş›Á
 !ğ
NULL
 &&

282 
cúd
->
š‹º®_ş›Á_»äesh
 =ğ
ev
) {

283 
miüo£c
 = 
	`cú_´oûss_scheduËd_İ”©iÚs
(
cúd
->
š‹º®_ş›Á
);

284 ià(
miüo£c
 > 
ev
->
evšt
)

285 
miüo£c
 = 
ev
->
evšt
;

287 ià(
miüo£c
 <ğ0 && 
cúd
->
š‹º®_ş›Á_»äesh
 =ğ
ev
)

288 
cúd
->
š‹º®_ş›Á_»äesh
 = 
NULL
;

289 (
miüo£c
);

290 
	}
}

292 
	#CCND_ID_TEMPL
 "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"

	)

295 
	$cúd_uri_li¡’
(
cúd_hªdË
 *
cúd
, cÚ¡ *
uri
,

296 
cú_hªdËr
 
p
, 
šŒ_t
 
štd©a
)

298 
cú_ch¬buf
 *
Çme
;

299 
cú_ch¬buf
 *
uri_modif›d
 = 
NULL
;

300 
cú_şosu»
 *
şosu»
;

301 
cú_šdexbuf
 *
comps
;

302 cÚ¡ *
comp
;

303 
size_t
 
comp_size
;

304 
size_t
 
off£t
;

305 
»g_wª‹d
 = 1;

307 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

308 
	`cú_Çme_äom_uri
(
Çme
, 
uri
);

309 
comps
 = 
	`cú_šdexbuf_ü—‹
();

310 ià(
	`cú_Çme_¥l™
(
Çme
, 
comps
) < 0)

311 
	`abÜt
();

312 ià(
	`cú_Çme_comp_g‘
(
Çme
->
buf
, 
comps
, 1, &
comp
, &
comp_size
) >= 0) {

313 ià(
comp_size
 =ğ32 && 0 =ğ
	`memcmp
(
comp
, 
CCND_ID_TEMPL
, 32)) {

315 
off£t
 = 
comp
 - 
Çme
->
buf
;

316 
	`memıy
(
Çme
->
buf
 + 
off£t
, 
cúd
->
cúd_id
, 32);

317 
uri_modif›d
 = 
	`cú_ch¬buf_ü—‹
();

318 
	`cú_uri_­³nd
(
uri_modif›d
, 
Çme
->
buf
,‚ame->
Ëngth
, 1);

319 
uri
 = (*)
uri_modif›d
->
buf
;

320 
»g_wª‹d
 = 0;

323 
şosu»
 = 
	`ÿÎoc
(1, (*closure));

324 
şosu»
->
p
 =…;

325 
şosu»
->
d©a
 = 
cúd
;

326 
şosu»
->
štd©a
 = intdata;

328 ià(
»g_wª‹d
)

329 
	`cúd_»g_uri
(
cúd
, 
uri
,

331 
CCN_FORW_CHILD_INHERIT
 | 
CCN_FORW_ACTIVE
,

333 
	`cú_£t_š‹»¡_f‹r
(
cúd
->
š‹º®_ş›Á
, 
Çme
, 
şosu»
);

334 
	`cú_ch¬buf_de¡roy
(&
Çme
);

335 
	`cú_ch¬buf_de¡roy
(&
uri_modif›d
);

336 
	`cú_šdexbuf_de¡roy
(&
comps
);

337 
	}
}

346 
	$cúd_»g_cúx_cúdid
(
cúd_hªdË
 *
cúd
)

348 
cú_ch¬buf
 *
Çme
;

349 
cú_ch¬buf
 *
uri
;

351 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

352 
	`cú_Çme_äom_uri
(
Çme
, "ccnx:/ccnx");

353 
	`cú_Çme_­³nd
(
Çme
, 
cúd
->
cúd_id
, 32);

354 
uri
 = 
	`cú_ch¬buf_ü—‹
();

355 
	`cú_uri_­³nd
(
uri
, 
Çme
->
buf
,‚ame->
Ëngth
, 1);

356 
	`cúd_»g_uri
(
cúd
, 
	`cú_ch¬buf_as_¡ršg
(
uri
),

358 (
CCN_FORW_CHILD_INHERIT
 |

359 
CCN_FORW_ACTIVE
 |

360 
CCN_FORW_CAPTURE
 |

361 
CCN_FORW_ADVERTISE
 ),

363 
	`cú_ch¬buf_de¡roy
(&
Çme
);

364 
	`cú_ch¬buf_de¡roy
(&
uri
);

365 
	}
}

367 #iâdeà
CCN_PATH_VAR_TMP


368 
	#CCN_PATH_VAR_TMP
 "/v¬/tmp"

	)

376 #iâdeà
CCND_KEYSTORE_PASS


377 
	#CCND_KEYSTORE_PASS
 "\010\043\103\375\327\237\152\351\155"

	)

381 
	$cúd_š™_š‹º®_key¡Üe
(
cúd_hªdË
 *
cúd
)

383 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

384 
cú_ch¬buf
 *
cmd
 = 
NULL
;

385 
cú_ch¬buf
 *
cuÍr™
 = 
NULL
;

386 
¡©
 
¡©buf
;

387 cÚ¡ *
dœ
 = 
NULL
;

388 
»s
 = -1;

389 
size_t
 
§ve
;

390 *
key¡Üe_·th
 = 
NULL
;

391 
FILE
 *
·ssfe
;

392 
cú_signšg_·¿ms
 
¥
 = 
CCN_SIGNING_PARAMS_INIT
;

394 ià(
cúd
->
š‹º®_ş›Á
 =ğ
NULL
)

396 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

397 
cmd
 = 
	`cú_ch¬buf_ü—‹
();

398 
dœ
 = 
	`g‘’v
("CCND_KEYSTORE_DIRECTORY");

399 ià(
dœ
 !ğ
NULL
 && dir[0] == '/')

400 
	`cú_ch¬buf_putf
(
‹mp
, "%s/", 
dœ
);

402 
	`cú_ch¬buf_putf
(
‹mp
, 
CCN_PATH_VAR_TMP
 "/.cúx-u£r%d/", ()
	`g‘euid
());

403 
»s
 = 
	`¡©
(
	`cú_ch¬buf_as_¡ršg
(
‹mp
), &
¡©buf
);

404 ià(
»s
 == -1) {

405 ià(
”ºo
 =ğ
ENOENT
)

406 
»s
 = 
	`mkdœ
(
	`cú_ch¬buf_as_¡ršg
(
‹mp
), 0700);

407 ià(
»s
 != 0) {

408 
cuÍr™
 = 
‹mp
;

409 
Fšish
;

412 
§ve
 = 
‹mp
->
Ëngth
;

413 
	`cú_ch¬buf_putf
(
‹mp
, ".cúd_key¡Üe_%s", 
cúd
->
pÜt¡r
);

414 
key¡Üe_·th
 = 
	`¡rdup
(
	`cú_ch¬buf_as_¡ršg
(
‹mp
));

415 
»s
 = 
	`¡©
(
key¡Üe_·th
, &
¡©buf
);

416 ià(
»s
 == 0)

417 
»s
 = 
	`cú_lßd_deçuÉ_key
(
cúd
->
š‹º®_ş›Á
, 
key¡Üe_·th
, 
CCND_KEYSTORE_PASS
);

418 ià(
»s
 >= 0)

419 
Fšish
;

421 
‹mp
->
Ëngth
 = 
§ve
;

422 
	`cú_ch¬buf_putf
(
‹mp
, "p");

423 
·ssfe
 = 
	`fİ’
(
	`cú_ch¬buf_as_¡ršg
(
‹mp
), "wb");

424 
	`årštf
(
·ssfe
, "%s", 
CCND_KEYSTORE_PASS
);

425 
	`fşo£
(
·ssfe
);

426 
	`cú_ch¬buf_putf
(
cmd
, "%s-init-keystore-helper %s",

427 
cúd
->
´ogÇme
, 
key¡Üe_·th
);

428 
»s
 = 
	`sy¡em
(
	`cú_ch¬buf_as_¡ršg
(
cmd
));

429 ià(
»s
 != 0) {

430 
cuÍr™
 = 
cmd
;

431 
Fšish
;

433 
»s
 = 
	`cú_lßd_deçuÉ_key
(
cúd
->
š‹º®_ş›Á
, 
key¡Üe_·th
, 
CCND_KEYSTORE_PASS
);

434 
Fšish
:

435 ià(
cuÍr™
 !ğ
NULL
) {

436 
	`cúd_msg
(
cúd
, "%s: %s:\n", 
	`cú_ch¬buf_as_¡ršg
(
cuÍr™
), 
	`¡»¼Ü
(
”ºo
));

437 
cuÍr™
 = 
NULL
;

439 
»s
 = 
	`cú_chk_signšg_·¿ms
(
cúd
->
š‹º®_ş›Á
, 
NULL
, &
¥
, NULL, NULL, NULL);

440 ià(
»s
 != 0)

441 
	`abÜt
();

442 
	`memıy
(
cúd
->
cúd_id
, 
¥
.
pubid
, (ccnd->ccnd_id));

443 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

444 
	`cú_ch¬buf_de¡roy
(&
cmd
);

445 ià(
key¡Üe_·th
 !ğ
NULL
)

446 
	`ä“
(
key¡Üe_·th
);

447 (
»s
);

448 
	}
}

451 
	$po¡_çû_nÙiû
(
cúd_hªdË
 *
cúd
, 
çûid
)

453 
çû
 *çû = 
	`cúd_çû_äom_çûid
(
cúd
, 
çûid
);

454 
cú_ch¬buf
 *
msg
 = 
	`cú_ch¬buf_ü—‹
();

455 
»s
 = -1;

456 
pÜt
;

459 ià(
çû
 =ğ
NULL
)

460 
	`cú_ch¬buf_putf
(
msg
, "de¡royçû(%u);\n", 
çûid
);

462 
	`cú_ch¬buf_putf
(
msg
, "Ãwçû(%u, 0x%x", 
çûid
, 
çû
->
æags
);

463 ià(
çû
->
addr
 !ğ
NULL
 &&

464 (
çû
->
æags
 & (
CCN_FACE_INET
 | 
CCN_FACE_INET6
)) != 0) {

465 
	`cú_ch¬buf_putf
(
msg
, ", ");

466 
pÜt
 = 
	`cú_ch¬buf_­³nd_sockaddr
(
msg
, 
çû
->
addr
);

467 ià(
pÜt
 < 0)

468 
msg
->
Ëngth
--;

469 ià(
pÜt
 > 0)

470 
	`cú_ch¬buf_putf
(
msg
, ":%d", 
pÜt
);

472 
	`cú_ch¬buf_putf
(
msg
, ");\n", 
çûid
);

474 
GOT_HERE
 
»s
 = 
	`cú_£qw_wr™e
(
cúd
->
nÙiû
, 
msg
->
buf
, msg->
Ëngth
);

475 
GOT_HERE
 
	`cú_ch¬buf_de¡roy
(&
msg
);

476 (
»s
);

477 
	}
}

480 
	$cúd_nÙiû_push
(
cú_scheduË
 *
sched
,

481 *
ş›Áh
,

482 
cú_scheduËd_ev’t
 *
ev
,

483 
æags
)

485 
cúd_hªdË
 *
cúd
 = 
ş›Áh
;

486 
cú_šdexbuf
 *
chçû
 = 
NULL
;

487 
i
 = 0;

488 
j
 = 0;

489 
miüo£c
 = 0;

490 
»s
 = 0;

492 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) == 0 &&

493 
cúd
->
nÙiû
 !ğ
NULL
 &&

494 
cúd
->
nÙiû_push
 =ğ
ev
 &&

495 
cúd
->
chçû
 !ğ
NULL
) {

496 
GOT_HERE
 
chçû
 = 
cúd
->chface;

497 
	`cú_£qw_b©ch_¡¬t
(
cúd
->
nÙiû
);

498 
i
 = 0; i < 
chçû
->
n
 && 
»s
 != -1; i++)

499 
»s
 = 
	`po¡_çû_nÙiû
(
cúd
, 
chçû
->
buf
[
i
]);

500 
	`cú_£qw_b©ch_’d
(
cúd
->
nÙiû
);

501 
GOT_HERE


502 
j
 = 0; 
i
 < 
chçû
->
n
; i++, j++)

503 
chçû
->
buf
[
j
] = chçû->buf[
i
];

504 
chçû
->
n
 = 
j
;

505 ià(
»s
 == -1)

506 
miüo£c
 = 3000;

507 
GOT_HERE
 ià(0è
	`cúd_š‹º®_ş›Á_»scheduË
(
cúd
);

509 ià(
miüo£c
 <= 0)

510 
cúd
->
nÙiû_push
 = 
NULL
;

511 (
miüo£c
);

512 
	}
}

522 
	$cúd_çû_¡©us_chªge
(
cúd_hªdË
 *
cúd
, 
çûid
)

524 
cú_šdexbuf
 *
chçû
 = 
cúd
->chface;

525 ià(
chçû
 !ğ
NULL
) {

526 
GOT_HERE


527 
	`cú_šdexbuf_£t_š£¹
(
chçû
, 
çûid
);

528 ià(
cúd
->
nÙiû_push
 =ğ
NULL
)

529 
cúd
->
nÙiû_push
 = 
	`cú_scheduË_ev’t
(cúd->
sched
, 2000,

530 
cúd_nÙiû_push
,

531 
NULL
, 0);

533 
	}
}

536 
	$cúd_¡¬t_nÙiû
(
cúd_hªdË
 *
cúd
)

538 
cú
 *
h
 = 
cúd
->
š‹º®_ş›Á
;

539 
cú_ch¬buf
 *
Çme
 = 
NULL
;

540 
çû
 *çû = 
NULL
;

541 
i
;

543 ià(
h
 =ğ
NULL
)

545 ià(
cúd
->
nÙiû
 !ğ
NULL
)

547 ià(
cúd
->
chçû
 !ğ
NULL
) {

549 
	`cúd_msg
(
cúd
, "cúd_š‹º®_ş›Á.c:%d Huh?", 
__LINE__
);

550 
	`cú_šdexbuf_de¡roy
(&
cúd
->
chçû
);

552 
GOT_HERE


553 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

554 
	`cú_Çme_äom_uri
(
Çme
, "ccnx:/ccnx");

555 
	`cú_Çme_­³nd
(
Çme
, 
cúd
->
cúd_id
, 32);

556 
	`cú_Çme_­³nd_¡r
(
Çme
, 
CCND_NOTICE_NAME
);

557 
cúd
->
nÙiû
 = 
	`cú_£qw_ü—‹
(
h
, 
Çme
);

558 
cúd
->
chçû
 = 
	`cú_šdexbuf_ü—‹
();

559 
i
 = 0; i < 
cúd
->
çû_lim™
; i++) {

560 
çû
 = 
cúd
->
çûs_by_çûid
[
i
];

561 ià(
çû
 !ğ
NULL
)

562 
	`cú_šdexbuf_£t_š£¹
(
cúd
->
chçû
, 
çû
->
çûid
);

564 ià(
cúd
->
chçû
->
n
 > 0)

565 
	`cúd_çû_¡©us_chªge
(
cúd
, cúd->
chçû
->
buf
[0]);

566 
	`cú_ch¬buf_de¡roy
(&
Çme
);

567 
	}
}

570 
	$cúd_š‹º®_ş›Á_¡¬t
(
cúd_hªdË
 *
cúd
)

572 
cú
 *
h
;

573 ià(
cúd
->
š‹º®_ş›Á
 !ğ
NULL
)

575 ià(
cúd
->
çû0
 =ğ
NULL
)

576 
	`abÜt
();

577 
cúd
->
š‹º®_ş›Á
 = 
h
 = 
	`cú_ü—‹
();

578 ià(
	`cúd_š™_š‹º®_key¡Üe
(
cúd
) < 0) {

579 
	`cú_de¡roy
(&
cúd
->
š‹º®_ş›Á
);

582 
	`cúd_uri_li¡’
(
cúd
, "ccnx:/ccnx/ping",

583 &
cúd_ªsw”_»q
, 
OP_PING
);

584 
	`cúd_uri_li¡’
(
cúd
, "cúx:/cúx/" 
CCND_ID_TEMPL
 "/ping",

585 &
cúd_ªsw”_»q
, 
OP_PING
);

586 
	`cúd_uri_li¡’
(
cúd
, "cúx:/cúx/" 
CCND_ID_TEMPL
 "/newface",

587 &
cúd_ªsw”_»q
, 
OP_NEWFACE
 + 
MUST_VERIFY1
);

588 
	`cúd_uri_li¡’
(
cúd
, "cúx:/cúx/" 
CCND_ID_TEMPL
 "/destroyface",

589 &
cúd_ªsw”_»q
, 
OP_DESTROYFACE
 + 
MUST_VERIFY1
);

590 
	`cúd_uri_li¡’
(
cúd
, "cúx:/cúx/" 
CCND_ID_TEMPL
 "/prefixreg",

591 &
cúd_ªsw”_»q
, 
OP_PREFIXREG
 + 
MUST_VERIFY1
);

592 
	`cúd_uri_li¡’
(
cúd
, "cúx:/cúx/" 
CCND_ID_TEMPL
 "/selfreg",

593 &
cúd_ªsw”_»q
, 
OP_SELFREG
 + 
MUST_VERIFY1
);

594 
	`cúd_uri_li¡’
(
cúd
, "cúx:/cúx/" 
CCND_ID_TEMPL
 "/unreg",

595 &
cúd_ªsw”_»q
, 
OP_UNREG
 + 
MUST_VERIFY1
);

596 
	`cúd_uri_li¡’
(
cúd
, "cúx:/cúx/" 
CCND_ID_TEMPL
 "/" 
CCND_NOTICE_NAME
,

597 &
cúd_ªsw”_»q
, 
OP_NOTICE
);

598 
	`cúd_uri_li¡’
(
cúd
, "ccnx:/%C1.M.S.localhost/%C1.M.SRV/ccnd",

599 &
cúd_ªsw”_»q
, 
OP_SERVICE
);

600 
	`cúd_»g_cúx_cúdid
(
cúd
);

601 
	`cúd_»g_uri
(
cúd
, "ccnx:/%C1.M.S.localhost",

603 (
CCN_FORW_CHILD_INHERIT
 |

604 
CCN_FORW_ACTIVE
 |

605 
CCN_FORW_LOCAL
 ),

607 
cúd
->
š‹º®_ş›Á_»äesh
 \

608 ğ
	`cú_scheduË_ev’t
(
cúd
->
sched
, 50000,

609 
cúd_š‹º®_ş›Á_»äesh
,

610 
NULL
, 
CCN_INTEREST_LIFETIME_MICROSEC
);

612 
	}
}

615 
	$cúd_š‹º®_ş›Á_»scheduË
(
cúd_hªdË
 *
cúd
)

617 ià(
cúd
->
š‹º®_ş›Á_»äesh
 =ğ
NULL
)

619 
	`cú_scheduË_ÿnûl
(
cúd
->
sched
, cúd->
š‹º®_ş›Á_»äesh
);

620 
cúd
->
š‹º®_ş›Á_»äesh
 \

621 ğ
	`cú_scheduË_ev’t
(
cúd
->
sched
, 0,

622 
cúd_š‹º®_ş›Á_»äesh
,

623 
NULL
, 
CCN_INTEREST_LIFETIME_MICROSEC
);

624 
	}
}

627 
	$cúd_š‹º®_ş›Á_¡İ
(
cúd_hªdË
 *
cúd
)

629 
cúd
->
nÙiû
 = 
NULL
;

630 ià(
cúd
->
nÙiû_push
 !ğ
NULL
)

631 
	`cú_scheduË_ÿnûl
(
cúd
->
sched
, cúd->
nÙiû_push
);

632 
	`cú_šdexbuf_de¡roy
(&
cúd
->
chçû
);

633 
	`cú_de¡roy
(&
cúd
->
š‹º®_ş›Á
);

634 
	`cú_ch¬buf_de¡roy
(&
cúd
->
£rviû_cúb
);

635 ià(
cúd
->
š‹º®_ş›Á_»äesh
 !ğ
NULL
)

636 
	`cú_scheduË_ÿnûl
(
cúd
->
sched
, cúd->
š‹º®_ş›Á_»äesh
);

637 
	}
}

	@ccnd/ccnd_main.c

20 
	~<sigÇl.h
>

21 
	~<¡ddef.h
>

22 
	~<¡d¬g.h
>

23 
	~<¡dio.h
>

24 
	~<¡dlib.h
>

26 
	~"cúd_´iv©e.h
"

29 
	$¡diŞogg”
(*
logg”d©a
, cÚ¡ *
fÜm©
, 
va_li¡
 
­
)

31 
FILE
 *
å
 = (FILE *)
logg”d©a
;

32 (
	`vårštf
(
å
, 
fÜm©
, 
­
));

33 
	}
}

36 
	$maš
(
¬gc
, **
¬gv
)

38 
cúd_hªdË
 *
h
;

40 ià(
¬gc
 > 1) {

41 
	`årštf
(
¡d”r
, "%s", 
cúd_u§ge_mes§ge
);

42 
	`ex™
(1);

44 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

45 
h
 = 
	`cúd_ü—‹
(
¬gv
[0], 
¡diŞogg”
, 
¡d”r
);

46 ià(
h
 =ğ
NULL
)

47 
	`ex™
(1);

48 
	`cúd_run
(
h
);

49 
	`cúd_msg
(
h
, "exiting.");

50 
	`cúd_de¡roy
(&
h
);

51 
	`ex™
(0);

52 
	}
}

	@ccnd/ccnd_msg.c

22 
	~<¡dio.h
>

23 
	~<sys/time.h
>

24 
	~<¡d¬g.h
>

25 
	~<time.h
>

26 
	~<uni¡d.h
>

28 
	~<cú/cú.h
>

29 
	~<cú/cúd.h
>

30 
	~<cú/ch¬buf.h
>

31 
	~<cú/uri.h
>

33 
	~"cúd_´iv©e.h
"

44 
	$cúd_msg
(
cúd_hªdË
 *
h
, cÚ¡ *
fmt
, ...)

46 
timev®
 
t
;

47 
va_li¡
 
­
;

48 
cú_ch¬buf
 *
b
;

49 
»s
;

50 cÚ¡ *
pÜt¡r
;

51 ià(
h
 =ğ
NULL
 || h->
debug
 =ğ0 || h->
logg”
 == 0)

53 
b
 = 
	`cú_ch¬buf_ü—‹
();

54 
	`g‘timeofday
(&
t
, 
NULL
);

55 ià(((
h
->
debug
 & 64) != 0) &&

56 ((
h
->
logb»ak
-- < 0 && 
t
.
tv_£c
 !ğh->
logtime
) ||

57 
t
.
tv_£c
 >ğ
h
->
logtime
 + 30)) {

58 
pÜt¡r
 = 
h
->portstr;

59 ià(
pÜt¡r
 =ğ
NULL
)

60 
pÜt¡r
 = "";

61 
	`cú_ch¬buf_putf
(
b
, "%ld.000000 ccnd[%d]: %s ____________________ %s",

62 ()
t
.
tv_£c
, 
h
->
logpid
, h->
pÜt¡r
, 
	`ùime
(&t.tv_sec));

63 
h
->
logtime
 = 
t
.
tv_£c
;

64 
h
->
logb»ak
 = 30;

66 
	`cú_ch¬buf_putf
(
b
, "%ld.%06u ccnd[%d]: %s\n",

67 ()
t
.
tv_£c
, (é.
tv_u£c
, 
h
->
logpid
, 
fmt
);

68 
	`va_¡¬t
(
­
, 
fmt
);

69 
»s
 = (*
h
->
logg”
)(h->
logg”d©a
, (cÚ¡ *)
b
->
buf
, 
­
);

70 
	`va_’d
(
­
);

71 
	`cú_ch¬buf_de¡roy
(&
b
);

73 ià(
»s
 < 0)

74 
h
->
debug
 = 0;

75 
	}
}

88 
	$cúd_debug_cúb
(
cúd_hªdË
 *
h
,

89 
lš’o
,

90 cÚ¡ *
msg
,

91 
çû
 *face,

92 cÚ¡ *
cúb
,

93 
size_t
 
cúb_size
)

95 
cú_ch¬buf
 *
c
;

96 
cú_·r£d_š‹»¡
 
pi
;

97 cÚ¡ *
nÚû
 = 
NULL
;

98 
size_t
 
nÚû_size
 = 0;

99 
size_t
 
i
;

102 ià(
h
 !ğ
NULL
 && h->
debug
 == 0)

104 
c
 = 
	`cú_ch¬buf_ü—‹
();

105 
	`cú_ch¬buf_putf
(
c
, "debug.%d % ", 
lš’o
, 
msg
);

106 ià(
çû
 !ğ
NULL
)

107 
	`cú_ch¬buf_putf
(
c
, "%u ", 
çû
->
çûid
);

108 
	`cú_uri_­³nd
(
c
, 
cúb
, 
cúb_size
, 1);

109 
	`cú_ch¬buf_putf
(
c
, " (%u by‹s)", ()
cúb_size
);

110 ià(
	`cú_·r£_š‹»¡
(
cúb
, 
cúb_size
, &
pi
, 
NULL
) >= 0) {

111 cÚ¡ *
p
 = "";

112 
	`cú_»f_gged_BLOB
(
CCN_DTAG_NÚû
, 
cúb
,

113 
pi
.
off£t
[
CCN_PI_B_NÚû
],

114 
pi
.
off£t
[
CCN_PI_E_NÚû
],

115 &
nÚû
,

116 &
nÚû_size
);

117 ià(
nÚû_size
 > 0) {

118 
	`cú_ch¬buf_putf
(
c
, " ");

119 ià(
nÚû_size
 == 12)

120 
p
 = "CCC-P-F-T-NN";

121 
i
 = 0; i < 
nÚû_size
; i++)

122 
	`cú_ch¬buf_putf
(
c
, "%s%02X", (*
p
è&& (*p++)=='-' ? "-" : "", 
nÚû
[
i
]);

125 
	`cúd_msg
(
h
, "%s", 
	`cú_ch¬buf_as_¡ršg
(
c
));

126 
	`cú_ch¬buf_de¡roy
(&
c
);

127 
	}
}

132 cÚ¡ *
	gcúd_u§ge_mes§ge
 =

149 " UDP…ÜˆfÜ uniÿ¡ cl›Á (deçuÉ "
CCN_DEFAULT_UNICAST_PORT
").\n"

153 " Nam¡em oàunix-domaš sock‘ (deçuÉ "
CCN_DEFAULT_LOCAL_SOCKNAME
").\n"

	@ccnd/ccnd_private.h

24 #iâdeà
CCND_PRIVATE_DEFINED


25 
	#CCND_PRIVATE_DEFINED


	)

27 
	~<pŞl.h
>

28 
	~<¡d¬g.h
>

29 
	~<¡ddef.h
>

30 
	~<¡dšt.h
>

31 
	~<sys/sock‘.h
>

32 
	~<sys/ty³s.h
>

34 
	~<cú/cú_´iv©e.h
>

35 
	~<cú/codšg.h
>

36 
	~<cú/»g_mgmt.h
>

37 
	~<cú/scheduË.h
>

38 
	~<cú/£qwr™”.h
>

44 
	gcú_ch¬buf
;

45 
	gcú_šdexbuf
;

46 
	ghashtb
;

51 
	gcúd_hªdË
;

52 
	gçû
;

53 
	gcÚ‹Á_’Œy
;

54 
	gÇm•»fix_’Œy
;

55 
	g´İag©šg_’Œy
;

56 
	gcÚ‹Á_Œ“_node
;

57 
	gcú_fÜw¬dšg
;

60 
	tcú_acûssiÚ_t
;

62 (*
	tcúd_logg”
)(*
	tlogg”d©a
, cÚ¡ *
	tfÜm©
, 
	tva_li¡
 
	t­
);

67 
	scúd_hªdË
 {

68 
cúd_id
[32];

69 
hashtb
 *
çûs_by_fd
;

70 
hashtb
 *
dg¿m_çûs
;

71 
hashtb
 *
cÚ‹Á_b
;

72 
hashtb
 *
Çm•»fix_b
;

73 
hashtb
 *
´İag©šg_b
;

74 
cú_šdexbuf
 *
sklšks
;

75 
fÜw¬d_to_g’
;

76 
çû_g’
;

77 
çû_rov”
;

78 
çû_lim™
;

79 
çû
 **
çûs_by_çûid
;

80 
cú_scheduËd_ev’t
 *
»­”
;

81 
cú_scheduËd_ev’t
 *
age
;

82 
cú_scheduËd_ev’t
 *
ş—n
;

83 
cú_scheduËd_ev’t
 *
age_fÜw¬dšg
;

84 cÚ¡ *
pÜt¡r
;

85 
v4_çûid
;

86 
v6_çûid
;

87 
nfds_t
 
nfds
;

88 
pŞlfd
 *
fds
;

89 
cú_g‘time
 
ticktock
;

90 
£c
;

91 
u£c
;

92 
cú_scheduË
 *
sched
;

93 
cú_ch¬buf
 *
sü©ch_ch¬buf
;

94 
cú_šdexbuf
 *
sü©ch_šdexbuf
;

96 
cú_acûssiÚ_t
 
acûssiÚ_ba£
;

97 
cÚ‹Á_by_acûssiÚ_wšdow
;

98 
cÚ‹Á_’Œy
 **
cÚ‹Á_by_acûssiÚ
;

100 
hashtb
 *
¥¬£_¡¿ggËr_b
;

101 
cú_acûssiÚ_t
 
acûssiÚ
;

102 
cú_acûssiÚ_t
 
mš_¡®e
;

103 
cú_acûssiÚ_t
 
max_¡®e
;

104 
ÿ·c™y
;

106 
n_¡®e
;

107 
cú_šdexbuf
 *
unsŞ
;

108 
ŞdfÜm©cÚ‹Á
;

109 
ŞdfÜm©cÚ‹ÁgrumbË
;

110 
ŞdfÜm©š‹»¡s
;

111 
ŞdfÜm©š‹»¡grumbË
;

112 
cÚ‹Á_dups_»cvd
;

113 
cÚ‹Á_™ems_£Á
;

114 
š‹»¡s_acû±ed
;

115 
š‹»¡s_drİ³d
;

116 
š‹»¡s_£Á
;

117 
š‹»¡s_¡ufãd
;

118 
£ed
[3];

119 
ruÂšg
;

120 
debug
;

121 
cúd_logg”
 
logg”
;

122 *
logg”d©a
;

123 
logb»ak
;

124 
logtime
;

125 
logpid
;

126 
mtu
;

127 
æood
;

128 
cú_ch¬buf
 *
autÜeg
;

129 
fÜû_z”o_äeshÃss
;

130 
š‹»¡_çûid
;

131 cÚ¡ *
´ogÇme
;

132 
cú
 *
š‹º®_ş›Á
;

133 
çû
 *
çû0
;

134 
cú_ch¬buf
 *
£rviû_cúb
;

135 
cú_£qwr™”
 *
nÙiû
;

136 
cú_šdexbuf
 *
chçû
;

137 
cú_scheduËd_ev’t
 *
š‹º®_ş›Á_»äesh
;

138 
cú_scheduËd_ev’t
 *
nÙiû_push
;

139 
d©a_·u£_miüo£c
;

140 (*
­²Úû
)(
cúd_hªdË
 *, 
çû
 *, 
cú_ch¬buf
 *);

151 
	#FACESLOTBITS
 18

	)

152 
	#MAXFACES
 ((1U << 
FACESLOTBITS
è- 1)

	)

154 
	scÚ‹Á_queue
 {

155 
bur¡_n£c
;

156 
mš_u£c
;

157 
¿nd_u£c
;

158 
»ady
;

159 
Äun
;

160 
cú_šdexbuf
 *
£nd_queue
;

161 
cú_scheduËd_ev’t
 *
£nd”
;

164 
	ecq_d–ay_şass
 {

165 
CCN_CQ_ASAP
,

166 
CCN_CQ_NORMAL
,

167 
CCN_CQ_SLOW
,

168 
CCN_CQ_N


174 
	sçû
 {

175 
»cv_fd
;

176 
£ndçû
;

177 
æags
;

178 
su½lus
;

179 
çûid
;

180 
»cvcouÁ
;

181 
cÚ‹Á_queue
 *
q
[
CCN_CQ_N
];

182 
cú_ch¬buf
 *
šbuf
;

183 
cú_sk–‘Ú_decod”
 
decod”
;

184 
size_t
 
outbufšdex
;

185 
cú_ch¬buf
 *
outbuf
;

186 cÚ¡ 
sockaddr
 *
addr
;

187 
sockËn_t
 
add¾’
;

188 
³ndšg_š‹»¡s
;

192 
	#CCN_FACE_LINK
 (1 << 0è

	)

193 
	#CCN_FACE_DGRAM
 (1 << 1è

	)

194 
	#CCN_FACE_GG
 (1 << 2è

	)

195 
	#CCN_FACE_LOCAL
 (1 << 3è

	)

196 
	#CCN_FACE_INET
 (1 << 4è

	)

197 
	#CCN_FACE_MCAST
 (1 << 5è

	)

198 
	#CCN_FACE_INET6
 (1 << 6è

	)

199 
	#CCN_FACE_DC
 (1 << 7è

	)

200 
	#CCN_FACE_NOSEND
 (1 << 8è

	)

201 
	#CCN_FACE_UNDECIDED
 (1 << 9è

	)

202 
	#CCN_FACE_PERMANENT
 (1 << 10è

	)

203 
	#CCN_FACE_CONNECTING
 (1 << 11è

	)

204 
	#CCN_FACE_LOOPBACK
 (1 << 12è

	)

205 
	#CCN_FACE_CLOSING
 (1 << 13è

	)

206 
	#CCN_FACE_PASSIVE
 (1 << 14è

	)

207 
	#CCN_FACE_NORECV
 (1 << 15è

	)

208 
	#CCN_FACE_REGOK
 (1 << 16è

	)

209 
	#CCN_NOFACEID
 (~0Uè

	)

221 
	scÚ‹Á_’Œy
 {

222 
cú_acûssiÚ_t
 
acûssiÚ
;

223 *
comps
;

224 
ncomps
;

225 
æags
;

226 cÚ¡ *
key
;

227 
key_size
;

228 
size
;

229 
cú_šdexbuf
 *
sklšks
;

235 
	#CCN_CONTENT_ENTRY_SLOWSEND
 1

	)

236 
	#CCN_CONTENT_ENTRY_STALE
 2

	)

237 
	#CCN_CONTENT_ENTRY_PRECIOUS
 4

	)

243 
	s¥¬£_¡¿ggËr_’Œy
 {

244 
cÚ‹Á_’Œy
 *
cÚ‹Á
;

258 
	s´İag©šg_’Œy
 {

259 
´İag©šg_’Œy
 *
Ãxt
;

260 
´İag©šg_’Œy
 *
´ev
;

261 
æags
;

262 
çûid
;

263 
u£c
;

264 
£Á
;

265 
cú_šdexbuf
 *
outbound
;

266 *
š‹»¡_msg
;

267 
size
;

268 
fg’
;

271 
	#CCN_PR_UNSENT
 0x01

	)

272 
	#CCN_PR_WAIT1
 0x02

	)

273 
	#CCN_PR_STUFFED1
 0x04

	)

274 
	#CCN_PR_TAP
 0x08

	)

275 
	#CCN_PR_EQV
 0x10

	)

276 
	#CCN_PR_SCOPE0
 0x20

	)

277 
	#CCN_PR_SCOPE1
 0x40

	)

278 
	#CCN_PR_SCOPE2
 0x80

	)

284 
	sÇm•»fix_’Œy
 {

285 
´İag©šg_’Œy
 
³_h—d
;

286 
cú_šdexbuf
 *
fÜw¬d_to
;

287 
cú_šdexbuf
 *
p
;

288 
cú_fÜw¬dšg
 *
fÜw¬dšg
;

289 
Çm•»fix_’Œy
 *
·»Á
;

290 
chd»n
;

291 
æags
;

292 
fg’
;

293 
¤c
;

294 
o¤c
;

295 
u£c
;

302 
	scú_fÜw¬dšg
 {

303 
çûid
;

304 
æags
;

305 
expœes
;

306 
cú_fÜw¬dšg
 *
Ãxt
;

317 
	#CCN_FORW_REFRESHED
 (1 << 16è

	)

322 
	#CCN_FWU_SECS
 5

	)

329 
	`cúd_š™_š‹º®_key¡Üe
(
cúd_hªdË
 *);

330 
	`cúd_š‹º®_ş›Á_¡¬t
(
cúd_hªdË
 *);

331 
	`cúd_š‹º®_ş›Á_¡İ
(
cúd_hªdË
 *);

338 
cú_ch¬buf
 *
	`cúd_»q_Ãwçû
(
cúd_hªdË
 *
h
,

339 cÚ¡ *
msg
, 
size_t
 
size
);

346 
cú_ch¬buf
 *
	`cúd_»q_de¡royçû
(
cúd_hªdË
 *
h
,

347 cÚ¡ *
msg
, 
size_t
 
size
);

354 
cú_ch¬buf
 *
	`cúd_»q_´efix»g
(
cúd_hªdË
 *
h
,

355 cÚ¡ *
msg
, 
size_t
 
size
);

362 
cú_ch¬buf
 *
	`cúd_»q_£läeg
(
cúd_hªdË
 *
h
,

363 cÚ¡ *
msg
, 
size_t
 
size
);

370 
cú_ch¬buf
 *
	`cúd_»q_uÄeg
(
cúd_hªdË
 *
h
,

371 cÚ¡ *
msg
, 
size_t
 
size
);

373 
	`cúd_»g_uri
(
cúd_hªdË
 *
h
,

374 cÚ¡ *
uri
,

375 
çûid
,

376 
æags
,

377 
expœes
);

379 
çû
 *
	`cúd_çû_äom_çûid
(
cúd_hªdË
 *, );

380 
	`cúd_çû_¡©us_chªge
(
cúd_hªdË
 *, );

381 
	`cúd_de¡roy_çû
(
cúd_hªdË
 *
h
, 
çûid
);

382 
	`cúd_£nd
(
cúd_hªdË
 *
h
, 
çû
 *face,

383 cÚ¡ *
d©a
, 
size_t
 
size
);

386 
	`cúd_¡©s_hªdË_h‰p_cÚÃùiÚ
(
cúd_hªdË
 *, 
çû
 *);

387 
	`cúd_msg
(
cúd_hªdË
 *, const *, ...);

388 
	`cúd_debug_cúb
(
cúd_hªdË
 *
h
,

389 
lš’o
,

390 cÚ¡ *
msg
,

391 
çû
 *face,

392 cÚ¡ *
cúb
,

393 
size_t
 
cúb_size
);

395 
cúd_hªdË
 *
	`cúd_ü—‹
(cÚ¡ *, 
cúd_logg”
, *);

396 
	`cúd_run
(
cúd_hªdË
 *
h
);

397 
	`cúd_de¡roy
(
cúd_hªdË
 **);

398 cÚ¡ *
cúd_u§ge_mes§ge
;

	@ccnd/ccnd_stats.c

22 
	~<sys/ty³s.h
>

23 
	~<”ºo.h
>

24 
	~<fú.h
>

25 
	~<¡dšt.h
>

26 
	~<¡dio.h
>

27 
	~<¡dlib.h
>

28 
	~<¡ršg.h
>

29 
	~<sys/time.h
>

30 
	~<sys/sock‘.h
>

31 
	~<sys/ut¢ame.h
>

32 
	~<time.h
>

33 
	~<uni¡d.h
>

34 
	~<cú/cú.h
>

35 
	~<cú/cúd.h
>

36 
	~<cú/ch¬buf.h
>

37 
	~<cú/codšg.h
>

38 
	~<cú/šdexbuf.h
>

39 
	~<cú/scheduË.h
>

40 
	~<cú/sockaddrut.h
>

41 
	~<cú/hashtb.h
>

42 
	~<cú/uri.h
>

44 
	~"cúd_´iv©e.h
"

46 
	#CRLF
 "\r\n"

	)

47 
	#NL
 "\n"

	)

49 
	scúd_¡©s
 {

50 
	mtÙ®_š‹»¡_couÁs
;

51 
	mtÙ®_æood_cÚŒŞ
;

54 
cúd_cŞËù_¡©s
(
cúd_hªdË
 *
h
, 
cúd_¡©s
 *
ªs
);

55 
cú_ch¬buf
 *
cŞËù_¡©s_html
(
cúd_hªdË
 *
h
);

56 
£nd_h‰p_»¥Ú£
(
cúd_hªdË
 *
h
, 
çû
 *face,

57 cÚ¡ *
mime_ty³
,

58 
cú_ch¬buf
 *
»¥Ú£
);

59 
cú_ch¬buf
 *
cŞËù_¡©s_html
(
cúd_hªdË
 *
h
);

60 
cú_ch¬buf
 *
cŞËù_¡©s_xml
(
cúd_hªdË
 *
h
);

64 cÚ¡ *
	g»¥404
 =

65 "HTTP/1.1 404 NÙ Found" 
CRLF


66 "CÚÃùiÚ: clo£" 
CRLF
 CRLF;

68 cÚ¡ *
	g»¥405
 =

69 "HTTP/1.1 405 M‘hod NÙ AÎowed" 
CRLF


70 "CÚÃùiÚ: clo£" 
CRLF
 CRLF;

73 
	$cúd_¡©s_h‰p_£t_debug
(
cúd_hªdË
 *
h
, 
çû
 *çû, 
Ëv–
)

75 
cú_ch¬buf
 *
»¥Ú£
 = 
	`cú_ch¬buf_ü—‹
();

77 
h
->
debug
 = 1;

78 
	`cúd_msg
(
h
, "CCND_DEBUG=%d", 
Ëv–
);

79 
h
->
debug
 = 
Ëv–
;

80 
	`cú_ch¬buf_putf
(
»¥Ú£
, "<t™Ë>CCND_DEBUG=%d</t™Ë><‰>CCND_DEBUG=%d</‰>" 
CRLF
, 
Ëv–
,†evel);

81 
	`£nd_h‰p_»¥Ú£
(
h
, 
çû
, "‹xt/html", 
»¥Ú£
);

82 
	`cú_ch¬buf_de¡roy
(&
»¥Ú£
);

83 
	}
}

86 
	$cúd_¡©s_hªdË_h‰p_cÚÃùiÚ
(
cúd_hªdË
 *
h
, 
çû
 *face)

88 
cú_ch¬buf
 *
»¥Ú£
 = 
NULL
;

89 
rbuf
[16];

90 
i
;

91 
n¥aû
;

92 
n
;

94 ià(
çû
->
šbuf
->
Ëngth
 < 4)

96 ià((
çû
->
æags
 & 
CCN_FACE_NOSEND
) != 0) {

97 
	`cúd_de¡roy_çû
(
h
, 
çû
->
çûid
);

100 
n
 = (
rbuf
) - 1;

101 ià(
çû
->
šbuf
->
Ëngth
 < 
n
)

102 
n
 = 
çû
->
šbuf
->
Ëngth
;

103 
i
 = 0, 
n¥aû
 = 0; i < 
n
 &&‚space < 2; i++) {

104 
rbuf
[
i
] = 
çû
->
šbuf
->
buf
[i];

105 ià(
rbuf
[
i
] == ' ')

106 
n¥aû
++;

108 
rbuf
[
i
] = 0;

109 ià(
n¥aû
 < 2 && 
i
 < (
rbuf
) - 1)

111 ià(0 =ğ
	`¡rcmp
(
rbuf
, "GET / ") ||

112 0 =ğ
	`¡rcmp
(
rbuf
, "GET /? ")) {

113 
»¥Ú£
 = 
	`cŞËù_¡©s_html
(
h
);

114 
	`£nd_h‰p_»¥Ú£
(
h
, 
çû
, "‹xt/html", 
»¥Ú£
);

116 ià(0 =ğ
	`¡rcmp
(
rbuf
, "GET /?l=none ")) {

117 
	`cúd_¡©s_h‰p_£t_debug
(
h
, 
çû
, 0);

119 ià(0 =ğ
	`¡rcmp
(
rbuf
, "GET /?l=low ")) {

120 
	`cúd_¡©s_h‰p_£t_debug
(
h
, 
çû
, 1);

122 ià(0 =ğ
	`¡rcmp
(
rbuf
, "GET /?l=co ")) {

123 
	`cúd_¡©s_h‰p_£t_debug
(
h
, 
çû
, 4);

125 ià(0 =ğ
	`¡rcmp
(
rbuf
, "GET /?l=med ")) {

126 
	`cúd_¡©s_h‰p_£t_debug
(
h
, 
çû
, 71);

128 ià(0 =ğ
	`¡rcmp
(
rbuf
, "GET /?l=high ")) {

129 
	`cúd_¡©s_h‰p_£t_debug
(
h
, 
çû
, -1);

131 ià(0 =ğ
	`¡rcmp
(
rbuf
, "GET /?f=xml ")) {

132 
»¥Ú£
 = 
	`cŞËù_¡©s_xml
(
h
);

133 
	`£nd_h‰p_»¥Ú£
(
h
, 
çû
, "‹xt/xml", 
»¥Ú£
);

135 ià(0 =ğ
	`¡rcmp
(
rbuf
, "GET "))

136 
	`cúd_£nd
(
h
, 
çû
, 
»¥404
, 
	`¡¾’
(resp404));

138 
	`cúd_£nd
(
h
, 
çû
, 
»¥405
, 
	`¡¾’
(resp405));

139 
çû
->
æags
 |ğ(
CCN_FACE_NOSEND
 | 
CCN_FACE_CLOSING
);

140 
	`cú_ch¬buf_de¡roy
(&
»¥Ú£
);

142 
	}
}

145 
	$£nd_h‰p_»¥Ú£
(
cúd_hªdË
 *
h
, 
çû
 *face,

146 cÚ¡ *
mime_ty³
, 
cú_ch¬buf
 *
»¥Ú£
)

148 
lšg”
†šg” = { .
l_Úoff
 = 1, .
l_lšg”
 = 1 };

149 
buf
[128];

150 
hd¾’
;

153 
	`£tsockİt
(
çû
->
»cv_fd
, 
SOL_SOCKET
, 
SO_LINGER
, &
lšg”
, (linger));

154 
hd¾’
 = 
	`¢´štf
(
buf
, (buf),

155 "HTTP/1.1 200 OK" 
CRLF


156 "CÚ‹Á-Ty³: %s; ch¬£t=utf-8" 
CRLF


157 "CÚÃùiÚ: clo£" 
CRLF


158 "CÚ‹Á-L’gth: %jd" 
CRLF
 CRLF,

159 
mime_ty³
,

160 (
štmax_t
)
»¥Ú£
->
Ëngth
);

161 
	`cúd_£nd
(
h
, 
çû
, 
buf
, 
hd¾’
);

162 
	`cúd_£nd
(
h
, 
çû
, 
»¥Ú£
->
buf
,„e¥Ú£->
Ëngth
);

163 
	}
}

168 
	$cúd_cŞËù_¡©s
(
cúd_hªdË
 *
h
, 
cúd_¡©s
 *
ªs
)

170 
hashtb_’um”©Ü
 
“
;

171 
hashtb_’um”©Ü
 *
e
 = &
“
;

172 
sum
;

173 
i
;

174 
sum
 = 0, 
	`hashtb_¡¬t
(
h
->
Çm•»fix_b
, 
e
);

175 
e
->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

176 
Çm•»fix_’Œy
 *
Åe
 = 
e
->
d©a
;

177 
´İag©šg_’Œy
 *
h—d
 = &
Åe
->
³_h—d
;

178 
´İag©šg_’Œy
 *
p
;

179 
p
 = 
h—d
->
Ãxt
;… != head;… =…->next) {

180 ià(
	`cúd_çû_äom_çûid
(
h
, 
p
->
çûid
è!ğ
NULL
)

181 
sum
 += 1;

184 
ªs
->
tÙ®_š‹»¡_couÁs
 = 
sum
;

185 
	`hashtb_’d
(
e
);

186 
sum
 = 0, 
	`hashtb_¡¬t
(
h
->
´İag©šg_b
, 
e
);

187 
e
->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

188 
´İag©šg_’Œy
 *
³
 = 
e
->
d©a
;

189 ià(
³
->
š‹»¡_msg
 =ğ
NULL
)

190 
sum
 += 1;

192 
ªs
->
tÙ®_æood_cÚŒŞ
 = 
sum
;

193 
	`hashtb_’d
(
e
);

195 
sum
 = 0, 
i
 = 0; i < 
h
->
çû_lim™
; i++) {

196 
çû
 *çû = 
h
->
çûs_by_çûid
[
i
];

197 ià(
çû
 !ğ
NULL
)

198 
sum
 +ğ
çû
->
³ndšg_š‹»¡s
;

200 ià(
sum
 !ğ
ªs
->
tÙ®_š‹»¡_couÁs
)

201 
	`cúd_msg
(
h
, "ccnd_collect_stats found inconsistency %ld != %ld\n",

202 ()
sum
, ()
ªs
->
tÙ®_š‹»¡_couÁs
);

203 
ªs
->
tÙ®_š‹»¡_couÁs
 = 
sum
;

205 
	}
}

210 
	$cŞËù_çûs_html
(
cúd_hªdË
 *
h
, 
cú_ch¬buf
 *
b
)

212 
i
;

213 
cú_ch¬buf
 *
nodebuf
;

214 
pÜt
;

216 
nodebuf
 = 
	`cú_ch¬buf_ü—‹
();

217 
	`cú_ch¬buf_putf
(
b
, "<h4>Faûs</h4>" 
NL
);

218 
	`cú_ch¬buf_putf
(
b
, "<ul>");

219 
i
 = 0; i < 
h
->
çû_lim™
; i++) {

220 
çû
 *çû = 
h
->
çûs_by_çûid
[
i
];

221 ià(
çû
 !ğ
NULL
 && (çû->
æags
 & 
CCN_FACE_UNDECIDED
) == 0) {

222 
	`cú_ch¬buf_putf
(
b
, " <li>");

223 
	`cú_ch¬buf_putf
(
b
, "<b>face:</b> %u <b>flags:</b> 0x%x",

224 
çû
->
çûid
, faû->
æags
);

225 
	`cú_ch¬buf_putf
(
b
, " <b>pending:</b> %d",

226 
çû
->
³ndšg_š‹»¡s
);

227 ià(
çû
->
»cvcouÁ
 != 0)

228 
	`cú_ch¬buf_putf
(
b
, " <b>activity:</b> %d",

229 
çû
->
»cvcouÁ
);

230 
nodebuf
->
Ëngth
 = 0;

231 
pÜt
 = 
	`cú_ch¬buf_­³nd_sockaddr
(
nodebuf
, 
çû
->
addr
);

232 ià(
pÜt
 > 0) {

233 cÚ¡ *
node
 = 
	`cú_ch¬buf_as_¡ršg
(
nodebuf
);

234 
chk
 = 
CCN_FACE_MCAST
 | 
CCN_FACE_UNDECIDED
 |

235 
CCN_FACE_NOSEND
 | 
CCN_FACE_GG
 | 
CCN_FACE_PASSIVE
;

236 ià((
çû
->
æags
 & 
chk
) == 0)

237 
	`cú_ch¬buf_putf
(
b
,

241 
node
, 
CCN_DEFAULT_UNICAST_PORT
,

242 
node
, 
pÜt
);

243 ià((
çû
->
æags
 & 
CCN_FACE_PASSIVE
) == 0)

244 
	`cú_ch¬buf_putf
(
b
, " <b>remote:</b> %s:%d",

245 
node
, 
pÜt
);

247 
	`cú_ch¬buf_putf
(
b
, " <b>local:</b> %s:%d",

248 
node
, 
pÜt
);

249 ià(
çû
->
£ndçû
 !ğçû->
çûid
 &&

250 
çû
->
£ndçû
 !ğ
CCN_NOFACEID
)

251 
	`cú_ch¬buf_putf
(
b
, " <b>vŸ:</b> %u", 
çû
->
£ndçû
);

253 
	`cú_ch¬buf_putf
(
b
, "</li>" 
NL
);

256 
	`cú_ch¬buf_putf
(
b
, "</ul>");

257 
	`cú_ch¬buf_de¡roy
(&
nodebuf
);

258 
	}
}

261 
	$cŞËù_fÜw¬dšg_html
(
cúd_hªdË
 *
h
, 
cú_ch¬buf
 *
b
)

263 
hashtb_’um”©Ü
 
“
;

264 
hashtb_’um”©Ü
 *
e
 = &
“
;

265 
cú_fÜw¬dšg
 *
f
;

266 
»s
;

267 
cú_ch¬buf
 *
Çme
 = 
	`cú_ch¬buf_ü—‹
();

269 
	`cú_ch¬buf_putf
(
b
, "<h4>FÜw¬dšg</h4>" 
NL
);

270 
	`cú_ch¬buf_putf
(
b
, "<ul>");

271 
	`hashtb_¡¬t
(
h
->
Çm•»fix_b
, 
e
);

272 ; 
e
->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

273 
Çm•»fix_’Œy
 *
e
 = 
e
->
d©a
;

274 
	`cú_Çme_š™
(
Çme
);

275 
»s
 = 
	`cú_Çme_­³nd_compÚ’ts
(
Çme
, 
e
->
key
, 0,ƒ->
keysize
);

276 ià(
»s
 < 0)

277 
	`abÜt
();

279 
	`cú_ch¬buf_putf
(
b
, " <li>");

280 
	`cú_uri_­³nd
(
b
, 
Çme
->
buf
,‚ame->
Ëngth
, 1);

281 
	`cú_ch¬buf_putf
(
b
, "</li>" 
NL
);

283 
f
 = 
e
->
fÜw¬dšg
; f !ğ
NULL
; f = f->
Ãxt
) {

284 ià((
f
->
æags
 & 
CCN_FORW_ACTIVE
) != 0) {

285 
	`cú_Çme_š™
(
Çme
);

286 
»s
 = 
	`cú_Çme_­³nd_compÚ’ts
(
Çme
, 
e
->
key
, 0,ƒ->
keysize
);

287 
	`cú_ch¬buf_putf
(
b
, " <li>");

288 
	`cú_uri_­³nd
(
b
, 
Çme
->
buf
,‚ame->
Ëngth
, 1);

289 
	`cú_ch¬buf_putf
(
b
,

293 
f
->
çûid
, f->
æags
, f->
expœes
);

294 
	`cú_ch¬buf_putf
(
b
, "</li>" 
NL
);

298 
	`hashtb_’d
(
e
);

299 
	`cú_ch¬buf_de¡roy
(&
Çme
);

300 
	`cú_ch¬buf_putf
(
b
, "</ul>");

301 
	}
}

304 
	$cúd_cŞÜhash
(
cúd_hªdË
 *
h
)

306 cÚ¡ *
a
 = 
h
->
cúd_id
;

307 
v
;

309 
v
 = (
a
[0] << 16) + (a[1] << 8) +‡[2];

310  (
v
 | 0xC0C0C0);

311 
	}
}

313 
cú_ch¬buf
 *

314 
	$cŞËù_¡©s_html
(
cúd_hªdË
 *
h
)

316 
cúd_¡©s
 
¡©s
 = {0};

317 
cú_ch¬buf
 *
b
 = 
	`cú_ch¬buf_ü—‹
();

318 
pid
;

319 
ut¢ame
 
un
;

320 cÚ¡ *
pÜt¡r
;

322 
pÜt¡r
 = 
	`g‘’v
(
CCN_LOCAL_PORT_ENVNAME
);

323 ià(
pÜt¡r
 =ğ
NULL
 ||…Üt¡r[0] =ğ0 || 
	`¡¾’
(portstr) > 10)

324 
pÜt¡r
 = 
CCN_DEFAULT_UNICAST_PORT
;

325 
	`uÇme
(&
un
);

326 
pid
 = 
	`g‘pid
();

328 
	`cúd_cŞËù_¡©s
(
h
, &
¡©s
);

329 
	`cú_ch¬buf_putf
(
b
,

339 "</h—d>" 
NL


341 "<°şass='h—d”'>% cúd[%d]†oÿÈpÜˆ%s</p>" 
NL


343 " %d stÜed, %lu sË, %d s·r£, %lu du¶iÿ‹, %lu s’t</div>" 
NL


345 " %ld…’dšg, %ld…rİag©šg, %ld‚Ùed</div>" 
NL


347 " %lu drİ³d, %lu s’t, %lu stufãd</div>" 
NL
,

348 
un
.
nod’ame
,

349 
pid
,

350 
	`cúd_cŞÜhash
(
h
),

351 
un
.
nod’ame
,

352 
pid
,

353 
pÜt¡r
,

354 ()
h
->
acûssiÚ
,

355 
	`hashtb_n
(
h
->
cÚ‹Á_b
),

356 
h
->
n_¡®e
,

357 
	`hashtb_n
(
h
->
¥¬£_¡¿ggËr_b
),

358 
h
->
cÚ‹Á_dups_»cvd
,

359 
h
->
cÚ‹Á_™ems_£Á
,

360 
	`hashtb_n
(
h
->
Çm•»fix_b
), 
¡©s
.
tÙ®_š‹»¡_couÁs
,

361 
	`hashtb_n
(
h
->
´İag©šg_b
è- 
¡©s
.
tÙ®_æood_cÚŒŞ
,

362 
¡©s
.
tÙ®_æood_cÚŒŞ
,

363 
h
->
š‹»¡s_acû±ed
, h->
š‹»¡s_drİ³d
,

364 
h
->
š‹»¡s_£Á
, h->
š‹»¡s_¡ufãd
);

366 
	`cú_ch¬buf_putf
(
b
,

367 "<div><b>Aùivçû ªd†i¡’”s:</b> %d</div>" 
NL
,

368 
	`hashtb_n
(
h
->
çûs_by_fd
è+ hashtb_n(h->
dg¿m_çûs
));

369 
	`cŞËù_çûs_html
(
h
, 
b
);

370 
	`cŞËù_fÜw¬dšg_html
(
h
, 
b
);

371 
	`cú_ch¬buf_putf
(
b
,

373 "</html>" 
NL
);

374 (
b
);

375 
	}
}

380 
	$cŞËù_çûs_xml
(
cúd_hªdË
 *
h
, 
cú_ch¬buf
 *
b
)

382 
i
;

383 
cú_ch¬buf
 *
nodebuf
;

384 
pÜt
;

386 
nodebuf
 = 
	`cú_ch¬buf_ü—‹
();

387 
	`cú_ch¬buf_putf
(
b
, "<faces>");

388 
i
 = 0; i < 
h
->
çû_lim™
; i++) {

389 
çû
 *çû = 
h
->
çûs_by_çûid
[
i
];

390 ià(
çû
 !ğ
NULL
 && (çû->
æags
 & 
CCN_FACE_UNDECIDED
) == 0) {

391 
	`cú_ch¬buf_putf
(
b
, "<face>");

392 
	`cú_ch¬buf_putf
(
b
,

395 
çû
->
çûid
, faû->
æags
);

396 
	`cú_ch¬buf_putf
(
b
, "<pending>%d</pending>",

397 
çû
->
³ndšg_š‹»¡s
);

398 
	`cú_ch¬buf_putf
(
b
, "<recvcount>%d</recvcount>",

399 
çû
->
»cvcouÁ
);

400 
nodebuf
->
Ëngth
 = 0;

401 
pÜt
 = 
	`cú_ch¬buf_­³nd_sockaddr
(
nodebuf
, 
çû
->
addr
);

402 ià(
pÜt
 > 0) {

403 cÚ¡ *
node
 = 
	`cú_ch¬buf_as_¡ršg
(
nodebuf
);

404 
	`cú_ch¬buf_putf
(
b
, "<>%s:%d</>", 
node
, 
pÜt
);

406 ià(
çû
->
£ndçû
 !ğçû->
çûid
 &&

407 
çû
->
£ndçû
 !ğ
CCN_NOFACEID
)

408 
	`cú_ch¬buf_putf
(
b
, "<vŸ>%u</vŸ>", 
çû
->
£ndçû
);

409 
	`cú_ch¬buf_putf
(
b
, "</çû>" 
NL
);

412 
	`cú_ch¬buf_putf
(
b
, "</faces>");

413 
	`cú_ch¬buf_de¡roy
(&
nodebuf
);

414 
	}
}

417 
	$cŞËù_fÜw¬dšg_xml
(
cúd_hªdË
 *
h
, 
cú_ch¬buf
 *
b
)

419 
hashtb_’um”©Ü
 
“
;

420 
hashtb_’um”©Ü
 *
e
 = &
“
;

421 
cú_fÜw¬dšg
 *
f
;

422 
»s
;

423 
cú_ch¬buf
 *
Çme
 = 
	`cú_ch¬buf_ü—‹
();

425 
	`cú_ch¬buf_putf
(
b
, "<forwarding>");

426 
	`hashtb_¡¬t
(
h
->
Çm•»fix_b
, 
e
);

427 ; 
e
->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

428 
Çm•»fix_’Œy
 *
e
 = 
e
->
d©a
;

429 
f
 = 
e
->
fÜw¬dšg
, 
»s
 = 0; f !ğ
NULL
 && !»s; f = f->
Ãxt
) {

430 ià((
f
->
æags
 & 
CCN_FORW_ACTIVE
) != 0)

431 
»s
 = 1;

433 ià(
»s
) {

434 
	`cú_Çme_š™
(
Çme
);

435 
»s
 = 
	`cú_Çme_­³nd_compÚ’ts
(
Çme
, 
e
->
key
, 0,ƒ->
keysize
);

436 
	`cú_ch¬buf_putf
(
b
, "<fentry>");

437 
	`cú_ch¬buf_putf
(
b
, "<prefix>");

438 
	`cú_uri_­³nd
(
b
, 
Çme
->
buf
,‚ame->
Ëngth
, 1);

439 
	`cú_ch¬buf_putf
(
b
, "</prefix>");

440 
f
 = 
e
->
fÜw¬dšg
; f !ğ
NULL
; f = f->
Ãxt
) {

441 ià((
f
->
æags
 & 
CCN_FORW_ACTIVE
) != 0) {

442 
	`cú_ch¬buf_putf
(
b
,

448 
f
->
çûid
, f->
æags
, f->
expœes
);

451 
	`cú_ch¬buf_putf
(
b
, "</fentry>");

454 
	`hashtb_’d
(
e
);

455 
	`cú_ch¬buf_de¡roy
(&
Çme
);

456 
	`cú_ch¬buf_putf
(
b
, "</forwarding>");

457 
	}
}

459 
cú_ch¬buf
 *

460 
	$cŞËù_¡©s_xml
(
cúd_hªdË
 *
h
)

462 
cúd_¡©s
 
¡©s
 = {0};

463 
cú_ch¬buf
 *
b
 = 
	`cú_ch¬buf_ü—‹
();

465 
	`cúd_cŞËù_¡©s
(
h
, &
¡©s
);

466 
	`cú_ch¬buf_putf
(
b
,

486 ()
h
->
acûssiÚ
,

487 
	`hashtb_n
(
h
->
cÚ‹Á_b
),

488 
h
->
n_¡®e
,

489 
	`hashtb_n
(
h
->
¥¬£_¡¿ggËr_b
),

490 
h
->
cÚ‹Á_dups_»cvd
,

491 
h
->
cÚ‹Á_™ems_£Á
,

492 
	`hashtb_n
(
h
->
Çm•»fix_b
), 
¡©s
.
tÙ®_š‹»¡_couÁs
,

493 
	`hashtb_n
(
h
->
´İag©šg_b
è- 
¡©s
.
tÙ®_æood_cÚŒŞ
,

494 
¡©s
.
tÙ®_æood_cÚŒŞ
,

495 
h
->
š‹»¡s_acû±ed
, h->
š‹»¡s_drİ³d
,

496 
h
->
š‹»¡s_£Á
, h->
š‹»¡s_¡ufãd
);

497 
	`cŞËù_çûs_xml
(
h
, 
b
);

498 
	`cŞËù_fÜw¬dšg_xml
(
h
, 
b
);

499 
	`cú_ch¬buf_putf
(
b
, "</cúd>" 
NL
);

500 (
b
);

501 
	}
}

	@ccnd/ccndsmoketest.c

18 
	~<”ºo.h
>

19 
	~<fú.h
>

20 
	~<Ãtdb.h
>

21 
	~<pŞl.h
>

22 
	~<sigÇl.h
>

23 
	~<¡dšt.h
>

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<time.h
>

28 
	~<uni¡d.h
>

29 
	~<¬·/š‘.h
>

30 
	~<sys/ty³s.h
>

31 
	~<sys/sock‘.h
>

32 
	~<Ãtš‘/š.h
>

33 
	~<sys/¡©.h
>

34 
	~<sys/un.h
>

36 #ià
defšed
(
NEED_GETADDRINFO_COMPAT
)

37 
	~"g‘addršfo.h
"

38 
	~"dummyš6.h
"

41 
	~<cú/cúd.h
>

42 
	~<cú/cú_´iv©e.h
>

44 
	#CRLF
 "\r\n"

	)

46 
	g¿wbuf
[1024*1024];

49 
	$´šŒaw
(*
p
, 
n
)

51 
i
, 
l
;

52 
n
 > 0) {

53 
l
 = (
n
 > 40 ? 40 :‚);

54 
i
 = 0; i < 
l
; i++)

55 
	`´štf
(" %c", (' ' <ğ
p
[
i
] &&…[i] <= '~') ?…[i] : '.');

56 
	`´štf
("\n");

57 
i
 = 0; i < 
l
; i++)

58 
	`´štf
("%02X", ()
p
[
i
]);

59 
	`´štf
("\n");

60 
p
 +ğ
l
;

61 
n
 -ğ
l
;

63 
	}
}

66 
	$İ’_loÿl
(
sockaddr_un
 *
§
, cÚ¡ *
v”b
)

68 
sock
;

69 
»s
;

71 
sock
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

72 ià(
sock
 == -1) {

73 
	`³¼Ü
("socket");

74 
	`ex™
(1);

76 
»s
 = 
	`cÚÃù
(
sock
, (
sockaddr
 *)
§
, (*sa));

77 ià(
»s
 =ğ-1 && 
”ºo
 =ğ
ENOENT
) {

79 ià(
v”b
 !ğ
NULL
 && 0 =ğ
	`¡rcmp
(verb, "kill"))

80 
	`ex™
(1);

82 
	`¦“p
(1);

83 
»s
 = 
	`cÚÃù
(
sock
, (
sockaddr
 *)
§
, (*sa));

85 ià(
»s
 == -1) {

86 
	`³¼Ü
((*)
§
->
sun_·th
);

87 
	`ex™
(1);

89 (
sock
);

90 
	}
}

93 
	$İ’_sock‘
(cÚ¡ *
ho¡
, cÚ¡ *
pÜt¡r
, 
sock_ty³
)

95 
»s
;

96 
sock
 = 0;

97 
ÿnÚiÿl_»mÙe
[
NI_MAXHOST
] = "";

98 
addršfo
 *addršfØğ
NULL
;

99 
addršfo
 *
myai
 = 
NULL
;

100 
addršfo
 
hšts
 = {0};

102 ià(
pÜt¡r
 =ğ
NULL
 ||…ortstr[0] == 0)

103 
pÜt¡r
 = 
CCN_DEFAULT_UNICAST_PORT
;

104 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

105 
hšts
.
ai_sockty³
 = 
sock_ty³
;

106 
hšts
.
ai_æags
 = 0;

107 #ifdeà
AI_ADDRCONFIG


108 
hšts
.
ai_æags
 |ğ
AI_ADDRCONFIG
;

110 #ifdeà
AI_NUMERICSERV


111 
hšts
.
ai_æags
 |ğ
AI_NUMERICSERV
;

113 
»s
 = 
	`g‘addršfo
(
ho¡
, 
pÜt¡r
, &
hšts
, &
addršfo
);

114 ià(
»s
 !ğ0 || 
addršfo
 =ğ
NULL
) {

115 
	`årštf
(
¡d”r
, "getaddrinfo(\"%s\", \"%s\", ...): %s\n",

116 
ho¡
, 
pÜt¡r
, 
	`gai_¡»¼Ü
(
»s
));

117 
	`ex™
(1);

120 
»s
 = 
	`g‘Çmešfo
(
addršfo
->
ai_addr
,‡ddršfo->
ai_add¾’
,

121 
ÿnÚiÿl_»mÙe
, (ÿnÚiÿl_»mÙe), 
NULL
, 0, 0);

123 
sock
 = 
	`sock‘
(
addršfo
->
ai_çmy
,‡ddršfo->
ai_sockty³
, 0);

124 ià(
sock
 == -1) {

125 
	`³¼Ü
("socket");

126 
	`ex™
(1);

128 
hšts
.
ai_çmy
 = 
addršfo
->ai_family;

129 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

130 #ifdeà
AI_NUMERICSERV


131 
hšts
.
ai_æags
 |ğ
AI_NUMERICSERV
;

133 
»s
 = 
	`g‘addršfo
(
NULL
, NULL, &
hšts
, &
myai
);

134 ià(
myai
 !ğ
NULL
) {

135 
»s
 = 
	`bšd
(
sock
, (
sockaddr
 *)
myai
->
ai_addr
, myai->
ai_add¾’
);

136 ià(
»s
 == -1) {

137 
	`³¼Ü
("bind");

138 
	`ex™
(1);

141 
»s
 = 
	`cÚÃù
(
sock
, (
sockaddr
 *)
addršfo
->
ai_addr
,‡ddršfo->
ai_add¾’
);

142 ià(
»s
 == -1) {

143 
	`³¼Ü
(
ÿnÚiÿl_»mÙe
);

144 
	`ex™
(1);

146 
	`ä“addršfo
(
addršfo
);

147 ià(
myai
 !ğ
NULL
)

148 
	`ä“addršfo
(
myai
);

149  (
sock
);

150 
	}
}

153 
	$£nd_cúb_fe
(
sock
, 
FILE
 *
msgs
, cÚ¡ *
f’ame
, 
is_dg¿m
)

155 
ssize_t
 
¿wËn
;

156 
ssize_t
 
¤es
;

157 
fd
 = 0;

158 
Œunÿ‹d
 = 0;

159 
ÚemÜe
[1] = {0};

161 ià(
	`¡rcmp
(
f’ame
, "-") != 0) {

162 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

163 ià(
fd
 == -1) {

164 
	`³¼Ü
(
f’ame
);

165 
	`ex™
(-1);

169 
¿wËn
 = 
	`»ad
(
fd
, 
¿wbuf
, (rawbuf));

170 ià(
¿wËn
 == -1) {

171 
	`³¼Ü
(
f’ame
);

172 
	`ex™
(-1);

174 ià(
¿wËn
 =ğ0 && !
is_dg¿m
)

176 ià(
is_dg¿m
 && 
¿wËn
 =ğ(
¿wbuf
))

177 
Œunÿ‹d
 = 
	`»ad
(
fd
, 
ÚemÜe
, 1);

178 ià(
Œunÿ‹d
 == 1)

179 
	`årštf
(
msgs
, "TRUNCATED ");

180 
	`årštf
(
msgs
, "£nd % (%lu by‹s)\n", 
f’ame
, ()
¿wËn
);

181 
¤es
 = 
	`£nd
(
sock
, 
¿wbuf
, 
¿wËn
, 0);

182 ià(
¤es
 == -1) {

183 
	`³¼Ü
("send");

184 
	`ex™
(1);

186 ià(
is_dg¿m
)

189 ià(
fd
 != 0)

190 
	`şo£
(
fd
);

191 
	}
}

194 
	$is_cúb_Çme
(cÚ¡ *
s
)

196 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

197  (
Ën
 > 5 && 0 =ğ
	`¡rÿ£cmp
(
s
 +†en - 5, ".ccnb"));

198 
	}
}

201 
	$wr™e_to_¡»am
(
FILE
 *
out¡»am
, cÚ¡ *
¿wbuf
, 
size_t
 
¿wËn
)

203 
size_t
 
wËn
;

204 
wËn
 = 
	`fwr™e
(
¿wbuf
, 1, 
¿wËn
, 
out¡»am
);

205 ià(
wËn
 !ğ
¿wËn
)

206 
	`årštf
(
¡d”r
, "short write (%ld of %ld)\n",

207 ()
wËn
, ()
¿wËn
);

208 ià(
	`fæush
(
out¡»am
) != 0)

209 
	`³¼Ü
("fflush");

210 
	}
}

213 
	$maš
(
¬gc
, **
¬gv
)

215 
sockaddr_un
 
addr
 = {0};

216 
c
;

217 
pŞlfd
 
fds
[1];

218 
»s
;

219 
ssize_t
 
¿wËn
;

220 
ssize_t
 
wËn
;

221 
sock
;

222 *
f’ame
 = 
NULL
;

223 cÚ¡ *
pÜt¡r
;

224 
m£c
 = 1000;

225 
¬gp
;

226 
FILE
 *
msgs
 = 
¡dout
;

227 
FILE
 *
out¡»am
 = 
NULL
;

228 
udp
 = 0;

229 
tı
 = 0;

230 
»cvloİ
 = 0;

231 
do_pşo£
 = 0;

232 cÚ¡ *
ho¡
 = "localhost";

233 cÚ¡ *
cmd
 = 
NULL
;

235 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "bht:T:u:")) != -1) {

236 
c
) {

238 
out¡»am
 = 
¡dout
;

239 
msgs
 = 
¡d”r
;

242 
m£c
 = 
	`©oi
(
İrg
);

245 
udp
 = 1;

246 
ho¡
 = 
İrg
;

249 
tı
 = 1;

250 
ho¡
 = 
İrg
;

254 
	`årštf
(
¡d”r
, "U§g% %s\n", 
¬gv
[0],

266 
	`ex™
(1);

269 
¬gp
 = 
İtšd
;

270 
pÜt¡r
 = 
	`g‘’v
(
CCN_LOCAL_PORT_ENVNAME
);

271 
	`cú_£tup_sockaddr_un
(
pÜt¡r
, &
addr
);

272 ià(
udp
)

273 
sock
 = 
	`İ’_sock‘
(
ho¡
, 
pÜt¡r
, 
SOCK_DGRAM
);

274 ià(
tı
)

275 
sock
 = 
	`İ’_sock‘
(
ho¡
, 
pÜt¡r
, 
SOCK_STREAM
);

277 
sock
 = 
	`İ’_loÿl
(&
addr
, 
¬gv
[
İtšd
]);

278 
fds
[0].
fd
 = 
sock
;

279 
fds
[0].
ev’ts
 = 
POLLIN
;

280 
fds
[0].
»v’ts
 = 0;

281 
¬gp
 = 
İtšd
; 
¬gv
[¬gp] !ğ
NULL
;‡rgp++) {

282 ià(0 =ğ
	`¡rcmp
(
¬gv
[
¬gp
], "send")) {

283 
f’ame
 = 
¬gv
[
¬gp
 + 1];

284 ià(
f’ame
 =ğ
NULL
)

285 
f’ame
 = "-";

287 
¬gp
++;

288 
	`£nd_cúb_fe
(
sock
, 
msgs
, 
f’ame
, 
udp
);

290 ià(
	`is_cúb_Çme
(
¬gv
[
¬gp
])) {

291 
f’ame
 = 
¬gv
[
¬gp
];

292 
	`£nd_cúb_fe
(
sock
, 
msgs
, 
f’ame
, 
udp
);

294 ià(
»cvloİ
 || 0 =ğ
	`¡rcmp
(
¬gv
[
¬gp
], "recv")) {

295 
»s
 = 
	`pŞl
(
fds
, 1, 
m£c
);

296 ià(
»s
 == -1) {

297 
	`³¼Ü
("poll");

298 
	`ex™
(1);

300 ià(
»s
 == 0) {

301 
	`årštf
(
msgs
, "»cvimed ouˆaá” %d ms\n", 
m£c
);

302 
»cvloİ
 = 0;

305 
¿wËn
 = 
	`»cv
(
sock
, 
¿wbuf
, (rawbuf), 0);

306 ià(
¿wËn
 == -1) {

307 
	`³¼Ü
("recv");

308 
	`ex™
(1);

310 ià(
¿wËn
 == 0)

312 ià(
»cvloİ
)

313 
¬gp
--;

315 
	`årštf
(
msgs
, "»cv oà%lu by‹s\n", ()
¿wËn
);

316 ià(
out¡»am
 !ğ
NULL
)

317 
	`wr™e_to_¡»am
(
out¡»am
, 
¿wbuf
, 
¿wËn
);

319 
	`´šŒaw
(
¿wbuf
, 
¿wËn
);

321 ià(0 =ğ
	`¡rcmp
(
¬gv
[
¬gp
], "kill")) {

322 
	`pŞl
(
fds
, 1, 1);

323 
»s
 = 
	`uÆšk
((*)
addr
.
sun_·th
);

324 ià(
»s
 == 0) {

325 
»s
 = 
	`İ’_sock‘
(
ho¡
, 
pÜt¡r
, 
SOCK_STREAM
);

326 ià(
»s
 != -1) {

327 
	`wr™e
(
»s
, " ", 1);

328 
	`şo£
(
»s
);

330 
	`pŞl
(
fds
, 1, 5000);

331 
¿wËn
 = 
	`»cv
(
sock
, 
¿wbuf
, (rawbuf), 0);

332 ià(
¿wËn
 == 0)

333 
	`ex™
(0);

334 ià(
¿wËn
 > 0)

335 
	`ex™
(2);

337 
	`årštf
(
¡d”r
, "% kÈ(%sè", 
¬gv
[0], (*)
addr
.
sun_·th
);

338 
	`³¼Ü
("failed");

339 
	`ex™
(1);

341 ià(0 =ğ
	`¡rcmp
(
¬gv
[
¬gp
], "timeo")) {

342 ià(
¬gv
[
¬gp
 + 1] !ğ
NULL
)

343 
m£c
 = 
	`©oi
(
¬gv
[++
¬gp
]);

345 ià(
udp
 =ğ0 && 0 =ğ
	`¡rcmp
(
¬gv
[
¬gp
], "status")) {

346 
msgs
 = 
¡d”r
;

347 
cmd
 = ("sed -e 's=[<]style .*/style[>]==g' -e 's=[<][^>]*[>]==g'|"

349 
out¡»am
 = 
	`pİ’
(
cmd
, "w");

350 
wËn
 = 
	`£nd
(
sock
, "GET / " 
CRLF
 , 8, 0);

351 
»cvloİ
 = 1;

352 
do_pşo£
 = 1;

353 
¬gp
--;

356 
	`årštf
(
¡d”r
, "%s: unknown verb %s,ry -h switch for usage\n",

357 
¬gv
[0],‡rgv[
¬gp
]);

358 
	`ex™
(1);

361 ià(
do_pşo£
)

362 
	`pşo£
(
out¡»am
);

363 
	`ex™
(0);

364 
	}
}

	@cmd/ccn_ccnbtoxml.c

21 
	~<fú.h
>

22 
	~<lim™s.h
>

23 
	~<¡ddef.h
>

24 
	~<¡dio.h
>

25 
	~<¡dšt.h
>

26 
	~<¡dlib.h
>

27 
	~<¡ršg.h
>

28 
	~<uni¡d.h
>

29 
	~<ùy³.h
>

31 
	~<cú/ch¬buf.h
>

32 
	~<cú/codšg.h
>

33 
	~<cú/ex‹nd_diù.h
>

36 
	$u§ge
(cÚ¡ *
´ogÇme
)

38 
	`årštf
(
¡d”r
,

52 
´ogÇme
);

53 
	`ex™
(1);

54 
	}
}

56 
	#CCN_NO_SCHEMA
 
INT_MIN


	)

57 
	#CCN_UNKNOWN_SCHEMA
 (
INT_MIN
+1)

	)

59 
	scú_decod”_¡ack_™em
 {

60 
size_t
 
	mÇmešdex
;

61 
size_t
 
	m§vedss
;

62 
	m§ved_schema
;

63 
	m§ved_schema_¡©e
;

64 
cú_decod”_¡ack_™em
 *
	mlšk
;

67 
	gcú_decod”
;

68 
	eÿÎback_kšd
 {

69 
	mCALLBACK_INITIAL
,

70 
	mCALLBACK_OBJECTEND
,

71 
	mCALLBACK_FINAL


74 (*
	tcú_decod”_ÿÎback
)(

75 
	tcú_decod”
 *
	td
,

76 
	tÿÎback_kšd
 
	tkšd
,

77 *
	td©a


80 
	scú_decod”
 {

81 
¡©e
;

82 
g¡©e
;

83 
b™s
;

84 
size_t
 
numv®
;

85 
uštmax_t
 
bignumv®
;

86 
schema
;

87 
s¡©e
;

88 
cú_decod”_¡ack_™em
 *
¡ack
;

89 
cú_ch¬buf
 *
¡ršg¡ack
;

90 cÚ¡ 
cú_diù_’Œy
 *
gdiù
;

91 
gdiù_couÁ
;

92 
cú_decod”_ÿÎback
 
ÿÎback
;

93 *
ÿÎbackd©a
;

94 
fÜm©tšg_æags
;

95 
ba£64_ch¬_couÁ
;

96 
cú_ch¬buf
 *
ªnÙ©iÚ
;

99 
	#FORCE_BINARY
 (1 << 0)

	)

100 
	#PREFER_HEX
 (1 << 1)

	)

101 
	#VERBOSE_DECODE
 (1 << 2)

	)

103 
cú_decod”
 *

104 
	$cú_decod”_ü—‹
(
fÜm©tšg_æags
, cÚ¡ 
cú_diù
 *
dgs
)

106 
cú_decod”
 *
d
;

107 
d
 = 
	`ÿÎoc
(1, (*d));

108 
d
->
¡ršg¡ack
 = 
	`cú_ch¬buf_ü—‹
();

109 ià(
d
->
¡ršg¡ack
 =ğ
NULL
) {

110 
	`ä“
(
d
);

111 
d
 = 
NULL
;

113 
d
->
schema
 = 
CCN_NO_SCHEMA
;

114 
d
->
gdiù
 = 
dgs
->
diù
;

115 
d
->
gdiù_couÁ
 = 
dgs
->
couÁ
;

116 
d
->
fÜm©tšg_æags
 = formatting_flags;

117 
d
->
ªnÙ©iÚ
 = 
NULL
;

118 (
d
);

119 
	}
}

122 
	$cú_decod”_£t_ÿÎback
(
cú_decod”
 *
d
, 
cú_decod”_ÿÎback
 
c
, *
d©a
)

124 
d
->
ÿÎback
 = 
c
;

125 ià(
c
 =ğ
NULL
) {

126 
d
->
ÿÎbackd©a
 = 
NULL
;

128 
d
->
ÿÎbackd©a
 = 
d©a
;

129 
	`c
(
d
, 
CALLBACK_INITIAL
, 
d©a
);

131 
	}
}

133 
cú_decod”_¡ack_™em
 *

134 
	$cú_decod”_push
(
cú_decod”
 *
d
)

136 
cú_decod”_¡ack_™em
 *
s
;

137 
s
 = 
	`ÿÎoc
(1, (*s));

138 ià(
s
 !ğ
NULL
) {

139 
s
->
lšk
 = 
d
->
¡ack
;

140 
s
->
§vedss
 = 
d
->
¡ršg¡ack
->
Ëngth
;

141 
s
->
§ved_schema
 = 
d
->
schema
;

142 
s
->
§ved_schema_¡©e
 = 
d
->
s¡©e
;

143 
d
->
¡ack
 = 
s
;

145 (
s
);

146 
	}
}

149 
	$cú_decod”_pİ
(
cú_decod”
 *
d
)

151 
cú_decod”_¡ack_™em
 *
s
 = 
d
->
¡ack
;

152 ià(
s
 !ğ
NULL
) {

153 
d
->
¡ack
 = 
s
->
lšk
;

154 
d
->
¡ršg¡ack
->
Ëngth
 = 
s
->
§vedss
;

155 
d
->
schema
 = 
s
->
§ved_schema
;

156 
d
->
s¡©e
 = 
s
->
§ved_schema_¡©e
;

157 
	`ä“
(
s
);

159 
	}
}

162 
	$cú_decod”_de¡roy
(
cú_decod”
 **
dp
)

164 
cú_decod”
 *
d
 = *
dp
;

165 ià(
d
 !ğ
NULL
) {

166 ià(
d
->
ÿÎback
 !ğ
NULL
) {

167 
d
->
	`ÿÎback
(d, 
CALLBACK_FINAL
, d->
ÿÎbackd©a
);

169 
d
->
¡ack
 !ğ
NULL
) {

170 
	`cú_decod”_pİ
(
d
);

172 
	`cú_ch¬buf_de¡roy
(&(
d
->
¡ršg¡ack
));

173 
	`ä“
(
d
);

174 *
dp
 = 
NULL
;

176 
	}
}

179 
	$diù_Çme_äom_numb”
(
ndx
, cÚ¡ 
cú_diù_’Œy
 *
diù
, 
n
)

181 
i
;

182 
i
 = 0; i < 
n
; i++)

183 ià(
ndx
 =ğ
diù
[
i
].
šdex
)

184  (
diù
[
i
].
Çme
);

185  (
NULL
);

186 
	}
}

188 cÚ¡ 
	gBa£64
[] =

192 
	$is_‹xt_’codabË
(
p
[], 
size_t
 
¡¬t
, size_ˆ
Ëngth
)

194 
size_t
 
i
;

196 ià(
Ëngth
 == 0)  (0);

197 
i
 = 0; i < 
Ëngth
; i++) {

198 
c
 = 
p
[
¡¬t
 + 
i
];

199 ià(
c
 < ' ' || c > '~')  (0);

200 ià(
c
 == '<' || c == '>' || c == '&')  (0);

203 
	}
}

207 
	$´št_³rûÁ_esÿ³d
(cÚ¡ *
d©a
, 
size_t
 
size
)

209 
size_t
 
i
;

210 
ch
;

211 
i
 = 0; i < 
size
 && 
d©a
[i] == '.'; i++)

214 ià(
i
 =ğ
size
)

215 
	`´štf
("...");

216 
i
 = 0; i < 
size
; i++) {

217 
ch
 = 
d©a
[
i
];

222 ià(('a' <ğ
ch
 && ch <= 'z') ||

223 ('A' <ğ
ch
 && ch <= 'Z') ||

224 ('0' <ğ
ch
 && ch <= '9') ||

225 
ch
 == '-' || ch == '.' || ch == '_' || ch == '~')

226 
	`´štf
("%c", 
ch
);

228 
	`´štf
("%%%02X", ()
ch
);

230 
	}
}

232 
ssize_t


233 
	$cú_decod”_decode
(
cú_decod”
 *
d
, 
p
[], 
size_t
 
n
)

235 
¡©e
 = 
d
->state;

236 
g¡©e
 = 0;

237 
size_t
 
numv®
 = 
d
->numval;

238 
ssize_t
 
i
 = 0;

239 
c
;

240 
size_t
 
chunk
;

241 
cú_decod”_¡ack_™em
 *
s
;

242 cÚ¡ *
gÇme
;

243 
i
 < 
n
) {

244 
¡©e
) {

246 ià(
g¡©e
 > 1 &&agstate-- == 2) {

247 
	`´štf
("\"");

248 
	`cú_decod”_pİ
(
d
);

250 ià(
p
[
i
] =ğ
CCN_CLOSE
) {

251 
i
++;

252 
s
 = 
d
->
¡ack
;

253 ià(
s
 =ğ
NULL
 || 
g¡©e
 > 1) {

254 
¡©e
 = -
__LINE__
;

257 ià(
g¡©e
 == 1) {

258 
g¡©e
 = 0;

259 
	`´štf
("/>");

261 ià(
d
->
schema
 =ğ-1-
CCN_PROCESSING_INSTRUCTIONS
) {

262 
	`´štf
("?>");

263 ià(
d
->
s¡©e
 != 2) {

264 
¡©e
 = -
__LINE__
;

269 
	`´štf
("</%s>", 
d
->
¡ršg¡ack
->
buf
 + 
s
->
Çmešdex
);

271 ià(
d
->
ªnÙ©iÚ
 !ğ
NULL
) {

272 ià(
d
->
ªnÙ©iÚ
->
Ëngth
 > 0) {

273 
	`´štf
("<!-- ");

274 
	`´št_³rûÁ_esÿ³d
(
d
->
ªnÙ©iÚ
->
buf
, d->ªnÙ©iÚ->
Ëngth
);

275 
	`´štf
(" -->");

277 
	`cú_ch¬buf_de¡roy
(&
d
->
ªnÙ©iÚ
);

279 
	`cú_decod”_pİ
(
d
);

280 ià(
d
->
¡ack
 =ğ
NULL
) {

281 ià(
d
->
ÿÎback
 !ğ
NULL
)

282 
d
->
	`ÿÎback
(d, 
CALLBACK_OBJECTEND
, d->
ÿÎbackd©a
);

284 
	`´štf
("\n");

288 
numv®
 = 0;

289 
¡©e
 = 1;

292 
c
 = 
p
[
i
++];

293 ià((
c
 & 
CCN_TT_HBIT
è=ğ
CCN_CLOSE
) {

294 ià(
numv®
 > (numval << 7)) {

295 
¡©e
 = 9;

296 
d
->
bignumv®
 = 
numv®
;

297 
i
--;

300 
numv®
 = (numv® << 7è+ (
c
 & 127);

301 ià(
numv®
 > (numv® << (7-
CCN_TT_BITS
))) {

302 
¡©e
 = 9;

303 
d
->
bignumv®
 = 
numv®
;

307 
numv®
 = (numv® << (7-
CCN_TT_BITS
)) +

308 ((
c
 >> 
CCN_TT_BITS
è& 
CCN_MAX_TINY
);

309 
c
 &ğ
CCN_TT_MASK
;

310 
c
) {

311 
CCN_EXT
:

312 ià(
g¡©e
 == 1) {

313 
g¡©e
 = 0;

314 
	`´štf
(">");

316 
s
 = 
	`cú_decod”_push
(
d
);

317 
s
->
Çmešdex
 = 
d
->
¡ršg¡ack
->
Ëngth
;

318 
d
->
schema
 = -1-
numv®
;

319 
d
->
s¡©e
 = 0;

320 
numv®
) {

321 
CCN_PROCESSING_INSTRUCTIONS
:

322 
	`´štf
("<?");

325 
¡©e
 = -
__LINE__
;

327 
¡©e
 = 0;

329 
CCN_DTAG
:

330 ià(
g¡©e
 == 1) {

331 
g¡©e
 = 0;

332 
	`´štf
(">");

334 
s
 = 
	`cú_decod”_push
(
d
);

335 
s
->
Çmešdex
 = 
d
->
¡ršg¡ack
->
Ëngth
;

336 
d
->
schema
 = 
numv®
;

337 
d
->
s¡©e
 = 0;

338 
gÇme
 = 
NULL
;

339 ià(
numv®
 <ğ
INT_MAX
)

340 
gÇme
 = 
	`diù_Çme_äom_numb”
(
numv®
, 
d
->
gdiù
, d->
gdiù_couÁ
);

341 ià(
gÇme
 =ğ
NULL
) {

342 
	`årštf
(
¡d”r
,

344 ()
numv®
);

345 
	`cú_ch¬buf_­³nd
(
d
->
¡ršg¡ack
,

348 
	`´štf
("<%s code=\"%lu\"",

349 
d
->
¡ršg¡ack
->
buf
 + 
s
->
Çmešdex
,

350 ()
d
->
schema
);

351 
d
->
schema
 = 
CCN_UNKNOWN_SCHEMA
;

354 
	`cú_ch¬buf_­³nd
(
d
->
¡ršg¡ack
, 
gÇme
, 
	`¡¾’
(tagname)+1);

355 
	`´štf
("<%s", 
gÇme
);

357 ià((
d
->
fÜm©tšg_æags
 & 
VERBOSE_DECODE
) != 0) {

358 ià(
d
->
ªnÙ©iÚ
 !ğ
NULL
)

359 
	`abÜt
();

360 ià(
numv®
 == 15 )

361 
d
->
ªnÙ©iÚ
 = 
	`cú_ch¬buf_ü—‹
();

363 
g¡©e
 = 1;

364 
¡©e
 = 0;

366 
CCN_BLOB
:

367 ià(
g¡©e
 == 1) {

368 
g¡©e
 = 0;

369 ià((
d
->
fÜm©tšg_æags
 & 
FORCE_BINARY
è=ğ0 && 
	`is_‹xt_’codabË
(
p
, 
i
, 
numv®
)) {

370 
	`´štf
(" ccnbencoding=\"text\">");

371 
¡©e
 = 6;

373 ià((
d
->
fÜm©tšg_æags
 & 
PREFER_HEX
) != 0) {

374 
	`´štf
(" ccnbencoding=\"hexBinary\">");

375 
¡©e
 = 2;

378 
	`´štf
(" ccnbencoding=\"base64Binary\">");

379 
¡©e
 = 10;

383 
	`årštf
(
¡d”r
, "blob‚otagged in xml output\n");

384 
¡©e
 = 10;

386 
¡©e
 = (
numv®
 == 0) ? 0 : state;

387 
d
->
ba£64_ch¬_couÁ
 = 0;

389 
CCN_UDATA
:

390 ià(
g¡©e
 == 1) {

391 
g¡©e
 = 0;

392 
	`´štf
(">");

394 
¡©e
 = 3;

395 ià(
d
->
schema
 =ğ-1-
CCN_PROCESSING_INSTRUCTIONS
) {

396 ià(
d
->
s¡©e
 > 0) {

397 
	`´štf
(" ");

399 
¡©e
 = 6;

400 
d
->
s¡©e
 += 1;

402 ià(
numv®
 == 0)

403 
¡©e
 = 0;

405 
CCN_DATTR
:

406 ià(
g¡©e
 != 1) {

407 
¡©e
 = -
__LINE__
;

410 
s
 = 
	`cú_decod”_push
(
d
);

411 
	`cú_ch¬buf_»£rve
(
d
->
¡ršg¡ack
, 1);

412 
s
->
Çmešdex
 = 
d
->
¡ršg¡ack
->
Ëngth
;

413 
	`´štf
(" UNKNOWN_DATTR_%lu=\"", ()
numv®
);

414 
g¡©e
 = 3;

415 
¡©e
 = 0;

417 
CCN_ATTR
:

418 ià(
g¡©e
 != 1) {

419 
¡©e
 = -
__LINE__
;

422 
numv®
 += 1;

423 
s
 = 
	`cú_decod”_push
(
d
);

424 
	`cú_ch¬buf_»£rve
(
d
->
¡ršg¡ack
, 
numv®
 + 1);

425 
s
->
Çmešdex
 = 
d
->
¡ršg¡ack
->
Ëngth
;

426 
¡©e
 = 5;

428 
CCN_TAG
:

429 ià(
g¡©e
 == 1) {

430 
g¡©e
 = 0;

431 
	`´štf
(">");

433 
numv®
 += 1;

434 
s
 = 
	`cú_decod”_push
(
d
);

435 
	`cú_ch¬buf_»£rve
(
d
->
¡ršg¡ack
, 
numv®
 + 1);

436 
s
->
Çmešdex
 = 
d
->
¡ršg¡ack
->
Ëngth
;

437 
¡©e
 = 4;

440 
¡©e
 = -
__LINE__
;

445 
c
 = 
p
[
i
++];

446 ià(
d
->
ªnÙ©iÚ
 !ğ
NULL
)

447 
	`cú_ch¬buf_­³nd_v®ue
(
d
->
ªnÙ©iÚ
, 
c
, 1);

448 
	`´štf
("%02X", 
c
);

449 ià(--
numv®
 == 0) {

450 
¡©e
 = 0;

454 
c
 = 
p
[
i
++];

455 ià(--
numv®
 == 0) {

456 
¡©e
 = 0;

458 
c
) {

460 
¡©e
 = -
__LINE__
;

463 
	`´štf
("&amp;");

466 
	`´štf
("&lt;");

469 
	`´štf
("&gt;");

472 
	`´štf
("&quot;");

475 
	`´štf
("%c", 
c
);

480 
chunk
 = 
n
 - 
i
;

481 ià(
chunk
 > 
numv®
) {

482 
chunk
 = 
numv®
;

484 ià(
chunk
 == 0) {

485 
¡©e
 = -
__LINE__
;

488 
	`cú_ch¬buf_­³nd
(
d
->
¡ršg¡ack
, 
p
 + 
i
, 
chunk
);

489 
numv®
 -ğ
chunk
;

490 
i
 +ğ
chunk
;

491 ià(
numv®
 == 0) {

492 
	`cú_ch¬buf_­³nd
(
d
->
¡ršg¡ack
, (const *)"\0", 1);

493 
s
 = 
d
->
¡ack
;

494 ià(
s
 =ğ
NULL
 ||

495 
	`¡¾’
((*)
d
->
¡ršg¡ack
->
buf
 + 
s
->
Çmešdex
) !=

496 
d
->
¡ršg¡ack
->
Ëngth
 -1 - 
s
->
Çmešdex
) {

497 
¡©e
 = -
__LINE__
;

500 ià(
¡©e
 == 4) {

501 
	`´štf
("<%s", 
d
->
¡ršg¡ack
->
buf
 + 
s
->
Çmešdex
);

502 
g¡©e
 = 1;

505 
	`´štf
(" %s=\"", 
d
->
¡ršg¡ack
->
buf
 + 
s
->
Çmešdex
);

506 
g¡©e
 = 3;

508 
¡©e
 = 0;

512 
c
 = 
p
[
i
++];

513 ià(--
numv®
 == 0) {

514 
¡©e
 = 0;

516 
	`´štf
("%c", 
c
);

519 
c
 = 
p
[
i
++];

520 ià((
c
 & 
CCN_TT_HBIT
è=ğ
CCN_CLOSE
) {

521 
d
->
bignumv®
 = (d->bignumv® << 7è+ (
c
 & 127);

524 
d
->
bignumv®
 = (d->bignumv® << (7-
CCN_TT_BITS
)) +

525 ((
c
 >> 
CCN_TT_BITS
è& 
CCN_MAX_TINY
);

526 
c
 &ğ
CCN_TT_MASK
;

527 ià(
g¡©e
 == 1) {

528 
g¡©e
 = 0;

529 
	`´štf
(">");

536 
c
) {

538 
¡©e
 = -
__LINE__
;

543 
c
 = 
p
[
i
++];

544 ià(
d
->
ªnÙ©iÚ
 !ğ
NULL
)

545 
	`cú_ch¬buf_­³nd_v®ue
(
d
->
ªnÙ©iÚ
, 
c
, 1);

546 
	`´štf
("%c", 
Ba£64
[
c
 >> 2]);

547 
d
->
ba£64_ch¬_couÁ
++;

548 ià(--
numv®
 == 0) {

549 
	`´štf
("%c==", 
Ba£64
[(
c
 & 3) << 4]);

550 
¡©e
 = 0;

551 
d
->
ba£64_ch¬_couÁ
 += 3;

554 
d
->
b™s
 = (
c
 & 3);

555 
¡©e
 = 11;

557 ià((
d
->
fÜm©tšg_æags
 & 
FORCE_BINARY
è=ğ0 && d->
ba£64_ch¬_couÁ
 >= 64) {

558 
d
->
ba£64_ch¬_couÁ
 = 0;

559 
	`´štf
("\n");

563 
c
 = 
p
[
i
++];

564 ià(
d
->
ªnÙ©iÚ
 !ğ
NULL
)

565 
	`cú_ch¬buf_­³nd_v®ue
(
d
->
ªnÙ©iÚ
, 
c
, 1);

566 
	`´štf
("%c", 
Ba£64
[((
d
->
b™s
 & 3è<< 4è+ (
c
 >> 4)]);

567 
d
->
ba£64_ch¬_couÁ
++;

568 ià(--
numv®
 == 0) {

569 
	`´štf
("%c=", 
Ba£64
[(
c
 & 0xF) << 2]);

570 
¡©e
 = 0;

571 
d
->
ba£64_ch¬_couÁ
 += 2;

574 
d
->
b™s
 = (
c
 & 0xF);

575 
¡©e
 = 12;

577 ià((
d
->
fÜm©tšg_æags
 & 
FORCE_BINARY
è=ğ0 && d->
ba£64_ch¬_couÁ
 >= 64) {

578 
d
->
ba£64_ch¬_couÁ
 = 0;

579 
	`´štf
("\n");

583 
c
 = 
p
[
i
++];

584 ià(
d
->
ªnÙ©iÚ
 !ğ
NULL
)

585 
	`cú_ch¬buf_­³nd_v®ue
(
d
->
ªnÙ©iÚ
, 
c
, 1);

586 
	`´štf
("%c%c", 
Ba£64
[((
d
->
b™s
 & 0xFè<< 2è+ (
c
 >> 6)],

587 
Ba£64
[
c
 & 0x3F]);

588 
d
->
ba£64_ch¬_couÁ
 += 2;

589 ià(--
numv®
 == 0) {

590 
¡©e
 = 0;

593 
¡©e
 = 10;

595 ià((
d
->
fÜm©tšg_æags
 & 
FORCE_BINARY
è=ğ0 && d->
ba£64_ch¬_couÁ
 >= 64) {

596 
d
->
ba£64_ch¬_couÁ
 = 0;

597 
	`´štf
("\n");

601 
n
 = 
i
;

604 
d
->
¡©e
 = state;

605 
d
->
g¡©e
 =agstate;

606 
d
->
numv®
 =‚umval;

607 (
i
);

608 
	}
}

611 
	$´oûss_d©a
(
cú_decod”
 *
d
, *
d©a
, 
size_t
 
n
)

613 
»s
 = 0;

614 
size_t
 
s
;

615 
	`´štf
("<?xml version=\"1.0\"ƒncoding=\"UTF-8\"?>\n");

616 
s
 = 
	`cú_decod”_decode
(
d
, 
d©a
, 
n
);

617 ià(
d
->
¡©e
 !ğ0 || 
s
 < 
n
 || d->
¡ack
 !ğ
NULL
 || d->
g¡©e
 != 0) {

618 
»s
 = 1;

619 
	`årštf
(
¡d”r
, "error state %d‡fter %d of %d chars\n",

620 ()
d
->
¡©e
, ()
s
, ()
n
);

622 (
»s
);

623 
	}
}

626 
	$´oûss_fd
(
cú_decod”
 *
d
, 
fd
)

628 
cú_ch¬buf
 *
c
 = 
	`cú_ch¬buf_ü—‹
();

629 
ssize_t
 
Ën
;

630 
»s
 = 0;

632 *
p
 = 
	`cú_ch¬buf_»£rve
(
c
, 80);

633 ià(
p
 =ğ
NULL
) {

634 
	`³¼Ü
("ccn_charbuf_reserve");

635 
»s
 = 1;

638 
Ën
 = 
	`»ad
(
fd
, 
p
, 
c
->
lim™
 - c->
Ëngth
);

639 ià(
Ën
 <= 0) {

640 ià(
Ën
 == -1) {

641 
	`³¼Ü
("read");

642 
»s
 = 1;

646 
c
->
Ëngth
 +ğ
Ën
;

648 
	`årštf
(
¡d”r
, " <!-- iÅuˆi %6lu by‹ -->\n", ()
c
->
Ëngth
);

649 
»s
 |ğ
	`´oûss_d©a
(
d
, 
c
->
buf
, c->
Ëngth
);

650 
	`cú_ch¬buf_de¡roy
(&
c
);

651 (
»s
);

652 
	}
}

656 
	$´oûss_fe
(*
·th
, 
fÜm©tšg_æags
, cÚ¡ 
cú_diù
 *
dgs
)

658 
fd
 = 0;

659 
»s
 = 0;

660 
cú_decod”
 *
d
;

662 ià(0 !ğ
	`¡rcmp
(
·th
, "-")) {

663 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

664 ià(-1 =ğ
fd
) {

665 
	`³¼Ü
(
·th
);

670 
d
 = 
	`cú_decod”_ü—‹
(
fÜm©tšg_æags
, 
dgs
);

671 
»s
 = 
	`´oûss_fd
(
d
, 
fd
);

672 
	`cú_decod”_de¡roy
(&
d
);

674 ià(
fd
 > 0)

675 
	`şo£
(
fd
);

676 (
»s
);

677 
	}
}

679 
	sÿÎback_¡©e
 {

680 
	mäagm’t
;

681 *
	mf•»fix
;

685 
	$£t_¡dout
(
cú_decod”
 *
d
, 
ÿÎback_kšd
 
kšd
, *
d©a
)

687 
ÿÎback_¡©e
 *
cs
 = (ÿÎback_¡©*)
d©a
;

688 
f’ame
[256];

689 
FILE
 *
å
;

690 
kšd
) {

691 
CALLBACK_INITIAL
:

692 
CALLBACK_OBJECTEND
:

693 
	`¢´štf
(
f’ame
, (f’ame), "%s%05d.xml", 
cs
->
f•»fix
, cs->
äagm’t
++);

694 
	`årštf
(
¡d”r
, " <!--‡‰achšg stdouˆtØ% --!>\n", 
f’ame
);

695 
å
 = 
	`äeİ’
(
f’ame
, "w+", 
¡dout
);

696 ià(
å
 =ğ
NULL
)

697 
	`³¼Ü
(
f’ame
);

699 
CALLBACK_FINAL
:

700 
	`fæush
(
¡dout
);

701 
	`fşo£
(
¡dout
);

702 
	`ä“
(
cs
);

705 
	}
}

708 
	$´oûss_¥l™_fe
(*
ba£
, *
·th
, 
fÜm©tšg_æags
,

709 cÚ¡ 
cú_diù
 *
dgs
, *
suffix
)

711 
fd
 = 0;

712 
»s
 = 0;

713 
cú_decod”
 *
d
;

714 
ÿÎback_¡©e
 *
cs
;

716 ià(0 !ğ
	`¡rcmp
(
·th
, "-")) {

717 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

718 ià(-1 =ğ
fd
) {

719 
	`³¼Ü
(
·th
);

724 
cs
 = 
	`ÿÎoc
(1, (*cs));

725 
cs
->
f•»fix
 = 
ba£
;

726 
cs
->
äagm’t
 = *
suffix
;

727 
d
 = 
	`cú_decod”_ü—‹
(
fÜm©tšg_æags
, 
dgs
);

728 
	`cú_decod”_£t_ÿÎback
(
d
, 
£t_¡dout
, 
cs
);

729 
»s
 = 
	`´oûss_fd
(
d
, 
fd
);

730 *
suffix
 = 
cs
->
äagm’t
;

731 
	`cú_decod”_de¡roy
(&
d
);

732 ià(
fd
 > 0)

733 
	`şo£
(
fd
);

734 (
»s
);

735 
	}
}

737 
	#L
 (
CCN_TT_HBIT
 & ~
CCN_CLOSE
)

	)

738 
	g‹¡1
[] = {

739 (2 << 
CCN_TT_BITS
è+ 
CCN_TAG
 + 
L
, 'F', 'o', 'o',

740 (0 << 
CCN_TT_BITS
è+ 
CCN_TAG
 + 
L
, 'a',

741 (1 << 
CCN_TT_BITS
è+ 
CCN_UDATA
 + 
L
, 'X',

742 
CCN_CLOSE
,

743 (0 << 
CCN_TT_BITS
è+ 
CCN_TAG
 + 
L
, 'b',

744 (3 << 
CCN_TT_BITS
è+ 
CCN_ATTR
 + 
L
, 't', 'y', 'p', 'e',

745 (5 << 
CCN_TT_BITS
è+ 
CCN_UDATA
 + 
L
, 'e', 'm', 'p', 't', 'y',

746 
CCN_CLOSE
,

747 (2 << 
CCN_TT_BITS
è+ 
CCN_TAG
 + 
L
, 'b', 'i', 'n',

748 (4 << 
CCN_TT_BITS
è+ 
CCN_BLOB
 + 
L
, 1, 0x23, 0x45, 0x67,

749 
CCN_CLOSE
,

750 (
CCN_CLOSE
 + ((20-1è>> (7-
CCN_TT_BITS
))),

751 (((20-1è& 
CCN_TT_MASK
è<< 
CCN_TT_BITS
è+ 
CCN_TAG
 + 
L
,

755 
CCN_CLOSE
,

756 (2 << 
CCN_TT_BITS
è+ 
CCN_TAG
 + 
L
, 'i', 'n', 't',

757 (3 << 
CCN_TT_BITS
è+ 
CCN_ATTR
 + 
L
, 't', 'y', 'p', 'e',

758 (3 << 
CCN_TT_BITS
è+ 
CCN_UDATA
 + 
L
, 'B', 'I', 'G',

759 
CCN_CLOSE
,

760 (6 << 
CCN_TT_BITS
è+ 
CCN_UDATA
 + 
L
,

762 
CCN_CLOSE
,

766 
	$maš
(
¬gc
, **
¬gv
)

768 *
İrg
;

769 
İtšd
, 
İtİt
;

770 
c
;

771 
tæag
 = 0, 
fÜm©tšg_æags
 = 0, 
”ræag
 = 0;

772 *
§rg
 = 
NULL
;

773 
»s
 = 0;

774 
suffix
 = 0;

775 
cú_decod”
 *
d
;

776 
cú_diù
 *
dgs
 = (cú_diù *)&
cú_dg_diù
;

778 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, ":hbd:s:tvx")) != -1) {

779 
c
) {

781 
	`u§ge
(
¬gv
[0]);

784 
fÜm©tšg_æags
 |ğ
FORCE_BINARY
;

787 ià(0 !ğ
	`cú_ex‹nd_diù
(
İrg
, 
dgs
, &dtags)) {

788 
	`årštf
(
¡d”r
, "UÇbËØlßd dg diùiÚ¬y %s\n", 
İrg
);

789 
”ræag
 = 1;

793 
§rg
 = 
İrg
;

796 
tæag
 = 1;

799 
fÜm©tšg_æags
 |ğ
VERBOSE_DECODE
;

802 
fÜm©tšg_æags
 |ğ
PREFER_HEX
;

805 
	`årštf
(
¡d”r
, "UÄecognized o±iÚ: -%c\n", 
İtİt
);

806 
”ræag
 = 1;

809 ià(
tæag
 && (
§rg
 !ğ
NULL
 || 
fÜm©tšg_æags
 != 0))

810 
”ræag
 = 1;

812 ià(
”ræag
 || (
tæag
 && (
İtšd
 < 
¬gc
)))

813 
	`u§ge
(
¬gv
[0]);

815 ià(
tæag
) {

816 
d
 = 
	`cú_decod”_ü—‹
(1, &
cú_dg_diù
);

817 
»s
 |ğ
	`´oûss_d©a
(
d
, 
‹¡1
, (test1));

818 
	`cú_decod”_de¡roy
(&
d
);

819  (
»s
);

822 
suffix
 = 0; 
İtšd
 < 
¬gc
; optind++) {

823 ià(
§rg
) {

824 
	`årštf
(
¡d”r
, "<!-- Proûssšg % štØ% -->\n", 
¬gv
[
İtšd
], 
§rg
);

825 
»s
 |ğ
	`´oûss_¥l™_fe
(
§rg
, 
¬gv
[
İtšd
], 
fÜm©tšg_æags
,

826 
dgs
, &
suffix
);

829 
	`årštf
(
¡d”r
, "<!-- Proûssšg % -->\n", 
¬gv
[
İtšd
]);

830 
»s
 |ğ
	`´oûss_fe
(
¬gv
[
İtšd
], 
fÜm©tšg_æags
, 
dgs
);

833 (
»s
);

834 
	}
}

	@cmd/ccn_splitccnb.c

22 
	~<fú.h
>

23 
	~<sys/ty³s.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/mmª.h
>

26 
	~<lim™s.h
>

27 
	~<¡ddef.h
>

28 
	~<¡dio.h
>

29 
	~<¡dlib.h
>

30 
	~<¡ršg.h
>

31 
	~<uni¡d.h
>

33 
	~<cú/codšg.h
>

35 
	sf¡©e
 {

36 *
	m´efix
;

37 
	m£gnum
;

41 
	$£gm’t_´efix
(*
·th
)

43 *
s
, *
d
, *
r
;

45 
s
 = 
	`¡¼chr
(
·th
, '/');

46 ià(
s
 =ğ
NULL
è ğ
·th
;

47 
d
 = 
	`¡¼chr
(
s
, '.');

48 ià(
d
 =ğ
NULL
èd = 
s
 + 
	`¡¾’
(s);

49 
r
 = 
	`ÿÎoc
(1, 1 + 
d
 - 
·th
);

50 
	`memıy
(
r
, 
·th
, 
d
 -…ath);

51  (
r
);

52 
	}
}

55 
	$wr™e_£gm’t
(*
d©a
, 
size_t
 
s
, 
f¡©e
 *
³rfe¡©e
)

57 
ofd
;

58 
ofe
[256];

59 
mode_t
 
mode
 = 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
;

60 
»s
;

62 
	`¥rštf
(
ofe
, "%s-%05d.cúb", 
³rfe¡©e
->
´efix
,…”fe¡©e->
£gnum
);

63 
ofd
 = 
	`İ’
(
ofe
, 
O_CREAT
 | 
O_WRONLY
 | 
O_TRUNC
, 
mode
);

64 ià(
ofd
 == -1) {

65 
	`³¼Ü
("open");

68 
»s
 = 
	`wr™e
(
ofd
, 
d©a
, 
s
);

69 
	`şo£
(
ofd
);

70 ià(
»s
 !ğ
s
) {

71 
	`³¼Ü
("write");

74 
³rfe¡©e
->
£gnum
++;

76 
	}
}

79 
	$´oûss_‹¡
(*
d©a
, 
size_t
 
n
, 
f¡©e
 *
³rfe¡©e
)

81 
cú_sk–‘Ú_decod”
 
sk–_decod”
 = {0};

82 
cú_sk–‘Ú_decod”
 *
d
 = &
sk–_decod”
;

83 
»s
 = 0;

84 
size_t
 
s
;

86 
»Œy
:

87 
s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
d©a
, 
n
);

88 ià(
d
->
¡©e
 < 0) {

89 
»s
 = 1;

90 
	`årštf
(
¡d”r
, "error state %d‡fter %d of %d chars\n",

91 ()
d
->
¡©e
, ()
s
, ()
n
);

93 ià(
s
 == 0) {

94 
	`årštf
(
¡d”r
, "nothingo do\n");

97 ià(
s
 < 
n
) {

98 ià(
	`wr™e_£gm’t
(
d©a
, 
s
, 
³rfe¡©e
) != 0) {

102 
d©a
 +ğ
s
;

103 
n
 -ğ
s
;

104 
»Œy
;

106 
	`årštf
(
¡d”r
, "\n");

108 ià(!
	`CCN_FINAL_DSTATE
(
d
->
¡©e
)) {

109 
»s
 = 1;

110 
	`årštf
(
¡d”r
, "incomplete state %d‡fter %d of %d chars\n",

111 ()
d
->
¡©e
, ()
s
, ()
n
);

112 } ià(
	`wr™e_£gm’t
(
d©a
, 
s
, 
³rfe¡©e
) != 0) {

113 
»s
 = 1;

115 (
»s
);

116 
	}
}

119 
	$´oûss_fd
(
fd
, 
f¡©e
 *
³rfe¡©e
)

121 *
buf
;

122 
ssize_t
 
Ën
;

123 
¡©
 
s
;

124 
»s
 = 0;

126 
»s
 = 
	`f¡©
(
fd
, &
s
);

127 
Ën
 = 
s
.
¡_size
;

128 
buf
 = (*)
	`mm­
((*)
NULL
, 
Ën
, 
PROT_READ
, 
MAP_PRIVATE
, 
fd
, 0);

129 ià(
buf
 == (*)-1)  (1);

130 
	`årštf
(
¡d”r
, " <!-- iÅuˆi %6lu by‹ -->\n", ()
Ën
);

131 
»s
 |ğ
	`´oûss_‹¡
(
buf
, 
Ën
, 
³rfe¡©e
);

132 
	`munm­
((*)
buf
, 
Ën
);

133 (
»s
);

134 
	}
}

138 
	$´oûss_fe
(*
·th
, 
f¡©e
 *
³rfe¡©e
)

140 
fd
;

141 
»s
 = 0;

143 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

144 ià(-1 =ğ
fd
) {

145 
	`³¼Ü
(
·th
);

149 
³rfe¡©e
->
£gnum
 = 0;

150 ià(
³rfe¡©e
->
´efix
 !ğ
NULL
è
	`ä“
(perfilestate->prefix);

151 
³rfe¡©e
->
´efix
 = 
	`£gm’t_´efix
(
·th
);

153 
»s
 = 
	`´oûss_fd
(
fd
, 
³rfe¡©e
);

154 ià(
fd
 > 0)

155 
	`şo£
(
fd
);

156 (
»s
);

157 
	}
}

160 
	$maš
(
¬gc
, *
¬gv
[])

162 
i
;

163 
»s
 = 0;

164 
f¡©e
 
³rfe¡©e
 = {0};

166 
i
 = 1; 
¬gv
[i] != 0; i++) {

167 
	`årštf
(
¡d”r
, "<!-- Proûssšg % -->\n", 
¬gv
[
i
]);

168 
»s
 |ğ
	`´oûss_fe
(
¬gv
[
i
], &
³rfe¡©e
);

170 (
»s
);

171 
	}
}

	@cmd/ccn_xmltoccnb.c

20 
	~<fú.h
>

21 
	~<¡ddef.h
>

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

25 
	~<uni¡d.h
>

27 
	~<ex·t.h
>

29 
	~<cú/codšg.h
>

30 
	~<cú/ch¬buf.h
>

31 
	~<cú/ex‹nd_diù.h
>

34 
	$u§ge
(cÚ¡ *
´ogÇme
)

36 
	`årštf
(
¡d”r
,

44 
´ogÇme
);

45 
	`ex™
(1);

46 
	}
}

48 
	scú_’cod”_¡ack_™em
 {

49 
size_t
 
	m¡¬t
;

50 
size_t
 
	m’d
;

51 
cú_’cod”_¡ack_™em
 *
	mlšk
;

54 
	scú_’cod”
 {

55 
cú_ch¬buf
 *
	mİ’ud©a
;

56 
	mis_ba£64bš¬y
;

57 
	mis_hexBš¬y
;

58 
	mis_‹xt
;

59 
	mtoss_wh™e
;

60 cÚ¡ 
cú_diù_’Œy
 *
	mgdiù
;

61 
	mgdiù_couÁ
;

62 
FILE
 *
	moutfe
;

65 
	sba£64_decod”
 {

66 
size_t
 
	mšput_´oûs£d
;

67 
size_t
 
	m»suÉ_size
;

68 *
	mouut
;

69 
size_t
 
	mouut_size
;

70 
	m·¹Ÿl
;

71 
	mpha£
;

76 
	$ba£64_decode_by‹s
(
ba£64_decod”
 *
d
, cÚ¡ *
p
, 
size_t
 
couÁ
)

78 
size_t
 
i
;

79 
size_t
 
oi
 = 
d
->
»suÉ_size
;

80 cÚ¡ *
s
 = 
p
;

81 
·¹Ÿl
 = 
d
->partial;

82 
’dgame
 = 
·¹Ÿl
 & 0x100;

83 
pha£
 = 
d
->phase;

84 
ch
;

85 ià(
pha£
 < 0)

87 
i
 = 0; i < 
couÁ
; i++) {

88 
ch
 = 
s
[
i
];

93 ià('A' <ğ
ch
 && ch <= 'Z')

94 
ch
 -= 'A';

95 ià('a' <ğ
ch
 && ch <= 'z')

96 
ch
 -= 'a' - 26;

97 ià('0' <ğ
ch
 && ch <= '9')

98 
ch
 -= '0' - 52;

99 ià(
ch
 == '+')

100 
ch
 = 62;

101 ià(
ch
 == '/')

102 
ch
 = 63;

103 ià(
ch
 == ' ' || ch == '\t' || ch == '\n')

105 ià(
ch
 == '=')

106 ià(
pha£
 > 4 || (
·¹Ÿl
 & 3) != 0)

107 
pha£
 = -1;

109 
pha£
 -= 2;

110 
·¹Ÿl
 >>= 2;

111 
’dgame
 = 0x100;

115 
pha£
 = -1;

118 ià(
’dgame
 != 0) {

119 
pha£
 = -1;

122 
·¹Ÿl
 <<= 6;

123 
·¹Ÿl
 |ğ
ch
;

124 
pha£
 += 6;

125 ià(
pha£
 >= 8) {

126 ià(
oi
 < 
d
->
ouut_size
)

127 
d
->
ouut
[
oi
] = 
·¹Ÿl
 >> (
pha£
 - 8);

128 
oi
 += 1;

129 
pha£
 -= 8;

132 
d
->
pha£
 =…hase;

133 
d
->
·¹Ÿl
 =…artial & ((1<<6)-1);

134 
d
->
»suÉ_size
 = 
oi
;

135 
	}
}

138 
	$diù_lookup
(cÚ¡ *
key
, cÚ¡ 
cú_diù_’Œy
 *
diù
, 
n
)

140 
i
;

141 
i
 = 0; i < 
n
; i++)

142 ià(0 =ğ
	`¡rcmp
(
key
, 
diù
[
i
].
Çme
))

143  (
diù
[
i
].
šdex
);

145 
	}
}

147 
cú_’cod”
 *

148 
	$cú_’cod”_ü—‹
(
FILE
 *
outfe
, cÚ¡ 
cú_diù
 *
dgs
)

150 
cú_’cod”
 *
c
;

151 
c
 = 
	`ÿÎoc
(1, (*c));

152 ià(
c
) {

153 
c
->
İ’ud©a
 = 
	`cú_ch¬buf_ü—‹
();

154 ià(
c
->
İ’ud©a
 !ğ
NULL
)

155 
	`cú_ch¬buf_»£rve
(
c
->
İ’ud©a
, 128);

156 
c
->
outfe
 = outfile;

157 
c
->
gdiù
 = 
dgs
->
diù
;

158 
c
->
gdiù_couÁ
 = 
dgs
->
couÁ
;

160 (
c
);

161 
	}
}

164 
	$cú_’cod”_de¡roy
(
cú_’cod”
 **
cbp
)

166 
cú_’cod”
 *
c
 = *
cbp
;

167 ià(
c
 !ğ
NULL
) {

168 
	`cú_ch¬buf_de¡roy
(&
c
->
İ’ud©a
);

169 
	`ä“
(
c
);

170 *
cbp
 = 
NULL
;

172 
	}
}

175 
	$em™_by‹s
(
cú_’cod”
 *
u
, cÚ¡ *
p
, 
size_t
 
Ëngth
)

178 ()
	`fwr™e
(
p
, 1, 
Ëngth
, 
u
->
outfe
);

179 
	}
}

182 
	$em™_‰
(
cú_’cod”
 *
u
, 
size_t
 
numv®
, 
cú_‰
 
‰
)

184 
buf
[1+8*(((
numv®
)+6)/7)];

185 *
p
 = 
buf
 + ((buf)-1);

186 
n
 = 1;

187 
p
[0] = (
CCN_TT_HBIT
 & ~
CCN_CLOSE
) |

188 ((
numv®
 & 
CCN_MAX_TINY
è<< 
CCN_TT_BITS
) |

189 (
CCN_TT_MASK
 & 
‰
);

190 
numv®
 >>ğ(7-
CCN_TT_BITS
);

191 
numv®
 != 0) {

192 (--
p
)[0] = ((()
numv®
è& ~
CCN_TT_HBIT
è| 
CCN_CLOSE
;

193 
n
++;

194 
numv®
 >>= 7;

196 
	`em™_by‹s
(
u
, 
p
, 
n
);

197 
	}
}

200 
	$®l_wh™e¥aû
(
cú_ch¬buf
 *
b
)

202 
size_t
 
i
;

203 
size_t
 
n
 = 
b
->
Ëngth
;

204 
i
 = 0; i < 
n
; i++) {

205 
b
->
buf
[
i
]) {

214 
	}
}

217 
	$fšish_İ’ud©a
(
cú_’cod”
 *
u
)

219 ià(
u
->
is_ba£64bš¬y
) {

220 *
obuf
 = 
NULL
;

221 
ssize_t
 
Ën
 = -1;

222 
size_t
 
maxbšËn
 = 
u
->
İ’ud©a
->
Ëngth
 * 3 / 4 + 4;

223 
ba£64_decod”
 
d
 = { 0 };

224 
u
->
is_ba£64bš¬y
 = 0;

225 
obuf
 = 
	`cú_ch¬buf_»£rve
(
u
->
İ’ud©a
, 
maxbšËn
);

226 ià(
obuf
 !ğ
NULL
) {

227 
d
.
ouut
 = 
obuf
;

228 
d
.
ouut_size
 = 
maxbšËn
;

229 
	`ba£64_decode_by‹s
(&
d
, 
u
->
İ’ud©a
->
buf
, u->İ’ud©a->
Ëngth
);

230 ià(
d
.
pha£
 =ğ0 && d.
»suÉ_size
 <ğd.
ouut_size
)

231 
Ën
 = 
d
.
»suÉ_size
;

233 ià(
Ën
 == -1) {

234 
	`årštf
(
¡d”r
,

238 
	`em™_‰
(
u
, 
Ën
, 
CCN_BLOB
);

239 
	`em™_by‹s
(
u
, 
obuf
, 
Ën
);

240 
u
->
İ’ud©a
->
Ëngth
 = 0;

244 ià(
u
->
is_hexBš¬y
) {

245 
size_t
 
maxbšËn
 = (
u
->
İ’ud©a
->
Ëngth
 + 1)/2;

246 *
obuf
 = 
NULL
;

247 
v
 = -1;

248 
size_t
 
i
;

249 
size_t
 
j
 = 0;

250 
ch
;

251 
u
->
is_hexBš¬y
 = 0;

252 
obuf
 = 
	`cú_ch¬buf_»£rve
(
u
->
İ’ud©a
, 
maxbšËn
);

253 ià(
obuf
 !ğ
NULL
) {

254 
v
 = 1, 
i
 = 0, 
j
 = 0; v > 0 && i < 
u
->
İ’ud©a
->
Ëngth
; i++) {

255 
ch
 = 
u
->
İ’ud©a
->
buf
[
i
];

256 ià(
ch
 <= ' ')

258 
v
 = (v << 4è+ (('0' <ğ
ch
 && ch <= '9') ? (ch - '0') :

259 ('A' <ğ
ch
 && ch <= 'F') ? (ch - 'A' + 10) :

260 ('a' <ğ
ch
 && ch <= 'f') ? (ch - 'a' + 10) :

262 ià(
v
 > 255) {

263 ià(
j
 >ğ
maxbšËn
)

265 
obuf
[
j
++] = 
v
 & 255;

266 
v
 = 1;

270 ià(
v
 != 1) {

271 
	`årštf
(
¡d”r
,

275 
	`em™_‰
(
u
, 
j
, 
CCN_BLOB
);

276 
	`em™_by‹s
(
u
, 
obuf
, 
j
);

277 
u
->
İ’ud©a
->
Ëngth
 = 0;

281 ià(
u
->
is_‹xt
) {

282 
u
->
is_‹xt
 = 0;

283 
	`em™_‰
(
u
, u->
İ’ud©a
->
Ëngth
, 
CCN_BLOB
);

284 
	`em™_by‹s
(
u
, u->
İ’ud©a
->
buf
, u->İ’ud©a->
Ëngth
);

285 
u
->
İ’ud©a
->
Ëngth
 = 0;

288 ià(
u
->
İ’ud©a
->
Ëngth
 != 0) {

289 ià(!(
u
->
toss_wh™e
 && 
	`®l_wh™e¥aû
(u->
İ’ud©a
))) {

290 
	`em™_‰
(
u
, u->
İ’ud©a
->
Ëngth
, 
CCN_UDATA
);

291 
	`em™_by‹s
(
u
, u->
İ’ud©a
->
buf
, u->İ’ud©a->
Ëngth
);

293 
u
->
İ’ud©a
->
Ëngth
 = 0;

295 
	}
}

298 
	$em™_Çme
(
cú_’cod”
 *
u
, 
cú_‰
 
‰
, cÚ¡ *
Çme
)

300 
size_t
 
Ëngth
 = 
	`¡¾’
(
Çme
);

301 
diùšdex
 = -1;

302 ià(
Ëngth
 == 0) ;

303 
	`fšish_İ’ud©a
(
u
);

304 ià(
‰
 =ğ
CCN_TAG
) {

305 
diùšdex
 = 
	`diù_lookup
(
Çme
, 
u
->
gdiù
, u->
gdiù_couÁ
);

306 ià(
diùšdex
 >= 0) {

307 
	`em™_‰
(
u
, 
diùšdex
, 
CCN_DTAG
);

311 
	`em™_‰
(
u
, 
Ëngth
-1, 
‰
);

312 
	`em™_by‹s
(
u
, 
Çme
, 
Ëngth
);

313 
	}
}

316 
	$em™_xch¬s
(
cú_’cod”
 *
u
, cÚ¡ 
XML_Ch¬
 *
xch¬s
)

318 
size_t
 
Ëngth
 = 
	`¡¾’
(
xch¬s
);

319 
	`fšish_İ’ud©a
(
u
);

320 
	`em™_‰
(
u
, 
Ëngth
, 
CCN_UDATA
);

321 
	`em™_by‹s
(
u
, 
xch¬s
, 
Ëngth
);

322 
	}
}

325 
	$em™_şo£r
(
cú_’cod”
 *
u
)

327 cÚ¡ 
şo£r
[] = { 
CCN_CLOSE
 };

328 
	`fšish_İ’ud©a
(
u
);

329 
	`em™_by‹s
(
u
, 
şo£r
, (closer));

330 
	}
}

333 
	$do_¡¬t_–em’t
(*
ud
, cÚ¡ 
XML_Ch¬
 *
Çme
,

334 cÚ¡ 
XML_Ch¬
 **
©ts
)

336 
cú_’cod”
 *
u
 = 
ud
;

337 cÚ¡ 
XML_Ch¬
 **
©t
;

338 
is_ba£64bš¬y
 = 0;

339 
is_hexBš¬y
 = 0;

340 
is_‹xt
 = 0;

341 
	`em™_Çme
(
u
, 
CCN_TAG
, 
Çme
);

342 
©t
 = 
©ts
;‡‰[0] !ğ
NULL
;‡tt += 2) {

343 ià(0 =ğ
	`¡rcmp
(
©t
[0], "ccnbencoding")) {

344 ià(0 =ğ
	`¡rcmp
(
©t
[1], "base64Binary")) {

345 
is_ba£64bš¬y
 = 1;

348 ià(0 =ğ
	`¡rcmp
(
©t
[1], "hexBinary")) {

349 
is_hexBš¬y
 = 1;

352 ià(0 =ğ
	`¡rcmp
(
©t
[1], "text")) {

353 
is_‹xt
 = 1;

356 
	`årštf
(
¡d”r
, "w¬nšg - unknowÀcúb’codšg found (%s)\n", 
©t
[1]);

358 
	`em™_Çme
(
u
, 
CCN_ATTR
, 
©t
[0]);

359 
	`em™_xch¬s
(
u
, 
©t
[1]);

361 
u
->
is_ba£64bš¬y
 = is_base64binary;

362 
u
->
is_hexBš¬y
 = is_hexBinary;

363 
u
->
is_‹xt
 = is_text;

364 
	}
}

367 
	$do_’d_–em’t
(*
ud
, cÚ¡ 
XML_Ch¬
 *
Çme
)

369 
cú_’cod”
 *
u
 = 
ud
;

370 
	`em™_şo£r
(
u
);

371 
	}
}

374 
	$do_ch¬aù”_d©a
(*
ud
, cÚ¡ 
XML_Ch¬
 *
s
, 
Ën
)

376 
cú_’cod”
 *
u
 = 
ud
;

377 
	`cú_ch¬buf_­³nd
(
u
->
İ’ud©a
, 
s
, 
Ën
);

378 
	}
}

381 
	$do_´oûssšg_š¡ruùiÚs
(*
ud
, cÚ¡ 
XML_Ch¬
 *
rg‘
, cÚ¡ XML_Ch¬ *
d©a
)

383 
cú_’cod”
 *
u
 = 
ud
;

384 
	`fšish_İ’ud©a
(
u
);

385 
	`em™_‰
(
u
, 
CCN_PROCESSING_INSTRUCTIONS
, 
CCN_EXT
);

386 
	`em™_xch¬s
(
u
, 
rg‘
);

387 
	`em™_xch¬s
(
u
, 
d©a
);

388 
	`em™_şo£r
(
u
);

389 
	}
}

391 
	#TOSS_WHITE
 1

	)

393 
	$´oûss_fd
(
fd
, 
FILE
 *
outfe
, 
æags
, cÚ¡ 
cú_diù
 *
dgs
)

395 
buf
[17];

396 
ssize_t
 
Ën
;

397 
»s
 = 0;

398 
cú_’cod”
 *
u
;

399 
XML_P¬£r
 
p
;

400 
u
 = 
	`cú_’cod”_ü—‹
(
outfe
, 
dgs
);

401 ià(
u
 =ğ
NULL
) (1);

402 ià(
æags
 & 
TOSS_WHITE
) {

403 
u
->
toss_wh™e
 = 1;

405 
p
 = 
	`XML_P¬£rC»©e
(
NULL
);

406 
	`XML_S‘U£rD©a
(
p
, 
u
);

407 
	`XML_S‘EËm’tHªdËr
(
p
, &
do_¡¬t_–em’t
, &
do_’d_–em’t
);

408 
	`XML_S‘Ch¬aù”D©aHªdËr
(
p
, &
do_ch¬aù”_d©a
);

409 
	`XML_S‘ProûssšgIn¡ruùiÚHªdËr
(
p
, &
do_´oûssšg_š¡ruùiÚs
);

411 (
Ën
 = 
	`»ad
(
fd
, 
buf
, (buf))) > 0) {

412 ià(
	`XML_P¬£
(
p
, 
buf
, 
Ën
, 0è!ğ
XML_STATUS_OK
) {

413 
»s
 |= 1;

417 ià(
Ën
 < 0) {

418 
	`³¼Ü
("read");

419 
»s
 |= 1;

421 ià(
	`XML_P¬£
(
p
, 
buf
, 0, 1è!ğ
XML_STATUS_OK
) {

422 
	`årštf
(
¡d”r
, "xmÈ·r£ƒ¼Ü†š%ld\n", ()
	`XML_G‘Cu¼’tLšeNumb”
(
p
));

423 
»s
 |= 1;

425 
	`XML_P¬£rF»e
(
p
);

426 
	`cú_’cod”_de¡roy
(&
u
);

428 (
»s
);

429 
	}
}

432 
	$´oûss_fe
(*
·th
, 
æags
, cÚ¡ 
cú_diù
 *
dgs
)

434 
fd
 = 0;

435 
»s
 = 0;

436 
FILE
 *
outfe
 = 
¡dout
;

437 cÚ¡ *
ba£Çme
;

438 cÚ¡ *
ext
;

439 *
ouŠame
 = 
NULL
;

440 cÚ¡ 
ou‹xt
[] = ".ccnb\0";

441 ià(0 !ğ
	`¡rcmp
(
·th
, "-")) {

442 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

443 ià(-1 =ğ
fd
) {

444 
	`³¼Ü
(
·th
);

447 
ba£Çme
 = 
	`¡¼chr
(
·th
, '/');

448 ià(
ba£Çme
 =ğ
NULL
)

449 
ba£Çme
 = 
·th
;

451 
ba£Çme
++;

452 
ext
 = 
	`¡¼chr
(
ba£Çme
, '.');

453 ià(
ext
 =ğ
NULL
 || 0 !ğ
	`¡rÿ£cmp
(ext, ".xml"))

454 
ext
 = 
	`¡¼chr
(
ba£Çme
, 0);

455 
ouŠame
 = 
	`ÿÎoc
(1, 
ext
 - 
ba£Çme
 + (
ou‹xt
));

456 ià(
ouŠame
 =ğ
NULL
è{ 
	`³¼Ü
("ÿÎoc"); 
	`ex™
(1); }

457 
	`memıy
(
ouŠame
, 
ba£Çme
, 
ext
 - basename);

458 
	`memıy
(
ouŠame
 + (
ext
 - 
ba£Çme
), 
ou‹xt
, (outext));

459 
outfe
 = 
	`fİ’
(
ouŠame
, "wb");

460 ià(
outfe
 =ğ
NULL
) {

461 
	`³¼Ü
(
ouŠame
);

462 
	`ä“
(
ouŠame
);

463 
ouŠame
 = 
NULL
;

464 
»s
 |= 1;

467 ià(
»s
 == 0) {

468 
»s
 = 
	`´oûss_fd
(
fd
, 
outfe
, 
æags
, 
dgs
);

469 
	`fæush
(
outfe
);

471 ià(
outfe
 !ğ
NULL
 && outf!ğ
¡dout
) {

472 ià(
	`ã¼Ü
(
outfe
)) {

473 
»s
 |= 1;

474 
	`årštf
(
¡d”r
, " %s: ouuˆ”rÜ\n", 
ouŠame
);

475 
	`ş—»¼
(
outfe
);

477 
	`fşo£
(
outfe
);

478 ià(
»s
 == 0)

479 
	`årštf
(
¡d”r
, " % wr™‹n.\n", 
ouŠame
);

481 ià(
fd
 > 0)

482 
	`şo£
(
fd
);

483 ià(
»s
 !ğ0 && 
ouŠame
 !ğ
NULL
) {

484 
	`uÆšk
(
ouŠame
);

486 ià(
ouŠame
 !ğ
NULL
)

487 
	`ä“
(
ouŠame
);

488 (
»s
);

489 
	}
}

492 
	$maš
(
¬gc
, **
¬gv
)

494 
i
;

495 
»s
 = 0;

496 
diù»s
 = 0;

497 
æags
 = 0;

498 
cú_diù
 *
dgs
 = (cú_diù *)&
cú_dg_diù
;

500 ià(
¬gv
[1] =ğ
NULL
)

501 
	`u§ge
(
¬gv
[0]);

502 
i
 = 1; 
¬gv
[i] != 0; i++) {

503 ià(0 =ğ
	`¡rcmp
(
¬gv
[
i
], "-h")) {

504 
	`u§ge
(
¬gv
[0]);

506 ià(0 =ğ
	`¡rcmp
(
¬gv
[
i
], "-w")) {

507 
æags
 |ğ
TOSS_WHITE
;

510 ià(0 =ğ
	`¡rcmp
(
¬gv
[
i
], "-d")) {

511 ià(
¬gv
[
i
+1] != 0) {

512 ià(0 > 
	`cú_ex‹nd_diù
(
¬gv
[
i
+1], 
dgs
, &dtags)) {

513 
	`årštf
(
¡d”r
, "UÇbËØlßd dg diùiÚ¬y %s\n", 
¬gv
[
i
+1]);

514 
diù»s
 = -1;

516 
i
++;

520 ià(
diù»s
 < 0)

521 
	`ex™
(1);

522 
	`årštf
(
¡d”r
, "<!-- Proûssšg % -->\n", 
¬gv
[
i
]);

523 
»s
 |ğ
	`´oûss_fe
(
¬gv
[
i
], 
æags
, 
dgs
);

525 (
»s
);

526 
	}
}

	@cmd/ccnbasicconfig.c

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<uni¡d.h
>

28 
	~<cú/bloom.h
>

29 
	~<cú/cú.h
>

30 
	~<cú/cúd.h
>

31 
	~<cú/ch¬buf.h
>

32 
	~<cú/uri.h
>

33 
	~<cú/çû_mgmt.h
>

34 
	~<cú/»g_mgmt.h
>

35 
	~<cú/sockü—‹.h
>

36 
	~<cú/signšg.h
>

37 
	~<cú/key¡Üe.h
>

40 
	$u§ge
(cÚ¡ *
´ogÇme
)

42 
	`årštf
(
¡d”r
,

45 
´ogÇme
);

46 
	`ex™
(1);

47 
	}
}

49 
	#CHKRES
(
»sv®
è
	`chk»s
(Ôesv®), 
__LINE__
)

	)

52 
	$chk»s
(
»s
, 
lš’o
)

54 ià(
»s
 >= 0)

56 
	`årštf
(
¡d”r
, "failure‡t "

58 ":%d (» ğ%d)\n", 
lš’o
, 
»s
);

59 
	`ex™
(1);

60 
	}
}

63 
	$maš
(
¬gc
, **
¬gv
)

65 
cú
 *
h
 = 
NULL
;

66 
cú_ch¬buf
 *
Çme
 = 
NULL
;

67 
cú_ch¬buf
 *
nuÎ_Çme
 = 
NULL
;

68 
cú_ch¬buf
 *
Çme_´efix
 = 
NULL
;

69 
cú_ch¬buf
 *
Ãwçû
 = 
NULL
;

70 
cú_ch¬buf
 *
´efix»g
 = 
NULL
;

71 
cú_ch¬buf
 *
»suÉbuf
 = 
NULL
;

72 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

73 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

74 cÚ¡ *
±r
 = 
NULL
;

75 
size_t
 
Ëngth
 = 0;

76 cÚ¡ *
¬g
 = 
NULL
;

77 cÚ¡ *
´ogÇme
 = 
NULL
;

78 
cú_·r£d_CÚ‹ÁObjeù
 
pcobuf
 = {0};

79 
cú_çû_š¡ªû
 
çû_š¡ªû_¡Üage
 = {0};

80 
cú_çû_š¡ªû
 *
çû_š¡ªû
 = &
çû_š¡ªû_¡Üage
;

81 
cú_fÜw¬dšg_’Œy
 
fÜw¬dšg_’Œy_¡Üage
 = {0};

82 
cú_fÜw¬dšg_’Œy
 *
fÜw¬dšg_’Œy
 = &
fÜw¬dšg_’Œy_¡Üage
;

83 
cú_ch¬buf
 *
sigÃd_šfo
 = 
NULL
;

84 
cú_ch¬buf
 *
keyloÿtÜ
 = 
NULL
;

85 
cú_key¡Üe
 *
key¡Üe
 = 
NULL
;

86 
expœe
 = -1;

87 
cúdid_¡Üage
[32] = {0};

88 cÚ¡ *
cúdid
 = 
NULL
;

89 
size_t
 
cúdid_size
 = 0;

90 
»s
;

91 
ch
;

93 
´ogÇme
 = 
¬gv
[0];

94 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "h")) != -1) {

95 
ch
) {

98 
	`u§ge
(
´ogÇme
);

103 
¬g
 = 
¬gv
[
İtšd
];

104 ià(
¬g
 =ğ
NULL
)

105 
	`u§ge
(
´ogÇme
);

106 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

107 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬g
);

108 ià(
»s
 < 0) {

109 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
´ogÇme
, 
¬g
);

110 
	`ex™
(1);

112 ià(
¬gc
 - 
İtšd
 < 3 ||‡rgc - optind > 4)

113 
	`u§ge
(
´ogÇme
);

115 
h
 = 
	`cú_ü—‹
();

116 
»s
 = 
	`cú_cÚÃù
(
h
, 
NULL
);

117 ià(
»s
 < 0) {

118 
	`cú_³¼Ü
(
h
, "ccn_connect");

119 
	`ex™
(1);

122 
Ãwçû
 = 
	`cú_ch¬buf_ü—‹
();

123 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

124 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

125 
sigÃd_šfo
 = 
	`cú_ch¬buf_ü—‹
();

126 
»suÉbuf
 = 
	`cú_ch¬buf_ü—‹
();

127 
Çme_´efix
 = 
	`cú_ch¬buf_ü—‹
();

128 
nuÎ_Çme
 = 
	`cú_ch¬buf_ü—‹
();

129 
	`CHKRES
(
	`cú_Çme_š™
(
nuÎ_Çme
));

131 
key¡Üe
 = 
	`cú_key¡Üe_ü—‹
();

133 
çû_š¡ªû
->
aùiÚ
 = "newface";

134 
çû_š¡ªû
->
desü
.
´Ùo
 = 
	`©oi
(
¬gv
[
İtšd
 + 1]);

135 
çû_š¡ªû
->
desü
.
add»ss
 = 
¬gv
[
İtšd
 + 2];

136 
çû_š¡ªû
->
desü
.
pÜt
 = 
¬gv
[
İtšd
 + 3];

137 ià(
çû_š¡ªû
->
desü
.
pÜt
 =ğ
NULL
)

138 
çû_š¡ªû
->
desü
.
pÜt
 = 
CCN_DEFAULT_UNICAST_PORT
;

139 
çû_š¡ªû
->
desü
.
mÿ¡_‰l
 = -1;

140 
çû_š¡ªû
->
liãtime
 = (~0U) >> 1;

142 
	`CHKRES
(
»s
 = 
	`cúb_­³nd_çû_š¡ªû
(
Ãwçû
, 
çû_š¡ªû
));

143 
‹mp
->
Ëngth
 = 0;

144 
	`CHKRES
(
	`cú_ch¬buf_putf
(
‹mp
, "%s/.cúx/.cúx_key¡Üe", 
	`g‘’v
("HOME")));

145 
»s
 = 
	`cú_key¡Üe_š™
(
key¡Üe
,

146 
	`cú_ch¬buf_as_¡ršg
(
‹mp
),

148 
	`CHKRES
(
»s
);

151 
keyloÿtÜ
 = 
	`cú_ch¬buf_ü—‹
();

152 
	`cú_ch¬buf_­³nd_‰
(
keyloÿtÜ
, 
CCN_DTAG_KeyLoÿtÜ
, 
CCN_DTAG
);

153 
	`cú_ch¬buf_­³nd_‰
(
keyloÿtÜ
, 
CCN_DTAG_Key
, 
CCN_DTAG
);

154 
	`CHKRES
(
	`cú_­³nd_pubkey_blob
(
keyloÿtÜ
, 
	`cú_key¡Üe_public_key
(
key¡Üe
)));

155 
	`cú_ch¬buf_­³nd_şo£r
(
keyloÿtÜ
);

156 
	`cú_ch¬buf_­³nd_şo£r
(
keyloÿtÜ
);

157 
»s
 = 
	`cú_sigÃd_šfo_ü—‹
(
sigÃd_šfo
,

158  
	`cú_key¡Üe_public_key_dige¡
(
key¡Üe
),

159  
	`cú_key¡Üe_public_key_dige¡_Ëngth
(
key¡Üe
),

160  
NULL
,

161  
CCN_CONTENT_DATA
,

162  
expœe
,

163  
NULL
,

164 
keyloÿtÜ
);

165 ià(
»s
 < 0) {

166 
	`årštf
(
¡d”r
, "FaedØü—‹ sigÃd_šfØÔe =ğ%d)\n", 
»s
);

167 
	`ex™
(1);

170 
‹mp
->
Ëngth
 = 0;

171 
»s
 = 
	`cú_’code_CÚ‹ÁObjeù
(
‹mp
,

172 
nuÎ_Çme
,

173 
sigÃd_šfo
,

174 
Ãwçû
->
buf
,

175 
Ãwçû
->
Ëngth
,

176 
NULL
,

177 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
));

178 
	`CHKRES
(
»s
);

181 
‹m¶
->
Ëngth
 = 0;

182 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

183 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

184 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

185 
	`cúb_gged_putf
(
‹m¶
, 
CCN_DTAG_Scİe
, "1");

186 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

189 
Çme
->
Ëngth
 = 0;

190 
	`CHKRES
(
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, "ccnx:/ccnx/ping"));

191 
	`CHKRES
(
»s
 = 
	`cú_Çme_­³nd_nÚû
(
Çme
));

192 
	`CHKRES
(
»s
 = 
	`cú_g‘
(
h
, 
Çme
, 
‹m¶
, 200, 
»suÉbuf
, &
pcobuf
, 
NULL
, 0));

193 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Publish”PublicKeyDige¡
,

194 
»suÉbuf
->
buf
,

195 
pcobuf
.
off£t
[
CCN_PCO_B_Publish”PublicKeyDige¡
],

196 
pcobuf
.
off£t
[
CCN_PCO_E_Publish”PublicKeyDige¡
],

197 &
cúdid
, &
cúdid_size
);

198 
	`CHKRES
(
»s
);

199 ià(
cúdid_size
 > (
cúdid_¡Üage
))

200 
	`CHKRES
(-1);

201 
	`memıy
(
cúdid_¡Üage
, 
cúdid
, 
cúdid_size
);

202 
cúdid
 = 
cúdid_¡Üage
;

205 
	`CHKRES
(
	`cú_Çme_š™
(
Çme
));

206 
	`CHKRES
(
	`cú_Çme_­³nd_¡r
(
Çme
, "ccnx"));

207 
	`CHKRES
(
	`cú_Çme_­³nd
(
Çme
, 
cúdid
, 
cúdid_size
));

208 
	`CHKRES
(
	`cú_Çme_­³nd
(
Çme
, "newface", 7));

209 
	`CHKRES
(
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
));

210 
»s
 = 
	`cú_g‘
(
h
, 
Çme
, 
‹m¶
, 1000, 
»suÉbuf
, &
pcobuf
, 
NULL
, 0);

211 ià(
»s
 < 0) {

212 
	`årštf
(
¡d”r
, "no„esponse from face creation„equest\n");

213 
	`ex™
(1);

215 
±r
 = 
»suÉbuf
->
buf
;

216 
Ëngth
 = 
»suÉbuf
->length;

217 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
»suÉbuf
->
buf
,„esuÉbuf->
Ëngth
, &
pcobuf
, &
±r
, &length);

218 
	`CHKRES
(
»s
);

219 
çû_š¡ªû
 = 
	`cú_çû_š¡ªû_·r£
(
±r
, 
Ëngth
);

220 ià(
çû_š¡ªû
 =ğ
NULL
)

221 
	`CHKRES
(
»s
 = -1);

222 
	`CHKRES
(
çû_š¡ªû
->
çûid
);

225 
Çme_´efix
->
Ëngth
 = 0;

226 
	`CHKRES
(
	`cú_Çme_äom_uri
(
Çme_´efix
, 
¬g
));

227 
fÜw¬dšg_’Œy
->
aùiÚ
 = "prefixreg";

228 
fÜw¬dšg_’Œy
->
Çme_´efix
 =‚ame_prefix;

229 
fÜw¬dšg_’Œy
->
çûid
 = 
çû_š¡ªû
->faceid;

230 
fÜw¬dšg_’Œy
->
liãtime
 = (~0U) >> 1;

231 
´efix»g
 = 
	`cú_ch¬buf_ü—‹
();

232 
	`CHKRES
(
»s
 = 
	`cúb_­³nd_fÜw¬dšg_’Œy
(
´efix»g
, 
fÜw¬dšg_’Œy
));

233 
‹mp
->
Ëngth
 = 0;

234 
»s
 = 
	`cú_’code_CÚ‹ÁObjeù
(
‹mp
,

235 
nuÎ_Çme
,

236 
sigÃd_šfo
,

237 
´efix»g
->
buf
,

238 
´efix»g
->
Ëngth
,

239 
NULL
,

240 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
));

241 
	`CHKRES
(
»s
);

242 
	`CHKRES
(
	`cú_Çme_š™
(
Çme
));

243 
	`CHKRES
(
	`cú_Çme_­³nd_¡r
(
Çme
, "ccnx"));

244 
	`CHKRES
(
	`cú_Çme_­³nd
(
Çme
, 
cúdid
, 
cúdid_size
));

245 
	`CHKRES
(
	`cú_Çme_­³nd_¡r
(
Çme
, "prefixreg"));

246 
	`CHKRES
(
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
));

247 
»s
 = 
	`cú_g‘
(
h
, 
Çme
, 
‹m¶
, 1000, 
»suÉbuf
, &
pcobuf
, 
NULL
, 0);

248 ià(
»s
 < 0) {

249 
	`årštf
(
¡d”r
, "no„esponse from…refix„egistration„equest\n");

250 
	`ex™
(1);

252 
	`årštf
(
¡d”r
, "P»fix % wÈbfÜw¬dedØçû %d\n", 
¬g
, 
çû_š¡ªû
->
çûid
);

255 
	`cú_de¡roy
(&
h
);

256 
	`ex™
(
»s
 < 0);

257 
	}
}

	@cmd/ccnbuzz.c

48 
	~<¡dio.h
>

49 
	~<¡dlib.h
>

50 
	~<¡ršg.h
>

51 
	~<uni¡d.h
>

52 
	~<cú/bloom.h
>

53 
	~<cú/cú.h
>

54 
	~<cú/ch¬buf.h
>

55 
	~<cú/uri.h
>

58 
	$u§ge
(cÚ¡ *
´ogÇme
)

60 
	`årštf
(
¡d”r
,

65 
´ogÇme
);

66 
	`ex™
(1);

67 
	}
}

69 
	smyd©a
 {

70 
	m®low_¡®e
;

74 
	$­³nd_bloom_–em’t
(
cú_ch¬buf
 *
‹m¶
,

75 
cú_dg
 
dg
, 
cú_bloom
 *
b
)

77 
i
;

78 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
dg
, 
CCN_DTAG
);

79 
i
 = 
	`cú_bloom_wœesize
(
b
);

80 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
i
, 
CCN_BLOB
);

81 
	`cú_bloom_¡Üe_wœe
(
b
, 
	`cú_ch¬buf_»£rve
(
‹m¶
, 
i
), i);

82 
‹m¶
->
Ëngth
 +ğ
i
;

83 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

84 
	}
}

91 
	$­³nd_bf_®l
(
cú_ch¬buf
 *
c
)

93 
bf_®l
[9] = { 3, 1, 'A', 0, 0, 0, 0, 0, 0xFF };

94 cÚ¡ 
cú_bloom_wœe
 *
b
 = 
	`cú_bloom_v®id©e_wœe
(
bf_®l
, (bf_all));

95 ià(
b
 =ğ
NULL
è
	`abÜt
();

96 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Bloom
, 
CCN_DTAG
);

97 
	`cú_ch¬buf_­³nd_‰
(
c
, (
bf_®l
), 
CCN_BLOB
);

98 
	`cú_ch¬buf_­³nd
(
c
, 
bf_®l
, (bf_all));

99 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

100 
	}
}

102 
cú_bloom
 *

103 
	$make_·¹™iÚ
(
i
, 
lg_n
)

105 
cú_bloom_wœe
 
‹m¶©e
 = {0};

106 
cú_bloom
 *
ªs
 = 
NULL
;

107 
j
;

109 ià(
lg_n
 > 13 || 
i
 >ğ(1U <<†g_n)è
	`abÜt
();

110 ià(
lg_n
 >= 3)

111 
‹m¶©e
.
lg_b™s
 = 
lg_n
;

113 
‹m¶©e
.
lg_b™s
 = 3;

114 
‹m¶©e
.
n_hash
 = 1;

115 
‹m¶©e
.
m‘hod
 = 'A';

116 
	`mem£t
(
‹m¶©e
.
bloom
, ~0, (template.bloom));

118 
j
 = 
i
; j < (1U << 
‹m¶©e
.
lg_b™s
); j +ğ(1U << 
lg_n
))

119 
‹m¶©e
.
bloom
[
j
 / 8] -= (1U << (j % 8));

120 
ªs
 = 
	`cú_bloom_äom_wœe
(&
‹m¶©e
, 8 + (1 << (‹m¶©e.
lg_b™s
 - 3)));

121 (
ªs
);

122 
	}
}

124 
cú_ch¬buf
 *

125 
	$make_‹m¶©e
(
myd©a
 *
md
, 
cú_upÿÎ_šfo
 *
šfo
, 
cú_bloom
 *
b
)

127 
cú_ch¬buf
 *
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

128 cÚ¡ *
ib
 = 
NULL
;

129 cÚ¡ *
cb
 = 
NULL
;

130 
cú_šdexbuf
 *
cc
 = 
NULL
;

131 
cú_·r£d_š‹»¡
 *
pi
 = 
NULL
;

132 
cú_buf_decod”
 
decod”
;

133 
cú_buf_decod”
 *
d
;

134 
size_t
 
¡¬t
;

135 
size_t
 
¡İ
;

137 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

138 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

139 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

141 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_MaxSuffixCompÚ’ts
, 
CCN_DTAG
);

142 
	`cúb_­³nd_numb”
(
‹m¶
, 2);

143 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

144 ià(
šfo
 !ğ
NULL
) {

145 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Exşude
, 
CCN_DTAG
);

146 
ib
 = 
šfo
->
š‹»¡_cúb
;

147 
cb
 = 
šfo
->
cÚ‹Á_cúb
;

148 
cc
 = 
šfo
->
cÚ‹Á_comps
;

149 
	`­³nd_bf_®l
(
‹m¶
);

151 
	`cú_ch¬buf_­³nd
(
‹m¶
,

152 
cb
 + 
cc
->
buf
[cc->
n
 - 2],

153 
cc
->
buf
[cc->
n
 - 1] - cc->buf[cc->n - 2]);

154 ià(
b
 =ğ
NULL
) {

156 
pi
 = 
šfo
->pi;

157 ià(
pi
->
off£t
[
CCN_PI_E_Exşude
] >…i->off£t[
CCN_PI_B_Exşude
]) {

158 
¡¬t
 = 
¡İ
 = 0;

159 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
,

160 
ib
 + 
pi
->
off£t
[
CCN_PI_B_Exşude
],

161 
pi
->
off£t
[
CCN_PI_E_Exşude
] -

162 
pi
->
off£t
[
CCN_PI_B_Exşude
]);

163 ià(!
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Exşude
))

164 
d
->
decod”
.
¡©e
 = -1;

165 
	`cú_buf_advªû
(
d
);

166 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Bloom
)) {

167 
¡¬t
 = 
pi
->
off£t
[
CCN_PI_B_Exşude
] + 
d
->
decod”
.
tok’_šdex
;

168 
	`cú_buf_advªû
(
d
);

169 ià(
	`cú_buf_m©ch_blob
(
d
, 
NULL
, NULL))

170 
	`cú_buf_advªû
(
d
);

171 
	`cú_buf_check_şo£
(
d
);

172 
¡İ
 = 
pi
->
off£t
[
CCN_PI_B_Exşude
] + 
d
->
decod”
.
tok’_šdex
;

174 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

175 
	`cú_buf_advªû
(
d
);

176 ià(
	`cú_buf_m©ch_blob
(
d
, 
NULL
, NULL))

177 
	`cú_buf_advªû
(
d
);

178 
	`cú_buf_check_şo£
(
d
);

179 
¡¬t
 = 
pi
->
off£t
[
CCN_PI_B_Exşude
] + 
d
->
decod”
.
tok’_šdex
;

180 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Bloom
)) {

181 
	`cú_buf_advªû
(
d
);

182 ià(
	`cú_buf_m©ch_blob
(
d
, 
NULL
, NULL))

183 
	`cú_buf_advªû
(
d
);

184 
	`cú_buf_check_şo£
(
d
);

186 
¡İ
 = 
pi
->
off£t
[
CCN_PI_B_Exşude
] + 
d
->
decod”
.
tok’_šdex
;

188 ià(
d
->
decod”
.
¡©e
 >= 0)

189 
	`cú_ch¬buf_­³nd
(
‹m¶
, 
ib
 + 
¡¬t
, 
¡İ
 - start);

194 
	`­³nd_bloom_–em’t
(
‹m¶
, 
CCN_DTAG_Bloom
, 
b
);

196 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

198 ià(
b
 !ğ
NULL
) {

199 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Exşude
, 
CCN_DTAG
);

200 
	`­³nd_bloom_–em’t
(
‹m¶
, 
CCN_DTAG_Bloom
, 
b
);

201 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

203 ià(
md
->
®low_¡®e
) {

204 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, 
CCN_DTAG
);

205 
	`cúb_­³nd_numb”
(
‹m¶
,

206 
CCN_AOK_DEFAULT
 | 
CCN_AOK_STALE
);

207 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

209 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

210 (
‹m¶
);

211 
	}
}

213 
cú_upÿÎ_»s


214 
	$šcomšg_cÚ‹Á
(

215 
cú_şosu»
 *
£lå
,

216 
cú_upÿÎ_kšd
 
kšd
,

217 
cú_upÿÎ_šfo
 *
šfo
)

219 
cú_ch¬buf
 *
Çme
 = 
NULL
;

220 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

221 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

222 cÚ¡ *
cúb
 = 
NULL
;

223 
size_t
 
cúb_size
 = 0;

224 cÚ¡ *
d©a
 = 
NULL
;

225 
size_t
 
d©a_size
 = 0;

226 cÚ¡ *
cb
 = 
NULL
;

227 
cú_šdexbuf
 *
cc
 = 
NULL
;

228 
»s
;

229 
myd©a
 *
md
 = 
£lå
->
d©a
;

231 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

232 ià(
md
 !ğ
NULL
) {

233 
£lå
->
d©a
 = 
NULL
;

234 
	`ä“
(
md
);

235 
md
 = 
NULL
;

237 (
CCN_UPCALL_RESULT_OK
);

239 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

240 (
CCN_UPCALL_RESULT_REEXPRESS
);

241 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
 && kšd !ğ
CCN_UPCALL_CONTENT_UNVERIFIED
)

242 (
CCN_UPCALL_RESULT_ERR
);

243 ià(
md
 =ğ
NULL
)

244 
£lå
->
d©a
 = 
md
 = 
	`ÿÎoc
(1, (*md));

245 
cúb
 = 
šfo
->
cÚ‹Á_cúb
;

246 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

247 
cb
 = 
šfo
->
cÚ‹Á_cúb
;

248 
cc
 = 
šfo
->
cÚ‹Á_comps
;

249 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
cúb
, 
cúb_size
, 
šfo
->
pco
, &
d©a
, &
d©a_size
);

250 ià(
»s
 < 0è
	`abÜt
();

253 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

254 
	`cú_Çme_š™
(
Çme
);

255 ià(
cc
->
n
 < 2è
	`abÜt
();

256 
»s
 = 
	`cú_Çme_­³nd_compÚ’ts
(
Çme
, 
cb
, 
cc
->
buf
[0], cc->buf[cc->
n
 - 1]);

257 ià(
»s
 < 0è
	`abÜt
();

258 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

260 
‹m¶
 = 
	`make_‹m¶©e
(
md
, 
šfo
, 
NULL
);

262 
»s
 = 
	`cú_ex´ess_š‹»¡
(
šfo
->
h
, 
Çme
, 
£lå
, 
‹m¶
);

263 ià(
»s
 < 0è
	`abÜt
();

265 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

266 
	`cú_ch¬buf_de¡roy
(&
Çme
);

268 (
CCN_UPCALL_RESULT_OK
);

269 
	}
}

272 
	$maš
(
¬gc
, **
¬gv
)

274 
cú
 *cú = 
NULL
;

275 
cú_ch¬buf
 *
Çme
 = 
NULL
;

276 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

277 
cú_şosu»
 *
šcomšg
 = 
NULL
;

278 cÚ¡ *
¬g
 = 
NULL
;

279 
»s
;

280 
ch
;

281 
myd©a
 *mydata;

282 
®low_¡®e
 = 0;

283 
lg_n
 = 3;

284 
n
 = 8;

285 
i
;

287 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "han:")) != -1) {

288 
ch
) {

290 
®low_¡®e
 = 1;

293 
n
 = 
	`©oi
(
İrg
);

294 ià(
n
 < 2 ||‚ > 8*1024) {

295 
	`årštf
(
¡d”r
, "invalid -n value\n");

296 
	`u§ge
(
¬gv
[0]);

301 
	`u§ge
(
¬gv
[0]);

304 
lg_n
 = 0; (1U <<†g_nè< 
n
;†g_n++)

306 
n
 = 1U << 
lg_n
;

307 
¬g
 = 
¬gv
[
İtšd
];

308 ià(
¬g
 =ğ
NULL
)

309 
	`u§ge
(
¬gv
[0]);

310 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

311 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬g
);

312 ià(
»s
 < 0) {

313 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
¬gv
[0], 
¬g
);

314 
	`ex™
(1);

316 ià(
¬gv
[
İtšd
 + 1] !ğ
NULL
)

317 
	`årštf
(
¡d”r
, "% w¬nšg:ƒxŒ¨¬gum’t ignÜed\n", 
¬gv
[0]);

318 
cú
 = 
	`cú_ü—‹
();

319 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

320 
	`³¼Ü
("Could‚ot connecto ccnd");

321 
	`ex™
(1);

323 
šcomšg
 = 
	`ÿÎoc
(1, (*incoming));

324 
šcomšg
->
p
 = &
šcomšg_cÚ‹Á
;

325 
myd©a
 = 
	`ÿÎoc
(1, (*mydata));

326 
myd©a
->
®low_¡®e
 =‡llow_stale;

327 
šcomšg
->
d©a
 = 
myd©a
;

329 
i
 = 0; i < 
n
; i++) {

330 
cú_bloom
 *
b
 = 
	`make_·¹™iÚ
(
i
, 
lg_n
);

331 
‹m¶
 = 
	`make_‹m¶©e
(
myd©a
, 
NULL
, 
b
);

332 
	`cú_ex´ess_š‹»¡
(
cú
, 
Çme
, 
šcomšg
, 
‹m¶
);

333 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

334 
	`cú_bloom_de¡roy
(&
b
);

337 
	`cú_ch¬buf_de¡roy
(&
Çme
);

338 
»s
 >= 0) {

339 
»s
 = 
	`cú_run
(
cú
, 1000);

341 
	`cú_de¡roy
(&
cú
);

342 
	`ex™
(
»s
 < 0);

343 
	}
}

	@cmd/ccnbx.c

22 
	~<fú.h
>

23 
	~<¡ddef.h
>

24 
	~<¡dio.h
>

25 
	~<¡dšt.h
>

26 
	~<¡dlib.h
>

27 
	~<¡ršg.h
>

28 
	~<uni¡d.h
>

30 
	~<cú/ch¬buf.h
>

31 
	~<cú/codšg.h
>

32 
	~<cú/cú.h
>

34 
	#CCNBX_OPT_UNADORNED
 1

	)

35 
	#CCNBX_OPT_VERBOSE
 2

	)

38 
	$u§ge
(cÚ¡ *
´ogÇme
)

40 
	`årštf
(
¡d”r
,

48 
´ogÇme
);

49 
	`ex™
(1);

50 
	}
}

54 
	$dg_lookup
(cÚ¡ *
key
)

56 cÚ¡ 
cú_diù_’Œy
 *
diù
 = 
cú_dg_diù
.dict;

57 
n
 = 
cú_dg_diù
.
couÁ
;

58 
i
;

59 
i
 = 0; i < 
n
; i++)

60 ià(0 =ğ
	`¡rcmp
(
key
, 
diù
[
i
].
Çme
))

61  (
diù
[
i
].
šdex
);

63 
	}
}

66 
	$cúbx
(cÚ¡ *
·th
, cÚ¡ *
£ËùÜ
, 
İt
) {

67 
cú_sk–‘Ú_decod”
 
sk–_decod”
 = {0};

68 
cú_sk–‘Ú_decod”
 *
d
 = &
sk–_decod”
;

69 
cú_ch¬buf
 *
c
 = 
NULL
;

70 
fd
 = 0;

71 
¡©us
 = 1;

72 
dg
;

73 
ssize_t
 
»s
;

74 
ssize_t
 
s
;

75 
size_t
 
off£t
 = 0;

76 
size_t
 
¡¬t
 = 0;

77 
size_t
 
’d
 = ~0U;

78 
v”bo£
 = (
İt
 & 
CCNBX_OPT_VERBOSE
) != 0;

80 ià(0 !ğ
	`¡rcmp
(
·th
, "-")) {

81 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

82 ià(-1 =ğ
fd
) {

83 
	`³¼Ü
(
·th
);

87 
dg
 = 
	`dg_lookup
(
£ËùÜ
);

88 ià(
dg
 == -1) {

89 
	`årštf
(
¡d”r
, "% i nÙ‡ DTAG\n", 
£ËùÜ
);

90 
Fšish
;

92 
c
 = 
	`cú_ch¬buf_ü—‹
();

93 
d
->
¡©e
 |ğ
CCN_DSTATE_PAUSE
;

95 
	`cú_ch¬buf_»£rve
(
c
, 512);

96 
»s
 = 
	`»ad
(
fd
, 
c
->
buf
 + c->
Ëngth
, c->
lim™
 - c->length);

97 ià(
»s
 < 0) {

98 
	`³¼Ü
(
·th
);

99 
Fšish
;

101 ià(
»s
 == 0) {

102 
	`årštf
(
¡d”r
, "´em©u»ƒnd oàfÚ %s\n", 
·th
);

103 
Fšish
;

105 
c
->
Ëngth
 +ğ
»s
;

106 
d
->
šdex
 < 
c
->
Ëngth
) {

107 
s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
c
->
buf
 + d->
šdex
, c->
Ëngth
 - d->index);

108 
off£t
 +ğ
s
;

109 ià(
v”bo£
è
	`årštf
(
¡d”r
, "%d, ", ()
s
);

110 ià(
d
->
¡©e
 < 0) {

111 
	`årštf
(
¡d”r
, "error state %d‡fter %d chars from %s\n",

112 ()
d
->
¡©e
, ()(d->
šdex
), 
·th
);

113 
Fšish
;

115 ià(
s
 =ğ0 || 
	`CCN_FINAL_DSTATE
(
d
->
¡©e
))

117 ià(
	`CCN_GET_TT_FROM_DSTATE
(
d
->
¡©e
è=ğ
CCN_DTAG
 &&

118 
d
->
numv®
 =ğ
dg
) {

119 ià(
v”bo£
)

120 
	`årštf
(
¡d”r
, "(%s starts‡t %d,†evel is %d) ",

121 
£ËùÜ
,

122 ()
d
->
tok’_šdex
,

123 ()
d
->
Ã¡
);

124 
¡¬t
 = 
d
->
tok’_šdex
;

125 
d
->
Ã¡
 = 1;

126 ià((
İt
 & 
CCNBX_OPT_UNADORNED
) == 0)

127 
d
->
¡©e
 &ğ~
CCN_DSTATE_PAUSE
;

129 
¡¬t
 = 
’d
 = 
d
->
šdex
;

130 
¡©us
 = 0;

132 ià(
¡©us
 =ğ0 && 
d
->
Ã¡
 == 1 &&

133 (
	`CCN_GET_TT_FROM_DSTATE
(
d
->
¡©e
è=ğ
CCN_UDATA
 ||

134 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
¡©e
è=ğ
CCN_BLOB
)) {

136 
¡¬t
 = 
d
->
šdex
;

137 
’d
 = 
d
->
šdex
 + d->
numv®
;

138 
d
->
¡©e
 &ğ~
CCN_DSTATE_PAUSE
;

141 } !
	`CCN_FINAL_DSTATE
(
d
->
¡©e
));

142 ià(
v”bo£
è
	`årštf
(
¡d”r
, "completeƒlement‡fter %lu chars from %s\n",

143 ()
off£t
, 
·th
);

144 ià(
off£t
 < 
’d
)

145 
’d
 = 
off£t
;

146 ià(
¡©us
 == 0)

147 
»s
 = 
	`wr™e
(1, 
c
->
buf
 + 
¡¬t
, 
’d
 - start);

148 
Fšish
:

149 
	`cú_ch¬buf_de¡roy
(&
c
);

150 
	`şo£
(
fd
);

151 (
¡©us
);

152 
	}
}

155 
	$maš
(
¬gc
, **
¬gv
)

157 
c
;

158 
¡©us
 = 0;

159 
İt
 = 0;

161 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "dhv")) != -1) {

162 
c
) {

164 
İt
 |ğ
CCNBX_OPT_UNADORNED
;

167 
İt
 |ğ
CCNBX_OPT_VERBOSE
;

171 
	`u§ge
(
¬gv
[0]);

175 ià(
¬gv
[
İtšd
] =ğ
NULL
 ||‡rgv[optind + 1] == NULL) {

176 
	`årštf
(
¡d”r
, "Too few‡rguments\n");

177 
	`u§ge
(
¬gv
[0]);

179 ià(
¬gv
[
İtšd
 + 2] !ğ
NULL
) {

180 
	`årštf
(
¡d”r
, "Too many‡rguments\n");

181 
	`u§ge
(
¬gv
[0]);

183 
¡©us
 = 
	`cúbx
(
¬gv
[
İtšd
],‡rgv[İtšd + 1], 
İt
);

184 (
¡©us
);

185 
	}
}

	@cmd/ccncat.c

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/ch¬buf.h
>

27 
	~<cú/uri.h
>

33 
	$u§ge
(cÚ¡ *
´ogÇme
)

35 
	`årštf
(
¡d”r
,

40 
´ogÇme
);

41 
	`ex™
(1);

42 
	}
}

44 
	smyd©a
 {

45 *
	mdÚe
;

46 
	m®low_¡®e
;

54 
cú_ch¬buf
 *

55 
	$make_‹m¶©e
(
myd©a
 *
md
, 
cú_upÿÎ_šfo
 *
šfo
)

57 
cú_ch¬buf
 *
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

58 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

59 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

60 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

62 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_MšSuffixCompÚ’ts
, 
CCN_DTAG
);

63 
	`cúb_­³nd_numb”
(
‹m¶
, 1);

64 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

65 ià(
md
->
®low_¡®e
) {

66 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, 
CCN_DTAG
);

67 
	`cúb_­³nd_numb”
(
‹m¶
, 
CCN_AOK_DEFAULT
 | 
CCN_AOK_STALE
);

68 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

70 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

71 (
‹m¶
);

72 
	}
}

79 
cú_upÿÎ_»s


80 
	$šcomšg_cÚ‹Á
(
cú_şosu»
 *
£lå
,

81 
cú_upÿÎ_kšd
 
kšd
,

82 
cú_upÿÎ_šfo
 *
šfo
)

84 
cú_ch¬buf
 *
Çme
 = 
NULL
;

85 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

86 cÚ¡ *
cúb
 = 
NULL
;

87 
size_t
 
cúb_size
 = 0;

88 cÚ¡ *
d©a
 = 
NULL
;

89 
size_t
 
d©a_size
 = 0;

90 
size_t
 
wr™‹n
;

91 cÚ¡ *
ib
 = 
NULL
;

92 
cú_šdexbuf
 *
ic
 = 
NULL
;

93 
»s
;

94 
myd©a
 *
md
 = 
£lå
->
d©a
;

96 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

97 ià(
md
 !ğ
NULL
) {

98 
£lå
->
d©a
 = 
NULL
;

99 
	`ä“
(
md
);

100 
md
 = 
NULL
;

102 (
CCN_UPCALL_RESULT_OK
);

104 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

105 (
CCN_UPCALL_RESULT_REEXPRESS
);

106 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_UNVERIFIED
)

107 (
CCN_UPCALL_RESULT_VERIFY
);

108 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
)

109 (
CCN_UPCALL_RESULT_ERR
);

110 ià(
md
 =ğ
NULL
)

111 
£lå
->
d©a
 = 
md
 = 
	`ÿÎoc
(1, (*md));

112 
cúb
 = 
šfo
->
cÚ‹Á_cúb
;

113 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

114 
ib
 = 
šfo
->
š‹»¡_cúb
;

115 
ic
 = 
šfo
->
š‹»¡_comps
;

116 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
cúb
, 
cúb_size
, 
šfo
->
pco
, &
d©a
, &
d©a_size
);

117 ià(
»s
 < 0è
	`abÜt
();

118 ià(
šfo
->
pco
->
ty³
 !ğ
CCN_CONTENT_DATA
) {

120 
	`årštf
(
¡d”r
, "*** s·mmed‡ˆblock %d\n", ()
£lå
->
štd©a
);

121 
	`ex™
(1);

125 ià(
d©a_size
 == 0)

126 *(
md
->
dÚe
) = 1;

128 
wr™‹n
 = 
	`fwr™e
(
d©a
, 
d©a_size
, 1, 
¡dout
);

129 ià(
wr™‹n
 != 1)

130 
	`ex™
(1);

133 ià(
šfo
->
pco
->
off£t
[
CCN_PCO_B_Fš®BlockID
] !=

134 
šfo
->
pco
->
off£t
[
CCN_PCO_E_Fš®BlockID
]) {

135 cÚ¡ *
fš®id
 = 
NULL
;

136 
size_t
 
fš®id_size
 = 0;

137 cÚ¡ *
Çmeid
 = 
NULL
;

138 
size_t
 
Çmeid_size
 = 0;

139 
cú_šdexbuf
 *
cc
 = 
šfo
->
cÚ‹Á_comps
;

140 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Fš®BlockID
, 
cúb
,

141 
šfo
->
pco
->
off£t
[
CCN_PCO_B_Fš®BlockID
],

142 
šfo
->
pco
->
off£t
[
CCN_PCO_E_Fš®BlockID
],

143 &
fš®id
,

144 &
fš®id_size
);

145 ià(
cc
->
n
 < 2è
	`abÜt
();

146 
	`cú_»f_gged_BLOB
(
CCN_DTAG_CompÚ’t
, 
cúb
,

147 
cc
->
buf
[cc->
n
 - 2],

148 
cc
->
buf
[cc->
n
 - 1],

149 &
Çmeid
,

150 &
Çmeid_size
);

151 ià(
fš®id_size
 =ğ
Çmeid_size
 &&

152 0 =ğ
	`memcmp
(
fš®id
, 
Çmeid
, 
Çmeid_size
))

153 *(
md
->
dÚe
) = 1;

156 ià(*(
md
->
dÚe
)) {

157 
	`cú_£t_run_timeout
(
šfo
->
h
, 0);

158 (
CCN_UPCALL_RESULT_OK
);

162 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

163 
	`cú_Çme_š™
(
Çme
);

164 ià(
ic
->
n
 < 2è
	`abÜt
();

165 
»s
 = 
	`cú_Çme_­³nd_compÚ’ts
(
Çme
, 
ib
, 
ic
->
buf
[0], ic->buf[ic->
n
 - 2]);

166 ià(
»s
 < 0è
	`abÜt
();

167 
	`cú_Çme_­³nd_num”ic
(
Çme
, 
CCN_MARKER_SEQNUM
, ++(
£lå
->
štd©a
));

168 
‹m¶
 = 
	`make_‹m¶©e
(
md
, 
šfo
);

170 
»s
 = 
	`cú_ex´ess_š‹»¡
(
šfo
->
h
, 
Çme
, 
£lå
, 
‹m¶
);

171 ià(
»s
 < 0è
	`abÜt
();

173 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

174 
	`cú_ch¬buf_de¡roy
(&
Çme
);

176 (
CCN_UPCALL_RESULT_OK
);

177 
	}
}

184 
	$maš
(
¬gc
, **
¬gv
)

186 
cú
 *cú = 
NULL
;

187 
cú_ch¬buf
 *
Çme
 = 
NULL
;

188 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

189 
cú_şosu»
 *
šcomšg
 = 
NULL
;

190 cÚ¡ *
¬g
 = 
NULL
;

191 
i
;

192 
»s
;

193 
ch
;

194 
myd©a
 *mydata;

195 
®low_¡®e
 = 0;

196 *
dÚe
;

197 
ex™_¡©us
 = 0;

199 
dÚe
 = 
	`ÿÎoc
(1, (*done));

201 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "ha")) != -1) {

202 
ch
) {

204 
®low_¡®e
 = 1;

208 
	`u§ge
(
¬gv
[0]);

211 
¬g
 = 
¬gv
[
İtšd
];

212 ià(
¬g
 =ğ
NULL
)

213 
	`u§ge
(
¬gv
[0]);

214 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

216 
i
 = 
İtšd
; 
¬gv
[i] !ğ
NULL
; i++) {

217 
Çme
->
Ëngth
 = 0;

218 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬gv
[
i
]);

219 ià(
»s
 < 0) {

220 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
¬gv
[0],‡rgv[
i
]);

221 
	`ex™
(1);

224 
i
 = 
İtšd
; (
¬g
 = 
¬gv
[i]è!ğ
NULL
; i++) {

225 *
dÚe
 = 0;

226 
Çme
->
Ëngth
 = 0;

227 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬g
);

228 
cú
 = 
	`cú_ü—‹
();

229 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

230 
	`³¼Ü
("Could‚ot connecto ccnd");

231 
	`ex™
(1);

233 
	`cú_»sŞve_v”siÚ
(
cú
, 
Çme
, 
CCN_V_HIGHEST
, 50);

234 
	`cú_Çme_­³nd_num”ic
(
Çme
, 
CCN_MARKER_SEQNUM
, 0);

235 
šcomšg
 = 
	`ÿÎoc
(1, (*incoming));

236 
šcomšg
->
p
 = &
šcomšg_cÚ‹Á
;

237 
myd©a
 = 
	`ÿÎoc
(1, (*mydata));

238 
myd©a
->
®low_¡®e
 =‡llow_stale;

239 
myd©a
->
dÚe
 = done;

240 
šcomšg
->
d©a
 = 
myd©a
;

241 
‹m¶
 = 
	`make_‹m¶©e
(
myd©a
, 
NULL
);

242 
	`cú_ex´ess_š‹»¡
(
cú
, 
Çme
, 
šcomšg
, 
‹m¶
);

243 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

245 
»s
 = 
	`cú_run
(
cú
, 200);

246 ià((!*
dÚe
è&& 
šcomšg
->
štd©a
 == 0) {

247 
	`årštf
(
¡d”r
, "%s:‚Ù found: %s\n", 
¬gv
[0], 
¬g
);

248 
»s
 = -1;

251 
»s
 >ğ0 && !*
dÚe
) {

252 
	`fæush
(
¡dout
);

253 
»s
 = 
	`cú_run
(
cú
, 333);

255 ià(
»s
 < 0)

256 
ex™_¡©us
 = 1;

257 
	`cú_de¡roy
(&
cú
);

258 
	`fæush
(
¡dout
);

259 
	`ä“
(
šcomšg
);

260 
šcomšg
 = 
NULL
;

262 
	`cú_ch¬buf_de¡roy
(&
Çme
);

263 
	`ä“
(
dÚe
);

264 
	`ex™
(
ex™_¡©us
);

265 
	}
}

	@cmd/ccncatchunks.c

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<uni¡d.h
>

24 
	~<cú/cú.h
>

25 
	~<cú/ch¬buf.h
>

26 
	~<cú/uri.h
>

29 
	$u§ge
(cÚ¡ *
´ogÇme
)

31 
	`årštf
(
¡d”r
,

36 
´ogÇme
);

37 
	`ex™
(1);

38 
	}
}

40 
	smyd©a
 {

41 
	m®low_¡®e
;

44 
cú_ch¬buf
 *

45 
	$make_‹m¶©e
(
myd©a
 *
md
, 
cú_upÿÎ_šfo
 *
šfo
)

47 
cú_ch¬buf
 *
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

48 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

49 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

50 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

52 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_MaxSuffixCompÚ’ts
, 
CCN_DTAG
);

53 
	`cúb_­³nd_numb”
(
‹m¶
, 1);

54 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

55 ià(
md
->
®low_¡®e
) {

56 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, 
CCN_DTAG
);

57 
	`cúb_­³nd_numb”
(
‹m¶
, 
CCN_AOK_DEFAULT
 | 
CCN_AOK_STALE
);

58 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

60 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

61 (
‹m¶
);

62 
	}
}

64 
	#CHUNK_SIZE
 1024

	)

66 
cú_upÿÎ_»s


67 
	$šcomšg_cÚ‹Á
(

68 
cú_şosu»
 *
£lå
,

69 
cú_upÿÎ_kšd
 
kšd
,

70 
cú_upÿÎ_šfo
 *
šfo
)

72 
cú_ch¬buf
 *
Çme
 = 
NULL
;

73 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

74 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

75 cÚ¡ *
cúb
 = 
NULL
;

76 
size_t
 
cúb_size
 = 0;

77 cÚ¡ *
d©a
 = 
NULL
;

78 
size_t
 
d©a_size
 = 0;

79 
size_t
 
wr™‹n
;

80 cÚ¡ *
ib
 = 
NULL
;

81 
cú_šdexbuf
 *
ic
 = 
NULL
;

82 
»s
;

83 
myd©a
 *
md
 = 
£lå
->
d©a
;

85 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

86 ià(
md
 !ğ
NULL
) {

87 
£lå
->
d©a
 = 
NULL
;

88 
	`ä“
(
md
);

89 
md
 = 
NULL
;

91 (
CCN_UPCALL_RESULT_OK
);

93 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

94 (
CCN_UPCALL_RESULT_REEXPRESS
);

95 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
 && kšd !ğ
CCN_UPCALL_CONTENT_UNVERIFIED
)

96 (
CCN_UPCALL_RESULT_ERR
);

97 ià(
md
 =ğ
NULL
)

98 
£lå
->
d©a
 = 
md
 = 
	`ÿÎoc
(1, (*md));

99 
cúb
 = 
šfo
->
cÚ‹Á_cúb
;

100 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

101 
ib
 = 
šfo
->
š‹»¡_cúb
;

102 
ic
 = 
šfo
->
š‹»¡_comps
;

104 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
cúb
, 
cúb_size
, 
šfo
->
pco
, &
d©a
, &
d©a_size
);

105 ià(
»s
 < 0è
	`abÜt
();

106 ià(
d©a_size
 > 
CHUNK_SIZE
) {

108 
	`årštf
(
¡d”r
, "*** Segment %d found with‡ data size of %d."

111 ()
£lå
->
štd©a
, ()
d©a_size
);

112 
	`ex™
(1);

117 
wr™‹n
 = 
	`fwr™e
(
d©a
, 
d©a_size
, 1, 
¡dout
);

118 ià(
wr™‹n
 != 1)

119 
	`ex™
(1);

122 ià(
d©a_size
 < 
CHUNK_SIZE
)

123 
	`ex™
(0);

126 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

127 
	`cú_Çme_š™
(
Çme
);

128 ià(
ic
->
n
 < 2è
	`abÜt
();

129 
»s
 = 
	`cú_Çme_­³nd_compÚ’ts
(
Çme
, 
ib
, 
ic
->
buf
[0], ic->buf[ic->
n
 - 2]);

130 ià(
»s
 < 0è
	`abÜt
();

131 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

132 
	`cú_ch¬buf_putf
(
‹mp
, "%d", ++(
£lå
->
štd©a
));

133 
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
);

134 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

135 
‹m¶
 = 
	`make_‹m¶©e
(
md
, 
šfo
);

137 
»s
 = 
	`cú_ex´ess_š‹»¡
(
šfo
->
h
, 
Çme
, 
£lå
, 
‹m¶
);

138 ià(
»s
 < 0è
	`abÜt
();

140 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

141 
	`cú_ch¬buf_de¡roy
(&
Çme
);

143 (
CCN_UPCALL_RESULT_OK
);

144 
	}
}

147 
	$maš
(
¬gc
, **
¬gv
)

149 
cú
 *cú = 
NULL
;

150 
cú_ch¬buf
 *
Çme
 = 
NULL
;

151 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

152 
cú_şosu»
 *
šcomšg
 = 
NULL
;

153 cÚ¡ *
¬g
 = 
NULL
;

154 
»s
;

155 
ch
;

156 
myd©a
 *mydata;

157 
®low_¡®e
 = 0;

159 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "ha")) != -1) {

160 
ch
) {

162 
®low_¡®e
 = 1;

166 
	`u§ge
(
¬gv
[0]);

169 
¬g
 = 
¬gv
[
İtšd
];

170 ià(
¬g
 =ğ
NULL
)

171 
	`u§ge
(
¬gv
[0]);

172 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

173 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬g
);

174 ià(
»s
 < 0) {

175 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
¬gv
[0], 
¬g
);

176 
	`ex™
(1);

178 ià(
¬gv
[
İtšd
 + 1] !ğ
NULL
)

179 
	`årštf
(
¡d”r
, "% w¬nšg:ƒxŒ¨¬gum’t ignÜed\n", 
¬gv
[0]);

180 
cú
 = 
	`cú_ü—‹
();

181 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

182 
	`³¼Ü
("Could‚ot connecto ccnd");

183 
	`ex™
(1);

185 
	`cú_Çme_­³nd
(
Çme
, "0", 1);

186 
šcomšg
 = 
	`ÿÎoc
(1, (*incoming));

187 
šcomšg
->
p
 = &
šcomšg_cÚ‹Á
;

188 
myd©a
 = 
	`ÿÎoc
(1, (*mydata));

189 
myd©a
->
®low_¡®e
 =‡llow_stale;

190 
šcomšg
->
d©a
 = 
myd©a
;

191 
‹m¶
 = 
	`make_‹m¶©e
(
myd©a
, 
NULL
);

192 
	`cú_ex´ess_š‹»¡
(
cú
, 
Çme
, 
šcomšg
, 
‹m¶
);

193 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

194 
	`cú_ch¬buf_de¡roy
(&
Çme
);

196 
»s
 = 
	`cú_run
(
cú
, 200);

197 ià(
šcomšg
->
štd©a
 == 0) {

198 
	`årštf
(
¡d”r
, "%s:‚Ù found: %s\n", 
¬gv
[0], 
¬g
);

199 
	`ex™
(1);

202 
»s
 >= 0) {

203 
	`fæush
(
¡dout
);

204 
»s
 = 
	`cú_run
(
cú
, 200);

206 
	`cú_de¡roy
(&
cú
);

207 
	`ex™
(
»s
 < 0);

208 
	}
}

	@cmd/ccncatchunks2.c

20 
	~<sys/time.h
>

21 
	~<as£¹.h
>

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

25 
	~<time.h
>

26 
	~<uni¡d.h
>

28 
	~<cú/cú.h
>

29 
	~<cú/ch¬buf.h
>

30 
	~<cú/scheduË.h
>

31 
	~<cú/uri.h
>

33 
	#PIPELIMIT
 (1U << 7)

	)

35 
	#GOT_HERE
(è(()(
__LINE__
))

	)

37 
	gexşude¡uff
;

39 
	soood©a
 {

40 
cú_şosu»
 
	mşosu»
;

41 *
	m¿w_d©a
;

42 
size_t
 
	m¿w_d©a_size
;

45 
	smyd©a
 {

46 
cú
 *
	mh
;

47 
	m®low_¡®e
;

48 
	mu£_decim®
;

49 
	mooo_ba£
;

50 
	mooo_couÁ
;

51 
	mcurwšdow
;

52 
	mmaxwšdow
;

53 
	m£ndtime
;

54 
	m£ndtime_¦Ù
;

55 
	m¹t
;

56 
	m¹‹
;

57 
	mbackoff
;

58 
	mfš®¦Ù
;

59 
cú_ch¬buf
 *
	mÇme
;

60 
cú_ch¬buf
 *
	m‹m¶
;

61 
exşude¡uff
 *
	mexş
;

62 
cú_scheduË
 *
	msched
;

63 
cú_scheduËd_ev’t
 *
	m»pÜt
;

64 
cú_scheduËd_ev’t
 *
	mhŞefËr
;

65 
štmax_t
 
	mš‹»¡s_£Á
;

66 
štmax_t
 
	mpkts_»cvd
;

67 
štmax_t
 
	mco_by‹s_»cvd
;

68 
štmax_t
 
	md–iv”ed
;

69 
štmax_t
 
	md–iv”ed_by‹s
;

70 
štmax_t
 
	mjunk
;

71 
štmax_t
 
	mhŞes
;

72 
štmax_t
 
	mtimeouts
;

73 
štmax_t
 
	mdups
;

74 
štmax_t
 
	mÏ¡check
;

75 
štmax_t
 
	munv”if›d
;

76 
timev®
 
	m¡¬t_tv
;

77 
timev®
 
	m¡İ_tv
;

78 
oood©a
 
	mooo
[
PIPELIMIT
];

81 
fl_hŞes
(
cú_scheduË
 *
sched
, *
ş›Áh
,

82 
cú_scheduËd_ev’t
 *
ev
, 
æags
);

84 
FILE
* 
	glog¡»am
 = 
NULL
;

87 
	$u§ge
(cÚ¡ *
´ogÇme
)

89 
	`årštf
(
¡d”r
,

96 
´ogÇme
);

97 
	`ex™
(1);

98 
	}
}

101 
	$myg‘time
(cÚ¡ 
cú_g‘time
 *
£lf
, 
cú_timev®
 *
»suÉ
)

103 
timev®
 
now
 = {0};

104 
	`g‘timeofday
(&
now
, 0);

105 
»suÉ
->
s
 = 
now
.
tv_£c
;

106 
»suÉ
->
miüos
 = 
now
.
tv_u£c
;

107 
	}
}

109 
cú_g‘time
 
	gmytick”
 = {

111 &
myg‘time
,

113 
NULL


117 
	$upd©e_¹t
(
myd©a
 *
md
, 
šcomšg
, 
¦Ù
)

119 
timev®
 
now
 = {0};

120 
t
, 
d–
, 
¹‹
;

122 ià(!
šcomšg
 && 
md
->
£ndtime_¦Ù
 == ~0)

123 
md
->
£ndtime_¦Ù
 = 
¦Ù
;

124 ià(
¦Ù
 !ğ
md
->
£ndtime_¦Ù
)

126 
	`g‘timeofday
(&
now
, 0);

127 
t
 = (()(
now
.
tv_£c
è* 1000000è+ ()Òow.
tv_u£c
);

128 ià(
šcomšg
) {

129 
d–
 = 
t
 - 
md
->
£ndtime
;

130 
md
->
¹t
 = 
d–
;

131 ià(
d–
 <= 30000000) {

132 
¹‹
 = 
md
->rtte;

133 ià(
d–
 > 
¹‹
)

134 
¹‹
 =„tte + (rtte >> 3);

136 
¹‹
 =„tte - (rtte >> 7);

137 ià(
¹‹
 < 127)

138 
¹‹
 = 
d–
;

139 
md
->
¹‹
 =„tte;

141 ià(
md
->
hŞefËr
 =ğ
NULL
)

142 
md
->
hŞefËr
 = 
	`cú_scheduË_ev’t
(md->
sched
, 10000, &
fl_hŞes
, 
NULL
, 0);

143 
md
->
£ndtime_¦Ù
 = ~0;

144 ià(
log¡»am
)

145 
	`årštf
(
log¡»am
,

149 ()
now
.
tv_£c
,

150 ()
now
.
tv_u£c
,

151 
md
->
š‹»¡s_£Á
,

152 
md
->
pkts_»cvd
,

153 
md
->
junk
,

154 
md
->
hŞes
,

155 
md
->
timeouts
,

156 
md
->
unv”if›d
,

157 
md
->
curwšdow
,

158 
md
->
¹t
,

159 
md
->
¹‹


163 
md
->
£ndtime
 = 
t
;

164 
	}
}

167 
	$»pÜ‹r
(
cú_scheduË
 *
sched
, *
ş›Áh
,

168 
cú_scheduËd_ev’t
 *
ev
, 
æags
)

170 
timev®
 
now
 = {0};

171 
myd©a
 *
md
 = 
ş›Áh
;

172 
	`g‘timeofday
(&
now
, 0);

173 
	`fæush
(
¡dout
);

174 
	`årštf
(
¡d”r
,

178 ()
now
.
tv_£c
,

179 ()
now
.
tv_u£c
,

180 ()
	`g‘pid
(),

181 
md
->
š‹»¡s_£Á
,

182 
md
->
pkts_»cvd
,

183 
md
->
junk
,

184 
md
->
hŞes
,

185 
md
->
timeouts
,

186 
md
->
unv”if›d
,

187 
md
->
curwšdow
,

188 
md
->
¹t
,

189 
md
->
¹‹


191 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) != 0) {

192 
md
->
»pÜt
 = 
NULL
;

196 
	}
}

199 
	$´št_summ¬y
(
myd©a
 *
md
)

201 cÚ¡ *
expid
;

202 cÚ¡ *
dlm
 = " ";

203 
–­£d
 = 0.0;

204 
štmax_t
 
d–iv”ed_by‹s
;

205 
¿‹
 = 0.0;

207 
expid
 = 
	`g‘’v
("CCN_EXPERIMENT_ID");

208 ià(
expid
 =ğ
NULL
)

209 
expid
 = 
dlm
 = "";

210 
	`g‘timeofday
(&
md
->
¡İ_tv
, 0);

211 
–­£d
 = ()()(
md
->
¡İ_tv
.
tv_£c
 - md->
¡¬t_tv
.tv_sec);

212 
–­£d
 +ğ(()
md
->
¡İ_tv
.
tv_u£c
 - ()md->
¡¬t_tv
.tv_usec)/1000000.0;

213 
d–iv”ed_by‹s
 = 
md
->delivered_bytes;

214 ià(
–­£d
 > 0.00001)

215 
¿‹
 = 
d–iv”ed_by‹s
/
–­£d
;

216 
	`årštf
(
¡d”r
,

220 ()
md
->
¡İ_tv
.
tv_£c
,

221 ()
md
->
¡İ_tv
.
tv_u£c
,

222 ()
	`g‘pid
(),

223 
expid
,

224 
dlm
,

225 
d–iv”ed_by‹s
,

226 
–­£d
,

227 
¿‹


229 
	}
}

231 
cú_ch¬buf
 *

232 
	$make_‹m¶©e
(
myd©a
 *
md
)

234 
cú_ch¬buf
 *
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

235 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

236 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

237 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

239 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_MaxSuffixCompÚ’ts
, 
CCN_DTAG
);

240 
	`cúb_­³nd_numb”
(
‹m¶
, 1);

241 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

242 ià(
md
->
®low_¡®e
) {

243 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, 
CCN_DTAG
);

244 
	`cúb_­³nd_numb”
(
‹m¶
, 
CCN_AOK_DEFAULT
 | 
CCN_AOK_STALE
);

245 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

247 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

248 (
‹m¶
);

249 
	}
}

251 
cú_ch¬buf
 *

252 
	$£qu’ûd_Çme
(
myd©a
 *
md
, 
uštmax_t
 
£q
)

254 
cú_ch¬buf
 *
Çme
 = 
NULL
;

255 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

257 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

258 
	`cú_ch¬buf_­³nd
(
Çme
, 
md
->Çme->
buf
, md->Çme->
Ëngth
);

259 ià(
md
->
u£_decim®
) {

260 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

261 
	`cú_ch¬buf_putf
(
‹mp
, "%ju", 
£q
);

262 
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
);

263 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

266 
	`cú_Çme_­³nd_num”ic
(
Çme
, 
CCN_MARKER_SEQNUM
, 
£q
);

267 (
Çme
);

268 
	}
}

271 
	$ask_mÜe
(
myd©a
 *
md
, 
uštmax_t
 
£q
)

273 
cú_ch¬buf
 *
Çme
 = 
NULL
;

274 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

275 
»s
;

276 
¦Ù
;

277 
cú_şosu»
 *
ş
 = 
NULL
;

279 
¦Ù
 = 
£q
 % 
PIPELIMIT
;

280 
ş
 = &
md
->
ooo
[
¦Ù
].
şosu»
;

281 ià(
ş
->
štd©a
 == -1)

282 
ş
->
štd©a
 = 
£q
;

283 
	`as£¹
(
ş
->
štd©a
 =ğ
£q
);

284 
	`as£¹
(
md
->
ooo
[
¦Ù
].
¿w_d©a_size
 == 0);

285 
Çme
 = 
	`£qu’ûd_Çme
(
md
, 
£q
);

286 
‹m¶
 = 
	`make_‹m¶©e
(
md
);

287 
	`upd©e_¹t
(
md
, 0, 
¦Ù
);

288 
»s
 = 
	`cú_ex´ess_š‹»¡
(
md
->
h
, 
Çme
, 
ş
, 
‹m¶
);

289 ià(
»s
 < 0è
	`abÜt
();

290 
md
->
š‹»¡s_£Á
++;

291 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

292 
	`cú_ch¬buf_de¡roy
(&
Çme
);

293 ià(
£q
 =ğ
md
->
d–iv”ed
 + md->
ooo_couÁ
)

294 
md
->
ooo_couÁ
++;

295 
	`as£¹
(
£q
 >ğ
md
->
d–iv”ed
);

296 
	`as£¹
(
£q
 < 
md
->
d–iv”ed
 + md->
ooo_couÁ
);

297 
	`as£¹
(
md
->
ooo_couÁ
 < 
PIPELIMIT
);

298 
	}
}

300 
cú_upÿÎ_»s


301 
	$hŞe_fËd
(
cú_şosu»
 *
£lå
,

302 
cú_upÿÎ_kšd
 
kšd
,

303 
cú_upÿÎ_šfo
 *
šfo
)

305 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
)

306 
	`ä“
(
£lå
);

307 (
CCN_UPCALL_RESULT_OK
);

308 
	}
}

311 
	$fl_hŞes
(
cú_scheduË
 *
sched
, *
ş›Áh
,

312 
cú_scheduËd_ev’t
 *
ev
, 
æags
)

314 
myd©a
 *
md
 = 
ş›Áh
;

315 
cú_ch¬buf
 *
Çme
 = 
NULL
;

316 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

317 
cú_şosu»
 *
ş
 = 
NULL
;

318 
backoff
;

319 
d–ay
;

321 ià((
æags
 & 
CCN_SCHEDULE_CANCEL
) != 0) {

322 
md
->
hŞefËr
 = 
NULL
;

325 
backoff
 = 
md
->backoff;

326 ià(
md
->
d–iv”ed
 =ğmd->
Ï¡check
 && md->
ooo_couÁ
 > 0) {

327 ià(
backoff
 == 0) {

328 
md
->
hŞes
++;

329 
	`årštf
(
¡d”r
, "*** HŞ© %jd\n", 
md
->
d–iv”ed
);

330 
	`»pÜ‹r
(
sched
, 
md
, 
NULL
, 0);

331 
md
->
curwšdow
 = 1;

332 
ş
 = 
	`ÿÎoc
(1, (*cl));

333 
ş
->
p
 = &
hŞe_fËd
;

334 
Çme
 = 
	`£qu’ûd_Çme
(
md
, md->
d–iv”ed
);

335 
‹m¶
 = 
	`make_‹m¶©e
(
md
);

336 
	`cú_ex´ess_š‹»¡
(
md
->
h
, 
Çme
, 
ş
, 
‹m¶
);

337 
md
->
š‹»¡s_£Á
++;

338 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

339 
	`cú_ch¬buf_de¡roy
(&
Çme
);

341 ià((6000000 >> 
backoff
è> 
md
->
¹‹
)

342 
backoff
++;

345 
md
->
Ï¡check
 = md->
d–iv”ed
;

346 
backoff
 = 0;

348 
md
->
backoff
 = backoff;

349 
d–ay
 = (
md
->
¹‹
 << 
backoff
);

350 ià(
d–ay
 < 10000)

351 
d–ay
 = 10000;

352 (
d–ay
);

353 
	}
}

356 
	$is_fš®
(
cú_upÿÎ_šfo
 *
šfo
)

359 cÚ¡ *
cúb
;

360 
size_t
 
cúb_size
;

361 
cúb
 = 
šfo
->
cÚ‹Á_cúb
;

362 ià(
cúb
 =ğ
NULL
 || 
šfo
->
pco
 == NULL)

364 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

365 ià(
šfo
->
pco
->
off£t
[
CCN_PCO_B_Fš®BlockID
] !=

366 
šfo
->
pco
->
off£t
[
CCN_PCO_E_Fš®BlockID
]) {

367 cÚ¡ *
fš®id
 = 
NULL
;

368 
size_t
 
fš®id_size
 = 0;

369 cÚ¡ *
Çmeid
 = 
NULL
;

370 
size_t
 
Çmeid_size
 = 0;

371 
cú_šdexbuf
 *
cc
 = 
šfo
->
cÚ‹Á_comps
;

372 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Fš®BlockID
, 
cúb
,

373 
šfo
->
pco
->
off£t
[
CCN_PCO_B_Fš®BlockID
],

374 
šfo
->
pco
->
off£t
[
CCN_PCO_E_Fš®BlockID
],

375 &
fš®id
,

376 &
fš®id_size
);

377 ià(
cc
->
n
 < 2è
	`abÜt
();

378 
	`cú_»f_gged_BLOB
(
CCN_DTAG_CompÚ’t
, 
cúb
,

379 
cc
->
buf
[cc->
n
 - 2],

380 
cc
->
buf
[cc->
n
 - 1],

381 &
Çmeid
,

382 &
Çmeid_size
);

383 ià(
fš®id_size
 =ğ
Çmeid_size
 &&

384 0 =ğ
	`memcmp
(
fš®id
, 
Çmeid
, 
Çmeid_size
))

388 
	}
}

390 
cú_upÿÎ_»s


391 
	$šcomšg_cÚ‹Á
(
cú_şosu»
 *
£lå
,

392 
cú_upÿÎ_kšd
 
kšd
,

393 
cú_upÿÎ_šfo
 *
šfo
)

395 cÚ¡ *
cúb
 = 
NULL
;

396 
size_t
 
cúb_size
 = 0;

397 cÚ¡ *
d©a
 = 
NULL
;

398 
size_t
 
d©a_size
 = 0;

399 
size_t
 
wr™‹n
;

400 
»s
;

401 
myd©a
 *
md
 = 
£lå
->
d©a
;

402 
¦Ù
;

404 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

405 
£lå
->
štd©a
 = -1;

406 (
CCN_UPCALL_RESULT_OK
);

408 
	`GOT_HERE
();

409 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
) {

410 
md
->
timeouts
++;

411 ià(
£lå
->
»fcouÁ
 > 1 || s–å->
štd©a
 == -1)

412 (
CCN_UPCALL_RESULT_OK
);

413 
md
->
š‹»¡s_£Á
++;

414 
md
->
curwšdow
 = 1;

416 (
CCN_UPCALL_RESULT_REEXPRESS
);

418 
	`GOT_HERE
();

419 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
 && kšd !ğ
CCN_UPCALL_CONTENT_UNVERIFIED
)

420 (
CCN_UPCALL_RESULT_ERR
);

421 
	`as£¹
(
md
 !ğ
NULL
);

422 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_UNVERIFIED
) {

423 ià(
md
->
pkts_»cvd
 == 0)

424 (
CCN_UPCALL_RESULT_VERIFY
);

425 
md
->
unv”if›d
++;

427 
md
->
pkts_»cvd
++;

428 ià(
£lå
->
štd©a
 == -1) {

430 
md
->
dups
++;

431 (
CCN_UPCALL_RESULT_OK
);

433 
cúb
 = 
šfo
->
cÚ‹Á_cúb
;

434 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

435 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
cúb
, 
cúb_size
, 
šfo
->
pco
, &
d©a
, &
d©a_size
);

436 ià(
»s
 < 0è
	`abÜt
();

437 
	`GOT_HERE
();

439 
md
->
co_by‹s_»cvd
 +ğ
d©a_size
;

440 
¦Ù
 = ((
ušŒ_t
)
£lå
->
štd©a
è% 
PIPELIMIT
;

441 
	`as£¹
(
£lå
 =ğ&
md
->
ooo
[
¦Ù
].
şosu»
);

442 ià(
	`is_fš®
(
šfo
)) {

443 
	`GOT_HERE
();

444 
md
->
fš®¦Ù
 = 
¦Ù
;

446 ià(
¦Ù
 !ğ
md
->
ooo_ba£
 || md->
ooo_couÁ
 == 0) {

448 
oood©a
 *
ooo
 = &
md
->ooo[
¦Ù
];

449 ià(
ooo
->
¿w_d©a_size
 == 0) {

450 
	`GOT_HERE
();

451 
	`upd©e_¹t
(
md
, 1, 
¦Ù
);

452 
ooo
->
¿w_d©a
 = 
	`m®loc
(
d©a_size
);

453 
	`memıy
(
ooo
->
¿w_d©a
, 
d©a
, 
d©a_size
);

454 
ooo
->
¿w_d©a_size
 = 
d©a_size
 + 1;

457 
md
->
dups
++;

458 ià(
md
->
curwšdow
 > 1)

459 
md
->
curwšdow
--;

462 
	`as£¹
(
md
->
ooo
[
¦Ù
].
¿w_d©a_size
 == 0);

463 
	`upd©e_¹t
(
md
, 1, 
¦Ù
);

464 
md
->
ooo
[
¦Ù
].
şosu»
.
štd©a
 = -1;

465 
md
->
d–iv”ed
++;

466 
md
->
d–iv”ed_by‹s
 +ğ
d©a_size
;

467 
wr™‹n
 = 
	`fwr™e
(
d©a
, 
d©a_size
, 1, 
¡dout
);

468 ià(
wr™‹n
 != 1)

469 
	`ex™
(1);

471 ià(
¦Ù
 =ğ
md
->
fš®¦Ù
) {

472 
	`GOT_HERE
();

473 
	`cú_scheduË_de¡roy
(&
md
->
sched
);

474 
	`´št_summ¬y
(
md
);

475 
	`ex™
(0);

477 
md
->
ooo_couÁ
--;

478 
¦Ù
 = (¦Ù + 1è% 
PIPELIMIT
;

479 ià(
md
->
curwšdow
 < md->
maxwšdow
)

480 
md
->
curwšdow
++;

481 
md
->
ooo_couÁ
 > 0 && md->
ooo
[
¦Ù
].
¿w_d©a_size
 != 0) {

482 
oood©a
 *
ooo
 = &
md
->ooo[
¦Ù
];

483 
md
->
d–iv”ed
++;

484 
md
->
d–iv”ed_by‹s
 +ğ(
ooo
->
¿w_d©a_size
 - 1);

485 
wr™‹n
 = 
	`fwr™e
(
ooo
->
¿w_d©a
, ooo->
¿w_d©a_size
 - 1, 1, 
¡dout
);

486 ià(
wr™‹n
 != 1)

487 
	`ex™
(1);

489 ià(
¦Ù
 =ğ
md
->
fš®¦Ù
) {

490 
	`GOT_HERE
();

491 
	`cú_scheduË_de¡roy
(&
md
->
sched
);

492 
	`ex™
(0);

494 
	`ä“
(
ooo
->
¿w_d©a
);

495 
ooo
->
¿w_d©a
 = 
NULL
;

496 
ooo
->
¿w_d©a_size
 = 0;

497 
¦Ù
 = (¦Ù + 1è% 
PIPELIMIT
;

498 
md
->
ooo_couÁ
--;

500 
md
->
ooo_ba£
 = 
¦Ù
;

504 ià(
md
->
ooo_couÁ
 < md->
curwšdow
)

505 
	`ask_mÜe
(
md
, md->
d–iv”ed
 + md->
ooo_couÁ
);

506 ià(
md
->
ooo_couÁ
 < md->
curwšdow
)

507 
	`ask_mÜe
(
md
, md->
d–iv”ed
 + md->
ooo_couÁ
);

509 (
CCN_UPCALL_RESULT_OK
);

510 
	}
}

513 
	$maš
(
¬gc
, **
¬gv
)

515 
cú
 *cú = 
NULL
;

516 
cú_ch¬buf
 *
Çme
 = 
NULL
;

517 
cú_şosu»
 *
šcomšg
 = 
NULL
;

518 cÚ¡ *
¬g
 = 
NULL
;

519 
»s
;

520 
miüos
;

521 
ch
;

522 
myd©a
 *mydata;

523 
®low_¡®e
 = 0;

524 
u£_decim®
 = 1;

525 
i
;

526 
maxwšdow
 = 
PIPELIMIT
-1;

528 ià(
maxwšdow
 > 31)

529 
maxwšdow
 = 31;

531 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "hap:s")) != -1) {

532 
ch
) {

534 
®low_¡®e
 = 1;

537 
»s
 = 
	`©oi
(
İrg
);

538 ià(1 <ğ
»s
 &&„e < 
PIPELIMIT
)

539 
maxwšdow
 = 
»s
;

541 
	`u§ge
(
¬gv
[0]);

544 
u£_decim®
 = 0;

548 
	`u§ge
(
¬gv
[0]);

551 
¬g
 = 
¬gv
[
İtšd
];

552 ià(
¬g
 =ğ
NULL
)

553 
	`u§ge
(
¬gv
[0]);

554 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

555 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬g
);

556 ià(
»s
 < 0) {

557 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
¬gv
[0], 
¬g
);

558 
	`ex™
(1);

560 ià(
¬gv
[
İtšd
 + 1] !ğ
NULL
)

561 
	`årštf
(
¡d”r
, "% w¬nšg:ƒxŒ¨¬gum’t ignÜed\n", 
¬gv
[0]);

562 
cú
 = 
	`cú_ü—‹
();

563 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

564 
	`³¼Ü
("Could‚ot connecto ccnd");

565 
	`ex™
(1);

568 
myd©a
 = 
	`ÿÎoc
(1, (*mydata));

569 
myd©a
->
h
 = 
cú
;

570 
myd©a
->
Çme
 =‚ame;

571 
myd©a
->
®low_¡®e
 =‡llow_stale;

572 
myd©a
->
u£_decim®
 = use_decimal;

573 
myd©a
->
exş
 = 
NULL
;

574 
myd©a
->
sched
 = 
	`cú_scheduË_ü—‹
(myd©a, &
mytick”
);

575 
myd©a
->
»pÜt
 = 
	`cú_scheduË_ev’t
(myd©a->
sched
, 0, &
»pÜ‹r
, 
NULL
, 0);

576 
myd©a
->
hŞefËr
 = 
NULL
;

577 
myd©a
->
maxwšdow
 = maxwindow;

578 
myd©a
->
fš®¦Ù
 = ~0;

579 
i
 = 0; i < 
PIPELIMIT
; i++) {

580 
šcomšg
 = &
myd©a
->
ooo
[
i
].
şosu»
;

581 
šcomšg
->
p
 = &
šcomšg_cÚ‹Á
;

582 
šcomšg
->
d©a
 = 
myd©a
;

583 
šcomšg
->
štd©a
 = -1;

585 
myd©a
->
ooo_ba£
 = 0;

586 
myd©a
->
ooo_couÁ
 = 0;

587 
myd©a
->
curwšdow
 = 1;

588 
	`g‘timeofday
(&
myd©a
->
¡¬t_tv
, 0);

589 
log¡»am
 = 
NULL
;

591 
	`ask_mÜe
(
myd©a
, 0);

593 
»s
 = 
	`cú_run
(
cú
, 500);

594 ià(
myd©a
->
d–iv”ed
 == 0) {

595 
	`årštf
(
¡d”r
, "%s:‚Ù found: %s\n", 
¬gv
[0], 
¬g
);

596 
	`ex™
(1);

599 
»s
 >= 0) {

600 
miüos
 = 
	`cú_scheduË_run
(
myd©a
->
sched
);

601 ià(
miüos
 < 0)

602 
miüos
 = 10000000;

603 
»s
 = 
	`cú_run
(
cú
, 
miüos
 / 1000);

605 
	`cú_scheduË_de¡roy
(&
myd©a
->
sched
);

606 
	`´št_summ¬y
(
myd©a
);

607 
	`cú_de¡roy
(&
cú
);

608 
	`ex™
(
»s
 < 0);

609 
	}
}

	@cmd/ccndumpnames.c

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

25 
	~<uni¡d.h
>

27 
	~<cú/cú.h
>

28 
	~<cú/ch¬buf.h
>

29 
	~<cú/uri.h
>

35 
cú_dump_Çmes
(
cú
 *
h
, 
cú_ch¬buf
 *
Çme_´efix
, 
loÿl_scİe
, 
®low_¡®e
);

38 
	$u§ge
(cÚ¡ *
´ogÇme
)

40 
	`årštf
(
¡d”r
,

44 
´ogÇme
);

45 
	`ex™
(1);

46 
	}
}

49 
	$maš
(
¬gc
, **
¬gv
)

51 
cú
 *cú = 
NULL
;

52 
cú_ch¬buf
 *
c
 = 
NULL
;

53 
®low_¡®e
 = 0;

54 
ch
;

55 
»s
;

57 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "ha")) != -1) {

58 
ch
) {

60 
®low_¡®e
 = 1;

64 
	`u§ge
(
¬gv
[0]);

68 
cú
 = 
	`cú_ü—‹
();

69 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

70 
	`³¼Ü
("Could‚ot connecto ccnd");

71 
	`ex™
(1);

73 
c
 = 
	`cú_ch¬buf_ü—‹
();

74 ià(
¬gv
[
İtšd
] =ğ
NULL
)

75 
	`cú_Çme_š™
(
c
);

77 
»s
 = 
	`cú_Çme_äom_uri
(
c
, 
¬gv
[
İtšd
]);

78 ià(
»s
 < 0) {

79 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
¬gv
[0],‡rgv[
İtšd
]);

80 
	`ex™
(1);

82 ià(
¬gv
[
İtšd
+1] !ğ
NULL
)

83 
	`årštf
(
¡d”r
, "% w¬nšg:ƒxŒ¨¬gum’t ignÜed\n", 
¬gv
[0]);

85 
	`cú_dump_Çmes
(
cú
, 
c
, 1, 
®low_¡®e
);

86 
	`ex™
(0);

87 
	}
}

	@cmd/ccndumppcap.c

22 
	~<sys/ty³s.h
>

23 
	~<sys/¡©.h
>

24 
	~<sys/mmª.h
>

25 
	~<sys/sock‘.h
>

26 
	~<sys/time.h
>

27 
	~<fú.h
>

28 
	~<¡dio.h
>

29 
	~<¡dlib.h
>

30 
	~<¡ršg.h
>

31 
	~<¡dšt.h
>

32 
	~<¬·/š‘.h
>

34 
	~<pÿp.h
>

35 
	~<cú/cú.h
>

36 
	~<cú/cúd.h
>

38 
	#LLC_LENGTH
 4

	)

39 
	#IP_OFFSET
 
LLC_LENGTH


	)

40 
	#IP_ADDR_LENGTH
 4

	)

41 
	#IP_HDR_LENGTH
 20

	)

42 
	#IP_LENGTH_OFFSET
 
IP_OFFSET
 + 2

	)

43 
	#IP_CHKSUM_OFFSET
 
IP_OFFSET
 + 10

	)

44 
	#IP_SRC_ADDR_OFFSET
 
IP_CHKSUM_OFFSET
 + 2

	)

45 
	#IP_DEST_ADDR_OFFSET
 
IP_CHKSUM_OFFSET
 + 
IP_ADDR_LENGTH


	)

47 
	#UDP_OFFSET
 
IP_OFFSET
 + 
IP_HDR_LENGTH


	)

48 
	#UDP_HDR_LENGTH
 8

	)

49 
	#UDP_LENGTH_OFFSET
 
UDP_OFFSET
 + 4

	)

50 
	#UDP_CHKSUM_OFFSET
 
UDP_OFFSET
 + 6

	)

51 
	#DATA_OFFSET
 
UDP_OFFSET
 + 
UDP_HDR_LENGTH


	)

52 
	#MAX_PACKET
 65536

	)

53 
	#DEFAULT_SRC_PORT
 55555

	)

54 
	#DEFAULT_DEST_PORT
 
CCN_DEFAULT_UNICAST_PORT_NUMBER


	)

57 
	$u§ge
(cÚ¡ *
´ogÇme
)

59 
	`årštf
(
¡d”r
,

64 
´ogÇme
);

65 
	`ex™
(1);

66 
	}
}

69 
	$dump_udp_·ck‘
(
pÿp_dum³r_t
 *
dump_fe
,

70 *
_¤c_addr
,

71 *
_de¡_addr
,

72 
udp_¤c_pÜt
,

73 
udp_de¡_pÜt
,

74 cÚ¡ *
d©a
, 
size_t
 
d©a_Ën
,

76 
timev®
 *
ts
) {

78 
pktbuf
[
MAX_PACKET
];

79 
ušt32_t
 
Îc_v®
 = 
PF_INET
;

81 
ušt16_t
 
n¤c_pÜt
 = 
	`htÚs
((0 =ğ
udp_¤c_pÜt
è? 
DEFAULT_SRC_PORT
 : udp_src_port);

82 
ušt16_t
 
nde¡_pÜt
 = 
	`htÚs
((0 =ğ
udp_de¡_pÜt
è? 
DEFAULT_DEST_PORT
 : udp_dest_port);

83 
ušt16_t
 
nudp_Ën
 = 
	`htÚs
(
d©a_Ën
 + 
UDP_HDR_LENGTH
);

84 
ušt16_t
 
n_Ën
 = 
	`htÚs
(
d©a_Ën
 + 
UDP_HDR_LENGTH
 + 
IP_HDR_LENGTH
);

86 
size_t
 
äame_Ën
 = 
d©a_Ën
 + 
UDP_HDR_LENGTH
 + 
IP_HDR_LENGTH
 + 
LLC_LENGTH
;

87 
pÿp_pkthdr
 
pÿp_h—d”
;

89 cÚ¡ 
Hdr
[] = {

104 
udpHdr
[
UDP_HDR_LENGTH
];

105 
	`mem£t
(
udpHdr
, 0, 
UDP_HDR_LENGTH
);

107 
	`memıy
(&
pktbuf
[0], (*)&
Îc_v®
, 
LLC_LENGTH
);

108 
	`memıy
(&
pktbuf
[
IP_OFFSET
], 
Hdr
, 
IP_HDR_LENGTH
);

109 
	`memıy
(&
pktbuf
[
IP_LENGTH_OFFSET
], &
n_Ën
, 2);

110 ià(
NULL
 !ğ
_¤c_addr
) {

111 
	`memıy
(&
pktbuf
[
IP_SRC_ADDR_OFFSET
], 
_¤c_addr
, 
IP_ADDR_LENGTH
);

113 ià(
NULL
 !ğ
_de¡_addr
) {

114 
	`memıy
(&
pktbuf
[
IP_DEST_ADDR_OFFSET
], 
_de¡_addr
, 
IP_ADDR_LENGTH
);

117 
	`memıy
(&
pktbuf
[
UDP_OFFSET
], &
n¤c_pÜt
, ());

118 
	`memıy
(&
pktbuf
[
UDP_OFFSET
 + ()], &
nde¡_pÜt
, ());

119 
	`memıy
(&
pktbuf
[
UDP_LENGTH_OFFSET
], &
nudp_Ën
, ());

121 
	`memıy
(&
pktbuf
[
DATA_OFFSET
], 
d©a
, 
d©a_Ën
);

123 
pÿp_h—d”
.
Ën
 =…ÿp_h—d”.
ÿ¶’
 = 
äame_Ën
;

124 ià(
NULL
 !ğ
ts
) {

125 
pÿp_h—d”
.
ts
.
tv_£c
 =s->tv_sec;

126 
pÿp_h—d”
.
ts
.
tv_u£c
 =s->tv_usec;

129 
	`pÿp_dump
((*)
dump_fe
, &
pÿp_h—d”
, &
pktbuf
[0]);

131 ià(0 !ğ
	`pÿp_dump_æush
(
dump_fe
)) {

132 
	`årštf
(
¡d”r
, "Error flushing…cap dump...\n");

136 
	}
}

139 
	$´oûss_‹¡
(
pÿp_dum³r_t
 *
pÿp_out
, 
cÚ‹Á_Úly
,

140 *
_¤c_addr
,

141 *
_de¡_addr
,

142 
udp_¤c_pÜt
,

143 
udp_de¡_pÜt
,

144 *
d©a
, 
size_t
 
n
)

146 
cú_sk–‘Ú_decod”
 
sk–_decod”
 = {0};

147 
cú_sk–‘Ú_decod”
 *
d
 = &
sk–_decod”
;

148 
cú_·r£d_CÚ‹ÁObjeù
 
cÚ‹Á
;

149 
cú_šdexbuf
 *
comps
 = 
	`cú_šdexbuf_ü—‹
();

150 cÚ¡ * 
cÚ‹Á_v®ue
;

151 
size_t
 
cÚ‹Á_Ëngth
;

152 
»s
 = 0;

153 
size_t
 
s
;

155 
»Œy
:

156 
s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
d©a
, 
n
);

157 ià(
d
->
¡©e
 < 0) {

158 
»s
 = 1;

159 
	`årštf
(
¡d”r
, "error state %d‡fter %d of %d chars\n",

160 ()
d
->
¡©e
, ()
s
, ()
n
);

161 } ià(
s
 == 0) {

162 
	`årštf
(
¡d”r
, "nothingo do\n");

164 ià(
s
 < 
n
) {

165 ià(!
cÚ‹Á_Úly
) {

166 ià(
	`dump_udp_·ck‘
(
pÿp_out
, 
_¤c_addr
, 
_de¡_addr
,

167 
udp_¤c_pÜt
, 
udp_de¡_pÜt
, 
d©a
, 
s
, 
NULL
) != 0) {

168 
»s
 = 2;

171 ià(
	`cú_·r£_CÚ‹ÁObjeù
(
d©a
, 
s
, &
cÚ‹Á
, 
comps
) != 0) {

172 
	`årštf
(
¡d”r
, "unableo…arse content object\n");

173 
»s
 = 1;

174 } ià(
	`cú_cÚ‹Á_g‘_v®ue
(
d©a
, 
s
, &
cÚ‹Á
, &
cÚ‹Á_v®ue
, &
cÚ‹Á_Ëngth
) != 0) {

175 
	`årštf
(
¡d”r
, "unableo„etrieve content value\n");

176 
»s
 = 1;

177 } ià(
	`dump_udp_·ck‘
(
pÿp_out
, 
_¤c_addr
, 
_de¡_addr
,

178 
udp_¤c_pÜt
, 
udp_de¡_pÜt
,

179 
cÚ‹Á_v®ue
, 
cÚ‹Á_Ëngth
, 
NULL
) != 0) {

180 
»s
 = 2;

184 
d©a
 +ğ
s
;

185 
n
 -ğ
s
;

186 ià(
»s
 != 0) {

187 
	`årštf
(
¡d”r
, "Error dumping content.\n");

188  
»s
;

190 
»Œy
;

192 
	`årštf
(
¡d”r
, "\n");

194 ià(!
	`CCN_FINAL_DSTATE
(
d
->
¡©e
)) {

195 
»s
 = 1;

196 
	`årštf
(
¡d”r
, "incomplete state %d‡fter %d of %d chars\n",

197 ()
d
->
¡©e
, ()
s
, ()
n
);

199 ià(!
cÚ‹Á_Úly
) {

200 ià(
	`dump_udp_·ck‘
(
pÿp_out
, 
_¤c_addr
, 
_de¡_addr
,

201 
udp_¤c_pÜt
, 
udp_de¡_pÜt
, 
d©a
, 
s
, 
NULL
) != 0) {

202 
»s
 = 2;

205 ià(
	`cú_·r£_CÚ‹ÁObjeù
(
d©a
, 
s
, &
cÚ‹Á
, 
comps
) != 0) {

206 
	`årštf
(
¡d”r
, "unableo…arse content object\n");

207 
»s
 = 1;

208 } ià(
	`cú_cÚ‹Á_g‘_v®ue
(
d©a
, 
s
, &
cÚ‹Á
, &
cÚ‹Á_v®ue
, &
cÚ‹Á_Ëngth
) != 0) {

209 
	`årštf
(
¡d”r
, "unableo„etrieve content value\n");

210 
»s
 = 1;

211 } ià(
	`dump_udp_·ck‘
(
pÿp_out
, 
_¤c_addr
, 
_de¡_addr
,

212 
udp_¤c_pÜt
, 
udp_de¡_pÜt
, 
cÚ‹Á_v®ue
, 
cÚ‹Á_Ëngth
, 
NULL
) != 0) {

213 
»s
 = 2;

217 
»s
 = 1;

219 (
»s
);

220 
	}
}

223 
	$´oûss_fd
(
pÿp_dum³r_t
 *
pÿp_out
, 
fd
, 
cÚ‹Á_Úly
,

224 *
_¤c_addr
,

225 *
_de¡_addr
,

226 
udp_¤c_pÜt
,

227 
udp_de¡_pÜt


230 *
buf
;

231 
ssize_t
 
Ën
;

232 
¡©
 
s
;

233 
»s
 = 0;

235 
»s
 = 
	`f¡©
(
fd
, &
s
);

236 
Ën
 = 
s
.
¡_size
;

237 
buf
 = (*)
	`mm­
((*)
NULL
, 
Ën
, 
PROT_READ
, 
MAP_PRIVATE
, 
fd
, 0);

238 ià(
buf
 == (*)-1)  (1);

239 
	`årštf
(
¡d”r
, " <!-- iÅuˆi %6lu by‹ -->\n", ()
Ën
);

240 
»s
 |ğ
	`´oûss_‹¡
(
pÿp_out
, 
cÚ‹Á_Úly
,

241 
_¤c_addr
, 
_de¡_addr
, 
udp_¤c_pÜt
, 
udp_de¡_pÜt
,

242 
buf
, 
Ën
);

243 
	`munm­
((*)
buf
, 
Ën
);

244 (
»s
);

245 
	}
}

248 
	$maš
(
¬gc
, **
¬gv
)

250 
pÿp_t
 *
pÿp
 = 
NULL
;

251 
pÿp_dum³r_t
 *
pÿp_out
 = 
NULL
;

252 
fd
;

253 
i
;

254 
»s
 = 0;

256 ià(
¬gc
 < 2) {

257 
	`u§ge
(
¬gv
[0]);

260 
pÿp
 = 
	`pÿp_İ’_d—d
(
DLT_NULL
, 
MAX_PACKET
);

261 ià(
NULL
 =ğ
pÿp
) {

262 
	`årštf
(
¡d”r
, "Cannot open…cap descriptor!\n");

263 
	`ex™
(-1);

266 
pÿp_out
 = 
	`pÿp_dump_İ’
(
pÿp
, "-");

267 ià(
NULL
 =ğ
pÿp_out
) {

268 
	`årštf
(
¡d”r
, "Cannot open output stdout!\n");

269 
	`u§ge
(
¬gv
[0]);

272 
i
 = 1; 
¬gv
[i] != 0; i++) {

273 
	`årštf
(
¡d”r
, "<!-- Proûssšg % -->\n", 
¬gv
[
i
]);

275 
fd
 = 
	`İ’
(
¬gv
[
i
], 
O_RDONLY
);

276 ià(-1 =ğ
fd
) {

277 
	`³¼Ü
(
¬gv
[
i
]);

283 
»s
 |ğ
	`´oûss_fd
(
pÿp_out
, 
fd
, 0, 
NULL
, NULL, 0, 0);

286 
	`pÿp_dump_şo£
(
pÿp_out
);

287 
	`pÿp_şo£
(
pÿp
);

288  
»s
;

289 
	}
}

	@cmd/ccnget.c

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

25 
	~<cú/bloom.h
>

26 
	~<cú/cú.h
>

27 
	~<cú/ch¬buf.h
>

28 
	~<cú/uri.h
>

31 
	$u§ge
(cÚ¡ *
´ogÇme
)

33 
	`årštf
(
¡d”r
,

40 
´ogÇme
);

41 
	`ex™
(1);

42 
	}
}

45 
	$maš
(
¬gc
, **
¬gv
)

47 
cú
 *
h
 = 
NULL
;

48 
cú_ch¬buf
 *
Çme
 = 
NULL
;

49 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

50 
cú_ch¬buf
 *
»suÉbuf
 = 
NULL
;

51 cÚ¡ *
¬g
 = 
NULL
;

52 
cú_·r£d_CÚ‹ÁObjeù
 
pcobuf
 = { 0 };

53 
»s
;

54 
ch
;

55 
®low_¡®e
 = 0;

56 
cÚ‹Á_Úly
 = 0;

57 cÚ¡ *
±r
;

58 
size_t
 
Ëngth
;

59 
»sŞve_v”siÚ
 = 0;

60 cÚ¡ *
’v_timeout
 = 
	`g‘’v
("CCN_LINGER");

61 
timeout_ms
 = 3000;

63 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "hacv")) != -1) {

64 
ch
) {

66 
®low_¡®e
 = 1;

69 
cÚ‹Á_Úly
 = 1;

72 ià(
»sŞve_v”siÚ
 == 0)

73 
»sŞve_v”siÚ
 = 
CCN_V_HIGHEST
;

75 
»sŞve_v”siÚ
 = 
CCN_V_HIGH
;

79 
	`u§ge
(
¬gv
[0]);

82 
¬g
 = 
¬gv
[
İtšd
];

83 ià(
¬g
 =ğ
NULL
)

84 
	`u§ge
(
¬gv
[0]);

85 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

86 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬g
);

87 ià(
»s
 < 0) {

88 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
¬gv
[0], 
¬g
);

89 
	`ex™
(1);

91 ià(
¬gv
[
İtšd
 + 1] !ğ
NULL
)

92 
	`årštf
(
¡d”r
, "% w¬nšg:ƒxŒ¨¬gum’t ignÜed\n", 
¬gv
[0]);

93 
h
 = 
	`cú_ü—‹
();

94 
»s
 = 
	`cú_cÚÃù
(
h
, 
NULL
);

95 ià(
»s
 < 0) {

96 
	`cú_³¼Ü
(
h
, "ccn_connect");

97 
	`ex™
(1);

99 ià(
»s
 < 0) {

100 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
¬gv
[0], 
¬g
);

101 
	`ex™
(1);

103 ià(
’v_timeout
 !ğ
NULL
 && (
»s
 = 
	`©oi
(env_timeout)) > 0) {

104 
timeout_ms
 = 
»s
 * 1000;

106 ià(
®low_¡®e
 || 
’v_timeout
 !ğ
NULL
) {

107 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

108 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

109 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

110 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

111 ià(
®low_¡®e
) {

112 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, 
CCN_DTAG
);

113 
	`cúb_­³nd_numb”
(
‹m¶
,

114 
CCN_AOK_DEFAULT
 | 
CCN_AOK_STALE
);

115 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

117 ià(
’v_timeout
 !ğ
NULL
) {

122 
buf
[3] = { 0 };

123 
liãtime
;

124 
i
;

125 ià(
timeout_ms
 > 60000)

126 
liãtime
 = 30 << 12;

128 
liãtime
 = 
timeout_ms
 * 2 / 5 * 4096 / 1000;

130 
i
 = (
buf
è- 1; i >ğ0; i--, 
liãtime
 >>= 8)

131 
buf
[
i
] = 
liãtime
 & 0xff;

132 
	`cúb_­³nd_gged_blob
(
‹m¶
, 
CCN_DTAG_IÁ”e¡Liãtime
, 
buf
, (buf));

134 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

136 
»suÉbuf
 = 
	`cú_ch¬buf_ü—‹
();

137 ià(
»sŞve_v”siÚ
 != 0) {

138 
»s
 = 
	`cú_»sŞve_v”siÚ
(
h
, 
Çme
, 
»sŞve_v”siÚ
, 500);

139 ià(
»s
 >= 0) {

140 
	`cú_uri_­³nd
(
»suÉbuf
, 
Çme
->
buf
,‚ame->
Ëngth
, 1);

141 
	`årštf
(
¡d”r
, "== %s\n",

142 
	`cú_ch¬buf_as_¡ršg
(
»suÉbuf
));

143 
»suÉbuf
->
Ëngth
 = 0;

146 
»s
 = 
	`cú_g‘
(
h
, 
Çme
, 
‹m¶
, 
timeout_ms
, 
»suÉbuf
, &
pcobuf
, 
NULL
, 0);

147 ià(
»s
 >= 0) {

148 
±r
 = 
»suÉbuf
->
buf
;

149 
Ëngth
 = 
»suÉbuf
->length;

150 ià(
cÚ‹Á_Úly
)

151 
	`cú_cÚ‹Á_g‘_v®ue
(
±r
, 
Ëngth
, &
pcobuf
, &ptr, &length);

152 ià(
Ëngth
 > 0)

153 
»s
 = 
	`fwr™e
(
±r
, 
Ëngth
, 1, 
¡dout
) - 1;

155 
	`cú_ch¬buf_de¡roy
(&
»suÉbuf
);

156 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

157 
	`cú_ch¬buf_de¡roy
(&
Çme
);

158 
	`cú_de¡roy
(&
h
);

159 
	`ex™
(
»s
 < 0);

160 
	}
}

	@cmd/ccnhexdumpdata.c

20 
	~<fú.h
>

21 
	~<sys/ty³s.h
>

22 
	~<sys/¡©.h
>

23 
	~<sys/mmª.h
>

24 
	~<lim™s.h
>

25 
	~<¡ddef.h
>

26 
	~<¡dio.h
>

27 
	~<¡dlib.h
>

28 
	~<¡ršg.h
>

29 
	~<uni¡d.h
>

31 
	~<cú/codšg.h
>

32 
	~<cú/cú.h
>

34 
	sf¡©e
 {

35 *
	m´efix
;

36 
	m£gnum
;

40 
	$£gm’t_´efix
(*
·th
)

42 *
s
, *
d
, *
r
;

44 
s
 = 
	`¡¼chr
(
·th
, '/');

45 ià(
s
 =ğ
NULL
è ğ
·th
;

46 
d
 = 
	`¡¼chr
(
s
, '.');

47 ià(
d
 =ğ
NULL
èd = 
s
 + 
	`¡¾’
(s);

48 
r
 = 
	`ÿÎoc
(1, 1 + 
d
 - 
·th
);

49 
	`memıy
(
r
, 
·th
, 
d
 -…ath);

50  (
r
);

51 
	}
}

54 
	$´oûss_‹¡
(*
d©a
, 
size_t
 
n
, 
f¡©e
 *
³rfe¡©e
)

56 
cú_sk–‘Ú_decod”
 
sk–_decod”
 = {0};

57 
cú_sk–‘Ú_decod”
 *
d
 = &
sk–_decod”
;

58 
cú_·r£d_CÚ‹ÁObjeù
 
cÚ‹Á
;

59 
cú_šdexbuf
 *
comps
 = 
	`cú_šdexbuf_ü—‹
();

60 cÚ¡ * 
cÚ‹Á_v®ue
;

61 
size_t
 
cÚ‹Á_Ëngth
;

62 
»s
 = 0;

63 
size_t
 
s
;

64 
i
;

66 
»Œy
:

67 
s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
d©a
, 
n
);

68 ià(
d
->
¡©e
 < 0) {

69 
»s
 = 1;

70 
	`årštf
(
¡d”r
, "error state %d‡fter %d of %d chars\n",

71 ()
d
->
¡©e
, ()
s
, ()
n
);

73 ià(
s
 == 0) {

74 
	`årštf
(
¡d”r
, "nothingo do\n");

76 ià(
s
 < 
n
) {

77 
cÚ‹Á_v®ue
 = 
NULL
;

78 
cÚ‹Á_Ëngth
 = 0;

79 ià(
	`cú_·r£_CÚ‹ÁObjeù
(
d©a
, 
s
, &
cÚ‹Á
, 
comps
) != 0) {

80 
	`årštf
(
¡d”r
, "unableo…arse content object\n");

81 
»s
 = 1;

83 ià(
	`cú_cÚ‹Á_g‘_v®ue
(
d©a
, 
s
, &
cÚ‹Á
, &
cÚ‹Á_v®ue
, &
cÚ‹Á_Ëngth
) != 0) {

84 
	`årštf
(
¡d”r
, "unableo„etrieve content value\n");

85 
»s
 = 1;

87 
i
 = 0; i < 
cÚ‹Á_Ëngth
; i++) {

88 ià(
i
 % 16 =ğ0è
	`´štf
("\n%08x ", i);

89 
	`´štf
(" %02x", 
cÚ‹Á_v®ue
[
i
]);

91 
	`´štf
("\n");

92 
d©a
 +ğ
s
;

93 
n
 -ğ
s
;

94 
»Œy
;

98 ià(!
	`CCN_FINAL_DSTATE
(
d
->
¡©e
)) {

99 
»s
 = 1;

100 
	`årštf
(
¡d”r
, "incomplete state %d‡fter %d of %d chars\n",

101 ()
d
->
¡©e
, ()
s
, ()
n
);

103 
cÚ‹Á_v®ue
 = 
NULL
;

104 
cÚ‹Á_Ëngth
 = 0;

105 ià(
	`cú_·r£_CÚ‹ÁObjeù
(
d©a
, 
s
, &
cÚ‹Á
, 
comps
) != 0) {

106 
	`årštf
(
¡d”r
, "unableo…arse content object\n");

107 
»s
 = 1;

109 ià(
	`cú_cÚ‹Á_g‘_v®ue
(
d©a
, 
s
, &
cÚ‹Á
, &
cÚ‹Á_v®ue
, &
cÚ‹Á_Ëngth
) != 0) {

110 
	`årštf
(
¡d”r
, "unableo„etrieve content value\n");

111 
»s
 = 1;

113 
i
 = 0; i < 
cÚ‹Á_Ëngth
; i++) {

114 ià(
i
 % 16 =ğ0è
	`´štf
("\n%08x ", i);

115 
	`´štf
(" %02x", 
cÚ‹Á_v®ue
[
i
]);

117 
	`´štf
("\n\n");

119 (
»s
);

120 
	}
}

123 
	$´oûss_fd
(
fd
, 
f¡©e
 *
³rfe¡©e
)

125 *
buf
;

126 
ssize_t
 
Ën
;

127 
¡©
 
s
;

128 
»s
 = 0;

130 
»s
 = 
	`f¡©
(
fd
, &
s
);

131 
Ën
 = 
s
.
¡_size
;

132 
buf
 = (*)
	`mm­
((*)
NULL
, 
Ën
, 
PROT_READ
, 
MAP_PRIVATE
, 
fd
, 0);

133 ià(
buf
 == (*)-1)  (1);

134 
	`årštf
(
¡d”r
, " <!-- iÅuˆi %6lu by‹ -->\n", ()
Ën
);

135 
»s
 |ğ
	`´oûss_‹¡
(
buf
, 
Ën
, 
³rfe¡©e
);

136 
	`munm­
((*)
buf
, 
Ën
);

137 (
»s
);

138 
	}
}

142 
	$´oûss_fe
(*
·th
, 
f¡©e
 *
³rfe¡©e
)

144 
fd
;

145 
»s
 = 0;

147 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

148 ià(-1 =ğ
fd
) {

149 
	`³¼Ü
(
·th
);

153 
³rfe¡©e
->
£gnum
 = 0;

154 ià(
³rfe¡©e
->
´efix
 !ğ
NULL
è
	`ä“
(perfilestate->prefix);

155 
³rfe¡©e
->
´efix
 = 
	`£gm’t_´efix
(
·th
);

157 
»s
 = 
	`´oûss_fd
(
fd
, 
³rfe¡©e
);

158 ià(
fd
 > 0)

159 
	`şo£
(
fd
);

160 (
»s
);

161 
	}
}

164 
	$maš
(
¬gc
, *
¬gv
[])

166 
i
;

167 
»s
 = 0;

168 
f¡©e
 
³rfe¡©e
 = {0};

170 
i
 = 1; 
¬gv
[i] != 0; i++) {

171 
	`årštf
(
¡d”r
, "<!-- Proûssšg % -->\n", 
¬gv
[
i
]);

172 
»s
 |ğ
	`´oûss_fe
(
¬gv
[
i
], &
³rfe¡©e
);

174 (
»s
);

175 
	}
}

	@cmd/ccnls.c

20 
	~<”ºo.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<cú/cú.h
>

25 
	~<cú/ch¬buf.h
>

26 
	~<cú/uri.h
>

28 
	supÿÎd©a
 {

29 
	mmagic
;

30 *
	mcouÁ”
;

31 
	mw¬n
;

32 
	mİtiÚ
;

33 
	mn_exş
;

34 
cú_ch¬buf
 **
	mexş
;

37 
	#MUST_VERIFY
 0x01

	)

40 
	$Çmecom·»
(cÚ¡ *
a
, cÚ¡ *
b
)

42 cÚ¡ 
cú_ch¬buf
 *
¯
 = *(cÚ¡ cú_ch¬buà**)
a
;

43 cÚ¡ 
cú_ch¬buf
 *
bb
 = *(cÚ¡ cú_ch¬buà**)
b
;

44 
ªs
 = 
	`cú_com·»_Çmes
(
¯
->
buf
,‡a->
Ëngth
, 
bb
->buf, bb->length);

45 ià(
ªs
 == 0)

46 
	`årštf
(
¡d”r
, "was§t? %d\n", 
__LINE__
);

47  (
ªs
);

48 
	}
}

50 
cú_upÿÎ_»s


51 
	$šcomšg_cÚ‹Á
(

52 
cú_şosu»
 *
£lå
,

53 
cú_upÿÎ_kšd
 
kšd
,

54 
cú_upÿÎ_šfo
 *
šfo
)

56 
cú_ch¬buf
 *
c
 = 
NULL
;

57 
cú_ch¬buf
 *
comp
 = 
NULL
;

58 
cú_ch¬buf
 *
uri
 = 
NULL
;

59 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

60 cÚ¡ *
cúb
 = 
NULL
;

61 
size_t
 
cúb_size
 = 0;

62 
cú_šdexbuf
 *
comps
 = 
NULL
;

63 
m©ched_comps
 = 0;

64 
»s
;

65 
i
;

66 
upÿÎd©a
 *
d©a
 = 
£lå
->data;

68 ià(
d©a
->
magic
 !ğ856372è
	`abÜt
();

69 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
)

70 (
CCN_UPCALL_RESULT_OK
);

71 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

72 (
CCN_UPCALL_RESULT_REEXPRESS
);

73 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_UNVERIFIED
) {

74 ià((
d©a
->
İtiÚ
 & 
MUST_VERIFY
) != 0)

75 (
CCN_UPCALL_RESULT_VERIFY
);

77 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
è
	`abÜt
();

79 
cúb
 = 
šfo
->
cÚ‹Á_cúb
;

80 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

81 
comps
 = 
šfo
->
cÚ‹Á_comps
;

82 
m©ched_comps
 = 
šfo
->
pi
->
´efix_comps
;

83 
c
 = 
	`cú_ch¬buf_ü—‹
();

84 
uri
 = 
	`cú_ch¬buf_ü—‹
();

85 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

87 ià(
m©ched_comps
 > 
comps
->
n
) {

88 
	`cú_uri_­³nd
(
c
, 
cúb
, 
cúb_size
, 1);

89 
	`årštf
(
¡d”r
, "How didhi h­³n? %s\n", 
	`cú_ch¬buf_as_¡ršg
(
uri
));

90 
	`ex™
(1);

92 
d©a
->
couÁ”
[0]++;

94 
	`cú_Çme_š™
(
c
);

95 
»s
 = 
	`cú_Çme_­³nd_compÚ’ts
(
c
, 
šfo
->
š‹»¡_cúb
,

96 
šfo
->
š‹»¡_comps
->
buf
[0],

97 
šfo
->
š‹»¡_comps
->
buf
[
m©ched_comps
]);

98 ià(
»s
 < 0è
	`abÜt
();

100 
comp
 = 
	`cú_ch¬buf_ü—‹
();

101 
	`cú_Çme_š™
(
comp
);

102 ià(
m©ched_comps
 + 1 =ğ
comps
->
n
) {

104 
	`cú_dige¡_CÚ‹ÁObjeù
(
cúb
, 
šfo
->
pco
);

105 
	`cú_Çme_­³nd
(
comp
, 
šfo
->
pco
->
dige¡
, info->pco->
dige¡_by‹s
);

107 ià(
m©ched_comps
 < 
comps
->
n
) {

108 
	`cú_Çme_­³nd_compÚ’ts
(
comp
, 
cúb
,

109 
comps
->
buf
[
m©ched_comps
],

110 
comps
->
buf
[
m©ched_comps
 + 1]);

112 
»s
 = 
	`cú_uri_­³nd
(
uri
, 
comp
->
buf
, comp->
Ëngth
, 0);

113 ià(
»s
 < 0 || 
uri
->
Ëngth
 < 1)

114 
	`årštf
(
¡d”r
, "*** E¼Ü: cúl lš%d„es=%d\n", 
__LINE__
, 
»s
);

116 ià(
uri
->
Ëngth
 == 1)

117 
	`cú_ch¬buf_­³nd
(
uri
, ".", 1);

118 
	`´štf
("%s%s\n", 
	`cú_ch¬buf_as_¡ršg
(
uri
) + 1,

119 
kšd
 =ğ
CCN_UPCALL_CONTENT
 ? " [verified]" : " [unverified]");

121 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

122 
	`cú_ch¬buf_­³nd
(
‹m¶
, 
c
->
buf
, c->
Ëngth
);

123 ià(
m©ched_comps
 =ğ
comps
->
n
) {

125 
	`cú_ch¬buf_de¡roy
(&
comp
);

130 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_MšSuffixCompÚ’ts
, 
CCN_DTAG
);

131 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 1, 
CCN_UDATA
);

132 
	`cú_ch¬buf_­³nd
(
‹m¶
, "1", 1);

133 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

136 
d©a
->
exş
 = 
	`»®loc
(d©a->exş, (d©a->
n_exş
 + 1) * (data->excl[0]));

137 
d©a
->
exş
[d©a->
n_exş
++] = 
comp
;

138 
comp
 = 
NULL
;

140 
	`qsÜt
(
d©a
->
exş
, d©a->
n_exş
, (d©a->exş[0]), &
Çmecom·»
);

141 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Exşude
, 
CCN_DTAG
);

142 
i
 = 0; i < 
d©a
->
n_exş
; i++) {

143 
comp
 = 
d©a
->
exş
[
i
];

144 ià(
comp
->
Ëngth
 < 4è
	`abÜt
();

145 
	`cú_ch¬buf_­³nd
(
‹m¶
, 
comp
->
buf
 + 1, comp->
Ëngth
 - 2);

147 
comp
 = 
NULL
;

148 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

151 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, 
CCN_DTAG
);

152 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 1, 
CCN_UDATA
);

153 
	`cú_ch¬buf_­³nd
(
‹m¶
, "1", 1);

154 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

155 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

156 ià(
‹m¶
->
Ëngth
 > 
d©a
->
w¬n
) {

157 
	`årštf
(
¡d”r
, "*** IÁ”e¡…ack‘ i %d by‹s\n", ()
‹m¶
->
Ëngth
);

158 
d©a
->
w¬n
 = data->warn * 8 / 5;

160 
	`cú_ex´ess_š‹»¡
(
šfo
->
h
, 
c
, 
£lå
, 
‹m¶
);

161 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

162 
	`cú_ch¬buf_de¡roy
(&
c
);

163 
	`cú_ch¬buf_de¡roy
(&
uri
);

164 (
CCN_UPCALL_RESULT_OK
);

165 
	}
}

168 
	$u§ge
(cÚ¡ *
´og
)

170 
	`årštf
(
¡d”r
, "Usage: %s uri\n"

173 "ƒnvœÚm’ˆv¬ CCN_VERIFY indiÿ‹ sigÇtu» v”ifiÿtiÚ i »quœed (nÚ-z”o)\n", 
´og
);

174 
	`ex™
(1);

175 
	}
}

178 
	$maš
(
¬gc
, **
¬gv
)

180 
cú
 *cú = 
NULL
;

181 
cú_ch¬buf
 *
c
 = 
NULL
;

182 
upÿÎd©a
 *
d©a
 = 
NULL
;

183 
i
;

184 
n
;

185 
»s
;

186 
couÁ”
 = 0;

187 
cú_şosu»
 *
ş
 = 
NULL
;

188 
timeout_ms
 = 500;

189 cÚ¡ *
’v_timeout
 = 
	`g‘’v
("CCN_LINGER");

190 cÚ¡ *
’v_v”ify
 = 
	`g‘’v
("CCN_VERIFY");

192 ià(
¬gv
[1] =ğ
NULL
 ||‡rgv[2] != NULL)

193 
	`u§ge
(
¬gv
[0]);

195 ià(
’v_timeout
 !ğ
NULL
 && (
i
 = 
	`©oi
(env_timeout)) > 0)

196 
timeout_ms
 = 
i
 * 1000;

198 
c
 = 
	`cú_ch¬buf_ü—‹
();

199 
»s
 = 
	`cú_Çme_äom_uri
(
c
, 
¬gv
[1]);

200 ià(
»s
 < 0)

201 
	`u§ge
(
¬gv
[0]);

203 
cú
 = 
	`cú_ü—‹
();

204 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

205 
	`³¼Ü
("Could‚ot connecto ccnd");

206 
	`ex™
(1);

209 
d©a
 = 
	`ÿÎoc
(1, (*data));

210 
d©a
->
magic
 = 856372;

211 
d©a
->
w¬n
 = 1492;

212 
d©a
->
couÁ”
 = &counter;

213 
d©a
->
İtiÚ
 = 0;

214 ià(
’v_v”ify
 && *env_verify)

215 
d©a
->
İtiÚ
 |ğ
MUST_VERIFY
;

216 
ş
 = 
	`ÿÎoc
(1, (*cl));

217 
ş
->
p
 = &
šcomšg_cÚ‹Á
;

218 
ş
->
d©a
 = data;

219 
	`cú_ex´ess_š‹»¡
(
cú
, 
c
, 
ş
, 
NULL
);

220 
ş
 = 
NULL
;

221 
d©a
 = 
NULL
;

222 
i
 = 0;; i++) {

223 
n
 = 
couÁ”
;

224 
	`cú_run
(
cú
, 
timeout_ms
);

225 
	`fæush
(
¡dout
);

226 ià(
couÁ”
 =ğ
n
)

229 
	`cú_de¡roy
(&
cú
);

230 
	`cú_ch¬buf_de¡roy
(&
c
);

231 
	`ex™
(0);

232 
	}
}

	@cmd/ccnput.c

20 
	~<”ºo.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/uri.h
>

27 
	~<cú/key¡Üe.h
>

28 
	~<cú/signšg.h
>

30 
ssize_t


31 
	$»ad_fuÎ
(
fd
, *
buf
, 
size_t
 
size
)

33 
size_t
 
i
;

34 
ssize_t
 
»s
 = 0;

35 
i
 = 0; i < 
size
; i +ğ
»s
) {

36 
»s
 = 
	`»ad
(
fd
, 
buf
 + 
i
, 
size
 - i);

37 ià(
»s
 == -1) {

38 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EINTR
)

39 
»s
 = 0;

41 (
»s
);

43 ià(
»s
 == 0)

46 (
i
);

47 
	}
}

50 
	$u§ge
(cÚ¡ *
´ogÇme
)

52 
	`årštf
(
¡d”r
,

73 "\n", 
´ogÇme
);

74 
	`ex™
(1);

75 
	}
}

77 
cú_upÿÎ_»s


78 
	$šcomšg_š‹»¡
(

79 
cú_şosu»
 *
£lå
,

80 
cú_upÿÎ_kšd
 
kšd
,

81 
cú_upÿÎ_šfo
 *
šfo
)

83 
cú_ch¬buf
 *
cob
 = 
£lå
->
d©a
;

84 
»s
;

86 
kšd
) {

87 
CCN_UPCALL_FINAL
:

89 
CCN_UPCALL_INTEREST
:

90 ià(
	`cú_cÚ‹Á_m©ches_š‹»¡
(
cob
->
buf
, cob->
Ëngth
,

91 1, 
NULL
,

92 
šfo
->
š‹»¡_cúb
, info->
pi
->
off£t
[
CCN_PI_E
],

93 
šfo
->
pi
)) {

94 
»s
 = 
	`cú_put
(
šfo
->
h
, 
cob
->
buf
, cob->
Ëngth
);

95 ià(
»s
 >= 0) {

96 
£lå
->
štd©a
 = 1;

97 
	`cú_£t_run_timeout
(
šfo
->
h
, 0);

98 (
CCN_UPCALL_RESULT_INTEREST_CONSUMED
);

105 (
CCN_UPCALL_RESULT_OK
);

106 
	}
}

109 
	$maš
(
¬gc
, **
¬gv
)

111 cÚ¡ *
´ogÇme
 = 
¬gv
[0];

112 
cú
 *cú = 
NULL
;

113 
cú_ch¬buf
 *
Çme
 = 
NULL
;

114 
cú_ch¬buf
 *
²ame
 = 
NULL
;

115 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

116 
expœe
 = -1;

117 
v”siÚed
 = 0;

118 
size_t
 
blocksize
 = 8*1024;

119 
¡©us
 = 0;

120 
»s
;

121 
ssize_t
 
»ad_»s
;

122 *
buf
 = 
NULL
;

123 
cú_cÚ‹Á_ty³
 
cÚ‹Á_ty³
 = 
CCN_CONTENT_DATA
;

124 
cú_şosu»
 
š_š‹»¡
 = {.
p
=&
šcomšg_š‹»¡
};

125 cÚ¡ *
po¡v”
 = 
NULL
;

126 cÚ¡ *
key_uri
 = 
NULL
;

127 
fÜû
 = 0;

128 
v”bo£
 = 0;

129 
timeout
 = -1;

130 
£tfš®
 = 0;

131 
cú_signšg_·¿ms
 
¥
 = 
CCN_SIGNING_PARAMS_INIT
;

133 (
»s
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "fhk:lvV:t:w:x:")) != -1) {

134 
»s
) {

136 
fÜû
 = 1;

139 
£tfš®
 = 1;

142 
key_uri
 = 
İrg
;

145 
expœe
 = 
	`©Ş
(
İrg
);

146 ià(
expœe
 <= 0)

147 
	`u§ge
(
´ogÇme
);

150 
v”bo£
 = 1;

153 
v”siÚed
 = 1;

154 
po¡v”
 = 
İrg
;

155 ià(0 =ğ
	`memcmp
(
po¡v”
, "%00", 3))

156 
£tfš®
 = 1;

159 
timeout
 = 
	`©Ş
(
İrg
);

160 ià(
timeout
 <= 0)

161 
	`u§ge
(
´ogÇme
);

162 
timeout
 *= 1000;

165 ià(0 =ğ
	`¡rÿ£cmp
(
İrg
, "DATA")) {

166 
cÚ‹Á_ty³
 = 
CCN_CONTENT_DATA
;

169 ià(0 =ğ
	`¡rÿ£cmp
(
İrg
, "ENCR")) {

170 
cÚ‹Á_ty³
 = 
CCN_CONTENT_ENCR
;

173 ià(0 =ğ
	`¡rÿ£cmp
(
İrg
, "GONE")) {

174 
cÚ‹Á_ty³
 = 
CCN_CONTENT_GONE
;

177 ià(0 =ğ
	`¡rÿ£cmp
(
İrg
, "KEY")) {

178 
cÚ‹Á_ty³
 = 
CCN_CONTENT_KEY
;

181 ià(0 =ğ
	`¡rÿ£cmp
(
İrg
, "LINK")) {

182 
cÚ‹Á_ty³
 = 
CCN_CONTENT_LINK
;

185 ià(0 =ğ
	`¡rÿ£cmp
(
İrg
, "NACK")) {

186 
cÚ‹Á_ty³
 = 
CCN_CONTENT_NACK
;

189 
cÚ‹Á_ty³
 = 
	`©oi
(
İrg
);

190 ià(
cÚ‹Á_ty³
 > 0 && content_type <= 0xffffff)

192 
	`årštf
(
¡d”r
, "UnknowÀcÚ‹Áy³ %s\n", 
İrg
);

196 
	`u§ge
(
´ogÇme
);

200 
¬gc
 -ğ
İtšd
;

201 
¬gv
 +ğ
İtšd
;

202 ià(
¬gv
[0] =ğ
NULL
)

203 
	`u§ge
(
´ogÇme
);

204 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

205 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬gv
[0]);

206 ià(
»s
 < 0) {

207 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
´ogÇme
, 
¬gv
[0]);

208 
	`ex™
(1);

210 ià(
¬gv
[1] !ğ
NULL
)

211 
	`årštf
(
¡d”r
, "% w¬nšg:ƒxŒ¨¬gum’t ignÜed\n", 
´ogÇme
);

214 
²ame
 = 
	`cú_ch¬buf_ü—‹
();

215 
	`cú_ch¬buf_­³nd
(
²ame
, 
Çme
->
buf
,‚ame->
Ëngth
);

218 
cú
 = 
	`cú_ü—‹
();

219 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

220 
	`³¼Ü
("Could‚ot connecto ccnd");

221 
	`ex™
(1);

225 
buf
 = 
	`ÿÎoc
(1, 
blocksize
);

226 
»ad_»s
 = 
	`»ad_fuÎ
(0, 
buf
, 
blocksize
);

227 ià(
»ad_»s
 < 0) {

228 
	`³¼Ü
("read");

229 
»ad_»s
 = 0;

230 
¡©us
 = 1;

234 ià(
v”siÚed
) {

235 
»s
 = 
	`cú_ü—‹_v”siÚ
(
cú
, 
Çme
, 
CCN_V_REPLACE
 | 
CCN_V_NOW
 | 
CCN_V_HIGH
, 0, 0);

236 ià(
»s
 < 0) {

237 
	`årštf
(
¡d”r
, "%s: cú_ü—‹_v”siÚ(èçed\n", 
´ogÇme
);

238 
	`ex™
(1);

240 ià(
po¡v”
 !ğ
NULL
) {

241 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
po¡v”
);

242 ià(
»s
 < 0) {

243 
	`årštf
(
¡d”r
, "-V %s: inv®id‚amsuffix\n", 
po¡v”
);

244 
	`ex™
(0);

248 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

251 ià(
£tfš®
)

252 
¥
.
¥_æags
 |ğ
CCN_SP_FINAL_BLOCK
;

254 ià(
»s
 < 0) {

255 
	`årštf
(
¡d”r
, "FaedØü—‹ sigÃd_šfØÔe =ğ%d)\n", 
»s
);

256 
	`ex™
(1);

260 
¥
.
ty³
 = 
cÚ‹Á_ty³
;

263 ià(
expœe
 >= 0) {

264 ià(
¥
.
‹m¶©e_cúb
 =ğ
NULL
) {

265 
¥
.
‹m¶©e_cúb
 = 
	`cú_ch¬buf_ü—‹
();

266 
	`cú_ch¬buf_­³nd_‰
(
¥
.
‹m¶©e_cúb
, 
CCN_DTAG_SigÃdInfo
, 
CCN_DTAG
);

268 ià(
¥
.
‹m¶©e_cúb
->
Ëngth
 > 0) {

269 
¥
.
‹m¶©e_cúb
->
Ëngth
--;

271 
	`cúb_gged_putf
(
¥
.
‹m¶©e_cúb
, 
CCN_DTAG_F»shÃssSecÚds
, "%ld", 
expœe
);

272 
¥
.
¥_æags
 |ğ
CCN_SP_TEMPL_FRESHNESS
;

273 
	`cú_ch¬buf_­³nd_şo£r
(
¥
.
‹m¶©e_cúb
);

277 ià(
key_uri
 !ğ
NULL
) {

278 
cú_ch¬buf
 *
c
 = 
	`cú_ch¬buf_ü—‹
();

279 
»s
 = 
	`cú_Çme_äom_uri
(
c
, 
key_uri
);

280 ià(
»s
 < 0) {

281 
	`årštf
(
¡d”r
, "% i nÙ‡ v®id cúx URI\n", 
key_uri
);

282 
	`ex™
(1);

284 ià(
¥
.
‹m¶©e_cúb
 =ğ
NULL
) {

285 
¥
.
‹m¶©e_cúb
 = 
	`cú_ch¬buf_ü—‹
();

286 
	`cú_ch¬buf_­³nd_‰
(
¥
.
‹m¶©e_cúb
, 
CCN_DTAG_SigÃdInfo
, 
CCN_DTAG
);

288 ià(
¥
.
‹m¶©e_cúb
->
Ëngth
 > 0) {

289 
¥
.
‹m¶©e_cúb
->
Ëngth
--;

291 
	`cú_ch¬buf_­³nd_‰
(
¥
.
‹m¶©e_cúb
, 
CCN_DTAG_KeyLoÿtÜ
, 
CCN_DTAG
);

292 
	`cú_ch¬buf_­³nd_‰
(
¥
.
‹m¶©e_cúb
, 
CCN_DTAG_KeyName
, 
CCN_DTAG
);

293 
	`cú_ch¬buf_­³nd
(
¥
.
‹m¶©e_cúb
, 
c
->
buf
, c->
Ëngth
);

294 
	`cú_ch¬buf_­³nd_şo£r
(
¥
.
‹m¶©e_cúb
);

295 
	`cú_ch¬buf_­³nd_şo£r
(
¥
.
‹m¶©e_cúb
);

296 
¥
.
¥_æags
 |ğ
CCN_SP_TEMPL_KEY_LOCATOR
;

297 
	`cú_ch¬buf_­³nd_şo£r
(
¥
.
‹m¶©e_cúb
);

298 
	`cú_ch¬buf_de¡roy
(&
c
);

302 
‹mp
->
Ëngth
 = 0;

303 
»s
 = 
	`cú_sign_cÚ‹Á
(
cú
, 
‹mp
, 
Çme
, &
¥
, 
buf
, 
»ad_»s
);

304 ià(
»s
 != 0) {

305 
	`årštf
(
¡d”r
, "FaedØ’codCÚ‹ÁObjeù (» =ğ%d)\n", 
»s
);

306 
	`ex™
(1);

308 ià(
»ad_»s
 =ğ
blocksize
) {

309 
»ad_»s
 = 
	`»ad_fuÎ
(0, 
buf
, 1);

310 ià(
»ad_»s
 == 1) {

311 
	`årštf
(
¡d”r
, "%s: w¬nšg -runÿ‹d d©a\n", 
¬gv
[0]);

312 
¡©us
 = 1;

315 
	`ä“
(
buf
);

316 
buf
 = 
NULL
;

317 ià(
fÜû
) {

319 
»s
 = 
	`cú_put
(
cú
, 
‹mp
->
buf
,emp->
Ëngth
);

320 ià(
»s
 < 0) {

321 
	`årštf
(
¡d”r
, "cú_puˆçed (» =ğ%d)\n", 
»s
);

322 
	`ex™
(1);

326 
š_š‹»¡
.
d©a
 = 
‹mp
;

328 
»s
 = 
	`cú_£t_š‹»¡_f‹r
(
cú
, 
²ame
, &
š_š‹»¡
);

329 ià(
»s
 < 0) {

330 
	`årštf
(
¡d”r
, "FaedØ»gi¡” iÁ”e¡ (» =ğ%d)\n", 
»s
);

331 
	`ex™
(1);

333 
»s
 = 
	`cú_run
(
cú
, 
timeout
);

334 ià(
š_š‹»¡
.
štd©a
 == 0) {

335 ià(
v”bo£
)

336 
	`årštf
(
¡d”r
, "Nobody's interested\n");

337 
	`ex™
(1);

341 ià(
v”bo£
) {

342 
cú_ch¬buf
 *
uri
 = 
	`cú_ch¬buf_ü—‹
();

343 
uri
->
Ëngth
 = 0;

344 
	`cú_uri_­³nd
(
uri
, 
Çme
->
buf
,‚ame->
Ëngth
, 1);

345 
	`´štf
("wrÙ%s\n", 
	`cú_ch¬buf_as_¡ršg
(
uri
));

346 
	`cú_ch¬buf_de¡roy
(&
uri
);

348 
	`cú_de¡roy
(&
cú
);

349 
	`cú_ch¬buf_de¡roy
(&
Çme
);

350 
	`cú_ch¬buf_de¡roy
(&
²ame
);

351 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

352 
	`cú_ch¬buf_de¡roy
(&
¥
.
‹m¶©e_cúb
);

353 
	`ex™
(
¡©us
);

354 
	}
}

	@cmd/ccnrm.c

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<uni¡d.h
>

24 
	~<cú/cú.h
>

25 
	~<cú/uri.h
>

28 
	$u§ge
(cÚ¡ *
´ogÇme
)

30 
	`årštf
(
¡d”r
,

34 
´ogÇme
);

35 
	`ex™
(1);

36 
	}
}

45 
cú_ch¬buf
 *

46 
	$loÿl_scİe_rm_‹m¶©e
()

48 
cú_ch¬buf
 *
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

49 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

50 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

51 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

52 
	`cúb_gged_putf
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, "%2d",

53 (
CCN_AOK_EXPIRE
 | 
CCN_AOK_DEFAULT
));

54 
	`cúb_gged_putf
(
‹m¶
, 
CCN_DTAG_Scİe
, "0");

55 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

56 (
‹m¶
);

57 
	}
}

60 
	smyd©a
 {

61 
	mn£’
;

62 
FILE
 *
	mouut
;

63 } 
	gmyd©a
 = {0, 
NULL
};

65 
cú_upÿÎ_»s


66 
	$šcomšg_cÚ‹Á
(

67 
cú_şosu»
 *
£lå
,

68 
cú_upÿÎ_kšd
 
kšd
,

69 
cú_upÿÎ_šfo
 *
šfo
)

71 
myd©a
 *
md
 = 
£lå
->
d©a
;

73 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
)

74 (
CCN_UPCALL_RESULT_OK
);

75 ià(
md
 =ğ
NULL
)

76 (
CCN_UPCALL_RESULT_ERR
);

77 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

78 (
CCN_UPCALL_RESULT_REEXPRESS
);

79 ià((
kšd
 !ğ
CCN_UPCALL_CONTENT
 && kšd !ğ
CCN_UPCALL_CONTENT_UNVERIFIED
))

80 (
CCN_UPCALL_RESULT_ERR
);

81 
md
->
n£’
++;

82 ià(
md
->
ouut
 !ğ
NULL
)

83 
	`fwr™e
(
šfo
->
cÚ‹Á_cúb
, info->
pco
->
off£t
[
CCN_PCO_E
], 1, 
md
->
ouut
);

84 (
CCN_UPCALL_RESULT_REEXPRESS
);

85 
	}
}

88 
cú_şosu»
 
	gšcomšg_cÚ‹Á_aùiÚ
 = {

89 .
p
 = &
šcomšg_cÚ‹Á
,

90 .
	gd©a
 = &
myd©a


94 
	$maš
(
¬gc
, **
¬gv
)

96 
cú
 *cú = 
NULL
;

97 
cú_ch¬buf
 *
c
 = 
NULL
;

98 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

99 
i
;

100 
»s
;

101 
ch
;

102 
FILE
* 
şo£this
 = 
NULL
;

104 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "ho:")) != -1) {

105 
ch
) {

107 ià(
	`¡rcmp
(
İrg
, "-") == 0)

108 
myd©a
.
ouut
 = 
¡dout
;

110 
myd©a
.
ouut
 = 
şo£this
 = 
	`fİ’
(
İrg
, "wb");

111 ià(
myd©a
.
ouut
 =ğ
NULL
) {

112 
	`³¼Ü
(
İrg
);

113 
	`ex™
(1);

117 : 
	`u§ge
(
¬gv
[0]);

121 
cú
 = 
	`cú_ü—‹
();

122 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

123 
	`³¼Ü
("Could‚ot connecto ccnd");

124 
	`ex™
(1);

126 
c
 = 
	`cú_ch¬buf_ü—‹
();

128 
‹m¶
 = 
	`loÿl_scİe_rm_‹m¶©e
();

129 
i
 = 
İtšd
; 
¬gv
[i] !ğ
NULL
; i++) {

130 
c
->
Ëngth
 = 0;

131 
»s
 = 
	`cú_Çme_äom_uri
(
c
, 
¬gv
[
i
]);

132 ià(
»s
 < 0) {

133 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
¬gv
[0],‡rgv[
i
]);

134 
	`ex™
(1);

136 
	`cú_ex´ess_š‹»¡
(
cú
, 
c
, &
šcomšg_cÚ‹Á_aùiÚ
, 
‹m¶
);

138 ià(
i
 =ğ
İtšd
)

139 
	`u§ge
(
¬gv
[0]);

140 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

141 
	`cú_ch¬buf_de¡roy
(&
c
);

142 
i
 = 0;; i++) {

143 
»s
 = 
myd©a
.
n£’
;

144 
	`cú_run
(
cú
, 100);

145 ià(
»s
 =ğ
myd©a
.
n£’
)

148 ià(
şo£this
 !ğ
NULL
)

149 
	`fşo£
(
şo£this
);

150 
	`cú_de¡roy
(&
cú
);

151 
	`årštf
(
¡d”r
, "m¬ked sË: %d\n", 
myd©a
.
n£’
);

152 
	`ex™
(0);

153 
	}
}

	@cmd/ccnsendchunks.c

20 
	~<”ºo.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/uri.h
>

27 
	~<cú/key¡Üe.h
>

28 
	~<cú/signšg.h
>

30 
	smyd©a
 {

31 
	mcÚ‹Á_»ûived
;

32 
	mcÚ‹Á_£Á
;

33 
	mout¡ªdšg
;

36 
cú_upÿÎ_»s


37 
	$šcomšg_cÚ‹Á
(

38 
cú_şosu»
 *
£lå
,

39 
cú_upÿÎ_kšd
 
kšd
,

40 
cú_upÿÎ_šfo
 *
šfo
)

42 
myd©a
 *
md
 = 
£lå
->
d©a
;

44 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
)

45 (
CCN_UPCALL_RESULT_OK
);

46 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

47 (
CCN_UPCALL_RESULT_OK
);

48 ià((
kšd
 !ğ
CCN_UPCALL_CONTENT
 && kšd !ğ
CCN_UPCALL_CONTENT_UNVERIFIED
è|| 
md
 =ğ
NULL
)

49 (
CCN_UPCALL_RESULT_ERR
);

50 
md
->
cÚ‹Á_»ûived
++;

51 
	`cú_£t_run_timeout
(
šfo
->
h
, 0);

52 (
CCN_UPCALL_RESULT_OK
);

53 
	}
}

55 
cú_upÿÎ_»s


56 
	$šcomšg_š‹»¡
(

57 
cú_şosu»
 *
£lå
,

58 
cú_upÿÎ_kšd
 
kšd
,

59 
cú_upÿÎ_šfo
 *
šfo
)

61 
myd©a
 *
md
 = 
£lå
->
d©a
;

63 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
)

64 (
CCN_UPCALL_RESULT_OK
);

65 ià(
kšd
 !ğ
CCN_UPCALL_INTEREST
 || 
md
 =ğ
NULL
)

66 (
CCN_UPCALL_RESULT_ERR
);

67 ià((
šfo
->
pi
->
ªsw”äom
 & 
CCN_AOK_NEW
) != 0) {

68 ià(
md
->
out¡ªdšg
 < 10)

69 
md
->
out¡ªdšg
 = 10;

70 
	`cú_£t_run_timeout
(
šfo
->
h
, 0);

72 (
CCN_UPCALL_RESULT_OK
);

73 
	}
}

75 
ssize_t


76 
	$»ad_fuÎ
(
fd
, *
buf
, 
size_t
 
size
)

78 
size_t
 
i
;

79 
ssize_t
 
»s
 = 0;

80 
i
 = 0; i < 
size
; i +ğ
»s
) {

81 
»s
 = 
	`»ad
(
fd
, 
buf
 + 
i
, 
size
 - i);

82 ià(
»s
 == -1) {

83 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EINTR
)

84 
»s
 = 0;

86 (
»s
);

88 ià(
»s
 == 0)

91 (
i
);

92 
	}
}

95 
	$u§ge
(cÚ¡ *
´ogÇme
)

97 
	`årštf
(
¡d”r
,

101 "und”hgiv’ uri\n", 
´ogÇme
);

102 
	`ex™
(1);

103 
	}
}

106 
	$maš
(
¬gc
, **
¬gv
)

108 cÚ¡ *
´ogÇme
 = 
¬gv
[0];

109 
cú
 *cú = 
NULL
;

110 
cú_ch¬buf
 *
roÙ
 = 
NULL
;

111 
cú_ch¬buf
 *
Çme
 = 
NULL
;

112 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

113 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

114 
cú_ch¬buf
 *
sigÃd_šfo
 = 
NULL
;

115 
cú_ch¬buf
 *
keyloÿtÜ
 = 
NULL
;

116 
cú_ch¬buf
 *
fš®blockid
 = 
NULL
;

117 
cú_key¡Üe
 *
key¡Üe
 = 
NULL
;

118 
expœe
 = -1;

119 
blocksize
 = 1024;

120 
i
;

121 
¡©us
 = 0;

122 
»s
;

123 
ssize_t
 
»ad_»s
;

124 *
buf
 = 
NULL
;

125 
myd©a
 mydata = { 0 };

126 
cú_şosu»
 
š_cÚ‹Á
 = {.
p
=&
šcomšg_cÚ‹Á
, .
d©a
=&
myd©a
};

127 
cú_şosu»
 
š_š‹»¡
 = {.
p
=&
šcomšg_š‹»¡
, .
d©a
=&
myd©a
};

128 (
»s
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "hx:b:")) != -1) {

129 
»s
) {

131 
expœe
 = 
	`©Ş
(
İrg
);

132 ià(
expœe
 <= 0)

133 
	`u§ge
(
´ogÇme
);

136 
blocksize
 = 
	`©Ş
(
İrg
);

140 
	`u§ge
(
´ogÇme
);

144 
¬gc
 -ğ
İtšd
;

145 
¬gv
 +ğ
İtšd
;

146 ià(
¬gv
[0] =ğ
NULL
)

147 
	`u§ge
(
´ogÇme
);

148 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

149 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬gv
[0]);

150 ià(
»s
 < 0) {

151 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
´ogÇme
, 
¬gv
[0]);

152 
	`ex™
(1);

154 ià(
¬gv
[1] !ğ
NULL
)

155 
	`årštf
(
¡d”r
, "% w¬nšg:ƒxŒ¨¬gum’t ignÜed\n", 
´ogÇme
);

157 
cú
 = 
	`cú_ü—‹
();

158 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

159 
	`³¼Ü
("Could‚ot connecto ccnd");

160 
	`ex™
(1);

163 
buf
 = 
	`ÿÎoc
(1, 
blocksize
);

164 
roÙ
 = 
Çme
;

165 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

166 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

167 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

168 
sigÃd_šfo
 = 
	`cú_ch¬buf_ü—‹
();

169 
key¡Üe
 = 
	`cú_key¡Üe_ü—‹
();

170 
‹mp
->
Ëngth
 = 0;

171 
	`cú_ch¬buf_putf
(
‹mp
, "%s/.cúx/.cúx_key¡Üe", 
	`g‘’v
("HOME"));

172 
»s
 = 
	`cú_key¡Üe_š™
(
key¡Üe
,

173 
	`cú_ch¬buf_as_¡ršg
(
‹mp
),

175 ià(
»s
 != 0) {

176 
	`´štf
("Failedo initialize keystore\n");

177 
	`ex™
(1);

180 
Çme
->
Ëngth
 = 0;

181 
	`cú_ch¬buf_­³nd
(
Çme
, 
roÙ
->
buf
,„oÙ->
Ëngth
);

184 
	`cú_£t_š‹»¡_f‹r
(
cú
, 
Çme
, &
š_š‹»¡
);

187 
‹mp
->
Ëngth
 = 0;

188 
	`cú_ch¬buf_putf
(
‹mp
, "%d", 0);

189 
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
);

190 
‹m¶
->
Ëngth
 = 0;

191 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

192 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

193 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

194 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_MaxSuffixCompÚ’ts
, 
CCN_DTAG
);

195 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 1, 
CCN_UDATA
);

196 
	`cú_ch¬buf_­³nd
(
‹m¶
, "1", 1);

197 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

199 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

200 
»s
 = 
	`cú_ex´ess_š‹»¡
(
cú
, 
Çme
, &
š_cÚ‹Á
, 
‹m¶
);

201 ià(
»s
 < 0è
	`abÜt
();

204 
keyloÿtÜ
 = 
	`cú_ch¬buf_ü—‹
();

205 
	`cú_ch¬buf_­³nd_‰
(
keyloÿtÜ
, 
CCN_DTAG_KeyLoÿtÜ
, 
CCN_DTAG
);

206 
	`cú_ch¬buf_­³nd_‰
(
keyloÿtÜ
, 
CCN_DTAG_Key
, 
CCN_DTAG
);

207 
»s
 = 
	`cú_­³nd_pubkey_blob
(
keyloÿtÜ
, 
	`cú_key¡Üe_public_key
(
key¡Üe
));

208 ià(
»s
 < 0)

209 
	`cú_ch¬buf_de¡roy
(&
keyloÿtÜ
);

211 
	`cú_ch¬buf_­³nd_şo£r
(
keyloÿtÜ
);

212 
	`cú_ch¬buf_­³nd_şo£r
(
keyloÿtÜ
);

215 
i
 = 0;; i++) {

216 
»ad_»s
 = 
	`»ad_fuÎ
(0, 
buf
, 
blocksize
);

217 ià(
»ad_»s
 < 0) {

218 
	`³¼Ü
("read");

219 
»ad_»s
 = 0;

220 
¡©us
 = 1;

222 
sigÃd_šfo
->
Ëngth
 = 0;

223 ià(
»ad_»s
 < 
blocksize
) {

224 
‹mp
->
Ëngth
 = 0;

225 
	`cú_ch¬buf_putf
(
‹mp
, "%d", 
i
);

226 
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
);

227 
fš®blockid
 = 
	`cú_ch¬buf_ü—‹
();

228 
	`cú_ch¬buf_­³nd_‰
(
fš®blockid
, 
‹mp
->
Ëngth
, 
CCN_BLOB
);

229 
	`cú_ch¬buf_­³nd
(
fš®blockid
, 
‹mp
->
buf
,emp->
Ëngth
);

231 
»s
 = 
	`cú_sigÃd_šfo_ü—‹
(
sigÃd_šfo
,

232  
	`cú_key¡Üe_public_key_dige¡
(
key¡Üe
),

233  
	`cú_key¡Üe_public_key_dige¡_Ëngth
(
key¡Üe
),

234  
NULL
,

235  
CCN_CONTENT_DATA
,

236  
expœe
,

237 
fš®blockid
,

238 
keyloÿtÜ
);

240 
	`cú_ch¬buf_de¡roy
(&
keyloÿtÜ
);

241 ià(
»s
 < 0) {

242 
	`årštf
(
¡d”r
, "FaedØü—‹ sigÃd_šfØÔe =ğ%d)\n", 
»s
);

243 
	`ex™
(1);

245 
Çme
->
Ëngth
 = 0;

246 
	`cú_ch¬buf_­³nd
(
Çme
, 
roÙ
->
buf
,„oÙ->
Ëngth
);

247 
‹mp
->
Ëngth
 = 0;

248 
	`cú_ch¬buf_putf
(
‹mp
, "%d", 
i
);

249 
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
);

250 
‹mp
->
Ëngth
 = 0;

251 
	`cú_ch¬buf_­³nd
(
‹mp
, 
buf
, 
»ad_»s
);

252 
‹mp
->
Ëngth
 = 0;

253 
»s
 = 
	`cú_’code_CÚ‹ÁObjeù
(
‹mp
,

254 
Çme
,

255 
sigÃd_šfo
,

256 
buf
,

257 
»ad_»s
,

258 
NULL
,

259 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
));

260 ià(
»s
 != 0) {

261 
	`årštf
(
¡d”r
, "FaedØ’codCÚ‹ÁObjeù (» =ğ%d)\n", 
»s
);

262 
	`ex™
(1);

264 ià(
i
 == 0) {

266 ià(
myd©a
.
cÚ‹Á_»ûived
 == 0)

267 
	`cú_run
(
cú
, 100);

268 ià(
myd©a
.
cÚ‹Á_»ûived
 > 0) {

269 
	`årštf
(
¡d”r
, "%s:‚ami š u£: %s\n", 
´ogÇme
, 
¬gv
[0]);

270 
	`ex™
(1);

272 
myd©a
.
out¡ªdšg
++;

274 
»s
 = 
	`cú_put
(
cú
, 
‹mp
->
buf
,emp->
Ëngth
);

275 ià(
»s
 < 0) {

276 
	`årštf
(
¡d”r
, "cú_puˆçed (» =ğ%d)\n", 
»s
);

277 
	`ex™
(1);

279 ià(
»ad_»s
 < 
blocksize
)

281 ià(
myd©a
.
out¡ªdšg
 > 0)

282 
myd©a
.
out¡ªdšg
--;

284 
»s
 = 10;

285 
»s
 = 
	`cú_run
(
cú
,„es * 100);

286 ià(
»s
 < 0) {

287 
¡©us
 = 1;

292 
	`ä“
(
buf
);

293 
buf
 = 
NULL
;

294 
	`cú_ch¬buf_de¡roy
(&
roÙ
);

295 
	`cú_ch¬buf_de¡roy
(&
Çme
);

296 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

297 
	`cú_ch¬buf_de¡roy
(&
sigÃd_šfo
);

298 
	`cú_ch¬buf_de¡roy
(&
fš®blockid
);

299 
	`cú_key¡Üe_de¡roy
(&
key¡Üe
);

300 
	`cú_de¡roy
(&
cú
);

301 
	`ex™
(
¡©us
);

302 
	}
}

	@cmd/ccnseqwriter.c

20 
	~<”ºo.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/uri.h
>

27 
	~<cú/£qwr™”.h
>

30 
	$u§ge
(cÚ¡ *
´ogÇme
)

32 
	`årštf
(
¡d”r
,

35 " usšg cú v”siÚšg‡nd segm’tiÚ.\n", 
´ogÇme
);

36 
	`ex™
(1);

37 
	}
}

40 
	$maš
(
¬gc
, **
¬gv
)

42 cÚ¡ *
´ogÇme
 = 
¬gv
[0];

43 
cú
 *cú = 
NULL
;

44 
cú_ch¬buf
 *
Çme
 = 
NULL
;

45 
cú_£qwr™”
 *
w
 = 
NULL
;

46 
blocksize
 = 1024;

47 
i
;

48 
¡©us
 = 0;

49 
»s
;

50 
ssize_t
 
»ad_»s
;

51 *
buf
 = 
NULL
;

52 (
»s
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "hb:")) != -1) {

53 
»s
) {

55 
blocksize
 = 
	`©Ş
(
İrg
);

56 ià(
blocksize
 <= 0 || blocksize > 4096)

57 
	`u§ge
(
´ogÇme
);

61 
	`u§ge
(
´ogÇme
);

65 
¬gc
 -ğ
İtšd
;

66 
¬gv
 +ğ
İtšd
;

67 ià(
¬gv
[0] =ğ
NULL
)

68 
	`u§ge
(
´ogÇme
);

69 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

70 
»s
 = 
	`cú_Çme_äom_uri
(
Çme
, 
¬gv
[0]);

71 ià(
»s
 < 0) {

72 
	`årštf
(
¡d”r
, "%s: bad cúx URI: %s\n", 
´ogÇme
, 
¬gv
[0]);

73 
	`ex™
(1);

75 ià(
¬gv
[1] !ğ
NULL
)

76 
	`årštf
(
¡d”r
, "% w¬nšg:ƒxŒ¨¬gum’t ignÜed\n", 
´ogÇme
);

78 
cú
 = 
	`cú_ü—‹
();

79 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

80 
	`³¼Ü
("Could‚ot connecto ccnd");

81 
	`ex™
(1);

84 
buf
 = 
	`ÿÎoc
(1, 
blocksize
);

86 
w
 = 
	`cú_£qw_ü—‹
(
cú
, 
Çme
);

87 ià(
w
 =ğ
NULL
) {

88 
	`årštf
(
¡d”r
, "ccn_seqw_create failed\n");

89 
	`ex™
(1);

91 
i
 = 0;; i++) {

92 
	`cú_run
(
cú
, 1);

93 
»ad_»s
 = 
	`»ad
(0, 
buf
, 
blocksize
);

94 ià(
»ad_»s
 < 0) {

95 
	`³¼Ü
("read");

96 
»ad_»s
 = 0;

97 
¡©us
 = 1;

99 ià(
»ad_»s
 == 0) {

100 
	`cú_£qw_şo£
(
w
);

101 
w
 = 
NULL
;

102 
¡©us
 = 0;

105 
»s
 = 
	`cú_£qw_wr™e
(
w
, 
buf
, 
»ad_»s
);

106 
»s
 == -1) {

107 
	`cú_run
(
cú
, 100);

108 
»s
 = 
	`cú_£qw_wr™e
(
w
, 
buf
, 
»ad_»s
);

110 ià(
»s
 !ğ
»ad_»s
)

111 
	`abÜt
();

113 
	`cú_run
(
cú
, 1);

114 
	`ä“
(
buf
);

115 
buf
 = 
NULL
;

116 
	`cú_ch¬buf_de¡roy
(&
Çme
);

117 
	`cú_de¡roy
(&
cú
);

118 
	`ex™
(
¡©us
);

119 
	}
}

	@cmd/ccnslurp.c

20 
	~<”ºo.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<cú/bloom.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/ch¬buf.h
>

27 
	~<cú/uri.h
>

29 
	supÿÎd©a
 {

30 
	mmagic
;

31 *
	mcouÁ”
;

32 
	mw¬n
;

33 
	mæags
;

34 
	mn_exş
;

35 
cú_ch¬buf
 **
	mexş
;

37 
	#EXCLUDE_LOW
 1

	)

38 
	#EXCLUDE_HIGH
 2

	)

41 
Çmecom·»
(cÚ¡ *
a
, cÚ¡ *
b
);

42 
upÿÎd©a
 *
g‘_my_d©a
(
cú_şosu»
 *
£lå
);

43 
­³nd_bf_®l
(
cú_ch¬buf
 *
c
);

44 
ex´ess_my_š‹»¡
(
cú
 *
h
,

45 
cú_şosu»
 *
£lå
,

46 
cú_ch¬buf
 *
Çme
);

47 
cú_şosu»
 *
¥l™_my_exşudes
(cú_şosu» *
£lå
);

48 
cú_upÿÎ_»s
 
šcomšg_cÚ‹Á
(
cú_şosu»
 *
£lå
,

49 
cú_upÿÎ_kšd
 
kšd
,

50 
cú_upÿÎ_šfo
 *);

51 
cú_ch¬buf
 *
cú_ch¬buf_du¶iÿ‹
(ccn_charbuf *);

52 
ªsw”_·ssive
(
cú_ch¬buf
 *
‹m¶
);

55 
cú_ch¬buf
 *
	g·ssive_‹m¶
;

56 
cú_ch¬buf
 *

57 
	$ü—‹_·ssive_‹m¶
()

59 
cú_ch¬buf
 *
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

60 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

61 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

62 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

63 
	`ªsw”_·ssive
(
‹m¶
);

64 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

65 (
‹m¶
);

66 
	}
}

75 
	$Çmecom·»
(cÚ¡ *
a
, cÚ¡ *
b
)

77 cÚ¡ 
cú_ch¬buf
 *
¯
 = *(cÚ¡ cú_ch¬buà**)
a
;

78 cÚ¡ 
cú_ch¬buf
 *
bb
 = *(cÚ¡ cú_ch¬buà**)
b
;

79 
ªs
 = 
	`cú_com·»_Çmes
(
¯
->
buf
,‡a->
Ëngth
, 
bb
->buf, bb->length);

80 ià(
ªs
 == 0)

81 
	`årštf
(
¡d”r
, "was§t? %d\n", 
__LINE__
);

82  (
ªs
);

83 
	}
}

85 
upÿÎd©a
 *
	$g‘_my_d©a
(
cú_şosu»
 *
£lå
)

87 
upÿÎd©a
 *
d©a
 = 
£lå
->data;

88 ià(
d©a
->
magic
 !ğ856372è
	`abÜt
();

89 (
d©a
);

90 
	}
}

124 
cú_upÿÎ_»s


125 
	$šcomšg_cÚ‹Á
(

126 
cú_şosu»
 *
£lå
,

127 
cú_upÿÎ_kšd
 
kšd
,

128 
cú_upÿÎ_šfo
 *
šfo
)

130 
cú_ch¬buf
 *
c
 = 
NULL
;

131 
cú_ch¬buf
 *
comp
 = 
NULL
;

132 
cú_ch¬buf
 *
uri
 = 
NULL
;

133 cÚ¡ *
cúb
 = 
NULL
;

134 
size_t
 
cúb_size
 = 0;

135 
cú_šdexbuf
 *
comps
 = 
NULL
;

136 
m©ched_comps
 = 0;

137 
»s
;

138 
i
;

139 
upÿÎd©a
 *
d©a
 = 
	`g‘_my_d©a
(
£lå
);

141 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

142 
i
 = 0; i < 
d©a
->
n_exş
; i++)

143 
	`cú_ch¬buf_de¡roy
(&(
d©a
->
exş
[
i
]));

144 ià(
d©a
->
exş
 !ğ
NULL
)

145 
	`ä“
(
d©a
->
exş
);

146 
	`ä“
(
d©a
);

147 
	`ä“
(
£lå
);

150 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

152 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
 && kšd !ğ
CCN_UPCALL_CONTENT_UNVERIFIED
 && kšd !ğ
CCN_UPCALL_CONTENT_BAD
)

153 
	`abÜt
();

155 
cúb
 = 
šfo
->
cÚ‹Á_cúb
;

156 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

157 
comps
 = 
šfo
->
cÚ‹Á_comps
;

158 
m©ched_comps
 = 
šfo
->
pi
->
´efix_comps
;

159 
c
 = 
	`cú_ch¬buf_ü—‹
();

160 
uri
 = 
	`cú_ch¬buf_ü—‹
();

162 ià(
m©ched_comps
 + 1 > 
comps
->
n
) {

163 
	`cú_uri_­³nd
(
c
, 
cúb
, 
cúb_size
, 1);

164 
	`årštf
(
¡d”r
, "How didhi h­³n? %s\n", 
	`cú_ch¬buf_as_¡ršg
(
uri
));

165 
	`ex™
(1);

168 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_BAD
) {

169 
	`cú_uri_­³nd
(
uri
, 
cúb
, 
cúb_size
, 1);

170 
	`årštf
(
¡d”r
, "*** VERIFICATION FAILURE *** %s\n", 
	`cú_ch¬buf_as_¡ršg
(
uri
));

171 
uri
->
Ëngth
 = 0;

174 
d©a
->
couÁ”
[0]++;

177 
	`cú_Çme_š™
(
c
);

178 
	`cú_Çme_­³nd_compÚ’ts
(
c
, 
cúb
, 
comps
->
buf
[0], comps->buf[
m©ched_comps
]);

180 
comp
 = 
	`cú_ch¬buf_ü—‹
();

181 
	`cú_Çme_š™
(
comp
);

182 ià(
m©ched_comps
 + 1 =ğ
comps
->
n
) {

184 
	`cú_dige¡_CÚ‹ÁObjeù
(
cúb
, 
šfo
->
pco
);

185 
	`cú_Çme_­³nd
(
comp
, 
šfo
->
pco
->
dige¡
, info->pco->
dige¡_by‹s
);

188 
	`cú_Çme_­³nd_compÚ’ts
(
comp
, 
cúb
,

189 
comps
->
buf
[
m©ched_comps
],

190 
comps
->
buf
[
m©ched_comps
 + 1]);

192 
d©a
->
exş
 = 
	`»®loc
(d©a->exş, (d©a->
n_exş
 + 1) * (data->excl[0]));

193 
d©a
->
exş
[d©a->
n_exş
++] = 
comp
;

194 
comp
 = 
NULL
;

195 
	`qsÜt
(
d©a
->
exş
, d©a->
n_exş
, (d©a->exş[0]), &
Çmecom·»
);

196 
»s
 = 
	`ex´ess_my_š‹»¡
(
šfo
->
h
, 
£lå
, 
c
);

197 ià(
»s
 == -1) {

198 
cú_şosu»
 *
high
 = 
	`¥l™_my_exşudes
(
£lå
);

199 ià(
high
 =ğ
NULL
è
	`abÜt
();

200 
	`ex´ess_my_š‹»¡
(
šfo
->
h
, 
£lå
, 
c
);

201 
	`ex´ess_my_š‹»¡
(
šfo
->
h
, 
high
, 
c
);

204 ià(
m©ched_comps
 + 2 < 
comps
->
n
) {

205 
upÿÎd©a
 *
Ãwd©
 = 
NULL
;

206 
cú_şosu»
 *
ş
;

207 
Ãwd©
 = 
	`ÿÎoc
(1, (*newdat));

208 
Ãwd©
->
magic
 = 856372;

209 
Ãwd©
->
w¬n
 = 1492;

210 
Ãwd©
->
couÁ”
 = 
d©a
->counter;

211 
Ãwd©
->
æags
 = 0;

212 
Ãwd©
->
n_exş
 = 0;

213 
Ãwd©
->
exş
 = 
NULL
;

214 
ş
 = 
	`ÿÎoc
(1, (*cl));

215 
ş
->
p
 = &
šcomšg_cÚ‹Á
;

216 
ş
->
d©a
 = 
Ãwd©
;

217 
	`cú_Çme_š™
(
c
);

218 
	`cú_Çme_­³nd_compÚ’ts
(
c
, 
cúb
,

219 
comps
->
buf
[0],

220 
comps
->
buf
[
m©ched_comps
 + 1]);

221 
	`cú_ex´ess_š‹»¡
(
šfo
->
h
, 
c
, 
ş
, 
·ssive_‹m¶
);

224 
»s
 = 
	`cú_uri_­³nd
(
uri
, 
šfo
->
cÚ‹Á_cúb
, info->
pco
->
off£t
[
CCN_PCO_E
], 1);

225 ià(
»s
 < 0)

226 
	`årštf
(
¡d”r
, "*** E¼Ü: cú¦u½†š%d„es=%d\n", 
__LINE__
, 
»s
);

228 
	`´štf
("%s\n", 
	`cú_ch¬buf_as_¡ršg
(
uri
));

230 
	`cú_ch¬buf_de¡roy
(&
c
);

231 
	`cú_ch¬buf_de¡roy
(&
uri
);

233 
	}
}

240 
	$ªsw”_·ssive
(
cú_ch¬buf
 *
‹m¶
)

242 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, 
CCN_DTAG
);

243 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 1, 
CCN_UDATA
);

244 
	`cú_ch¬buf_­³nd
(
‹m¶
, "1", 1);

245 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

246 
	}
}

253 
	$ex´ess_my_š‹»¡
(
cú
 *
h
,

254 
cú_şosu»
 *
£lå
,

255 
cú_ch¬buf
 *
Çme
)

257 
ªs
;

258 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

259 
i
;

260 
upÿÎd©a
 *
d©a
 = 
	`g‘_my_d©a
(
£lå
);

262 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

263 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

264 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

265 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

266 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Exşude
, 
CCN_DTAG
);

267 ià((
d©a
->
æags
 & 
EXCLUDE_LOW
) != 0)

268 
	`­³nd_bf_®l
(
‹m¶
);

269 
i
 = 0; i < 
d©a
->
n_exş
; i++) {

270 
cú_ch¬buf
 *
comp
 = 
d©a
->
exş
[
i
];

271 ià(
comp
->
Ëngth
 < 4è
	`abÜt
();

272 
	`cú_ch¬buf_­³nd
(
‹m¶
, 
comp
->
buf
 + 1, comp->
Ëngth
 - 2);

274 ià((
d©a
->
æags
 & 
EXCLUDE_HIGH
) != 0)

275 
	`­³nd_bf_®l
(
‹m¶
);

276 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

277 
	`ªsw”_·ssive
(
‹m¶
);

278 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

279 ià(
‹m¶
->
Ëngth
 + 
Çme
->Ëngth > 
d©a
->
w¬n
 + 2) {

280 
	`årštf
(
¡d”r
, "*** IÁ”e¡…ack‘ i %d by‹s\n", ()
‹m¶
->
Ëngth
);

281 
d©a
->
w¬n
 = data->warn * 8 / 5;

283 ià(
‹m¶
->
Ëngth
 + 
Çme
->Ëngth > 1450 && 
d©a
->
n_exş
 > 3)

284 
ªs
 = -1;

286 
	`cú_ex´ess_š‹»¡
(
h
, 
Çme
, 
£lå
, 
‹m¶
);

287 
ªs
 = 0;

289 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

290 (
ªs
);

291 
	}
}

297 
cú_şosu»
 *

298 
	$¥l™_my_exşudes
(
cú_şosu»
 *
£lå
)

300 
i
;

301 
m
;

302 
upÿÎd©a
 *
Ãwd©
 = 
NULL
;

303 
cú_şosu»
 *
ş
;

304 
upÿÎd©a
 *
d©a
 = 
	`g‘_my_d©a
(
£lå
);

306 ià(
d©a
->
n_exş
 < 3)

307  
NULL
;

308 
m
 = 
d©a
->
n_exş
 / 2;

309 
Ãwd©
 = 
	`ÿÎoc
(1, (*newdat));

310 
Ãwd©
->
magic
 = 856372;

311 
Ãwd©
->
w¬n
 = 1492;

312 
Ãwd©
->
couÁ”
 = 
d©a
->counter;

313 
Ãwd©
->
n_exş
 = 
d©a
->n_exş - 
m
;

314 
Ãwd©
->
exş
 = 
	`ÿÎoc
Òewd©->
n_exş
, (newdat->excl[0]));

315 ià(
Ãwd©
->
exş
 =ğ
NULL
) {

316 
	`ä“
(
Ãwd©
);

317 (
NULL
);

319 
Ãwd©
->
exş
[0] = 
	`cú_ch¬buf_du¶iÿ‹
(
d©a
->exş[
m
]);

320 
Ãwd©
->
æags
 = 
d©a
->æag | 
EXCLUDE_LOW
;

321 
i
 = 1; i < 
Ãwd©
->
n_exş
; i++) {

322 
Ãwd©
->
exş
[
i
] = 
d©a
->exş[
m
 + i];

323 
d©a
->
exş
[
m
 + 
i
] = 
NULL
;

325 
d©a
->
n_exş
 = 
m
 + 1;

326 
d©a
->
æags
 |ğ
EXCLUDE_HIGH
;

327 
ş
 = 
	`ÿÎoc
(1, (*cl));

328 
ş
->
p
 = &
šcomšg_cÚ‹Á
;

329 
ş
->
d©a
 = 
Ãwd©
;

330 (
ş
);

331 
	}
}

338 
	$­³nd_bf_®l
(
cú_ch¬buf
 *
c
)

340 
bf_®l
[9] = { 3, 1, 'A', 0, 0, 0, 0, 0, 0xFF };

341 cÚ¡ 
cú_bloom_wœe
 *
b
 = 
	`cú_bloom_v®id©e_wœe
(
bf_®l
, (bf_all));

342 ià(
b
 =ğ
NULL
è
	`abÜt
();

343 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Bloom
, 
CCN_DTAG
);

344 
	`cú_ch¬buf_­³nd_‰
(
c
, (
bf_®l
), 
CCN_BLOB
);

345 
	`cú_ch¬buf_­³nd
(
c
, 
bf_®l
, (bf_all));

346 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

347 
	}
}

349 
cú_ch¬buf
 *

350 
	$cú_ch¬buf_du¶iÿ‹
(
cú_ch¬buf
 *
c
)

352 
cú_ch¬buf
 *
ªs
 = 
	`cú_ch¬buf_ü—‹
();

353 
	`cú_ch¬buf_­³nd
(
ªs
, 
c
->
buf
, c->
Ëngth
);

354 (
ªs
);

355 
	}
}

358 
	$u§ge
(cÚ¡ *
´og
)

360 
	`årštf
(
¡d”r
,

363 "‡nd…ršˆouˆÇme oàfound cÚ‹ÁØ¡dout\n", 
´og
);

364 
	`ex™
(1);

365 
	}
}

368 
	$maš
(
¬gc
, **
¬gv
)

370 cÚ¡ *
´ogÇme
 = 
¬gv
[0];

371 
cú
 *cú = 
NULL
;

372 
cú_ch¬buf
 *
c
 = 
NULL
;

373 
upÿÎd©a
 *
d©a
 = 
NULL
;

374 
i
;

375 
n
;

376 
»s
;

377 
couÁ”
 = 0;

378 
cú_şosu»
 *
ş
 = 
NULL
;

380 ià(
¬gv
[1] =ğ
NULL
 ||‡rgv[2] != NULL)

381 
	`u§ge
(
¬gv
[0]);

383 
·ssive_‹m¶
 = 
	`ü—‹_·ssive_‹m¶
();

384 
c
 = 
	`cú_ch¬buf_ü—‹
();

385 
»s
 = 
	`cú_Çme_äom_uri
(
c
, 
¬gv
[1]);

386 ià(
»s
 < 0) {

387 
	`årštf
(
¡d”r
, "%s: bad cú URI: %s\n", 
´ogÇme
, 
¬gv
[1]);

388 
	`ex™
(1);

391 
cú
 = 
	`cú_ü—‹
();

392 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

393 
	`³¼Ü
("Could‚ot connecto ccnd");

394 
	`ex™
(1);

397 
d©a
 = 
	`ÿÎoc
(1, (*data));

398 
d©a
->
magic
 = 856372;

399 
d©a
->
w¬n
 = 1492;

400 
d©a
->
couÁ”
 = &counter;

401 
ş
 = 
	`ÿÎoc
(1, (*cl));

402 
ş
->
p
 = &
šcomšg_cÚ‹Á
;

403 
ş
->
d©a
 = data;

404 
	`cú_ex´ess_š‹»¡
(
cú
, 
c
, 
ş
, 
·ssive_‹m¶
);

405 
ş
 = 
NULL
;

406 
d©a
 = 
NULL
;

407 
	`cú_ch¬buf_de¡roy
(&
c
);

408 
i
 = 0;; i++) {

409 
n
 = 
couÁ”
;

410 
	`cú_run
(
cú
, 1000);

411 
	`fæush
(
¡dout
);

412 ià(
couÁ”
 =ğ
n
)

415 
	`cú_de¡roy
(&
cú
);

416 
	`cú_ch¬buf_de¡roy
(&
·ssive_‹m¶
);

417 
	`ex™
(0);

418 
	}
}

	@cmd/ccntimefromdatetime.c

22 
	~<time.h
>

23 
	~<m©h.h
>

24 
	~<¡dio.h
>

25 
	~<¡dšt.h
>

26 
	~<¡dlib.h
>

27 
	~<¡ršg.h
>

30 
	$cvt_a_d©e
(*
s
)

32 *
Ëáov”
;

33 *
z
 = "?";

34 
tm
m = {0};

35 
time_t
 
£cÚds
;

36 
äaùiÚ
 = 0.0;

37 
fuÎtime
;

38 
back
;

39 
»s
 = 0;

40 
štmax_t
 
fixedsÿËd
;

42 
Ëáov”
 = 
	`¡½time
(
s
, "%FT%T", &
tm
);

43 
£cÚds
 = 
	`timegm
(&
tm
);

44 ià(
Ëáov”
 !ğ
NULL
)

45 
äaùiÚ
 = 
	`¡¹od
(
Ëáov”
, &
z
);

46 ià(0 !ğ
	`¡rcmp
(
z
, "Z"è|| 
£cÚds
 <= 0 ||

47 
äaùiÚ
 < 0.0 || fraction >= 1.0) {

48 
»s
 = 1;

49 
	`årštf
(
¡d”r
, "´obËm cÚv”tšg %s\n", 
s
);

52 
fuÎtime
 = ((()
£cÚds
è+ 
äaùiÚ
);

53 
fixedsÿËd
 = (
štmax_t
)
	`round
(
fuÎtime
 * ()(1U << 12));

54 
back
 = ()
fixedsÿËd
 / 4096.0;

55 
	`´štf
("%s\t%012jX\t%f\t%f\n", 
s
, 
fixedsÿËd
, 
fuÎtime
, 
back
);

57 (
»s
);

58 
	}
}

61 
	$maš
(
¬gc
, **
¬gv
)

63 
i
;

64 
»s
 = 0;

65 
i
 = 1; i < 
¬gc
; i++)

66 
»s
 |ğ
	`cvt_a_d©e
(
¬gv
[
i
]);

67 (
»s
 == 0 ? 0 : 1);

68 
	}
}

	@cmd/dataresponsetest.c

19 
	~<fú.h
>

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<uni¡d.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/ty³s.h
>

26 
	~<cú/cú.h
>

28 
	sİtiÚs
 {

29 
	mloggšg
;

30 
	mnoš‹»¡
;

31 
	m»cÚÃù
;

32 } 
	gİtiÚs
 = {0, 0, 0};

34 
	shªdËr¡©e
 {

35 
	mÃxt
;

36 
	mcouÁ
;

37 
	shªdËr¡©e™em
 {

38 *
	mf’ame
;

39 *
	mcÚ‹Ás
;

40 
size_t
 
	msize
;

41 
cú_·r£d_CÚ‹ÁObjeù
 
	mx
;

42 
cú_šdexbuf
 *
	mcompÚ’ts
;

43 } *
	m™ems
;

46 
cú_upÿÎ_»s
 
š‹»¡_hªdËr
(
cú_şosu»
 *
£lå
,

47 
cú_upÿÎ_kšd
,

48 
cú_upÿÎ_šfo
 *
šfo
);

51 
	$maš
 (
¬gc
, *
¬gv
[]) {

52 
cú
 *cú = 
NULL
;

53 
cú_şosu»
 *
aùiÚ
;

54 
cú_ch¬buf
 *
Çmebuf
 = 
NULL
;

55 
cú_ch¬buf
 *
š‹»¡Çmebuf
 = 
NULL
;

56 
cú_ch¬buf
 *
š‹»¡‹m¶©ebuf
 = 
NULL
;

57 
cú_buf_decod”
 
decod”
;

58 
cú_buf_decod”
 *
d
;

59 
hªdËr¡©e
 *
¡©e
;

60 *
f’ame
;

61 
¿wbuf
[1024 * 1024];

62 
ssize_t
 
¿wËn
;

63 
i
, 
n
, 
»s
;

64 
fd
 = -1;

66 
cú
 = 
	`cú_ü—‹
();

67 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

68 
	`³¼Ü
("ccn_connect");

69 
	`ex™
(1);

72 
¡©e
 = 
	`ÿÎoc
(1, (
hªdËr¡©e
));

73 
aùiÚ
 = 
	`ÿÎoc
(1, (
cú_şosu»
));

74 
aùiÚ
->
p
 = 
š‹»¡_hªdËr
;

76 
Çmebuf
 = 
	`cú_ch¬buf_ü—‹
();

77 ià(
Çmebuf
 =ğ
NULL
) {

78 
	`årštf
(
¡d”r
, "ccn_charbuf_create\n");

79 
	`ex™
(1);

81 
»s
 = 
	`cú_Çme_š™
(
Çmebuf
);

82 ià(
»s
 < 0) {

83 
	`årštf
(
¡d”r
, "ccn_name_init\n");

84 
	`ex™
(1);

87 
š‹»¡Çmebuf
 = 
	`cú_ch¬buf_ü—‹
();

88 
š‹»¡‹m¶©ebuf
 = 
	`cú_ch¬buf_ü—‹
();

89 ià(
š‹»¡Çmebuf
 =ğ
NULL
 || 
š‹»¡‹m¶©ebuf
 == NULL) {

90 
	`årštf
(
¡d”r
, "ccn_charbuf_create\n");

91 
	`ex™
(1);

93 
»s
 = 
	`cú_Çme_š™
(
š‹»¡Çmebuf
);

94 ià(
»s
 < 0) {

95 
	`årštf
(
¡d”r
, "ccn_name_init\n");

96 
	`ex™
(1);

99 
n
 = 0;

100 
i
 = 1; i < 
¬gc
; i++) {

101 ià(
fd
 !ğ-1è
	`şo£
(fd);

102 
f’ame
 = 
¬gv
[
i
];

103 ià(0 =ğ
	`¡rcmp
(
f’ame
, "-d")) {

104 
İtiÚs
.
loggšg
++;

107 ià(0 =ğ
	`¡rcmp
(
f’ame
, "-nointerest")) {

108 
İtiÚs
.
noš‹»¡
 = 1;

111 ià(0 =ğ
	`¡rcmp
(
f’ame
, "-reconnect")) {

112 
İtiÚs
.
»cÚÃù
 = 1;

116 ià(
İtiÚs
.
loggšg
 > 0è
	`årštf
(
¡d”r
, "Proûssšg % ", 
f’ame
);

117 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

118 ià(
fd
 == -1) {

119 
	`³¼Ü
("- open");

123 
¿wËn
 = 
	`»ad
(
fd
, 
¿wbuf
, (rawbuf));

124 ià(
¿wËn
 <= 0) {

125 
	`³¼Ü
("-„ead");

129 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, (*)
¿wbuf
, 
¿wËn
);

131 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CÚ‹ÁObjeù
)) {

132 
¡©e
->
™ems
 = 
	`»®loc
(¡©e->™ems, (
n
 + 1) * (*(state->items)));

133 ià(
¡©e
->
™ems
 =ğ
NULL
) {

134 
	`³¼Ü
(" -„ealloc failed");

135 
	`ex™
(1);

137 
	`mem£t
(&(
¡©e
->
™ems
[
n
]), 0, (*(state->items)));

138 
¡©e
->
™ems
[
n
].
compÚ’ts
 = 
	`cú_šdexbuf_ü—‹
();

139 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
((*)
¿wbuf
, 
¿wËn
, &(
¡©e
->
™ems
[
n
].
x
), s‹->™ems[n].
compÚ’ts
);

140 ià(
»s
 < 0) {

141 ià(
İtiÚs
.
loggšg
 > 0è
	`årštf
(
¡d”r
, "Proûssšg % ", 
f’ame
);

142 
	`årštf
(
¡d”r
, "- skpšg: CÚ‹ÁObjeùƒ¼Ü %d\n", 
»s
);

143 
	`cú_šdexbuf_de¡roy
(&
¡©e
->
™ems
[
n
].
compÚ’ts
);

146 ià(
İtiÚs
.
loggšg
 > 0è
	`årštf
(
¡d”r
, "- ok\n");

147 
¡©e
->
™ems
[
n
].
f’ame
 = filename;

148 
¡©e
->
™ems
[
n
].
cÚ‹Ás
 = 
	`m®loc
(
¿wËn
);

149 
¡©e
->
™ems
[
n
].
size
 = 
¿wËn
;

150 
	`memıy
(
¡©e
->
™ems
[
n
].
cÚ‹Ás
, 
¿wbuf
, 
¿wËn
);

151 
n
++;

152 } ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_IÁ”e¡
)) {

153 
cú_·r£d_š‹»¡
 
š‹»¡
 = {0};

154 ià(
İtiÚs
.
noš‹»¡
 == 0) {

155 
size_t
 
Çme_¡¬t
;

156 
size_t
 
Çme_size
;

157 
š‹»¡Çmebuf
->
Ëngth
 = 0;

158 
š‹»¡‹m¶©ebuf
->
Ëngth
 = 0;

159 
»s
 = 
	`cú_·r£_š‹»¡
((*)
¿wbuf
, 
¿wËn
, &
š‹»¡
, 
NULL
);

160 
Çme_¡¬t
 = 
š‹»¡
.
off£t
[
CCN_PI_B_Name
];

161 
Çme_size
 = 
š‹»¡
.
off£t
[
CCN_PI_E_Name
] - 
Çme_¡¬t
;

162 
	`cú_ch¬buf_­³nd
(
š‹»¡Çmebuf
, 
¿wbuf
 + 
Çme_¡¬t
, 
Çme_size
);

163 
	`cú_ch¬buf_­³nd
(
š‹»¡‹m¶©ebuf
, 
¿wbuf
, 
¿wËn
);

164 
»s
 = 
	`cú_ex´ess_š‹»¡
(
cú
, 
š‹»¡Çmebuf
, 
aùiÚ
, 
š‹»¡‹m¶©ebuf
);

167 ià(
İtiÚs
.
loggšg
 =ğ0è
	`årštf
(
¡d”r
, "Proûssšg % ", 
f’ame
);

168 
	`årštf
(
¡d”r
, "- skipping: unknownype\n");

171 
¡©e
->
couÁ
 = 
n
;

172 
aùiÚ
->
d©a
 = 
¡©e
;

174 ià(
	`cú_Çme_š™
(
Çmebuf
) == -1) {

175 
	`årštf
(
¡d”r
, "ccn_name_init\n");

176 
	`ex™
(1);

179 
»s
 = 
	`cú_£t_š‹»¡_f‹r
(
cú
, 
Çmebuf
, 
aùiÚ
);

181 
»s
 = 
	`cú_run
(
cú
, -1);

182 
	`cú_discÚÃù
(
cú
);

183 ià(!
İtiÚs
.
»cÚÃù
)

185 
	`¦“p
(2);

186 
	`cú_cÚÃù
(
cú
, 
NULL
);

188 
	`cú_de¡roy
(&
cú
);

189 
	`ex™
(0);

190 
	}
}

193 
	$m©ch_compÚ’ts
(*
msg1
, 
cú_šdexbuf
 *
comp1
,

194 *
msg2
, 
cú_šdexbuf
 *
comp2
) {

195 
m©ched
;

196 
lc1
, 
lc2
;

197 *
c1p
, *
c2p
;

199 
m©ched
 = 0; (m©ched < 
comp1
->
n
 - 1è&& (m©ched < 
comp2
->n - 1); matched++) {

200 
lc1
 = 
comp1
->
buf
[
m©ched
 + 1] - comp1->buf[matched];

201 
lc2
 = 
comp2
->
buf
[
m©ched
 + 1] - comp2->buf[matched];

202 ià(
lc1
 !ğ
lc2
è (
m©ched
);

204 
c1p
 = 
msg1
 + 
comp1
->
buf
[
m©ched
];

205 
c2p
 = 
msg2
 + 
comp2
->
buf
[
m©ched
];

206 ià(
	`memcmp
(
c1p
, 
c2p
, 
lc1
è!ğ0è (
m©ched
);

208  (
m©ched
);

209 
	}
}

211 
cú_upÿÎ_»s


212 
	$š‹»¡_hªdËr
(
cú_şosu»
 *
£lå
,

213 
cú_upÿÎ_kšd
 
upÿÎ_kšd
,

214 
cú_upÿÎ_šfo
 *
šfo
)

216 
i
, 
c
, 
mc
, 
m©ch
, 
»s
;

217 
hªdËr¡©e™em
 
™em
;

218 
hªdËr¡©e
 *
¡©e
;

219 
size_t
 
cúb_size
 = 0;

221 
¡©e
 = 
£lå
->
d©a
;

222 
upÿÎ_kšd
) {

223 
CCN_UPCALL_FINAL
:

224 
	`årštf
(
¡d”r
, "Upcall final\n");

227 
CCN_UPCALL_INTEREST_TIMED_OUT
:

228 
	`årštf
(
¡d”r
, "refresh\n");

229  (
CCN_UPCALL_RESULT_REEXPRESS
);

231 
CCN_UPCALL_CONTENT
:

232 
CCN_UPCALL_CONTENT_UNVERIFIED
:

233 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

234 
c
 = 
¡©e
->
couÁ
;

235 
i
 = 0; i < 
c
; i++) {

236 ià(
šfo
->
cÚ‹Á_comps
->
n
 =ğ
¡©e
->
™ems
[
i
].
compÚ’ts
->n) {

237 
mc
 = 
	`m©ch_compÚ’ts
((*)
šfo
->
cÚ‹Á_cúb
, info->
cÚ‹Á_comps
,

238 
¡©e
->
™ems
[
i
].
cÚ‹Ás
, s‹->™ems[i].
compÚ’ts
);

239 ià(
mc
 =ğ(
šfo
->
cÚ‹Á_comps
->
n
 - 1)) {

240 
	`årštf
(
¡d”r
, "Duplicate content\n");

245 
	`årštf
(
¡d”r
, "StÜšg cÚ‹Á i‹m %d ", 
c
);

246 
¡©e
->
™ems
 = 
	`»®loc
(¡©e->™ems, (
c
 + 1) * (*(state->items)));

247 ià(
¡©e
->
™ems
 =ğ
NULL
) {

248 
	`³¼Ü
("realloc failed");

249 
	`ex™
(1);

251 
	`mem£t
(&(
¡©e
->
™ems
[
c
]), 0, (*(state->items)));

252 
¡©e
->
™ems
[
c
].
compÚ’ts
 = 
	`cú_šdexbuf_ü—‹
();

254 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
šfo
->
cÚ‹Á_cúb
, 
cúb_size
, &(
¡©e
->
™ems
[
c
].
x
), s‹->™ems[c].
compÚ’ts
);

255 ià(
»s
 < 0) {

256 
	`årštf
(
¡d”r
, "- skipping: Not‡ ContentObject\n");

257 
	`cú_šdexbuf_de¡roy
(&
¡©e
->
™ems
[
c
].
compÚ’ts
);

260 
	`årštf
(
¡d”r
, "- ok\n");

261 
¡©e
->
™ems
[
c
].
f’ame
 = "ephemeral";

262 
¡©e
->
™ems
[
c
].
cÚ‹Ás
 = 
	`m®loc
(
cúb_size
);

263 
¡©e
->
™ems
[
c
].
size
 = 
cúb_size
;

264 
	`memıy
(
¡©e
->
™ems
[
c
].
cÚ‹Ás
, 
šfo
->
cÚ‹Á_cúb
, 
cúb_size
);

265 
¡©e
->
couÁ
 = 
c
 + 1;

268 
CCN_UPCALL_CONTENT_BAD
:

269 
	`årštf
(
¡d”r
, "Content signature verification failed! Discarding.\n");

272 
CCN_UPCALL_CONSUMED_INTEREST
:

273 
	`årštf
(
¡d”r
, "Upcall consumed interest\n");

276 
CCN_UPCALL_INTEREST
:

277 
c
 = 
¡©e
->
couÁ
;

278 
i
 = 0; i < 
c
; i++) {

279 
m©ch
 = 
	`cú_cÚ‹Á_m©ches_š‹»¡
(
¡©e
->
™ems
[
i
].
cÚ‹Ás
,

280 
¡©e
->
™ems
[
i
].
size
,

282 
NULL
,

283 
šfo
->
š‹»¡_cúb
,

284 
šfo
->
pi
->
off£t
[
CCN_PI_E
],

285 
šfo
->
pi
);

286 ià(
m©ch
) {

287 
	`cú_put
(
šfo
->
h
, 
¡©e
->
™ems
[
i
].
cÚ‹Ás
, s‹->™ems[i].
size
);

288 
	`årštf
(
¡d”r
, "S’dšg %s\n", 
¡©e
->
™ems
[
i
].
f’ame
);

289 ià(
i
 < 
c
 - 1) {

290 
™em
 = 
¡©e
->
™ems
[
i
];

291 
	`memmove
(&(
¡©e
->
™ems
[
i
]), &(¡©e->™ems[i+1]), (
™em
è* ((
c
 - 1) - i));

292 
¡©e
->
™ems
[
c
 - 1] = 
™em
;

300 
	}
}

	@include/ccn/bloom.h

22 #iâdeà
CCN_BLOOM_DEFINED


23 
	#CCN_BLOOM_DEFINED


	)

25 
	~<¡ddef.h
>

27 
	gcú_bloom
;

33 
cú_bloom
 *
cú_bloom_ü—‹
(
e¡im©ed_memb”s
,

34 cÚ¡ 
£ed
[4]);

40 
cú_bloom
 *
cú_bloom_äom_wœe
(cÚ¡ *
d©a
, 
size_t
 
size
);

45 
cú_bloom_de¡roy
(
cú_bloom
 **);

51 
cú_bloom_š£¹
(
cú_bloom
 *
b
, cÚ¡ *
key
, 
size_t
 
size
);

56 
cú_bloom_m©ch
(
cú_bloom
 *
b
, cÚ¡ *
key
, 
size_t
 
size
);

62 
cú_bloom_n
(
cú_bloom
 *
b
);

67 
cú_bloom_wœesize
(
cú_bloom
 *
b
);

72 
cú_bloom_¡Üe_wœe
(
cú_bloom
 *
b
,

73 *
de¡
, 
size_t
 
de¡size
);

78 
	scú_bloom_wœe
 {

79 
	mlg_b™s
;

80 
	mn_hash
;

81 
	mm‘hod
;

82 
	m»£rved
;

83 
	m£ed
[4];

84 
	mbloom
[1024];

92 cÚ¡ 
cú_bloom_wœe
 *

93 
cú_bloom_v®id©e_wœe
(cÚ¡ *
buf
, 
size_t
 
size
);

99 
cú_bloom_m©ch_wœe
(cÚ¡ 
cú_bloom_wœe
 *
f
,

100 cÚ¡ *
key
, 
size_t
 
size
);

	@include/ccn/ccn.h

22 #iâdeà
CCN_CCN_DEFINED


23 
	#CCN_CCN_DEFINED


	)

25 
	~<¡dšt.h
>

26 
	~<cú/codšg.h
>

27 
	~<cú/ch¬buf.h
>

28 
	~<cú/šdexbuf.h
>

40 
	#CCN_API_VERSION
 3000

	)

47 
	#CCN_INTEREST_LIFETIME_SEC
 4

	)

48 
	#CCN_INTEREST_LIFETIME_MICROSEC
 (
CCN_INTEREST_LIFETIME_SEC
 * 1000000)

	)

51 
	gcú
;

52 
	gcú_pkey
;

55 
	gcú_şosu»
;

56 
	gcú_upÿÎ_šfo
;

57 
	gcú_·r£d_š‹»¡
;

58 
	gcú_·r£d_CÚ‹ÁObjeù
;

69 
	ecú_upÿÎ_kšd
 {

70 
	mCCN_UPCALL_FINAL
,

71 
	mCCN_UPCALL_INTEREST
,

72 
	mCCN_UPCALL_CONSUMED_INTEREST
,

73 
	mCCN_UPCALL_CONTENT
,

74 
	mCCN_UPCALL_INTEREST_TIMED_OUT
,

75 
	mCCN_UPCALL_CONTENT_UNVERIFIED
,

76 
	mCCN_UPCALL_CONTENT_BAD


82 
	ecú_upÿÎ_»s
 {

83 
	mCCN_UPCALL_RESULT_ERR
 = -1,

84 
	mCCN_UPCALL_RESULT_OK
 = 0,

85 
	mCCN_UPCALL_RESULT_REEXPRESS
 = 1,

86 
	mCCN_UPCALL_RESULT_INTEREST_CONSUMED
 = 2,

87 
	mCCN_UPCALL_RESULT_VERIFY
 = 3

94 
	$cú_upÿÎ_»s
 (*
	tcú_hªdËr
)(

95 
	tcú_şosu»
 *
	t£lå
,

96 
	tcú_upÿÎ_kšd
 
	tkšd
,

97 
	tcú_upÿÎ_šfo
 *
	tšfo


109 
	scú_şosu»
 {

110 
cú_hªdËr
 
p
;

111 *
d©a
;

112 
šŒ_t
 
štd©a
;

113 
»fcouÁ
;

124 
	scú_upÿÎ_šfo
 {

125 
cú
 *
h
;

127 cÚ¡ *
š‹»¡_cúb
;

128 
cú_·r£d_š‹»¡
 *
pi
;

129 
cú_šdexbuf
 *
š‹»¡_comps
;

130 
m©ched_comps
;

132 cÚ¡ *
cÚ‹Á_cúb
;

133 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
;

134 
cú_šdexbuf
 *
cÚ‹Á_comps
;

143 
cú
 *
	`cú_ü—‹
();

151 
	`cú_cÚÃù
(
cú
 *
h
, cÚ¡ *
Çme
);

161 
	`cú_g‘_cÚÃùiÚ_fd
(
cú
 *
h
);

168 
	`cú_discÚÃù
(
cú
 *
h
);

174 
	`cú_de¡roy
(
cú
 **
hp
);

186 
	`cú_Çme_š™
(
cú_ch¬buf
 *
c
);

193 
	`cú_Çme_­³nd
(
cú_ch¬buf
 *
c
, cÚ¡ *
compÚ’t
, 
size_t
 
n
);

202 
	`cú_Çme_­³nd_¡r
(
cú_ch¬buf
 *
c
, cÚ¡ *
s
);

210 
	`cú_Çme_­³nd_compÚ’ts
(
cú_ch¬buf
 *
c
,

211 cÚ¡ *
cúb
,

212 
size_t
 
¡¬t
, size_ˆ
¡İ
);

214 
	ecú_m¬k”
 {

215 
CCN_MARKER_NONE
 = -1,

216 
CCN_MARKER_SEQNUM
 = 0x00,

217 
CCN_MARKER_CONTROL
 = 0xC1,

218 
CCN_MARKER_OSEQNUM
 = 0xF8,

219 
CCN_MARKER_BLKID
 = 0xFB,

220 
CCN_MARKER_VERSION
 = 0xFD

229 
	`cú_Çme_­³nd_num”ic
(
cú_ch¬buf
 *
c
,

230 
cú_m¬k”
 
g
, 
uštmax_t
 
v®ue
);

237 
	`cú_Çme_­³nd_nÚû
(
cú_ch¬buf
 *
c
);

245 
	`cú_Çme_¥l™
(cÚ¡ 
cú_ch¬buf
 *
c
,

246 
cú_šdexbuf
* 
compÚ’ts
);

256 
	`cú_Çme_chİ
(
cú_ch¬buf
 *
c
,

257 
cú_šdexbuf
* 
compÚ’ts
, 
n
);

265 
	ecú_cÚ‹Á_ty³
 {

266 
CCN_CONTENT_DATA
 = 0x0C04C0,

267 
CCN_CONTENT_ENCR
 = 0x10D091,

268 
CCN_CONTENT_GONE
 = 0x18E344,

269 
CCN_CONTENT_KEY
 = 0x28463F,

270 
CCN_CONTENT_LINK
 = 0x2C834A,

271 
CCN_CONTENT_NACK
 = 0x34008A

292 
	`cú_ex´ess_š‹»¡
(
cú
 *
h
,

293 
cú_ch¬buf
 *
Çmebuf
,

294 
cú_şosu»
 *
aùiÚ
,

295 
cú_ch¬buf
 *
š‹»¡_‹m¶©e
);

308 
	`cú_£t_š‹»¡_f‹r
(
cú
 *
h
, 
cú_ch¬buf
 *
Çmebuf
,

309 
cú_şosu»
 *
aùiÚ
);

314 
	`cú_£t_š‹»¡_f‹r_w™h_æags
(
cú
 *
h
,

315 
cú_ch¬buf
 *
Çmebuf
,

316 
cú_şosu»
 *
aùiÚ
,

317 
fÜw_æags
);

327 
	`cú_put
(
cú
 *
h
, cÚ¡ *
p
, 
size_t
 
Ëngth
);

334 
	`cú_ouut_is_³ndšg
(
cú
 *
h
);

342 
	`cú_run
(
cú
 *
h
, 
timeout
);

349 
	`cú_£t_run_timeout
(
cú
 *
h
, 
timeout
);

364 
	`cú_g‘
(
cú
 *
h
,

365 
cú_ch¬buf
 *
Çme
,

366 
cú_ch¬buf
 *
š‹»¡_‹m¶©e
,

367 
timeout_ms
,

368 
cú_ch¬buf
 *
»suÉbuf
,

369 
cú_·r£d_CÚ‹ÁObjeù
 *
pcobuf
,

370 
cú_šdexbuf
 *
compsbuf
,

371 
æags
);

373 
	#CCN_GET_NOKEYWAIT
 1

	)

376 
	`cú_v”ify_cÚ‹Á
(
cú
 *
h
,

377 cÚ¡ *
msg
,

378 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
);

385 
	scú_buf_decod”
 {

386 
cú_sk–‘Ú_decod”
 
decod”
;

387 cÚ¡ *
buf
;

388 
size_t
 
size
;

391 
cú_buf_decod”
 *
	`cú_buf_decod”_¡¬t
(cú_buf_decod” *
d
,

392 cÚ¡ *
buf
, 
size_t
 
size
);

394 
	`cú_buf_advªû
(
cú_buf_decod”
 *
d
);

395 
	`cú_buf_advªû_·¡_–em’t
(
cú_buf_decod”
 *
d
);

398 
	`cú_buf_m©ch_dg
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
);

400 
	`cú_buf_m©ch_some_dg
(
cú_buf_decod”
 *
d
);

402 
	`cú_buf_m©ch_some_blob
(
cú_buf_decod”
 *
d
);

403 
	`cú_buf_m©ch_blob
(
cú_buf_decod”
 *
d
,

404 cÚ¡ **
buå
, 
size_t
 *
siz•
);

406 
	`cú_buf_m©ch_ud©a
(
cú_buf_decod”
 *
d
, cÚ¡ *
s
);

408 
	`cú_buf_m©ch_©Œ
(
cú_buf_decod”
 *
d
, cÚ¡ *
s
);

411 
	`cú_·r£_»quœed_gged_BLOB
(
cú_buf_decod”
 *
d
,

412 
cú_dg
 
dg
,

413 
mšËn
, 
maxËn
);

414 
	`cú_·r£_İtiÚ®_gged_BLOB
(
cú_buf_decod”
 *
d
,

415 
cú_dg
 
dg
,

416 
mšËn
, 
maxËn
);

417 
	`cú_·r£_nÚNeg©iveIÁeg”
(
cú_buf_decod”
 *
d
);

418 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
cú_buf_decod”
 *
d
,

419 
cú_dg
 
dg
);

420 
	`cú_·r£_uštmax
(
cú_buf_decod”
 *
d
, 
uštmax_t
 *
»suÉ
);

421 
	`cú_·r£_gged_¡ršg
(
cú_buf_decod”
 *
d
,

422 
cú_dg
 
dg
, 
cú_ch¬buf
 *
¡Üe
);

424 
uštmax_t
 
	`cú_·r£_»quœed_gged_bš¬y_numb”
(
cú_buf_decod”
 *
d
,

425 
cú_dg
 
dg
,

426 
mšËn
, 
maxËn
);

427 
uštmax_t
 
	`cú_·r£_İtiÚ®_gged_bš¬y_numb”
(
cú_buf_decod”
 *
d
,

428 
cú_dg
 
dg
,

429 
mšËn
, 
maxËn
,

430 
uštmax_t
 
deçuÉ_v®ue
);

434 
	`cú_buf_check_şo£
(
cú_buf_decod”
 *
d
);

440 
	`cú_»f_gged_BLOB
(
cú_dg
 
‰
,

441 cÚ¡ *
buf
,

442 
size_t
 
¡¬t
, size_ˆ
¡İ
,

443 cÚ¡ **
´esuÉ
, 
size_t
 *
psize
);

445 
	`cú_ãtch_gged_nÚNeg©iveIÁeg”
(
cú_dg
 
‰
,

446 cÚ¡ *
buf
, 
size_t
 
¡¬t
, size_ˆ
¡İ
);

466 
	ecú_·r£d_š‹»¡_off£tid
 {

467 
CCN_PI_B_Name
,

468 
CCN_PI_B_CompÚ’t0
,

469 
CCN_PI_B_La¡P»fixCompÚ’t
,

470 
CCN_PI_E_La¡P»fixCompÚ’t
,

471 
CCN_PI_E_CompÚ’tLa¡
 = 
CCN_PI_E_La¡P»fixCompÚ’t
,

472 
CCN_PI_E_Name
,

473 
CCN_PI_B_MšSuffixCompÚ’ts
,

474 
CCN_PI_E_MšSuffixCompÚ’ts
,

475 
CCN_PI_B_MaxSuffixCompÚ’ts
,

476 
CCN_PI_E_MaxSuffixCompÚ’ts
,

477 
CCN_PI_B_Publish”ID
,

478 
CCN_PI_B_Publish”IDKeyDige¡
,

479 
CCN_PI_E_Publish”IDKeyDige¡
,

480 
CCN_PI_E_Publish”ID
,

481 
CCN_PI_B_Exşude
,

482 
CCN_PI_E_Exşude
,

483 
CCN_PI_B_ChdS–eùÜ
,

484 
CCN_PI_E_ChdS–eùÜ
,

485 
CCN_PI_B_Answ”OrigšKšd
,

486 
CCN_PI_E_Answ”OrigšKšd
,

487 
CCN_PI_B_Scİe
,

488 
CCN_PI_E_Scİe
,

489 
CCN_PI_B_IÁ”e¡Liãtime
,

490 
CCN_PI_E_IÁ”e¡Liãtime
,

491 
CCN_PI_B_NÚû
,

492 
CCN_PI_E_NÚû
,

493 
CCN_PI_B_OTHER
,

494 
CCN_PI_E_OTHER
,

495 
CCN_PI_E


498 
	scú_·r£d_š‹»¡
 {

499 
magic
;

500 
´efix_comps
;

501 
mš_suffix_comps
;

502 
max_suffix_comps
;

503 
Üd”´ef
;

504 
ªsw”äom
;

505 
scİe
;

506 
off£t
[
CCN_PI_E
+1];

512 
	#CCN_AOK_CS
 0x1

	)

513 
	#CCN_AOK_NEW
 0x2

	)

514 
	#CCN_AOK_DEFAULT
 (
CCN_AOK_CS
 | 
CCN_AOK_NEW
)

	)

515 
	#CCN_AOK_STALE
 0x4

	)

516 
	#CCN_AOK_EXPIRE
 0x10

	)

527 
	`cú_·r£_š‹»¡
(cÚ¡ *
msg
, 
size_t
 
size
,

528 
cú_·r£d_š‹»¡
 *
š‹»¡
,

529 
cú_šdexbuf
 *
compÚ’ts
);

535 
štmax_t
 
	`cú_š‹»¡_liãtime
(cÚ¡ *
msg
,

536 cÚ¡ 
cú_·r£d_š‹»¡
 *
pi
);

541 
	`cú_š‹»¡_liãtime_£cÚds
(cÚ¡ *
msg
,

542 cÚ¡ 
cú_·r£d_š‹»¡
 *
pi
);

546 
	ecú_·r£d_cÚ‹Á_objeù_off£tid
 {

547 
CCN_PCO_B_SigÇtu»
,

548 
CCN_PCO_B_Dige¡AlgÜ™hm
,

549 
CCN_PCO_E_Dige¡AlgÜ™hm
,

550 
CCN_PCO_B_W™Ãss
,

551 
CCN_PCO_E_W™Ãss
,

552 
CCN_PCO_B_SigÇtu»B™s
,

553 
CCN_PCO_E_SigÇtu»B™s
,

554 
CCN_PCO_E_SigÇtu»
,

555 
CCN_PCO_B_Name
,

556 
CCN_PCO_B_CompÚ’t0
,

557 
CCN_PCO_E_CompÚ’tN
,

558 
CCN_PCO_E_CompÚ’tLa¡
 = 
CCN_PCO_E_CompÚ’tN
,

559 
CCN_PCO_E_Name
,

560 
CCN_PCO_B_SigÃdInfo
,

561 
CCN_PCO_B_Publish”PublicKeyDige¡
,

562 
CCN_PCO_E_Publish”PublicKeyDige¡
,

563 
CCN_PCO_B_Time¡amp
,

564 
CCN_PCO_E_Time¡amp
,

565 
CCN_PCO_B_Ty³
,

566 
CCN_PCO_E_Ty³
,

567 
CCN_PCO_B_F»shÃssSecÚds
,

568 
CCN_PCO_E_F»shÃssSecÚds
,

569 
CCN_PCO_B_Fš®BlockID
,

570 
CCN_PCO_E_Fš®BlockID
,

571 
CCN_PCO_B_KeyLoÿtÜ
,

573 
CCN_PCO_B_Key_C”tifiÿ‹_KeyName
,

574 
CCN_PCO_B_KeyName_Name
,

575 
CCN_PCO_E_KeyName_Name
,

576 
CCN_PCO_B_KeyName_Pub
,

577 
CCN_PCO_E_KeyName_Pub
,

578 
CCN_PCO_E_Key_C”tifiÿ‹_KeyName
,

579 
CCN_PCO_E_KeyLoÿtÜ
,

580 
CCN_PCO_E_SigÃdInfo
,

581 
CCN_PCO_B_CÚ‹Á
,

582 
CCN_PCO_E_CÚ‹Á
,

583 
CCN_PCO_E


586 
	scú_·r£d_CÚ‹ÁObjeù
 {

587 
magic
;

588 
cú_cÚ‹Á_ty³
 
ty³
;

589 
Çme_ncomps
;

590 
off£t
[
CCN_PCO_E
+1];

591 
dige¡
[32];

592 
dige¡_by‹s
;

605 
	`cú_·r£_CÚ‹ÁObjeù
(cÚ¡ *
msg
, 
size_t
 
size
,

606 
cú_·r£d_CÚ‹ÁObjeù
 *
x
,

607 
cú_šdexbuf
 *
compÚ’ts
);

609 
	`cú_dige¡_CÚ‹ÁObjeù
(cÚ¡ *
msg
,

610 
cú_·r£d_CÚ‹ÁObjeù
 *
pc
);

617 
	`cú_·r£_Name
(
cú_buf_decod”
 *
d
, 
cú_šdexbuf
 *
compÚ’ts
);

628 
	`cú_com·»_Çmes
(cÚ¡ *
a
, 
size_t
 
asize
,

629 cÚ¡ *
b
, 
size_t
 
bsize
);

647 
	`cú_Çme_comp_¡rcmp
(cÚ¡ *
d©a
,

648 cÚ¡ 
cú_šdexbuf
 *
šdexbuf
,

649 
i
,

650 cÚ¡ *
v®
);

656 
	`cú_Çme_comp_g‘
(cÚ¡ *
d©a
,

657 cÚ¡ 
cú_šdexbuf
 *
šdexbuf
,

658 
i
,

659 cÚ¡ **
comp
, 
size_t
 *
size
);

661 
	`cú_Çme_Ãxt_siblšg
(
cú_ch¬buf
 *
c
);

667 
	`cú_cÚ‹Á_g‘_v®ue
(cÚ¡ *
d©a
, 
size_t
 
d©a_size
,

668 cÚ¡ 
cú_·r£d_CÚ‹ÁObjeù
 *
cÚ‹Á
,

669 cÚ¡ **
v®ue
, 
size_t
 *
size
);

701 
	scú_signšg_·¿ms
 {

702 
­i_v”siÚ
;

703 
¥_æags
;

704 
cú_ch¬buf
 *
‹m¶©e_cúb
;

705 
pubid
[32];

706 
cú_cÚ‹Á_ty³
 
ty³
;

707 
äeshÃss
;

711 
	#CCN_SIGNING_PARAMS_INIT
 \

712 { 
CCN_API_VERSION
, 0, 
NULL
, {0}, 
CCN_CONTENT_DATA
, -1 
	}

	)
}

714 
	#CCN_SP_TEMPL_TIMESTAMP
 0x0001

	)

715 
	#CCN_SP_TEMPL_FINAL_BLOCK_ID
 0x0002

	)

716 
	#CCN_SP_TEMPL_FRESHNESS
 0x0004

	)

717 
	#CCN_SP_TEMPL_KEY_LOCATOR
 0x0008

	)

718 
	#CCN_SP_FINAL_BLOCK
 0x0010

	)

719 
	#CCN_SP_OMIT_KEY_LOCATOR
 0x0020

	)

721 
cú_sign_cÚ‹Á
(
cú
 *
h
,

722 
cú_ch¬buf
 *
»suÉbuf
,

723 cÚ¡ 
cú_ch¬buf
 *
Çme_´efix
,

724 cÚ¡ 
cú_signšg_·¿ms
 *
·¿ms
,

725 cÚ¡ *
d©a
, 
size_t
 
size
);

727 
cú_lßd_´iv©e_key
(
cú
 *
h
,

728 cÚ¡ *
key¡Üe_·th
,

729 cÚ¡ *
key¡Üe_·s¥h¿£
,

730 
cú_ch¬buf
 *
pubid_out
);

732 
cú_lßd_deçuÉ_key
(
cú
 *
h
,

733 cÚ¡ *
key¡Üe_·th
,

734 cÚ¡ *
key¡Üe_·s¥h¿£
);

736 
cú_g‘_public_key
(
cú
 *
h
,

737 cÚ¡ 
cú_signšg_·¿ms
 *
·¿ms
,

738 
cú_ch¬buf
 *
dige¡_»suÉ
,

739 
cú_ch¬buf
 *
»suÉ
);

741 
cú_chk_signšg_·¿ms
(
cú
 *
h
,

742 cÚ¡ 
cú_signšg_·¿ms
 *
·¿ms
,

743 
cú_signšg_·¿ms
 *
»suÉ
,

744 
cú_ch¬buf
 **
±ime¡amp
,

745 
cú_ch¬buf
 **
pfš®blockid
,

746 
cú_ch¬buf
 **
pkeyloÿtÜ
);

748 
cú_sigÃd_šfo_ü—‹
(

749 
cú_ch¬buf
 *
c
,

750 cÚ¡ *
publish”_key_id
,

751 
size_t
 
publish”_key_id_size
,

752 cÚ¡ 
cú_ch¬buf
 *
time¡amp
,

753 
cú_cÚ‹Á_ty³
 
ty³
,

754 
äeshÃss
,

755 cÚ¡ 
cú_ch¬buf
 *
fš®blockid
,

756 cÚ¡ 
cú_ch¬buf
 *
key_loÿtÜ
);

758 
cú_’code_CÚ‹ÁObjeù
(
cú_ch¬buf
 *
buf
,

759 cÚ¡ 
cú_ch¬buf
 *
Name
,

760 cÚ¡ 
cú_ch¬buf
 *
SigÃdInfo
,

761 cÚ¡ *
d©a
,

762 
size_t
 
size
,

763 cÚ¡ *
dige¡_®gÜ™hm
,

764 cÚ¡ 
cú_pkey
 *
´iv©e_key
);

780 
cú_cÚ‹Á_m©ches_š‹»¡
(cÚ¡ *
cÚ‹Á_objeù
,

781 
size_t
 
cÚ‹Á_objeù_size
,

782 
im¶ic™_cÚ‹Á_dige¡
,

783 
cú_·r£d_CÚ‹ÁObjeù
 *
pc
,

784 cÚ¡ *
š‹»¡_msg
,

785 
size_t
 
š‹»¡_msg_size
,

786 cÚ¡ 
cú_·r£d_š‹»¡
 *
pi
);

797 
cú_³¼Ü
(
cú
 *
h
, cÚ¡ *
s
);

798 
cú_£‹¼Ü
(
cú
 *
h
, 
”rÜ_code
);

799 
cú_g‘”rÜ
(
cú
 *
h
);

812 
cú_ch¬buf_­³nd_‰
(
cú_ch¬buf
 *
c
, 
size_t
 
v®
, 
cú_‰
 
‰
);

821 
cú_ch¬buf_­³nd_şo£r
(
cú_ch¬buf
 *
c
);

830 
cúb_­³nd_numb”
(
cú_ch¬buf
 *
c
, 
Âi
);

836 
cúb_­³nd_time¡amp_blob
(
cú_ch¬buf
 *
c
,

837 
cú_m¬k”
 
m¬k”
,

838 
štmax_t
 
£cs
, 
n£cs
);

843 
cúb_­³nd_now_blob
(
cú_ch¬buf
 *
c
, 
cú_m¬k”
 
m¬k”
);

848 
cúb_–em’t_begš
(
cú_ch¬buf
 *
c
, 
cú_dg
 
dg
);

854 
cúb_–em’t_’d
(
cú_ch¬buf
 *
c
);

859 
cúb_­³nd_gged_blob
(
cú_ch¬buf
 *
c
, 
cú_dg
 
dg
,

860 cÚ¡ *
d©a
, 
size_t
 
size
);

865 
cúb_gged_putf
(
cú_ch¬buf
 *
c
, 
cú_dg
 
dg
,

866 cÚ¡ *
fmt
, ...);

873 
	#CCN_V_REPLACE
 1

	)

874 
	#CCN_V_LOW
 2

	)

875 
	#CCN_V_HIGH
 4

	)

876 
	#CCN_V_EST
 8

	)

877 
	#CCN_V_LOWEST
 (2|8)

	)

878 
	#CCN_V_HIGHEST
 (4|8)

	)

879 
	#CCN_V_NEXT
 (4|1)

	)

880 
	#CCN_V_PREV
 (2|1)

	)

881 
	#CCN_V_NOW
 16

	)

882 
	#CCN_V_NESTOK
 32

	)

884 
cú_»sŞve_v”siÚ
(
cú
 *
h
,

885 
cú_ch¬buf
 *
Çme
,

886 
v”siÚšg_æags
,

887 
timeout_ms
);

889 
cú_ü—‹_v”siÚ
(
cú
 *
h
,

890 
cú_ch¬buf
 *
Çme
,

891 
v”siÚšg_æags
,

892 
štmax_t
 
£cs
, 
n£cs
);

	@include/ccn/ccn_private.h

22 #iâdeà
CCN_PRIVATE_DEFINED


23 
	#CCN_PRIVATE_DEFINED


	)

25 
	~<sys/ty³s.h
>

26 
	~<¡dšt.h
>

28 
	gcú
;

29 
	gcú_ch¬buf
;

30 
	gsockaddr_un
;

35 
cú_di¥©ch_mes§ge
(
cú
 *
h
, *
msg
, 
size_t
 
size
);

41 
cú_´oûss_scheduËd_İ”©iÚs
(
cú
 *
h
);

47 
cú_ch¬buf
 *
cú_g¿b_bufã»d_ouut
(
cú
 *
h
);

49 
cú_£tup_sockaddr_un
(cÚ¡ *, 
sockaddr_un
 *);

	@include/ccn/ccnd.h

22 #iâdeà
CCN_CCND_DEFINED


23 
	#CCN_CCND_DEFINED


	)

25 
	#CCN_DEFAULT_LOCAL_SOCKNAME
 "/tmp/.cúd.sock"

	)

26 
	#CCN_LOCAL_PORT_ENVNAME
 "CCN_LOCAL_PORT"

	)

32 
	#CCN_DEFAULT_UNICAST_PORT_NUMBER
 9695U

	)

33 
	#CCN_DEFAULT_UNICAST_PORT
 "9695"

	)

39 
	#CCN_EMPTY_PDU
 "CCN\202\000"

	)

40 
	#CCN_EMPTY_PDU_LENGTH
 5

	)

	@include/ccn/charbuf.h

22 #iâdeà
CCN_CHARBUF_DEFINED


23 
	#CCN_CHARBUF_DEFINED


	)

25 
	~<¡ddef.h
>

26 
	~<time.h
>

28 
	scú_ch¬buf
 {

29 
size_t
 
	mËngth
;

30 
size_t
 
	mlim™
;

31 *
	mbuf
;

38 
cú_ch¬buf
 *
cú_ch¬buf_ü—‹
();

39 
cú_ch¬buf_de¡roy
(
cú_ch¬buf
 **
cbp
);

46 *
cú_ch¬buf_»£rve
(
cú_ch¬buf
 *
c
, 
size_t
 
n
);

52 
cú_ch¬buf_»£t
(
cú_ch¬buf
 *
c
);

57 
cú_ch¬buf_­³nd
(
cú_ch¬buf
 *
c
, cÚ¡ *
p
, 
size_t
 
n
);

63 
cú_ch¬buf_­³nd_v®ue
(
cú_ch¬buf
 *
c
, 
v®
, 
n
);

69 
cú_ch¬buf_­³nd_ch¬buf
(
cú_ch¬buf
 *
c
, cÚ¡ cú_ch¬buà*
i
);

75 
cú_ch¬buf_­³nd_¡ršg
(
cú_ch¬buf
 *
c
, cÚ¡ *
s
);

81 
cú_ch¬buf_putf
(
cú_ch¬buf
 *
c
, cÚ¡ *
fmt
, ...);

90 
cú_ch¬buf_­³nd_d©‘ime
(
cú_ch¬buf
 *
c
, 
time_t
 
£cs
, 
n£cs
);

104 
	#CCN_DATETIME_PRECISION_USEC
 6

	)

105 
	#CCN_DATETIME_PRECISION_MAX
 6

	)

106 
cú_ch¬buf_­³nd_d©‘ime_now
(
cú_ch¬buf
 *
c
, 
´ecisiÚ
);

115 *
cú_ch¬buf_as_¡ršg
(
cú_ch¬buf
 *
c
);

	@include/ccn/coding.h

22 #iâdeà
CCN_CODING_DEFINED


23 
	#CCN_CODING_DEFINED


	)

25 
	~<sys/ty³s.h
>

26 
	~<¡ddef.h
>

28 
	#CCN_TT_BITS
 3

	)

29 
	#CCN_TT_MASK
 ((1 << 
CCN_TT_BITS
è- 1)

	)

30 
	#CCN_MAX_TINY
 ((1 << (7-
CCN_TT_BITS
)è- 1)

	)

31 
	#CCN_TT_HBIT
 (()(1 << 7))

	)

36 
	ecú_‰
 {

37 
	mCCN_EXT
,

38 
	mCCN_TAG
,

39 
	mCCN_DTAG
,

40 
	mCCN_ATTR
,

41 
	mCCN_DATTR
,

42 
	mCCN_BLOB
,

43 
	mCCN_UDATA
,

44 
	mCCN_NO_TOKEN


48 
	#CCN_CLOSE
 (()(0))

	)

50 
	ecú_ext_subty³
 {

52 
	mCCN_PROCESSING_INSTRUCTIONS
 = 16

60 
	ecú_dg
 {

61 
	mCCN_DTAG_Any
 = 13,

62 
	mCCN_DTAG_Name
 = 14,

63 
	mCCN_DTAG_CompÚ’t
 = 15,

64 
	mCCN_DTAG_C”tifiÿ‹
 = 16,

65 
	mCCN_DTAG_CŞËùiÚ
 = 17,

66 
	mCCN_DTAG_Com¶‘eName
 = 18,

67 
	mCCN_DTAG_CÚ‹Á
 = 19,

68 
	mCCN_DTAG_SigÃdInfo
 = 20,

69 
	mCCN_DTAG_CÚ‹ÁDige¡
 = 21,

70 
	mCCN_DTAG_CÚ‹ÁHash
 = 22,

71 
	mCCN_DTAG_CouÁ
 = 24,

72 
	mCCN_DTAG_H—d”
 = 25,

73 
	mCCN_DTAG_IÁ”e¡
 = 26,

74 
	mCCN_DTAG_Key
 = 27,

75 
	mCCN_DTAG_KeyLoÿtÜ
 = 28,

76 
	mCCN_DTAG_KeyName
 = 29,

77 
	mCCN_DTAG_L’gth
 = 30,

78 
	mCCN_DTAG_Lšk
 = 31,

79 
	mCCN_DTAG_LškAuth’tiÿtÜ
 = 32,

80 
	mCCN_DTAG_NameCompÚ’tCouÁ
 = 33,

81 
	mCCN_DTAG_RoÙDige¡
 = 36,

82 
	mCCN_DTAG_SigÇtu»
 = 37,

83 
	mCCN_DTAG_S¹
 = 38,

84 
	mCCN_DTAG_Time¡amp
 = 39,

85 
	mCCN_DTAG_Ty³
 = 40,

86 
	mCCN_DTAG_NÚû
 = 41,

87 
	mCCN_DTAG_Scİe
 = 42,

88 
	mCCN_DTAG_Exşude
 = 43,

89 
	mCCN_DTAG_Bloom
 = 44,

90 
	mCCN_DTAG_BloomS“d
 = 45,

91 
	mCCN_DTAG_Answ”OrigšKšd
 = 47,

92 
	mCCN_DTAG_IÁ”e¡Liãtime
 = 48,

93 
	mCCN_DTAG_W™Ãss
 = 53,

94 
	mCCN_DTAG_SigÇtu»B™s
 = 54,

95 
	mCCN_DTAG_Dige¡AlgÜ™hm
 = 55,

96 
	mCCN_DTAG_BlockSize
 = 56,

97 
	mCCN_DTAG_F»shÃssSecÚds
 = 58,

98 
	mCCN_DTAG_Fš®BlockID
 = 59,

99 
	mCCN_DTAG_Publish”PublicKeyDige¡
 = 60,

100 
	mCCN_DTAG_Publish”C”tifiÿ‹Dige¡
 = 61,

101 
	mCCN_DTAG_Publish”Issu”KeyDige¡
 = 62,

102 
	mCCN_DTAG_Publish”Issu”C”tifiÿ‹Dige¡
 = 63,

103 
	mCCN_DTAG_CÚ‹ÁObjeù
 = 64,

104 
	mCCN_DTAG_W¿µedKey
 = 65,

105 
	mCCN_DTAG_W¿µšgKeyId’tif›r
 = 66,

106 
	mCCN_DTAG_W¿pAlgÜ™hm
 = 67,

107 
	mCCN_DTAG_KeyAlgÜ™hm
 = 68,

108 
	mCCN_DTAG_Lab–
 = 69,

109 
	mCCN_DTAG_Enüy±edKey
 = 70,

110 
	mCCN_DTAG_Enüy±edNÚûKey
 = 71,

111 
	mCCN_DTAG_W¿µšgKeyName
 = 72,

112 
	mCCN_DTAG_AùiÚ
 = 73,

113 
	mCCN_DTAG_FaûID
 = 74,

114 
	mCCN_DTAG_IPPrÙo
 = 75,

115 
	mCCN_DTAG_Ho¡
 = 76,

116 
	mCCN_DTAG_PÜt
 = 77,

117 
	mCCN_DTAG_MuÉiÿ¡IÁ”çû
 = 78,

118 
	mCCN_DTAG_FÜw¬dšgFÏgs
 = 79,

119 
	mCCN_DTAG_FaûIn¡ªû
 = 80,

120 
	mCCN_DTAG_FÜw¬dšgEÁry
 = 81,

121 
	mCCN_DTAG_MuÉiÿ¡TTL
 = 82,

122 
	mCCN_DTAG_MšSuffixCompÚ’ts
 = 83,

123 
	mCCN_DTAG_MaxSuffixCompÚ’ts
 = 84,

124 
	mCCN_DTAG_ChdS–eùÜ
 = 85,

125 
	mCCN_DTAG_R•os™ÜyInfo
 = 86,

126 
	mCCN_DTAG_V”siÚ
 = 87,

127 
	mCCN_DTAG_R•os™ÜyV”siÚ
 = 88,

128 
	mCCN_DTAG_Glob®P»fix
 = 89,

129 
	mCCN_DTAG_LoÿlName
 = 90,

130 
	mCCN_DTAG_PŞicy
 = 91,

131 
	mCCN_DTAG_Name¥aû
 = 92,

132 
	mCCN_DTAG_Glob®P»fixName
 = 93,

133 
	mCCN_DTAG_PŞicyV”siÚ
 = 94,

134 
	mCCN_DTAG_KeyV®ueS‘
 = 95,

135 
	mCCN_DTAG_KeyV®uePaœ
 = 96,

136 
	mCCN_DTAG_IÁeg”V®ue
 = 97,

137 
	mCCN_DTAG_Decim®V®ue
 = 98,

138 
	mCCN_DTAG_SŒšgV®ue
 = 99,

139 
	mCCN_DTAG_Bš¬yV®ue
 = 100,

140 
	mCCN_DTAG_NameV®ue
 = 101,

141 
	mCCN_DTAG_EÁry
 = 102,

142 
	mCCN_DTAG_ACL
 = 103,

143 
	mCCN_DTAG_P¬am‘”izedName
 = 104,

144 
	mCCN_DTAG_P»fix
 = 105,

145 
	mCCN_DTAG_Suffix
 = 106,

146 
	mCCN_DTAG_RoÙ
 = 107,

147 
	mCCN_DTAG_ProfeName
 = 108,

148 
	mCCN_DTAG_P¬am‘”s
 = 109,

149 
	mCCN_DTAG_CCNPrÙocŞD©aUn™
 = 17702112

152 
	scú_diù_’Œy
 {

153 
	mšdex
;

154 cÚ¡ *
	mÇme
;

157 
	scú_diù
 {

158 
	mcouÁ
;

159 cÚ¡ 
cú_diù_’Œy
 *
	mdiù
;

165 cÚ¡ 
cú_diù
 
cú_dg_diù
;

167 
	scú_sk–‘Ú_decod”
 {

168 
ssize_t
 
	mšdex
;

169 
	m¡©e
;

170 
	mÃ¡
;

171 
size_t
 
	mnumv®
;

172 
size_t
 
	mtok’_šdex
;

173 
size_t
 
	m–em’t_šdex
;

182 
	ecú_decod”_¡©e
 {

183 
	mCCN_DSTATE_INITIAL
 = 0,

184 
	mCCN_DSTATE_NEWTOKEN
,

185 
	mCCN_DSTATE_NUMVAL
,

186 
	mCCN_DSTATE_UDATA
,

187 
	mCCN_DSTATE_TAGNAME
,

188 
	mCCN_DSTATE_ATTRNAME
,

189 
	mCCN_DSTATE_BLOB
,

191 
	mCCN_DSTATE_ERR_OVERFLOW
 = -1,

192 
	mCCN_DSTATE_ERR_ATTR
 = -2,

193 
	mCCN_DSTATE_ERR_CODING
 = -3,

194 
	mCCN_DSTATE_ERR_NEST
 = -4,

195 
	mCCN_DSTATE_ERR_BUG
 = -5

207 
	#CCN_DSTATE_PAUSE
 (1 << 15)

	)

208 
	#CCN_GET_TT_FROM_DSTATE
(
¡©e
è(
CCN_TT_MASK
 & ((¡©eè>> 16))

	)

209 
	#CCN_FINAL_DSTATE
(
¡©e
è(((¡©eè& (
CCN_DSTATE_PAUSE
-1)è=ğ0)

	)

211 
ssize_t
 
cú_sk–‘Ú_decode
(
cú_sk–‘Ú_decod”
 *
d
,

212 cÚ¡ *
p
,

213 
size_t
 
n
);

	@include/ccn/digest.h

25 #iâdeà
CCN_DIGEST_DEFINED


26 
	#CCN_DIGEST_DEFINED


	)

28 
	~<¡ddef.h
>

30 
	gcú_dige¡
;

33 
	ecú_dige¡_id
 {

34 
	mCCN_DIGEST_DEFAULT
,

35 
	mCCN_DIGEST_SHA1
,

36 
	mCCN_DIGEST_SHA224
,

37 
	mCCN_DIGEST_SHA256
,

38 
	mCCN_DIGEST_SHA384
,

39 
	mCCN_DIGEST_SHA512


42 
cú_dige¡
 *
cú_dige¡_ü—‹
(
cú_dige¡_id
);

43 
cú_dige¡_de¡roy
(
cú_dige¡
 **);

44 
cú_dige¡_id
 
cú_dige¡_g‘id
(
cú_dige¡
 *);

45 
size_t
 
cú_dige¡_size
(
cú_dige¡
 *);

46 
cú_dige¡_š™
(
cú_dige¡
 *);

48 
cú_dige¡_upd©e
(
cú_dige¡
 *, cÚ¡ *, 
size_t
);

49 
cú_dige¡_fš®
(
cú_dige¡
 *, *, 
size_t
);

	@include/ccn/extend_dict.h

22 #iâdeà
CCN_EXTEND_DICT_DEFINED


23 
	#CCN_EXTEND_DICT_DEFINED


	)

25 
	~<cú/codšg.h
>

31 
cú_de¡roy_diù
(
cú_diù
 **
dp
);

37 
cú_ex‹nd_diù
(cÚ¡ *
diù_fe
, 
cú_diù
 *
d
,

38 
cú_diù
 **
rdp
);

	@include/ccn/face_mgmt.h

20 #iâdeà
CCN_FACE_MGMT_DEFINED


21 
	#CCN_FACE_MGMT_DEFINED


	)

23 
	~<¡ddef.h
>

24 
	~<cú/ch¬buf.h
>

25 
	~<cú/sockü—‹.h
>

27 
	#CCN_NO_FACEID
 (~0U)

	)

29 
	scú_çû_š¡ªû
 {

30 cÚ¡ *
	maùiÚ
;

31 cÚ¡ *
	mcúd_id
;

32 
size_t
 
	mcúd_id_size
;

33 
	mçûid
;

34 
cú_sockdesü
 
	mdesü
;

35 
	mliãtime
;

36 
cú_ch¬buf
 *
	m¡Üe
;

39 
cú_çû_š¡ªû
 *
cú_çû_š¡ªû_·r£
(cÚ¡ *
p
,

40 
size_t
 
size
);

42 
cú_çû_š¡ªû_de¡roy
(
cú_çû_š¡ªû
**);

44 
cúb_­³nd_çû_š¡ªû
(
cú_ch¬buf
 *,

45 cÚ¡ 
cú_çû_š¡ªû
 *);

	@include/ccn/hashtb.h

22 #iâdeà
CCN_HASHTB_DEFINED


23 
	#CCN_HASHTB_DEFINED


	)

25 
	~<¡ddef.h
>

27 
	ghashtb
;

28 
	ghashtb_’um”©Ü
;

29 (*
	thashtb_fš®ize_´oc
)(
	thashtb_’um”©Ü
 *);

30 
	shashtb_·¿m
 {

31 
hashtb_fš®ize_´oc
 
fš®ize
;

32 *
fš®ize_d©a
;

33 
Üd”s
;

41 
hashtb
 *

42 
	`hashtb_ü—‹
(
size_t
 
™em_size
, cÚ¡ 
hashtb_·¿m
 *
·¿m
);

50 
	`hashtb_g‘_·¿m
(
hashtb
 *
ht
, 
hashtb_·¿m
 *
·¿m
);

56 
	`hashtb_de¡roy
(
hashtb
 **
ht
);

62 
	`hashtb_n
(
hashtb
 *
ht
);

70 
	`hashtb_lookup
(
hashtb
 *
ht
, cÚ¡ *
key
, 
size_t
 
keysize
);

73 
	shashtb_’um”©Ü
 {

74 
hashtb
 *
ht
;

75 cÚ¡ *
key
;

76 
size_t
 
keysize
;

77 
size_t
 
extsize
;

78 *
d©a
;

79 
size_t
 
d©asize
;

80 *
´iv
[3];

90 
hashtb_’um”©Ü
 *

91 
	`hashtb_¡¬t
(
hashtb
 *, 
hashtb_’um”©Ü
 *);

92 
	`hashtb_’d
(
hashtb_’um”©Ü
 *);

94 
	`hashtb_Ãxt
(
hashtb_’um”©Ü
 *);

109 
	`hashtb_£ek
(
hashtb_’um”©Ü
 *
h‹
,

110 cÚ¡ *
key
, 
size_t
 
keysize
, size_ˆ
extsize
);

111 
	#HT_OLD_ENTRY
 0

	)

112 
	#HT_NEW_ENTRY
 1

	)

124 
	`hashtb_d–‘e
(
hashtb_’um”©Ü
 *);

134 
	`hashtb_»hash
(
hashtb
 *
ht
, 
n_buck‘s
);

	@include/ccn/header.h

20 #iâdeà
CCN_HEADER_DEFINED


21 
	#CCN_HEADER_DEFINED


	)

23 
	~<¡ddef.h
>

24 
	~<cú/ch¬buf.h
>

26 
	scú_h—d”
 {

27 
uštmax_t
 
	m¡¬t
;

28 
uštmax_t
 
	mcouÁ
;

29 
uštmax_t
 
	mblock_size
;

30 
uštmax_t
 
	mËngth
;

31 
cú_ch¬buf
 *
	mroÙ_dige¡
;

32 
cú_ch¬buf
 *
	mcÚ‹Á_dige¡
;

35 
cú_h—d”
 *
cú_h—d”_·r£
(cÚ¡ *, 
size_t
);

37 
cú_h—d”_de¡roy
(
cú_h—d”
 **);

39 
cúb_­³nd_h—d”
(
cú_ch¬buf
 *, cÚ¡ 
cú_h—d”
 *);

41 
cú_h—d”
 *
cú_g‘_h—d”
(
cú
 *, 
cú_ch¬buf
 *, );

	@include/ccn/indexbuf.h

22 #iâdeà
CCN_INDEXBUF_DEFINED


23 
	#CCN_INDEXBUF_DEFINED


	)

25 
	~<¡ddef.h
>

27 
	scú_šdexbuf
 {

28 
size_t
 
	mn
;

29 
size_t
 
	mlim™
;

30 
size_t
 *
	mbuf
;

33 
cú_šdexbuf
 *
cú_šdexbuf_ü—‹
();

34 
cú_šdexbuf_de¡roy
(
cú_šdexbuf
 **
cbp
);

35 
size_t
 *
cú_šdexbuf_»£rve
(
cú_šdexbuf
 *
c
, size_ˆ
n
);

36 
cú_šdexbuf_­³nd
(
cú_šdexbuf
 *
c
, cÚ¡ 
size_t
 *
p
, size_ˆ
n
);

37 
cú_šdexbuf_­³nd_–em’t
(
cú_šdexbuf
 *
c
, 
size_t
 
v
);

38 
cú_šdexbuf_memb”
(
cú_šdexbuf
 *
x
, 
size_t
 
v®
);

39 
cú_šdexbuf_»move_–em’t
(
cú_šdexbuf
 *
x
, 
size_t
 
v®
);

40 
cú_šdexbuf_£t_š£¹
(
cú_šdexbuf
 *
x
, 
size_t
 
v®
);

41 
cú_šdexbuf_»move_fœ¡_m©ch
(
cú_šdexbuf
 *
x
, 
size_t
 
v®
);

42 
cú_šdexbuf_move_to_’d
(
cú_šdexbuf
 *
x
, 
size_t
 
v®
);

43 
cú_šdexbuf_move_to_äÚt
(
cú_šdexbuf
 *
x
, 
size_t
 
v®
);

	@include/ccn/keystore.h

25 #iâdeà
CCN_KEYSTORE_DEFINED


26 
	#CCN_KEYSTORE_DEFINED


	)

28 
	~<¡ddef.h
>

33 
	gcú_key¡Üe
;

38 
	gcú_pkey
;

43 
	gcú_û¹ifiÿ‹
;

45 
cú_key¡Üe
 *
cú_key¡Üe_ü—‹
();

46 
cú_key¡Üe_de¡roy
(
cú_key¡Üe
 **
p
);

47 
cú_key¡Üe_š™
(
cú_key¡Üe
 *
p
, *
Çme
, *
·sswÜd
);

48 cÚ¡ 
cú_pkey
 *
cú_key¡Üe_´iv©e_key
(
cú_key¡Üe
 *
p
);

49 cÚ¡ 
cú_pkey
 *
cú_key¡Üe_public_key
(
cú_key¡Üe
 *
p
);

50 
ssize_t
 
cú_key¡Üe_public_key_dige¡_Ëngth
(
cú_key¡Üe
 *
p
);

51 cÚ¡ *
cú_key¡Üe_public_key_dige¡
(
cú_key¡Üe
 *
p
);

52 cÚ¡ 
cú_û¹ifiÿ‹
 *
cú_key¡Üe_û¹ifiÿ‹
(
cú_key¡Üe
 *
p
);

	@include/ccn/matrix.h

25 #iâdeà
CCN_MATRIX_DEFINED


26 
	#CCN_MATRIX_DEFINED


	)

28 
	~<¡dšt.h
>

30 
	gcú_m©rix
;

32 
	scú_m©rix_bounds
 {

33 
ušt_Ëa¡64_t
 
	mrow_mš
;

34 
ušt_Ëa¡64_t
 
	mrow_max
;

35 
	mcŞ_mš
;

36 
	mcŞ_max
;

39 
cú_m©rix
 *
cú_m©rix_ü—‹
();

40 
cú_m©rix_de¡roy
(
cú_m©rix
 **);

42 
šŒ_t
 
cú_m©rix_ãtch
(
cú_m©rix
 *
m
,

43 
ušt_Ëa¡64_t
 
row
, 
cŞ
);

44 
cú_m©rix_¡Üe
(
cú_m©rix
 *
m
,

45 
ušt_Ëa¡64_t
 
row
, 
cŞ
, 
šŒ_t
 
v®ue
);

53 
cú_m©rix_g‘bounds
(
cú_m©rix
 *
m
, 
cú_m©rix_bounds
 *
»suÉ
);

59 
cú_m©rix_Œim
(
cú_m©rix
 *
m
, cÚ¡ 
cú_m©rix_bounds
 *
bounds
);

64 
cú_m©rix_ş—r
(
cú_m©rix
 *
m
, cÚ¡ 
cú_m©rix_bounds
 *
bounds
);

	@include/ccn/merklepathasn1.h

21 #iâdeà
CCN_MERKLEPATHASN1_DEFINED


22 
	#CCN_MERKLEPATHASN1_DEFINED


	)

24 
	~<İ’s¦/a¢1.h
>

25 
	~<İ’s¦/a¢1t.h
>

26 
	~<İ’s¦/§ã¡ack.h
>

28 
	$DECLARE_STACK_OF
(
ASN1_OCTET_STRING
)

33 
	#sk_ASN1_OCTET_STRING_Ãw
(
cmp
è
	`SKM_sk_Ãw
(
ASN1_OCTET_STRING
, (cmp))

	)

34 
	#sk_ASN1_OCTET_STRING_Ãw_nuÎ
(è
	`SKM_sk_Ãw_nuÎ
(
ASN1_OCTET_STRING
)

	)

35 
	#sk_ASN1_OCTET_STRING_ä“
(
¡
è
	`SKM_sk_ä“
(
ASN1_OCTET_STRING
, (¡))

	)

36 
	#sk_ASN1_OCTET_STRING_num
(
¡
è
	`SKM_sk_num
(
ASN1_OCTET_STRING
, (¡))

	)

37 
	#sk_ASN1_OCTET_STRING_v®ue
(
¡
, 
i
è
	`SKM_sk_v®ue
(
ASN1_OCTET_STRING
, (¡), (i))

	)

38 
	#sk_ASN1_OCTET_STRING_£t
(
¡
, 
i
, 
v®
è
	`SKM_sk_£t
(
ASN1_OCTET_STRING
, (¡), (i), (v®))

	)

39 
	#sk_ASN1_OCTET_STRING_z”o
(
¡
è
	`SKM_sk_z”o
(
ASN1_OCTET_STRING
, (¡))

	)

40 
	#sk_ASN1_OCTET_STRING_push
(
¡
, 
v®
è
	`SKM_sk_push
(
ASN1_OCTET_STRING
, (¡), (v®))

	)

41 
	#sk_ASN1_OCTET_STRING_unshiá
(
¡
, 
v®
è
	`SKM_sk_unshiá
(
ASN1_OCTET_STRING
, (¡), (v®))

	)

42 
	#sk_ASN1_OCTET_STRING_fšd
(
¡
, 
v®
è
	`SKM_sk_fšd
(
ASN1_OCTET_STRING
, (¡), (v®))

	)

43 
	#sk_ASN1_OCTET_STRING_fšd_ex
(
¡
, 
v®
è
	`SKM_sk_fšd_ex
(
ASN1_OCTET_STRING
, (¡), (v®))

	)

44 
	#sk_ASN1_OCTET_STRING_d–‘e
(
¡
, 
i
è
	`SKM_sk_d–‘e
(
ASN1_OCTET_STRING
, (¡), (i))

	)

45 
	#sk_ASN1_OCTET_STRING_d–‘e_±r
(
¡
, 
±r
è
	`SKM_sk_d–‘e_±r
(
ASN1_OCTET_STRING
, (¡), (±r))

	)

46 
	#sk_ASN1_OCTET_STRING_š£¹
(
¡
, 
v®
, 
i
è
	`SKM_sk_š£¹
(
ASN1_OCTET_STRING
, (¡), (v®), (i))

	)

47 
	#sk_ASN1_OCTET_STRING_£t_cmp_func
(
¡
, 
cmp
è
	`SKM_sk_£t_cmp_func
(
ASN1_OCTET_STRING
, (¡), (cmp))

	)

48 
	#sk_ASN1_OCTET_STRING_dup
(
¡
è
	`SKM_sk_dup
(
ASN1_OCTET_STRING
, st)

	)

49 
	#sk_ASN1_OCTET_STRING_pİ_ä“
(
¡
, 
ä“_func
è
	`SKM_sk_pİ_ä“
(
ASN1_OCTET_STRING
, (¡), (ä“_func))

	)

50 
	#sk_ASN1_OCTET_STRING_shiá
(
¡
è
	`SKM_sk_shiá
(
ASN1_OCTET_STRING
, (¡))

	)

51 
	#sk_ASN1_OCTET_STRING_pİ
(
¡
è
	`SKM_sk_pİ
(
ASN1_OCTET_STRING
, (¡))

	)

52 
	#sk_ASN1_OCTET_STRING_sÜt
(
¡
è
	`SKM_sk_sÜt
(
ASN1_OCTET_STRING
, (¡))

	)

53 
	#sk_ASN1_OCTET_STRING_is_sÜ‹d
(
¡
è
	`SKM_sk_is_sÜ‹d
(
ASN1_OCTET_STRING
, (¡))

	)

55 
	sMP_šfo_¡
 {

56 
ASN1_INTEGER
 *
node
;

57 
	`STACK_OF
(
ASN1_OCTET_STRING
è*
hashes
;

58 } 
	tMP_šfo
;

60 
	$DECLARE_ASN1_FUNCTIONS
(
MP_šfo
)

	@include/ccn/random.h

21 #iâdeà
CCN_RANDOM_DEFINED


22 
	#CCN_RANDOM_DEFINED


	)

24 
	~<¡ddef.h
>

26 
cú_¿ndom_by‹s
(*
buf
, 
size_t
 
size
);

27 
cú_add_’Œİy
(cÚ¡ *
buf
, 
size_t
 
size
, 
b™s_of_’Œİy
);

	@include/ccn/reg_mgmt.h

20 #iâdeà
CCN_REG_MGMT_DEFINED


21 
	#CCN_REG_MGMT_DEFINED


	)

23 
	~<¡ddef.h
>

24 
	~<cú/ch¬buf.h
>

26 
	scú_fÜw¬dšg_’Œy
 {

27 cÚ¡ *
	maùiÚ
;

28 
cú_ch¬buf
 *
	mÇme_´efix
;

29 cÚ¡ *
	mcúd_id
;

30 
size_t
 
	mcúd_id_size
;

31 
	mçûid
;

32 
	mæags
;

33 
	mliãtime
;

34 
	m¡Üe
[48];

37 
	#CCN_FORW_ACTIVE
 1

	)

38 
	#CCN_FORW_CHILD_INHERIT
 2

	)

39 
	#CCN_FORW_ADVERTISE
 4

	)

40 
	#CCN_FORW_LAST
 8

	)

41 
	#CCN_FORW_CAPTURE
 16

	)

42 
	#CCN_FORW_LOCAL
 32

	)

43 
	#CCN_FORW_TAP
 64

	)

44 
	#CCN_FORW_PUBMASK
 (
CCN_FORW_ACTIVE
 | \

45 
CCN_FORW_CHILD_INHERIT
 | \

46 
CCN_FORW_ADVERTISE
 | \

47 
CCN_FORW_LAST
 | \

48 
CCN_FORW_CAPTURE
 | \

49 
CCN_FORW_LOCAL
 | \

50 
CCN_FORW_TAP
 )

	)

52 
cú_fÜw¬dšg_’Œy
 *

53 
cú_fÜw¬dšg_’Œy_·r£
(cÚ¡ *
p
, 
size_t
 
size
);

55 
cú_fÜw¬dšg_’Œy_de¡roy
(
cú_fÜw¬dšg_’Œy
**);

57 
cúb_­³nd_fÜw¬dšg_’Œy
(
cú_ch¬buf
 *,

58 cÚ¡ 
cú_fÜw¬dšg_’Œy
*);

	@include/ccn/schedule.h

22 #iâdeà
CCN_SCHEDULE_DEFINED


23 
	#CCN_SCHEDULE_DEFINED


	)

25 
	~<¡dšt.h
>

27 
	gcú_scheduË
;

28 
	gcú_scheduËd_ev’t
;

37 
	scú_timev®
 {

38 
	ms
;

39 
	mmiüos
;

42 
	gcú_g‘time
;

43 (*
	tcú_g‘time_aùiÚ
)(cÚ¡ 
	tcú_g‘time
 *, 
	tcú_timev®
 *);

44 
	scú_g‘time
 {

45 
desü
[8];

46 
cú_g‘time_aùiÚ
 
g‘time
;

47 
miüos_³r_ba£
;

48 *
d©a
;

59 
	#CCN_SCHEDULE_CANCEL
 0x10

	)

60 (*
	tcú_scheduËd_aùiÚ
)(

61 
	tcú_scheduË
 *
	tsched
,

62 *
	tş›Áh
,

63 
	tcú_scheduËd_ev’t
 *
	tev
,

64 
	tæags
);

66 
	scú_scheduËd_ev’t
 {

67 
cú_scheduËd_aùiÚ
 
aùiÚ
;

68 *
evd©a
;

69 
šŒ_t
 
evšt
;

75 
cú_scheduË
 *
	`cú_scheduË_ü—‹
(*
ş›Áh
,

76 cÚ¡ 
cú_g‘time
 *
cúşock
);

77 
	`cú_scheduË_de¡roy
(
cú_scheduË
 **
schedp
);

82 cÚ¡ 
cú_g‘time
 *
	`cú_scheduË_g‘_g‘time
(
cú_scheduË
 *);

87 
cú_scheduËd_ev’t
 *
	`cú_scheduË_ev’t
(

88 
cú_scheduË
 *
sched
,

89 
miüos
,

90 
cú_scheduËd_aùiÚ
 
aùiÚ
,

91 *
evd©a
,

92 
šŒ_t
 
evšt
);

99 
	`cú_scheduË_ÿnûl
(
cú_scheduË
 *, 
cú_scheduËd_ev’t
 *);

107 
	`cú_scheduË_run
(
cú_scheduË
 *);

	@include/ccn/seqwriter.h

21 #iâdeà
CCN_SEQWRITER_DEFINED


22 
	#CCN_SEQWRITER_DEFINED


	)

24 
	~<¡ddef.h
>

25 
	gcú_£qwr™”
;

26 
	gcú
;

27 
	gcú_ch¬buf
;

29 
cú_£qwr™”
 *
cú_£qw_ü—‹
(
cú
 *
h
, 
cú_ch¬buf
 *
Çme
);

30 
cú_£qw_possibË_š‹»¡
(
cú_£qwr™”
 *
w
);

31 
cú_£qw_b©ch_¡¬t
(
cú_£qwr™”
 *
w
);

32 
cú_£qw_wr™e
(
cú_£qwr™”
 *
w
, cÚ¡ *
buf
, 
size_t
 
size
);

33 
cú_£qw_b©ch_’d
(
cú_£qwr™”
 *
w
);

34 
cú_£qw_şo£
(
cú_£qwr™”
 *
w
);

	@include/ccn/signing.h

24 #iâdeà
CCN_SIGNING_DEFINED


25 
	#CCN_SIGNING_DEFINED


	)

27 
	~<¡ddef.h
>

28 
	~<cú/ch¬buf.h
>

33 
	gcú_sigc
;

38 
	gcú_pkey
;

43 
	gcú_sigÇtu»
;

48 
	gcú_·r£d_CÚ‹ÁObjeù
;

50 
cú_sigc
 *
cú_sigc_ü—‹
();

51 
cú_sigc_š™
(
cú_sigc
 *
ùx
, cÚ¡ *
dige¡
);

52 
cú_sigc_de¡roy
(
cú_sigc
 **);

53 
cú_sigc_upd©e
(
cú_sigc
 *
ùx
, cÚ¡ *
d©a
, 
size_t
 
size
);

54 
cú_sigc_fš®
(
cú_sigc
 *
ùx
, 
cú_sigÇtu»
 *
sigÇtu»
, 
size_t
 *
size
, cÚ¡ 
cú_pkey
 *
´iv_key
);

55 
size_t
 
cú_sigc_sigÇtu»_max_size
(
cú_sigc
 *
ùx
, cÚ¡ 
cú_pkey
 *
´iv_key
);

56 
cú_v”ify_sigÇtu»
(cÚ¡ *
msg
, 
size_t
 
size
, cÚ¡ 
cú_·r£d_CÚ‹ÁObjeù
 *
co
,

57 cÚ¡ 
cú_pkey
 *
v”ifiÿtiÚ_pubkey
);

58 
cú_pkey
 *
cú_d2i_pubkey
(cÚ¡ *
p
, 
size_t
 
size
);

59 
cú_pubkey_ä“
(
cú_pkey
 *
i_pubkey
);

60 
size_t
 
cú_pubkey_size
(cÚ¡ 
cú_pkey
 *
i_pubkey
);

67 
cú_­³nd_pubkey_blob
(
cú_ch¬buf
 *
c
, cÚ¡ 
cú_pkey
 *
i_pubkey
);

	@include/ccn/sockaddrutil.h

21 #iâdeà
CCN_SOCKADDRUTIL_DEFINED


22 
	#CCN_SOCKADDRUTIL_DEFINED


	)

24 
	~<sys/sock‘.h
>

25 
	~<cú/ch¬buf.h
>

28 
cú_ch¬buf_­³nd_sockaddr
(
cú_ch¬buf
 *, cÚ¡ 
sockaddr
 *);

	@include/ccn/sockcreate.h

20 #iâdeà
CCN_SOCKCREATE_DEFINED


21 
	#CCN_SOCKCREATE_DEFINED


	)

22 
	~<sys/ty³s.h
>

23 
	~<sys/sock‘.h
>

32 
	scú_sock‘s
 {

33 
	m»cvšg
;

34 
	m£ndšg
;

41 
	scú_sockdesü
 {

42 
	m´Ùo
;

44 cÚ¡ *
	madd»ss
;

45 cÚ¡ *
	mpÜt
;

46 cÚ¡ *
	msourû_add»ss
;

47 
	mmÿ¡_‰l
;

50 
cú_£tup_sock‘
(cÚ¡ 
cú_sockdesü
 *
desü
,

51 (*
logg”
)(*, const *, ...),

52 *
logd©
,

53 (*
g‘bound
)(*, 
sockaddr
 *, 
sockËn_t
),

54 *
g‘boundd©
,

55 
cú_sock‘s
 *
socks
);

	@include/ccn/uri.h

22 #iâdeà
CCN_URI_DEFINED


23 
	#CCN_URI_DEFINED


	)

25 
	~<cú/ch¬buf.h
>

29 
cú_uri_­³nd_³rûÁesÿ³d
(
cú_ch¬buf
 *
c
,

30 cÚ¡ *
d©a
, 
size_t
 
size
);

34 
cú_uri_­³nd
(
cú_ch¬buf
 *
c
,

35 cÚ¡ *
cúb
,

36 
size_t
 
size
,

37 
šşudescheme
);

41 
cú_Çme_äom_uri
(
cú_ch¬buf
 *
c
, cÚ¡ *
uri
);

	@lib/basicparsetest.c

20 
	~<¡ddef.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

26 
	~<cú/cú.h
>

27 
	~<cú/ch¬buf.h
>

28 
	~<cú/codšg.h
>

29 
	~<cú/çû_mgmt.h
>

30 
	~<cú/sockü—‹.h
>

31 
	~<cú/»g_mgmt.h
>

32 
	~<cú/h—d”.h
>

43 
	$maš
 (
¬gc
, **
¬gv
)

45 
buf
[8800];

46 
ssize_t
 
size
;

47 
cú_çû_š¡ªû
 *
çû_š¡ªû
;

48 
cú_fÜw¬dšg_’Œy
 *
fÜw¬dšg_’Œy
;

49 
cú_h—d”
 *
h—d”
;

50 
»s
 = 1;

51 
cú_ch¬buf
 *
c
 = 
	`cú_ch¬buf_ü—‹
();

52 
i
;

53 
cú_·r£d_š‹»¡
 
·r£d_š‹»¡
 = {0};

54 
cú_·r£d_š‹»¡
 *
pi
 = &
·r£d_š‹»¡
;

56 
size
 = 
	`»ad
(0, 
buf
, (buf));

57 ià(
size
 < 0)

58 
	`ex™
(0);

60 
çû_š¡ªû
 = 
	`cú_çû_š¡ªû_·r£
(
buf
, 
size
);

61 ià(
çû_š¡ªû
 !ğ
NULL
) {

62 
	`´štf
("face_instance OK\n");

63 
c
->
Ëngth
 = 0;

64 
»s
 = 
	`cúb_­³nd_çû_š¡ªû
(
c
, 
çû_š¡ªû
);

65 ià(
»s
 != 0)

66 
	`´štf
("face_instance‡ppend failed\n");

67 ià(
	`memcmp
(
buf
, 
c
->buf, c->
Ëngth
) != 0)

68 
	`´štf
("face_instance mismatch\n");

69 
	`cú_çû_š¡ªû_de¡roy
(&
çû_š¡ªû
);

70 
çû_š¡ªû
 = 
	`cú_çû_š¡ªû_·r£
(
c
->
buf
, c->
Ëngth
);

71 ià(
çû_š¡ªû
 =ğ
NULL
) {

72 
	`´štf
("face_instance„eparse failed\n");

73 
»s
 = 1;

76 
	`cú_çû_š¡ªû_de¡roy
(&
çû_š¡ªû
);

78 
fÜw¬dšg_’Œy
 = 
	`cú_fÜw¬dšg_’Œy_·r£
(
buf
, 
size
);

79 ià(
fÜw¬dšg_’Œy
 !ğ
NULL
) {

80 
	`´štf
("forwarding_entry OK\n");

81 
c
->
Ëngth
 = 0;

82 
»s
 = 
	`cúb_­³nd_fÜw¬dšg_’Œy
(
c
, 
fÜw¬dšg_’Œy
);

83 ià(
»s
 != 0)

84 
	`´štf
("forwarding_entry‡ppend failed\n");

85 ià(
	`memcmp
(
buf
, 
c
->buf, c->
Ëngth
) != 0)

86 
	`´štf
("forwarding_entry mismatch\n");

87 
	`cú_fÜw¬dšg_’Œy_de¡roy
(&
fÜw¬dšg_’Œy
);

88 
fÜw¬dšg_’Œy
 = 
	`cú_fÜw¬dšg_’Œy_·r£
(
c
->
buf
, c->
Ëngth
);

89 ià(
fÜw¬dšg_’Œy
 =ğ
NULL
) {

90 
	`´štf
("forwarding_entry„eparse failed\n");

91 
»s
 = 1;

94 
	`cú_fÜw¬dšg_’Œy_de¡roy
(&
fÜw¬dšg_’Œy
);

96 
h—d”
 = 
	`cú_h—d”_·r£
(
buf
, 
size
);

97 ià(
h—d”
 !ğ
NULL
) {

98 
	`´štf
("header OK\n");

99 
c
->
Ëngth
 = 0;

100 
»s
 = 
	`cúb_­³nd_h—d”
(
c
, 
h—d”
);

101 ià(
»s
 != 0)

102 
	`´štf
("header‡ppend failed\n");

103 ià(
	`memcmp
(
buf
, 
c
->buf, c->
Ëngth
) != 0)

104 
	`´štf
("header mismatch\n");

105 
	`cú_h—d”_de¡roy
(&
h—d”
);

106 
h—d”
 = 
	`cú_h—d”_·r£
(
c
->
buf
, c->
Ëngth
);

107 ià(
h—d”
 =ğ
NULL
) {

108 
	`´štf
("header„eparse failed\n");

109 
»s
 = 1;

112 
	`cú_h—d”_de¡roy
(&
h—d”
);

114 
i
 = 
	`cú_·r£_š‹»¡
(
buf
, 
size
, 
pi
, 
NULL
);

115 ià(
i
 >= 0) {

116 
»s
 = 0;

117 
	`´štf
("interest OK†ifetime %jd (%d seconds)\n",

118 
	`cú_š‹»¡_liãtime
(
buf
, 
pi
),

119 
	`cú_š‹»¡_liãtime_£cÚds
(
buf
, 
pi
));

122 ià(
»s
 != 0) {

123 
	`´štf
("URP\n");

125 
	`ex™
(
»s
);

126 
	}
}

	@lib/ccn_bloom.c

20 
	~<¡ddef.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<cú/bloom.h
>

25 
	scú_bloom
 {

26 
	mn
;

27 
cú_bloom_wœe
 *
	mwœe
;

37 
cú_bloom
 *

38 
	$cú_bloom_ü—‹
(
e¡im©ed_memb”s
, cÚ¡ 
£ed
[4])

40 
cú_bloom
 *
ªs
 = 
NULL
;

41 
cú_bloom_wœe
 *
f
;

42 
n
 = 
e¡im©ed_memb”s
;

43 
i
;

44 
ªs
 = 
	`ÿÎoc
(1, (*ans));

45 ià(
ªs
 =ğ
NULL
) (ans);

46 
f
 = 
	`ÿÎoc
(1, (*f));

47 ià(
f
 !ğ
NULL
) {

48 
f
->
m‘hod
 = 'A';

49 
f
->
lg_b™s
 = 13;

51 
f
->
lg_b™s
 > 3 && (1 << f->lg_b™sè> 
n
 * 12)

52 
f
->
lg_b™s
--;

54 
f
->
n_hash
 = (9 << f->
lg_b™s
è/ (13 * 
n
 + 1);

55 ià(
f
->
n_hash
 < 2)

56 
f
->
n_hash
 = 2;

57 ià(
f
->
n_hash
 > 32)

58 
f
->
n_hash
 = 32;

59 
i
 = 0; i < (
f
->
£ed
); i++)

60 
f
->
£ed
[
i
] = seed[i];

61 
ªs
->
wœe
 = 
f
;

64 
	`cú_bloom_de¡roy
(&
ªs
);

65 (
ªs
);

66 
	}
}

68 cÚ¡ 
cú_bloom_wœe
 *

69 
	$cú_bloom_v®id©e_wœe
(cÚ¡ *
buf
, 
size_t
 
size
)

71 cÚ¡ 
cú_bloom_wœe
 *
f
 = (cÚ¡ cú_bloom_wœ*)
buf
;

72 ià(
size
 < 9)

73  (
NULL
);

74 ià(
f
->
lg_b™s
 > 13 || f->lg_bits < 3)

75  (
NULL
);

76 ià(
f
->
n_hash
 < 1 || f->n_hash > 32)

77  (
NULL
);

78 ià(
size
 !ğ((*
f
è- (f->
bloom
)è+ (1 << (f->
lg_b™s
 - 3)))

79  (
NULL
);

80 ià(!(
f
->
»£rved
 =ğ0 && f->
m‘hod
 == 'A'))

81  (
NULL
);

82 (
f
);

83 
	}
}

85 
cú_bloom
 *

86 
	$cú_bloom_äom_wœe
(cÚ¡ *
d©a
, 
size_t
 
size
)

88 
cú_bloom
 *
ªs
 = 
NULL
;

89 cÚ¡ 
cú_bloom_wœe
 *
f
 = 
	`cú_bloom_v®id©e_wœe
(
d©a
, 
size
);

90 ià(
f
 !ğ
NULL
) {

91 
ªs
 = 
	`ÿÎoc
(1, (*ans));

92 ià(
ªs
 =ğ
NULL
) (ans);

93 
ªs
->
n
 = 1 << 
f
->
lg_b™s
;

94 
ªs
->
wœe
 = 
	`ÿÎoc
(1, 
size
);

95 ià(
ªs
->
wœe
 =ğ
NULL
)

96 
	`cú_bloom_de¡roy
(&
ªs
);

98 
	`memıy
(
ªs
->
wœe
, 
d©a
, 
size
);

100 (
ªs
);

101 
	}
}

104 
	$cú_bloom_de¡roy
(
cú_bloom
 **
bp
)

106 ià(*
bp
 !ğ
NULL
) {

107 ià((*
bp
)->
wœe
 !ğ
NULL
)

108 
	`ä“
((*
bp
)->
wœe
);

109 
	`ä“
(*
bp
);

110 *
bp
 = 
NULL
;

112 
	}
}

115 
	$bloom_£ed
(cÚ¡ 
cú_bloom_wœe
 *
f
)

117 
u
;

118 cÚ¡ *
s
 = 
f
->
£ed
;

119 
u
 = ((
s
[0]) << 24) |

120 ((
s
[1]) << 16) |

121 ((
s
[2]) << 8) |

122 (
s
[3]);

123 (
u
 & 0x7FFFFFFF);

124 
	}
}

127 
	$bloom_Ãxthash
(
s
, 
u
)

129 cÚ¡ 
k
 = 13;

130 
b
 = 
s
 & ((1 << 
k
) - 1);

132 
s
 = (( >> 
k
è^ (
b
 << (31 - k)è^ (b << (13 - k))è+ 
u
;

133 (
s
 & 0x7FFFFFFF);

134 
	}
}

142 
	$cú_bloom_š£¹
(
cú_bloom
 *
b
, cÚ¡ *
key
, 
size_t
 
size
)

145 
d
 = 0;

146 
cú_bloom_wœe
 *
f
 = 
b
->
wœe
;

147 
h
, 
i
, 
k
, 
m
, 
n
, 
s
;

148 cÚ¡ *
hb
 = (cÚ¡ *)
key
;

149 
n
 = 
f
->
n_hash
;

150 
m
 = (8*(
f
->
bloom
è- 1è& ((1 << f->
lg_b™s
) - 1);

151 
s
 = 
	`bloom_£ed
(
f
);

152 
k
 = 0; k < 
size
; k++)

153 
s
 = 
	`bloom_Ãxthash
(s, 
hb
[
k
] + 1);

154 
i
 = 0; i < 
n
; i++) {

155 
s
 = 
	`bloom_Ãxthash
(s, 0);

156 
h
 = 
s
 & 
m
;

157 ià(0 =ğ(
f
->
bloom
[
h
 >> 3] & (1 << (h & 7)))) {

158 
f
->
bloom
[
h
 >> 3] |= (1 << (h & 7));

159 
d
++;

161 
f
->
bloom
[
h
 >> 3] |= (1 << (h & 7));

163 
b
->
n
 += 1;

164 (
d
);

165 
	}
}

168 
	$cú_bloom_m©ch_wœe
(cÚ¡ 
cú_bloom_wœe
 *
f
, cÚ¡ *
key
, 
size_t
 
size
)

170 
h
, 
i
, 
k
, 
m
, 
n
, 
s
;

171 cÚ¡ *
hb
 = (cÚ¡ *)
key
;

172 
n
 = 
f
->
n_hash
;

173 
m
 = (8*(
f
->
bloom
è- 1è& ((1 << f->
lg_b™s
) - 1);

174 
s
 = 
	`bloom_£ed
(
f
);

175 
k
 = 0; k < 
size
; k++)

176 
s
 = 
	`bloom_Ãxthash
(s, 
hb
[
k
] + 1);

177 
i
 = 0; i < 
n
; i++) {

178 
s
 = 
	`bloom_Ãxthash
(s, 0);

179 ià(
k
 >ğ
size
)

180 
k
 = 0;

181 
h
 = 
s
 & 
m
;

182 ià(0 =ğ(
f
->
bloom
[
h
 >> 3] & (1 << (h & 7))))

186 
	}
}

189 
	$cú_bloom_m©ch
(
cú_bloom
 *
b
, cÚ¡ *
key
, 
size_t
 
size
)

191 (
	`cú_bloom_m©ch_wœe
(
b
->
wœe
, 
key
, 
size
));

192 
	}
}

195 
	$cú_bloom_n
(
cú_bloom
 *
b
)

197 (
b
->
n
);

198 
	}
}

201 
	$cú_bloom_wœesize
(
cú_bloom
 *
b
)

204 cÚ¡ 
cú_bloom_wœe
 *
f
 = (
b
->
wœe
);

205 ià(
f
 =ğ
NULL
)

207 (((*
f
è- (f->
bloom
)è+ (1 << (f->
lg_b™s
 - 3)));

208 
	}
}

211 
	$cú_bloom_¡Üe_wœe
(
cú_bloom
 *
b
, *
de¡
, 
size_t
 
de¡size
)

214 
wœesize
 = 
	`cú_bloom_wœesize
(
b
);

215 ià(
wœesize
 < 0 || 
de¡size
 != wiresize)

217 
	`memıy
(
de¡
, 
b
->
wœe
, 
de¡size
);

219 
	}
}

	@lib/ccn_buf_decoder.c

20 
	~<¡ršg.h
>

21 
	~<¡dlib.h
>

22 
	~<cú/cú.h
>

23 
	~<cú/ch¬buf.h
>

24 
	~<cú/codšg.h
>

25 
	~<cú/šdexbuf.h
>

27 
cú_buf_decod”
 *

28 
	$cú_buf_decod”_¡¬t
(
cú_buf_decod”
 *
d
,

29 cÚ¡ *
buf
, 
size_t
 
size
)

31 
	`mem£t
(&
d
->
decod”
, 0, (d->decoder));

32 
d
->
decod”
.
¡©e
 |ğ
CCN_DSTATE_PAUSE
;

33 
d
->
buf
 = buf;

34 
d
->
size
 = size;

35 
	`cú_sk–‘Ú_decode
(&
d
->
decod”
, 
buf
, 
size
);

36 (
d
);

37 
	}
}

40 
	$cú_buf_advªû
(
cú_buf_decod”
 *
d
)

42 
	`cú_sk–‘Ú_decode
(&
d
->
decod”
,

43 
d
->
buf
 + d->
decod”
.
šdex
,

44 
d
->
size
 - d->
decod”
.
šdex
);

45 
	}
}

48 
	$cú_buf_m©ch_dg
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
)

50  (
d
->
decod”
.
¡©e
 >= 0 &&

51 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_DTAG
 &&

52 
d
->
decod”
.
numv®
 =ğ
dg
);

53 
	}
}

56 
	$cú_buf_m©ch_some_dg
(
cú_buf_decod”
 *
d
)

58 (
d
->
decod”
.
¡©e
 >= 0 &&

59 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_DTAG
);

60 
	}
}

63 
	$cú_buf_m©ch_some_blob
(
cú_buf_decod”
 *
d
)

65 (
d
->
decod”
.
¡©e
 >= 0 &&

66 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_BLOB
);

67 
	}
}

70 
	$cú_buf_m©ch_blob
(
cú_buf_decod”
 *
d
,

71 cÚ¡ **
buå
, 
size_t
 *
siz•
)

73 ià(
	`cú_buf_m©ch_some_blob
(
d
)) {

74 ià(
buå
 !ğ
NULL
)

75 *
buå
 = 
d
->
buf
 + d->
decod”
.
šdex
;

76 ià(
siz•
 !ğ
NULL
)

77 *
siz•
 = 
d
->
decod”
.
numv®
;

80 ià(
buå
 !ğ
NULL
)

81 *
buå
 = 
d
->
buf
 + d->
decod”
.
tok’_šdex
;

82 ià(
siz•
 !ğ
NULL
)

83 *
siz•
 = 0;

85 
	}
}

88 
	$cú_buf_m©ch_ud©a
(
cú_buf_decod”
 *
d
, cÚ¡ *
s
)

90 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

91  (
d
->
decod”
.
¡©e
 >= 0 &&

92 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_UDATA
 &&

93 
d
->
decod”
.
numv®
 =ğ
Ën
 &&

94 0 =ğ
	`memcmp
(
d
->
buf
 + d->
decod”
.
šdex
, 
s
, 
Ën
));

95 
	}
}

98 
	$cú_buf_m©ch_©Œ
(
cú_buf_decod”
 *
d
, cÚ¡ *
s
)

100 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

101  (
d
->
decod”
.
¡©e
 >= 0 &&

102 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_ATTR
 &&

103 
d
->
decod”
.
numv®
 =ğ
Ën
 &&

104 0 =ğ
	`memcmp
(
d
->
buf
 + d->
decod”
.
šdex
, 
s
, 
Ën
));

105 
	}
}

108 
	$cú_buf_check_şo£
(
cú_buf_decod”
 *
d
)

110 ià(
d
->
decod”
.
¡©e
 >= 0) {

111 ià(
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è!ğ
CCN_NO_TOKEN
)

112 
d
->
decod”
.
¡©e
 = 
CCN_DSTATE_ERR_NEST
;

114 
	`cú_buf_advªû
(
d
);

116 
	}
}

119 
	$cú_buf_advªû_·¡_–em’t
(
cú_buf_decod”
 *
d
)

121 
cú_‰
 
‰
;

122 
Ã¡
;

123 ià(
d
->
decod”
.
¡©e
 < 0)

124 (
d
->
decod”
.
¡©e
);

125 
‰
 = 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
);

126 ià(
‰
 =ğ
CCN_DTAG
 ||ˆ=ğ
CCN_TAG
) {

127 
Ã¡
 = 
d
->
decod”
.nest;

128 
	`cú_buf_advªû
(
d
);

129 
d
->
decod”
.
¡©e
 >ğ0 && d->decod”.
Ã¡
 >=‚est)

130 
	`cú_buf_advªû
(
d
);

132 
	`cú_buf_check_şo£
(
d
);

136 ià(
d
->
decod”
.
¡©e
 < 0)

137 (
d
->
decod”
.
¡©e
);

139 
	}
}

142 
	$cú_·r£_»quœed_gged_BLOB
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
,

143 
mšËn
, 
maxËn
)

145 
»s
 = -1;

146 
size_t
 
Ën
 = 0;

147 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
)) {

148 
»s
 = 
d
->
decod”
.
–em’t_šdex
;

149 
	`cú_buf_advªû
(
d
);

150 ià(
	`cú_buf_m©ch_some_blob
(
d
)) {

151 
Ën
 = 
d
->
decod”
.
numv®
;

152 
	`cú_buf_advªû
(
d
);

154 
	`cú_buf_check_şo£
(
d
);

155 ià(
Ën
 < 
mšËn
 || (
maxËn
 >= 0 &&†en > maxlen)) {

156 
d
->
decod”
.
¡©e
 = -
__LINE__
;

160 
d
->
decod”
.
¡©e
 = -
__LINE__
;

161 ià(
d
->
decod”
.
¡©e
 < 0)

162  (
d
->
decod”
.
¡©e
);

163 (
»s
);

164 
	}
}

167 
	$cú_·r£_İtiÚ®_gged_BLOB
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
,

168 
mšËn
, 
maxËn
)

170 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
))

171 (
	`cú_·r£_»quœed_gged_BLOB
(
d
, 
dg
, 
mšËn
, 
maxËn
));

173 
	}
}

175 
uštmax_t


176 
	$cú_·r£_»quœed_gged_bš¬y_numb”
(
cú_buf_decod”
 *
d
,

177 
cú_dg
 
dg
,

178 
mšËn
, 
maxËn
)

180 
uštmax_t
 
v®ue
 = 0;

181 cÚ¡ *
p
 = 
NULL
;

182 
size_t
 
Ën
 = 0;

183 
i
;

184 ià(0 <ğ
mšËn
 && mšËÀ<ğ
maxËn
 && maxËÀ<ğ(
v®ue
) &&

185 
	`cú_buf_m©ch_dg
(
d
, 
dg
)) {

186 
	`cú_buf_advªû
(
d
);

187 ià(
	`cú_buf_m©ch_blob
(
d
, &
p
, &
Ën
))

188 
	`cú_buf_advªû
(
d
);

189 
	`cú_buf_check_şo£
(
d
);

190 ià(
d
->
decod”
.
¡©e
 < 0)

191 (
v®ue
);

192 ià(
mšËn
 <ğ
Ën
 &&†’ <ğ
maxËn
)

193 
i
 = 0; i < 
Ën
; i++)

194 
v®ue
 = (v®u<< 8è+ 
p
[
i
];

196 
d
->
decod”
.
¡©e
 = -
__LINE__
;

199 
d
->
decod”
.
¡©e
 = -
__LINE__
;

200 (
v®ue
);

201 
	}
}

203 
uštmax_t


204 
	$cú_·r£_İtiÚ®_gged_bš¬y_numb”
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
,

205 
mšËn
, 
maxËn
, 
uštmax_t
 
deçuÉ_v®ue
)

207 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
))

208 (
	`cú_·r£_»quœed_gged_bš¬y_numb”
(
d
, 
dg
, 
mšËn
, 
maxËn
));

209 (
deçuÉ_v®ue
);

210 
	}
}

213 
	$cú_·r£_»quœed_gged_UDATA
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
)

215 
»s
 = -1;

216 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
)) {

217 
»s
 = 
d
->
decod”
.
–em’t_šdex
;

218 
	`cú_buf_advªû
(
d
);

219 ià(
d
->
decod”
.
¡©e
 >= 0 &&

220 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_UDATA
)

221 
	`cú_buf_advªû
(
d
);

223 
d
->
decod”
.
¡©e
 = -
__LINE__
;

224 
	`cú_buf_check_şo£
(
d
);

227 
d
->
decod”
.
¡©e
 = -
__LINE__
;

228 ià(
d
->
decod”
.
¡©e
 < 0)

230 (
»s
);

231 
	}
}

234 
	$cú_·r£_İtiÚ®_gged_UDATA
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
)

236 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
))

237 (
	`cú_·r£_»quœed_gged_UDATA
(
d
, 
dg
));

239 
	}
}

253 
	$cú_·r£_gged_¡ršg
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
, 
cú_ch¬buf
 *
¡Üe
)

255 cÚ¡ *
p
 = 
NULL
;

256 
size_t
 
size
 = 0;

257 
»s
;

259 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
)) {

260 
	`cú_buf_advªû
(
d
);

261 ià(
d
->
decod”
.
¡©e
 >= 0 &&

262 
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_UDATA
) {

263 
»s
 = 
¡Üe
->
Ëngth
;

264 
p
 = 
d
->
buf
 + d->
decod”
.
šdex
;

265 
size
 = 
d
->
decod”
.
numv®
;

266 
	`cú_buf_advªû
(
d
);

268 
	`cú_buf_check_şo£
(
d
);

269 ià(
d
->
decod”
.
¡©e
 >= 0) {

271 
»s
 = 
¡Üe
->
Ëngth
;

272 ià(
size
 > 0)

273 
	`cú_ch¬buf_­³nd
(
¡Üe
, 
p
, 
size
);

274 
	`cú_ch¬buf_­³nd_v®ue
(
¡Üe
, 0, 1);

275 (
»s
);

279 
	}
}

289 
	$cú_·r£_Name
(
cú_buf_decod”
 *
d
, 
cú_šdexbuf
 *
compÚ’ts
)

291 
ncomp
 = 0;

292 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Name
)) {

293 ià(
compÚ’ts
 !ğ
NULL
ècompÚ’ts->
n
 = 0;

294 
	`cú_buf_advªû
(
d
);

295 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

296 ià(
compÚ’ts
 !ğ
NULL
)

297 
	`cú_šdexbuf_­³nd_–em’t
(
compÚ’ts
, 
d
->
decod”
.
tok’_šdex
);

298 
ncomp
 += 1;

299 
	`cú_buf_advªû
(
d
);

300 ià(
	`cú_buf_m©ch_blob
(
d
, 
NULL
, NULL))

301 
	`cú_buf_advªû
(
d
);

302 
	`cú_buf_check_şo£
(
d
);

304 ià(
compÚ’ts
 !ğ
NULL
)

305 
	`cú_šdexbuf_­³nd_–em’t
(
compÚ’ts
, 
d
->
decod”
.
tok’_šdex
);

306 
	`cú_buf_check_şo£
(
d
);

309 
d
->
decod”
.
¡©e
 = -
__LINE__
;

310 ià(
d
->
decod”
.
¡©e
 < 0)

313 (
ncomp
);

314 
	}
}

317 
	$cú_·r£_Publish”ID
(
cú_buf_decod”
 *
d
, 
cú_·r£d_š‹»¡
 *
pi
)

319 
»s
 = -1;

320 
iskey
 = 0;

321 
pub¡¬t
 = 
d
->
decod”
.
tok’_šdex
;

322 
key¡¬t
 = 
pub¡¬t
;

323 
key’d
 = 
pub¡¬t
;

324 
pub’d
 = 
pub¡¬t
;

325 
iskey
 = 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Publish”PublicKeyDige¡
);

326 ià(
iskey
 ||

327 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Publish”C”tifiÿ‹Dige¡
) ||

328 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Publish”Issu”KeyDige¡
) ||

329 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Publish”Issu”C”tifiÿ‹Dige¡
)) {

330 
»s
 = 
d
->
decod”
.
–em’t_šdex
;

331 
	`cú_buf_advªû
(
d
);

332 
key¡¬t
 = 
d
->
decod”
.
tok’_šdex
;

333 ià(!
	`cú_buf_m©ch_some_blob
(
d
))

334  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

335 
	`cú_buf_advªû
(
d
);

336 
key’d
 = 
d
->
decod”
.
tok’_šdex
;

337 
	`cú_buf_check_şo£
(
d
);

338 
pub’d
 = 
d
->
decod”
.
tok’_šdex
;

340 ià(
d
->
decod”
.
¡©e
 < 0)

341  (
d
->
decod”
.
¡©e
);

342 ià(
pi
 !ğ
NULL
) {

343 
pi
->
off£t
[
CCN_PI_B_Publish”ID
] = 
pub¡¬t
;

344 
pi
->
off£t
[
CCN_PI_B_Publish”IDKeyDige¡
] = 
key¡¬t
;

345 
pi
->
off£t
[
CCN_PI_E_Publish”IDKeyDige¡
] = 
iskey
 ? 
key’d
 : 
key¡¬t
;

346 
pi
->
off£t
[
CCN_PI_E_Publish”ID
] = 
pub’d
;

348 (
»s
);

349 
	}
}

352 
	$cú_·r£_İtiÚ®_Any_Ü_Bloom
(
cú_buf_decod”
 *
d
)

354 
»s
;

355 
»s
 = 
	`cú_·r£_İtiÚ®_gged_BLOB
(
d
, 
CCN_DTAG_Bloom
, 1, 1024+8);

356 ià(
»s
 >= 0)

357 (
»s
);

358 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Any
)) {

359 
	`cú_buf_advªû
(
d
);

360 
	`cú_buf_check_şo£
(
d
);

361 
»s
 = 0;

363 ià(
d
->
decod”
.
¡©e
 < 0)

364  (
d
->
decod”
.
¡©e
);

365 (
»s
);

366 
	}
}

369 
	$cú_·r£_Exşude
(
cú_buf_decod”
 *
d
)

371 
»s
 = -1;

372 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Exşude
)) {

373 
»s
 = 
d
->
decod”
.
–em’t_šdex
;

374 
	`cú_buf_advªû
(
d
);

375 
	`cú_·r£_İtiÚ®_Any_Ü_Bloom
(
d
);

376 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

377 
	`cú_·r£_»quœed_gged_BLOB
(
d
, 
CCN_DTAG_CompÚ’t
, 0, -1);

378 
	`cú_·r£_İtiÚ®_Any_Ü_Bloom
(
d
);

380 
	`cú_buf_check_şo£
(
d
);

382 ià(
d
->
decod”
.
¡©e
 < 0)

383  (
d
->
decod”
.
¡©e
);

384 (
»s
);

385 
	}
}

390 
	$cú_·r£_nÚNeg©iveIÁeg”
(
cú_buf_decod”
 *
d
)

392 cÚ¡ *
p
;

393 
i
;

394 
n
;

395 
v®
;

396 
Ãwv®
;

397 
c
;

398 ià(
d
->
decod”
.
¡©e
 < 0)

399 (
d
->
decod”
.
¡©e
);

400 ià(
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_UDATA
) {

401 
p
 = 
d
->
buf
 + d->
decod”
.
šdex
;

402 
n
 = 
d
->
decod”
.
numv®
;

403 ià(
n
 < 1)

404 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

405 
v®
 = 0;

406 
i
 = 0; i < 
n
; i++) {

407 
c
 = 
p
[
i
];

408 ià('0' <ğ
c
 && c <= '9') {

409 
Ãwv®
 = 
v®
 * 10 + (
c
 - '0');

410 ià(
Ãwv®
 < 
v®
)

411 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

412 
v®
 = 
Ãwv®
;

415 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

417 
	`cú_buf_advªû
(
d
);

418 (
v®
);

420 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

421 
	}
}

430 
	$cú_·r£_uštmax
(
cú_buf_decod”
 *
d
, 
uštmax_t
 *
»suÉ
)

432 cÚ¡ *
p
;

433 
i
;

434 
n
;

435 
uštmax_t
 
v®
;

436 
uštmax_t
 
Ãwv®
;

437 
c
;

438 ià(
d
->
decod”
.
¡©e
 < 0)

439 (
d
->
decod”
.
¡©e
);

440 ià(
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_UDATA
) {

441 
p
 = 
d
->
buf
 + d->
decod”
.
šdex
;

442 
n
 = 
d
->
decod”
.
numv®
;

443 ià(
n
 < 1)

444 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

445 
v®
 = 0;

446 
i
 = 0; i < 
n
; i++) {

447 
c
 = 
p
[
i
];

448 ià('0' <ğ
c
 && c <= '9') {

449 
Ãwv®
 = 
v®
 * 10 + (
c
 - '0');

450 ià(
Ãwv®
 < 
v®
)

451 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

452 
v®
 = 
Ãwv®
;

455 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

457 
	`cú_buf_advªû
(
d
);

458 *
»suÉ
 = 
v®
;

461 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

462 
	}
}

465 
	$cú_·r£_time¡amp
(
cú_buf_decod”
 *
d
)

467 cÚ¡ 
dlm
[] = "--T::.Z";

468 cÚ¡ *
p
;

469 
i
;

470 
k
;

471 
n
;

472 ià(
d
->
decod”
.
¡©e
 < 0)

473 (
d
->
decod”
.
¡©e
);

474 ià(
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_BLOB
) {

476 
n
 = 
d
->
decod”
.
numv®
;

477 ià(
n
 < 3 ||‚ > 7)

478 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

479 
	`cú_buf_advªû
(
d
);

482 ià(
	`CCN_GET_TT_FROM_DSTATE
(
d
->
decod”
.
¡©e
è=ğ
CCN_UDATA
) {

484 
p
 = 
d
->
buf
 + d->
decod”
.
šdex
;

485 
n
 = 
d
->
decod”
.
numv®
;

486 ià(
n
 < 8 ||‚ > 40)

487 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

488 ià(
p
[
n
 - 1] != 'Z')

489 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

490 
i
 = 0, 
k
 = 0; i < 
n
 && '0' <ğ
p
[i] &&…[i] <= '9';) {

491 
i
++;

492 ià(
i
 < 
n
 && 
p
[i] =ğ
dlm
[
k
]) {

493 ià(
dlm
[
k
++] == 0)

494 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

495 
i
++;

498 ià(
k
 < 5)

499 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

500 ià(!(
i
 =ğ
n
 || i ==‚ - 1))

501 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

502 
	`cú_buf_advªû
(
d
);

505 (
d
->
decod”
.
¡©e
 = -
__LINE__
);

506 
	}
}

509 
	$cú_·r£_»quœed_gged_time¡amp
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
)

511 
»s
 = -1;

512 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
)) {

513 
»s
 = 
d
->
decod”
.
–em’t_šdex
;

514 
	`cú_buf_advªû
(
d
);

515 
	`cú_·r£_time¡amp
(
d
);

516 
	`cú_buf_check_şo£
(
d
);

519 
d
->
decod”
.
¡©e
 = -
__LINE__
;

520 ià(
d
->
decod”
.
¡©e
 < 0)

522 (
»s
);

523 
	}
}

526 
	$cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
)

528 
»s
 = -1;

529 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
)) {

530 
	`cú_buf_advªû
(
d
);

531 
»s
 = 
	`cú_·r£_nÚNeg©iveIÁeg”
(
d
);

532 
	`cú_buf_check_şo£
(
d
);

534 ià(
d
->
decod”
.
¡©e
 < 0)

535  (
d
->
decod”
.
¡©e
);

536 (
»s
);

537 
	}
}

540 
	$cú_ãtch_gged_nÚNeg©iveIÁeg”
(
cú_dg
 
‰
,

541 cÚ¡ *
buf
,

542 
size_t
 
¡¬t
, size_ˆ
¡İ
)

544 
cú_buf_decod”
 
decod”
;

545 
cú_buf_decod”
 *
d
;

546 
»suÉ
 = -1;

547 ià(
¡İ
 < 
¡¬t
) (-1);

548 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
buf
 + 
¡¬t
, 
¡İ
 - start);

549 ià(
	`cú_buf_m©ch_dg
(
d
, 
‰
)) {

550 
	`cú_buf_advªû
(
d
);

551 
»suÉ
 = 
	`cú_·r£_nÚNeg©iveIÁeg”
(
d
);

552 
	`cú_buf_check_şo£
(
d
);

554 ià(
»suÉ
 < 0)

556 (
»suÉ
);

557 
	}
}

561 
	$cú_·r£_š‹»¡
(cÚ¡ *
msg
, 
size_t
 
size
,

562 
cú_·r£d_š‹»¡
 *
š‹»¡
,

563 
cú_šdexbuf
 *
compÚ’ts
)

565 
cú_buf_decod”
 
decod”
;

566 
cú_buf_decod”
 *
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
msg
, 
size
);

567 
magic
 = 0;

568 
ncomp
 = 0;

569 
»s
;

570 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_IÁ”e¡
)) {

571 ià(
compÚ’ts
 =ğ
NULL
) {

573 
compÚ’ts
 = 
	`cú_šdexbuf_ü—‹
();

574 ià(
compÚ’ts
 =ğ
NULL
) (-1);

575 
»s
 = 
	`cú_·r£_š‹»¡
(
msg
, 
size
, 
š‹»¡
, 
compÚ’ts
);

576 
	`cú_šdexbuf_de¡roy
(&
compÚ’ts
);

577 (
»s
);

579 
	`cú_buf_advªû
(
d
);

580 
š‹»¡
->
off£t
[
CCN_PI_B_Name
] = 
d
->
decod”
.
–em’t_šdex
;

581 
š‹»¡
->
off£t
[
CCN_PI_B_CompÚ’t0
] = 
d
->
decod”
.
šdex
;

582 
ncomp
 = 
	`cú_·r£_Name
(
d
, 
compÚ’ts
);

583 
š‹»¡
->
off£t
[
CCN_PI_E_CompÚ’tLa¡
] = 
d
->
decod”
.
tok’_šdex
 - 1;

584 
š‹»¡
->
off£t
[
CCN_PI_E_Name
] = 
d
->
decod”
.
tok’_šdex
;

585 
š‹»¡
->
´efix_comps
 = 
ncomp
;

586 
š‹»¡
->
off£t
[
CCN_PI_B_La¡P»fixCompÚ’t
] = 
compÚ’ts
->
buf
[(
ncomp
 > 0) ? (ncomp - 1) : 0];

587 
š‹»¡
->
off£t
[
CCN_PI_E_La¡P»fixCompÚ’t
] = 
compÚ’ts
->
buf
[
ncomp
];

589 
š‹»¡
->
mš_suffix_comps
 = 0;

590 
š‹»¡
->
max_suffix_comps
 = 32767;

591 
š‹»¡
->
off£t
[
CCN_PI_B_MšSuffixCompÚ’ts
] = 
d
->
decod”
.
tok’_šdex
;

592 
»s
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
,

593 
CCN_DTAG_MšSuffixCompÚ’ts
);

594 
š‹»¡
->
off£t
[
CCN_PI_E_MšSuffixCompÚ’ts
] = 
d
->
decod”
.
tok’_šdex
;

595 ià(
»s
 >= 0)

596 
š‹»¡
->
mš_suffix_comps
 = 
»s
;

597 
š‹»¡
->
off£t
[
CCN_PI_B_MaxSuffixCompÚ’ts
] = 
d
->
decod”
.
tok’_šdex
;

598 
»s
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
,

599 
CCN_DTAG_MaxSuffixCompÚ’ts
);

600 
š‹»¡
->
off£t
[
CCN_PI_E_MaxSuffixCompÚ’ts
] = 
d
->
decod”
.
tok’_šdex
;

601 ià(
»s
 >= 0)

602 
š‹»¡
->
max_suffix_comps
 = 
»s
;

603 ià(
š‹»¡
->
max_suffix_comps
 < iÁ”e¡->
mš_suffix_comps
)

604  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

606 
»s
 = 
	`cú_·r£_Publish”ID
(
d
, 
š‹»¡
);

608 
š‹»¡
->
off£t
[
CCN_PI_B_Exşude
] = 
d
->
decod”
.
tok’_šdex
;

609 
»s
 = 
	`cú_·r£_Exşude
(
d
);

610 
š‹»¡
->
off£t
[
CCN_PI_E_Exşude
] = 
d
->
decod”
.
tok’_šdex
;

612 
š‹»¡
->
off£t
[
CCN_PI_B_ChdS–eùÜ
] = 
d
->
decod”
.
tok’_šdex
;

613 
»s
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
,

614 
CCN_DTAG_ChdS–eùÜ
);

615 ià(
»s
 < 0)

616 
»s
 = 0;

617 
š‹»¡
->
Üd”´ef
 = 
»s
;

618 
š‹»¡
->
off£t
[
CCN_PI_E_ChdS–eùÜ
] = 
d
->
decod”
.
tok’_šdex
;

619 ià(
š‹»¡
->
Üd”´ef
 > 5)

620  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

622 
š‹»¡
->
off£t
[
CCN_PI_B_Answ”OrigšKšd
] = 
d
->
decod”
.
tok’_šdex
;

623 
š‹»¡
->
ªsw”äom
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
,

624 
CCN_DTAG_Answ”OrigšKšd
);

625 
š‹»¡
->
off£t
[
CCN_PI_E_Answ”OrigšKšd
] = 
d
->
decod”
.
tok’_šdex
;

626 ià(
š‹»¡
->
ªsw”äom
 == -1)

627 
š‹»¡
->
ªsw”äom
 = 
CCN_AOK_DEFAULT
;

628 ià((
š‹»¡
->
ªsw”äom
 & 
CCN_AOK_NEW
) != 0 &&

629 (
š‹»¡
->
ªsw”äom
 & 
CCN_AOK_CS
) == 0)

630  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

632 
š‹»¡
->
off£t
[
CCN_PI_B_Scİe
] = 
d
->
decod”
.
tok’_šdex
;

633 
š‹»¡
->
scİe
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
,

634 
CCN_DTAG_Scİe
);

635 
š‹»¡
->
off£t
[
CCN_PI_E_Scİe
] = 
d
->
decod”
.
tok’_šdex
;

636 ià(
š‹»¡
->
scİe
 > 9)

637  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

638 ià((
š‹»¡
->
ªsw”äom
 & 
CCN_AOK_EXPIRE
) != 0 &&

639 
š‹»¡
->
scİe
 != 0)

640  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

642 
š‹»¡
->
off£t
[
CCN_PI_B_IÁ”e¡Liãtime
] = 
d
->
decod”
.
tok’_šdex
;

643 
»s
 = 
	`cú_·r£_İtiÚ®_gged_BLOB
(
d
, 
CCN_DTAG_IÁ”e¡Liãtime
, 1, 8);

644 ià(
»s
 >= 0)

645 
magic
 |= 20100401;

646 
š‹»¡
->
off£t
[
CCN_PI_E_IÁ”e¡Liãtime
] = 
d
->
decod”
.
tok’_šdex
;

648 
š‹»¡
->
off£t
[
CCN_PI_B_NÚû
] = 
d
->
decod”
.
tok’_šdex
;

649 
»s
 = 
	`cú_·r£_İtiÚ®_gged_BLOB
(
d
, 
CCN_DTAG_NÚû
, 4, 64);

650 
š‹»¡
->
off£t
[
CCN_PI_E_NÚû
] = 
d
->
decod”
.
tok’_šdex
;

652 
š‹»¡
->
off£t
[
CCN_PI_B_OTHER
] = 
d
->
decod”
.
tok’_šdex
;

653 
š‹»¡
->
off£t
[
CCN_PI_E_OTHER
] = 
d
->
decod”
.
tok’_šdex
;

654 
	`cú_buf_check_şo£
(
d
);

655 
š‹»¡
->
off£t
[
CCN_PI_E
] = 
d
->
decod”
.
šdex
;

658  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

659 ià(
d
->
decod”
.
¡©e
 < 0)

660  (
d
->
decod”
.
¡©e
);

661 ià(
d
->
decod”
.
šdex
 !ğ
size
 || !
	`CCN_FINAL_DSTATE
(d->decod”.
¡©e
))

662  (
CCN_DSTATE_ERR_CODING
);

663 ià(
magic
 == 0)

664 
magic
 = 20090701;

665 ià(!(
magic
 == 20090701 || magic == 20100401))

666  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

667 
š‹»¡
->
magic
 = magic;

668  (
ncomp
);

669 
	}
}

671 
	s·r£d_KeyName
 {

672 
	mName
;

673 
	m’dName
;

674 
	mPublish”ID
;

675 
	m’dPublish”ID
;

679 
	$cú_·r£_KeyName
(
cú_buf_decod”
 *
d
, 
·r£d_KeyName
 *
x
)

681 
»s
 = -1;

682 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_KeyName
)) {

683 
»s
 = 
d
->
decod”
.
–em’t_šdex
;

684 
	`cú_buf_advªû
(
d
);

685 
x
->
Name
 = 
d
->
decod”
.
tok’_šdex
;

686 
	`cú_·r£_Name
(
d
, 
NULL
);

687 
x
->
’dName
 = 
d
->
decod”
.
tok’_šdex
;

688 
x
->
Publish”ID
 = 
	`cú_·r£_Publish”ID
(
d
, 
NULL
);

689 
x
->
’dPublish”ID
 = 
d
->
decod”
.
tok’_šdex
;

690 
	`cú_buf_check_şo£
(
d
);

693 
d
->
decod”
.
¡©e
 = -
__LINE__
;

694 ià(
d
->
decod”
.
¡©e
 < 0)

695  (
d
->
decod”
.
¡©e
);

696 (
»s
);

697 
	}
}

700 
	$cú_·r£_SigÇtu»
(
cú_buf_decod”
 *
d
, 
cú_·r£d_CÚ‹ÁObjeù
 *
x
)

702 
»s
 = -1;

703 
i
;

704 
cú_·r£d_CÚ‹ÁObjeù
 
dummy
;

705 ià(
x
 =ğ
NULL
)

706 
x
 = &
dummy
;

707 
i
 = 
CCN_PCO_B_SigÇtu»
; i <ğ
CCN_PCO_E_SigÇtu»
; i++) {

708 
x
->
off£t
[
i
] = 
d
->
decod”
.
tok’_šdex
;

710 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_SigÇtu»
)) {

711 
»s
 = 
d
->
decod”
.
–em’t_šdex
;

712 
	`cú_buf_advªû
(
d
);

713 
x
->
off£t
[
CCN_PCO_B_Dige¡AlgÜ™hm
] = 
d
->
decod”
.
tok’_šdex
;

714 
	`cú_·r£_İtiÚ®_gged_UDATA
(
d
, 
CCN_DTAG_Dige¡AlgÜ™hm
);

715 
x
->
off£t
[
CCN_PCO_E_Dige¡AlgÜ™hm
] = 
d
->
decod”
.
tok’_šdex
;

716 
x
->
off£t
[
CCN_PCO_B_W™Ãss
] = 
d
->
decod”
.
tok’_šdex
;

717 
	`cú_·r£_İtiÚ®_gged_BLOB
(
d
, 
CCN_DTAG_W™Ãss
, 8, -1);

718 
x
->
off£t
[
CCN_PCO_E_W™Ãss
] = 
d
->
decod”
.
tok’_šdex
;

719 
x
->
off£t
[
CCN_PCO_B_SigÇtu»B™s
] = 
d
->
decod”
.
tok’_šdex
;

720 
	`cú_·r£_»quœed_gged_BLOB
(
d
, 
CCN_DTAG_SigÇtu»B™s
, 16, -1);

721 
x
->
off£t
[
CCN_PCO_E_SigÇtu»B™s
] = 
d
->
decod”
.
tok’_šdex
;

722 
	`cú_buf_check_şo£
(
d
);

723 
x
->
off£t
[
CCN_PCO_E_SigÇtu»
] = 
d
->
decod”
.
tok’_šdex
;

725 ià(
d
->
decod”
.
¡©e
 < 0)

726  (
d
->
decod”
.
¡©e
);

727 (
»s
);

728 
	}
}

731 
	$cú_·r£_SigÃdInfo
(
cú_buf_decod”
 *
d
, 
cú_·r£d_CÚ‹ÁObjeù
 *
x
)

733 
x
->
off£t
[
CCN_PCO_B_SigÃdInfo
] = 
d
->
decod”
.
tok’_šdex
;

734 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_SigÃdInfo
)) {

735 
	`cú_buf_advªû
(
d
);

736 
x
->
off£t
[
CCN_PCO_B_Publish”PublicKeyDige¡
] = 
d
->
decod”
.
tok’_šdex
;

737 
	`cú_·r£_»quœed_gged_BLOB
(
d
, 
CCN_DTAG_Publish”PublicKeyDige¡
, 16, 64);

738 
x
->
off£t
[
CCN_PCO_E_Publish”PublicKeyDige¡
] = 
d
->
decod”
.
tok’_šdex
;

740 
x
->
off£t
[
CCN_PCO_B_Time¡amp
] = 
d
->
decod”
.
tok’_šdex
;

741 
	`cú_·r£_»quœed_gged_time¡amp
(
d
, 
CCN_DTAG_Time¡amp
);

742 
x
->
off£t
[
CCN_PCO_E_Time¡amp
] = 
d
->
decod”
.
tok’_šdex
;

744 
x
->
off£t
[
CCN_PCO_B_Ty³
] = 
d
->
decod”
.
tok’_šdex
;

745 
x
->
ty³
 = 
CCN_CONTENT_DATA
;

746 
x
->
ty³
 = 
	`cú_·r£_İtiÚ®_gged_bš¬y_numb”
(
d
, 
CCN_DTAG_Ty³
, 3, 3, 
CCN_CONTENT_DATA
);

747 
x
->
off£t
[
CCN_PCO_E_Ty³
] = 
d
->
decod”
.
tok’_šdex
;

749 
x
->
off£t
[
CCN_PCO_B_F»shÃssSecÚds
] = 
d
->
decod”
.
tok’_šdex
;

750 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
, 
CCN_DTAG_F»shÃssSecÚds
);

751 
x
->
off£t
[
CCN_PCO_E_F»shÃssSecÚds
] = 
d
->
decod”
.
tok’_šdex
;

753 
x
->
off£t
[
CCN_PCO_B_Fš®BlockID
] = 
d
->
decod”
.
tok’_šdex
;

754 
	`cú_·r£_İtiÚ®_gged_BLOB
(
d
, 
CCN_DTAG_Fš®BlockID
, 1, -1);

755 
x
->
off£t
[
CCN_PCO_E_Fš®BlockID
] = 
d
->
decod”
.
tok’_šdex
;

757 
x
->
off£t
[
CCN_PCO_B_KeyLoÿtÜ
] = 
d
->
decod”
.
tok’_šdex
;

758 
x
->
off£t
[
CCN_PCO_B_Key_C”tifiÿ‹_KeyName
] = 
d
->
decod”
.
tok’_šdex
;

759 
x
->
off£t
[
CCN_PCO_E_Key_C”tifiÿ‹_KeyName
] = 
d
->
decod”
.
tok’_šdex
;

760 
x
->
off£t
[
CCN_PCO_B_KeyName_Name
] = 
d
->
decod”
.
tok’_šdex
;

761 
x
->
off£t
[
CCN_PCO_E_KeyName_Name
] = 
d
->
decod”
.
tok’_šdex
;

762 
x
->
off£t
[
CCN_PCO_B_KeyName_Pub
] = 
d
->
decod”
.
tok’_šdex
;

763 
x
->
off£t
[
CCN_PCO_E_KeyName_Pub
] = 
d
->
decod”
.
tok’_šdex
;

764 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_KeyLoÿtÜ
)) {

765 
	`cú_buf_advªû
(
d
);

766 
x
->
off£t
[
CCN_PCO_B_Key_C”tifiÿ‹_KeyName
] = 
d
->
decod”
.
tok’_šdex
;

767 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Key
)) {

768 ()
	`cú_·r£_»quœed_gged_BLOB
(
d
, 
CCN_DTAG_Key
, 0, -1);

770 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_C”tifiÿ‹
)) {

771 ()
	`cú_·r£_»quœed_gged_BLOB
(
d
, 
CCN_DTAG_C”tifiÿ‹
, 0, -1);

774 
·r£d_KeyName
 
keyÇme
 = {-1, -1, -1, -1};

775 ià(
	`cú_·r£_KeyName
(
d
, &
keyÇme
) >= 0) {

776 ià(
keyÇme
.
Name
 >= 0) {

777 
x
->
off£t
[
CCN_PCO_B_KeyName_Name
] = 
keyÇme
.
Name
;

778 
x
->
off£t
[
CCN_PCO_E_KeyName_Name
] = 
keyÇme
.
’dName
;

780 ià(
keyÇme
.
Publish”ID
 >= 0) {

781 
x
->
off£t
[
CCN_PCO_B_KeyName_Pub
] = 
keyÇme
.
Publish”ID
;

782 
x
->
off£t
[
CCN_PCO_E_KeyName_Pub
] = 
keyÇme
.
’dPublish”ID
;

786 
x
->
off£t
[
CCN_PCO_E_Key_C”tifiÿ‹_KeyName
] = 
d
->
decod”
.
tok’_šdex
;

787 
	`cú_buf_check_şo£
(
d
);

789 
x
->
off£t
[
CCN_PCO_E_KeyLoÿtÜ
] = 
d
->
decod”
.
tok’_šdex
;

790 
	`cú_buf_check_şo£
(
d
);

793 
d
->
decod”
.
¡©e
 = -
__LINE__
;

794 
x
->
off£t
[
CCN_PCO_E_SigÃdInfo
] = 
d
->
decod”
.
tok’_šdex
;

795 ià(
d
->
decod”
.
¡©e
 < 0)

796  (
d
->
decod”
.
¡©e
);

798 
	}
}

801 
	$cú_·r£_CÚ‹ÁObjeù
(cÚ¡ *
msg
, 
size_t
 
size
,

802 
cú_·r£d_CÚ‹ÁObjeù
 *
x
,

803 
cú_šdexbuf
 *
compÚ’ts
)

805 
cú_buf_decod”
 
decod”
;

806 
cú_buf_decod”
 *
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
msg
, 
size
);

807 
»s
;

808 
x
->
magic
 = 20090415;

809 
x
->
dige¡_by‹s
 = 0;

810 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CÚ‹ÁObjeù
)) {

811 
	`cú_buf_advªû
(
d
);

812 
»s
 = 
	`cú_·r£_SigÇtu»
(
d
, 
x
);

813 
x
->
off£t
[
CCN_PCO_B_Name
] = 
d
->
decod”
.
tok’_šdex
;

814 
x
->
off£t
[
CCN_PCO_B_CompÚ’t0
] = 
d
->
decod”
.
šdex
;

815 
»s
 = 
	`cú_·r£_Name
(
d
, 
compÚ’ts
);

816 ià(
»s
 < 0)

817 
d
->
decod”
.
¡©e
 = -
__LINE__
;

818 
x
->
Çme_ncomps
 = 
»s
;

819 
x
->
off£t
[
CCN_PCO_E_CompÚ’tLa¡
] = 
d
->
decod”
.
tok’_šdex
 - 1;

820 
x
->
off£t
[
CCN_PCO_E_Name
] = 
d
->
decod”
.
tok’_šdex
;

821 
	`cú_·r£_SigÃdInfo
(
d
, 
x
);

822 
x
->
off£t
[
CCN_PCO_B_CÚ‹Á
] = 
d
->
decod”
.
tok’_šdex
;

823 
	`cú_·r£_»quœed_gged_BLOB
(
d
, 
CCN_DTAG_CÚ‹Á
, 0, -1);

824 
x
->
off£t
[
CCN_PCO_E_CÚ‹Á
] = 
d
->
decod”
.
tok’_šdex
;

825 
	`cú_buf_check_şo£
(
d
);

826 
x
->
off£t
[
CCN_PCO_E
] = 
d
->
decod”
.
šdex
;

829 
d
->
decod”
.
¡©e
 = -
__LINE__
;

830 ià(
d
->
decod”
.
šdex
 !ğ
size
 || !
	`CCN_FINAL_DSTATE
(d->decod”.
¡©e
))

831  (
CCN_DSTATE_ERR_CODING
);

833 
	}
}

836 
	$cú_»f_gged_BLOB
(
cú_dg
 
‰
,

837 cÚ¡ *
buf
, 
size_t
 
¡¬t
, size_ˆ
¡İ
,

838 cÚ¡ **
´esuÉ
, 
size_t
 *
psize
)

840 
cú_buf_decod”
 
decod”
;

841 
cú_buf_decod”
 *
d
;

842 ià(
¡İ
 < 
¡¬t
) (-1);

843 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
buf
 + 
¡¬t
, 
¡İ
 - start);

844 ià(
	`cú_buf_m©ch_dg
(
d
, 
‰
)) {

845 
	`cú_buf_advªû
(
d
);

846 ià(
	`cú_buf_m©ch_blob
(
d
, 
´esuÉ
, 
psize
))

847 
	`cú_buf_advªû
(
d
);

848 
	`cú_buf_check_şo£
(
d
);

852 ià(
d
->
decod”
.
šdex
 !ğd->
size
 || !
	`CCN_FINAL_DSTATE
(d->decod”.
¡©e
))

853  (
CCN_DSTATE_ERR_CODING
);

855 
	}
}

857 
cú_buf_decod”
 *

858 
	$cú_buf_decod”_¡¬t_©_compÚ’ts
(
cú_buf_decod”
 *
d
,

859 cÚ¡ *
buf
, 
size_t
 
buæ’
)

861 
	`cú_buf_decod”_¡¬t
(
d
, 
buf
, 
buæ’
);

862 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Name
) ||

863 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_IÁ”e¡
) ||

864 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CÚ‹ÁObjeù
)

866 
	`cú_buf_advªû
(
d
);

867 
	`cú_·r£_SigÇtu»
(
d
, 
NULL
);

869 (
d
);

870 
	}
}

873 
	$cú_cÚ‹Á_g‘_v®ue
(cÚ¡ *
d©a
, 
size_t
 
d©a_size
,

874 cÚ¡ 
cú_·r£d_CÚ‹ÁObjeù
 *
cÚ‹Á
,

875 cÚ¡ **
v®ue
, 
size_t
 *
v®ue_size
)

877 
»s
;

878 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_CÚ‹Á
, 
d©a
,

879 
cÚ‹Á
->
off£t
[
CCN_PCO_B_CÚ‹Á
],

880 
cÚ‹Á
->
off£t
[
CCN_PCO_E_CÚ‹Á
],

881 
v®ue
, 
v®ue_size
);

882 (
»s
);

883 
	}
}

886 
	$cú_com·»_Çmes
(cÚ¡ *
a
, 
size_t
 
asize
,

887 cÚ¡ *
b
, 
size_t
 
bsize
)

889 
cú_buf_decod”
 
a_decod”
;

890 
cú_buf_decod”
 
b_decod”
;

891 
cú_buf_decod”
 *
¯
 =

892 
	`cú_buf_decod”_¡¬t_©_compÚ’ts
(&
a_decod”
, 
a
, 
asize
);

893 
cú_buf_decod”
 *
bb
 =

894 
	`cú_buf_decod”_¡¬t_©_compÚ’ts
(&
b_decod”
, 
b
, 
bsize
);

895 cÚ¡ *
aı
 = 
NULL
;

896 cÚ¡ *
bı
 = 
NULL
;

897 
size_t
 
acsize
;

898 
size_t
 
bcsize
;

899 
cmp
 = 0;

900 
mÜe_a
;

902 
mÜe_a
 = 
	`cú_buf_m©ch_dg
(
¯
, 
CCN_DTAG_CompÚ’t
);

903 
cmp
 = 
mÜe_a
 - 
	`cú_buf_m©ch_dg
(
bb
, 
CCN_DTAG_CompÚ’t
);

904 ià(
mÜe_a
 =ğ0 || 
cmp
 != 0)

906 
	`cú_buf_advªû
(
¯
);

907 
	`cú_buf_advªû
(
bb
);

908 
acsize
 = 
bcsize
 = 0;

909 ià(
	`cú_buf_m©ch_blob
(
¯
, &
aı
, &
acsize
))

910 
	`cú_buf_advªû
(
¯
);

911 ià(
	`cú_buf_m©ch_blob
(
bb
, &
bı
, &
bcsize
))

912 
	`cú_buf_advªû
(
bb
);

913 
cmp
 = 
acsize
 - 
bcsize
;

914 ià(
cmp
 != 0)

916 
cmp
 = 
	`memcmp
(
aı
, 
bı
, 
acsize
);

917 ià(
cmp
 != 0)

919 
	`cú_buf_check_şo£
(
¯
);

920 
	`cú_buf_check_şo£
(
bb
);

922  (
cmp
);

923 
	}
}

	@lib/ccn_buf_encoder.c

20 
	~<¡ršg.h
>

21 
	~<¡d¬g.h
>

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<sys/time.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/ch¬buf.h
>

27 
	~<cú/codšg.h
>

28 
	~<cú/šdexbuf.h
>

29 
	~<cú/signšg.h
>

30 
	~<cú/cú_´iv©e.h
>

48 
	$cú_sigÃd_šfo_ü—‹
(
cú_ch¬buf
 *
c
,

49 cÚ¡ *
publish”_key_id
,

50 
size_t
 
publish”_key_id_size
,

51 cÚ¡ 
cú_ch¬buf
 *
time¡amp
,

52 
cú_cÚ‹Á_ty³
 
ty³
,

53 
äeshÃss
,

54 cÚ¡ 
cú_ch¬buf
 *
fš®blockid
,

55 cÚ¡ 
cú_ch¬buf
 *
key_loÿtÜ
)

57 
»s
 = 0;

58 cÚ¡ 
çk•ubkeyid
[32] = {0};

60 ià(
publish”_key_id
 !ğ
NULL
 && 
publish”_key_id_size
 != 32)

63 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_SigÃdInfo
, 
CCN_DTAG
);

65 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Publish”PublicKeyDige¡
, 
CCN_DTAG
);

66 ià(
publish”_key_id
 !ğ
NULL
) {

67 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 
publish”_key_id_size
, 
CCN_BLOB
);

68 
»s
 |ğ
	`cú_ch¬buf_­³nd
(
c
, 
publish”_key_id
, 
publish”_key_id_size
);

71 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, (
çk•ubkeyid
), 
CCN_BLOB
);

72 
»s
 |ğ
	`cú_ch¬buf_­³nd
(
c
, 
çk•ubkeyid
, (fakepubkeyid));

74 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
c
);

76 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Time¡amp
, 
CCN_DTAG
);

77 ià(
time¡amp
 !ğ
NULL
)

78 
»s
 |ğ
	`cú_ch¬buf_­³nd_ch¬buf
(
c
, 
time¡amp
);

80 
»s
 |ğ
	`cúb_­³nd_now_blob
(
c
, 
CCN_MARKER_NONE
);

81 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
c
);

83 ià(
ty³
 !ğ
CCN_CONTENT_DATA
) {

84 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Ty³
, 
CCN_DTAG
);

85 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 3, 
CCN_BLOB
);

86 
»s
 |ğ
	`cú_ch¬buf_­³nd_v®ue
(
c
, 
ty³
, 3);

87 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
c
);

90 ià(
äeshÃss
 >= 0)

91 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_F»shÃssSecÚds
, "%d", 
äeshÃss
);

93 ià(
fš®blockid
 !ğ
NULL
) {

94 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Fš®BlockID
, 
CCN_DTAG
);

95 
»s
 |ğ
	`cú_ch¬buf_­³nd_ch¬buf
(
c
, 
fš®blockid
);

96 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
c
);

99 ià(
key_loÿtÜ
 !ğ
NULL
) {

101 
»s
 |ğ
	`cú_ch¬buf_­³nd_ch¬buf
(
c
, 
key_loÿtÜ
);

104 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
c
);

106 (
»s
 == 0 ? 0 : -1);

107 
	}
}

110 
	$cú_’code_SigÇtu»
(
cú_ch¬buf
 *
buf
,

111 cÚ¡ *
dige¡_®gÜ™hm
,

112 cÚ¡ *
w™Ãss
,

113 
size_t
 
w™Ãss_size
,

114 cÚ¡ 
cú_sigÇtu»
 *
sigÇtu»
,

115 
size_t
 
sigÇtu»_size
)

117 
»s
 = 0;

119 ià(
sigÇtu»
 =ğ
NULL
)

122 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
buf
, 
CCN_DTAG_SigÇtu»
, 
CCN_DTAG
);

124 ià(
dige¡_®gÜ™hm
 !ğ
NULL
) {

125 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
buf
, 
CCN_DTAG_Dige¡AlgÜ™hm
, 
CCN_DTAG
);

126 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
buf
, 
	`¡¾’
(
dige¡_®gÜ™hm
), 
CCN_UDATA
);

127 
»s
 |ğ
	`cú_ch¬buf_­³nd_¡ršg
(
buf
, 
dige¡_®gÜ™hm
);

128 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
buf
);

131 ià(
w™Ãss
 !ğ
NULL
) {

132 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
buf
, 
CCN_DTAG_W™Ãss
, 
CCN_DTAG
);

133 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
buf
, 
w™Ãss_size
, 
CCN_BLOB
);

134 
»s
 |ğ
	`cú_ch¬buf_­³nd
(
buf
, 
w™Ãss
, 
w™Ãss_size
);

135 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
buf
);

138 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
buf
, 
CCN_DTAG_SigÇtu»B™s
, 
CCN_DTAG
);

139 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
buf
, 
sigÇtu»_size
, 
CCN_BLOB
);

140 
»s
 |ğ
	`cú_ch¬buf_­³nd
(
buf
, 
sigÇtu»
, 
sigÇtu»_size
);

141 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
buf
);

143 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
buf
);

145 (
»s
 == 0 ? 0 : -1);

146 
	}
}

160 
	$cú_’code_CÚ‹ÁObjeù
(
cú_ch¬buf
 *
buf
,

161 cÚ¡ 
cú_ch¬buf
 *
Name
,

162 cÚ¡ 
cú_ch¬buf
 *
SigÃdInfo
,

163 cÚ¡ *
d©a
,

164 
size_t
 
size
,

165 cÚ¡ *
dige¡_®gÜ™hm
,

166 cÚ¡ 
cú_pkey
 *
´iv©e_key


169 
»s
 = 0;

170 
cú_sigc
 *
sig_ùx
;

171 
cú_sigÇtu»
 *
sigÇtu»
;

172 
size_t
 
sigÇtu»_size
;

173 
cú_ch¬buf
 *
cÚ‹Á_h—d”
;

174 
size_t
 
şo£r_¡¬t
;

176 
cÚ‹Á_h—d”
 = 
	`cú_ch¬buf_ü—‹
();

177 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
cÚ‹Á_h—d”
, 
CCN_DTAG_CÚ‹Á
, 
CCN_DTAG
);

178 ià(
size
 != 0)

179 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
cÚ‹Á_h—d”
, 
size
, 
CCN_BLOB
);

180 
şo£r_¡¬t
 = 
cÚ‹Á_h—d”
->
Ëngth
;

181 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
cÚ‹Á_h—d”
);

182 ià(
»s
 < 0)

184 
sig_ùx
 = 
	`cú_sigc_ü—‹
();

185 ià(
sig_ùx
 =ğ
NULL
)

187 ià(0 !ğ
	`cú_sigc_š™
(
sig_ùx
, 
dige¡_®gÜ™hm
))

189 ià(0 !ğ
	`cú_sigc_upd©e
(
sig_ùx
, 
Name
->
buf
, Name->
Ëngth
))

191 ià(0 !ğ
	`cú_sigc_upd©e
(
sig_ùx
, 
SigÃdInfo
->
buf
, SigÃdInfo->
Ëngth
))

193 ià(0 !ğ
	`cú_sigc_upd©e
(
sig_ùx
, 
cÚ‹Á_h—d”
->
buf
, 
şo£r_¡¬t
))

195 ià(0 !ğ
	`cú_sigc_upd©e
(
sig_ùx
, 
d©a
, 
size
))

197 ià(0 !ğ
	`cú_sigc_upd©e
(
sig_ùx
, 
cÚ‹Á_h—d”
->
buf
 + 
şo£r_¡¬t
,

198 
cÚ‹Á_h—d”
->
Ëngth
 - 
şo£r_¡¬t
))

200 
sigÇtu»
 = 
	`ÿÎoc
(1, 
	`cú_sigc_sigÇtu»_max_size
(
sig_ùx
, 
´iv©e_key
));

201 ià(
sigÇtu»
 =ğ
NULL
)

203 
»s
 = 
	`cú_sigc_fš®
(
sig_ùx
, 
sigÇtu»
, &
sigÇtu»_size
, 
´iv©e_key
);

204 ià(0 !ğ
»s
) {

205 
	`ä“
(
sigÇtu»
);

208 
	`cú_sigc_de¡roy
(&
sig_ùx
);

209 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
buf
, 
CCN_DTAG_CÚ‹ÁObjeù
, 
CCN_DTAG
);

210 
»s
 |ğ
	`cú_’code_SigÇtu»
(
buf
, 
dige¡_®gÜ™hm
,

211 
NULL
, 0, 
sigÇtu»
, 
sigÇtu»_size
);

212 
»s
 |ğ
	`cú_ch¬buf_­³nd_ch¬buf
(
buf
, 
Name
);

213 
»s
 |ğ
	`cú_ch¬buf_­³nd_ch¬buf
(
buf
, 
SigÃdInfo
);

214 
»s
 |ğ
	`cúb_­³nd_gged_blob
(
buf
, 
CCN_DTAG_CÚ‹Á
, 
d©a
, 
size
);

215 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
buf
);

216 
	`ä“
(
sigÇtu»
);

217 
	`cú_ch¬buf_de¡roy
(&
cÚ‹Á_h—d”
);

218 (
»s
 == 0 ? 0 : -1);

219 
	}
}

231 
	$cú_ch¬buf_­³nd_‰
(
cú_ch¬buf
 *
c
, 
size_t
 
v®
, 
cú_‰
 
‰
)

233 
buf
[1+8*(((
v®
)+6)/7)];

234 *
p
 = &(
buf
[(buf)-1]);

235 
n
 = 1;

236 
p
[0] = (
CCN_TT_HBIT
 & ~
CCN_CLOSE
) |

237 ((
v®
 & 
CCN_MAX_TINY
è<< 
CCN_TT_BITS
) |

238 (
CCN_TT_MASK
 & 
‰
);

239 
v®
 >>ğ(7-
CCN_TT_BITS
);

240 
v®
 != 0) {

241 (--
p
)[0] = ((()
v®
è& ~
CCN_TT_HBIT
è| 
CCN_CLOSE
;

242 
n
++;

243 
v®
 >>= 7;

245 (
	`cú_ch¬buf_­³nd
(
c
, 
p
, 
n
));

246 
	}
}

249 
	$cú_ch¬buf_­³nd_şo£r
(
cú_ch¬buf
 *
c
)

251 
»s
;

252 cÚ¡ 
şo£r
 = 
CCN_CLOSE
;

253 
»s
 = 
	`cú_ch¬buf_­³nd
(
c
, &
şo£r
, 1);

254 (
»s
);

255 
	}
}

264 
	$cúb_­³nd_numb”
(
cú_ch¬buf
 *
c
, 
Âi
)

266 
Âi¡ršg
[40];

267 
Âi¡ršgËn
;

268 
»s
;

270 ià(
Âi
 < 0)

272 
Âi¡ršgËn
 = 
	`¢´štf
(
Âi¡ršg
, Òni¡ršg), "%d", 
Âi
);

273 ià(
Âi¡ršgËn
 >ğ(
Âi¡ršg
))

275 
»s
 = 
	`cú_ch¬buf_­³nd_‰
(
c
, 
Âi¡ršgËn
, 
CCN_UDATA
);

276 
»s
 |ğ
	`cú_ch¬buf_­³nd_¡ršg
(
c
, 
Âi¡ršg
);

277 (
»s
);

278 
	}
}

292 
	$cúb_­³nd_time¡amp_blob
(
cú_ch¬buf
 *
c
,

293 
cú_m¬k”
 
m¬k”
,

294 
štmax_t
 
£cs
, 
n£cs
)

296 
i
;

297 
n
;

298 
štmax_t
 
ts
;

299 *
p
;

300 ià(
£cs
 <ğ0 || 
n£cs
 < 0 ||‚secs > 999999999)

302 
n
 = 2;

303 
ts
 = 
£cs
 >> 4; 
n
 < 7 &&s != 0;s >>= 8)

304 
n
++;

305 
	`cú_ch¬buf_­³nd_‰
(
c
, 
n
 + (
m¬k”
 >ğ0), 
CCN_BLOB
);

306 ià(
m¬k”
 >= 0)

307 
	`cú_ch¬buf_­³nd_v®ue
(
c
, 
m¬k”
, 1);

308 
p
 = 
	`cú_ch¬buf_»£rve
(
c
, 
n
);

309 ià(
p
 =ğ
NULL
)

311 
ts
 = 
£cs
 >> 4;

312 
i
 = 0; i < 
n
 - 2; i++)

313 
p
[
i
] = 
ts
 >> (8 * (
n
 - 3 - i));

315 
ts
 = ((
£cs
 & 15è<< 12è+ ((
n£cs
 / 5 * 8 + 195312) / 390625);

316 
i
 = 
n
 - 2; i <‚; i++)

317 
p
[
i
] = 
ts
 >> (8 * (
n
 - 1 - i));

318 
c
->
Ëngth
 +ğ
n
;

320 
	}
}

331 
	$cúb_­³nd_now_blob
(
cú_ch¬buf
 *
c
, 
cú_m¬k”
 
m¬k”
)

333 
timev®
 
now
;

334 
»s
;

336 
	`g‘timeofday
(&
now
, 
NULL
);

337 
»s
 = 
	`cúb_­³nd_time¡amp_blob
(
c
, 
m¬k”
, 
now
.
tv_£c
,‚ow.
tv_u£c
 * 1000);

338 (
»s
);

339 
	}
}

345 
	$cúb_–em’t_begš
(
cú_ch¬buf
 *
c
, 
cú_dg
 
dg
)

347 (
	`cú_ch¬buf_­³nd_‰
(
c
, 
dg
, 
CCN_DTAG
));

348 
	}
}

355 
	$cúb_–em’t_’d
(
cú_ch¬buf
 *
c
)

357 (
	`cú_ch¬buf_­³nd_şo£r
(
c
));

358 
	}
}

371 
	$cúb_­³nd_gged_blob
(
cú_ch¬buf
 *
c
,

372 
cú_dg
 
dg
,

373 cÚ¡ *
d©a
,

374 
size_t
 
size
)

376 
»s
;

378 
»s
 = 
	`cú_ch¬buf_­³nd_‰
(
c
, 
dg
, 
CCN_DTAG
);

379 ià(
size
 != 0) {

380 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 
size
, 
CCN_BLOB
);

381 
»s
 |ğ
	`cú_ch¬buf_­³nd
(
c
, 
d©a
, 
size
);

383 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
c
);

384 (
»s
 == 0 ? 0 : -1);

385 
	}
}

397 
	$cúb_gged_putf
(
cú_ch¬buf
 *
c
,

398 
cú_dg
 
dg
, cÚ¡ *
fmt
, ...)

400 
»s
;

401 
size
;

402 
va_li¡
 
­
;

403 *
±r
;

405 
»s
 = 
	`cú_ch¬buf_­³nd_‰
(
c
, 
dg
, 
CCN_DTAG
);

406 ià(
»s
 < 0)

408 
±r
 = (*)
	`cú_ch¬buf_»£rve
(
c
, 
	`¡¾’
(
fmt
) + 20);

409 ià(
±r
 =ğ
NULL
)

411 
	`va_¡¬t
(
­
, 
fmt
);

412 
size
 = 
	`v¢´štf
(
±r
 + 2, (
c
->
lim™
 - c->
Ëngth
 - 2), 
fmt
, 
­
);

413 
	`va_’d
(
­
);

414 ià(
size
 < 0)

416 ià(
size
 > 0) {

417 ià(
size
 >ğ(
c
->
lim™
 - c->
Ëngth
 - 2))

418 
±r
 = 
NULL
;

419 
»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
c
, 
size
, 
CCN_UDATA
);

420 ià(
±r
 =ğ(*)
c
->
buf
 + c->
Ëngth
 + 2)

421 
c
->
Ëngth
 +ğ
size
;

422 ià(
±r
 =ğ(*)
c
->
buf
 + c->
Ëngth
 + 1) {

423 
	`memmove
(
±r
 - 1,…Œ, 
size
);

424 
c
->
Ëngth
 +ğ
size
;

427 
±r
 = (*)
	`cú_ch¬buf_»£rve
(
c
, 
size
 + 1);

428 
	`va_¡¬t
(
­
, 
fmt
);

429 
size
 = 
	`v¢´štf
(
±r
, siz+ 1, 
fmt
, 
­
);

430 
	`va_’d
(
­
);

431 ià(
size
 < 0)

433 
c
->
Ëngth
 +ğ
size
;

436 
»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
c
);

437 (
»s
 == 0 ? 0 : -1);

438 
	}
}

	@lib/ccn_bulkdata.c

20 
	~<as£¹.h
>

21 
	~<¡dšt.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

25 
	~<cú/bloom.h
>

26 
	~<cú/cú.h
>

42 
	tcú_£qfunc
(
	tuštmax_t
 
	tx
, *
	t·¿m
,

43 
	tcú_ch¬buf
 *
	t»suÉbuf
);

48 
cú_£qfunc
 
cú_decim®_£qfunc
;

49 
cú_£qfunc
 
cú_bš¬y_£qfunc
;

56 
	$cú_decim®_£qfunc
(
uštmax_t
 
x
, *
·¿m
, 
cú_ch¬buf
 *
»suÉbuf
)

58 ()
·¿m
;

59 
	`as£¹
(
»suÉbuf
->
Ëngth
 == 0);

60 
	`cú_ch¬buf_putf
(
»suÉbuf
, "%ju", 
x
);

61 
	}
}

68 
	$cú_bš¬y_£qfunc
(
uštmax_t
 
x
, *
·¿m
, 
cú_ch¬buf
 *
»suÉbuf
)

70 
uštmax_t
 
m
;

71 
n
;

72 *
b
;

73 ()
·¿m
;

74 
n
 = 0, 
m
 = 0; 
x
 < m;‚++)

75 
m
 = (m << 8) | 0xff;

76 
b
 = 
	`cú_ch¬buf_»£rve
(
»suÉbuf
, 
n
 + 1);

77 
»suÉbuf
->
Ëngth
 = 
n
 + 1;

78 ; 
n
 >ğ0;‚--, 
x
 >>= 8)

79 
b
[
n
] = 
x
 & 0xff;

80 
	}
}

85 
	sbulkd©a
 {

86 
cú_£qfunc
 *
	m£qfunc
;

87 *
	m£qfunc_·¿m
;

88 
³ndšg
 *
	mfœ¡
;

89 
cú_şosu»
 *
	mş›Á
;

90 
uštmax_t
 
	mÃxt_ex³ùed
;

91 
cú_ch¬buf
 *
	mÇme_´efix
;

92 
	m´efix_comps
;

96 
	s³ndšg
 {

97 
³ndšg
 *
	m´ev
;

98 
³ndšg
 *
	mÃxt
;

99 
bulkd©a
 *
	m·»Á
;

100 
uštmax_t
 
	mx
;

101 
cú_şosu»
 
	mşosu»
;

102 *
	mcÚ‹Á_cúb
;

103 
size_t
 
	mcÚ‹Á_size
;

106 
cú_upÿÎ_»s
 
d–iv”_cÚ‹Á
(
cú
 *
h
, 
bulkd©a
 *
b
);

107 
ex´ess_bulkd©a_š‹»¡
(
cú
 *
h
, 
³ndšg
 *
b
);

112  
cú_upÿÎ_»s


113 
	$imcomšg_bulkd©a
(
cú_şosu»
 *
£lå
,

114 
cú_upÿÎ_kšd
 
kšd
,

115 
cú_upÿÎ_šfo
 *
šfo
)

117 
bulkd©a
 *
b
;

118 
³ndšg
 *
p
 = 
£lå
->
d©a
;

119 
cú_upÿÎ_»s
 
»s
 = 
CCN_UPCALL_RESULT_ERR
;

121 
	`as£¹
(
£lå
 =ğ&
p
->
şosu»
);

122 
b
 = 
p
->
·»Á
;

124 
kšd
) {

125 
CCN_UPCALL_FINAL
:

126 
p
->
´ev
->
Ãxt
 =…->next->prev;

127 
p
->
Ãxt
->
´ev
 =…->prev->next;

128 ià(
b
 !ğ
NULL
 && 
p
 =ğb->
fœ¡
)

129 
b
->
fœ¡
 = (
p
 =ğp->
Ãxt
è? 
NULL
 :…->next;

130 ià(
p
->
cÚ‹Á_cúb
 !ğ
NULL
)

131 
	`ä“
(
p
->
cÚ‹Á_cúb
);

132 
	`ä“
(
p
);

133 (
CCN_UPCALL_RESULT_OK
);

134 
CCN_UPCALL_CONTENT
:

135 
CCN_UPCALL_CONTENT_UNVERIFIED
:

136 
CCN_UPCALL_CONTENT_BAD
:

139 
CCN_UPCALL_INTEREST_TIMED_OUT
:

141 (
CCN_UPCALL_RESULT_REEXPRESS
);

143 (
CCN_UPCALL_RESULT_ERR
);

147 ià(
p
->
cÚ‹Á_cúb
 =ğ
NULL
) {

148 ià(
p
->
x
 =ğ
b
->
Ãxt_ex³ùed
) {

150 
»s
 = (*
b
->
ş›Á
->
p
)(b->ş›Á, 
kšd
, 
šfo
);

151 ià(
»s
 =ğ
CCN_UPCALL_RESULT_OK
) {

152 
b
->
Ãxt_ex³ùed
 += 1;

153 
b
->
fœ¡
 = (
p
 =ğp->
Ãxt
è? 
NULL
 :…->next;

154 
p
->
´ev
->
Ãxt
 =…->next->prev;

155 
p
->
Ãxt
->
´ev
 =…->prev->next;

156 
p
->
Ãxt
 =…->
´ev
 =…;

157 
p
->
·»Á
 = 
NULL
;

161 ià(
p
->
cÚ‹Á_cúb
 =ğ
NULL
) {

163 
size_t
 
size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

164 
£lå
->
»fcouÁ
++;

165 
p
->
cÚ‹Á_cúb
 = 
	`m®loc
(
size
);

166 
	`memıy
(
p
->
cÚ‹Á_cúb
, 
šfo
->cÚ‹Á_cúb, 
size
);

167 
p
->
cÚ‹Á_size
 = 
size
;

170 
b
->
fœ¡
 !ğ
NULL
 && b->fœ¡->
x
 =ğb->
Ãxt_ex³ùed
 &&

171 
b
->
fœ¡
->
cÚ‹Á_cúb
 !ğ
NULL
) {

172 
»s
 = 
	`d–iv”_cÚ‹Á
(
šfo
->
h
, 
b
);

173 ià(
»s
 !ğ
CCN_UPCALL_RESULT_OK
)

176 ià(
b
->
fœ¡
 =ğ
NULL
) {

178 (
CCN_UPCALL_RESULT_OK
);

180 
p
 = 
b
->
fœ¡
;…->
x
 >ğb->
Ãxt_ex³ùed
;… =…->
Ãxt
) {

182 ià(
p
->
cÚ‹Á_cúb
 =ğ
NULL
)

183 
	`ex´ess_bulkd©a_š‹»¡
(
šfo
->
h
, 
p
);

185 (
CCN_UPCALL_RESULT_OK
);

186 
	}
}

189 
	$ex´ess_bulkd©a_š‹»¡
(
cú
 *
h
, 
³ndšg
 *
p
)

191 
»s
;

192 
bulkd©a
 *
b
 = 
NULL
;

193 
´efix_comps
 = -1;

194 
addl_comps
 = -1;

195 
cú_ch¬buf
 *
Çme
 = 
NULL
;

196 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

197 
cú_ch¬buf
 *
£q
 = 
NULL
;

199 
b
 = 
p
->
·»Á
;

200 ià(
b
 =ğ
NULL
)

202 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

203 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

204 
£q
 = 
	`cú_ch¬buf_ü—‹
();

206 
	`cú_ch¬buf_­³nd
(
Çme
, 
b
->
Çme_´efix
->
buf
, b->Çme_´efix->
Ëngth
);

208 
£q
->
Ëngth
 = 0;

209 (*
b
->
£qfunc
)(
p
->
x
, b->
£qfunc_·¿m
, 
£q
);

210 
	`cú_Çme_­³nd
(
Çme
, 
£q
->
buf
, seq->
Ëngth
);

211 
´efix_comps
 = -1;

212 
addl_comps
 = 1;

214 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

216 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

217 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

221 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

222 
»s
 = 
	`cú_ex´ess_š‹»¡
(
h
, 
Çme
, &
p
->
şosu»
, 
‹m¶
);

223 
	`as£¹
(
»s
 >= 0);

224 
	`cú_ch¬buf_de¡roy
(&
Çme
);

225 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

226 
	`cú_ch¬buf_de¡roy
(&
£q
);

227 
	}
}

233 
cú_upÿÎ_»s


234 
	$d–iv”_cÚ‹Á
(
cú
 *
h
, 
bulkd©a
 *
b
)

236 
cú_upÿÎ_šfo
 
šfo
 = {0};

237 
cú_·r£d_CÚ‹ÁObjeù
 
obj
 = {0};

238 
³ndšg
 *
p
 = 
b
->
fœ¡
;

239 
»s
;

240 
cú_upÿÎ_»s
 
ªs
;

241 
	`as£¹
(
p
 !ğ
NULL
 &&…->
x
 =ğ
b
->
Ãxt_ex³ùed
 &&…->
cÚ‹Á_cúb
 != NULL);

242 
šfo
.
pco
 = &
obj
;

243 
šfo
.
cÚ‹Á_comps
 = 
	`cú_šdexbuf_ü—‹
();

244 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
p
->
cÚ‹Á_cúb
,…->
cÚ‹Á_size
,

245 &
obj
, 
šfo
.
cÚ‹Á_comps
);

246 
	`as£¹
(
»s
 >= 0);

247 
šfo
.
cÚ‹Á_cúb
 = 
p
->content_ccnb;

248 
šfo
.
m©ched_comps
 = info.
cÚ‹Á_comps
->
n
 - 2;

250 
ªs
 = (*
b
->
ş›Á
->
p
)(b->ş›Á, 
CCN_UPCALL_CONTENT
, &
šfo
);

252 
šfo
.
cÚ‹Á_cúb
 = 
NULL
;

253 
	`ä“
(
p
->
cÚ‹Á_cúb
);

254 
p
->
cÚ‹Á_cúb
 = 
NULL
;

255 
p
->
cÚ‹Á_size
 = 0;

256 
	`cú_šdexbuf_de¡roy
(&
šfo
.
cÚ‹Á_comps
);

257 ià(
ªs
 =ğ
CCN_UPCALL_RESULT_OK
) {

258 
cú_şosu»
 *
Şd
 = &
p
->
şosu»
;

259 ià((--(
Şd
->
»fcouÁ
)) == 0) {

260 
šfo
.
pco
 = 
NULL
;

261 (
Şd
->
p
)(Şd, 
CCN_UPCALL_FINAL
, &
šfo
);

264 (
ªs
);

265 
	}
}

	@lib/ccn_charbuf.c

20 
	~<¡d¬g.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/time.h
>

25 
	~<cú/ch¬buf.h
>

27 
cú_ch¬buf
 *

28 
	$cú_ch¬buf_ü—‹
()

30 
cú_ch¬buf
 *
c
;

31 
c
 = 
	`ÿÎoc
(1, (*c));

32 (
c
);

33 
	}
}

36 
	$cú_ch¬buf_de¡roy
(
cú_ch¬buf
 **
cbp
)

38 
cú_ch¬buf
 *
c
 = *
cbp
;

39 ià(
c
 !ğ
NULL
) {

40 ià(
c
->
buf
 !ğ
NULL
)

41 
	`ä“
(
c
->
buf
);

42 
	`ä“
(
c
);

43 *
cbp
 = 
NULL
;

45 
	}
}

51 
	$cú_ch¬buf_»£rve
(
cú_ch¬buf
 *
c
, 
size_t
 
n
)

53 
size_t
 
Ãwsz
 = 
n
 + 
c
->
Ëngth
;

54 *
buf
 = 
c
->buf;

55 ià(
Ãwsz
 < 
n
)

56 (
NULL
);

57 ià(
Ãwsz
 > 
c
->
lim™
) {

58 ià(2 * 
c
->
lim™
 > 
Ãwsz
)

59 
Ãwsz
 = 2 * 
c
->
lim™
;

60 
buf
 = 
	`»®loc
(
c
->buf, 
Ãwsz
);

61 ià(
buf
 =ğ
NULL
)

62 (
NULL
);

63 
	`mem£t
(
buf
 + 
c
->
lim™
, 0, 
Ãwsz
 - c->limit);

64 
c
->
buf
 = buf;

65 
c
->
lim™
 = 
Ãwsz
;

67 
buf
 +ğ
c
->
Ëngth
;

68 (
buf
);

69 
	}
}

71 
	$cú_ch¬buf_»£t
(
cú_ch¬buf
 *
c
)

73 ià(
c
 =ğ
NULL
) {

76 
c
->
Ëngth
 = 0;

77 
	}
}

80 
	$cú_ch¬buf_­³nd
(
cú_ch¬buf
 *
c
, cÚ¡ *
p
, 
size_t
 
n
)

82 *
d¡
 = 
	`cú_ch¬buf_»£rve
(
c
, 
n
);

83 ià(
d¡
 =ğ
NULL
)

85 
	`memıy
(
d¡
, 
p
, 
n
);

86 
c
->
Ëngth
 +ğ
n
;

88 
	}
}

91 
	$cú_ch¬buf_­³nd_v®ue
(
cú_ch¬buf
 *
c
, 
v®
, 
n
)

93 *
d¡
;

94 
i
;

95 ià(
n
 > (
v®
))

97 
d¡
 = 
	`cú_ch¬buf_»£rve
(
c
, 
n
);

98 ià(
d¡
 =ğ
NULL
)

100 
i
 = 0; i < 
n
; i++)

101 
d¡
[
i
] = ()(
v®
 >> (8 * (
n
-1-i)));

102 
c
->
Ëngth
 +ğ
n
;

104 
	}
}

107 
	$cú_ch¬buf_­³nd_ch¬buf
(
cú_ch¬buf
 *
c
, cÚ¡ cú_ch¬buà*
š
)

109 (
	`cú_ch¬buf_­³nd
(
c
, 
š
->
buf
, in->
Ëngth
));

110 
	}
}

113 
	$cú_ch¬buf_­³nd_¡ršg
(
cú_ch¬buf
 *
c
, cÚ¡ *
s
)

115 (
	`cú_ch¬buf_­³nd
(
c
, 
s
, 
	`¡¾’
(s)));

116 
	}
}

119 
	$cú_ch¬buf_putf
(
cú_ch¬buf
 *
c
, cÚ¡ *
fmt
, ...)

121 
sz
;

122 
va_li¡
 
­
;

123 *
buf
;

124 
buf
 = (*)
	`cú_ch¬buf_»£rve
(
c
, 
	`¡¾’
(
fmt
) + 10);

125 ià(
buf
 =ğ
NULL
) (-1);

126 
	`va_¡¬t
(
­
, 
fmt
);

127 
sz
 = 
	`v¢´štf
(
buf
, 
c
->
lim™
 - c->
Ëngth
, 
fmt
, 
­
);

128 
	`va_’d
(
­
);

129 ià(
sz
 < 0)

130 (
sz
);

131 ià(
c
->
Ëngth
 + 
sz
 < c->
lim™
) {

132 
c
->
Ëngth
 +ğ
sz
;

133 (
sz
);

135 
	`va_’d
(
­
);

136 
buf
 = (*)
	`cú_ch¬buf_»£rve
(
c
, 
sz
 + 1);

137 ià(
buf
 =ğ
NULL
) (-1);

138 
	`va_¡¬t
(
­
, 
fmt
);

139 
sz
 = 
	`v¢´štf
(
buf
, 
c
->
lim™
 - c->
Ëngth
, 
fmt
, 
­
);

140 
	`va_’d
(
­
);

141 ià(
c
->
Ëngth
 + 
sz
 < c->
lim™
) {

142 
c
->
Ëngth
 +ğ
sz
;

143 (
sz
);

146 
	}
}

150 
	$cú_ch¬buf_­³nd_d©‘ime
(
cú_ch¬buf
 *
c
, 
time_t
 
£cs
, 
n£cs
)

152 
time¡ršg
[32];

153 
tim–’
;

154 
tm
 
time_tm
;

155 
»s
;

157 
tim–’
 = 
	`¡ráime
(
time¡ršg
, (timestring),

158 "%FT%T", 
	`gmtime_r
(&
£cs
, &
time_tm
));

159 ià(
tim–’
 >ğ(
time¡ršg
))

161 ià(
n£cs
 != 0) {

162 ià(
n£cs
 < 0 ||‚secs >= 1000000000)

164 
tim–’
 +ğ
	`¢´štf
(&
time¡ršg
[timelen], (timestring) -imelen,

165 ".%09d", 
n£cs
);

166 ià(
tim–’
 >ğ(
time¡ršg
))

168 
time¡ršg
[
tim–’
 - 1] == '0')imelen--;

170 
time¡ršg
[
tim–’
++] = 'Z';

171 
»s
 = 
	`cú_ch¬buf_­³nd
(
c
, 
time¡ršg
, 
tim–’
);

172  (
»s
);

173 
	}
}

176 
	$cú_ch¬buf_as_¡ršg
(
cú_ch¬buf
 *
c
)

178 *
r
;

179 
r
 = 
	`cú_ch¬buf_»£rve
(
c
, 1);

180 ià(
r
 =ğ
NULL
)

181 (
NULL
);

182 
r
[0] = 0;

183 ((*)
c
->
buf
);

184 
	}
}

	@lib/ccn_client.c

20 
	~<¬·/š‘.h
>

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<pŞl.h
>

24 
	~<sigÇl.h
>

25 
	~<¡dšt.h
>

26 
	~<¡dio.h
>

27 
	~<¡dlib.h
>

28 
	~<¡ršg.h
>

29 
	~<sys/sock‘.h
>

30 
	~<sys/¡©.h
>

31 
	~<sys/time.h
>

32 
	~<sys/ty³s.h
>

33 
	~<sys/un.h
>

34 
	~<uni¡d.h
>

36 
	~<cú/cú.h
>

37 
	~<cú/cú_´iv©e.h
>

38 
	~<cú/cúd.h
>

39 
	~<cú/ch¬buf.h
>

40 
	~<cú/codšg.h
>

41 
	~<cú/dige¡.h
>

42 
	~<cú/hashtb.h
>

43 
	~<cú/»g_mgmt.h
>

44 
	~<cú/signšg.h
>

45 
	~<cú/key¡Üe.h
>

46 
	~<cú/uri.h
>

48 
	scú
 {

49 
	msock
;

50 
size_t
 
	moutbufšdex
;

51 
cú_ch¬buf
 *
	mš‹»¡buf
;

52 
cú_ch¬buf
 *
	mšbuf
;

53 
cú_ch¬buf
 *
	moutbuf
;

54 
cú_ch¬buf
 *
	mcúdid
;

55 
hashtb
 *
	mš‹»¡s_by_´efix
;

56 
hashtb
 *
	mš‹»¡_f‹rs
;

57 
cú_sk–‘Ú_decod”
 
	mdecod”
;

58 
cú_šdexbuf
 *
	msü©ch_šdexbuf
;

59 
hashtb
 *
	mkeys
;

60 
hashtb
 *
	mkey¡Ües
;

61 
cú_ch¬buf
 *
	mdeçuÉ_pubid
;

62 
timev®
 
	mnow
;

63 
	mtimeout
;

64 
	m»äesh_us
;

65 
	m”r
;

66 
	m”¾še
;

67 
	mv”bo£_”rÜ
;

68 
	mp
;

69 
	mruÂšg
;

72 
	gex´es£d_š‹»¡
;

73 
	gcú_»g_şosu»
;

75 
	sš‹»¡s_by_´efix
 {

76 
ex´es£d_š‹»¡
 *
	mli¡
;

79 
	sex´es£d_š‹»¡
 {

80 
	mmagic
;

81 
timev®
 
	mÏ¡time
;

82 
cú_şosu»
 *
	maùiÚ
;

83 *
	mš‹»¡_msg
;

84 
size_t
 
	msize
;

85 
	mrg‘
;

86 
	mout¡ªdšg
;

87 
	mliãtime_us
;

88 
cú_ch¬buf
 *
	mwª‹d_pub
;

89 
ex´es£d_š‹»¡
 *
	mÃxt
;

92 
	sš‹»¡_f‹r
 {

93 
cú_şosu»
 *
	maùiÚ
;

94 
cú_»g_şosu»
 *
	mcú_»g_şosu»
;

95 
timev®
 
	mexpœy
;

96 
	mæags
;

98 
	#CCN_FORW_WAITING_CCNDID
 (1<<30)

	)

100 
	scú_»g_şosu»
 {

101 
cú_şosu»
 
	maùiÚ
;

102 
š‹»¡_f‹r
 *
	mš‹»¡_f‹r
;

105 
	#NOTE_ERR
(
h
, 
e
è(h->
”r
 = (e), h->
”¾še
 = 
__LINE__
, 
	`cú_nÙe_”r
(h))

	)

106 
	#NOTE_ERRNO
(
h
è
	`NOTE_ERR
(h, 
”ºo
)

	)

108 
	#THIS_CANNOT_HAPPEN
(
h
) \

109 dØ{ 
	`NOTE_ERR
(
h
, -73); 
	`cú_³¼Ü
(h, "Cª'ˆh­³n");} 0)

	)

111 
	#XXX
 \

112 dØ{ 
	`NOTE_ERR
(
h
, -76); 
	`cú_³¼Ü
(h, "PËa£ wr™sommÜcodh”e"); } 0)

	)

114 
cú_»äesh_š‹»¡
(
cú
 *, 
ex´es£d_š‹»¡
 *);

115 
cú_š™Ÿ‹_´efix_»g
(
cú
 *,

116 cÚ¡ *, 
size_t
,

117 
š‹»¡_f‹r
 *);

118 
fš®ize_pkey
(
hashtb_’um”©Ü
 *
e
);

119 
fš®ize_key¡Üe
(
hashtb_’um”©Ü
 *
e
);

120 
cú_pushout
(
cú
 *
h
);

123 
	$tv_—¾›r
(cÚ¡ 
timev®
 *
a
, cÚ¡ timev® *
b
)

125 ià(
a
->
tv_£c
 > 
b
->tv_sec)

127 ià(
a
->
tv_£c
 < 
b
->tv_sec)

129 (
a
->
tv_u£c
 < 
b
->tv_usec);

130 
	}
}

140 
	$cú_³¼Ü
(
cú
 *
h
, cÚ¡ *
s
)

142 cÚ¡ *
dlm
 = ": ";

143 ià(
s
 =ğ
NULL
) {

144 ià(
h
->
”r
 > 0)

145 
s
 = 
	`¡»¼Ü
(
h
->
”r
);

147 
dlm
 = 
s
 = "";

150 
	`årštf
(
¡d”r
, "ccn_client.c:%d[%d] -ƒrror %d%s%s\n",

151 
h
->
”¾še
, ()
	`g‘pid
(), h->
”r
, 
dlm
, 
s
);

152 
	}
}

155 
	$cú_nÙe_”r
(
cú
 *
h
)

157 ià(
h
->
v”bo£_”rÜ
)

158 
	`cú_³¼Ü
(
h
, 
NULL
);

160 
	}
}

169 
	$cú_£‹¼Ü
(
cú
 *
h
, 
”rÜ_code
)

171 ià(
h
 =ğ
NULL
)

173 
h
->
”r
 = 
”rÜ_code
;

174 
h
->
”¾še
 = 0;

175 ià(
”rÜ_code
 != 0)

176 
	`cú_nÙe_”r
(
h
);

178 
	}
}

186 
	$cú_g‘”rÜ
(
cú
 *
h
)

188 ià(
h
 =ğ
NULL
)

190 (
h
->
”r
);

191 
	}
}

193 
cú_šdexbuf
 *

194 
	$cú_šdexbuf_obš
(
cú
 *
h
)

196 
cú_šdexbuf
 *
c
 = 
h
->
sü©ch_šdexbuf
;

197 ià(
c
 =ğ
NULL
)

198 (
	`cú_šdexbuf_ü—‹
());

199 
h
->
sü©ch_šdexbuf
 = 
NULL
;

200 
c
->
n
 = 0;

201 (
c
);

202 
	}
}

205 
	$cú_šdexbuf_»Ëa£
(
cú
 *
h
, 
cú_šdexbuf
 *
c
)

207 
c
->
n
 = 0;

208 ià(
h
->
sü©ch_šdexbuf
 =ğ
NULL
)

209 
h
->
sü©ch_šdexbuf
 = 
c
;

211 
	`cú_šdexbuf_de¡roy
(&
c
);

212 
	}
}

215 
	$cú_»¶aû_hªdËr
(
cú
 *
h
,

216 
cú_şosu»
 **
d¡p
,

217 
cú_şosu»
 *
¤c
)

219 
cú_şosu»
 *
Şd
 = *
d¡p
;

220 ià(
¤c
 =ğ
Şd
)

222 ià(
¤c
 !ğ
NULL
)

223 
¤c
->
»fcouÁ
++;

224 *
d¡p
 = 
¤c
;

225 ià(
Şd
 !ğ
NULL
 && (--(Şd->
»fcouÁ
)) == 0) {

226 
cú_upÿÎ_šfo
 
šfo
 = { 0 };

227 
šfo
.
h
 = h;

228 (
Şd
->
p
)(Şd, 
CCN_UPCALL_FINAL
, &
šfo
);

230 
	}
}

238 
cú
 *

239 
	$cú_ü—‹
()

241 
cú
 *
h
;

242 cÚ¡ *
s
;

243 
hashtb_·¿m
 
·¿m
 = {0};

245 
h
 = 
	`ÿÎoc
(1, (*h));

246 ià(
h
 =ğ
NULL
)

247 (
h
);

248 
·¿m
.
fš®ize_d©a
 = 
h
;

249 
h
->
sock
 = -1;

250 
h
->
š‹»¡buf
 = 
	`cú_ch¬buf_ü—‹
();

251 
·¿m
.
fš®ize
 = &
fš®ize_pkey
;

252 
h
->
keys
 = 
	`hashtb_ü—‹
((
cú_pkey
 *), &
·¿m
);

253 
·¿m
.
fš®ize
 = &
fš®ize_key¡Üe
;

254 
h
->
key¡Ües
 = 
	`hashtb_ü—‹
((
cú_key¡Üe
 *), &
·¿m
);

255 
s
 = 
	`g‘’v
("CCN_DEBUG");

256 
h
->
v”bo£_”rÜ
 = (
s
 !ğ
NULL
 && s[0] != 0);

257 
s
 = 
	`g‘’v
("CCN_TAP");

258 ià(
s
 !ğ
NULL
 && s[0] != 0) {

259 
p_Çme
[255];

260 
timev®
 
tv
;

261 
	`g‘timeofday
(&
tv
, 
NULL
);

262 ià(
	`¢´štf
(
p_Çme
, 255, "%s-%d-%d-%d", 
s
, ()
	`g‘pid
(),

263 ()
tv
.
tv_£c
, (év.
tv_u£c
) >= 255) {

264 
	`årštf
(
¡d”r
, "CCN_TAP…©h i toØlÚg: %s\n", 
s
);

266 
h
->
p
 = 
	`İ’
(
p_Çme
, 
O_WRONLY
|
O_APPEND
|
O_CREAT
, 
S_IRWXU
);

267 ià(
h
->
p
 == -1) {

268 
	`NOTE_ERRNO
(
h
);

269 
	`cú_³¼Ü
(
h
, "Unableo open CCN_TAP file");

272 
	`årštf
(
¡d”r
, "CCN_TAP wr™šgØ%s\n", 
p_Çme
);

275 
h
->
p
 = -1;

277 (
h
);

278 
	}
}

288 
	$cú_cÚÃù
(
cú
 *
h
, cÚ¡ *
Çme
)

290 
sockaddr_un
 
addr
 = {0};

291 
»s
;

292 ià(
h
 =ğ
NULL
)

294 
h
->
”r
 = 0;

295 ià(
h
->
sock
 != -1)

296 (
	`NOTE_ERR
(
h
, 
EINVAL
));

297 
addr
.
sun_çmy
 = 
AF_UNIX
;

298 ià(
Çme
 =ğ
NULL
 ||‚ame[0] == 0)

299 
	`cú_£tup_sockaddr_un
(
NULL
, &
addr
);

301 
addr
.
sun_çmy
 = 
AF_UNIX
;

302 
	`¡ºıy
(
addr
.
sun_·th
, 
Çme
, (addr.sun_path));

304 
h
->
sock
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

305 ià(
h
->
sock
 == -1)

306 (
	`NOTE_ERRNO
(
h
));

307 
»s
 = 
	`cÚÃù
(
h
->
sock
, (
sockaddr
 *)&
addr
, (addr));

308 ià(
»s
 == -1)

309 (
	`NOTE_ERRNO
(
h
));

310 
»s
 = 
	`fú
(
h
->
sock
, 
F_SETFL
, 
O_NONBLOCK
);

311 ià(
»s
 == -1)

312 (
	`NOTE_ERRNO
(
h
));

313 (
h
->
sock
);

314 
	}
}

317 
	$cú_g‘_cÚÃùiÚ_fd
(
cú
 *
h
)

319 (
h
->
sock
);

320 
	}
}

323 
	$cú_discÚÃù
(
cú
 *
h
)

325 
»s
;

326 
»s
 = 
	`cú_pushout
(
h
);

327 ià(
»s
 == 1) {

328 
»s
 = 
	`fú
(
h
->
sock
, 
F_SETFL
, 0);

329 ià(
»s
 == 0)

330 
	`cú_pushout
(
h
);

332 
	`cú_ch¬buf_de¡roy
(&
h
->
šbuf
);

333 
	`cú_ch¬buf_de¡roy
(&
h
->
outbuf
);

334 
»s
 = 
	`şo£
(
h
->
sock
);

335 
h
->
sock
 = -1;

336 ià(
»s
 == -1)

337 (
	`NOTE_ERRNO
(
h
));

339 
	}
}

342 
	$cú_gre
(
ex´es£d_š‹»¡
 *
i
)

344 
	`årštf
(
¡d”r
, "BOTCH - (¡ruùƒx´es£d_š‹»¡ *)%°ha bad magiøv®ue\n", (*)
i
);

345 
	}
}

348 
	$»¶aû_š‹»¡_msg
(
ex´es£d_š‹»¡
 *
š‹»¡
,

349 
cú_ch¬buf
 *
cb
)

351 ià(
š‹»¡
->
magic
 != 0x7059e5f4) {

352 
	`cú_gre
(
š‹»¡
);

355 ià(
š‹»¡
->
š‹»¡_msg
 !ğ
NULL
)

356 
	`ä“
(
š‹»¡
->
š‹»¡_msg
);

357 
š‹»¡
->
š‹»¡_msg
 = 
NULL
;

358 
š‹»¡
->
size
 = 0;

359 ià(
cb
 !ğ
NULL
 && cb->
Ëngth
 > 0) {

360 
š‹»¡
->
š‹»¡_msg
 = 
	`ÿÎoc
(1, 
cb
->
Ëngth
);

361 ià(
š‹»¡
->
š‹»¡_msg
 !ğ
NULL
) {

362 
	`memıy
(
š‹»¡
->
š‹»¡_msg
, 
cb
->
buf
, cb->
Ëngth
);

363 
š‹»¡
->
size
 = 
cb
->
Ëngth
;

366 
	}
}

368 
ex´es£d_š‹»¡
 *

369 
	$cú_de¡roy_š‹»¡
(
cú
 *
h
, 
ex´es£d_š‹»¡
 *
i
)

371 
ex´es£d_š‹»¡
 *
ªs
 = 
i
->
Ãxt
;

372 ià(
i
->
magic
 != 0x7059e5f4) {

373 
	`cú_gre
(
i
);

374 (
NULL
);

376 
	`cú_»¶aû_hªdËr
(
h
, &(
i
->
aùiÚ
), 
NULL
);

377 
	`»¶aû_š‹»¡_msg
(
i
, 
NULL
);

378 
	`cú_ch¬buf_de¡roy
(&
i
->
wª‹d_pub
);

379 
i
->
magic
 = -1;

380 
	`ä“
(
i
);

381 (
ªs
);

382 
	}
}

385 
	$cú_check_š‹»¡s
(
ex´es£d_š‹»¡
 *
li¡
)

387 
ex´es£d_š‹»¡
 *
›
;

388 
›
 = 
li¡
; i!ğ
NULL
; iğ›->
Ãxt
) {

389 ià(
›
->
magic
 != 0x7059e5f4) {

390 
	`cú_gre
(
›
);

391 
	`abÜt
();

394 
	}
}

397 
	$cú_ş—n_š‹»¡s_by_´efix
(
cú
 *
h
, 
š‹»¡s_by_´efix
 *
’Œy
)

399 
ex´es£d_š‹»¡
 *
›
;

400 
ex´es£d_š‹»¡
 *
Ãxt
;

401 
ex´es£d_š‹»¡
 **

;

402 
	`cú_check_š‹»¡s
(
’Œy
->
li¡
);

403 

 = &(
’Œy
->
li¡
);

404 
›
 = 
’Œy
->
li¡
; i!ğ
NULL
; iğ
Ãxt
) {

405 
Ãxt
 = 
›
->next;

406 ià(
›
->
aùiÚ
 =ğ
NULL
)

407 
	`cú_de¡roy_š‹»¡
(
h
, 
›
);

409 (*

èğ
›
;

410 

 = &(
›
->
Ãxt
);

413 (*

èğ
NULL
;

414 
	`cú_check_š‹»¡s
(
’Œy
->
li¡
);

415 
	}
}

418 
	$cú_de¡roy
(
cú
 **
hp
)

420 
hashtb_’um”©Ü
 
“
;

421 
hashtb_’um”©Ü
 *
e
 = &
“
;

422 
cú
 *
h
 = *
hp
;

423 ià(
h
 =ğ
NULL
)

425 
	`cú_discÚÃù
(
h
);

426 ià(
h
->
š‹»¡s_by_´efix
 !ğ
NULL
) {

427 
	`hashtb_¡¬t
(
h
->
š‹»¡s_by_´efix
, 
e
);ƒ->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

428 
š‹»¡s_by_´efix
 *
’Œy
 = 
e
->
d©a
;

429 
’Œy
->
li¡
 !ğ
NULL
)

430 
’Œy
->
li¡
 = 
	`cú_de¡roy_š‹»¡
(
h
,ƒntry->list);

432 
	`hashtb_’d
(
e
);

433 
	`hashtb_de¡roy
(&(
h
->
š‹»¡s_by_´efix
));

435 ià(
h
->
š‹»¡_f‹rs
 !ğ
NULL
) {

436 
	`hashtb_¡¬t
(
h
->
š‹»¡_f‹rs
, 
e
);ƒ->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

437 
š‹»¡_f‹r
 *
i
 = 
e
->
d©a
;

438 
	`cú_»¶aû_hªdËr
(
h
, &(
i
->
aùiÚ
), 
NULL
);

440 
	`hashtb_’d
(
e
);

441 
	`hashtb_de¡roy
(&(
h
->
š‹»¡_f‹rs
));

443 
	`hashtb_de¡roy
(&(
h
->
keys
));

444 
	`hashtb_de¡roy
(&(
h
->
key¡Ües
));

445 
	`cú_ch¬buf_de¡roy
(&
h
->
š‹»¡buf
);

446 
	`cú_šdexbuf_de¡roy
(&
h
->
sü©ch_šdexbuf
);

447 
	`cú_ch¬buf_de¡roy
(&
h
->
deçuÉ_pubid
);

448 ià(
h
->
p
 != -1)

449 
	`şo£
(
h
->
p
);

450 
	`ä“
(
h
);

451 *
hp
 = 
NULL
;

452 
	}
}

462 
	$cú_check_Çmebuf
(
cú
 *
h
, 
cú_ch¬buf
 *
Çmebuf
, 
´efix_comps
,

463 
om™_possibË_dige¡
)

465 
cú_buf_decod”
 
decod”
;

466 
cú_buf_decod”
 *
d
;

467 
i
 = 0;

468 
ªs
 = 0;

469 
´ev_ªs
 = 0;

470 ià(
Çmebuf
 =ğ
NULL
 ||‚amebuf->
Ëngth
 < 2)

472 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
Çmebuf
->
buf
,‚amebuf->
Ëngth
);

473 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Name
)) {

474 
	`cú_buf_advªû
(
d
);

475 
´ev_ªs
 = 
ªs
 = 
d
->
decod”
.
tok’_šdex
;

476 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

477 
	`cú_buf_advªû
(
d
);

478 ià(
	`cú_buf_m©ch_blob
(
d
, 
NULL
, NULL)) {

479 
	`cú_buf_advªû
(
d
);

481 
	`cú_buf_check_şo£
(
d
);

482 
i
 += 1;

483 ià(
´efix_comps
 < 0 || 
i
 <=…refix_comps) {

484 
´ev_ªs
 = 
ªs
;

485 
ªs
 = 
d
->
decod”
.
tok’_šdex
;

488 
	`cú_buf_check_şo£
(
d
);

490 ià(
d
->
decod”
.
¡©e
 < 0 || 
ªs
 < 
´efix_comps
)

492 ià(
om™_possibË_dige¡
 && 
ªs
 =ğ
´ev_ªs
 + 36 &&‡n =ğ
Çmebuf
->
Ëngth
 - 1)

493 (
´ev_ªs
);

494 (
ªs
);

495 
	}
}

498 
	$cú_cÚ¡ruù_š‹»¡
(
cú
 *
h
,

499 
cú_ch¬buf
 *
Çme_´efix
,

500 
cú_ch¬buf
 *
š‹»¡_‹m¶©e
,

501 
ex´es£d_š‹»¡
 *
de¡
)

503 
cú_ch¬buf
 *
c
 = 
h
->
š‹»¡buf
;

504 
size_t
 
¡¬t
;

505 
size_t
 
size
;

506 
»s
;

508 
de¡
->
liãtime_us
 = 
CCN_INTEREST_LIFETIME_MICROSEC
;

509 
c
->
Ëngth
 = 0;

510 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

511 
	`cú_ch¬buf_­³nd
(
c
, 
Çme_´efix
->
buf
,‚ame_´efix->
Ëngth
);

512 
»s
 = 0;

513 ià(
š‹»¡_‹m¶©e
 !ğ
NULL
) {

514 
cú_·r£d_š‹»¡
 
pi
 = { 0 };

515 
»s
 = 
	`cú_·r£_š‹»¡
(
š‹»¡_‹m¶©e
->
buf
,

516 
š‹»¡_‹m¶©e
->
Ëngth
, &
pi
, 
NULL
);

517 ià(
»s
 >= 0) {

518 
štmax_t
 
liãtime
 = 
	`cú_š‹»¡_liãtime
(
š‹»¡_‹m¶©e
->
buf
, &
pi
);

520 ià(
liãtime
 < 1 ||†ifetime > (30 << 12))

521 
	`NOTE_ERR
(
h
, 
EINVAL
);

523 
de¡
->
liãtime_us
 = (
liãtime
 * 1000000) >> 12;

524 
¡¬t
 = 
pi
.
off£t
[
CCN_PI_E_Name
];

525 
size
 = 
pi
.
off£t
[
CCN_PI_B_NÚû
] - 
¡¬t
;

526 
	`cú_ch¬buf_­³nd
(
c
, 
š‹»¡_‹m¶©e
->
buf
 + 
¡¬t
, 
size
);

527 
¡¬t
 = 
pi
.
off£t
[
CCN_PI_B_OTHER
];

528 
size
 = 
pi
.
off£t
[
CCN_PI_E_OTHER
] - 
¡¬t
;

529 ià(
size
 != 0)

530 
	`cú_ch¬buf_­³nd
(
c
, 
š‹»¡_‹m¶©e
->
buf
 + 
¡¬t
, 
size
);

533 
	`NOTE_ERR
(
h
, 
EINVAL
);

535 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

536 
	`»¶aû_š‹»¡_msg
(
de¡
, (
»s
 >ğ0 ? 
c
 : 
NULL
));

537 
	}
}

540 
	$cú_ex´ess_š‹»¡
(
cú
 *
h
,

541 
cú_ch¬buf
 *
Çmebuf
,

542 
cú_şosu»
 *
aùiÚ
,

543 
cú_ch¬buf
 *
š‹»¡_‹m¶©e
)

545 
hashtb_’um”©Ü
 
“
;

546 
hashtb_’um”©Ü
 *
e
 = &
“
;

547 
»s
;

548 
´efix’d
;

549 
ex´es£d_š‹»¡
 *
š‹»¡
 = 
NULL
;

550 
š‹»¡s_by_´efix
 *
’Œy
 = 
NULL
;

551 ià(
h
->
š‹»¡s_by_´efix
 =ğ
NULL
) {

552 
h
->
š‹»¡s_by_´efix
 = 
	`hashtb_ü—‹
((š‹»¡s_by_´efix), 
NULL
);

553 ià(
h
->
š‹»¡s_by_´efix
 =ğ
NULL
)

554 (
	`NOTE_ERRNO
(
h
));

556 
´efix’d
 = 
	`cú_check_Çmebuf
(
h
, 
Çmebuf
, -1, 1);

557 ià(
´efix’d
 < 0)

558 (
´efix’d
);

563 
	`hashtb_¡¬t
(
h
->
š‹»¡s_by_´efix
, 
e
);

564 
»s
 = 
	`hashtb_£ek
(
e
, 
Çmebuf
->
buf
 + 1, 
´efix’d
 - 1, 0);

565 
’Œy
 = 
e
->
d©a
;

566 ià(
’Œy
 =ğ
NULL
) {

567 
	`NOTE_ERRNO
(
h
);

568 
	`hashtb_’d
(
e
);

569 (
»s
);

571 ià(
»s
 =ğ
HT_NEW_ENTRY
)

572 
’Œy
->
li¡
 = 
NULL
;

573 
š‹»¡
 = 
	`ÿÎoc
(1, (*interest));

574 ià(
š‹»¡
 =ğ
NULL
) {

575 
	`NOTE_ERRNO
(
h
);

576 
	`hashtb_’d
(
e
);

579 
š‹»¡
->
magic
 = 0x7059e5f4;

580 
	`cú_cÚ¡ruù_š‹»¡
(
h
, 
Çmebuf
, 
š‹»¡_‹m¶©e
, 
š‹»¡
);

581 ià(
š‹»¡
->
š‹»¡_msg
 =ğ
NULL
) {

582 
	`ä“
(
š‹»¡
);

583 
	`hashtb_’d
(
e
);

586 
	`cú_»¶aû_hªdËr
(
h
, &(
š‹»¡
->
aùiÚ
),‡ction);

587 
š‹»¡
->
rg‘
 = 1;

588 
š‹»¡
->
Ãxt
 = 
’Œy
->
li¡
;

589 
’Œy
->
li¡
 = 
š‹»¡
;

590 
	`hashtb_’d
(
e
);

592 
	`cú_»äesh_š‹»¡
(
h
, 
š‹»¡
);

594 
	}
}

597 
	$fš®ize_š‹»¡_f‹r
(
hashtb_’um”©Ü
 *
e
)

599 
š‹»¡_f‹r
 *
i
 = 
e
->
d©a
;

600 ià(
i
->
cú_»g_şosu»
 !ğ
NULL
) {

601 
i
->
cú_»g_şosu»
->
š‹»¡_f‹r
 = 
NULL
;

602 
i
->
cú_»g_şosu»
 = 
NULL
;

604 
	}
}

607 
	$cú_£t_š‹»¡_f‹r_w™h_æags
(
cú
 *
h
, 
cú_ch¬buf
 *
Çmebuf
,

608 
cú_şosu»
 *
aùiÚ
, 
fÜw_æags
)

610 
hashtb_’um”©Ü
 
“
;

611 
hashtb_’um”©Ü
 *
e
 = &
“
;

612 
»s
;

613 
š‹»¡_f‹r
 *
’Œy
;

614 ià(
h
->
š‹»¡_f‹rs
 =ğ
NULL
) {

615 
hashtb_·¿m
 
·¿m
 = {0};

616 
·¿m
.
fš®ize
 = &
fš®ize_š‹»¡_f‹r
;

617 
h
->
š‹»¡_f‹rs
 = 
	`hashtb_ü—‹
((
š‹»¡_f‹r
), &
·¿m
);

618 ià(
h
->
š‹»¡_f‹rs
 =ğ
NULL
)

619 (
	`NOTE_ERRNO
(
h
));

621 
»s
 = 
	`cú_check_Çmebuf
(
h
, 
Çmebuf
, -1, 0);

622 ià(
»s
 < 0)

623 (
»s
);

624 
	`hashtb_¡¬t
(
h
->
š‹»¡_f‹rs
, 
e
);

625 
»s
 = 
	`hashtb_£ek
(
e
, 
Çmebuf
->
buf
 + 1,‚amebuf->
Ëngth
 - 2, 0);

626 ià(
»s
 >= 0) {

627 
’Œy
 = 
e
->
d©a
;

628 
’Œy
->
æags
 = 
fÜw_æags
;

629 
	`cú_»¶aû_hªdËr
(
h
, &(
’Œy
->
aùiÚ
),‡ction);

630 ià(
aùiÚ
 =ğ
NULL
)

631 
	`hashtb_d–‘e
(
e
);

633 
	`hashtb_’d
(
e
);

634 (
»s
);

635 
	}
}

638 
	$cú_£t_š‹»¡_f‹r
(
cú
 *
h
, 
cú_ch¬buf
 *
Çmebuf
,

639 
cú_şosu»
 *
aùiÚ
)

641 
fÜw_æags
 = 
CCN_FORW_ACTIVE
 | 
CCN_FORW_CHILD_INHERIT
;

642 (
	`cú_£t_š‹»¡_f‹r_w™h_æags
(
h
, 
Çmebuf
, 
aùiÚ
, 
fÜw_æags
));

643 
	}
}

646 
	$cú_pushout
(
cú
 *
h
)

648 
ssize_t
 
»s
;

649 
size_t
 
size
;

650 ià(
h
->
outbuf
 !ğ
NULL
 && h->
outbufšdex
 < h->outbuf->
Ëngth
) {

651 ià(
h
->
sock
 < 0)

653 
size
 = 
h
->
outbuf
->
Ëngth
 - h->
outbufšdex
;

654 
»s
 = 
	`wr™e
(
h
->
sock
, h->
outbuf
->
buf
 + h->
outbufšdex
, 
size
);

655 ià(
»s
 =ğ
size
) {

656 
h
->
outbuf
->
Ëngth
 = h->
outbufšdex
 = 0;

659 ià(
»s
 == -1)

660  ((
”ºo
 =ğ
EAGAIN
è? 1 : 
	`NOTE_ERRNO
(
h
));

661 
h
->
outbufšdex
 +ğ
»s
;

665 
	}
}

668 
	$cú_put
(
cú
 *
h
, cÚ¡ *
p
, 
size_t
 
Ëngth
)

670 
cú_sk–‘Ú_decod”
 
dd
 = {0};

671 
ssize_t
 
»s
;

672 ià(
h
 =ğ
NULL
 || 
p
 =ğNULL || 
Ëngth
 == 0)

673 (
	`NOTE_ERR
(
h
, 
EINVAL
));

674 
»s
 = 
	`cú_sk–‘Ú_decode
(&
dd
, 
p
, 
Ëngth
);

675 ià(!(
»s
 =ğ
Ëngth
 && 
dd
.
¡©e
 == 0))

676 (
	`NOTE_ERR
(
h
, 
EINVAL
));

677 ià(
h
->
p
 != -1) {

678 
»s
 = 
	`wr™e
(
h
->
p
, 
p
, 
Ëngth
);

679 ià(
»s
 == -1) {

680 
	`NOTE_ERRNO
(
h
);

681 ()
	`şo£
(
h
->
p
);

682 
h
->
p
 = -1;

685 ià(
h
->
outbuf
 !ğ
NULL
 && h->
outbufšdex
 < h->outbuf->
Ëngth
) {

687 
	`cú_ch¬buf_­³nd
(
h
->
outbuf
, 
p
, 
Ëngth
);

688  (
	`cú_pushout
(
h
));

690 ià(
h
->
sock
 == -1)

691 
»s
 = 0;

693 
»s
 = 
	`wr™e
(
h
->
sock
, 
p
, 
Ëngth
);

694 ià(
»s
 =ğ
Ëngth
)

696 ià(
»s
 == -1) {

697 ià(
”ºo
 !ğ
EAGAIN
)

698 (
	`NOTE_ERRNO
(
h
));

699 
»s
 = 0;

701 ià(
h
->
outbuf
 =ğ
NULL
) {

702 
h
->
outbuf
 = 
	`cú_ch¬buf_ü—‹
();

703 
h
->
outbufšdex
 = 0;

705 
	`cú_ch¬buf_­³nd
(
h
->
outbuf
, ((cÚ¡ *)
p
)+
»s
, 
Ëngth
-res);

707 
	}
}

710 
	$cú_ouut_is_³ndšg
(
cú
 *
h
)

712 (
h
 !ğ
NULL
 && h->
outbuf
 !ğNULL && h->
outbufšdex
 < h->outbuf->
Ëngth
);

713 
	}
}

715 
cú_ch¬buf
 *

716 
	$cú_g¿b_bufã»d_ouut
(
cú
 *
h
)

718 ià(
	`cú_ouut_is_³ndšg
(
h
è&& h->
outbufšdex
 == 0) {

719 
cú_ch¬buf
 *
ªs
 = 
h
->
outbuf
;

720 
h
->
outbuf
 = 
NULL
;

721 (
ªs
);

723 (
NULL
);

724 
	}
}

727 
	$cú_»äesh_š‹»¡
(
cú
 *
h
, 
ex´es£d_š‹»¡
 *
š‹»¡
)

729 
»s
;

730 ià(
š‹»¡
->
magic
 != 0x7059e5f4) {

731 
	`cú_gre
(
š‹»¡
);

734 ià(
š‹»¡
->
out¡ªdšg
 < iÁ”e¡->
rg‘
) {

735 
»s
 = 
	`cú_put
(
h
, 
š‹»¡
->
š‹»¡_msg
, iÁ”e¡->
size
);

736 ià(
»s
 >= 0) {

737 
š‹»¡
->
out¡ªdšg
 += 1;

738 ià(
h
->
now
.
tv_£c
 == 0)

739 
	`g‘timeofday
(&
h
->
now
, 
NULL
);

740 
š‹»¡
->
Ï¡time
 = 
h
->
now
;

743 
	}
}

746 
	$cú_g‘_cÚ‹Á_ty³
(cÚ¡ *
cúb
,

747 cÚ¡ 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
)

749 
cú_cÚ‹Á_ty³
 
ty³
 = 
pco
->type;

750 ()
cúb
;

751 
ty³
) {

752 
CCN_CONTENT_DATA
:

753 
CCN_CONTENT_ENCR
:

754 
CCN_CONTENT_GONE
:

755 
CCN_CONTENT_KEY
:

756 
CCN_CONTENT_LINK
:

757 
CCN_CONTENT_NACK
:

758  (
ty³
);

762 
	}
}

768 
	$cú_dige¡_CÚ‹Á
(cÚ¡ *
cÚ‹Á_objeù
,

769 
cú_·r£d_CÚ‹ÁObjeù
 *
pc
,

770 *
dige¡
,

771 
size_t
 
dige¡_by‹s
)

773 
»s
;

774 
cú_dige¡
 *
d
 = 
NULL
;

775 cÚ¡ *
cÚ‹Á
 = 
NULL
;

776 
size_t
 
cÚ‹Á_by‹s
 = 0;

778 ià(
pc
->
magic
 < 20080000è
	`abÜt
();

779 ià(
dige¡_by‹s
 =ğ(
dige¡
))

781 
d
 = 
	`cú_dige¡_ü—‹
(
CCN_DIGEST_SHA256
);

782 
	`cú_dige¡_š™
(
d
);

783 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_CÚ‹Á
, 
cÚ‹Á_objeù
,

784 
pc
->
off£t
[
CCN_PCO_B_CÚ‹Á
],

785 
pc
->
off£t
[
CCN_PCO_E_CÚ‹Á
],

786 &
cÚ‹Á
, &
cÚ‹Á_by‹s
);

787 ià(
»s
 < 0è
	`abÜt
();

788 
»s
 = 
	`cú_dige¡_upd©e
(
d
, 
cÚ‹Á
, 
cÚ‹Á_by‹s
);

789 ià(
»s
 < 0è
	`abÜt
();

790 
»s
 = 
	`cú_dige¡_fš®
(
d
, 
dige¡
, 
dige¡_by‹s
);

791 ià(
»s
 < 0è
	`abÜt
();

792 
	`cú_dige¡_de¡roy
(&
d
);

793 
	}
}

796 
	$cú_ÿche_key
(
cú
 *
h
,

797 cÚ¡ *
cúb
, 
size_t
 
size
,

798 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
)

800 
ty³
;

801 
cú_pkey
 **
’Œy
;

802 
hashtb_’um”©Ü
 
“
;

803 
hashtb_’um”©Ü
 *
e
 = &
“
;

804 
»s
;

805 
dige¡
[32];

807 
ty³
 = 
	`cú_g‘_cÚ‹Á_ty³
(
cúb
, 
pco
);

808 ià(
ty³
 !ğ
CCN_CONTENT_KEY
) {

812 
	`cú_dige¡_CÚ‹Á
(
cúb
, 
pco
, 
dige¡
, (digest));

814 
	`hashtb_¡¬t
(
h
->
keys
, 
e
);

815 
»s
 = 
	`hashtb_£ek
(
e
, (*)
dige¡
, (digest), 0);

816 ià(
»s
 < 0) {

817 
	`hashtb_’d
(
e
);

818 (
	`NOTE_ERRNO
(
h
));

820 
’Œy
 = 
e
->
d©a
;

821 ià(
»s
 =ğ
HT_NEW_ENTRY
) {

822 
cú_pkey
 *
pkey
;

823 cÚ¡ *
d©a
 = 
NULL
;

824 
size_t
 
d©a_size
 = 0;

826 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
cúb
, 
size
, 
pco
, &
d©a
, &
d©a_size
);

827 ià(
»s
 < 0) {

828 
	`hashtb_d–‘e
(
e
);

829 
	`hashtb_’d
(
e
);

830 (
	`NOTE_ERRNO
(
h
));

832 
pkey
 = 
	`cú_d2i_pubkey
(
d©a
, 
d©a_size
);

833 ià(
pkey
 =ğ
NULL
) {

834 
	`hashtb_d–‘e
(
e
);

835 
	`hashtb_’d
(
e
);

836 (
	`NOTE_ERRNO
(
h
));

838 *
’Œy
 = 
pkey
;

840 
	`hashtb_’d
(
e
);

842 
	}
}

845 
	$fš®ize_pkey
(
hashtb_’um”©Ü
 *
e
)

847 
cú_pkey
 **
’Œy
 = 
e
->
d©a
;

848 ià(*
’Œy
 !ğ
NULL
)

849 
	`cú_pubkey_ä“
(*
’Œy
);

850 
	}
}

863 
	$cú_loÿ‹_key
(
cú
 *
h
,

864 cÚ¡ *
msg
,

865 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
,

866 
cú_pkey
 **
pubkey
)

868 
»s
;

869 cÚ¡ *
pkeyid
;

870 
size_t
 
pkeyid_size
;

871 
cú_pkey
 **
’Œy
;

872 
cú_buf_decod”
 
decod”
;

873 
cú_buf_decod”
 *
d
;

875 ià(
h
->
keys
 =ğ
NULL
) {

876  (
	`NOTE_ERR
(
h
, 
EINVAL
));

879 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Publish”PublicKeyDige¡
, 
msg
,

880 
pco
->
off£t
[
CCN_PCO_B_Publish”PublicKeyDige¡
],

881 
pco
->
off£t
[
CCN_PCO_E_Publish”PublicKeyDige¡
],

882 &
pkeyid
, &
pkeyid_size
);

883 ià(
»s
 < 0)

884  (
	`NOTE_ERR
(
h
, 
»s
));

885 
’Œy
 = 
	`hashtb_lookup
(
h
->
keys
, 
pkeyid
, 
pkeyid_size
);

886 ià(
’Œy
 !ğ
NULL
) {

887 *
pubkey
 = *
’Œy
;

891 ià(
pco
->
off£t
[
CCN_PCO_B_KeyLoÿtÜ
] =ğpco->off£t[
CCN_PCO_E_KeyLoÿtÜ
])

894 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
msg
 + 
pco
->
off£t
[
CCN_PCO_B_Key_C”tifiÿ‹_KeyName
],

895 
pco
->
off£t
[
CCN_PCO_E_Key_C”tifiÿ‹_KeyName
] -

896 
pco
->
off£t
[
CCN_PCO_B_Key_C”tifiÿ‹_KeyName
]);

897 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_KeyName
)) {

900 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Key
)) {

901 cÚ¡ *
dkey
;

902 
size_t
 
dkey_size
;

903 
cú_dige¡
 *
dige¡
 = 
NULL
;

904 *
key_dige¡
 = 
NULL
;

905 
size_t
 
key_dige¡_size
;

906 
hashtb_’um”©Ü
 
“
;

907 
hashtb_’um”©Ü
 *
e
 = &
“
;

909 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Key
, 
msg
,

910 
pco
->
off£t
[
CCN_PCO_B_Key_C”tifiÿ‹_KeyName
],

911 
pco
->
off£t
[
CCN_PCO_E_Key_C”tifiÿ‹_KeyName
],

912 &
dkey
, &
dkey_size
);

913 *
pubkey
 = 
	`cú_d2i_pubkey
(
dkey
, 
dkey_size
);

914 
dige¡
 = 
	`cú_dige¡_ü—‹
(
CCN_DIGEST_SHA256
);

915 
	`cú_dige¡_š™
(
dige¡
);

916 
key_dige¡_size
 = 
	`cú_dige¡_size
(
dige¡
);

917 
key_dige¡
 = 
	`ÿÎoc
(1, 
key_dige¡_size
);

918 ià(
key_dige¡
 =ğ
NULL
è
	`abÜt
();

919 
»s
 = 
	`cú_dige¡_upd©e
(
dige¡
, 
dkey
, 
dkey_size
);

920 ià(
»s
 < 0è
	`abÜt
();

921 
»s
 = 
	`cú_dige¡_fš®
(
dige¡
, 
key_dige¡
, 
key_dige¡_size
);

922 ià(
»s
 < 0è
	`abÜt
();

923 
	`cú_dige¡_de¡roy
(&
dige¡
);

924 
	`hashtb_¡¬t
(
h
->
keys
, 
e
);

925 
»s
 = 
	`hashtb_£ek
(
e
, (*)
key_dige¡
, 
key_dige¡_size
, 0);

926 
	`ä“
(
key_dige¡
);

927 
key_dige¡
 = 
NULL
;

928 ià(
»s
 < 0) {

929 
	`hashtb_’d
(
e
);

930 (
	`NOTE_ERRNO
(
h
));

932 
’Œy
 = 
e
->
d©a
;

933 ià(
»s
 =ğ
HT_NEW_ENTRY
) {

934 *
’Œy
 = *
pubkey
;

937 
	`THIS_CANNOT_HAPPEN
(
h
);

938 
	`hashtb_’d
(
e
);

941 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_C”tifiÿ‹
)) {

942 
XXX
;

946 
	}
}

954 
	$cú_­³nd_lšk_Çme
(
cú_ch¬buf
 *
Çme
, cÚ¡ *
d©a
, 
size_t
 
d©a_size
)

956 
cú_buf_decod”
 
decod”
;

957 
cú_buf_decod”
 *
d
;

958 
size_t
 
¡¬t
 = 0;

959 
size_t
 
’d
 = 0;

961 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
d©a
, 
d©a_size
);

962 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Lšk
)) {

963 
	`cú_buf_advªû
(
d
);

964 
¡¬t
 = 
d
->
decod”
.
tok’_šdex
;

965 
	`cú_·r£_Name
(
d
, 
NULL
);

966 
’d
 = 
d
->
decod”
.
tok’_šdex
;

967 
	`cú_buf_check_şo£
(
d
);

968 ià(
d
->
decod”
.
¡©e
 < 0)

969  (
d
->
decod”
.
¡©e
);

970 
	`cú_ch¬buf_­³nd
(
Çme
, 
d©a
 + 
¡¬t
, 
’d
 - start);

974 
	}
}

982 
cú_upÿÎ_»s


983 
	$hªdË_key
(
cú_şosu»
 *
£lå
,

984 
cú_upÿÎ_kšd
 
kšd
,

985 
cú_upÿÎ_šfo
 *
šfo
)

987 
cú
 *
h
 = 
šfo
->h;

988 ()
h
;

989 
ty³
 = 0;

990 cÚ¡ *
msg
 = 
NULL
;

991 cÚ¡ *
d©a
 = 
NULL
;

992 
size_t
 
size
;

993 
size_t
 
d©a_size
;

994 
»s
;

995 
cú_ch¬buf
 *
Çme
 = 
NULL
;

997 
kšd
) {

998 
CCN_UPCALL_FINAL
:

999 
	`ä“
(
£lå
);

1000 (
CCN_UPCALL_RESULT_OK
);

1001 
CCN_UPCALL_INTEREST_TIMED_OUT
:

1003 (
CCN_UPCALL_RESULT_OK
);

1004 
CCN_UPCALL_CONTENT
:

1005 
ty³
 = 
	`cú_g‘_cÚ‹Á_ty³
(
msg
, 
šfo
->
pco
);

1006 ià(
ty³
 =ğ
CCN_CONTENT_KEY
)

1007 (
CCN_UPCALL_RESULT_OK
);

1008 ià(
ty³
 =ğ
CCN_CONTENT_LINK
) {

1011 
msg
 = 
šfo
->
cÚ‹Á_cúb
;

1012 
size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

1013 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
šfo
->
cÚ‹Á_cúb
, 
size
, info->
pco
,

1014 &
d©a
, &
d©a_size
);

1015 ià(
»s
 < 0)

1016  (
CCN_UPCALL_RESULT_ERR
);

1017 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

1018 
»s
 = 
	`cú_­³nd_lšk_Çme
(
Çme
, 
d©a
, 
d©a_size
);

1019 ià(
»s
 < 0)

1020  (
CCN_UPCALL_RESULT_ERR
);

1021 
»s
 = 
	`cú_ex´ess_š‹»¡
(
h
, 
Çme
, 
£lå
, 
NULL
);

1022 
	`cú_ch¬buf_de¡roy
(&
Çme
);

1023 (
»s
);

1025  (
CCN_UPCALL_RESULT_ERR
);

1026 
CCN_UPCALL_CONTENT_UNVERIFIED
:

1027 
ty³
 = 
	`cú_g‘_cÚ‹Á_ty³
(
msg
, 
šfo
->
pco
);

1028 ià(
ty³
 =ğ
CCN_CONTENT_KEY
)

1029 (
CCN_UPCALL_RESULT_OK
);

1030 (
CCN_UPCALL_RESULT_VERIFY
);

1032  (
CCN_UPCALL_RESULT_ERR
);

1034 
	}
}

1037 
	$cú_š™Ÿ‹_key_ãtch
(
cú
 *
h
,

1038 *
msg
,

1039 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
,

1040 
ex´es£d_š‹»¡
 *
Œigg”_š‹»¡
)

1047 
»s
;

1048 
Çm–’
;

1049 
cú_ch¬buf
 *
key_Çme
 = 
NULL
;

1050 
cú_şosu»
 *
key_şosu»
 = 
NULL
;

1051 cÚ¡ *
pkeyid
 = 
NULL
;

1052 
size_t
 
pkeyid_size
 = 0;

1053 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

1055 ià(
Œigg”_š‹»¡
 !ğ
NULL
) {

1057 ià(
Œigg”_š‹»¡
->
wª‹d_pub
 =ğ
NULL
)

1058 
Œigg”_š‹»¡
->
wª‹d_pub
 = 
	`cú_ch¬buf_ü—‹
();

1059 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Publish”PublicKeyDige¡
, 
msg
,

1060 
pco
->
off£t
[
CCN_PCO_B_Publish”PublicKeyDige¡
],

1061 
pco
->
off£t
[
CCN_PCO_E_Publish”PublicKeyDige¡
],

1062 &
pkeyid
, &
pkeyid_size
);

1063 ià(
Œigg”_š‹»¡
->
wª‹d_pub
 !ğ
NULL
 && 
»s
 >= 0) {

1064 
Œigg”_š‹»¡
->
wª‹d_pub
->
Ëngth
 = 0;

1065 
	`cú_ch¬buf_­³nd
(
Œigg”_š‹»¡
->
wª‹d_pub
, 
pkeyid
, 
pkeyid_size
);

1067 
Œigg”_š‹»¡
->
rg‘
 = 0;

1070 
Çm–’
 = (
pco
->
off£t
[
CCN_PCO_E_KeyName_Name
] -

1071 
pco
->
off£t
[
CCN_PCO_B_KeyName_Name
]);

1076 ià(
Çm–’
 == 0)

1078 
key_şosu»
 = 
	`ÿÎoc
(1, (*key_closure));

1079 ià(
key_şosu»
 =ğ
NULL
)

1080  (
	`NOTE_ERRNO
(
h
));

1081 
key_şosu»
->
p
 = &
hªdË_key
;

1083 
key_Çme
 = 
	`cú_ch¬buf_ü—‹
();

1084 
»s
 = 
	`cú_ch¬buf_­³nd
(
key_Çme
,

1085 
msg
 + 
pco
->
off£t
[
CCN_PCO_B_KeyName_Name
],

1086 
Çm–’
);

1087 ià(
pco
->
off£t
[
CCN_PCO_B_KeyName_Pub
] <…co->off£t[
CCN_PCO_E_KeyName_Pub
]) {

1088 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

1089 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

1090 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

1091 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

1092 
	`cú_ch¬buf_­³nd
(
‹m¶
,

1093 
msg
 + 
pco
->
off£t
[
CCN_PCO_B_KeyName_Pub
],

1094 (
pco
->
off£t
[
CCN_PCO_E_KeyName_Pub
] -

1095 
pco
->
off£t
[
CCN_PCO_B_KeyName_Pub
]));

1096 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

1098 
»s
 = 
	`cú_ex´ess_š‹»¡
(
h
, 
key_Çme
, 
key_şosu»
, 
‹m¶
);

1099 
	`cú_ch¬buf_de¡roy
(&
key_Çme
);

1100 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

1101 (
»s
);

1102 
	}
}

1109 
	$cú_check_pub_¬riv®
(
cú
 *
h
, 
ex´es£d_š‹»¡
 *
š‹»¡
)

1111 
cú_ch¬buf
 *
wªt
 = 
š‹»¡
->
wª‹d_pub
;

1112 ià(
wªt
 =ğ
NULL
)

1114 ià(
	`hashtb_lookup
(
h
->
keys
, 
wªt
->
buf
, wªt->
Ëngth
è!ğ
NULL
) {

1115 
	`cú_ch¬buf_de¡roy
(&
š‹»¡
->
wª‹d_pub
);

1116 
š‹»¡
->
rg‘
 = 1;

1117 
	`cú_»äesh_š‹»¡
(
h
, 
š‹»¡
);

1119 
	}
}

1130 
	$cú_di¥©ch_mes§ge
(
cú
 *
h
, *
msg
, 
size_t
 
size
)

1132 
cú_·r£d_š‹»¡
 
pi
 = {0};

1133 
cú_upÿÎ_šfo
 
šfo
 = {0};

1134 
i
;

1135 
»s
;

1136 
cú_upÿÎ_»s
 
u»s
;

1138 
h
->
ruÂšg
++;

1139 
šfo
.
h
 = h;

1140 
šfo
.
pi
 = &pi;

1141 
šfo
.
š‹»¡_comps
 = 
	`cú_šdexbuf_obš
(
h
);

1142 
»s
 = 
	`cú_·r£_š‹»¡
(
msg
, 
size
, &
pi
, 
šfo
.
š‹»¡_comps
);

1143 ià(
»s
 >= 0) {

1145 
cú_upÿÎ_kšd
 
upÿÎ_kšd
 = 
CCN_UPCALL_INTEREST
;

1146 
šfo
.
š‹»¡_cúb
 = 
msg
;

1147 ià(
h
->
š‹»¡_f‹rs
 !ğ
NULL
 && 
šfo
.
š‹»¡_comps
->
n
 > 0) {

1148 
cú_šdexbuf
 *
comps
 = 
šfo
.
š‹»¡_comps
;

1149 
size_t
 
key¡¬t
 = 
comps
->
buf
[0];

1150 *
key
 = 
msg
 + 
key¡¬t
;

1151 
š‹»¡_f‹r
 *
’Œy
;

1152 
i
 = 
comps
->
n
 - 1; i >= 0; i--) {

1153 
’Œy
 = 
	`hashtb_lookup
(
h
->
š‹»¡_f‹rs
, 
key
, 
comps
->
buf
[
i
] - 
key¡¬t
);

1154 ià(
’Œy
 !ğ
NULL
) {

1155 
šfo
.
m©ched_comps
 = 
i
;

1156 
u»s
 = (
’Œy
->
aùiÚ
->
p
)ÓÁry->aùiÚ, 
upÿÎ_kšd
, &
šfo
);

1157 ià(
u»s
 =ğ
CCN_UPCALL_RESULT_INTEREST_CONSUMED
)

1158 
upÿÎ_kšd
 = 
CCN_UPCALL_CONSUMED_INTEREST
;

1165 
cú_·r£d_CÚ‹ÁObjeù
 
obj
 = {0};

1166 
šfo
.
pco
 = &
obj
;

1167 
šfo
.
cÚ‹Á_comps
 = 
	`cú_šdexbuf_ü—‹
();

1168 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
msg
, 
size
, &
obj
, 
šfo
.
cÚ‹Á_comps
);

1169 ià(
»s
 >= 0) {

1170 
šfo
.
cÚ‹Á_cúb
 = 
msg
;

1171 ià(
h
->
š‹»¡s_by_´efix
 !ğ
NULL
) {

1172 
cú_šdexbuf
 *
comps
 = 
šfo
.
cÚ‹Á_comps
;

1173 
size_t
 
key¡¬t
 = 
comps
->
buf
[0];

1174 *
key
 = 
msg
 + 
key¡¬t
;

1175 
ex´es£d_š‹»¡
 *
š‹»¡
 = 
NULL
;

1176 
š‹»¡s_by_´efix
 *
’Œy
 = 
NULL
;

1177 
i
 = 
comps
->
n
 - 1; i >= 0; i--) {

1178 
’Œy
 = 
	`hashtb_lookup
(
h
->
š‹»¡s_by_´efix
, 
key
, 
comps
->
buf
[
i
] - 
key¡¬t
);

1179 ià(
’Œy
 !ğ
NULL
) {

1180 
š‹»¡
 = 
’Œy
->
li¡
; iÁ”e¡ !ğ
NULL
; iÁ”e¡ = iÁ”e¡->
Ãxt
) {

1181 ià(
š‹»¡
->
magic
 != 0x7059e5f4) {

1182 
	`cú_gre
(
š‹»¡
);

1184 ià(
š‹»¡
->
rg‘
 > 0 && iÁ”e¡->
out¡ªdšg
 > 0) {

1185 
»s
 = 
	`cú_·r£_š‹»¡
(
š‹»¡
->
š‹»¡_msg
,

1186 
š‹»¡
->
size
,

1187 
šfo
.
pi
,

1188 
šfo
.
š‹»¡_comps
);

1189 ià(
»s
 >= 0 &&

1190 
	`cú_cÚ‹Á_m©ches_š‹»¡
(
msg
, 
size
,

1191 1, 
šfo
.
pco
,

1192 
š‹»¡
->
š‹»¡_msg
,

1193 
š‹»¡
->
size
,

1194 
šfo
.
pi
)) {

1195 
cú_upÿÎ_kšd
 
upÿÎ_kšd
 = 
CCN_UPCALL_CONTENT
;

1196 
cú_pkey
 *
pubkey
 = 
NULL
;

1197 
ty³
 = 
	`cú_g‘_cÚ‹Á_ty³
(
msg
, 
šfo
.
pco
);

1198 ià(
ty³
 =ğ
CCN_CONTENT_KEY
)

1199 
»s
 = 
	`cú_ÿche_key
(
h
, 
msg
, 
size
, 
šfo
.
pco
);

1200 
»s
 = 
	`cú_loÿ‹_key
(
h
, 
msg
, 
šfo
.
pco
, &
pubkey
);

1201 ià(
»s
 == 0) {

1203 
»s
 = 
	`cú_v”ify_sigÇtu»
(
msg
, 
size
, 
šfo
.
pco
, 
pubkey
);

1204 
upÿÎ_kšd
 = (
»s
 =ğ1è? 
CCN_UPCALL_CONTENT
 : 
CCN_UPCALL_CONTENT_BAD
;

1206 
upÿÎ_kšd
 = 
CCN_UPCALL_CONTENT_UNVERIFIED
;

1207 
š‹»¡
->
out¡ªdšg
 -= 1;

1208 
šfo
.
š‹»¡_cúb
 = 
š‹»¡
->
š‹»¡_msg
;

1209 
šfo
.
m©ched_comps
 = 
i
;

1210 
u»s
 = (
š‹»¡
->
aùiÚ
->
p
)(interest->action,

1211 
upÿÎ_kšd
,

1212 &
šfo
);

1213 ià(
š‹»¡
->
magic
 != 0x7059e5f4)

1214 
	`cú_gre
(
š‹»¡
);

1215 ià(
u»s
 =ğ
CCN_UPCALL_RESULT_REEXPRESS
)

1216 
	`cú_»äesh_š‹»¡
(
h
, 
š‹»¡
);

1217 ià(
u»s
 =ğ
CCN_UPCALL_RESULT_VERIFY
 &&

1218 
upÿÎ_kšd
 =ğ
CCN_UPCALL_CONTENT_UNVERIFIED
) {

1219 
	`cú_š™Ÿ‹_key_ãtch
(
h
, 
msg
, 
šfo
.
pco
, 
š‹»¡
);

1221 
š‹»¡
->
rg‘
 = 0;

1222 
	`»¶aû_š‹»¡_msg
(
š‹»¡
, 
NULL
);

1223 
	`cú_»¶aû_hªdËr
(
h
, &(
š‹»¡
->
aùiÚ
), 
NULL
);

1233 
	`cú_šdexbuf_»Ëa£
(
h
, 
šfo
.
š‹»¡_comps
);

1234 
	`cú_šdexbuf_de¡roy
(&
šfo
.
cÚ‹Á_comps
);

1235 
h
->
ruÂšg
--;

1236 
	}
}

1239 
	$cú_´oûss_šput
(
cú
 *
h
)

1241 
ssize_t
 
»s
;

1242 
ssize_t
 
msg¡¬t
;

1243 *
buf
;

1244 
cú_sk–‘Ú_decod”
 *
d
 = &
h
->
decod”
;

1245 
cú_ch¬buf
 *
šbuf
 = 
h
->inbuf;

1246 ià(
šbuf
 =ğ
NULL
)

1247 
h
->
šbuf
 = inbuàğ
	`cú_ch¬buf_ü—‹
();

1248 ià(
šbuf
->
Ëngth
 == 0)

1249 
	`mem£t
(
d
, 0, (*d));

1250 
buf
 = 
	`cú_ch¬buf_»£rve
(
šbuf
, 8800);

1251 
»s
 = 
	`»ad
(
h
->
sock
, 
buf
, 
šbuf
->
lim™
 - inbuf->
Ëngth
);

1252 ià(
»s
 == 0) {

1253 
	`cú_discÚÃù
(
h
);

1256 ià(
»s
 == -1) {

1257 ià(
”ºo
 =ğ
EAGAIN
)

1258 
»s
 = 0;

1260 (
	`NOTE_ERRNO
(
h
));

1262 
šbuf
->
Ëngth
 +ğ
»s
;

1263 
msg¡¬t
 = 0;

1264 
	`cú_sk–‘Ú_decode
(
d
, 
buf
, 
»s
);

1265 
d
->
¡©e
 == 0) {

1266 
	`cú_di¥©ch_mes§ge
(
h
, 
šbuf
->
buf
 + 
msg¡¬t
,

1267 
d
->
šdex
 - 
msg¡¬t
);

1268 
msg¡¬t
 = 
d
->
šdex
;

1269 ià(
msg¡¬t
 =ğ
šbuf
->
Ëngth
) {

1270 
šbuf
->
Ëngth
 = 0;

1273 
	`cú_sk–‘Ú_decode
(
d
, 
šbuf
->
buf
 + d->
šdex
,

1274 
šbuf
->
Ëngth
 - 
d
->
šdex
);

1276 ià(
msg¡¬t
 < 
šbuf
->
Ëngth
 && msgstart > 0) {

1278 
	`memmove
(
šbuf
->
buf
, inbuf->buà+ 
msg¡¬t
,

1279 
šbuf
->
Ëngth
 - 
msg¡¬t
);

1280 
šbuf
->
Ëngth
 -ğ
msg¡¬t
;

1281 
d
->
šdex
 -ğ
msg¡¬t
;

1284 
	}
}

1287 
	$cú_upd©e_»äesh_us
(
cú
 *
h
, 
timev®
 *
tv
)

1289 
d–
;

1290 ià(
tv
->
tv_£c
 < 
h
->
now
.tv_sec)

1292 ià(
tv
->
tv_£c
 > 
h
->
now
.tv_£ø+ 
CCN_INTEREST_LIFETIME_SEC
)

1294 
d–
 = (
tv
->
tv_£c
 - 
h
->
now
.tv_sec)*1000000 +

1295 (
tv
->
tv_u£c
 - 
h
->
now
.tv_usec);

1296 ià(
d–
 < 0)

1297 
d–
 = 0;

1298 ià(
d–
 < 
h
->
»äesh_us
)

1299 
h
->
»äesh_us
 = 
d–
;

1300 
	}
}

1303 
	$cú_age_š‹»¡
(
cú
 *
h
,

1304 
ex´es£d_š‹»¡
 *
š‹»¡
,

1305 cÚ¡ *
key
, 
size_t
 
keysize
)

1307 
cú_·r£d_š‹»¡
 
pi
 = {0};

1308 
cú_upÿÎ_šfo
 
šfo
 = {0};

1309 
d–
;

1310 
»s
;

1311 
cú_upÿÎ_»s
 
u»s
;

1312 
fœ¡ÿÎ
;

1313 ià(
š‹»¡
->
magic
 != 0x7059e5f4)

1314 
	`cú_gre
(
š‹»¡
);

1315 
šfo
.
h
 = h;

1316 
šfo
.
pi
 = &pi;

1317 
fœ¡ÿÎ
 = (
š‹»¡
->
Ï¡time
.
tv_£c
 == 0);

1318 ià(
š‹»¡
->
Ï¡time
.
tv_£c
 + 30 < 
h
->
now
.tv_sec) {

1320 
š‹»¡
->
out¡ªdšg
 = 0;

1321 
š‹»¡
->
Ï¡time
 = 
h
->
now
;

1322 
š‹»¡
->
Ï¡time
.
tv_£c
 -= 30;

1324 
d–
 = (
h
->
now
.
tv_£c
 - 
š‹»¡
->
Ï¡time
.tv_sec)*1000000 +

1325 (
h
->
now
.
tv_u£c
 - 
š‹»¡
->
Ï¡time
.tv_usec);

1326 ià(
d–
 >ğ
š‹»¡
->
liãtime_us
) {

1327 
š‹»¡
->
out¡ªdšg
 = 0;

1328 
d–
 = 0;

1330 ià(
d–
 < 0)

1331 
d–
 = 0;

1332 ià(
š‹»¡
->
liãtime_us
 - 
d–
 < 
h
->
»äesh_us
)

1333 
h
->
»äesh_us
 = 
š‹»¡
->
liãtime_us
 - 
d–
;

1334 
š‹»¡
->
Ï¡time
 = 
h
->
now
;

1335 
d–
 > 
š‹»¡
->
Ï¡time
.
tv_u£c
) {

1336 
d–
 -= 1000000;

1337 
š‹»¡
->
Ï¡time
.
tv_£c
 -= 1;

1339 
š‹»¡
->
Ï¡time
.
tv_u£c
 -ğ
d–
;

1340 ià(
š‹»¡
->
rg‘
 > 0 && iÁ”e¡->
out¡ªdšg
 == 0) {

1341 
u»s
 = 
CCN_UPCALL_RESULT_REEXPRESS
;

1342 ià(!
fœ¡ÿÎ
) {

1343 
šfo
.
š‹»¡_cúb
 = 
š‹»¡
->
š‹»¡_msg
;

1344 
šfo
.
š‹»¡_comps
 = 
	`cú_šdexbuf_obš
(
h
);

1345 
»s
 = 
	`cú_·r£_š‹»¡
(
š‹»¡
->
š‹»¡_msg
,

1346 
š‹»¡
->
size
,

1347 
šfo
.
pi
,

1348 
šfo
.
š‹»¡_comps
);

1349 ià(
»s
 >= 0) {

1350 
u»s
 = (
š‹»¡
->
aùiÚ
->
p
)(interest->action,

1351 
CCN_UPCALL_INTEREST_TIMED_OUT
,

1352 &
šfo
);

1353 ià(
š‹»¡
->
magic
 != 0x7059e5f4)

1354 
	`cú_gre
(
š‹»¡
);

1357 
i
;

1358 
	`årštf
(
¡d”r
, "URP!! iÁ”e¡ ha b“ÀcÜru±ed cú_ş›Á.c:%d\n", 
__LINE__
);

1359 
i
 = 0; i < 120; i++)

1360 
	`¦“p
(1);

1361 
u»s
 = 
CCN_UPCALL_RESULT_ERR
;

1363 
	`cú_šdexbuf_»Ëa£
(
h
, 
šfo
.
š‹»¡_comps
);

1365 ià(
u»s
 =ğ
CCN_UPCALL_RESULT_REEXPRESS
)

1366 
	`cú_»äesh_š‹»¡
(
h
, 
š‹»¡
);

1368 
š‹»¡
->
rg‘
 = 0;

1370 
	}
}

1373 
	$cú_ş—n_®l_š‹»¡s
(
cú
 *
h
)

1375 
hashtb_’um”©Ü
 
“
;

1376 
hashtb_’um”©Ü
 *
e
 = &
“
;

1377 
š‹»¡s_by_´efix
 *
’Œy
;

1378 
	`hashtb_¡¬t
(
h
->
š‹»¡s_by_´efix
, 
e
);ƒ->
d©a
 !ğ
NULL
;) {

1379 
’Œy
 = 
e
->
d©a
;

1380 
	`cú_ş—n_š‹»¡s_by_´efix
(
h
, 
’Œy
);

1381 ià(
’Œy
->
li¡
 =ğ
NULL
)

1382 
	`hashtb_d–‘e
(
e
);

1384 
	`hashtb_Ãxt
(
e
);

1386 
	`hashtb_’d
(
e
);

1387 
	}
}

1390 
	$cú_nÙify_cúdid_chªged
(
cú
 *
h
)

1392 
hashtb_’um”©Ü
 
“
;

1393 
hashtb_’um”©Ü
 *
e
 = &
“
;

1394 ià(
h
->
š‹»¡_f‹rs
 !ğ
NULL
) {

1395 
	`hashtb_¡¬t
(
h
->
š‹»¡_f‹rs
, 
e
);ƒ->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

1396 
š‹»¡_f‹r
 *
i
 = 
e
->
d©a
;

1397 ià((
i
->
æags
 & 
CCN_FORW_WAITING_CCNDID
) != 0) {

1398 
i
->
expœy
 = 
h
->
now
;

1399 
i
->
æags
 &ğ~
CCN_FORW_WAITING_CCNDID
;

1402 
	`hashtb_’d
(
e
);

1404 
	}
}

1414 
	$cú_´oûss_scheduËd_İ”©iÚs
(
cú
 *
h
)

1416 
hashtb_’um”©Ü
 
“
;

1417 
hashtb_’um”©Ü
 *
e
 = &
“
;

1418 
š‹»¡s_by_´efix
 *
’Œy
;

1419 
ex´es£d_š‹»¡
 *
›
;

1420 
Ãed_ş—n
 = 0;

1421 
h
->
»äesh_us
 = 5 * 
CCN_INTEREST_LIFETIME_MICROSEC
;

1422 
	`g‘timeofday
(&
h
->
now
, 
NULL
);

1423 ià(
	`cú_ouut_is_³ndšg
(
h
))

1424 (
h
->
»äesh_us
);

1425 
h
->
ruÂšg
++;

1426 ià(
h
->
š‹»¡_f‹rs
 !ğ
NULL
) {

1427 
	`hashtb_¡¬t
(
h
->
š‹»¡_f‹rs
, 
e
);ƒ->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

1428 
š‹»¡_f‹r
 *
i
 = 
e
->
d©a
;

1429 ià(
	`tv_—¾›r
(&
i
->
expœy
, &
h
->
now
)) {

1431 
	`cú_š™Ÿ‹_´efix_»g
(
h
, 
e
->
key
,ƒ->
keysize
, 
i
);

1434 
	`cú_upd©e_»äesh_us
(
h
, &
i
->
expœy
);

1436 
	`hashtb_’d
(
e
);

1438 ià(
h
->
š‹»¡s_by_´efix
 !ğ
NULL
) {

1439 
	`hashtb_¡¬t
(
h
->
š‹»¡s_by_´efix
, 
e
);ƒ->
d©a
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

1440 
’Œy
 = 
e
->
d©a
;

1441 
	`cú_check_š‹»¡s
(
’Œy
->
li¡
);

1442 ià(
’Œy
->
li¡
 =ğ
NULL
)

1443 
Ãed_ş—n
 = 1;

1445 
›
 = 
’Œy
->
li¡
; i!ğ
NULL
; iğ›->
Ãxt
) {

1446 
	`cú_check_pub_¬riv®
(
h
, 
›
);

1447 ià(
›
->
rg‘
 != 0)

1448 
	`cú_age_š‹»¡
(
h
, 
›
, 
e
->
key
,ƒ->
keysize
);

1449 ià(
›
->
rg‘
 =ğ0 && ie->
wª‹d_pub
 =ğ
NULL
) {

1450 
	`cú_»¶aû_hªdËr
(
h
, &(
›
->
aùiÚ
), 
NULL
);

1451 
	`»¶aû_š‹»¡_msg
(
›
, 
NULL
);

1452 
Ãed_ş—n
 = 1;

1457 
	`hashtb_’d
(
e
);

1458 ià(
Ãed_ş—n
)

1459 
	`cú_ş—n_®l_š‹»¡s
(
h
);

1461 
h
->
ruÂšg
--;

1462 (
h
->
»äesh_us
);

1463 
	}
}

1475 
	$cú_£t_run_timeout
(
cú
 *
h
, 
timeout
)

1477 
ªs
 = 
h
->
timeout
;

1478 
h
->
timeout
 =imeout;

1479 (
ªs
);

1480 
	}
}

1491 
	$cú_run
(
cú
 *
h
, 
timeout
)

1493 
timev®
 
¡¬t
;

1494 
pŞlfd
 
fds
[1];

1495 
miüo£c
;

1496 
mli£c
;

1497 
»s
 = -1;

1498 ià(
h
->
ruÂšg
 != 0)

1499 (
	`NOTE_ERR
(
h
, 
EBUSY
));

1500 
	`mem£t
(
fds
, 0, (fds));

1501 
	`mem£t
(&
¡¬t
, 0, (start));

1502 
h
->
timeout
 =imeout;

1504 ià(
h
->
sock
 == -1) {

1505 
»s
 = -1;

1508 
miüo£c
 = 
	`cú_´oûss_scheduËd_İ”©iÚs
(
h
);

1509 
timeout
 = 
h
->timeout;

1510 ià(
¡¬t
.
tv_£c
 == 0)

1511 
¡¬t
 = 
h
->
now
;

1512 ià(
timeout
 >= 0) {

1513 
mli£c
 = (
h
->
now
.
tv_£c
 - 
¡¬t
.tv_sec) *1000 +

1514 (
h
->
now
.
tv_u£c
 - 
¡¬t
.tv_usec)/1000;

1515 ià(
mli£c
 > 
timeout
) {

1516 
»s
 = 0;

1520 
fds
[0].
fd
 = 
h
->
sock
;

1521 
fds
[0].
ev’ts
 = 
POLLIN
;

1522 ià(
	`cú_ouut_is_³ndšg
(
h
))

1523 
fds
[0].
ev’ts
 |ğ
POLLOUT
;

1524 
mli£c
 = 
miüo£c
 / 1000;

1525 ià(
timeout
 >ğ0 &&imeouˆ< 
mli£c
)

1526 
mli£c
 = 
timeout
;

1527 
»s
 = 
	`pŞl
(
fds
, 1, 
mli£c
);

1528 ià(
»s
 < 0 && 
”ºo
 !ğ
EINTR
) {

1529 
»s
 = 
	`NOTE_ERRNO
(
h
);

1532 ià(
»s
 > 0) {

1533 ià((
fds
[0].
»v’ts
 | 
POLLOUT
) != 0)

1534 
	`cú_pushout
(
h
);

1535 ià((
fds
[0].
»v’ts
 | 
POLLIN
) != 0)

1536 
	`cú_´oûss_šput
(
h
);

1538 ià(
h
->
”r
 =ğ
ENOTCONN
)

1539 
	`cú_discÚÃù
(
h
);

1540 ià(
h
->
timeout
 == 0)

1543 ià(
h
->
ruÂšg
 != 0)

1544 
	`abÜt
();

1545 ((
»s
 < 0) ?„es : 0);

1546 
	}
}

1549 
	ssim¶e_g‘_d©a
 {

1550 
cú_şosu»
 
	mşosu»
;

1551 
cú_ch¬buf
 *
	m»suÉbuf
;

1552 
cú_·r£d_CÚ‹ÁObjeù
 *
	mpcobuf
;

1553 
cú_šdexbuf
 *
	mcompsbuf
;

1554 
	mæags
;

1555 
	m»s
;

1558 
cú_upÿÎ_»s


1559 
	$hªdË_sim¶e_šcomšg_cÚ‹Á
(

1560 
cú_şosu»
 *
£lå
,

1561 
cú_upÿÎ_kšd
 
kšd
,

1562 
cú_upÿÎ_šfo
 *
šfo
)

1564 
sim¶e_g‘_d©a
 *
md
 = 
£lå
->
d©a
;

1565 
cú
 *
h
 = 
šfo
->h;

1567 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

1568 ià(
£lå
 !ğ&
md
->
şosu»
)

1569 
	`abÜt
();

1570 
	`ä“
(
md
);

1571 (
CCN_UPCALL_RESULT_OK
);

1573 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

1574 (
£lå
->
štd©a
 ? 
CCN_UPCALL_RESULT_REEXPRESS
 : 
CCN_UPCALL_RESULT_OK
);

1575 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_UNVERIFIED
) {

1576 ià((
md
->
æags
 & 
CCN_GET_NOKEYWAIT
) == 0)

1577 (
CCN_UPCALL_RESULT_VERIFY
);

1579 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
)

1580 (
CCN_UPCALL_RESULT_ERR
);

1581 ià(
md
->
»suÉbuf
 !ğ
NULL
) {

1582 
md
->
»suÉbuf
->
Ëngth
 = 0;

1583 
	`cú_ch¬buf_­³nd
(
md
->
»suÉbuf
,

1584 
šfo
->
cÚ‹Á_cúb
, info->
pco
->
off£t
[
CCN_PCO_E
]);

1586 ià(
md
->
pcobuf
 !ğ
NULL
)

1587 
	`memıy
(
md
->
pcobuf
, 
šfo
->
pco
, (*md->pcobuf));

1588 ià(
md
->
compsbuf
 !ğ
NULL
) {

1589 
md
->
compsbuf
->
n
 = 0;

1590 
	`cú_šdexbuf_­³nd
(
md
->
compsbuf
,

1591 
šfo
->
cÚ‹Á_comps
->
buf
, info->cÚ‹Á_comps->
n
);

1593 
md
->
»s
 = 0;

1594 
	`cú_£t_run_timeout
(
h
, 0);

1595 (
CCN_UPCALL_RESULT_OK
);

1596 
	}
}

1618 
	$cú_g‘
(
cú
 *
h
,

1619 
cú_ch¬buf
 *
Çme
,

1620 
cú_ch¬buf
 *
š‹»¡_‹m¶©e
,

1621 
timeout_ms
,

1622 
cú_ch¬buf
 *
»suÉbuf
,

1623 
cú_·r£d_CÚ‹ÁObjeù
 *
pcobuf
,

1624 
cú_šdexbuf
 *
compsbuf
,

1625 
æags
)

1627 
cú
 *
Üig_h
 = 
h
;

1628 
hashtb
 *
§ved_keys
 = 
NULL
;

1629 
»s
;

1630 
sim¶e_g‘_d©a
 *
md
;

1632 ià((
æags
 & ~(()
CCN_GET_NOKEYWAIT
)) != 0)

1634 ià(
h
 =ğ
NULL
 || h->
ruÂšg
) {

1635 
h
 = 
	`cú_ü—‹
();

1636 ià(
h
 =ğ
NULL
)

1638 ià(
Üig_h
 !ğ
NULL
) {

1639 
§ved_keys
 = 
h
->
keys
;

1640 
h
->
keys
 = 
Üig_h
->keys;

1642 
»s
 = 
	`cú_cÚÃù
(
h
, 
NULL
);

1643 ià(
»s
 < 0) {

1644 
	`cú_de¡roy
(&
h
);

1648 
md
 = 
	`ÿÎoc
(1, (*md));

1649 
md
->
»suÉbuf
 =„esultbuf;

1650 
md
->
pcobuf
 =…cobuf;

1651 
md
->
compsbuf
 = compsbuf;

1652 
md
->
æags
 = flags;

1653 
md
->
»s
 = -1;

1654 
md
->
şosu»
.
p
 = &
hªdË_sim¶e_šcomšg_cÚ‹Á
;

1655 
md
->
şosu»
.
d©a
 = md;

1656 
md
->
şosu»
.
štd©a
 = 1;

1657 
md
->
şosu»
.
»fcouÁ
 = 1;

1658 
»s
 = 
	`cú_ex´ess_š‹»¡
(
h
, 
Çme
, &
md
->
şosu»
, 
š‹»¡_‹m¶©e
);

1659 ià(
»s
 >= 0)

1660 
»s
 = 
	`cú_run
(
h
, 
timeout_ms
);

1661 ià(
»s
 >= 0)

1662 
»s
 = 
md
->res;

1663 
md
->
»suÉbuf
 = 
NULL
;

1664 
md
->
pcobuf
 = 
NULL
;

1665 
md
->
compsbuf
 = 
NULL
;

1666 
md
->
şosu»
.
štd©a
 = 0;

1667 
md
->
şosu»
.
»fcouÁ
--;

1668 ià(
md
->
şosu»
.
»fcouÁ
 == 0)

1669 
	`ä“
(
md
);

1670 ià(
h
 !ğ
Üig_h
) {

1671 ià(
§ved_keys
 !ğ
NULL
)

1672 
h
->
keys
 = 
§ved_keys
;

1673 
	`cú_de¡roy
(&
h
);

1675 (
»s
);

1676 
	}
}

1678 
cú_upÿÎ_»s


1679 
	$hªdË_pšg_»¥Ú£
(
cú_şosu»
 *
£lå
,

1680 
cú_upÿÎ_kšd
 
kšd
,

1681 
cú_upÿÎ_šfo
 *
šfo
)

1683 
»s
;

1684 cÚ¡ *
cúdid
 = 
NULL
;

1685 
size_t
 
size
 = 0;

1686 
cú
 *
h
 = 
šfo
->h;

1688 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

1689 
	`ä“
(
£lå
);

1690 (
CCN_UPCALL_RESULT_OK
);

1692 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_UNVERIFIED
)

1693 (
CCN_UPCALL_RESULT_VERIFY
);

1694 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
) {

1695 
	`NOTE_ERR
(
h
, -1000 - 
kšd
);

1696 (
CCN_UPCALL_RESULT_ERR
);

1698 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Publish”PublicKeyDige¡
,

1699 
šfo
->
cÚ‹Á_cúb
,

1700 
šfo
->
pco
->
off£t
[
CCN_PCO_B_Publish”PublicKeyDige¡
],

1701 
šfo
->
pco
->
off£t
[
CCN_PCO_E_Publish”PublicKeyDige¡
],

1702 &
cúdid
,

1703 &
size
);

1704 ià(
»s
 < 0) {

1705 
	`NOTE_ERR
(
h
, -1);

1706 (
CCN_UPCALL_RESULT_ERR
);

1708 ià(
h
->
cúdid
 =ğ
NULL
) {

1709 
h
->
cúdid
 = 
	`cú_ch¬buf_ü—‹
();

1710 ià(
h
->
cúdid
 =ğ
NULL
)

1711 (
	`NOTE_ERRNO
(
h
));

1713 
h
->
cúdid
->
Ëngth
 = 0;

1714 
	`cú_ch¬buf_­³nd
(
h
->
cúdid
, cúdid, 
size
);

1715 
	`cú_nÙify_cúdid_chªged
(
h
);

1716 (
CCN_UPCALL_RESULT_OK
);

1717 
	}
}

1720 
	$cú_š™Ÿ‹_pšg
(
cú
 *
h
)

1722 
cú_ch¬buf
 *
Çme
 = 
NULL
;

1723 
cú_şosu»
 *
aùiÚ
 = 
NULL
;

1725 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

1726 
	`cú_Çme_äom_uri
(
Çme
, "ccnx:/ccnx/ping");

1727 
	`cú_Çme_­³nd_nÚû
(
Çme
);

1728 
aùiÚ
 = 
	`ÿÎoc
(1, (*action));

1729 
aùiÚ
->
p
 = &
hªdË_pšg_»¥Ú£
;

1730 
	`cú_ex´ess_š‹»¡
(
h
, 
Çme
, 
aùiÚ
, 
NULL
);

1731 
	`cú_ch¬buf_de¡roy
(&
Çme
);

1732 
	}
}

1734 
cú_upÿÎ_»s


1735 
	$hªdË_´efix_»g_»¶y
(

1736 
cú_şosu»
 *
£lå
,

1737 
cú_upÿÎ_kšd
 
kšd
,

1738 
cú_upÿÎ_šfo
 *
šfo
)

1740 
cú_»g_şosu»
 *
md
 = 
£lå
->
d©a
;

1741 
cú
 *
h
 = 
šfo
->h;

1742 
liãtime
 = 10;

1743 
cú_fÜw¬dšg_’Œy
 *
ã
 = 
NULL
;

1744 
»s
;

1745 cÚ¡ *
ã_cúb
 = 
NULL
;

1746 
size_t
 
ã_cúb_size
 = 0;

1748 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

1750 ià(
£lå
 !ğ&
md
->
aùiÚ
)

1751 
	`abÜt
();

1752 ià(
md
->
š‹»¡_f‹r
 !ğ
NULL
)

1753 
md
->
š‹»¡_f‹r
->
cú_»g_şosu»
 = 
NULL
;

1754 
£lå
->
d©a
 = 
NULL
;

1755 
	`ä“
(
md
);

1756 (
CCN_UPCALL_RESULT_OK
);

1758 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

1759 (
CCN_UPCALL_RESULT_REEXPRESS
);

1760 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_UNVERIFIED
)

1761 (
CCN_UPCALL_RESULT_VERIFY
);

1762 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
) {

1763 
	`NOTE_ERR
(
h
, -1000 - 
kšd
);

1764 (
CCN_UPCALL_RESULT_ERR
);

1766 
»s
 = 
	`cú_cÚ‹Á_g‘_v®ue
(
šfo
->
cÚ‹Á_cúb
,

1767 
šfo
->
pco
->
off£t
[
CCN_PCO_E
],

1768 
šfo
->
pco
,

1769 &
ã_cúb
, &
ã_cúb_size
);

1770 ià(
»s
 == 0)

1771 
ã
 = 
	`cú_fÜw¬dšg_’Œy_·r£
(
ã_cúb
, 
ã_cúb_size
);

1772 ià(
ã
 =ğ
NULL
) {

1773 
XXX
;

1774 
liãtime
 = 30;

1777 
liãtime
 = 
ã
->lifetime;

1778 ià(
liãtime
 < 0)

1779 
liãtime
 = 0;

1780 ià(
liãtime
 > 3600)

1781 
liãtime
 = 3600;

1782 
md
->
š‹»¡_f‹r
->
expœy
 = 
h
->
now
;

1783 
md
->
š‹»¡_f‹r
->
expœy
.
tv_£c
 +ğ
liãtime
;

1784 
	`cú_fÜw¬dšg_’Œy_de¡roy
(&
ã
);

1785 (
CCN_UPCALL_RESULT_OK
);

1786 
	}
}

1789 
	$cú_š™Ÿ‹_´efix_»g
(
cú
 *
h
,

1790 cÚ¡ *
´efix
, 
size_t
 
´efix_size
,

1791 
š‹»¡_f‹r
 *
i
)

1793 
cú_»g_şosu»
 *
p
 = 
NULL
;

1794 
cú_ch¬buf
 *
»qÇme
 = 
NULL
;

1795 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

1796 
cú_fÜw¬dšg_’Œy
 
ã_¡Üe
 = { 0 };

1797 
cú_fÜw¬dšg_’Œy
 *
ã
 = &
ã_¡Üe
;

1798 
cú_ch¬buf
 *
»g_»que¡
 = 
NULL
;

1799 
cú_ch¬buf
 *
sigÃd_»g_»que¡
 = 
NULL
;

1800 
cú_ch¬buf
 *
em±y
 = 
NULL
;

1802 
i
->
expœy
 = 
h
->
now
;

1803 
i
->
expœy
.
tv_£c
 += 60;

1805 ià(
h
->
sock
 == -1)

1808 ià(
h
->
cúdid
 =ğ
NULL
) {

1809 
	`cú_š™Ÿ‹_pšg
(
h
);

1810 
i
->
æags
 |ğ
CCN_FORW_WAITING_CCNDID
;

1813 ià(
i
->
cú_»g_şosu»
 !ğ
NULL
)

1815 
p
 = 
	`ÿÎoc
(1, (*p));

1816 ià(
p
 =ğ
NULL
) {

1817 
	`NOTE_ERRNO
(
h
);

1820 
p
->
aùiÚ
.
d©a
 =…;

1821 
p
->
aùiÚ
.°ğ&
hªdË_´efix_»g_»¶y
;

1822 
p
->
š‹»¡_f‹r
 = 
i
;

1823 
i
->
cú_»g_şosu»
 = 
p
;

1824 
»qÇme
 = 
	`cú_ch¬buf_ü—‹
();

1825 
	`cú_Çme_äom_uri
(
»qÇme
, "ccnx:/ccnx");

1826 
	`cú_Çme_­³nd
(
»qÇme
, 
h
->
cúdid
->
buf
, h->cúdid->
Ëngth
);

1827 
	`cú_Çme_­³nd_¡r
(
»qÇme
, "selfreg");

1828 
ã
->
aùiÚ
 = "selfreg";

1829 
ã
->
cúd_id
 = 
h
->
cúdid
->
buf
;

1830 
ã
->
cúd_id_size
 = 
h
->
cúdid
->
Ëngth
;

1831 
ã
->
çûid
 = ~0;

1832 
ã
->
Çme_´efix
 = 
	`cú_ch¬buf_ü—‹
();

1833 
ã
->
æags
 = 
i
->flags & 0xFF;

1834 
ã
->
liãtime
 = -1;

1835 
	`cú_Çme_š™
(
ã
->
Çme_´efix
);

1836 
	`cú_Çme_­³nd_compÚ’ts
(
ã
->
Çme_´efix
, 
´efix
, 0, 
´efix_size
);

1837 
»g_»que¡
 = 
	`cú_ch¬buf_ü—‹
();

1838 
	`cúb_­³nd_fÜw¬dšg_’Œy
(
»g_»que¡
, 
ã
);

1839 
em±y
 = 
	`cú_ch¬buf_ü—‹
();

1840 
	`cú_Çme_š™
(
em±y
);

1841 
sigÃd_»g_»que¡
 = 
	`cú_ch¬buf_ü—‹
();

1842 
	`cú_sign_cÚ‹Á
(
h
, 
sigÃd_»g_»que¡
, 
em±y
, 
NULL
,

1843 
»g_»que¡
->
buf
,„eg_»que¡->
Ëngth
);

1844 
	`cú_Çme_­³nd
(
»qÇme
,

1845 
sigÃd_»g_»que¡
->
buf
, sigÃd_»g_»que¡->
Ëngth
);

1847 
	`cú_ex´ess_š‹»¡
(
h
, 
»qÇme
, &
p
->
aùiÚ
, 
‹m¶
);

1848 
	`cú_ch¬buf_de¡roy
(&
ã
->
Çme_´efix
);

1849 
	`cú_ch¬buf_de¡roy
(&
»qÇme
);

1850 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

1851 
	`cú_ch¬buf_de¡roy
(&
»g_»que¡
);

1852 
	`cú_ch¬buf_de¡roy
(&
sigÃd_»g_»que¡
);

1853 
	`cú_ch¬buf_de¡roy
(&
em±y
);

1854 
	}
}

1866 
	$cú_v”ify_cÚ‹Á
(
cú
 *
h
,

1867 cÚ¡ *
msg
,

1868 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
)

1870 
cú_pkey
 *
pubkey
 = 
NULL
;

1871 
»s
;

1872 *
buf
 = (*)
msg
;

1874 
»s
 = 
	`cú_loÿ‹_key
(
h
, 
msg
, 
pco
, &
pubkey
);

1875 ià(
»s
 == 0) {

1877 
»s
 = 
	`cú_v”ify_sigÇtu»
(
buf
, 
pco
->
off£t
[
CCN_PCO_E
],…co, 
pubkey
);

1878 
»s
 = (res == 1) ? 0 : -1;

1880 (
»s
);

1881 
	}
}

1895 
	$cú_lßd_´iv©e_key
(
cú
 *
h
,

1896 cÚ¡ *
key¡Üe_·th
,

1897 cÚ¡ *
key¡Üe_·s¥h¿£
,

1898 
cú_ch¬buf
 *
pubid_out
)

1900 
cú_key¡Üe
 *
key¡Üe
 = 
NULL
;

1901 
»s
 = 0;

1902 
cú_ch¬buf
 *
pubid
 = 
pubid_out
;

1903 
cú_ch¬buf
 *
pubid_¡Üe
 = 
NULL
;

1904 
hashtb_’um”©Ü
 
“
;

1905 
hashtb_’um”©Ü
 *
e
 = &
“
;

1907 ià(
pubid
 =ğ
NULL
)

1908 
pubid
 = 
pubid_¡Üe
 = 
	`cú_ch¬buf_ü—‹
();

1909 ià(
pubid
 =ğ
NULL
) {

1910 
»s
 = 
	`NOTE_ERRNO
(
h
);

1911 
CËªup
;

1913 
key¡Üe
 = 
	`cú_key¡Üe_ü—‹
();

1914 ià(
key¡Üe
 =ğ
NULL
) {

1915 
»s
 = 
	`NOTE_ERRNO
(
h
);

1916 
CËªup
;

1918 
»s
 = 
	`cú_key¡Üe_š™
(
key¡Üe
,

1919 (*)
key¡Üe_·th
,

1920 (*)
key¡Üe_·s¥h¿£
);

1921 ià(
»s
 != 0) {

1922 
»s
 = 
	`NOTE_ERRNO
(
h
);

1923 
CËªup
;

1925 
pubid
->
Ëngth
 = 0;

1926 
	`cú_ch¬buf_­³nd
(
pubid
,

1927 
	`cú_key¡Üe_public_key_dige¡
(
key¡Üe
),

1928 
	`cú_key¡Üe_public_key_dige¡_Ëngth
(
key¡Üe
));

1929 
	`hashtb_¡¬t
(
h
->
key¡Ües
, 
e
);

1930 
»s
 = 
	`hashtb_£ek
(
e
, 
pubid
->
buf
,…ubid->
Ëngth
, 0);

1931 ià(
»s
 =ğ
HT_NEW_ENTRY
) {

1932 
cú_key¡Üe
 **
p
 = 
e
->
d©a
;

1933 *
p
 = 
key¡Üe
;

1934 
key¡Üe
 = 
NULL
;

1935 
»s
 = 0;

1937 ià(
»s
 =ğ
HT_OLD_ENTRY
)

1938 
»s
 = 0;

1940 
»s
 = 
	`NOTE_ERRNO
(
h
);

1941 
	`hashtb_’d
(
e
);

1942 
CËªup
:

1943 
	`cú_ch¬buf_de¡roy
(&
pubid_¡Üe
);

1944 
	`cú_key¡Üe_de¡roy
(&
key¡Üe
);

1945 (
»s
);

1946 
	}
}

1960 
	$cú_lßd_deçuÉ_key
(
cú
 *
h
,

1961 cÚ¡ *
key¡Üe_·th
,

1962 cÚ¡ *
key¡Üe_·s¥h¿£
)

1964 
cú_ch¬buf
 *
deçuÉ_pubid
 = 
NULL
;

1965 
»s
;

1967 ià(
h
->
deçuÉ_pubid
 !ğ
NULL
)

1968 (
	`NOTE_ERR
(
h
, 
EINVAL
));

1969 
deçuÉ_pubid
 = 
	`cú_ch¬buf_ü—‹
();

1970 
»s
 = 
	`cú_lßd_´iv©e_key
(
h
,

1971 
key¡Üe_·th
,

1972 
key¡Üe_·s¥h¿£
,

1973 
deçuÉ_pubid
);

1974 ià(
»s
 == 0)

1975 
h
->
deçuÉ_pubid
 = default_pubid;

1977 
	`cú_ch¬buf_de¡roy
(&
deçuÉ_pubid
);

1978 (
»s
);

1979 
	}
}

1982 
	$fš®ize_key¡Üe
(
hashtb_’um”©Ü
 *
e
)

1984 
cú_key¡Üe
 **
p
 = 
e
->
d©a
;

1985 
	`cú_key¡Üe_de¡roy
(
p
);

1986 
	}
}

1998 
	$cú_g‘_public_key
(
cú
 *
h
,

1999 cÚ¡ 
cú_signšg_·¿ms
 *
·¿ms
,

2000 
cú_ch¬buf
 *
dige¡_»suÉ
,

2001 
cú_ch¬buf
 *
»suÉ
)

2003 
hashtb_’um”©Ü
 
“
;

2004 
hashtb_’um”©Ü
 *
e
 = &
“
;

2005 
cú_key¡Üe
 *
key¡Üe
 = 
NULL
;

2006 
cú_signšg_·¿ms
 
¥
 = 
CCN_SIGNING_PARAMS_INIT
;

2007 
»s
;

2008 
»s
 = 
	`cú_chk_signšg_·¿ms
(
h
, 
·¿ms
, &
¥
, 
NULL
, NULL, NULL);

2009 ià(
»s
 < 0)

2010 (
»s
);

2011 
	`hashtb_¡¬t
(
h
->
key¡Ües
, 
e
);

2012 ià(
	`hashtb_£ek
(
e
, 
¥
.
pubid
, (¥.pubid), 0è=ğ
HT_OLD_ENTRY
) {

2013 
cú_key¡Üe
 **
pk
 = 
e
->
d©a
;

2014 
key¡Üe
 = *
pk
;

2015 ià(
dige¡_»suÉ
 !ğ
NULL
) {

2016 
dige¡_»suÉ
->
Ëngth
 = 0;

2017 
	`cú_ch¬buf_­³nd
(
dige¡_»suÉ
,

2018 
	`cú_key¡Üe_public_key_dige¡
(
key¡Üe
),

2019 
	`cú_key¡Üe_public_key_dige¡_Ëngth
(
key¡Üe
));

2021 ià(
»suÉ
 !ğ
NULL
) {

2022 
cú_buf_decod”
 
decod”
;

2023 
cú_buf_decod”
 *
d
;

2024 cÚ¡ *
p
;

2025 
size_t
 
size
;

2026 
»suÉ
->
Ëngth
 = 0;

2027 
	`cú_­³nd_pubkey_blob
(
»suÉ
, 
	`cú_key¡Üe_public_key
(
key¡Üe
));

2028 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
»suÉ
->
buf
,„esuÉ->
Ëngth
);

2029 
»s
 = 
	`cú_buf_m©ch_blob
(
d
, &
p
, &
size
);

2030 ià(
»s
 >= 0) {

2031 
	`memmove
(
»suÉ
->
buf
, 
p
, 
size
);

2032 
»suÉ
->
Ëngth
 = 
size
;

2033 
»s
 = 0;

2038 
»s
 = 
	`NOTE_ERR
(
h
, -1);

2039 
	`hashtb_d–‘e
(
e
);

2041 
	`hashtb_’d
(
e
);

2042 (
»s
);

2043 
	}
}

2050 
	$cú_chk_signšg_·¿ms
(
cú
 *
h
,

2051 cÚ¡ 
cú_signšg_·¿ms
 *
·¿ms
,

2052 
cú_signšg_·¿ms
 *
»suÉ
,

2053 
cú_ch¬buf
 **
±ime¡amp
,

2054 
cú_ch¬buf
 **
pfš®blockid
,

2055 
cú_ch¬buf
 **
pkeyloÿtÜ
)

2057 
cú_ch¬buf
 *
deçuÉ_pubid
 = 
NULL
;

2058 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

2059 cÚ¡ *
home
 = 
NULL
;

2060 cÚ¡ *
cúx_dœ
 = 
NULL
;

2061 
»s
 = 0;

2062 
i
;

2063 
cÚæiùšg
;

2064 
Ãeded
;

2066 ià(
·¿ms
 !ğ
NULL
)

2067 *
»suÉ
 = *
·¿ms
;

2068 ià((
»suÉ
->
¥_æags
 & ~(
CCN_SP_TEMPL_TIMESTAMP
 |

2069 
CCN_SP_TEMPL_FINAL_BLOCK_ID
 |

2070 
CCN_SP_TEMPL_FRESHNESS
 |

2071 
CCN_SP_TEMPL_KEY_LOCATOR
 |

2072 
CCN_SP_FINAL_BLOCK
 |

2073 
CCN_SP_OMIT_KEY_LOCATOR


2075 (
	`NOTE_ERR
(
h
, 
EINVAL
));

2076 
cÚæiùšg
 = 
CCN_SP_TEMPL_FINAL_BLOCK_ID
 | 
CCN_SP_FINAL_BLOCK
;

2077 ià((
»suÉ
->
¥_æags
 & 
cÚæiùšg
) == conflicting)

2078 (
	`NOTE_ERR
(
h
, 
EINVAL
));

2079 
cÚæiùšg
 = 
CCN_SP_TEMPL_KEY_LOCATOR
 | 
CCN_SP_OMIT_KEY_LOCATOR
;

2080 ià((
»suÉ
->
¥_æags
 & 
cÚæiùšg
) == conflicting)

2081 (
	`NOTE_ERR
(
h
, 
EINVAL
));

2082 
i
 = 0; i < (
»suÉ
->
pubid
) &&„esult->pubid[i] == 0; i++)

2084 ià(
i
 =ğ(
»suÉ
->
pubid
)) {

2085 ià(
h
->
deçuÉ_pubid
 =ğ
NULL
) {

2086 
deçuÉ_pubid
 = 
	`cú_ch¬buf_ü—‹
();

2087 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

2088 ià(
deçuÉ_pubid
 =ğ
NULL
 || 
‹mp
 == NULL)

2089 (
	`NOTE_ERRNO
(
h
));

2090 
cúx_dœ
 = 
	`g‘’v
("CCNX_DIR");

2091 ià(
cúx_dœ
 =ğ
NULL
 || ccnx_dir[0] == 0) {

2092 
home
 = 
	`g‘’v
("HOME");

2093 ià(
home
 =ğ
NULL
)

2094 
home
 = "";

2095 
	`cú_ch¬buf_putf
(
‹mp
, "%s/.cúx/.cúx_key¡Üe", 
home
);

2098 
	`cú_ch¬buf_putf
(
‹mp
, "%s/.cúx_key¡Üe", 
cúx_dœ
);

2099 
»s
 = 
	`cú_lßd_´iv©e_key
(
h
,

2100 
	`cú_ch¬buf_as_¡ršg
(
‹mp
),

2102 
deçuÉ_pubid
);

2103 ià(
»s
 =ğ0 && 
deçuÉ_pubid
->
Ëngth
 =ğ(
»suÉ
->
pubid
)) {

2104 
h
->
deçuÉ_pubid
 = default_pubid;

2105 
deçuÉ_pubid
 = 
NULL
;

2108 ià(
h
->
deçuÉ_pubid
 =ğ
NULL
)

2109 
»s
 = 
	`NOTE_ERRNO
(
h
);

2111 
	`memıy
(
»suÉ
->
pubid
, 
h
->
deçuÉ_pubid
->
buf
, (result->pubid));

2113 
	`cú_ch¬buf_de¡roy
(&
deçuÉ_pubid
);

2114 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

2115 
Ãeded
 = 
»suÉ
->
¥_æags
 & (
CCN_SP_TEMPL_TIMESTAMP
 |

2116 
CCN_SP_TEMPL_FINAL_BLOCK_ID
 |

2117 
CCN_SP_TEMPL_FRESHNESS
 |

2118 
CCN_SP_TEMPL_KEY_LOCATOR
 );

2119 ià(
»suÉ
->
‹m¶©e_cúb
 !ğ
NULL
) {

2120 
cú_buf_decod”
 
decod”
;

2121 
cú_buf_decod”
 *
d
;

2122 
size_t
 
¡¬t
;

2123 
size_t
 
¡İ
;

2124 
size_t
 
size
;

2125 cÚ¡ *
±r
 = 
NULL
;

2126 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
,

2127 
»suÉ
->
‹m¶©e_cúb
->
buf
,

2128 
»suÉ
->
‹m¶©e_cúb
->
Ëngth
);

2129 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_SigÃdInfo
)) {

2130 
	`cú_buf_advªû
(
d
);

2131 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Publish”PublicKeyDige¡
))

2132 
	`cú_·r£_»quœed_gged_BLOB
(
d
,

2133 
CCN_DTAG_Publish”PublicKeyDige¡
, 16, 64);

2134 
¡¬t
 = 
d
->
decod”
.
tok’_šdex
;

2135 
	`cú_·r£_İtiÚ®_gged_BLOB
(
d
, 
CCN_DTAG_Time¡amp
, 1, -1);

2136 
¡İ
 = 
d
->
decod”
.
tok’_šdex
;

2137 ià((
Ãeded
 & 
CCN_SP_TEMPL_TIMESTAMP
) != 0) {

2138 
i
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Time¡amp
,

2139 
d
->
buf
,

2140 
¡¬t
, 
¡İ
,

2141 &
±r
, &
size
);

2142 ià(
i
 == 0) {

2143 ià(
±ime¡amp
 !ğ
NULL
) {

2144 *
±ime¡amp
 = 
	`cú_ch¬buf_ü—‹
();

2145 
	`cú_ch¬buf_­³nd
(*
±ime¡amp
, 
±r
, 
size
);

2147 
Ãeded
 &ğ~
CCN_SP_TEMPL_TIMESTAMP
;

2150 
	`cú_·r£_İtiÚ®_gged_BLOB
(
d
, 
CCN_DTAG_Ty³
, 1, -1);

2151 
i
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
,

2152 
CCN_DTAG_F»shÃssSecÚds
);

2153 ià((
Ãeded
 & 
CCN_SP_TEMPL_FRESHNESS
è!ğ0 && 
i
 >= 0) {

2154 
»suÉ
->
äeshÃss
 = 
i
;

2155 
Ãeded
 &ğ~
CCN_SP_TEMPL_FRESHNESS
;

2157 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Fš®BlockID
)) {

2158 
	`cú_buf_advªû
(
d
);

2159 
¡¬t
 = 
d
->
decod”
.
tok’_šdex
;

2160 ià(
	`cú_buf_m©ch_some_blob
(
d
))

2161 
	`cú_buf_advªû
(
d
);

2162 
¡İ
 = 
d
->
decod”
.
tok’_šdex
;

2163 
	`cú_buf_check_şo£
(
d
);

2164 ià((
Ãeded
 & 
CCN_SP_TEMPL_FINAL_BLOCK_ID
) != 0 &&

2165 
d
->
decod”
.
¡©e
 >ğ0 && 
¡İ
 > 
¡¬t
) {

2166 ià(
pfš®blockid
 !ğ
NULL
) {

2167 *
pfš®blockid
 = 
	`cú_ch¬buf_ü—‹
();

2168 
	`cú_ch¬buf_­³nd
(*
pfš®blockid
,

2169 
d
->
buf
 + 
¡¬t
, 
¡İ
 - start);

2171 
Ãeded
 &ğ~
CCN_SP_TEMPL_FINAL_BLOCK_ID
;

2174 
¡¬t
 = 
d
->
decod”
.
tok’_šdex
;

2175 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_KeyLoÿtÜ
))

2176 
	`cú_buf_advªû_·¡_–em’t
(
d
);

2177 
¡İ
 = 
d
->
decod”
.
tok’_šdex
;

2178 ià((
Ãeded
 & 
CCN_SP_TEMPL_KEY_LOCATOR
) != 0 &&

2179 
d
->
decod”
.
¡©e
 >ğ0 && 
¡İ
 > 
¡¬t
) {

2180 ià(
pkeyloÿtÜ
 !ğ
NULL
) {

2181 *
pkeyloÿtÜ
 = 
	`cú_ch¬buf_ü—‹
();

2182 
	`cú_ch¬buf_­³nd
(*
pkeyloÿtÜ
,

2183 
d
->
buf
 + 
¡¬t
, 
¡İ
 - start);

2185 
Ãeded
 &ğ~
CCN_SP_TEMPL_KEY_LOCATOR
;

2187 
	`cú_buf_check_şo£
(
d
);

2189 ià(
d
->
decod”
.
¡©e
 < 0)

2190 
»s
 = 
	`NOTE_ERR
(
h
, 
EINVAL
);

2192 ià(
Ãeded
 != 0)

2193 
»s
 = 
	`NOTE_ERR
(
h
, 
EINVAL
);

2194 (
»s
);

2195 
	}
}

2209 
	$cú_sign_cÚ‹Á
(
cú
 *
h
,

2210 
cú_ch¬buf
 *
»suÉbuf
,

2211 cÚ¡ 
cú_ch¬buf
 *
Çme_´efix
,

2212 cÚ¡ 
cú_signšg_·¿ms
 *
·¿ms
,

2213 cÚ¡ *
d©a
, 
size_t
 
size
)

2215 
hashtb_’um”©Ü
 
“
;

2216 
hashtb_’um”©Ü
 *
e
 = &
“
;

2217 
cú_signšg_·¿ms
 
p
 = 
CCN_SIGNING_PARAMS_INIT
;

2218 
cú_ch¬buf
 *
sigÃd_šfo
 = 
NULL
;

2219 
cú_key¡Üe
 *
key¡Üe
 = 
NULL
;

2220 
cú_ch¬buf
 *
time¡amp
 = 
NULL
;

2221 
cú_ch¬buf
 *
fš®blockid
 = 
NULL
;

2222 
cú_ch¬buf
 *
keyloÿtÜ
 = 
NULL
;

2223 
»s
;

2225 
»s
 = 
	`cú_chk_signšg_·¿ms
(
h
, 
·¿ms
, &
p
,

2226 &
time¡amp
, &
fš®blockid
, &
keyloÿtÜ
);

2227 ià(
»s
 < 0)

2228 (
»s
);

2229 
	`hashtb_¡¬t
(
h
->
key¡Ües
, 
e
);

2230 ià(
	`hashtb_£ek
(
e
, 
p
.
pubid
, Õ.pubid), 0è=ğ
HT_OLD_ENTRY
) {

2231 
cú_key¡Üe
 **
pk
 = 
e
->
d©a
;

2232 
key¡Üe
 = *
pk
;

2233 
sigÃd_šfo
 = 
	`cú_ch¬buf_ü—‹
();

2234 ià(
keyloÿtÜ
 =ğ
NULL
 && (
p
.
¥_æags
 & 
CCN_SP_OMIT_KEY_LOCATOR
) == 0) {

2236 
keyloÿtÜ
 = 
	`cú_ch¬buf_ü—‹
();

2237 
	`cú_ch¬buf_­³nd_‰
(
keyloÿtÜ
, 
CCN_DTAG_KeyLoÿtÜ
, 
CCN_DTAG
);

2238 
	`cú_ch¬buf_­³nd_‰
(
keyloÿtÜ
, 
CCN_DTAG_Key
, 
CCN_DTAG
);

2239 
»s
 = 
	`cú_­³nd_pubkey_blob
(
keyloÿtÜ
,

2240 
	`cú_key¡Üe_public_key
(
key¡Üe
));

2241 
	`cú_ch¬buf_­³nd_şo£r
(
keyloÿtÜ
);

2242 
	`cú_ch¬buf_­³nd_şo£r
(
keyloÿtÜ
);

2244 ià(
»s
 >ğ0 && (
p
.
¥_æags
 & 
CCN_SP_FINAL_BLOCK
) != 0) {

2245 
ncomp
;

2246 
cú_šdexbuf
 *
ndx
;

2247 cÚ¡ *
comp
 = 
NULL
;

2248 
size_t
 
size
 = 0;

2250 
ndx
 = 
	`cú_šdexbuf_ü—‹
();

2251 
ncomp
 = 
	`cú_Çme_¥l™
(
Çme_´efix
, 
ndx
);

2252 ià(
ncomp
 < 0)

2253 
»s
 = 
	`NOTE_ERR
(
h
, 
EINVAL
);

2255 
fš®blockid
 = 
	`cú_ch¬buf_ü—‹
();

2256 
	`cú_Çme_comp_g‘
(
Çme_´efix
->
buf
,

2257 
ndx
, 
ncomp
 - 1, &
comp
, &
size
);

2258 
	`cú_ch¬buf_­³nd_‰
(
fš®blockid
, 
size
, 
CCN_BLOB
);

2259 
	`cú_ch¬buf_­³nd
(
fš®blockid
, 
comp
, 
size
);

2261 
	`cú_šdexbuf_de¡roy
(&
ndx
);

2263 ià(
»s
 >= 0)

2264 
»s
 = 
	`cú_sigÃd_šfo_ü—‹
(
sigÃd_šfo
,

2265 
	`cú_key¡Üe_public_key_dige¡
(
key¡Üe
),

2266 
	`cú_key¡Üe_public_key_dige¡_Ëngth
(
key¡Üe
),

2267 
time¡amp
,

2268 
p
.
ty³
,

2269 
p
.
äeshÃss
,

2270 
fš®blockid
,

2271 
keyloÿtÜ
);

2272 ià(
»s
 >= 0)

2273 
»s
 = 
	`cú_’code_CÚ‹ÁObjeù
(
»suÉbuf
,

2274 
Çme_´efix
,

2275 
sigÃd_šfo
,

2276 
d©a
,

2277 
size
,

2278 
NULL
,

2279 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
));

2282 
»s
 = 
	`NOTE_ERR
(
h
, -1);

2283 
	`hashtb_d–‘e
(
e
);

2285 
	`hashtb_’d
(
e
);

2286 
	`cú_ch¬buf_de¡roy
(&
time¡amp
);

2287 
	`cú_ch¬buf_de¡roy
(&
keyloÿtÜ
);

2288 
	`cú_ch¬buf_de¡roy
(&
fš®blockid
);

2289 
	`cú_ch¬buf_de¡roy
(&
sigÃd_šfo
);

2290 (
»s
);

2291 
	}
}

	@lib/ccn_coding.c

20 
	~<cú/codšg.h
>

27 
	#XML
(
goİ
è(()0)

	)

56 
ssize_t


57 
	$cú_sk–‘Ú_decode
(
cú_sk–‘Ú_decod”
 *
d
,

58 cÚ¡ *
p
, 
size_t
 
n
)

60 
cú_decod”_¡©e
 
¡©e
 = 
d
->state;

61 
g¡©e
 = 0;

62 
size_t
 
numv®
 = 
d
->numval;

63 
ssize_t
 
i
 = 0;

64 
c
;

65 
size_t
 
chunk
;

66 
·u£
 = 0;

67 ià(
d
->
¡©e
 >= 0) {

68 
·u£
 = 
d
->
¡©e
 & 
CCN_DSTATE_PAUSE
;

69 
g¡©e
 = (
d
->
¡©e
 >> 8) & 3;

70 
¡©e
 = 
d
->state & 0xFF;

72 
i
 < 
n
) {

73 
¡©e
) {

74 
CCN_DSTATE_INITIAL
:

75 
CCN_DSTATE_NEWTOKEN
:

76 
d
->
tok’_šdex
 = 
i
 + d->
šdex
;

77 ià(
g¡©e
 > 1 &&agstate-- == 2) {

78 
	`XML
("\"");

80 ià(
p
[
i
] =ğ
CCN_CLOSE
) {

81 
i
++;

82 ià(
d
->
Ã¡
 <ğ0 || 
g¡©e
 > 1) {

83 
¡©e
 = 
CCN_DSTATE_ERR_NEST
;

86 ià(
g¡©e
 == 1) {

87 
g¡©e
 = 0;

88 
	`XML
("/>");

91 
	`XML
("</%s>");

93 
d
->
Ã¡
 -= 1;

94 ià(
d
->
Ã¡
 == 0) {

95 
¡©e
 = 
CCN_DSTATE_INITIAL
;

96 
n
 = 
i
;

98 ià(
·u£
) {

99 
¡©e
 |ğ((()
CCN_NO_TOKEN
) << 16);

100 
n
 = 
i
;

104 
numv®
 = 0;

105 
¡©e
 = 
CCN_DSTATE_NUMVAL
;

107 
CCN_DSTATE_NUMVAL
:

108 
c
 = 
p
[
i
++];

109 ià((
c
 & 
CCN_TT_HBIT
è=ğ
CCN_CLOSE
) {

110 ià(
numv®
 > ((~(
size_t
)0Uè>> (7 + 
CCN_TT_BITS
)))

111 
¡©e
 = 
CCN_DSTATE_ERR_OVERFLOW
;

112 
numv®
 = (numv® << 7è+ (
c
 & 127);

115 
numv®
 = (numv® << (7-
CCN_TT_BITS
)) +

116 ((
c
 >> 
CCN_TT_BITS
è& 
CCN_MAX_TINY
);

117 
c
 &ğ
CCN_TT_MASK
;

118 
c
) {

119 
CCN_EXT
:

120 ià(
g¡©e
 == 1) {

121 
g¡©e
 = 0;

122 
	`XML
(">");

124 
d
->
Ã¡
 += 1;

125 
d
->
–em’t_šdex
 = d->
tok’_šdex
;

126 
¡©e
 = 
CCN_DSTATE_NEWTOKEN
;

128 
CCN_DTAG
:

129 ià(
g¡©e
 == 1) {

130 
g¡©e
 = 0;

131 
	`XML
(">");

133 
d
->
Ã¡
 += 1;

134 
d
->
–em’t_šdex
 = d->
tok’_šdex
;

135 
	`XML
("<%s");

136 
g¡©e
 = 1;

137 
¡©e
 = 
CCN_DSTATE_NEWTOKEN
;

139 
CCN_BLOB
:

140 ià(
g¡©e
 == 1) {

141 
g¡©e
 = 0;

142 
	`XML
(" ccnbencoding=\"base64Binary\">");

144 
¡©e
 = 
CCN_DSTATE_BLOB
;

145 ià(
numv®
 == 0)

146 
¡©e
 = 
CCN_DSTATE_NEWTOKEN
;

148 
CCN_UDATA
:

149 ià(
g¡©e
 == 1) {

150 
g¡©e
 = 0;

151 
	`XML
(">");

153 
¡©e
 = 
CCN_DSTATE_UDATA
;

154 ià(
numv®
 == 0)

155 
¡©e
 = 
CCN_DSTATE_NEWTOKEN
;

157 
CCN_DATTR
:

158 ià(
g¡©e
 != 1) {

159 
¡©e
 = 
CCN_DSTATE_ERR_ATTR
;

162 
g¡©e
 = 3;

163 
¡©e
 = 
CCN_DSTATE_NEWTOKEN
;

165 
CCN_ATTR
:

166 ià(
g¡©e
 != 1) {

167 
¡©e
 = 
CCN_DSTATE_ERR_ATTR
;

170 
numv®
 += 1;

171 
¡©e
 = 
CCN_DSTATE_ATTRNAME
;

173 
CCN_TAG
:

174 ià(
g¡©e
 == 1) {

175 
g¡©e
 = 0;

176 
	`XML
(">");

178 
numv®
 += 1;

179 
d
->
Ã¡
 += 1;

180 
d
->
–em’t_šdex
 = d->
tok’_šdex
;

181 
¡©e
 = 
CCN_DSTATE_TAGNAME
;

184 
¡©e
 = 
CCN_DSTATE_ERR_CODING
;

186 ià(
·u£
) {

187 
¡©e
 |ğ(
c
 << 16);

188 
n
 = 
i
;

192 
CCN_DSTATE_TAGNAME
:

193 
chunk
 = 
n
 - 
i
;

194 ià(
chunk
 > 
numv®
)

195 
chunk
 = 
numv®
;

196 ià(
chunk
 == 0) {

197 
¡©e
 = 
CCN_DSTATE_ERR_BUG
;

200 
numv®
 -ğ
chunk
;

201 
i
 +ğ
chunk
;

202 ià(
numv®
 == 0) {

203 ià(
d
->
Ã¡
 == 0) {

204 
¡©e
 = 
CCN_DSTATE_ERR_NEST
;

207 
	`XML
("<%s");

208 
g¡©e
 = 1;

209 
¡©e
 = 
CCN_DSTATE_NEWTOKEN
;

212 
CCN_DSTATE_ATTRNAME
:

213 
chunk
 = 
n
 - 
i
;

214 ià(
chunk
 > 
numv®
)

215 
chunk
 = 
numv®
;

216 ià(
chunk
 == 0) {

217 
¡©e
 = 
CCN_DSTATE_ERR_BUG
;

220 
numv®
 -ğ
chunk
;

221 
i
 +ğ
chunk
;

222 ià(
numv®
 == 0) {

223 ià(
d
->
Ã¡
 == 0) {

224 
¡©e
 = 
CCN_DSTATE_ERR_ATTR
;

227 
	`XML
(" %s=\"");

228 
g¡©e
 = 3;

229 
¡©e
 = 
CCN_DSTATE_NEWTOKEN
;

232 
CCN_DSTATE_UDATA
:

233 
CCN_DSTATE_BLOB
:

234 
chunk
 = 
n
 - 
i
;

235 ià(
chunk
 > 
numv®
)

236 
chunk
 = 
numv®
;

237 ià(
chunk
 == 0) {

238 
¡©e
 = 
CCN_DSTATE_ERR_BUG
;

241 
numv®
 -ğ
chunk
;

242 
i
 +ğ
chunk
;

243 ià(
numv®
 == 0)

244 
¡©e
 = 
CCN_DSTATE_NEWTOKEN
;

247 
n
 = 
i
;

250 ià(
¡©e
 < 0)

251 
g¡©e
 = 
·u£
 = 0;

252 
d
->
¡©e
 = s‹ | 
·u£
 | (
g¡©e
 << 8);

253 
d
->
numv®
 =‚umval;

254 
d
->
šdex
 +ğ
i
;

255 (
i
);

256 
	}
}

	@lib/ccn_digest.c

20 
	~<¡dlib.h
>

21 
	~<İ’s¦/sha.h
>

22 
	~<cú/dige¡.h
>

24 
	scú_dige¡
 {

25 
cú_dige¡_id
 
	mid
;

26 
	msz
;

27 
	m»ady
;

28 
SHA256_CTX
 
	msha256_ùx
;

31 
cú_dige¡
 *

32 
	$cú_dige¡_ü—‹
(
cú_dige¡_id
 
id
)

34 
sz
 = 0;

35 
cú_dige¡
 *
ªs
;

36 
id
) {

37 
CCN_DIGEST_DEFAULT
:

38 
CCN_DIGEST_SHA256
:

39 
id
 = 
CCN_DIGEST_SHA256
;

40 
sz
 = 32;

43 (
NULL
);

45 
ªs
 = 
	`ÿÎoc
(1, (*ans));

46 ià(
ªs
 !ğ
NULL
) {

47 
ªs
->
id
 = id;

48 
ªs
->
sz
 = sz;

50 (
ªs
);

51 
	}
}

54 
	$cú_dige¡_de¡roy
(
cú_dige¡
 **
pd
)

56 ià(*
pd
 !ğ
NULL
) {

57 
	`ä“
(*
pd
);

58 *
pd
 = 
NULL
;

60 
	}
}

62 
cú_dige¡_id


63 
	$cú_dige¡_g‘id
(
cú_dige¡
 *
d
)

65 (
d
->
id
);

66 
	}
}

68 
size_t


69 
	$cú_dige¡_size
(
cú_dige¡
 *
d
)

71 (
d
->
sz
);

72 
	}
}

75 
	$cú_dige¡_š™
(
cú_dige¡
 *
d
)

77 
	`SHA256_In™
(&
d
->
sha256_ùx
);

78 
d
->
»ady
 = 1;

79 
	}
}

82 
	$cú_dige¡_upd©e
(
cú_dige¡
 *
d
, cÚ¡ *
d©a
, 
size_t
 
size
)

84 
»s
;

85 ià(
d
->
»ady
 != 1)

87 
»s
 = 
	`SHA256_Upd©e
(&
d
->
sha256_ùx
, 
d©a
, 
size
);

88 ((
»s
 == 1) ? 0 : -1);

89 
	}
}

92 
	$cú_dige¡_fš®
(
cú_dige¡
 *
d
, *
»suÉ
, 
size_t
 
dige¡_size
)

94 
»s
;

95 ià(
dige¡_size
 !ğ
d
->
sz
) (-1);

96 ià(
d
->
»ady
 != 1)

98 
»s
 = 
	`SHA256_Fš®
(
»suÉ
, &
d
->
sha256_ùx
);

99 
d
->
»ady
 = 0;

100 ((
»s
 == 1) ? 0 : -1);

101 
	}
}

	@lib/ccn_dtag_table.c

20 
	~<cú/codšg.h
>

22 
	#ARRAY_N
(
¬r
è(×¼)/×¼[0]))

	)

26 cÚ¡ 
cú_diù_’Œy
 
	gcú_gdiù
[] = {

27 {
CCN_DTAG_Any
, "Any"},

28 {
CCN_DTAG_Name
, "Name"},

29 {
CCN_DTAG_CompÚ’t
, "Component"},

30 {
CCN_DTAG_C”tifiÿ‹
, "Certificate"},

31 {
CCN_DTAG_CŞËùiÚ
, "Collection"},

32 {
CCN_DTAG_Com¶‘eName
, "CompleteName"},

33 {
CCN_DTAG_CÚ‹Á
, "Content"},

34 {
CCN_DTAG_SigÃdInfo
, "SignedInfo"},

35 {
CCN_DTAG_CÚ‹ÁDige¡
, "ContentDigest"},

36 {
CCN_DTAG_CÚ‹ÁHash
, "ContentHash"},

37 {
CCN_DTAG_CouÁ
, "Count"},

38 {
CCN_DTAG_H—d”
, "Header"},

39 {
CCN_DTAG_IÁ”e¡
, "Interest"},

40 {
CCN_DTAG_Key
, "Key"},

41 {
CCN_DTAG_KeyLoÿtÜ
, "KeyLocator"},

42 {
CCN_DTAG_KeyName
, "KeyName"},

43 {
CCN_DTAG_L’gth
, "Length"},

44 {
CCN_DTAG_Lšk
, "Link"},

45 {
CCN_DTAG_LškAuth’tiÿtÜ
, "LinkAuthenticator"},

46 {
CCN_DTAG_NameCompÚ’tCouÁ
, "NameComponentCount"},

47 {
CCN_DTAG_RoÙDige¡
, "RootDigest"},

48 {
CCN_DTAG_SigÇtu»
, "Signature"},

49 {
CCN_DTAG_S¹
, "Start"},

50 {
CCN_DTAG_Time¡amp
, "Timestamp"},

51 {
CCN_DTAG_Ty³
, "Type"},

52 {
CCN_DTAG_NÚû
, "Nonce"},

53 {
CCN_DTAG_Scİe
, "Scope"},

54 {
CCN_DTAG_Exşude
, "Exclude"},

55 {
CCN_DTAG_Bloom
, "Bloom"},

56 {
CCN_DTAG_BloomS“d
, "BloomSeed"},

57 {
CCN_DTAG_Answ”OrigšKšd
, "AnswerOriginKind"},

58 {
CCN_DTAG_IÁ”e¡Liãtime
, "InterestLifetime"},

59 {
CCN_DTAG_W™Ãss
, "Witness"},

60 {
CCN_DTAG_SigÇtu»B™s
, "SignatureBits"},

61 {
CCN_DTAG_Dige¡AlgÜ™hm
, "DigestAlgorithm"},

62 {
CCN_DTAG_BlockSize
, "BlockSize"},

63 {
CCN_DTAG_F»shÃssSecÚds
, "FreshnessSeconds"},

64 {
CCN_DTAG_Fš®BlockID
, "FinalBlockID"},

65 {
CCN_DTAG_Publish”PublicKeyDige¡
, "PublisherPublicKeyDigest"},

66 {
CCN_DTAG_Publish”C”tifiÿ‹Dige¡
, "PublisherCertificateDigest"},

67 {
CCN_DTAG_Publish”Issu”KeyDige¡
, "PublisherIssuerKeyDigest"},

68 {
CCN_DTAG_Publish”Issu”C”tifiÿ‹Dige¡
, "PublisherIssuerCertificateDigest"},

69 {
CCN_DTAG_CÚ‹ÁObjeù
, "ContentObject"},

70 {
CCN_DTAG_W¿µedKey
, "WrappedKey"},

71 {
CCN_DTAG_W¿µšgKeyId’tif›r
, "WrappingKeyIdentifier"},

72 {
CCN_DTAG_W¿pAlgÜ™hm
, "WrapAlgorithm"},

73 {
CCN_DTAG_KeyAlgÜ™hm
, "KeyAlgorithm"},

74 {
CCN_DTAG_Lab–
, "Label"},

75 {
CCN_DTAG_Enüy±edKey
, "EncryptedKey"},

76 {
CCN_DTAG_Enüy±edNÚûKey
, "EncryptedNonceKey"},

77 {
CCN_DTAG_W¿µšgKeyName
, "WrappingKeyName"},

78 {
CCN_DTAG_AùiÚ
, "Action"},

79 {
CCN_DTAG_FaûID
, "FaceID"},

80 {
CCN_DTAG_IPPrÙo
, "IPProto"},

81 {
CCN_DTAG_Ho¡
, "Host"},

82 {
CCN_DTAG_PÜt
, "Port"},

83 {
CCN_DTAG_MuÉiÿ¡IÁ”çû
, "MulticastInterface"},

84 {
CCN_DTAG_FÜw¬dšgFÏgs
, "ForwardingFlags"},

85 {
CCN_DTAG_FaûIn¡ªû
, "FaceInstance"},

86 {
CCN_DTAG_FÜw¬dšgEÁry
, "ForwardingEntry"},

87 {
CCN_DTAG_MuÉiÿ¡TTL
, "MulticastTTL"},

88 {
CCN_DTAG_MšSuffixCompÚ’ts
, "MinSuffixComponents"},

89 {
CCN_DTAG_MaxSuffixCompÚ’ts
, "MaxSuffixComponents"},

90 {
CCN_DTAG_ChdS–eùÜ
, "ChildSelector"},

91 {
CCN_DTAG_R•os™ÜyInfo
, "RepositoryInfo"},

92 {
CCN_DTAG_V”siÚ
, "Version"},

93 {
CCN_DTAG_R•os™ÜyV”siÚ
, "RepositoryVersion"},

94 {
CCN_DTAG_Glob®P»fix
, "GlobalPrefix"},

95 {
CCN_DTAG_LoÿlName
, "LocalName"},

96 {
CCN_DTAG_PŞicy
, "Policy"},

97 {
CCN_DTAG_Name¥aû
, "Namespace"},

98 {
CCN_DTAG_Glob®P»fixName
, "GlobalPrefixName"},

99 {
CCN_DTAG_PŞicyV”siÚ
, "PolicyVersion"},

100 {
CCN_DTAG_KeyV®ueS‘
, "KeyValueSet"},

101 {
CCN_DTAG_KeyV®uePaœ
, "KeyValuePair"},

102 {
CCN_DTAG_IÁeg”V®ue
, "IntegerValue"},

103 {
CCN_DTAG_Decim®V®ue
, "DecimalValue"},

104 {
CCN_DTAG_SŒšgV®ue
, "StringValue"},

105 {
CCN_DTAG_Bš¬yV®ue
, "BinaryValue"},

106 {
CCN_DTAG_NameV®ue
, "NameValue"},

107 {
CCN_DTAG_EÁry
, "Entry"},

108 {
CCN_DTAG_ACL
, "ACL"},

109 {
CCN_DTAG_P¬am‘”izedName
, "ParameterizedName"},

110 {
CCN_DTAG_P»fix
, "Prefix"},

111 {
CCN_DTAG_Suffix
, "Suffix"},

112 {
CCN_DTAG_RoÙ
, "Root"},

113 {
CCN_DTAG_ProfeName
, "ProfileName"},

114 {
CCN_DTAG_P¬am‘”s
, "Parameters"},

115 {
CCN_DTAG_CCNPrÙocŞD©aUn™
, "CCNProtocolDataUnit"},

119 cÚ¡ 
cú_diù
 
	gcú_dg_diù
 = {
ARRAY_N
(
cú_gdiù
) - 1, ccn_tagdict};

	@lib/ccn_extend_dict.c

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<ùy³.h
>

26 
	~<cú/ch¬buf.h
>

27 
	~<cú/ex‹nd_diù.h
>

30 
	$qsÜt_com·»_diù_Çmes
(cÚ¡ *
x
, cÚ¡ *
y
)

32 cÚ¡ 
cú_diù_’Œy
 *
ex
 = 
x
;

33 cÚ¡ 
cú_diù_’Œy
 *
ey
 = 
y
;

34  (
	`¡rcmp
(
ex
->
Çme
, 
ey
->name));

35 
	}
}

42 
	$qsÜt_com·»_diù_šdiûs
(cÚ¡ *
x
, cÚ¡ *
y
)

44 cÚ¡ 
cú_diù_’Œy
 *
ex
 = 
x
;

45 cÚ¡ 
cú_diù_’Œy
 *
ey
 = 
y
;

46 ià(
ex
->
Çme
 =ğ
NULL
)

47  ((
ey
->
Çme
 =ğ
NULL
) ? 0 : 1);

48 ià(
ey
->
Çme
 =ğ
NULL
)  (-1);

49 ià(
ex
->
šdex
 =ğ
ey
->index)  (0);

50  ((
ex
->
šdex
 < 
ey
->index) ? -1 : 1);

51 
	}
}

59 
	$cú_de¡roy_diù
(
cú_diù
 **
dp
)

61 
cú_diù
 *
d
 = *
dp
;

62 
i
;

63 ià(
d
 !ğ
NULL
) {

64 
i
 = 0; i < 
d
->
couÁ
; i++) {

65 ià(
d
->
diù
[
i
].
Çme
 !ğ
NULL
)

66 
	`ä“
((*)
d
->
diù
[
i
].
Çme
);

68 
	`ä“
(
d
);

70 *
dp
 = 
NULL
;

71 
	}
}

84 
	$cú_ex‹nd_diù
(cÚ¡ *
diù_fe
, 
cú_diù
 *
d
, cú_diù **
rdp
)

86 
FILE
 *
df
 = 
NULL
;

87 
i
, 
c
;

88 
cú_diù_’Œy
 *
ndd
 = 
NULL
;

89 
ndc
 = 0;

90 
cú_ch¬buf
 *
’amebuf
 = 
NULL
;

91 
ešdex
 = 0;;

92 
cú_diù
 *
nd
 = 
NULL
;

93 
	esÿÂ”_¡©e
 {

94 
S_OVERFLOW
 = -2,

95 
S_ERROR
 = -1,

96 
S_INITIAL
 = 0,

97 
S_INDEX
 = 1,

98 
S_NAME
 = 2,

99 
S_FLUSH
 = 3

100 } 
s
 = 
S_INITIAL
;

102 ià(
rdp
 =ğ
NULL
)

105 
’amebuf
 = 
	`cú_ch¬buf_ü—‹
();

106 ià(
’amebuf
 =ğ
NULL
)

109 
df
 = 
	`fİ’
(
diù_fe
, "r");

110 ià(
df
 =ğ
NULL
)

111 
”r
;

115 ià(
d
) {

116 
ndd
 = 
	`ÿÎoc
(
d
->
couÁ
, (*(d->
diù
)));

117 
ndc
 = 0;‚dø< 
d
->
couÁ
;‚dc++) {

118 
ndd
[
ndc
].
šdex
 = 
d
->
diù
[ndc].index;

119 
ndd
[
ndc
].
Çme
 = 
	`¡rdup
(
d
->
diù
[ndc].name);

124 (
c
 = 
	`fg‘c
(
df
)è!ğ
EOF
 && 
s
 >ğ
S_INITIAL
) {

125 
s
) {

126 
S_INITIAL
:

127 ià(
	`isdig™
(
c
)) {

128 
s
 = 
S_INDEX
;

129 
ešdex
 = 
c
 - '0';

131 
s
 = 
S_ERROR
;

133 
S_INDEX
:

134 ià(
	`isdig™
(
c
)) {

135 
‹šdex
 = 
ešdex
;

136 
ešdex
 = 10 *ƒšdex + (
c
 - '0');

137 ià(
ešdex
 < 
‹šdex
)

138 
s
 = 
S_OVERFLOW
;

139 } ià(
c
 == ',')

140 
s
 = 
S_NAME
;

142 
s
 = 
S_ERROR
;

144 
S_NAME
:

145 ià(
	`i§Êum
(
c
)) {

146 
	`cú_ch¬buf_­³nd_v®ue
(
’amebuf
, 
c
, 1);

147 } ià(
c
 == ',' || c == '\n') {

149 
ndd
 = 
	`»®loc
Òdd, (*nddè* (
ndc
 + 1));

150 
ndd
[
ndc
].
šdex
 = 
ešdex
;

151 
ndd
[
ndc
].
Çme
 = 
	`¡rdup
(
	`cú_ch¬buf_as_¡ršg
(
’amebuf
));

152 
ndc
++;

153 
	`cú_ch¬buf_»£t
(
’amebuf
);

154 
s
 = (
c
 =ğ','è? 
S_FLUSH
 : 
S_INITIAL
;

156 
s
 = 
S_ERROR
;

158 
S_FLUSH
:

159 ià(
c
 == '\n')

160 
s
 = 
S_INITIAL
;

166 
	`fşo£
(
df
);

167 
df
 = 
NULL
;

170 ià(
s
 < 0 || s =ğ
S_INDEX
)

171 
”r
;

172 ià(
s
 =ğ
S_NAME
) {

173 
ndd
 = 
	`»®loc
Òdd, (*nddè* (
ndc
 + 1));

174 
ndd
[
ndc
].
šdex
 = 
ešdex
;

175 
ndd
[
ndc
].
Çme
 = 
	`¡rdup
(
	`cú_ch¬buf_as_¡ršg
(
’amebuf
));

176 
ndc
++;

178 
	`cú_ch¬buf_de¡roy
(&
’amebuf
);

181 
	`qsÜt
(
ndd
, 
ndc
, (*ndd), 
qsÜt_com·»_diù_Çmes
);

182 
i
 = 1; i < 
ndc
; i++) {

183 ià(
	`¡rcmp
(
ndd
[
i
-1].
Çme
,‚dd[i].name) == 0) {

184 ià(
ndd
[
i
-1].
šdex
 ==‚dd[i].index) {

185 
	`ä“
((*)
ndd
[
i
-1].
Çme
);

186 
ndd
[
i
-1].
Çme
 = 
NULL
;

188 
”r
;

195 
	`qsÜt
(
ndd
, 
ndc
, (*ndd), 
qsÜt_com·»_diù_šdiûs
);

196 
i
 = 1; i < 
ndc
; i++) {

197 ià(
ndd
[
i
].
Çme
 =ğ
NULL
) {

198 
ndc
 = 
i
;

199 
ndd
 = 
	`»®loc
Òdd, (*nddè* 
ndc
);

202 ià(
ndd
[
i
-1].
šdex
 ==‚dd[i].index)

203 
”r
;

207 
nd
 = 
	`ÿÎoc
(1, (*nd));

208 ià(
nd
 =ğ
NULL
)

209 
”r
;

210 
nd
->
diù
 = 
ndd
;

211 
nd
->
couÁ
 = 
ndc
;

212 *
rdp
 = 
nd
;

215 
”r
:

216 
	`cú_ch¬buf_de¡roy
(&
’amebuf
);

217 ià(
df
 !ğ
NULL
)

218 
	`fşo£
(
df
);

219 ià(
ndd
 !ğ
NULL
) {

220 
ndc
--;‚dc >= 0;‚dc--) {

221 
	`ä“
((*)
ndd
[
ndc
].
Çme
);

226 
	}
}

	@lib/ccn_face_mgmt.c

20 
	~<¡ddef.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/ch¬buf.h
>

27 
	~<cú/codšg.h
>

28 
	~<cú/çû_mgmt.h
>

29 
	~<cú/sockü—‹.h
>

40 
cú_çû_š¡ªû
 *

41 
	$cú_çû_š¡ªû_·r£
(cÚ¡ *
p
, 
size_t
 
size
)

43 
cú_buf_decod”
 
decod”
;

44 
cú_buf_decod”
 *
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
p
, 
size
);

45 
cú_ch¬buf
 *
¡Üe
 = 
	`cú_ch¬buf_ü—‹
();

46 
cú_çû_š¡ªû
 *
»suÉ
;

47 cÚ¡ *
v®
;

48 
size_t
 
sz
;

49 
aùiÚ_off
 = -1;

50 
cúd_id_off
 = -1;

51 
ho¡_off
 = -1;

52 
pÜt_off
 = -1;

53 
mÿ¡_off
 = -1;

55 ià(
¡Üe
 =ğ
NULL
)

56 (
NULL
);

57 
»suÉ
 = 
	`ÿÎoc
(1, (*result));

58 ià(
»suÉ
 =ğ
NULL
) {

59 
	`cú_ch¬buf_de¡roy
(&
¡Üe
);

60 (
NULL
);

62 
»suÉ
->
¡Üe
 = store;

63 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_FaûIn¡ªû
)) {

64 
	`cú_buf_advªû
(
d
);

65 
aùiÚ_off
 = 
	`cú_·r£_gged_¡ršg
(
d
, 
CCN_DTAG_AùiÚ
, 
¡Üe
);

66 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Publish”PublicKeyDige¡
)) {

67 
	`cú_buf_advªû
(
d
);

68 ià(
	`cú_buf_m©ch_blob
(
d
, &
v®
, &
sz
)) {

69 
	`cú_buf_advªû
(
d
);

70 ià(
sz
 != 32)

71 
d
->
decod”
.
¡©e
 = -
__LINE__
;

73 
	`cú_buf_check_şo£
(
d
);

74 ià(
d
->
decod”
.
¡©e
 >= 0) {

75 
cúd_id_off
 = 
¡Üe
->
Ëngth
;

76 
	`cú_ch¬buf_­³nd
(
¡Üe
, 
v®
, 
sz
);

77 
»suÉ
->
cúd_id_size
 = 
sz
;

80 
»suÉ
->
çûid
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
, 
CCN_DTAG_FaûID
);

81 
»suÉ
->
desü
.
´Ùo
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
, 
CCN_DTAG_IPPrÙo
);

82 
ho¡_off
 = 
	`cú_·r£_gged_¡ršg
(
d
, 
CCN_DTAG_Ho¡
, 
¡Üe
);

83 
pÜt_off
 = 
	`cú_·r£_gged_¡ršg
(
d
, 
CCN_DTAG_PÜt
, 
¡Üe
);

84 
mÿ¡_off
 = 
	`cú_·r£_gged_¡ršg
(
d
, 
CCN_DTAG_MuÉiÿ¡IÁ”çû
, 
¡Üe
);

85 
»suÉ
->
desü
.
mÿ¡_‰l
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
, 
CCN_DTAG_MuÉiÿ¡TTL
);

86 
»suÉ
->
liãtime
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
, 
CCN_DTAG_F»shÃssSecÚds
);

87 
	`cú_buf_check_şo£
(
d
);

90 
d
->
decod”
.
¡©e
 = -
__LINE__
;

92 ià(
d
->
decod”
.
šdex
 !ğ
size
 || !
	`CCN_FINAL_DSTATE
(d->decod”.
¡©e
))

93 
	`cú_çû_š¡ªû_de¡roy
(&
»suÉ
);

95 *
b
 = (*)
¡Üe
->
buf
;

96 
»suÉ
->
aùiÚ
 = (
aùiÚ_off
 =ğ-1è? 
NULL
 : 
b
 +‡ction_off;

97 
»suÉ
->
cúd_id
 = (
cúd_id_off
 =ğ-1è? 
NULL
 : 
¡Üe
->
buf
 + ccnd_id_off;

98 
»suÉ
->
desü
.
add»ss
 = (
ho¡_off
 =ğ-1è? 
NULL
 : 
b
 + host_off;

99 
»suÉ
->
desü
.
pÜt
 = (
pÜt_off
 =ğ-1è? 
NULL
 : 
b
 +…ort_off;

100 
»suÉ
->
desü
.
sourû_add»ss
 = (
mÿ¡_off
 =ğ-1è? 
NULL
 : 
b
 + mcast_off;

102 (
»suÉ
);

103 
	}
}

109 
	$cú_çû_š¡ªû_de¡roy
(
cú_çû_š¡ªû
 **
pfi
)

111 ià(*
pfi
 =ğ
NULL
)

113 
	`cú_ch¬buf_de¡roy
(&(*
pfi
)->
¡Üe
);

114 
	`ä“
(*
pfi
);

115 *
pfi
 = 
NULL
;

116 
	}
}

123 
	$cúb_­³nd_çû_š¡ªû
(
cú_ch¬buf
 *
c
,

124 cÚ¡ 
cú_çû_š¡ªû
 *
fi
)

126 
»s
;

127 
»s
 = 
	`cúb_–em’t_begš
(
c
, 
CCN_DTAG_FaûIn¡ªû
);

128 ià(
fi
->
aùiÚ
 !ğ
NULL
)

129 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_AùiÚ
, "%s",

130 
fi
->
aùiÚ
);

131 ià(
fi
->
cúd_id_size
 != 0)

132 
»s
 |ğ
	`cúb_­³nd_gged_blob
(
c
, 
CCN_DTAG_Publish”PublicKeyDige¡
,

133 
fi
->
cúd_id
, fi->
cúd_id_size
);

134 ià(
fi
->
çûid
 != ~0)

135 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_FaûID
, "%u",

136 
fi
->
çûid
);

137 ià(
fi
->
desü
.
´Ùo
 >= 0)

138 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_IPPrÙo
, "%d",

139 
fi
->
desü
.
´Ùo
);

140 ià(
fi
->
desü
.
add»ss
 !ğ
NULL
)

141 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_Ho¡
, "%s",

142 
fi
->
desü
.
add»ss
);

143 ià(
fi
->
desü
.
pÜt
 !ğ
NULL
)

144 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_PÜt
, "%s",

145 
fi
->
desü
.
pÜt
);

146 ià(
fi
->
desü
.
sourû_add»ss
 !ğ
NULL
)

147 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_MuÉiÿ¡IÁ”çû
, "%s",

148 
fi
->
desü
.
sourû_add»ss
);

149 ià(
fi
->
desü
.
mÿ¡_‰l
 >= 0 && fi->descr.mcast_ttl != 1)

150 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_MuÉiÿ¡TTL
, "%d",

151 
fi
->
desü
.
mÿ¡_‰l
);

152 ià(
fi
->
liãtime
 >= 0)

153 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_F»shÃssSecÚds
, "%d",

154 
fi
->
liãtime
);

155 
»s
 |ğ
	`cúb_–em’t_’d
(
c
);

156 (
»s
);

157 
	}
}

	@lib/ccn_header.c

20 
	~<¡ddef.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/ch¬buf.h
>

27 
	~<cú/codšg.h
>

29 
	~<cú/h—d”.h
>

31 cÚ¡ 
	gm‘a
[8] = {
CCN_MARKER_CONTROL
, '.', 'M', 'E', 'T', 'A', '.', 'M'};

34 
	$cú_·r£_gged_»quœed_uštmax
(
cú_buf_decod”
 *
d
, 
cú_dg
 
dg
, 
uštmax_t
 *
»suÉ
)

36 
»s
 = -1;

37 ià(
	`cú_buf_m©ch_dg
(
d
, 
dg
)) {

38 
	`cú_buf_advªû
(
d
);

39 
»s
 = 
	`cú_·r£_uštmax
(
d
, 
»suÉ
);

40 
	`cú_buf_check_şo£
(
d
);

42  (
d
->
decod”
.
¡©e
 = -
__LINE__
);

44  (
»s
);

45 
	}
}

49 
cú_h—d”
 *

50 
	$cú_h—d”_·r£
(cÚ¡ *
p
, 
size_t
 
size
)

52 
cú_buf_decod”
 
decod”
;

53 
cú_buf_decod”
 *
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
p
, 
size
);

54 
cú_h—d”
 *
»suÉ
;

55 cÚ¡ *
blob
;

56 
size_t
 
blobsize
;

57 
»s
 = 0;

59 
»suÉ
 = 
	`ÿÎoc
(1, (*result));

60 ià(
»suÉ
 =ğ
NULL
)

61  (
NULL
);

62 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_H—d”
)) {

63 
	`cú_buf_advªû
(
d
);

64 
»s
 |ğ
	`cú_·r£_gged_»quœed_uštmax
(
d
, 
CCN_DTAG_S¹
, &
»suÉ
->
¡¬t
);

65 
»s
 |ğ
	`cú_·r£_gged_»quœed_uštmax
(
d
, 
CCN_DTAG_CouÁ
, &
»suÉ
->
couÁ
);

66 
»s
 |ğ
	`cú_·r£_gged_»quœed_uštmax
(
d
, 
CCN_DTAG_BlockSize
, &
»suÉ
->
block_size
);

67 
»s
 |ğ
	`cú_·r£_gged_»quœed_uštmax
(
d
, 
CCN_DTAG_L’gth
, &
»suÉ
->
Ëngth
);

68 ià(
»s
 != 0) {

69 
	`ä“
(
»suÉ
);

70  (
NULL
);

72 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CÚ‹ÁDige¡
)) {

73 
	`cú_buf_advªû
(
d
);

74 ià(
	`cú_buf_m©ch_blob
(
d
, &
blob
, &
blobsize
)) {

75 
»suÉ
->
cÚ‹Á_dige¡
 = 
	`cú_ch¬buf_ü—‹
();

76 
	`cú_ch¬buf_­³nd
(
»suÉ
->
cÚ‹Á_dige¡
, 
blob
, 
blobsize
);

77 
	`cú_buf_advªû
(
d
);

79 
	`cú_buf_check_şo£
(
d
);

81 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_RoÙDige¡
)) {

82 
	`cú_buf_advªû
(
d
);

83 ià(
	`cú_buf_m©ch_blob
(
d
, &
blob
, &
blobsize
)) {

84 
»suÉ
->
roÙ_dige¡
 = 
	`cú_ch¬buf_ü—‹
();

85 
	`cú_ch¬buf_­³nd
(
»suÉ
->
roÙ_dige¡
, 
blob
, 
blobsize
);

86 
	`cú_buf_advªû
(
d
);

88 
	`cú_buf_check_şo£
(
d
);

90 
	`cú_buf_check_şo£
(
d
);

93 
d
->
decod”
.
¡©e
 = -
__LINE__
;

95 ià(
d
->
decod”
.
šdex
 !ğ
size
 || !
	`CCN_FINAL_DSTATE
(d->decod”.
¡©e
)) {

96 
	`cú_h—d”_de¡roy
(&
»suÉ
);

98  (
»suÉ
);

99 
	}
}

104 
	$cú_h—d”_de¡roy
(
cú_h—d”
 **
ph
)

106 ià(*
ph
 =ğ
NULL
)

108 
	`cú_ch¬buf_de¡roy
(&(*
ph
)->
roÙ_dige¡
);

109 
	`cú_ch¬buf_de¡roy
(&(*
ph
)->
cÚ‹Á_dige¡
);

110 
	`ä“
(*
ph
);

111 *
ph
 = 
NULL
;

112 
	}
}

115 
	$cúb_­³nd_h—d”
(
cú_ch¬buf
 *
c
,

116 cÚ¡ 
cú_h—d”
 *
h
)

118 
»s
;

119 
»s
 = 
	`cúb_–em’t_begš
(
c
, 
CCN_DTAG_H—d”
);

120 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_S¹
, "%u", 
h
->
¡¬t
);

121 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_CouÁ
, "%u", 
h
->
couÁ
);

122 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_BlockSize
, "%u", 
h
->
block_size
);

123 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_L’gth
, "%u", 
h
->
Ëngth
);

124 ià(
h
->
cÚ‹Á_dige¡
 !ğ
NULL
) {

125 
»s
 |ğ
	`cúb_­³nd_gged_blob
(
c
, 
CCN_DTAG_CÚ‹ÁDige¡
,

126 
h
->
cÚ‹Á_dige¡
->
buf
, h->cÚ‹Á_dige¡->
Ëngth
);

128 ià(
h
->
roÙ_dige¡
 !ğ
NULL
) {

129 
»s
 |ğ
	`cúb_­³nd_gged_blob
(
c
, 
CCN_DTAG_RoÙDige¡
,

130 
h
->
roÙ_dige¡
->
buf
, h->roÙ_dige¡->
Ëngth
);

132 
»s
 |ğ
	`cúb_–em’t_’d
(
c
);

133  (
»s
);

134 
	}
}

136 
cú_h—d”
 *

137 
	$cú_g‘_h—d”
(
cú
 *
h
, 
cú_ch¬buf
 *
Çme
, 
timeout
)

139 
cú_ch¬buf
 *
hn
;

140 
cú_h—d”
 *
»suÉ
 = 
NULL
;

141 
»s
;

143 
hn
 = 
	`cú_ch¬buf_ü—‹
();

144 
	`cú_ch¬buf_­³nd_ch¬buf
(
hn
, 
Çme
);

149 
	`cú_Çme_­³nd
(
hn
, 
m‘a
, (meta));

150 
	`cú_Çme_­³nd_¡r
(
hn
, ".header");

151 
»s
 = 
	`cú_»sŞve_v”siÚ
(
h
, 
hn
, 
CCN_V_HIGHEST
, 
timeout
);

152 ià(
»s
 != 0) {

154 
	`cú_ch¬buf_»£t
(
hn
);

155 
	`cú_ch¬buf_­³nd_ch¬buf
(
hn
, 
Çme
);

156 
	`cú_Çme_­³nd_¡r
(
hn
, "_meta_");

157 
	`cú_Çme_­³nd_¡r
(
hn
, ".header");

158 
»s
 = 
	`cú_»sŞve_v”siÚ
(
h
, 
hn
, 
CCN_V_HIGHEST
, 
timeout
);

161 ià(
»s
 == 0) {

162 
cú_ch¬buf
 *
ho
 = 
	`cú_ch¬buf_ü—‹
();

163 
cú_·r£d_CÚ‹ÁObjeù
 
pcobuf
 = { 0 };

164 cÚ¡ *
hc
;

165 
size_t
 
hcs
;

167 
»s
 = 
	`cú_g‘
(
h
, 
hn
, 
NULL
, 
timeout
, 
ho
, &
pcobuf
, NULL, 0);

168 ià(
»s
 == 0) {

169 
hc
 = 
ho
->
buf
;

170 
hcs
 = 
ho
->
Ëngth
;

171 
	`cú_cÚ‹Á_g‘_v®ue
(
hc
, 
hcs
, &
pcobuf
, &hc, &hcs);

172 
»suÉ
 = 
	`cú_h—d”_·r£
(
hc
, 
hcs
);

174 
	`cú_ch¬buf_de¡roy
(&
ho
);

176 
	`cú_ch¬buf_de¡roy
(&
hn
);

177  (
»suÉ
);

178 
	}
}

	@lib/ccn_indexbuf.c

20 
	~<¡ddef.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<cú/šdexbuf.h
>

25 
	#ELEMENT
 
size_t


	)

30 
cú_šdexbuf
 *

31 
	$cú_šdexbuf_ü—‹
()

33 
cú_šdexbuf
 *
c
;

34 
c
 = 
	`ÿÎoc
(1, (*c));

35 (
c
);

36 
	}
}

42 
	$cú_šdexbuf_de¡roy
(
cú_šdexbuf
 **
cbp
)

44 
cú_šdexbuf
 *
c
 = *
cbp
;

45 ià(
c
 !ğ
NULL
) {

46 ià(
c
->
buf
 !ğ
NULL
) {

47 
	`ä“
(
c
->
buf
);

49 
	`ä“
(
c
);

50 *
cbp
 = 
NULL
;

52 
	}
}

58 
ELEMENT
 *

59 
	$cú_šdexbuf_»£rve
(
cú_šdexbuf
 *
c
, 
size_t
 
n
)

61 
size_t
 
Ãwlim
 = 
n
 + 
c
->n;

62 
size_t
 
Şdlim
 = 
c
->
lim™
;

63 
ELEMENT
 *
buf
 = 
c
->buf;

64 ià(
Ãwlim
 < 
n
)

65 (
NULL
);

66 ià(
Ãwlim
 > 
Şdlim
) {

67 ià(2 * 
Şdlim
 > 
Ãwlim
)

68 
Ãwlim
 = 2 * 
Şdlim
;

69 
buf
 = 
	`»®loc
(
c
->buf, 
Ãwlim
 * (
ELEMENT
));

70 ià(
buf
 =ğ
NULL
)

71 (
NULL
);

72 
	`mem£t
(
buf
 + 
Şdlim
, 0, (
Ãwlim
 - oldlimè* (
ELEMENT
));

73 
c
->
buf
 = buf;

74 
c
->
lim™
 = 
Ãwlim
;

76 
buf
 +ğ
c
->
n
;

77 (
buf
);

78 
	}
}

85 
	$cú_šdexbuf_­³nd
(
cú_šdexbuf
 *
c
, cÚ¡ 
ELEMENT
 *
p
, 
size_t
 
n
)

87 
ELEMENT
 *
d¡
 = 
	`cú_šdexbuf_»£rve
(
c
, 
n
);

88 ià(
d¡
 =ğ
NULL
)

90 
	`memıy
(
d¡
, 
p
, 
n
 * (
ELEMENT
));

91 
c
->
n
 +=‚;

93 
	}
}

100 
	$cú_šdexbuf_­³nd_–em’t
(
cú_šdexbuf
 *
c
, 
ELEMENT
 
v
)

102 
ELEMENT
 *
d¡
 = 
	`cú_šdexbuf_»£rve
(
c
, 1);

103 ià(
d¡
 =ğ
NULL
)

105 *
d¡
 = 
v
;

106 
c
->
n
 += 1;

108 
	}
}

114 
	$cú_šdexbuf_memb”
(
cú_šdexbuf
 *
x
, 
ELEMENT
 
v®
)

116 
i
;

117 ià(
x
 =ğ
NULL
)

119 
i
 = 
x
->
n
 - 1; i >= 0; i--)

120 ià(
x
->
buf
[
i
] =ğ
v®
)

121 (
i
);

123 
	}
}

130 
	$cú_šdexbuf_»move_–em’t
(
cú_šdexbuf
 *
x
, 
ELEMENT
 
v®
)

132 
i
;

133 ià(
x
 =ğ
NULL
) ;

134 
i
 = 
x
->
n
 - 1; i >= 0; i--)

135 ià(
x
->
buf
[
i
] =ğ
v®
) {

136 
x
->
buf
[
i
] = x->buf[--x->
n
];

139 
	}
}

146 
	$cú_šdexbuf_£t_š£¹
(
cú_šdexbuf
 *
x
, 
ELEMENT
 
v®
)

148 
i
;

149 ià(
x
 =ğ
NULL
)

151 
i
 = 0; i < 
x
->
n
; i++)

152 ià(
x
->
buf
[
i
] =ğ
v®
)

153 (
i
);

154 ià(
	`cú_šdexbuf_­³nd_–em’t
(
x
, 
v®
) < 0)

156 (
i
);

157 
	}
}

165 
	$cú_šdexbuf_»move_fœ¡_m©ch
(
cú_šdexbuf
 *
x
, 
ELEMENT
 
v®
)

167 
i
;

168 
n
;

169 ià(
x
 =ğ
NULL
)

171 
i
 = 0, 
n
 = 
x
->n; i <‚; i++) {

172 ià(
x
->
buf
[
i
] =ğ
v®
) {

173 ià(
i
 + 1 < 
n
)

174 
	`memmove
(&(
x
->
buf
[
i
]),

175 &(
x
->
buf
[
i
 + 1]),

176 (
x
->
buf
[
i
]è* (
n
 - i - 1));

177 
x
->
n
--;

178 (
i
);

182 
	}
}

188 
	$cú_šdexbuf_move_to_’d
(
cú_šdexbuf
 *
x
, 
ELEMENT
 
v®
)

190 
i
;

191 
n
;

192 ià(
x
 =ğ
NULL
)

194 
i
 = 0, 
n
 = 
x
->n; i + 1 <‚; i++) {

195 ià(
x
->
buf
[
i
] =ğ
v®
) {

196 
	`memmove
(&(
x
->
buf
[
i
]),

197 &(
x
->
buf
[
i
 + 1]),

198 (
x
->
buf
[
i
]è* (
n
 - i - 1));

199 
x
->
buf
[
n
 - 1] = 
v®
;

203 
	}
}

209 
	$cú_šdexbuf_move_to_äÚt
(
cú_šdexbuf
 *
x
, 
ELEMENT
 
v®
)

211 
i
;

212 
n
;

213 ià(
x
 =ğ
NULL
)

215 
i
 = 0, 
n
 = 
x
->n; i <‚; i++) {

216 ià(
x
->
buf
[
i
] =ğ
v®
) {

217 
	`memmove
(&(
x
->
buf
[1]),

218 &(
x
->
buf
[0]),

219 (
x
->
buf
[
i
]) * i);

220 
x
->
buf
[0] = 
v®
;

225 
	}
}

	@lib/ccn_interest.c

23 
	~<cú/cú.h
>

24 
	~<cú/ch¬buf.h
>

25 
	~<cú/codšg.h
>

31 
štmax_t


32 
	$cú_š‹»¡_liãtime
(cÚ¡ *
msg
,

33 cÚ¡ 
cú_·r£d_š‹»¡
 *
pi
)

35 
cú_buf_decod”
 
decod”
;

36 
cú_buf_decod”
 *
d
 = 
NULL
;

37 
¡¬t
 = 
pi
->
off£t
[
CCN_PI_B_IÁ”e¡Liãtime
];

38 
size_t
 
size
 = 
pi
->
off£t
[
CCN_PI_E_IÁ”e¡Liãtime
] - 
¡¬t
;

39 
uštmax_t
 
v®
;

40 ià(
size
 == 0)

41 (
CCN_INTEREST_LIFETIME_SEC
 << 12);

42 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
msg
 + 
¡¬t
, 
size
);

43 
v®
 = 
	`cú_·r£_İtiÚ®_gged_bš¬y_numb”
(
d
, 
CCN_DTAG_IÁ”e¡Liãtime
,

44 1, 7, 
CCN_INTEREST_LIFETIME_SEC
 << 12);

45 ià(
d
->
decod”
.
¡©e
 < 0)

46  (
d
->
decod”
.
¡©e
);

47 (
v®
);

48 
	}
}

56 
	$cú_š‹»¡_liãtime_£cÚds
(cÚ¡ *
msg
,

57 cÚ¡ 
cú_·r£d_š‹»¡
 *
pi
)

59 
štmax_t
 
v®
 = 
	`cú_š‹»¡_liãtime
(
msg
, 
pi
);

60 ià(
v®
 < 0)

61 (
v®
);

62 (
v®
 >> 12);

63 
	}
}

	@lib/ccn_keystore.c

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<İ’s¦/pkcs12.h
>

23 
	~<İ’s¦/sha.h
>

25 
	~<cú/key¡Üe.h
>

27 
	scú_key¡Üe
 {

28 
	mš™Ÿlized
;

29 
EVP_PKEY
 *
	m´iv©e_key
;

30 
EVP_PKEY
 *
	mpublic_key
;

31 
X509
 *
	mû¹ifiÿ‹
;

32 
ssize_t
 
	mpubkey_dige¡_Ëngth
;

33 
	mpubkey_dige¡
[
SHA256_DIGEST_LENGTH
];

36 
cú_key¡Üe
 *

37 
	$cú_key¡Üe_ü—‹
()

39 
cú_key¡Üe
 *
»s
 = 
	`ÿÎoc
(1, (*res));

40  (
»s
);

41 
	}
}

44 
	$cú_key¡Üe_de¡roy
(
cú_key¡Üe
 **
p
)

46 ià(*
p
 !ğ
NULL
) {

47 ià((*
p
)->
´iv©e_key
 !ğ
NULL
)

48 
	`EVP_PKEY_ä“
((*
p
)->
´iv©e_key
);

49 ià((*
p
)->
public_key
 !ğ
NULL
)

50 
	`EVP_PKEY_ä“
((*
p
)->
public_key
);

51 ià((*
p
)->
û¹ifiÿ‹
 !ğ
NULL
)

52 
	`X509_ä“
((*
p
)->
û¹ifiÿ‹
);

53 
	`ä“
(*
p
);

54 *
p
 = 
NULL
;

56 
	}
}

59 
	$cú_key¡Üe_š™
(
cú_key¡Üe
 *
p
, *
Çme
, *
·sswÜd
)

61 
FILE
 *
å
;

62 
PKCS12
 *
key¡Üe
;

63 
»s
;

65 
	`O³nSSL_add_®l_®gÜ™hms
();

66 
å
 = 
	`fİ’
(
Çme
, "rb");

67 ià(
å
 =ğ
NULL
)

70 
key¡Üe
 = 
	`d2i_PKCS12_å
(
å
, 
NULL
);

71 
	`fşo£
(
å
);

72 ià(
key¡Üe
 =ğ
NULL
)

75 
»s
 = 
	`PKCS12_·r£
(
key¡Üe
, 
·sswÜd
, &(
p
->
´iv©e_key
), &Õ->
û¹ifiÿ‹
), 
NULL
);

76 
	`PKCS12_ä“
(
key¡Üe
);

77 ià(
»s
 == 0) {

80 
p
->
public_key
 = 
	`X509_g‘_pubkey
Õ->
û¹ifiÿ‹
);

82 ià(1 !ğ
	`ASN1_™em_dige¡
(
	`ASN1_ITEM_½Œ
(
X509_PUBKEY
), 
	`EVP_sha256
(),

83 
	`X509_g‘_X509_PUBKEY
(
p
->
û¹ifiÿ‹
),

84 
p
->
pubkey_dige¡
, 
NULL
))  (-1);

85 
p
->
pubkey_dige¡_Ëngth
 = 
SHA256_DIGEST_LENGTH
;

86 
p
->
š™Ÿlized
 = 1;

88 
	}
}

90 cÚ¡ 
cú_pkey
 *

91 
	$cú_key¡Üe_´iv©e_key
(
cú_key¡Üe
 *
p
)

93 ià(0 =ğ
p
->
š™Ÿlized
)

94  (
NULL
);

96  ((cÚ¡ 
cú_pkey
 *)(
p
->
´iv©e_key
));

97 
	}
}

99 cÚ¡ 
cú_pkey
 *

100 
	$cú_key¡Üe_public_key
(
cú_key¡Üe
 *
p
)

102 ià(0 =ğ
p
->
š™Ÿlized
)

103  (
NULL
);

105  ((cÚ¡ 
cú_pkey
 *)(
p
->
public_key
));

106 
	}
}

108 
ssize_t


109 
	$cú_key¡Üe_public_key_dige¡_Ëngth
(
cú_key¡Üe
 *
p
)

111  ((0 =ğ
p
->
š™Ÿlized
è? -1 :…->
pubkey_dige¡_Ëngth
);

112 
	}
}

115 
	$cú_key¡Üe_public_key_dige¡
(
cú_key¡Üe
 *
p
)

117 ià(0 =ğ
p
->
š™Ÿlized
)

118  (
NULL
);

119  (
p
->
pubkey_dige¡
);

120 
	}
}

122 cÚ¡ 
cú_û¹ifiÿ‹
 *

123 
	$cú_key¡Üe_û¹ifiÿ‹
(
cú_key¡Üe
 *
p
)

125 ià(0 =ğ
p
->
š™Ÿlized
)

126  (
NULL
);

128  ((cÚ¡ *)(
p
->
û¹ifiÿ‹
));

129 
	}
}

	@lib/ccn_match.c

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<cú/bloom.h
>

23 
	~<cú/cú.h
>

24 
	~<cú/ch¬buf.h
>

25 
	~<cú/codšg.h
>

26 
	~<cú/dige¡.h
>

33 
	$cú_dige¡_CÚ‹ÁObjeù
(cÚ¡ *
cÚ‹Á_objeù
,

34 
cú_·r£d_CÚ‹ÁObjeù
 *
pc
)

36 
»s
;

37 
cú_dige¡
 *
d
 = 
NULL
;

39 ià(
pc
->
magic
 < 20080000è
	`abÜt
();

40 ià(
pc
->
dige¡_by‹s
 =ğÕc->
dige¡
))

42 ià(
pc
->
dige¡_by‹s
 !ğ0è
	`abÜt
();

43 
d
 = 
	`cú_dige¡_ü—‹
(
CCN_DIGEST_SHA256
);

44 
	`cú_dige¡_š™
(
d
);

45 
»s
 = 
	`cú_dige¡_upd©e
(
d
, 
cÚ‹Á_objeù
, 
pc
->
off£t
[
CCN_PCO_E
]);

46 ià(
»s
 < 0è
	`abÜt
();

47 
»s
 = 
	`cú_dige¡_fš®
(
d
, 
pc
->
dige¡
, (pc->digest));

48 ià(
»s
 < 0è
	`abÜt
();

49 ià(
pc
->
dige¡_by‹s
 !ğ0è
	`abÜt
();

50 
pc
->
dige¡_by‹s
 = Õc->
dige¡
);

51 
	`cú_dige¡_de¡roy
(&
d
);

52 
	}
}

55 
	$cú_pubid_m©ches
(cÚ¡ *
cÚ‹Á_objeù
,

56 
cú_·r£d_CÚ‹ÁObjeù
 *
pc
,

57 cÚ¡ *
š‹»¡_msg
,

58 cÚ¡ 
cú_·r£d_š‹»¡
 *
pi
)

60 
cú_buf_decod”
 
decod”
;

61 
cú_buf_decod”
 *
d
;

62 
pubid¡¬t
;

63 
pubidby‹s
;

64 
cÚ‹Ápubid¡¬t
 = 0;

65 
cÚ‹Ápubidby‹s
 = 0;

66 
pubid¡¬t
 = 
pi
->
off£t
[
CCN_PI_B_Publish”IDKeyDige¡
];

67 
pubidby‹s
 = 
pi
->
off£t
[
CCN_PI_E_Publish”IDKeyDige¡
] - 
pubid¡¬t
;

68 ià(
pubidby‹s
 > 0) {

69 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
,

70 
cÚ‹Á_objeù
 +

71 
pc
->
off£t
[
CCN_PCO_B_Publish”PublicKeyDige¡
],

72 (
pc
->
off£t
[
CCN_PCO_E_Publish”PublicKeyDige¡
] -

73 
pc
->
off£t
[
CCN_PCO_B_Publish”PublicKeyDige¡
]));

74 
	`cú_buf_advªû
(
d
);

75 ià(
	`cú_buf_m©ch_some_blob
(
d
)) {

76 
cÚ‹Ápubid¡¬t
 = 
d
->
decod”
.
tok’_šdex
;

77 
	`cú_buf_advªû
(
d
);

78 
cÚ‹Ápubidby‹s
 = 
d
->
decod”
.
tok’_šdex
 - 
cÚ‹Ápubid¡¬t
;

80 ià(
pubidby‹s
 !ğ
cÚ‹Ápubidby‹s
)

82 ià(0 !ğ
	`memcmp
(
š‹»¡_msg
 + 
pubid¡¬t
,

83 
d
->
buf
 + 
cÚ‹Ápubid¡¬t
,

84 
pubidby‹s
))

88 
	}
}

110 
	$cú_cÚ‹Á_m©ches_š‹»¡
(cÚ¡ *
cÚ‹Á_objeù
,

111 
size_t
 
cÚ‹Á_objeù_size
,

112 
im¶ic™_cÚ‹Á_dige¡
,

113 
cú_·r£d_CÚ‹ÁObjeù
 *
pc
,

114 cÚ¡ *
š‹»¡_msg
,

115 
size_t
 
š‹»¡_msg_size
,

116 cÚ¡ 
cú_·r£d_š‹»¡
 *
pi
)

118 
cú_·r£d_CÚ‹ÁObjeù
 
pc_¡Üe
;

119 
cú_·r£d_š‹»¡
 
pi_¡Üe
;

120 
»s
;

121 
ncomps
;

122 
´efix¡¬t
;

123 
´efixby‹s
;

124 
Çmecomp¡¬t
;

125 
Çmecompby‹s
;

126 
checkdige¡
 = 0;

127 
cú_buf_decod”
 
decod”
;

128 
cú_buf_decod”
 *
d
;

129 cÚ¡ *
Ãxtcomp
;

130 
size_t
 
Ãxtcomp_size
 = 0;

131 cÚ¡ *
comp
;

132 
size_t
 
comp_size
 = 0;

133 cÚ¡ *
bloom
;

134 
size_t
 
bloom_size
 = 0;

135 
m©ch_ªy
[2] = "-";

136 ià(
pc
 =ğ
NULL
) {

137 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
cÚ‹Á_objeù
, 
cÚ‹Á_objeù_size
,

138 &
pc_¡Üe
, 
NULL
);

139 ià(
»s
 < 0) (0);

140 
pc
 = &
pc_¡Üe
;

142 ià(
pi
 =ğ
NULL
) {

143 
»s
 = 
	`cú_·r£_š‹»¡
(
š‹»¡_msg
, 
š‹»¡_msg_size
,

144 &
pi_¡Üe
, 
NULL
);

145 ià(
»s
 < 0) (0);

146 
pi
 = &
pi_¡Üe
;

148 ià(!
	`cú_pubid_m©ches
(
cÚ‹Á_objeù
, 
pc
, 
š‹»¡_msg
, 
pi
))

150 
ncomps
 = 
pc
->
Çme_ncomps
 + (
im¶ic™_cÚ‹Á_dige¡
 ? 1 : 0);

151 ià(
ncomps
 < 
pi
->
´efix_comps
 +…i->
mš_suffix_comps
)

153 ià(
ncomps
 > 
pi
->
´efix_comps
 +…i->
max_suffix_comps
)

155 
´efix¡¬t
 = 
pi
->
off£t
[
CCN_PI_B_CompÚ’t0
];

156 
´efixby‹s
 = 
pi
->
off£t
[
CCN_PI_E_La¡P»fixCompÚ’t
] - 
´efix¡¬t
;

157 
Çmecomp¡¬t
 = 
pc
->
off£t
[
CCN_PCO_B_CompÚ’t0
];

158 
Çmecompby‹s
 = 
pc
->
off£t
[
CCN_PCO_E_CompÚ’tLa¡
] - 
Çmecomp¡¬t
;

159 ià(
´efixby‹s
 > 
Çmecompby‹s
) {

164 ià(
im¶ic™_cÚ‹Á_dige¡
 &&

165 
pi
->
off£t
[
CCN_PI_B_La¡P»fixCompÚ’t
] - 
´efix¡¬t
 =ğ
Çmecompby‹s
 &&

166 (
pi
->
off£t
[
CCN_PI_E_La¡P»fixCompÚ’t
] -

167 
pi
->
off£t
[
CCN_PI_B_La¡P»fixCompÚ’t
]) == 1 + 2 + 32 + 1) {

168 
´efixby‹s
 = 
Çmecompby‹s
;

169 
checkdige¡
 = 1;

174 ià(0 !ğ
	`memcmp
(
š‹»¡_msg
 + 
´efix¡¬t
,

175 
cÚ‹Á_objeù
 + 
Çmecomp¡¬t
,

176 
´efixby‹s
))

178 ià(
checkdige¡
) {

183 
	`cú_dige¡_CÚ‹ÁObjeù
(
cÚ‹Á_objeù
, 
pc
);

184 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
,

185 
š‹»¡_msg
 + 
pi
->
off£t
[
CCN_PI_B_La¡P»fixCompÚ’t
],

186 (
pi
->
off£t
[
CCN_PI_E_La¡P»fixCompÚ’t
] -

187 
pi
->
off£t
[
CCN_PI_B_La¡P»fixCompÚ’t
]));

188 
comp_size
 = 0;

189 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

190 
	`cú_buf_advªû
(
d
);

191 
	`cú_buf_m©ch_blob
(
d
, &
comp
, &
comp_size
);

193 ià(
comp_size
 !ğ
pc
->
dige¡_by‹s
è
	`abÜt
();

194 ià(0 !ğ
	`memcmp
(
comp
, 
pc
->
dige¡
, 
comp_size
))

197 ià(
pi
->
off£t
[
CCN_PI_E_Exşude
] >…i->off£t[
CCN_PI_B_Exşude
]) {

198 ià(
´efixby‹s
 < 
Çmecompby‹s
) {

200 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
,

201 
cÚ‹Á_objeù
 +

202 (
Çmecomp¡¬t
 + 
´efixby‹s
),

203 
pc
->
off£t
[
CCN_PCO_E_CompÚ’tLa¡
] -

204 (
Çmecomp¡¬t
 + 
´efixby‹s
));

205 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

206 
	`cú_buf_advªû
(
d
);

207 
	`cú_buf_m©ch_blob
(
d
, &
Ãxtcomp
, &
Ãxtcomp_size
);

212 ià(!
im¶ic™_cÚ‹Á_dige¡
)

213 
exşude_checked
;

214 ià(
´efixby‹s
 =ğ
Çmecompby‹s
) {

216 
	`cú_dige¡_CÚ‹ÁObjeù
(
cÚ‹Á_objeù
, 
pc
);

217 
Ãxtcomp_size
 = 
pc
->
dige¡_by‹s
;

218 
Ãxtcomp
 = 
pc
->
dige¡
;

220 
	`abÜt
();

221 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
,

222 
š‹»¡_msg
 + 
pi
->
off£t
[
CCN_PI_B_Exşude
],

223 
pi
->
off£t
[
CCN_PI_E_Exşude
] -

224 
pi
->
off£t
[
CCN_PI_B_Exşude
]);

225 ià(!
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Exşude
))

226 
	`abÜt
();

227 
	`cú_buf_advªû
(
d
);

228 
bloom
 = 
NULL
;

229 
bloom_size
 = 0;

230 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Any
)) {

231 
	`cú_buf_advªû
(
d
);

232 
bloom
 = 
m©ch_ªy
;

233 
	`cú_buf_check_şo£
(
d
);

235 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Bloom
)) {

236 
	`cú_buf_advªû
(
d
);

237 ià(
	`cú_buf_m©ch_blob
(
d
, &
bloom
, &
bloom_size
))

238 
	`cú_buf_advªû
(
d
);

239 
	`cú_buf_check_şo£
(
d
);

241 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

242 
	`cú_buf_advªû
(
d
);

243 
comp_size
 = 0;

244 ià(
	`cú_buf_m©ch_blob
(
d
, &
comp
, &
comp_size
))

245 
	`cú_buf_advªû
(
d
);

246 
	`cú_buf_check_şo£
(
d
);

247 ià(
comp_size
 > 
Ãxtcomp_size
)

249 ià(
comp_size
 =ğ
Ãxtcomp_size
) {

250 
»s
 = 
	`memcmp
(
comp
, 
Ãxtcomp
, 
comp_size
);

251 ià(
»s
 == 0)

253 ià(
»s
 > 0)

256 
bloom
 = 
NULL
;

257 
bloom_size
 = 0;

258 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Any
)) {

259 
	`cú_buf_advªû
(
d
);

260 
bloom
 = 
m©ch_ªy
;

261 
	`cú_buf_check_şo£
(
d
);

263 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Bloom
)) {

264 
	`cú_buf_advªû
(
d
);

265 ià(
	`cú_buf_m©ch_blob
(
d
, &
bloom
, &
bloom_size
))

266 
	`cú_buf_advªû
(
d
);

267 
	`cú_buf_check_şo£
(
d
);

273 ià(
bloom
 =ğ
m©ch_ªy
)

275 ià(
bloom_size
 != 0) {

276 cÚ¡ 
cú_bloom_wœe
 *
f
 = 
	`cú_bloom_v®id©e_wœe
(
bloom
, 
bloom_size
);

278 ià(
f
 =ğ
NULL
)

280 ià(
	`cú_bloom_m©ch_wœe
(
f
, 
Ãxtcomp
, 
Ãxtcomp_size
))

283 
exşude_checked
: {}

290 
	}
}

	@lib/ccn_matrix.c

23 
	~<¡ddef.h
>

24 
	~<¡dlib.h
>

25 
	~<¡ršg.h
>

26 
	~<cú/m©rix.h
>

27 
	~<cú/hashtb.h
>

29 
	scú_m©rix
 {

30 
hashtb_’um”©Ü
 
	me
;

33 
	scú_m©rix_key
 {

34 
ušt_Ëa¡64_t
 
	mrow
;

35 
	mcŞ
;

38 
cú_m©rix
 *

39 
	$cú_m©rix_ü—‹
()

41 
cú_m©rix
 *
m
;

42 
size_t
 
size
 = (
šŒ_t
);

43 ià(
size
 < (
ušt_Ëa¡64_t
))

44 
size
 = (
ušt_Ëa¡64_t
);

45 
m
 = 
	`ÿÎoc
(1, (*m));

46 ià(
m
 !ğ
NULL
)

47 
	`hashtb_¡¬t
(
	`hashtb_ü—‹
((
ušt_Ëa¡64_t
), 
NULL
), &
m
->
e
);

48 (
m
);

49 
	}
}

52 
	$cú_m©rix_de¡roy
(
cú_m©rix
 **
mp
)

54 
cú_m©rix
 *
m
 = *
mp
;

55 ià(
m
 !ğ
NULL
) {

56 
hashtb
 *
ht
 = 
m
->
e
.ht;

57 
	`hashtb_’d
(&
m
->
e
);

58 
	`hashtb_de¡roy
(&
ht
);

59 
	`ä“
(
m
);

60 *
mp
 = 
NULL
;

62 
	}
}

65 
šŒ_t


66 
	$cú_m©rix_ãtch
(
cú_m©rix
 *
m
, 
ušt_Ëa¡64_t
 
row
, 
cŞ
)

68 
šŒ_t
 *
v®p
;

69 
cú_m©rix_key
 
key
;

70 
	`mem£t
(&
key
, 0, (key));

71 
key
.
row
 =„ow;

72 
key
.
cŞ
 = col;

73 
v®p
 = 
	`hashtb_lookup
(
m
->
e
.
ht
, &
key
, (key));

74 (
v®p
 =ğ
NULL
 ? 0 : *valp);

75 
	}
}

78 
	$cú_m©rix_¡Üe
(
cú_m©rix
 *
m
, 
ušt_Ëa¡64_t
 
row
, 
cŞ
,

79 
šŒ_t
 
v®ue
)

81 
šŒ_t
 *
v®p
;

82 
cú_m©rix_key
 
key
;

83 
	`mem£t
(&
key
, 0, (key));

84 
key
.
row
 =„ow;

85 
key
.
cŞ
 = col;

86 ià(
	`hashtb_£ek
(&(
m
->
e
), &
key
, (key), 0) == -1) ;

87 
v®p
 = 
m
->
e
.
d©a
;

88 *
v®p
 = 
v®ue
;

89 
	}
}

98 
	$cú_m©rix_g‘bounds
(
cú_m©rix
 *
m
, 
cú_m©rix_bounds
 *
»suÉ
)

100 
hashtb_’um”©Ü
 *
e
 = &(
m
->e);

101 
hashtb
 *
ht
 = 
e
->ht;

102 
šŒ_t
 *
v®p
;

103 cÚ¡ 
cú_m©rix_key
 *
key
;

104 
fœ¡
 = 1;

105 
	`hashtb_’d
(
e
);

106 
	`mem£t
(
»suÉ
, 0, (*result));

107 
	`hashtb_¡¬t
(
ht
, 
e
);

108 
e
->
d©a
 !ğ
NULL
) {

109 
v®p
 = 
e
->
d©a
;

110 ià(*
v®p
 == 0)

111 
	`hashtb_d–‘e
(
e
);

113 
key
 = 
e
->key;

114 ià(
fœ¡
 || 
key
->
row
 >ğ
»suÉ
->
row_max
)

115 
»suÉ
->
row_max
 = 
key
->
row
 + 1;

116 ià(
fœ¡
 || 
key
->
row
 < 
»suÉ
->
row_mš
)

117 
»suÉ
->
row_mš
 = 
key
->
row
;

118 ià(
fœ¡
 || 
key
->
cŞ
 >ğ
»suÉ
->
cŞ_max
)

119 
»suÉ
->
cŞ_max
 = 
key
->
cŞ
 + 1;

120 ià(
fœ¡
 || 
key
->
cŞ
 < 
»suÉ
->
cŞ_mš
)

121 
»suÉ
->
cŞ_mš
 = 
key
->
cŞ
;

122 
fœ¡
 = 0;

123 
	`hashtb_Ãxt
(
e
);

126 (
	`hashtb_n
(
ht
));

127 
	}
}

134 
	$cú_m©rix_Œim
(
cú_m©rix
 *
m
, cÚ¡ 
cú_m©rix_bounds
 *
bounds
)

137 
	}
}

144 
	$cú_m©rix_ş—r
(
cú_m©rix
 *
m
, cÚ¡ 
cú_m©rix_bounds
 *
bounds
)

147 
	}
}

	@lib/ccn_merkle_path_asn1.c

6 
	~<cú/m”kË·tha¢1.h
>

8 
ASN1_SEQUENCE
(
MP_šfo
) = {

9 
ASN1_SIMPLE
(
MP_šfo
, 
node
, 
ASN1_INTEGER
),

10 
ASN1_SEQUENCE_OF
(
MP_šfo
, 
hashes
, 
ASN1_OCTET_STRING
)

11 } 
	$ASN1_SEQUENCE_END
(
MP_šfo
)

13 
	`IMPLEMENT_ASN1_FUNCTIONS
(
MP_šfo
)

	@lib/ccn_name_util.c

20 
	~<¡ršg.h
>

21 
	~<¡dlib.h
>

22 
	~<cú/cú.h
>

23 
	~<cú/ch¬buf.h
>

24 
	~<cú/codšg.h
>

25 
	~<cú/šdexbuf.h
>

26 
	~<cú/¿ndom.h
>

33 
	$cú_Çme_š™
(
cú_ch¬buf
 *
c
)

35 
»s
;

36 
c
->
Ëngth
 = 0;

37 
»s
 = 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

38 ià(
»s
 == -1) (res);

39 
»s
 = 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

40 (
»s
);

41 
	}
}

50 
	$cú_Çme_­³nd
(
cú_ch¬buf
 *
c
, cÚ¡ *
compÚ’t
, 
size_t
 
n
)

52 
»s
;

53 cÚ¡ 
şo£r
[2] = {
CCN_CLOSE
, CCN_CLOSE};

54 ià(
c
->
Ëngth
 < 2 || c->
buf
[c->Ëngth-1] !ğ
şo£r
[1])

56 
c
->
Ëngth
 -= 1;

57 
	`cú_ch¬buf_»£rve
(
c
, 
n
 + 8);

58 
»s
 = 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_CompÚ’t
, 
CCN_DTAG
);

59 ià(
»s
 == -1) (res);

60 
»s
 = 
	`cú_ch¬buf_­³nd_‰
(
c
, 
n
, 
CCN_BLOB
);

61 ià(
»s
 == -1) (res);

62 
»s
 = 
	`cú_ch¬buf_­³nd
(
c
, 
compÚ’t
, 
n
);

63 ià(
»s
 == -1) (res);

64 
»s
 = 
	`cú_ch¬buf_­³nd
(
c
, 
şo£r
, (closer));

65 (
»s
);

66 
	}
}

77 
	$cú_Çme_­³nd_¡r
(
cú_ch¬buf
 *
c
, cÚ¡ *
s
)

79 (
	`cú_Çme_­³nd
(
c
, 
s
, 
	`¡¾’
(s)));

80 
	}
}

90 
	$cú_Çme_­³nd_num”ic
(
cú_ch¬buf
 *
c
,

91 
cú_m¬k”
 
m¬k”
, 
uštmax_t
 
v®ue
)

93 
uštmax_t
 
v
;

94 
i
;

95 
b
[32];

97 
v
 = 
v®ue
, 
i
 = (
b
); v != 0 && i > 0; i--, v >>= 8)

98 
b
[
i
-1] = 
v
 & 0xff;

99 ià(
i
 < 1)

101 ià(
m¬k”
 >= 0)

102 
b
[--
i
] = 
m¬k”
;

103 (
	`cú_Çme_­³nd
(
c
, 
b
 + 
i
, (b) - i));

104 
	}
}

114 
	$cú_Çme_­³nd_nÚû
(
cú_ch¬buf
 *
c
)

116 cÚ¡ 
´e
[4] = { 
CCN_MARKER_CONTROL
, '.', 'N', 0 };

117 
b
[15];

119 
	`memıy
(
b
, 
´e
, (pre));

120 
	`cú_¿ndom_by‹s
(
b
 + (
´e
), (b) - (pre));

121 (
	`cú_Çme_­³nd
(
c
, 
b
, (b)));

122 
	}
}

131 
	$cú_Çme_­³nd_compÚ’ts
(
cú_ch¬buf
 *
c
,

132 cÚ¡ *
cúb
,

133 
size_t
 
¡¬t
, size_ˆ
¡İ
)

135 
»s
;

136 ià(
c
->
Ëngth
 < 2 || 
¡¬t
 > 
¡İ
)

138 
c
->
Ëngth
 -= 1;

139 
	`cú_ch¬buf_»£rve
(
c
, 
¡İ
 - 
¡¬t
 + 1);

140 
»s
 = 
	`cú_ch¬buf_­³nd
(
c
, 
cúb
 + 
¡¬t
, 
¡İ
 - start);

141 ià(
»s
 == -1) (res);

142 
»s
 = 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

143 (
»s
);

144 
	}
}

152 
	$cú_Çme_comp_g‘
(cÚ¡ *
d©a
,

153 cÚ¡ 
cú_šdexbuf
 *
šdexbuf
,

154 
i
,

155 cÚ¡ **
comp
, 
size_t
 *
size
)

157 
Ën
;

158 
cú_buf_decod”
 
decod”
;

159 
cú_buf_decod”
 *
d
;

162 ià(
šdexbuf
->
n
 < 2 || 
i
 > indexbuf->n - 2) {

166 
Ën
 = 
šdexbuf
->
buf
[
i
 + 1]-indexbuf->buf[i];

167 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
d©a
 + 
šdexbuf
->
buf
[
i
], 
Ën
);

168 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

169 
	`cú_buf_advªû
(
d
);

170 ià(
	`cú_buf_m©ch_blob
(
d
, 
comp
, 
size
))

172 *
comp
 = 
d
->
buf
 + d->
decod”
.
šdex
;

173 *
size
 = 0;

174 
	`cú_buf_check_şo£
(
d
);

175 ià(
d
->
decod”
.
¡©e
 >= 0)

179 
	}
}

182 
	$cú_Çme_comp_¡rcmp
(cÚ¡ *
d©a
,

183 cÚ¡ 
cú_šdexbuf
 *
šdexbuf
,

184 
i
, cÚ¡ *
v®
)

186 cÚ¡ *
comp_±r
;

187 
size_t
 
comp_size
;

192 ià(
	`cú_Çme_comp_g‘
(
d©a
, 
šdexbuf
, 
i
, &
comp_±r
, &
comp_size
) == 0)

193 (
	`¡ºcmp
(
v®
, (cÚ¡ *)
comp_±r
, 
comp_size
));

196 
	}
}

207 
	$cú_Çme_¥l™
(cÚ¡ 
cú_ch¬buf
 *
c
, 
cú_šdexbuf
 *
compÚ’ts
)

209 
cú_buf_decod”
 
decod”
;

210 
cú_buf_decod”
 *
d
;

211 
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
c
->
buf
, c->
Ëngth
);

212 (
	`cú_·r£_Name
(
d
, 
compÚ’ts
));

213 
	}
}

226 
	$cú_Çme_chİ
(
cú_ch¬buf
 *
c
, 
cú_šdexbuf
 *
compÚ’ts
, 
n
)

228 ià(
compÚ’ts
 =ğ
NULL
) {

229 
»s
;

230 
compÚ’ts
 = 
	`cú_šdexbuf_ü—‹
();

231 ià(
compÚ’ts
 =ğ
NULL
)

233 
»s
 = 
	`cú_Çme_¥l™
(
c
, 
compÚ’ts
);

234 ià(
»s
 >= 0)

235 
»s
 = 
	`cú_Çme_chİ
(
c
, 
compÚ’ts
, 
n
);

236 
	`cú_šdexbuf_de¡roy
(&
compÚ’ts
);

237 (
»s
);

240 ià(
compÚ’ts
->
n
 =ğ0 || compÚ’ts->
buf
[compÚ’ts->n-1] + 1 !ğ
c
->
Ëngth
)

241 ià(
	`cú_Çme_¥l™
(
c
, 
compÚ’ts
) < 0)

243 ià(
n
 < 0)

244 
n
 +ğ(
compÚ’ts
->n - 1);

245 ià(
n
 < 0)

247 ià(
n
 < 
compÚ’ts
->n) {

248 
c
->
Ëngth
 = 
compÚ’ts
->
buf
[
n
];

249 
	`cú_ch¬buf_­³nd_v®ue
(
c
, 
CCN_CLOSE
, 1);

250 
compÚ’ts
->
n
 =‚ + 1;

251 (
n
);

254 
	}
}

262 
	$cú_Çme_Ãxt_siblšg
(
cú_ch¬buf
 *
c
)

264 
»s
 = -1;

265 
cú_šdexbuf
 *
ndx
;

266 *
Ï¡comp
 = 
NULL
;

267 
size_t
 
Ï¡compsize
 = 0;

268 
size_t
 
i
;

269 
ÿ¼y
;

270 
cú_ch¬buf
 *
Ãwcomp
;

272 
ndx
 = 
	`cú_šdexbuf_ü—‹
();

273 ià(
ndx
 =ğ
NULL
è
Fšish
;

274 
»s
 = 
	`cú_Çme_¥l™
(
c
, 
ndx
);

275 ià(
»s
 <= 0) {

276 
»s
 = -1;

277 
Fšish
;

279 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_CompÚ’t
, 
c
->
buf
,

280 
ndx
->
buf
[
»s
-1],‚dx->buf[res],

281 (cÚ¡ **)&
Ï¡comp
,

282 &
Ï¡compsize
);

283 ià(
»s
 < 0è
Fšish
;

284 
ÿ¼y
 = 1, 
i
 = 
Ï¡compsize
; carry && i > 0; i--) {

285 
ÿ¼y
 = (((++
Ï¡comp
[
i
-1]) & 0xFF) == 0x00);

287 ià(
ÿ¼y
) {

288 
Ãwcomp
 = 
	`cú_ch¬buf_ü—‹
();

289 
»s
 |ğ
	`cú_ch¬buf_­³nd_v®ue
(
Ãwcomp
, 0, 1);

290 
»s
 |ğ
	`cú_ch¬buf_­³nd
(
Ãwcomp
, 
Ï¡comp
, 
Ï¡compsize
);

291 
»s
 |ğ
	`cú_Çme_chİ
(
c
, 
ndx
,‚dx->
n
 - 2);

292 
»s
 |ğ
	`cú_Çme_­³nd
(
c
, 
Ãwcomp
->
buf
,‚ewcomp->
Ëngth
);

293 
	`cú_ch¬buf_de¡roy
(&
Ãwcomp
);

294 ià(
»s
 < 0è
Fšish
;

296 
»s
 = 
ndx
->
n
 - 1;

297 
Fšish
:

298 
	`cú_šdexbuf_de¡roy
(&
ndx
);

299 (
»s
);

300 
	}
}

	@lib/ccn_reg_mgmt.c

20 
	~<¡ddef.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/ch¬buf.h
>

27 
	~<cú/»g_mgmt.h
>

29 
cú_fÜw¬dšg_’Œy
 *

30 
	$cú_fÜw¬dšg_’Œy_·r£
(cÚ¡ *
p
, 
size_t
 
size
)

32 
cú_buf_decod”
 
decod”
;

33 
cú_buf_decod”
 *
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
p
, 
size
);

34 
cú_ch¬buf
 *
¡Üe
 = 
	`cú_ch¬buf_ü—‹
();

35 
cú_fÜw¬dšg_’Œy
 *
»suÉ
;

36 cÚ¡ *
v®
;

37 
size_t
 
sz
;

38 
size_t
 
¡¬t
;

39 
size_t
 
’d
;

40 
aùiÚ_off
 = -1;

41 
cúd_id_off
 = -1;

43 ià(
¡Üe
 =ğ
NULL
)

44 (
NULL
);

45 
»suÉ
 = 
	`ÿÎoc
(1, (*result));

46 ià(
»suÉ
 =ğ
NULL
) {

47 
	`cú_ch¬buf_de¡roy
(&
¡Üe
);

48 (
NULL
);

50 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_FÜw¬dšgEÁry
)) {

51 
	`cú_buf_advªû
(
d
);

52 
aùiÚ_off
 = 
	`cú_·r£_gged_¡ršg
(
d
, 
CCN_DTAG_AùiÚ
, 
¡Üe
);

53 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Name
)) {

54 
»suÉ
->
Çme_´efix
 = 
	`cú_ch¬buf_ü—‹
();

55 
¡¬t
 = 
d
->
decod”
.
tok’_šdex
;

56 
	`cú_·r£_Name
(
d
, 
NULL
);

57 
’d
 = 
d
->
decod”
.
tok’_šdex
;

58 
	`cú_ch¬buf_­³nd
(
»suÉ
->
Çme_´efix
, 
p
 + 
¡¬t
, 
’d
 - start);

61 
»suÉ
->
Çme_´efix
 = 
NULL
;

62 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Publish”PublicKeyDige¡
)) {

63 
	`cú_buf_advªû
(
d
);

64 ià(
	`cú_buf_m©ch_blob
(
d
, &
v®
, &
sz
)) {

65 
	`cú_buf_advªû
(
d
);

66 ià(
sz
 != 32)

67 
d
->
decod”
.
¡©e
 = -
__LINE__
;

69 
	`cú_buf_check_şo£
(
d
);

70 ià(
d
->
decod”
.
¡©e
 >= 0) {

71 
cúd_id_off
 = 
¡Üe
->
Ëngth
;

72 
	`cú_ch¬buf_­³nd
(
¡Üe
, 
v®
, 
sz
);

73 
»suÉ
->
cúd_id_size
 = 
sz
;

76 
»suÉ
->
çûid
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
, 
CCN_DTAG_FaûID
);

77 
»suÉ
->
æags
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
, 
CCN_DTAG_FÜw¬dšgFÏgs
);

78 
»suÉ
->
liãtime
 = 
	`cú_·r£_İtiÚ®_gged_nÚNeg©iveIÁeg”
(
d
, 
CCN_DTAG_F»shÃssSecÚds
);

79 
	`cú_buf_check_şo£
(
d
);

82 
d
->
decod”
.
¡©e
 = -
__LINE__
;

84 ià(
d
->
decod”
.
šdex
 !ğ
size
 || !
	`CCN_FINAL_DSTATE
(d->decod”.
¡©e
) ||

85 
¡Üe
->
Ëngth
 > (
»suÉ
->store))

86 
	`cú_fÜw¬dšg_’Œy_de¡roy
(&
»suÉ
);

88 *
b
 = (*)
»suÉ
->
¡Üe
;

89 
	`memıy
(
b
, 
¡Üe
->
buf
, stÜe->
Ëngth
);

90 
»suÉ
->
aùiÚ
 = (
aùiÚ_off
 =ğ-1è? 
NULL
 : 
b
 +‡ction_off;

91 
»suÉ
->
cúd_id
 = (
cúd_id_off
 =ğ-1è? 
NULL
 :„esuÉ->
¡Üe
 + ccnd_id_off;

93 
	`cú_ch¬buf_de¡roy
(&
¡Üe
);

94 (
»suÉ
);

95 
	}
}

101 
	$cú_fÜw¬dšg_’Œy_de¡roy
(
cú_fÜw¬dšg_’Œy
 **
pã
)

103 ià(*
pã
 =ğ
NULL
)

105 
	`cú_ch¬buf_de¡roy
(&(*
pã
)->
Çme_´efix
);

106 
	`ä“
(*
pã
);

107 *
pã
 = 
NULL
;

108 
	}
}

111 
	$cúb_­³nd_fÜw¬dšg_’Œy
(
cú_ch¬buf
 *
c
,

112 cÚ¡ 
cú_fÜw¬dšg_’Œy
 *
ã
)

114 
»s
;

115 
»s
 = 
	`cúb_–em’t_begš
(
c
, 
CCN_DTAG_FÜw¬dšgEÁry
);

116 ià(
ã
->
aùiÚ
 !ğ
NULL
)

117 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_AùiÚ
, "%s",

118 
ã
->
aùiÚ
);

119 ià(
ã
->
Çme_´efix
 !ğ
NULL
 && fe->Çme_´efix->
Ëngth
 > 0)

120 
»s
 |ğ
	`cú_ch¬buf_­³nd
(
c
, 
ã
->
Çme_´efix
->
buf
,

121 
ã
->
Çme_´efix
->
Ëngth
);

122 ià(
ã
->
cúd_id_size
 != 0)

123 
»s
 |ğ
	`cúb_­³nd_gged_blob
(
c
, 
CCN_DTAG_Publish”PublicKeyDige¡
,

124 
ã
->
cúd_id
, fe->
cúd_id_size
);

125 ià(
ã
->
çûid
 != ~0)

126 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_FaûID
, "%u",

127 
ã
->
çûid
);

128 ià(
ã
->
æags
 >= 0)

129 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_FÜw¬dšgFÏgs
, "%d",

130 
ã
->
æags
);

131 ià(
ã
->
liãtime
 >= 0)

132 
»s
 |ğ
	`cúb_gged_putf
(
c
, 
CCN_DTAG_F»shÃssSecÚds
, "%d",

133 
ã
->
liãtime
);

134 
»s
 |ğ
	`cúb_–em’t_’d
(
c
);

135 (
»s
);

136 
	}
}

	@lib/ccn_schedule.c

20 
	~<¡ddef.h
>

21 
	~<¡dlib.h
>

22 
	~<lim™s.h
>

23 
	~<¡ršg.h
>

24 
	~<cú/scheduË.h
>

31 
	scú_scheduË_h—p_™em
 {

32 
šŒ_t
 
	mev’t_time
;

33 
cú_scheduËd_ev’t
 *
	mev
;

36 
	scú_scheduË
 {

37 *
	mş›Áh
;

38 cÚ¡ 
cú_g‘time
 *
	mşock
;

39 
cú_scheduË_h—p_™em
 *
	mh—p
;

40 
	mh—p_n
;

41 
	mh—p_lim™
;

42 
	mh—p_height
;

43 
	mnow
;

44 
cú_timev®
 
	mÏ¡time
;

45 
	mtime_has_·s£d
;

52 
	$upd©e_•och
(
cú_scheduË
 *
sched
)

54 
cú_scheduË_h—p_™em
 *
h—p
;

55 
n
;

56 
i
;

57 
t
 = 
sched
->
now
;

58 
h—p
 = 
sched
->heap;

59 
n
 = 
sched
->
h—p_n
;

60 
i
 = 0; i < 
n
; i++)

61 
h—p
[
i
].
ev’t_time
 -ğ
t
;

62 
sched
->
now
 = 0;

63 
	}
}

66 
	$upd©e_time
(
cú_scheduË
 *
sched
)

68 
cú_timev®
 
now
 = { 0 };

69 
–­£d
;

70 ià(
sched
->
time_has_·s£d
 < 0)

72 
sched
->
şock
->
	`g‘time
(sched->şock, &
now
);

74 ià(()(
now
.
s
 - 
sched
->
Ï¡time
.sè>ğ
INT_MAX
/4000000) {

76 
sched
->
Ï¡time
 = 
now
;

78 
sched
->
time_has_·s£d
 = 1;

79 
–­£d
 = 
now
.
miüos
 - 
sched
->
Ï¡time
.micros +

80 
sched
->
şock
->
miüos_³r_ba£
 * (
now
.
s
 - sched->
Ï¡time
.s);

81 ià(
–­£d
 + 
sched
->
now
 <ƒlapsed)

82 
	`upd©e_•och
(
sched
);

83 
sched
->
now
 +ğ
–­£d
;

84 
sched
->
Ï¡time
 = 
now
;

85 
	}
}

87 
cú_scheduË
 *

88 
	$cú_scheduË_ü—‹
(*
ş›Áh
, cÚ¡ 
cú_g‘time
 *
cúşock
)

90 
cú_scheduË
 *
sched
;

91 ià(
cúşock
 =ğ
NULL
)

92 (
NULL
);

93 
sched
 = 
	`ÿÎoc
(1, (*sched));

94 ià(
sched
 !ğ
NULL
) {

95 
sched
->
ş›Áh
 = clienth;

96 
sched
->
şock
 = 
cúşock
;

97 
	`upd©e_time
(
sched
);

99 (
sched
);

100 
	}
}

103 
	$cú_scheduË_de¡roy
(
cú_scheduË
 **
schedp
)

105 
cú_scheduË
 *
sched
;

106 
cú_scheduËd_ev’t
 *
ev
;

107 
cú_scheduË_h—p_™em
 *
h—p
;

108 
n
;

109 
i
;

110 
sched
 = *
schedp
;

111 ià(
sched
 =ğ
NULL
)

113 *
schedp
 = 
NULL
;

114 
h—p
 = 
sched
->heap;

115 ià(
h—p
 !ğ
NULL
) {

116 
n
 = 
sched
->
h—p_n
;

117 
sched
->
h—p
 = 
NULL
;

118 
i
 = 0; i < 
n
; i++) {

119 
ev
 = 
h—p
[
i
].ev;

120 (
ev
->
aùiÚ
)(
sched
, sched->
ş›Áh
,ƒv, 
CCN_SCHEDULE_CANCEL
);

121 
	`ä“
(
ev
);

123 
	`ä“
(
h—p
);

125 
	`ä“
(
sched
);

126 
	}
}

128 cÚ¡ 
cú_g‘time
 *

129 
	$cú_scheduË_g‘_g‘time
(
cú_scheduË
 *
schedp
) {

130 (
schedp
->
şock
);

131 
	}
}

139 
	$h—p_š£¹
(
cú_scheduË_h—p_™em
 *
h—p
, 
miüos
,

140 
cú_scheduËd_ev’t
 *
ev
, 
h
, 
n
)

142 
i
;

143 
i
 = (
n
 >> 
h
); i <‚; i = (n >> --h)) {

144 ià(
miüos
 <ğ
h—p
[
i
-1].
ev’t_time
) {

145 
šŒ_t
 
d
 = 
h—p
[
i
-1].
ev’t_time
;

146 
cú_scheduËd_ev’t
 *
e
 = 
h—p
[
i
-1].
ev
;

147 
h—p
[
i
-1].
ev
 =ƒv;

148 
h—p
[
i
-1].
ev’t_time
 = 
miüos
;

149 
miüos
 = 
d
;

150 
ev
 = 
e
;

153 
h—p
[
n
-1].
ev’t_time
 = 
miüos
;

154 
h—p
[
n
-1].
ev
 =ƒv;

155 
	}
}

162 
	$h—p_siá
(
cú_scheduË_h—p_™em
 *
h—p
, 
n
)

164 
i
, 
j
;

165 
miüos
;

166 ià(
n
 < 1)

168 
miüos
 = 
h—p
[
n
-1].
ev’t_time
;

169 
i
 = 1, 
j
 = 2; j < 
n
; i = j, j = 2 * j) {

170 ià(
j
 + 1 < 
n
 && 
h—p
[j-1].
ev’t_time
 > heap[j].event_time)

171 
j
 += 1;

172 ià(
miüos
 < 
h—p
[
j
-1].
ev’t_time
)

174 
h—p
[
i
-1] = h—p[
j
-1];

176 
h—p
[
i
-1] = h—p[
n
-1];

177 
h—p
[
n
-1].
ev
 = 
NULL
;

178 
h—p
[
n
-1].
ev’t_time
 = 0;

179 
	}
}

185 
cú_scheduËd_ev’t
 *

186 
	$»scheduË_ev’t
(

187 
cú_scheduË
 *
sched
,

188 
miüos
,

189 
cú_scheduËd_ev’t
 *
ev
)

191 
lim
;

192 
n
;

193 
h
;

194 
cú_scheduË_h—p_™em
 *
h—p
;

195 ià(
miüos
 + 
sched
->
now
 < micros)

196 
	`upd©e_•och
(
sched
);

197 
miüos
 +ğ
sched
->
now
;

198 
h—p
 = 
sched
->heap;

199 
n
 = 
sched
->
h—p_n
 + 1;

200 ià(
n
 > 
sched
->
h—p_lim™
) {

201 
lim
 = 
sched
->
h—p_lim™
 + 
n
;

202 
h—p
 = 
	`»®loc
(
sched
->h—p, 
lim
 * (heap[0]));

203 ià(
h—p
 =ğ
NULL
) (NULL);

204 
	`mem£t
(&(
h—p
[
sched
->
h—p_lim™
]), 0, (
lim
 - 
n
) * (heap[0]));

205 
sched
->
h—p_lim™
 = 
lim
;

206 
sched
->
h—p
 = heap;

208 
sched
->
h—p_n
 = 
n
;

209 
h
 = 
sched
->
h—p_height
;

210 (
n
 >> 
h
) > 1)

211 
sched
->
h—p_height
 = ++
h
;

212 (
n
 >> 
h
) < 1)

213 
sched
->
h—p_height
 = --
h
;

214 
	`h—p_š£¹
(
h—p
, 
miüos
, 
ev
, 
h
, 
n
);

215 (
ev
);

216 
	}
}

221 
cú_scheduËd_ev’t
 *

222 
	$cú_scheduË_ev’t
(

223 
cú_scheduË
 *
sched
,

224 
miüos
,

225 
cú_scheduËd_aùiÚ
 
aùiÚ
,

226 *
evd©a
,

227 
šŒ_t
 
evšt
)

229 
cú_scheduËd_ev’t
 *
ev
;

230 
ev
 = 
	`ÿÎoc
(1, (*ev));

231 ià(
ev
 =ğ
NULL
) (NULL);

232 
ev
->
aùiÚ
 =‡ction;

233 
ev
->
evd©a
 =ƒvdata;

234 
ev
->
evšt
 =ƒvint;

235 
	`upd©e_time
(
sched
);

236 (
	`»scheduË_ev’t
(
sched
, 
miüos
, 
ev
));

237 
	}
}

241 
	$cú_scheduË_ÿnûÎed_ev’t
(
cú_scheduË
 *
sched
, *
ş›Áh
,

242 
cú_scheduËd_ev’t
 *
ev
, 
æags
)

245 
	}
}

254 
	$cú_scheduË_ÿnûl
(
cú_scheduË
 *
sched
, 
cú_scheduËd_ev’t
 *
ev
)

256 
»s
;

257 ià(
ev
 =ğ
NULL
)

259 
»s
 = (
ev
->
aùiÚ
)(
sched
, sched->
ş›Áh
,ƒv, 
CCN_SCHEDULE_CANCEL
);

260 ià(
»s
 > 0)

261 
	`abÜt
();

262 
ev
->
aùiÚ
 = &
cú_scheduË_ÿnûÎed_ev’t
;

263 
ev
->
evd©a
 = 
NULL
;

264 
ev
->
evšt
 = 0;

266 
	}
}

269 
	$cú_scheduË_run_Ãxt
(
cú_scheduË
 *
sched
)

271 
cú_scheduËd_ev’t
 *
ev
;

272 
miüos
;

273 
»s
;

274 ià(
sched
->
h—p_n
 == 0) ;

275 
ev
 = 
sched
->
h—p
[0].ev;

276 
sched
->
h—p
[0].
ev
 = 
NULL
;

277 
miüos
 = 
sched
->
h—p
[0].
ev’t_time
 - sched->
now
;

278 
	`h—p_siá
(
sched
->
h—p
, sched->
h—p_n
--);

279 
»s
 = (
ev
->
aùiÚ
)(
sched
, sched->
ş›Áh
,ƒv, 0);

280 ià(
»s
 <= 0) {

281 
	`ä“
(
ev
);

289 ià(
miüos
 < -()(
sched
->
şock
->
miüos_³r_ba£
))

290 
miüos
 = 0;

291 
	`»scheduË_ev’t
(
sched
, 
miüos
 + 
»s
, 
ev
);

292 
	}
}

301 
	$cú_scheduË_run
(
cú_scheduË
 *
sched
)

303 
	`upd©e_time
(
sched
);

304 
sched
->
h—p_n
 > 0 && sched->
h—p
[0].
ev’t_time
 <ğsched->
now
) {

305 
sched
->
time_has_·s£d
 = 0;

306 
	`cú_scheduË_run_Ãxt
(
sched
);

307 ià(
sched
->
time_has_·s£d
)

308 
	`upd©e_time
(
sched
);

310 ià(
sched
->
h—p_n
 == 0)

312 (
sched
->
h—p
[0].
ev’t_time
 - sched->
now
);

313 
	}
}

315 #ifdeà
TESTSCHEDULE


317 
	~<¡dio.h
>

318 
	~<sys/time.h
>

321 
	$my_g‘time
(cÚ¡ 
cú_g‘time
 *
£lf
, 
cú_timev®
 *
»suÉ
)

323 
timev®
 
now
 = {0};

324 
	`g‘timeofday
(&
now
, 0);

325 
»suÉ
->
s
 = 
now
.
tv_£c
;

326 
»suÉ
->
miüos
 = 
now
.
tv_u£c
;

327 
	}
}

329 
cú_g‘time
 
	ggt
 = {"g‘TOD", &
my_g‘time
, 1000000, 
NULL
};

332 
	$‹¡tick
(
cú_scheduË
 *
sched
)

334 
sched
->
now
 = sched->
h—p
[0].
ev’t_time
 + 1;

335 
	`´štf
("%ld: ", ()
sched
->
h—p
[0].
ev’t_time
);

336 
	`cú_scheduË_run_Ãxt
(
sched
);

337 
	`´štf
("\n");

338 
	}
}

339 
	gdd
[] = "ABDEFGHI";

340 
	#SARGS
 
cú_scheduË
 *
sched
, *
ş›Áh
, 
cú_scheduËd_ev’t
 *
ev
, 
æags


	)

341 
	$A
(
SARGS
è{ ià(
æags
 & 
CCN_SCHEDULE_CANCEL
) (0);

342 
	`´štf
("A");  70000000; 
	}
}

343 
	$B
(
SARGS
è{ 
	`´štf
("B");  0; 
	}
}

344 
	$C
(
SARGS
è{ 
	`´štf
("C");  0; 
	}
}

345 
	$D
(
SARGS
è{ ià(
æags
 & 
CCN_SCHEDULE_CANCEL
) (0);

346 
	`´štf
("D");  30000000; 
	}
}

347 
cú_scheduË_h—p_™em
 
	gt¡
[7];

348 
	$TESTSCHEDULE
()

350 
cú_scheduË
 *
s
 = 
	`cú_scheduË_ü—‹
(
dd
+5, &
gt
);

351 
i
;

352 
cú_scheduËd_ev’t
 *
viùim
 = 
NULL
;

354 
s
->
time_has_·s£d
 = -1;

355 
	`cú_scheduË_ev’t
(
s
, 11111, 
A
, 
dd
+4, 11111);

356 
	`cú_scheduË_ev’t
(
s
, 1, 
A
, 
dd
, 1);

357 
	`cú_scheduË_ev’t
(
s
, 111, 
C
, 
dd
+2, 111);

358 
viùim
 = 
	`cú_scheduË_ev’t
(
s
, 1111111, 
A
, 
dd
+6, 1111111);

359 
	`cú_scheduË_ev’t
(
s
, 11, 
B
, 
dd
+1, 11);

360 
	`‹¡tick
(
s
);

361 
	`cú_scheduË_ev’t
(
s
, 1111, 
D
, 
dd
+3, 1111);

362 
	`cú_scheduË_ev’t
(
s
, 111111, 
B
, 
dd
+5, 111111);

363 
i
 = 0; i < 100; i++) {

364 ià(
i
 =ğ50è{ 
	`cú_scheduË_ÿnûl
(
s
, 
viùim
); viùim = 
NULL
; }

365 
	`‹¡tick
(
s
);

367 
	`cú_scheduË_de¡roy
(&
s
);

369 
	}
}

	@lib/ccn_seqwriter.c

21 
	~<¡ddef.h
>

22 
	~<¡dšt.h
>

23 
	~<¡dlib.h
>

24 
	~<”ºo.h
>

25 
	~<cú/cú.h
>

26 
	~<cú/£qwr™”.h
>

28 
	#MAX_DATA_SIZE
 4096

	)

30 
	scú_£qwr™”
 {

31 
cú_şosu»
 
	mş
;

32 
cú
 *
	mh
;

33 
cú_ch¬buf
 *
	mnb
;

34 
cú_ch¬buf
 *
	mnv
;

35 
cú_ch¬buf
 *
	mbufãr
;

36 
cú_ch¬buf
 *
	mcob0
;

37 
uštmax_t
 
	m£qnum
;

38 
	mb©chšg
;

39 
	mš‹»¡s_possibly_³ndšg
;

40 
	mşo£d
;

43 
cú_ch¬buf
 *

44 
	$£qw_Ãxt_cob
(
cú_£qwr™”
 *
w
)

46 
cú_ch¬buf
 *
cob
 = 
	`cú_ch¬buf_ü—‹
();

47 
cú_ch¬buf
 *
Çme
 = 
	`cú_ch¬buf_ü—‹
();

48 
cú_signšg_·¿ms
 
¥
 = 
CCN_SIGNING_PARAMS_INIT
;

49 
»s
;

51 ià(
w
->
şo£d
)

52 
¥
.
¥_æags
 |ğ
CCN_SP_FINAL_BLOCK
;

53 
	`cú_ch¬buf_­³nd
(
Çme
, 
w
->
nv
->
buf
, w->nv->
Ëngth
);

54 
	`cú_Çme_­³nd_num”ic
(
Çme
, 
CCN_MARKER_SEQNUM
, 
w
->
£qnum
);

55 
»s
 = 
	`cú_sign_cÚ‹Á
(
w
->
h
, 
cob
, 
Çme
, &
¥
, w->
bufãr
->
buf
, w->bufãr->
Ëngth
);

56 ià(
»s
 < 0)

57 
	`cú_ch¬buf_de¡roy
(&
cob
);

58 
	`cú_ch¬buf_de¡roy
(&
Çme
);

59 (
cob
);

60 
	}
}

62 
cú_upÿÎ_»s


63 
	$£qw_šcomšg_š‹»¡
(

64 
cú_şosu»
 *
£lå
,

65 
cú_upÿÎ_kšd
 
kšd
,

66 
cú_upÿÎ_šfo
 *
šfo
)

68 
»s
;

69 
cú_ch¬buf
 *
cob
 = 
NULL
;

70 
cú_£qwr™”
 *
w
 = 
£lå
->
d©a
;

72 ià(
w
 =ğ
NULL
 || 
£lå
 !ğ&(w->
ş
))

73 
	`abÜt
();

74 
kšd
) {

75 
CCN_UPCALL_FINAL
:

76 
	`cú_ch¬buf_de¡roy
(&
w
->
nb
);

77 
	`cú_ch¬buf_de¡roy
(&
w
->
nv
);

78 
	`cú_ch¬buf_de¡roy
(&
w
->
bufãr
);

79 
	`cú_ch¬buf_de¡roy
(&
w
->
cob0
);

80 
	`ä“
(
w
);

82 
CCN_UPCALL_INTEREST
:

83 ià(
w
->
şo£d
 || w->
bufãr
->
Ëngth
 > 0) {

84 
cob
 = 
	`£qw_Ãxt_cob
(
w
);

85 ià(
cob
 =ğ
NULL
)

86 (
CCN_UPCALL_RESULT_OK
);

87 ià(
	`cú_cÚ‹Á_m©ches_š‹»¡
(
cob
->
buf
, cob->
Ëngth
,

88 1, 
NULL
,

89 
šfo
->
š‹»¡_cúb
,

90 
šfo
->
pi
->
off£t
[
CCN_PI_E
],

91 
šfo
->
pi
)) {

92 
w
->
š‹»¡s_possibly_³ndšg
 = 0;

93 
»s
 = 
	`cú_put
(
šfo
->
h
, 
cob
->
buf
, cob->
Ëngth
);

94 ià(
»s
 >= 0) {

95 
w
->
bufãr
->
Ëngth
 = 0;

96 
w
->
£qnum
++;

97 (
CCN_UPCALL_RESULT_INTEREST_CONSUMED
);

100 
	`cú_ch¬buf_de¡roy
(&
cob
);

102 ià(
w
->
cob0
 !ğ
NULL
) {

103 
cob
 = 
w
->
cob0
;

104 ià(
	`cú_cÚ‹Á_m©ches_š‹»¡
(
cob
->
buf
, cob->
Ëngth
,

105 1, 
NULL
,

106 
šfo
->
š‹»¡_cúb
,

107 
šfo
->
pi
->
off£t
[
CCN_PI_E
],

108 
šfo
->
pi
)) {

109 
w
->
š‹»¡s_possibly_³ndšg
 = 0;

110 
	`cú_put
(
šfo
->
h
, 
cob
->
buf
, cob->
Ëngth
);

111 (
CCN_UPCALL_RESULT_INTEREST_CONSUMED
);

114 
w
->
š‹»¡s_possibly_³ndšg
 = 1;

119 (
CCN_UPCALL_RESULT_OK
);

120 
	}
}

129 
cú_£qwr™”
 *

130 
	$cú_£qw_ü—‹
(
cú
 *
h
, 
cú_ch¬buf
 *
Çme
)

132 
cú_£qwr™”
 *
w
 = 
NULL
;

133 
cú_ch¬buf
 *
nb
 = 
NULL
;

134 
cú_ch¬buf
 *
nv
 = 
NULL
;

135 
»s
;

137 
w
 = 
	`ÿÎoc
(1, (*w));

138 ià(
w
 =ğ
NULL
)

139 (
NULL
);

140 
nb
 = 
	`cú_ch¬buf_ü—‹
();

141 
	`cú_ch¬buf_­³nd
(
nb
, 
Çme
->
buf
,‚ame->
Ëngth
);

142 
nv
 = 
	`cú_ch¬buf_ü—‹
();

143 
	`cú_ch¬buf_­³nd
(
nv
, 
Çme
->
buf
,‚ame->
Ëngth
);

144 
»s
 = 
	`cú_ü—‹_v”siÚ
(
h
, 
nv
, 
CCN_V_NOW
, 0, 0);

145 ià(
»s
 < 0 || 
nb
 =ğ
NULL
) {

146 
	`cú_ch¬buf_de¡roy
(&
nv
);

147 
	`cú_ch¬buf_de¡roy
(&
nb
);

148 
	`ä“
(
w
);

149 (
NULL
);

152 
w
->
ş
.
p
 = &
£qw_šcomšg_š‹»¡
;

153 
w
->
ş
.
d©a
 = w;

154 
w
->
nb
 =‚b;

155 
w
->
nv
 =‚v;

156 
w
->
bufãr
 = 
	`cú_ch¬buf_ü—‹
();

157 
w
->
h
 = h;

158 
w
->
£qnum
 = 0;

159 
w
->
š‹»¡s_possibly_³ndšg
 = 1;

160 
»s
 = 
	`cú_£t_š‹»¡_f‹r
(
h
, 
nb
, &(
w
->
ş
));

161 ià(
»s
 < 0) {

162 
	`cú_ch¬buf_de¡roy
(&
w
->
nb
);

163 
	`cú_ch¬buf_de¡roy
(&
w
->
nv
);

164 
	`cú_ch¬buf_de¡roy
(&
w
->
bufãr
);

165 
	`ä“
(
w
);

166 (
NULL
);

168 (
w
);

169 
	}
}

188 
	$cú_£qw_wr™e
(
cú_£qwr™”
 *
w
, cÚ¡ *
buf
, 
size_t
 
size
)

190 
cú_ch¬buf
 *
cob
 = 
NULL
;

191 
»s
;

192 
ªs
;

194 ià(
w
 =ğ
NULL
 || w->
ş
.
d©a
 != w)

196 ià(
w
->
bufãr
 =ğ
NULL
 || 
size
 > 
MAX_DATA_SIZE
)

197 (
	`cú_£‹¼Ü
(
w
->
h
, 
EINVAL
));

198 
ªs
 = 
size
;

199 ià(
size
 + 
w
->
bufãr
->
Ëngth
 > 
MAX_DATA_SIZE
)

200 
ªs
 = 
	`cú_£‹¼Ü
(
w
->
h
, 
EAGAIN
);

201 ià(
size
 != 0)

202 
	`cú_ch¬buf_­³nd
(
w
->
bufãr
, 
buf
, 
size
);

203 ià(
w
->
š‹»¡s_possibly_³ndšg
 &&

204 (
w
->
b©chšg
 =ğ0 || 
ªs
 == -1)) {

205 
cob
 = 
	`£qw_Ãxt_cob
(
w
);

206 ià(
cob
 !ğ
NULL
) {

207 
»s
 = 
	`cú_put
(
w
->
h
, 
cob
->
buf
, cob->
Ëngth
);

208 ià(
»s
 >= 0) {

209 ià(
w
->
£qnum
 == 0) {

210 
w
->
cob0
 = 
cob
;

211 
cob
 = 
NULL
;

213 
w
->
bufãr
->
Ëngth
 = 0;

214 
w
->
£qnum
++;

215 
w
->
š‹»¡s_possibly_³ndšg
 = 0;

217 
	`cú_ch¬buf_de¡roy
(&
cob
);

220 (
ªs
);

221 
	}
}

232 
	$cú_£qw_b©ch_¡¬t
(
cú_£qwr™”
 *
w
)

234 ià(
w
 =ğ
NULL
 || w->
ş
.
d©a
 !ğw || w->
şo£d
)

236 (++(
w
->
b©chšg
));

237 
	}
}

243 
	$cú_£qw_b©ch_’d
(
cú_£qwr™”
 *
w
)

245 ià(
w
 =ğ
NULL
 || w->
ş
.
d©a
 !ğw || w->
b©chšg
 == 0)

247 ià(--(
w
->
b©chšg
) == 0)

248 
	`cú_£qw_wr™e
(
w
, 
NULL
, 0);

249 (
w
->
b©chšg
);

250 
	}
}

258 
	$cú_£qw_possibË_š‹»¡
(
cú_£qwr™”
 *
w
)

260 ià(
w
 =ğ
NULL
 || w->
ş
.
d©a
 != w)

262 
w
->
š‹»¡s_possibly_³ndšg
 = 1;

263 
	`cú_£qw_wr™e
(
w
, 
NULL
, 0);

265 
	}
}

271 
	$cú_£qw_şo£
(
cú_£qwr™”
 *
w
)

273 ià(
w
 =ğ
NULL
 || w->
ş
.
d©a
 != w)

275 
w
->
şo£d
 = 1;

276 
w
->
š‹»¡s_possibly_³ndšg
 = 1;

277 
w
->
b©chšg
 = 0;

278 
	`cú_£qw_wr™e
(
w
, 
NULL
, 0);

279 
	`cú_£t_š‹»¡_f‹r
(
w
->
h
, w->
nb
, 
NULL
);

281 
	}
}

	@lib/ccn_setup_sockaddr_un.c

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/sock‘.h
>

25 
	~<sys/un.h
>

27 
	~<cú/cúd.h
>

28 
	~<cú/cú_´iv©e.h
>

43 
	$cú_£tup_sockaddr_un
(cÚ¡ *
pÜt¡r
, 
sockaddr_un
 *
»suÉ
)

45 
sockaddr_un
 *
§
 = 
»suÉ
;

46 cÚ¡ *
sockÇme
 = 
	`g‘’v
("CCN_LOCAL_SOCKNAME");

47 ià(
sockÇme
 =ğ
NULL
 || sockname[0] == 0)

48 
sockÇme
 = 
CCN_DEFAULT_LOCAL_SOCKNAME
;

49 
	`mem£t
(
§
, 0, (*sa));

50 
§
->
sun_çmy
 = 
AF_UNIX
;

51 ià(
pÜt¡r
 =ğ
NULL
 ||…ortstr[0] == 0)

52 
pÜt¡r
 = 
	`g‘’v
(
CCN_LOCAL_PORT_ENVNAME
);

53 ià(
pÜt¡r
 !ğ
NULL
 && 
	`©oi
(portstr) > 0 &&

54 
	`©oi
(
pÜt¡r
è!ğ©oi(
CCN_DEFAULT_UNICAST_PORT
))

55 
	`¢´štf
(
§
->
sun_·th
, (sa->sun_path), "%s.%s",

56 
sockÇme
, 
pÜt¡r
);

58 
	`¢´štf
(
§
->
sun_·th
, (sa->sun_path), "%s",

59 
sockÇme
);

60 
	}
}

	@lib/ccn_signing.c

20 
	~<¡ddef.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<İ’s¦/evp.h
>

24 
	~<İ’s¦/¿nd.h
>

25 
	~<İ’s¦/x509.h
>

26 
	~<cú/m”kË·tha¢1.h
>

27 
	~<cú/cú.h
>

28 
	~<cú/signšg.h
>

29 
	~<cú/¿ndom.h
>

31 
	scú_sigc
 {

32 
EVP_MD_CTX
 
	mcÚ‹xt
;

33 cÚ¡ 
EVP_MD
 *
	mdige¡
;

36 
cú_sigc
 *

37 
	$cú_sigc_ü—‹
()

39  (
	`ÿÎoc
(1, (
cú_sigc
)));

40 
	}
}

43 
	$cú_sigc_de¡roy
(
cú_sigc
 **
ùx
)

45 ià(*
ùx
) {

47 
	`EVP_MD_CTX_ş—nup
(&(*
ùx
)->
cÚ‹xt
);

48 
	`ä“
(*
ùx
);

49 *
ùx
 = 
NULL
;

51 
	}
}

54 
	$cú_sigc_š™
(
cú_sigc
 *
ùx
, cÚ¡ *
dige¡
)

56 
	`EVP_MD_CTX_š™
(&
ùx
->
cÚ‹xt
);

57 ià(
dige¡
 =ğ
NULL
) {

58 
ùx
->
dige¡
 = 
	`EVP_sha256
();

62 
	`årštf
(
¡d”r
, "not‡ DigestAlgorithm I understand„ight‚ow\n");

66 ià(0 =ğ
	`EVP_SignIn™_ex
(&
ùx
->
cÚ‹xt
, ctx->
dige¡
, 
NULL
))

69 
	}
}

72 
	$cú_sigc_upd©e
(
cú_sigc
 *
ùx
, cÚ¡ *
d©a
, 
size_t
 
size
)

74 ià(0 =ğ
	`EVP_SignUpd©e
(&
ùx
->
cÚ‹xt
, (*)
d©a
, 
size
))

77 
	}
}

80 
	$cú_sigc_fš®
(
cú_sigc
 *
ùx
, 
cú_sigÇtu»
 *
sigÇtu»
, 
size_t
 *
size
, cÚ¡ 
cú_pkey
 *
´iv_key
)

82 
sig_size
;

84 ià(0 =ğ
	`EVP_SignFš®
(&
ùx
->
cÚ‹xt
, (*)
sigÇtu»
, &
sig_size
, (
EVP_PKEY
 *)
´iv_key
))

86 *
size
 = 
sig_size
;

88 
	}
}

90 
size_t


91 
	$cú_sigc_sigÇtu»_max_size
(
cú_sigc
 *
ùx
, cÚ¡ 
cú_pkey
 *
´iv_key
)

93  (
	`EVP_PKEY_size
((
EVP_PKEY
 *)
´iv_key
));

94 
	}
}

96 
	#is_Ëá
(
x
è(0 =ğ(x & 1))

	)

97 
	#node_Ì
(
x
è(x & 1)

	)

98 
	#siblšg_of
(
x
è(x ^ 1)

	)

99 
	#·»Á_of
(
x
è(x >> 1)

	)

101 
	$cú_m”kË_roÙ_hash
(cÚ¡ *
msg
, 
size_t
 
size
,

102 cÚ¡ 
cú_·r£d_CÚ‹ÁObjeù
 *
co
,

103 cÚ¡ 
EVP_MD
 *
dige¡_ty³
,

104 
MP_šfo
 *
m”kË_·th_šfo
,

105 *
»suÉ
, 
»suÉ_size
)

107 
node
 = 
	`ASN1_INTEGER_g‘
(
m”kË_·th_šfo
->node);

108 
EVP_MD_CTX
 
dige¡_cÚ‹xt
;

109 
EVP_MD_CTX
 *
dige¡_cÚ‹x
 = &
dige¡_cÚ‹xt
;

110 
size_t
 
d©a_size
;

111 *
šput_hash
[2];

113 
hash_šdex
 = 
	`sk_ASN1_OCTET_STRING_num
(
m”kË_·th_šfo
->
hashes
) - 1;

115 
»s
;

117 ià(
»suÉ_size
 !ğ
	`EVP_MD_size
(
dige¡_ty³
))

128 
	`EVP_MD_CTX_š™
(
dige¡_cÚ‹x
);

129 
	`EVP_Dige¡In™_ex
(
dige¡_cÚ‹x
, 
dige¡_ty³
, 
NULL
);

130 
d©a_size
 = 
co
->
off£t
[
CCN_PCO_E_CÚ‹Á
] - co->off£t[
CCN_PCO_B_Name
];

131 
»s
 = 
	`EVP_Dige¡Upd©e
(
dige¡_cÚ‹x
, 
msg
 + 
co
->
off£t
[
CCN_PCO_B_Name
], 
d©a_size
);

132 
»s
 = 
	`EVP_Dige¡Fš®_ex
(
dige¡_cÚ‹x
, 
»suÉ
, 
NULL
);

136 
node
 != 1) {

137 
šput_hash
[
node
 & 1] = 
»suÉ
;

138 
šput_hash
[(
node
 & 1è^ 1] = 
	`sk_ASN1_OCTET_STRING_v®ue
(
m”kË_·th_šfo
->
hashes
, 
hash_šdex
)->
d©a
;

139 ià(
	`sk_ASN1_OCTET_STRING_v®ue
(
m”kË_·th_šfo
->
hashes
, 
hash_šdex
)->
Ëngth
 !ğ
»suÉ_size
)

141 
hash_šdex
 -= 1;

142 #ifdeà
DEBUG


143 
	`årštf
(
¡d”r
, "node[%d].Ëáhash = ", 
	`·»Á_of
(
node
));

144 
x
 = 0; x < 
»suÉ_size
; x++) {

145 
	`årštf
(
¡d”r
, "%02x", 
šput_hash
[0][
x
]);

147 
	`årštf
(
¡d”r
, "\n");

149 
	`årštf
(
¡d”r
, "node[%d].righthash = ", 
	`·»Á_of
(
node
));

150 
x
 = 0; x < 
»suÉ_size
; x++) {

151 
	`årštf
(
¡d”r
, "%02x", 
šput_hash
[1][
x
]);

153 
	`årštf
(
¡d”r
, "\n");

155 
	`EVP_MD_CTX_š™
(
dige¡_cÚ‹x
);

156 
	`EVP_Dige¡In™_ex
(
dige¡_cÚ‹x
, 
dige¡_ty³
, 
NULL
);

157 
»s
 = 
	`EVP_Dige¡Upd©e
(
dige¡_cÚ‹x
, 
šput_hash
[0], 
»suÉ_size
);

158 
»s
 = 
	`EVP_Dige¡Upd©e
(
dige¡_cÚ‹x
, 
šput_hash
[1], 
»suÉ_size
);

159 
»s
 = 
	`EVP_Dige¡Fš®_ex
(
dige¡_cÚ‹x
, 
»suÉ
, 
NULL
);

160 
node
 = 
	`·»Á_of
(node);

162 #ifdeà
DEBUG


163 
	`årštf
(
¡d”r
, "y›ldšg‚ode[%d] hash = ", 
node
);

164 
x
 = 0; x < 
»suÉ_size
; x++) {

165 
	`årštf
(
¡d”r
, "%02x", 
»suÉ
[
x
]);

167 
	`årštf
(
¡d”r
, "\n");

171 
	}
}

173 
	$cú_v”ify_sigÇtu»
(cÚ¡ *
msg
,

174 
size_t
 
size
,

175 cÚ¡ 
cú_·r£d_CÚ‹ÁObjeù
 *
co
,

176 cÚ¡ 
cú_pkey
 *
v”ifiÿtiÚ_pubkey
)

178 
EVP_MD_CTX
 
v”c
;

179 
EVP_MD_CTX
 *
v”_ùx
 = &
v”c
;

180 
X509_SIG
 *
dige¡_šfo
 = 
NULL
;

181 
MP_šfo
 *
m”kË_·th_šfo
 = 
NULL
;

182 *
roÙ_hash
;

183 
size_t
 
roÙ_hash_size
;

185 
»s
;

187 cÚ¡ 
EVP_MD
 *
dige¡
 = 
	`EVP_md_nuÎ
();

188 cÚ¡ 
EVP_MD
 *
m”kË_·th_dige¡
 = 
	`EVP_md_nuÎ
();

190 cÚ¡ *
sigÇtu»_b™s
 = 
NULL
;

191 
size_t
 
sigÇtu»_b™s_size
 = 0;

192 cÚ¡ *
w™Ãss
 = 
NULL
;

193 
size_t
 
w™Ãss_size
 = 0;

194 
EVP_PKEY
 *
pkey
 = (EVP_PKEY *)
v”ifiÿtiÚ_pubkey
;

195 #ifdeà
DEBUG


196 
x
, 
h
;

199 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_SigÇtu»B™s
, 
msg
,

200 
co
->
off£t
[
CCN_PCO_B_SigÇtu»B™s
],

201 
co
->
off£t
[
CCN_PCO_E_SigÇtu»B™s
],

202 &
sigÇtu»_b™s
,

203 &
sigÇtu»_b™s_size
);

204 ià(
»s
 < 0)

207 ià(
co
->
off£t
[
CCN_PCO_B_Dige¡AlgÜ™hm
] =ğco->off£t[
CCN_PCO_E_Dige¡AlgÜ™hm
]) {

208 
dige¡
 = 
	`EVP_sha256
();

212 
	`årštf
(
¡d”r
, "not‡ DigestAlgorithm I understand„ight‚ow\n");

216 
	`EVP_MD_CTX_š™
(
v”_ùx
);

217 
»s
 = 
	`EVP_V”ifyIn™_ex
(
v”_ùx
, 
dige¡
, 
NULL
);

218 ià(!
»s
)

221 ià(
co
->
off£t
[
CCN_PCO_B_W™Ãss
] !ğco->off£t[
CCN_PCO_E_W™Ãss
]) {

226 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_W™Ãss
, 
msg
,

227 
co
->
off£t
[
CCN_PCO_B_W™Ãss
],

228 
co
->
off£t
[
CCN_PCO_E_W™Ãss
],

229 &
w™Ãss
,

230 &
w™Ãss_size
);

231 ià(
»s
 < 0)

235 
dige¡_šfo
 = 
	`d2i_X509_SIG
(
NULL
, &
w™Ãss
, 
w™Ãss_size
);

240 
ASN1_OBJECT
 *
m”kË_hash_Œ“_oid
 = 
	`OBJ_txt2obj
("1.2.840.113550.11.1.2.2", 1);

241 ià(0 !ğ
	`OBJ_cmp
(
dige¡_šfo
->
®gÜ
->
®gÜ™hm
, 
m”kË_hash_Œ“_oid
)) {

242 
	`årštf
(
¡d”r
, "A witness is…resent without‡n MHT OID!\n");

243 
	`ASN1_OBJECT_ä“
(
m”kË_hash_Œ“_oid
);

247 
	`ASN1_OBJECT_ä“
(
m”kË_hash_Œ“_oid
);

248 
m”kË_·th_dige¡
 = 
	`EVP_sha256
();

250 
m”kË_·th_šfo
 = 
	`d2i_MP_šfo
(
NULL
, (cÚ¡ **)&(
dige¡_šfo
->
dige¡
->
d©a
), dige¡_šfo->dige¡->
Ëngth
);

251 #ifdeà
DEBUG


252 
node
 = 
	`ASN1_INTEGER_g‘
(
m”kË_·th_šfo
->node);

253 
hash_couÁ
 = 
	`sk_ASN1_OCTET_STRING_num
(
m”kË_·th_šfo
->
hashes
);

254 
ASN1_OCTET_STRING
 *
hash
;

255 
	`årštf
(
¡d”r
, "A witness is…resent with‡n MHT OID\n");

256 
	`årštf
(
¡d”r
, "Thi i nod%d, w™h %d hashes\n", 
node
, 
hash_couÁ
);

257 
h
 = 0; h < 
hash_couÁ
; h++) {

258 
hash
 = 
	`sk_ASN1_OCTET_STRING_v®ue
(
m”kË_·th_šfo
->
hashes
, 
h
);

259 
	`årštf
(
¡d”r
, " hashes[%d]†’ = %d d©¨ğ", 
h
, 
hash
->
Ëngth
);

260 
x
 = 0; x < 
hash
->
Ëngth
; x++) {

261 
	`årštf
(
¡d”r
, "%02x", 
hash
->
d©a
[
x
]);

263 
	`årštf
(
¡d”r
, "\n");

267 
roÙ_hash_size
 = 
	`EVP_MD_size
(
m”kË_·th_dige¡
);

268 
roÙ_hash
 = 
	`ÿÎoc
(1, 
roÙ_hash_size
);

269 
»s
 = 
	`cú_m”kË_roÙ_hash
(
msg
, 
size
, 
co
, 
m”kË_·th_dige¡
, 
m”kË_·th_šfo
, 
roÙ_hash
, 
roÙ_hash_size
);

270 
»s
 = 
	`EVP_V”ifyUpd©e
(
v”_ùx
, 
roÙ_hash
, 
roÙ_hash_size
);

271 
»s
 = 
	`EVP_V”ifyFš®
(
v”_ùx
, 
sigÇtu»_b™s
, 
sigÇtu»_b™s_size
, 
pkey
);

272 
	`EVP_MD_CTX_ş—nup
(
v”_ùx
);

278 
size_t
 
sigÃd_size
 = 
co
->
off£t
[
CCN_PCO_E_CÚ‹Á
] - co->off£t[
CCN_PCO_B_Name
];

279 
»s
 = 
	`EVP_V”ifyUpd©e
(
v”_ùx
, 
msg
 + 
co
->
off£t
[
CCN_PCO_B_Name
], 
sigÃd_size
);

280 
»s
 = 
	`EVP_V”ifyFš®
(
v”_ùx
, 
sigÇtu»_b™s
, 
sigÇtu»_b™s_size
, 
pkey
);

281 
	`EVP_MD_CTX_ş—nup
(
v”_ùx
);

284 ià(
»s
 == 1)

288 
	}
}

290 
cú_pkey
 *

291 
	$cú_d2i_pubkey
(cÚ¡ *
p
, 
size_t
 
size
)

293 cÚ¡ *
q
 = 
p
;

294 
EVP_PKEY
 *
ªs
;

295 
ªs
 = 
	`d2i_PUBKEY
(
NULL
, &
q
, 
size
);

296  ((
cú_pkey
 *)
ªs
);

297 
	}
}

300 
	$cú_pubkey_ä“
(
cú_pkey
 *
i_pubkey
)

302 
EVP_PKEY
 *
pkey
 = (EVP_PKEY *)
i_pubkey
;

303 
	`EVP_PKEY_ä“
(
pkey
);

304 
	}
}

306 
size_t


307 
	$cú_pubkey_size
(cÚ¡ 
cú_pkey
 *
i_pubkey
)

309 
size_t
 
ªs
;

310 
EVP_PKEY
 *
pkey
 = (EVP_PKEY *)
i_pubkey
;

311 
ªs
 = 
	`EVP_PKEY_size
(
pkey
);

312  (
ªs
);

313 
	}
}

316 
	$cú_­³nd_pubkey_blob
(
cú_ch¬buf
 *
c
, cÚ¡ 
cú_pkey
 *
i_pubkey
)

318 
»s
;

319 
size_t
 
by‹s
;

320 *
p
 = 
NULL
;

321 
»s
 = 
	`i2d_PUBKEY
((
EVP_PKEY
 *)
i_pubkey
, 
NULL
);

322 ià(
»s
 < 0)

324 
by‹s
 = 
»s
;

325 
»s
 = 
	`cú_ch¬buf_­³nd_‰
(
c
, 
by‹s
, 
CCN_BLOB
);

326 ià(
»s
 < 0)

328 
p
 = 
	`cú_ch¬buf_»£rve
(
c
, 
by‹s
);

329 ià(
p
 =ğ
NULL
)

331 
»s
 = 
	`i2d_PUBKEY
((
EVP_PKEY
 *)
i_pubkey
, &
p
);

332 ià(
»s
 !ğ()
by‹s
)

334 
c
->
Ëngth
 +ğ
by‹s
;

335 (
by‹s
);

336 
	}
}

347 
	$cú_¿ndom_by‹s
(*
buf
, 
size_t
 
size
)

349 
num
 = 
size
;

351 ià(
num
 < 0 ||‚um !ğ
size
)

352 
	`abÜt
();

353 
	`RAND_by‹s
(
buf
, 
num
);

354 
	}
}

364 
	$cú_add_’Œİy
(cÚ¡ *
buf
, 
size_t
 
size
, 
b™s_of_’Œİy
)

366 
num
 = 
size
;

368 ià(
num
 < 0 ||‚um !ğ
size
)

369 
	`abÜt
();

371 ià(
b™s_of_’Œİy
 <= 0)

372 
b™s_of_’Œİy
 = (
num
 < 32) ? 1 :‚um / 32;

373 
	`RAND_add
((*)
buf
, 
num
, 
b™s_of_’Œİy
 * 0.125);

374 
	}
}

	@lib/ccn_sockaddrutil.c

21 
	~<¡ršg.h
>

22 
	~<sys/ty³s.h
>

23 
	~<sys/sock‘.h
>

24 
	~<Ãtš‘/š.h
>

25 
	~<¬·/š‘.h
>

26 
	~<cú/ch¬buf.h
>

27 
	~<cú/sockaddrut.h
>

38 
	$cú_ch¬buf_­³nd_sockaddr
(
cú_ch¬buf
 *
c
, cÚ¡ 
sockaddr
 *
§
)

40 cÚ¡ *
¿waddr
 = 
NULL
;

41 cÚ¡ *
s
 = 
NULL
;

42 cÚ¡ *
şo£r
 = "";

43 cÚ¡ 
sockaddr_š
 *
addr4
 = 
NULL
;

44 cÚ¡ 
sockaddr_š6
 *
addr6
 = 
NULL
;

45 
size_t
 
§vËn
 = 
c
->
Ëngth
;

46 
sockËn_t
 
sz
 = 80;

47 
pÜt
 = 0;

49 ià(
§
 =ğ
NULL
)

51 
§
->
§_çmy
) {

52 
AF_INET
:

53 
addr4
 = (
sockaddr_š
 *)
§
;

54 
¿waddr
 = (cÚ¡ *)&
addr4
->
sš_addr
.
s_addr
;

55 
pÜt
 = 
	`htÚs
(
addr4
->
sš_pÜt
);;

56 
AF_INET6
:

57 
addr6
 = (
sockaddr_š6
 *)
§
;

58 
¿waddr
 = (cÚ¡ *)&
addr6
->
sš6_addr
;

59 
pÜt
 = 
	`htÚs
(
addr6
->
sš6_pÜt
);

60 
	`cú_ch¬buf_­³nd_¡ršg
(
c
, "[");

61 
şo£r
 = "]";

66 
s
 = 
	`š‘_Áİ
(
§
->
§_çmy
, 
¿waddr
,

67 (*)
	`cú_ch¬buf_»£rve
(
c
, 
sz
), sz);

68 ià(
s
 =ğ
NULL
) {

69 
c
->
Ëngth
 = 
§vËn
;

72 
c
->
Ëngth
 +ğ
	`¡¾’
(
s
);

73 
	`cú_ch¬buf_­³nd_¡ršg
(
c
, 
şo£r
);

74 (
pÜt
);

75 
	}
}

	@lib/ccn_sockcreate.c

20 
	~<¡dlib.h
>

21 
	~<¡d¬g.h
>

22 
	~<”ºo.h
>

23 
	~<¡ršg.h
>

24 
	~<sigÇl.h
>

25 
	~<sys/ty³s.h
>

26 
	~<sys/time.h
>

27 
	~<sys/sock‘.h
>

28 
	~<Ãtš‘/š.h
>

29 
	~<¬·/š‘.h
>

30 
	~<Ãt/if.h
>

31 
	~<Ãtdb.h
>

32 
	~<uni¡d.h
>

34 
	~<cú/sockü—‹.h
>

36 #ià
defšed
(
NEED_GETADDRINFO_COMPAT
)

37 
	~"g‘addršfo.h
"

38 
	~"dummyš6.h
"

41 
	#LOGGIT
 ià(
logg”
è(*logg”)

	)

42 
	#GOT_HERE
 
	`LOGGIT
(
logd©
, "© cú_sockü—‹.c:%d", 
__LINE__
);

	)

46 
£t_muÉiÿ¡_sock‘_İtiÚs
(
sock‘_r
, 
sock‘_w
,

47 
addršfo
 *
ai
,

48 
addršfo
 *
loÿlif_fÜ_mÿ¡_addršfo
,

49 
muÉiÿ¡‰l
,

50 
ifšdex
,

51 (*
logg”
)(*, const *, ...),

52 *
logd©
)

54 
addršfo
 
hšts
;

55 
_m»q
 
m»q
;

56 #ifdeà
IPV6_JOIN_GROUP


57 
v6_m»q
 
m»q6
;

59 
csockİt
;

60 
isockİt
;

61 
»s
;

63 
	`mem£t
((*)&
hšts
, 0, (hints));

64 
	`mem£t
((*)&
m»q
, 0, (mreq));

65 #ifdeà
IPV6_JOIN_GROUP


66 
	`mem£t
((*)&
m»q6
, 0, (mreq6));

69 ià(
ai
->
ai_çmy
 =ğ
PF_INET
 && 
	`IN_MULTICAST
(
	`Áohl
(((
sockaddr_š
 *)×i->
ai_addr
))->
sš_addr
.
s_addr
))) {

70 
	`LOGGIT
(
logd©
, "IPv4 multicast");

71 #ifdeà
IP_ADD_MEMBERSHIP


72 
	`memıy
((*)&
m»q
.
imr_muÉŸddr
, &((
sockaddr_š
 *)
ai
->
ai_addr
)->
sš_addr
, (mreq.imr_multiaddr));

73 ià(
loÿlif_fÜ_mÿ¡_addršfo
 !ğ
NULL
) {

74 
	`memıy
((*)&
m»q
.
imr_š‹rçû
.
s_addr
, &((
sockaddr_š
 *)
loÿlif_fÜ_mÿ¡_addršfo
->
ai_addr
)->
sš_addr
, (mreq.imr_interface.s_addr));

76 
»s
 = 
	`£tsockİt
(
sock‘_r
, 
IPPROTO_IP
, 
IP_ADD_MEMBERSHIP
, &
m»q
, (mreq));

77 ià(
»s
 == -1) {

78 
	`LOGGIT
(
logd©
, "£tsockİt(..., IP_ADD_MEMBERSHIP, ...): %s", 
	`¡»¼Ü
(
”ºo
));

82 #ifdeà
IP_MULTICAST_LOOP


83 
csockİt
 = 0;

84 
»s
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IP
, 
IP_MULTICAST_LOOP
, &
csockİt
, (csockopt));

85 ià(
»s
 == -1) {

86 
	`LOGGIT
(
logd©
, "£tsockİt(..., IP_MULTICAST_LOOP, ...): %s", 
	`¡»¼Ü
(
”ºo
));

90 #ifdeà
IP_MULTICAST_TTL


91 ià(
muÉiÿ¡‰l
 > 0) {

92 
csockİt
 = 
muÉiÿ¡‰l
;

93 
»s
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IP
, 
IP_MULTICAST_TTL
, &
csockİt
, (csockopt));

94 ià(
»s
 == -1) {

95 
	`LOGGIT
(
logd©
, "£tsockİt(..., IP_MULTICAST_TTL, ...): %s", 
	`¡»¼Ü
(
”ºo
));

100 #ifdeà
IP_MULTICAST_IF


101 ià(
loÿlif_fÜ_mÿ¡_addršfo
 !ğ
NULL
) {

102 
š_addr
 
içddr
 = { 0 };

103 
içddr
 = ((
sockaddr_š
 *)
loÿlif_fÜ_mÿ¡_addršfo
->
ai_addr
)->
sš_addr
;

104 
»s
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IP
, 
IP_MULTICAST_IF
, &
içddr
, (ifaddr));

105 ià(
»s
 == -1) {

106 
	`LOGGIT
(
logd©
, "£tsockİt(..., IP_MULTICAST_IF, ...): %s", 
	`¡»¼Ü
(
”ºo
));

111 } ià(
ai
->
ai_çmy
 =ğ
PF_INET6
 && 
	`IN6_IS_ADDR_MULTICAST
((&((
sockaddr_š6
 *ïi->
ai_addr
)->
sš6_addr
))) {

112 
	`LOGGIT
(
logd©
, "IPv6 multicast");

113 #ifdeà
IPV6_JOIN_GROUP


114 
	`memıy
((*)&
m»q6
.
v6mr_muÉŸddr
, &((
sockaddr_š6
 *)
ai
->
ai_addr
)->
sš6_addr
, (mreq6.ipv6mr_multiaddr));

115 ià(
ifšdex
 > 0) {

116 
m»q6
.
v6mr_š‹rçû
 = 
ifšdex
;

118 
»s
 = 
	`£tsockİt
(
sock‘_r
, 
IPPROTO_IPV6
, 
IPV6_JOIN_GROUP
, &
m»q6
, (mreq6));

119 ià(
»s
 == -1) {

120 
	`LOGGIT
(
logd©
, "£tsockİt(..., IPV6_JOIN_GROUP, ...): %s", 
	`¡»¼Ü
(
”ºo
));

124 #ifdeà
IPV6_MULTICAST_LOOP


125 
isockİt
 = 0;

126 
»s
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IPV6
, 
IPV6_MULTICAST_LOOP
, &
isockİt
, (isockopt));

127 ià(
»s
 == -1) {

128 
	`LOGGIT
(
logd©
, "£tsockİt(..., IPV6_MULTICAST_LOOP, ...): %s", 
	`¡»¼Ü
(
”ºo
));

132 #ifdeà
IPV6_MULTICAST_HOPS


133 ià(
muÉiÿ¡‰l
 > 0) {

134 
isockİt
 = 
muÉiÿ¡‰l
;

135 
»s
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IPV6
, 
IPV6_MULTICAST_HOPS
, &
isockİt
, (isockopt));

136 ià(
»s
 == -1) {

137 
	`LOGGIT
(
logd©
, "£tsockİt(..., IPV6_MULTICAST_LOOP, ...): %s", 
	`¡»¼Ü
(
”ºo
));

142 #ifdeà
IP6_MULTICAST_IF


143 ià(
ifšdex
 > 0) {

144 
isockİt
 = 
ifšdex
;

145 
»s
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IPV6
, 
IP6_MULTICAST_IF
, &
isockİt
, (isockopt));

146 ià(
»s
 == -1) {

147 
	`LOGGIT
(
logd©
, "£tsockİt(..., IP6_MULTICAST_IF, ...): %s", 
	`¡»¼Ü
(
”ºo
));

154 
	}
}

172 
cú_£tup_sock‘
(cÚ¡ 
cú_sockdesü
 *
desü
,

173 (*
logg”
)(*, const *, ...),

174 *
logd©
,

175 (*
g‘bound
)(*, 
sockaddr
 *, 
sockËn_t
),

176 *
g‘boundd©
,

177 
cú_sock‘s
 *
socks
)

179 
»suÉ
 = -1;

180 *
ı
 = 
NULL
;

181 
addršfo
 
hšts
 = {0};

182 
»s
;

183 
addršfo
 *
mÿ¡_sourû_addršfo
 = 
NULL
;

184 
addršfo
 *addršfØğ
NULL
;

185 
addršfo
 *
Ïddršfo
 = 
NULL
;

186 
if_šdex
 = 0;

187 cÚ¡ 
Úe
 = 1;

188 
sock
 = -1;

189 
şo£_´Ùeù
 = -1;

191 
GOT_HERE
;

192 
socks
->
£ndšg
 = socks->
»cvšg
 = -1;

193 ià(
desü
->
´Ùo
 > 0)

194 
hšts
.
ai_´ÙocŞ
 = 
desü
->
´Ùo
;

195 ià(
desü
->
´Ùo
 =ğ
IPPROTO_UDP
)

196 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

197 ià(
desü
->
´Ùo
 =ğ
IPPROTO_TCP
)

198 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

199 
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

200 ià(
desü
->
pÜt
 =ğ
NULL
 ||

201 
	`¡r¥n
(
desü
->
pÜt
, "0123456789"è!ğ
	`¡¾’
(descr->port)) {

202 
	`LOGGIT
(
logd©
, "must specify‚umeric…ort");

203 
Fšish
;

205 
GOT_HERE
;

206 ià(
desü
->
sourû_add»ss
 !ğ
NULL
) {

207 
»s
 = 
	`g‘addršfo
(
desü
->
sourû_add»ss
, desü->
pÜt
,

208 &
hšts
, &
mÿ¡_sourû_addršfo
);

209 ià(
»s
 !ğ0 || 
mÿ¡_sourû_addršfo
 =ğ
NULL
) {

210 
	`LOGGIT
(
logd©
, "getaddrinfo(\"%s\", ...): %s",

211 
desü
->
sourû_add»ss
, 
	`gai_¡»¼Ü
(
»s
));

212 
Fšish
;

214 
hšts
.
ai_çmy
 = 
mÿ¡_sourû_addršfo
->ai_family;

216 
GOT_HERE
;

217 ià(
desü
->
mÿ¡_‰l
 >= 0) {

218 ià(
desü
->
mÿ¡_‰l
 < 1 || descr->mcast_ttl > 255) {

220 
	`LOGGIT
(
logd©
, "mÿ¡_‰l(%dèouˆoà¿nge", 
desü
->
mÿ¡_‰l
);

221 
Fšish
;

224 
GOT_HERE
;

225 ià(
desü
->
add»ss
 =ğ
NULL
) {

226 
	`LOGGIT
(
logd©
, "must specify„emote‡ddress");

227 
Fšish
;

229 #ifdeà
IPV6_JOIN_GROUP


230 
ı
 = 
	`¡rchr
(
desü
->
add»ss
, '%');

231 
GOT_HERE
;

232 ià(
ı
 !ğ
NULL
) {

233 
ı
++;

234 
”ºo
 = 0;

235 
if_šdex
 = 
	`©oi
(
ı
);

236 ià(
if_šdex
 == 0) {

237 
if_šdex
 = 
	`if_Çm‘ošdex
(
ı
);

238 ià(
if_šdex
 =ğ0 && 
”ºo
 != 0) {

239 
	`LOGGIT
(
logd©
, "Inv®id iÁ”çû‚am%s", 
ı
);

240 
Fšish
;

245 
GOT_HERE
;

246 
»s
 = 
	`g‘addršfo
(
desü
->
add»ss
, desü->
pÜt
,

247 &
hšts
, &
addršfo
);

248 ià(
»s
 !ğ0 || 
addršfo
 =ğ
NULL
) {

249 
	`LOGGIT
(
logd©
, "getaddrinfo(\"%s\", ...): %s",

250 
desü
->
add»ss
, 
	`gai_¡»¼Ü
(
»s
));

251 
Fšish
;

253 
sock
 = 
	`sock‘
(
addršfo
->
ai_çmy
,‡ddršfo->
ai_sockty³
,‡ddršfo->
ai_´ÙocŞ
);

254 
GOT_HERE
;

255 ià(
sock
 == -1) {

256 
	`LOGGIT
(
logd©
, "sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

257 
Fšish
;

259 
GOT_HERE
;

260 
socks
->
»cvšg
 = socks->
£ndšg
 = 
sock
;

261 ià(
mÿ¡_sourû_addršfo
 =ğ
NULL
) {

263 
hšts
.
ai_çmy
 = 
addršfo
->ai_family;

264 
hšts
.
ai_sockty³
 = 
addršfo
->ai_socktype;

265 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

266 
GOT_HERE
;

267 
»s
 = 
	`g‘addršfo
(
NULL
, 
desü
->
pÜt
, &
hšts
, &
Ïddršfo
);

268 ià(
»s
 != 0)

269 
Fšish
;

270 
GOT_HERE
;

271 
»s
 = 
	`bšd
(
socks
->
£ndšg
, 
Ïddršfo
->
ai_addr
,†addršfo->
ai_add¾’
);

272 ià(
»s
 =ğ-1 && 
g‘bound
) {

273 
mÿ¡_sourû_addršfo
 = 
Ïddršfo
;

274 
Ïddršfo
 = 
NULL
;

277 ià(
mÿ¡_sourû_addršfo
 !ğ
NULL
) {

286 
socks
->
£ndšg
 = -1;

287 ià(
g‘bound
) {

288 
GOT_HERE
;

289 
socks
->
£ndšg
 = 
	`g‘bound
(
g‘boundd©
,

290 
mÿ¡_sourû_addršfo
->
ai_addr
,

291 
mÿ¡_sourû_addršfo
->
ai_add¾’
);

292 ià(
socks
->
£ndšg
 >= 0) {

293 
GOT_HERE
;

294 
şo£_´Ùeù
 = 
socks
->
£ndšg
;

297 ià(
socks
->
£ndšg
 == -1)

298 
socks
->
£ndšg
 = 
	`sock‘
(
addršfo
->
ai_çmy
,‡ddršfo->
ai_sockty³
,‡ddršfo->
ai_´ÙocŞ
);

299 ià(
socks
->
£ndšg
 == -1) {

300 
	`LOGGIT
(
logd©
, "sock‘: %s", 
	`¡»¼Ü
(
”ºo
));

301 
Fšish
;

303 
»s
 = 
	`£tsockİt
(
socks
->
»cvšg
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
Úe
, (one));

304 ià(
»s
 == -1) {

305 
	`LOGGIT
(
logd©
, "£tsockİtÔecvšg, ..., SO_REUSEADDR, ...): %s", 
	`¡»¼Ü
(
”ºo
));

306 
Fšish
;

309 
»s
 = 
	`bšd
(
socks
->
»cvšg
, 
addršfo
->
ai_addr
,‡ddršfo->
ai_add¾’
);

310 ià(
»s
 == -1) {

311 
	`LOGGIT
(
logd©
, "bšdÔecvšg, ...): %s", 
	`¡»¼Ü
(
”ºo
));

312 
Fšish
;

315 
GOT_HERE
;

316 
»s
 = 
	`£t_muÉiÿ¡_sock‘_İtiÚs
(
socks
->
»cvšg
, socks->
£ndšg
,

317 
addršfo
,

318 
mÿ¡_sourû_addršfo
,

319 
desü
->
mÿ¡_‰l
,

320 
if_šdex
,

321 
logg”
,

322 
logd©
);

323 ià(
»s
 < 0)

324 
Fšish
;

325 ià(
mÿ¡_sourû_addršfo
 !ğ
NULL
) {

326 
GOT_HERE
;

327 ià(
socks
->
£ndšg
 !ğ
şo£_´Ùeù
) {

328 
»s
 = 
	`bšd
(
socks
->
£ndšg
,

329 
mÿ¡_sourû_addršfo
->
ai_addr
,

330 
mÿ¡_sourû_addršfo
->
ai_add¾’
);

331 ià(
»s
 == -1) {

332 
	`LOGGIT
(
logd©
, "bšd(£ndšg, ...): %s", 
	`¡»¼Ü
(
”ºo
));

333 
Fšish
;

337 
GOT_HERE
;

338 
»suÉ
 = 0;

340 
Fšish
:

341 ià(
addršfo
 !ğ
NULL
)

342 
	`ä“addršfo
(
addršfo
);

343 ià(
Ïddršfo
 !ğ
NULL
)

344 
	`ä“addršfo
(
Ïddršfo
);

345 ià(
mÿ¡_sourû_addršfo
 !ğ
NULL
)

346 
	`ä“addršfo
(
mÿ¡_sourû_addršfo
);

347 ià(
»suÉ
 != 0) {

348 
	`şo£
(
socks
->
»cvšg
);

349 ià(
socks
->
£ndšg
 !ğsocks->
»cvšg
 && socks->£ndšg !ğ
şo£_´Ùeù
)

350 
	`şo£
(
socks
->
£ndšg
);

351 
socks
->
£ndšg
 = socks->
»cvšg
 = -1;

353 (
»suÉ
);

354 
	}
}

	@lib/ccn_traverse.c

20 
	~<as£¹.h
>

21 
	~<¡dšt.h
>

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

26 
	~<cú/bloom.h
>

27 
	~<cú/cú.h
>

28 
	~<cú/ch¬buf.h
>

29 
	~<cú/uri.h
>

37 
	scú_Œav”§l
 {

38 
	mmagic
;

39 *
	mcouÁ”
;

40 
	mw¬n
;

41 
	mæags
;

42 
	mn_exş
;

43 
cú_ch¬buf
 **
	mexş
;

47 
	#EXCLUDE_LOW
 1

	)

48 
	#EXCLUDE_HIGH
 2

	)

49 
	#MUST_VERIFY
 4

	)

50 
	#LOCAL_SCOPE
 8

	)

51 
	#ALLOW_STALE
 0x10

	)

54 
Çmecom·»
(cÚ¡ *
a
, cÚ¡ *
b
);

55 
cú_Œav”§l
 *
g‘_my_d©a
(
cú_şosu»
 *
£lå
);

56 
­³nd_Any_f‹r
(
cú_ch¬buf
 *
c
);

57 
ex´ess_my_š‹»¡
(
cú
 *
h
,

58 
cú_şosu»
 *
£lå
,

59 
cú_ch¬buf
 *
Çme
);

60 
cú_şosu»
 *
¥l™_my_exşudes
(cú_şosu» *
£lå
);

61 
cú_upÿÎ_»s
 
šcomšg_cÚ‹Á
(
cú_şosu»
 *
£lå
,

62 
cú_upÿÎ_kšd
 
kšd
,

63 
cú_upÿÎ_šfo
 *);

64 
cú_ch¬buf
 *
cú_ch¬buf_du¶iÿ‹
(ccn_charbuf *);

65 
ªsw”_·ssive
(
cú_ch¬buf
 *
‹m¶
, 
®low_¡®e
);

66 
loÿl_scİe
(
cú_ch¬buf
 *
‹m¶
);

75 
	$Çmecom·»
(cÚ¡ *
a
, cÚ¡ *
b
)

77 cÚ¡ 
cú_ch¬buf
 *
¯
 = *(cÚ¡ cú_ch¬buà**)
a
;

78 cÚ¡ 
cú_ch¬buf
 *
bb
 = *(cÚ¡ cú_ch¬buà**)
b
;

79 
ªs
 = 
	`cú_com·»_Çmes
(
¯
->
buf
,‡a->
Ëngth
, 
bb
->buf, bb->length);

80 ià(
ªs
 == 0)

81 
	`abÜt
();

82  (
ªs
);

83 
	}
}

85 
cú_Œav”§l
 *
	$g‘_my_d©a
(
cú_şosu»
 *
£lå
)

87 
cú_Œav”§l
 *
d©a
 = 
£lå
->data;

88 ià(
d©a
->
magic
 !ğ68955871è
	`abÜt
();

89 (
d©a
);

90 
	}
}

124 
cú_upÿÎ_»s


125 
	$šcomšg_cÚ‹Á
(

126 
cú_şosu»
 *
£lå
,

127 
cú_upÿÎ_kšd
 
kšd
,

128 
cú_upÿÎ_šfo
 *
šfo
)

130 
cú_ch¬buf
 *
c
 = 
NULL
;

131 
cú_ch¬buf
 *
comp
 = 
NULL
;

132 
cú_ch¬buf
 *
uri
 = 
NULL
;

133 cÚ¡ *
cúb
 = 
NULL
;

134 
size_t
 
cúb_size
 = 0;

135 
cú_šdexbuf
 *
comps
 = 
NULL
;

136 
m©ched_comps
 = 0;

137 
»s
;

138 
i
;

139 
cú_Œav”§l
 *
d©a
 = 
	`g‘_my_d©a
(
£lå
);

141 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

142 
i
 = 0; i < 
d©a
->
n_exş
; i++)

143 
	`cú_ch¬buf_de¡roy
(&(
d©a
->
exş
[
i
]));

144 ià(
d©a
->
exş
 !ğ
NULL
)

145 
	`ä“
(
d©a
->
exş
);

146 
	`ä“
(
d©a
);

147 
	`ä“
(
£lå
);

150 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

152 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_BAD
)

154 ià(
kšd
 =ğ
CCN_UPCALL_CONTENT_UNVERIFIED
) {

155 ià((
d©a
->
æags
 & 
MUST_VERIFY
) != 0)

156 (
CCN_UPCALL_RESULT_VERIFY
);

158 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
 && kšd !ğ
CCN_UPCALL_CONTENT_UNVERIFIED
è
	`abÜt
();

160 
cúb
 = 
šfo
->
cÚ‹Á_cúb
;

161 
cúb_size
 = 
šfo
->
pco
->
off£t
[
CCN_PCO_E
];

162 
comps
 = 
šfo
->
cÚ‹Á_comps
;

163 
m©ched_comps
 = 
šfo
->
pi
->
´efix_comps
;

164 
c
 = 
	`cú_ch¬buf_ü—‹
();

165 
uri
 = 
	`cú_ch¬buf_ü—‹
();

167 ià(
m©ched_comps
 + 1 > 
comps
->
n
) {

168 
	`cú_uri_­³nd
(
c
, 
cúb
, 
cúb_size
, 1);

169 
	`årštf
(
¡d”r
, "How didhi h­³n? %s\n", 
	`cú_ch¬buf_as_¡ršg
(
uri
));

170 
	`ex™
(1);

173 
d©a
->
couÁ”
[0]++;

176 
	`cú_Çme_š™
(
c
);

177 
	`cú_Çme_­³nd_compÚ’ts
(
c
, 
cúb
, 
comps
->
buf
[0], comps->buf[
m©ched_comps
]);

179 
comp
 = 
	`cú_ch¬buf_ü—‹
();

180 
	`cú_Çme_š™
(
comp
);

181 ià(
m©ched_comps
 + 1 =ğ
comps
->
n
) {

183 
	`cú_dige¡_CÚ‹ÁObjeù
(
cúb
, 
šfo
->
pco
);

184 
	`cú_Çme_­³nd
(
comp
, 
šfo
->
pco
->
dige¡
, info->pco->
dige¡_by‹s
);

187 
	`cú_Çme_­³nd_compÚ’ts
(
comp
, 
cúb
,

188 
comps
->
buf
[
m©ched_comps
],

189 
comps
->
buf
[
m©ched_comps
 + 1]);

191 
d©a
->
exş
 = 
	`»®loc
(d©a->exş, (d©a->
n_exş
 + 1) * (data->excl[0]));

192 
d©a
->
exş
[d©a->
n_exş
++] = 
comp
;

193 
comp
 = 
NULL
;

194 
	`qsÜt
(
d©a
->
exş
, d©a->
n_exş
, (d©a->exş[0]), &
Çmecom·»
);

195 
»s
 = 
	`ex´ess_my_š‹»¡
(
šfo
->
h
, 
£lå
, 
c
);

196 ià(
»s
 == -1) {

197 
cú_şosu»
 *
high
 = 
	`¥l™_my_exşudes
(
£lå
);

198 ià(
high
 =ğ
NULL
è
	`abÜt
();

199 
	`ex´ess_my_š‹»¡
(
šfo
->
h
, 
£lå
, 
c
);

200 
	`ex´ess_my_š‹»¡
(
šfo
->
h
, 
high
, 
c
);

203 ià(
m©ched_comps
 + 2 < 
comps
->
n
) {

204 
cú_Œav”§l
 *
Ãwd©
 = 
NULL
;

205 
cú_şosu»
 *
ş
;

206 
Ãwd©
 = 
	`ÿÎoc
(1, (*newdat));

207 
Ãwd©
->
magic
 = 68955871;

208 
Ãwd©
->
w¬n
 = 1492;

209 
Ãwd©
->
couÁ”
 = 
d©a
->counter;

210 
Ãwd©
->
æags
 = 
d©a
->æag & ~(
EXCLUDE_LOW
 | 
EXCLUDE_HIGH
);

211 
Ãwd©
->
n_exş
 = 0;

212 
Ãwd©
->
exş
 = 
NULL
;

213 
ş
 = 
	`ÿÎoc
(1, (*cl));

214 
ş
->
p
 = &
šcomšg_cÚ‹Á
;

215 
ş
->
d©a
 = 
Ãwd©
;

216 
	`cú_Çme_š™
(
c
);

217 
	`cú_Çme_­³nd_compÚ’ts
(
c
, 
cúb
,

218 
comps
->
buf
[0],

219 
comps
->
buf
[
m©ched_comps
 + 1]);

220 
	`ex´ess_my_š‹»¡
(
šfo
->
h
, 
ş
, 
c
);

223 
»s
 = 
	`cú_uri_­³nd
(
uri
, 
šfo
->
cÚ‹Á_cúb
, info->
pco
->
off£t
[
CCN_PCO_E
], 1);

224 ià(
»s
 < 0)

225 
	`årštf
(
¡d”r
, "*** E¼Ü: cú_Œav”£†š%d„es=%d\n", 
__LINE__
, 
»s
);

227 
	`´štf
("%s\n", 
	`cú_ch¬buf_as_¡ršg
(
uri
));

229 
	`cú_ch¬buf_de¡roy
(&
c
);

230 
	`cú_ch¬buf_de¡roy
(&
uri
);

232 
	}
}

239 
	$ex´ess_my_š‹»¡
(
cú
 *
h
,

240 
cú_şosu»
 *
£lå
,

241 
cú_ch¬buf
 *
Çme
)

243 
ªs
;

244 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

245 
i
;

246 
cú_Œav”§l
 *
d©a
 = 
	`g‘_my_d©a
(
£lå
);

248 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

249 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

250 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

251 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

252 ià(
d©a
->
n_exş
 != 0) {

253 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Exşude
, 
CCN_DTAG
);

254 ià((
d©a
->
æags
 & 
EXCLUDE_LOW
) != 0)

255 
	`­³nd_Any_f‹r
(
‹m¶
);

256 
i
 = 0; i < 
d©a
->
n_exş
; i++) {

257 
cú_ch¬buf
 *
comp
 = 
d©a
->
exş
[
i
];

258 ià(
comp
->
Ëngth
 < 4è
	`abÜt
();

259 
	`cú_ch¬buf_­³nd
(
‹m¶
, 
comp
->
buf
 + 1, comp->
Ëngth
 - 2);

261 ià((
d©a
->
æags
 & 
EXCLUDE_HIGH
) != 0)

262 
	`­³nd_Any_f‹r
(
‹m¶
);

263 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

265 
	`ªsw”_·ssive
(
‹m¶
, (
d©a
->
æags
 & 
ALLOW_STALE
) != 0);

266 ià((
d©a
->
æags
 & 
LOCAL_SCOPE
) != 0)

267 
	`loÿl_scİe
(
‹m¶
);

268 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

269 ià(
‹m¶
->
Ëngth
 + 
Çme
->Ëngth > 
d©a
->
w¬n
 + 2) {

270 
	`årštf
(
¡d”r
, "*** IÁ”e¡…ack‘ i %d by‹s\n", ()
‹m¶
->
Ëngth
);

271 
d©a
->
w¬n
 = data->warn * 8 / 5;

273 ià(
‹m¶
->
Ëngth
 + 
Çme
->Ëngth > 1450 && 
d©a
->
n_exş
 > 3)

274 
ªs
 = -1;

276 
	`cú_ex´ess_š‹»¡
(
h
, 
Çme
, 
£lå
, 
‹m¶
);

277 
ªs
 = 0;

279 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

280 (
ªs
);

281 
	}
}

287 
cú_şosu»
 *

288 
	$¥l™_my_exşudes
(
cú_şosu»
 *
£lå
)

290 
i
;

291 
m
;

292 
cú_Œav”§l
 *
Ãwd©
 = 
NULL
;

293 
cú_şosu»
 *
ş
;

294 
cú_Œav”§l
 *
d©a
 = 
	`g‘_my_d©a
(
£lå
);

296 ià(
d©a
->
n_exş
 < 3)

297  
NULL
;

298 
m
 = 
d©a
->
n_exş
 / 2;

299 
Ãwd©
 = 
	`ÿÎoc
(1, (*newdat));

300 
Ãwd©
->
magic
 = 68955871;

301 
Ãwd©
->
w¬n
 = 1492;

302 
Ãwd©
->
couÁ”
 = 
d©a
->counter;

303 
Ãwd©
->
n_exş
 = 
d©a
->n_exş - 
m
;

304 
Ãwd©
->
exş
 = 
	`ÿÎoc
Òewd©->
n_exş
, (newdat->excl[0]));

305 ià(
Ãwd©
->
exş
 =ğ
NULL
) {

306 
	`ä“
(
Ãwd©
);

307 (
NULL
);

309 
Ãwd©
->
exş
[0] = 
	`cú_ch¬buf_du¶iÿ‹
(
d©a
->exş[
m
]);

310 
Ãwd©
->
æags
 = 
d©a
->æag | 
EXCLUDE_LOW
;

311 
i
 = 1; i < 
Ãwd©
->
n_exş
; i++) {

312 
Ãwd©
->
exş
[
i
] = 
d©a
->exş[
m
 + i];

313 
d©a
->
exş
[
m
 + 
i
] = 
NULL
;

315 
d©a
->
n_exş
 = 
m
 + 1;

316 
d©a
->
æags
 |ğ
EXCLUDE_HIGH
;

317 
ş
 = 
	`ÿÎoc
(1, (*cl));

318 
ş
->
p
 = &
šcomšg_cÚ‹Á
;

319 
ş
->
d©a
 = 
Ãwd©
;

320 (
ş
);

321 
	}
}

328 
	$­³nd_Any_f‹r
(
cú_ch¬buf
 *
c
)

330 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Any
, 
CCN_DTAG
);

331 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

332 
	}
}

334 
cú_ch¬buf
 *

335 
	$cú_ch¬buf_du¶iÿ‹
(
cú_ch¬buf
 *
c
)

337 
cú_ch¬buf
 *
ªs
 = 
	`cú_ch¬buf_ü—‹
();

338 
	`cú_ch¬buf_­³nd
(
ªs
, 
c
->
buf
, c->
Ëngth
);

339 (
ªs
);

340 
	}
}

347 
	$ªsw”_·ssive
(
cú_ch¬buf
 *
‹m¶
, 
®low_¡®e
)

349 
aok
 = 
CCN_AOK_CS
;

350 ià(
®low_¡®e
)

351 
aok
 |ğ
CCN_AOK_STALE
;

352 
	`cúb_gged_putf
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, "%d", 
aok
);

353 
	}
}

360 
	$loÿl_scİe
(
cú_ch¬buf
 *
‹m¶
)

362 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Scİe
, 
CCN_DTAG
);

363 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 1, 
CCN_UDATA
);

364 
	`cú_ch¬buf_­³nd
(
‹m¶
, "0", 1);

365 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

366 
	}
}

373 
	$cú_dump_Çmes
(
cú
 *
h
, 
cú_ch¬buf
 *
Çme_´efix
, 
loÿl_scİe
, 
®low_¡®e
)

375 *
couÁ”
;

376 
i
;

377 
n
;

378 
»s
;

379 
cú_Œav”§l
 *
d©a
 = 
NULL
;

380 
cú_şosu»
 *
ş
 = 
NULL
;

382 
couÁ”
 = 
	`ÿÎoc
(1, (*counter));

383 
d©a
 = 
	`ÿÎoc
(1, (*data));

384 
d©a
->
magic
 = 68955871;

385 
d©a
->
w¬n
 = 1492;

386 
d©a
->
æags
 = 0;

387 
d©a
->
couÁ”
 = counter;

388 ià(
loÿl_scİe
)

389 
d©a
->
æags
 |ğ
LOCAL_SCOPE
;

390 ià(
®low_¡®e
)

391 
d©a
->
æags
 |ğ
ALLOW_STALE
;

393 
ş
 = 
	`ÿÎoc
(1, (*cl));

394 
ş
->
p
 = &
šcomšg_cÚ‹Á
;

395 
ş
->
d©a
 = data;

397 
	`ex´ess_my_š‹»¡
(
h
, 
ş
, 
Çme_´efix
);

398 
ş
 = 
NULL
;

399 
d©a
 = 
NULL
;

400 
i
 = 0;; i++) {

401 
n
 = *
couÁ”
;

402 
»s
 = 
	`cú_run
(
h
, 1000);

403 
	`fæush
(
¡dout
);

404 ià(*
couÁ”
 =ğ
n
 || 
»s
 < 0)

407 
	`ex™
(0);

408 
	}
}

	@lib/ccn_uri.c

20 
	~<¡ršg.h
>

21 
	~<cú/cú.h
>

22 
	~<cú/ch¬buf.h
>

23 
	~<cú/codšg.h
>

24 
	~<cú/uri.h
>

51 
	$cú_uri_­³nd_³rûÁesÿ³d
(
cú_ch¬buf
 *
c
,

52 cÚ¡ *
d©a
, 
size_t
 
size
)

54 
size_t
 
i
;

55 
ch
;

56 
i
 = 0; i < 
size
 && 
d©a
[i] == '.'; i++)

59 ià(
i
 =ğ
size
)

60 
	`cú_ch¬buf_­³nd
(
c
, "...", 3);

61 
i
 = 0; i < 
size
; i++) {

62 
ch
 = 
d©a
[
i
];

67 ià(('a' <ğ
ch
 && ch <= 'z') ||

68 ('A' <ğ
ch
 && ch <= 'Z') ||

69 ('0' <ğ
ch
 && ch <= '9') ||

70 
ch
 == '-' || ch == '.' || ch == '_' || ch == '~')

71 
	`cú_ch¬buf_­³nd
(
c
, &(
d©a
[
i
]), 1);

73 
	`cú_ch¬buf_putf
(
c
, "%%%02X", ()
ch
);

75 
	}
}

88 
	$cú_uri_­³nd
(
cú_ch¬buf
 *
c
,

89 cÚ¡ *
cúb
,

90 
size_t
 
size
,

91 
šşudescheme
)

93 
ncomp
 = 0;

94 cÚ¡ *
comp
 = 
NULL
;

95 
size_t
 
compsize
 = 0;

96 
cú_buf_decod”
 
decod”
;

97 
cú_buf_decod”
 *
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
cúb
, 
size
);

98 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_IÁ”e¡
) ||

99 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CÚ‹ÁObjeù
)) {

100 
	`cú_buf_advªû
(
d
);

101 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_SigÇtu»
))

102 
	`cú_buf_advªû_·¡_–em’t
(
d
);

104 ià(!
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Name
))

106 ià(
šşudescheme
)

107 
	`cú_ch¬buf_­³nd_¡ršg
(
c
, "ccnx:");

108 
	`cú_buf_advªû
(
d
);

109 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

110 
	`cú_buf_advªû
(
d
);

111 
compsize
 = 0;

112 ià(
	`cú_buf_m©ch_blob
(
d
, &
comp
, &
compsize
))

113 
	`cú_buf_advªû
(
d
);

114 
	`cú_buf_check_şo£
(
d
);

115 ià(
d
->
decod”
.
¡©e
 < 0)

116 (
d
->
decod”
.
¡©e
);

117 
ncomp
 += 1;

118 
	`cú_ch¬buf_­³nd
(
c
, "/", 1);

119 
	`cú_uri_­³nd_³rûÁesÿ³d
(
c
, 
comp
, 
compsize
);

121 
	`cú_buf_check_şo£
(
d
);

122 ià(
d
->
decod”
.
¡©e
 < 0)

123  (
d
->
decod”
.
¡©e
);

124 ià(
ncomp
 == 0)

125 
	`cú_ch¬buf_­³nd
(
c
, "/", 1);

126 (
ncomp
);

127 
	}
}

130 
	$hex™
(
c
)

132 ià('0' <ğ
c
 && c <= '9')

133 (
c
 - '0');

134 ià('A' <ğ
c
 && c <= 'F')

135 (
c
 - 'A' + 10);

136 ià('a' <ğ
c
 && c <= 'f')

137 (
c
 - 'a' + 10);

139 
	}
}

161 
	$cú_­³nd_uri_compÚ’t
(
cú_ch¬buf
 *
c
, cÚ¡ *
s
, 
size_t
 
lim™
, size_ˆ*
cÚt
)

163 
size_t
 
¡¬t
 = 
c
->
Ëngth
;

164 
size_t
 
i
;

165 
”r
 = 0;

166 
d1
, 
d2
;

167 
ch
;

168 
i
 = 0; i < 
lim™
; i++) {

169 
ch
 = 
s
[
i
];

170 
ch
) {

175 
lim™
 = 
i
;

178 ià(
i
 + 3 > 
lim™
 || (
d1
 = 
	`hex™
(
s
[i+1])) < 0 ||

179 (
d2
 = 
	`hex™
(
s
[
i
+2])) < 0 ) {

182 
ch
 = 
d1
 * 16 + 
d2
;

183 
i
 += 2;

184 
	`cú_ch¬buf_­³nd
(
c
, &
ch
, 1);

189 
”r
++;

192 ià(
ch
 <= ' ' || ch > '~')

193 
”r
++;

194 
	`cú_ch¬buf_­³nd
(
c
, &
ch
, 1);

198 
i
 = 
¡¬t
; i < 
c
->
Ëngth
 && c->
buf
[i] == '.'; i++)

200 ià(
i
 =ğ
c
->
Ëngth
) {

202 
i
 -ğ
¡¬t
;

203 ià(
i
 <= 1) {

204 
c
->
Ëngth
 = 
¡¬t
;

205 
”r
 = -2;

207 ià(
i
 == 2) {

208 
c
->
Ëngth
 = 
¡¬t
;

209 
”r
 = -1;

212 
c
->
Ëngth
 -= 3;

214 ià(
cÚt
 !ğ
NULL
)

215 *
cÚt
 = 
lim™
;

216 (
”r
);

217 
	}
}

220 
	$cú_Çme_Ï¡_compÚ’t_off£t
(cÚ¡ *
cúb
, 
size_t
 
size
)

222 
cú_buf_decod”
 
decod”
;

223 
cú_buf_decod”
 *
d
 = 
	`cú_buf_decod”_¡¬t
(&
decod”
, 
cúb
, 
size
);

224 
»s
 = -1;

225 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Name
)) {

226 
	`cú_buf_advªû
(
d
);

227 
»s
 = 
d
->
decod”
.
tok’_šdex
;

228 
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_CompÚ’t
)) {

229 
»s
 = 
d
->
decod”
.
tok’_šdex
;

230 
	`cú_buf_advªû
(
d
);

231 ià(
	`cú_buf_m©ch_blob
(
d
, 
NULL
, NULL))

232 
	`cú_buf_advªû
(
d
);

233 
	`cú_buf_check_şo£
(
d
);

235 
	`cú_buf_check_şo£
(
d
);

237  ((
d
->
decod”
.
¡©e
 >ğ0è? 
»s
 : -1);

238 
	}
}

249 
	$cú_Çme_äom_uri
(
cú_ch¬buf
 *
c
, cÚ¡ *
uri
)

251 
»s
 = 0;

252 
cú_ch¬buf
 *
compbuf
 = 
NULL
;

253 cÚ¡ *
¡İ
 = 
uri
 + 
	`¡¾’
(uri);

254 cÚ¡ *
s
 = 
uri
;

255 
size_t
 
cÚt
 = 0;

257 
compbuf
 = 
	`cú_ch¬buf_ü—‹
();

258 ià(
compbuf
 =ğ
NULL
) (-1);

259 ià(
s
[0] != '/') {

260 
»s
 = 
	`cú_­³nd_uri_compÚ’t
(
compbuf
, 
s
, 
¡İ
 - s, &
cÚt
);

261 ià(
»s
 < -2)

262 
DÚe
;

263 
	`cú_ch¬buf_»£rve
(
compbuf
, 1)[0] = 0;

264 ià((0 =ğ
	`¡rÿ£cmp
((cÚ¡ *)(
compbuf
->
buf
), "ccnx:") ||

265 0 =ğ
	`¡rÿ£cmp
((cÚ¡ *)(
compbuf
->
buf
), "ccn:")) &&

266 
s
[
cÚt
-1] == ':') {

267 
s
 +ğ
cÚt
;

268 
cÚt
 = 0;

272 ià(
s
[0] == '/') {

273 
	`cú_Çme_š™
(
c
);

274 ià(
s
[1] == '/') {

276 
s
 += 2;

277 
compbuf
->
Ëngth
 = 0;

278 
»s
 = 
	`cú_­³nd_uri_compÚ’t
(
compbuf
, 
s
, 
¡İ
 - s, &
cÚt
);

279 ià(
»s
 < 0 &&„es != -2)

280 
DÚe
;

281 
s
 +ğ
cÚt
; cont = 0;

284 
s
[0] != 0 && s[0] != '?' && s[0] != '#') {

285 ià(
s
[0] == '/')

286 
s
++;

287 
compbuf
->
Ëngth
 = 0;

288 
»s
 = 
	`cú_­³nd_uri_compÚ’t
(
compbuf
, 
s
, 
¡İ
 - s, &
cÚt
);

289 
s
 +ğ
cÚt
; cont = 0;

290 ià(
»s
 < -2)

291 
DÚe
;

292 ià(
»s
 == -2) {

293 
»s
 = 0;

296 ià(
»s
 == -1) {

298 
»s
 = 
	`cú_Çme_Ï¡_compÚ’t_off£t
(
c
->
buf
, c->
Ëngth
);

299 ià(
»s
 < 0)

300 
DÚe
;

301 
c
->
Ëngth
 = 
»s
;

302 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

305 
»s
 = 
	`cú_Çme_­³nd
(
c
, 
compbuf
->
buf
, compbuf->
Ëngth
);

306 ià(
»s
 < 0)

307 
DÚe
;

309 
DÚe
:

310 
	`cú_ch¬buf_de¡roy
(&
compbuf
);

311 ià(
»s
 < 0)

313 ià(
c
->
Ëngth
 < 2 || c->
buf
[c->Ëngth-1] !ğ
CCN_CLOSE
)

315 (
s
 - 
uri
);

316 
	}
}

	@lib/ccn_verifysig.c

20 
	~<fú.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/ty³s.h
>

25 
	~<uni¡d.h
>

27 
	~<cú/cú.h
>

28 
	~<cú/key¡Üe.h
>

29 
	~<cú/signšg.h
>

31 
	g¿wbuf
[8801];

33 
	#MOAN
(
¬gs
èdØ{ 
årštf
‡rgs; 
	`Mßn
(
__LINE__
); 
¡©us
 = 1; } 0)

	)

36 
	$Mßn
(
lše
) {

37 
	`årštf
(
¡d”r
, "‡ˆcú_v”ifysig.c:%d\n", 
lše
);

38 
	}
}

41 
	$maš
(
¬gc
, **
¬gv
)

43 
ch
;

44 
»s
;

45 
¬gi
;

46 
fd
;

47 
ssize_t
 
size
;

48 cÚ¡ *
f’ame
;

49 
cú_·r£d_CÚ‹ÁObjeù
 
obj
 = {0};

50 
cú_·r£d_CÚ‹ÁObjeù
 *
co
 = &
obj
;

51 
cú_šdexbuf
 *
comps
 = 
	`cú_šdexbuf_ü—‹
();

52 
cú_key¡Üe
 *
key¡Üe
;

53 *
home
 = 
	`g‘’v
("HOME");

54 *
key¡Üe_suffix
 = "/.ccnx/.ccnx_keystore";

55 *
key¡Üe_Çme
 = 
NULL
;

57 
¡©us
 = 0;

59 
good
 = 0;

60 
bad
 = 0;

67 cÚ¡ *
v”ifiÿtiÚ_pubkey
 = 
NULL
;

69 ià(
home
 =ğ
NULL
) {

70 
	`´štf
("Unableo determine home directory for keystore\n");

71 
	`ex™
(1);

73 
key¡Üe_Çme
 = 
	`ÿÎoc
(1, 
	`¡¾’
(
home
è+ sŒËn(
key¡Üe_suffix
) + 1);

75 
	`¡rÿt
(
key¡Üe_Çme
, 
home
);

76 
	`¡rÿt
(
key¡Üe_Çme
, 
key¡Üe_suffix
);

78 
key¡Üe
 = 
	`cú_key¡Üe_ü—‹
();

79 ià(0 !ğ
	`cú_key¡Üe_š™
(
key¡Üe
, 
key¡Üe_Çme
, "Th1s1sn0t8g00dp8ssw0rd.")) {

80 
	`´štf
("Failedo initialize keystore\n");

81 
	`ex™
(1);

83 
v”ifiÿtiÚ_pubkey
 = 
	`cú_key¡Üe_public_key
(
key¡Üe
);

85 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "h")) != -1) {

86 
ch
) {

89 
	`årštf
(
¡d”r
, "provide‚ames of files containing ccnb format content\n");

90 
	`ex™
(1);

93 
¬gc
 -ğ
İtšd
;

94 
¬gv
 +ğ
İtšd
;

95 
¬gi
 = 0; 
¬gv
[¬gi] !ğ
NULL
;‡rgi++) {

96 
f’ame
 = 
¬gv
[
¬gi
];

97 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

98 ià(
fd
 == -1) {

99 
	`³¼Ü
(
f’ame
);

100 
¡©us
 = 1;

103 
	`årštf
(
¡d”r
, "R—dšg % ... ", 
f’ame
);

104 
size
 = 
	`»ad
(
fd
, 
¿wbuf
, (rawbuf));

105 ià(
size
 < 0) {

106 
	`³¼Ü
("skipping");

107 
	`şo£
(
fd
);

108 
¡©us
 = 1;

111 
	`şo£
(
fd
);

112 ià(
size
 =ğ(
¿wbuf
)) {

113 
	`årštf
(
¡d”r
, "skipping:oo big\n");

114 
¡©us
 = 1;

117 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
¿wbuf
, 
size
, 
co
, 
comps
);

118 ià(
»s
 < 0) {

119 
	`årštf
(
¡d”r
, "skipping:‚ot‡ ContentObject\n");

120 
¡©us
 = 1;

123 ià(
co
->
off£t
[
CCN_PCO_B_KeyLoÿtÜ
] !ğco->off£t[
CCN_PCO_E_KeyLoÿtÜ
]) {

124 
cú_buf_decod”
 
decod”
;

125 
cú_buf_decod”
 *
d
 =

126 
	`cú_buf_decod”_¡¬t
(&
decod”
,

127 
¿wbuf
 + 
co
->
off£t
[
CCN_PCO_B_Key_C”tifiÿ‹_KeyName
],

128 
co
->
off£t
[
CCN_PCO_E_Key_C”tifiÿ‹_KeyName
] - co->off£t[
CCN_PCO_B_Key_C”tifiÿ‹_KeyName
]);

130 
	`årštf
(
¡d”r
, "[has KeyLocator: ");

131 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_KeyName
)è
	`årštf
(
¡d”r
, "KeyName] ");

132 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_C”tifiÿ‹
)è
	`årštf
(
¡d”r
, "Certificate] ");

133 ià(
	`cú_buf_m©ch_dg
(
d
, 
CCN_DTAG_Key
)è
	`årštf
(
¡d”r
, "Key] ");

136 
»s
 = 
	`cú_v”ify_sigÇtu»
(
¿wbuf
, 
size
, 
co
, 
v”ifiÿtiÚ_pubkey
);

138 ià(
»s
 != 1) {

139 
	`årštf
(
¡d”r
, "Signature failedo verify\n");

140 
bad
++;

142 
	`årštf
(
¡d”r
, "Verified\n");

143 
good
++;

146 
	`´štf
("\n%d fes, %d sk³d, %d good, %d bad.\n", 
¬gi
,‡rg˜- 
good
 - 
bad
, good, bad);

147 
	`ex™
(
¡©us
);

148 
	}
}

	@lib/ccn_versioning.c

20 
	~<”ºo.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<uni¡d.h
>

25 
	~<cú/bloom.h
>

26 
	~<cú/cú.h
>

27 
	~<cú/ch¬buf.h
>

28 
	~<cú/uri.h
>

29 
	~<cú/cú_´iv©e.h
>

31 
	#FF
 0xff

	)

38 
	$­³nd_f‹r_®l
(
cú_ch¬buf
 *
c
)

40 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Any
, 
CCN_DTAG
);

41 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

42 
	}
}

49 
	$ªsw”_·ssive
(
cú_ch¬buf
 *
‹m¶
)

51 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Answ”OrigšKšd
, 
CCN_DTAG
);

52 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 1, 
CCN_UDATA
);

53 
	`cú_ch¬buf_­³nd
(
‹m¶
, "1", 1);

54 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

55 
	}
}

62 
	$ªsw”_highe¡
(
cú_ch¬buf
 *
‹m¶
)

64 
	`cúb_gged_putf
(
‹m¶
, 
CCN_DTAG_ChdS–eùÜ
, "1");

65 
	}
}

68 
	$­³nd_futu»_vcomp
(
cú_ch¬buf
 *
‹m¶
)

71 
b
[7] = {
CCN_MARKER_VERSION
 + 1, 0, 0, 0, 0, 0, 0};

72 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_CompÚ’t
, 
CCN_DTAG
);

73 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, (
b
), 
CCN_BLOB
);

74 
	`cú_ch¬buf_­³nd
(
‹m¶
, 
b
, (b));

75 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

76 
	}
}

78 
cú_ch¬buf
 *

79 
	$»sŞve_‹m¶
(
cú_ch¬buf
 *
‹m¶
, cÚ¡ *
vcomp
, 
size
)

81 ià(
‹m¶
 =ğ
NULL
)

82 
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

83 ià(
size
 < 3 || size > 16) {

84 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

85 (
NULL
);

87 
‹m¶
->
Ëngth
 = 0;

88 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
);

89 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

90 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

91 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_Exşude
, 
CCN_DTAG
);

92 
	`­³nd_f‹r_®l
(
‹m¶
);

93 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
CCN_DTAG_CompÚ’t
, 
CCN_DTAG
);

94 
	`cú_ch¬buf_­³nd_‰
(
‹m¶
, 
size
, 
CCN_BLOB
);

95 
	`cú_ch¬buf_­³nd
(
‹m¶
, 
vcomp
, 
size
);

96 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

97 
	`­³nd_futu»_vcomp
(
‹m¶
);

98 
	`­³nd_f‹r_®l
(
‹m¶
);

99 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

100 
	`ªsw”_highe¡
(
‹m¶
);

101 
	`ªsw”_·ssive
(
‹m¶
);

102 
	`cú_ch¬buf_­³nd_şo£r
(
‹m¶
);

103 (
‹m¶
);

104 
	}
}

124 
	$cú_»sŞve_v”siÚ
(
cú
 *
h
, 
cú_ch¬buf
 *
Çme
,

125 
v”siÚšg_æags
, 
timeout_ms
)

127 
»s
;

128 
my»s
 = -1;

129 
cú_·r£d_CÚ‹ÁObjeù
 
pco_¥aû
 = { 0 };

130 
cú_ch¬buf
 *
‹m¶
 = 
NULL
;

131 
cú_ch¬buf
 *
´efix
 = 
	`cú_ch¬buf_ü—‹
();

132 
cú_ch¬buf
 *
cobj
 = 
	`cú_ch¬buf_ü—‹
();

133 
cú_·r£d_CÚ‹ÁObjeù
 *
pco
 = &
pco_¥aû
;

134 
cú_šdexbuf
 *
ndx
 = 
	`cú_šdexbuf_ü—‹
();

135 cÚ¡ *
v”s
 = 
NULL
;

136 
size_t
 
v”s_size
 = 0;

137 
n
;

138 
cú_šdexbuf
 *
nix
 = 
	`cú_šdexbuf_ü—‹
();

139 
lowtime
[7] = {
CCN_MARKER_VERSION
, 0, 
FF
, FF, FF, FF, FF};

141 ià((
v”siÚšg_æags
 & ~
CCN_V_NESTOK
 & ~
CCN_V_EST
è!ğ
CCN_V_HIGH
) {

142 
	`cú_£‹¼Ü
(
h
, 
EINVAL
);

143 
	`cú_³¼Ü
(
h
, "ccn_resolve_version is only implemented for versioning_flags = CCN_V_HIGH(EST)");

144 
Fšish
;

146 
n
 = 
	`cú_Çme_¥l™
(
Çme
, 
nix
);

147 ià(
n
 < 0)

148 
Fšish
;

149 ià((
v”siÚšg_æags
 & 
CCN_V_NESTOK
) == 0) {

150 
»s
 = 
	`cú_Çme_comp_g‘
(
Çme
->
buf
, 
nix
, 
n
 - 1, &
v”s
, &
v”s_size
);

151 ià(
»s
 >ğ0 && 
v”s_size
 =ğ7 && 
v”s
[0] =ğ
CCN_MARKER_VERSION
) {

152 
my»s
 = 0;

153 
Fšish
;

156 
‹m¶
 = 
	`»sŞve_‹m¶
Ñem¶, 
lowtime
, (lowtime));

157 
	`cú_ch¬buf_­³nd
(
´efix
, 
Çme
->
buf
,‚ame->
Ëngth
);

158 
cobj
->
Ëngth
 = 0;

159 
»s
 = 
	`cú_g‘
(
h
, 
´efix
, 
‹m¶
, 
timeout_ms
, 
cobj
, 
pco
, 
ndx
, 0);

160 
cobj
->
Ëngth
 != 0) {

161 ià(
pco
->
ty³
 =ğ
CCN_CONTENT_NACK
)

163 
»s
 = 
	`cú_Çme_comp_g‘
(
cobj
->
buf
, 
ndx
, 
n
, &
v”s
, &
v”s_size
);

164 ià(
»s
 < 0)

166 ià(
v”s_size
 =ğ7 && 
v”s
[0] =ğ
CCN_MARKER_VERSION
) {

168 
Çme
->
Ëngth
 = 0;

169 
	`cú_ch¬buf_­³nd
(
Çme
, 
´efix
->
buf
,…»fix->
Ëngth
);

170 
	`cú_Çme_­³nd
(
Çme
, 
v”s
, 
v”s_size
);

171 
my»s
 = 0;

172 ià((
v”siÚšg_æags
 & 
CCN_V_EST
) == 0)

174 
‹m¶
 = 
	`»sŞve_‹m¶
Ñem¶, 
v”s
, 
v”s_size
);

175 ià(
‹m¶
 =ğ
NULL
) ;

176 
cobj
->
Ëngth
 = 0;

177 
»s
 = 
	`cú_g‘
(
h
, 
´efix
, 
‹m¶
, 
timeout_ms
, 
cobj
, 
pco
, 
ndx
,

178 
CCN_GET_NOKEYWAIT
);

182 
Fšish
:

183 
	`cú_ch¬buf_de¡roy
(&
´efix
);

184 
	`cú_ch¬buf_de¡roy
(&
cobj
);

185 
	`cú_šdexbuf_de¡roy
(&
ndx
);

186 
	`cú_šdexbuf_de¡roy
(&
nix
);

187 
	`cú_ch¬buf_de¡roy
(&
‹m¶
);

188 (
my»s
);

189 
	}
}

215 
	$cú_ü—‹_v”siÚ
(
cú
 *
h
, 
cú_ch¬buf
 *
Çme
,

216 
v”siÚšg_æags
, 
štmax_t
 
£cs
, 
n£cs
)

218 
size_t
 
i
;

219 
size_t
 
j
;

220 
size_t
 
lc
 = 0;

221 
size_t
 
oc
 = 0;

222 
n
;

223 
cú_šdexbuf
 *
nix
 = 
NULL
;

224 
my»s
 = -1;

225 
®»ady_v”siÚed
 = 0;

226 
ok_æags
 = (
CCN_V_REPLACE
 | 
CCN_V_HIGH
 | 
CCN_V_NOW
 | 
CCN_V_NESTOK
);

229 
nix
 = 
	`cú_šdexbuf_ü—‹
();

230 
n
 = 
	`cú_Çme_¥l™
(
Çme
, 
nix
);

231 ià(
n
 < 0)

232 
Fšish
;

233 ià((
v”siÚšg_æags
 & ~
ok_æags
) != 0)

234 
Fšish
;

236 ià(
n
 >= 1) {

237 
oc
 = 
nix
->
buf
[
n
-1];

238 
lc
 = 
nix
->
buf
[
n
] - 
oc
;

239 ià(
lc
 <ğ11 &&†ø>ğ6 && 
Çme
->
buf
[
oc
 + 2] =ğ
CCN_MARKER_VERSION
)

240 
®»ady_v”siÚed
 = 1;

242 
my»s
 = 0;

243 ià(
®»ady_v”siÚed
 &&

244 (
v”siÚšg_æags
 & (
CCN_V_REPLACE
 | 
CCN_V_NESTOK
)) == 0)

245 
Fšish
;

246 
Çme
->
Ëngth
 -= 1;

247 
i
 = 
Çme
->
Ëngth
;

248 
my»s
 |ğ
	`cú_ch¬buf_­³nd_‰
(
Çme
, 
CCN_DTAG_CompÚ’t
, 
CCN_DTAG
);

249 ià((
v”siÚšg_æags
 & 
CCN_V_NOW
) != 0)

250 
my»s
 |ğ
	`cúb_­³nd_now_blob
(
Çme
, 
CCN_MARKER_VERSION
);

252 
my»s
 |ğ
	`cúb_­³nd_time¡amp_blob
(
Çme
, 
CCN_MARKER_VERSION
, 
£cs
, 
n£cs
);

254 
my»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
Çme
);

255 ià(
my»s
 < 0) {

256 
Çme
->
Ëngth
 = 
i
;

257 
Clo£Name
;

259 
j
 = 
Çme
->
Ëngth
;

260 ià(
®»ady_v”siÚed
 && (
v”siÚšg_æags
 & 
CCN_V_REPLACE
) != 0) {

261 
oc
 = 
nix
->
buf
[
n
-1];

262 
lc
 = 
nix
->
buf
[
n
] - 
oc
;

263 ià((
v”siÚšg_æags
 & 
CCN_V_HIGH
) != 0 &&

264 
	`memcmp
(
Çme
->
buf
 + 
oc
,‚ame->buà+ 
i
, 
j
 - i) > 0) {

266 
Çme
->
Ëngth
 = 
i
;

268 
my»s
 = -1;

269 
Clo£Name
;

271 
	`memmove
(
Çme
->
buf
 + 
oc
,‚ame->buà+ 
i
, 
j
 - i);

272 
Çme
->
Ëngth
 -ğ
lc
;

274 
Clo£Name
:

275 
my»s
 |ğ
	`cú_ch¬buf_­³nd_şo£r
(
Çme
);

276 
Fšish
:

277 
my»s
 = (myres < 0) ? -1 : 0;

278 
	`cú_šdexbuf_de¡roy
(&
nix
);

279 (
my»s
);

280 
	}
}

	@lib/encodedecodetest.c

21 
	~<fú.h
>

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<uni¡d.h
>

25 
	~<¡ršg.h
>

26 
	~<sys/ty³s.h
>

27 
	~<sys/¡©.h
>

29 
	~<cú/cú.h
>

30 
	~<cú/bloom.h
>

31 
	~<cú/uri.h
>

32 
	~<cú/dige¡.h
>

33 
	~<cú/key¡Üe.h
>

34 
	~<cú/signšg.h
>

35 
	~<cú/¿ndom.h
>

37 
	s·th
 {

38 
	mcouÁ
;

39 * 
	mcomps
[];

41 
·th
 * 
	$·th_ü—‹
(* 
¡½©h
) {

42 * 
p
 = 
¡½©h
;

43 
¦ash_couÁ
 = 0;

44 
i
 = 0;

45 
·th
 *…ath;

47 ià(
	`¡¾’
(
¡½©h
) < 1) {

48  
NULL
;

50 *
p
 != '\0') {

51 ià(*
p
++ =ğ'/'è
¦ash_couÁ
++;

53 
·th
 = 
	`m®loc
((è+ (*)*(
¦ash_couÁ
+1));

54 
·th
->
comps
[0] = 
	`¡¹ok
(
	`¡rdup
(
¡½©h
), "/");

55 
·th
->
couÁ
 = 0;

56 
·th
->
comps
[
i
++]) {

57 
·th
->
comps
[
i
] = 
	`¡¹ok
(
NULL
, "/");

58 
·th
->
couÁ
++;

60  
·th
;

61 
	}
}

62 
	$·th_de¡roy
(
·th
 **path) {

63 
	`ä“
(*
·th
);

64 *
·th
 = 
NULL
;

65 
	}
}

68 
	$’code_mes§ge
(
cú_ch¬buf
 *
mes§ge
, 
·th
 * 
Çme_·th
, *
d©a
, 
size_t
 
Ën
, cú_ch¬buà*
sigÃd_šfo
, cÚ¡ *
pkey
) {

69 
cú_ch¬buf
 *
·th
 = 
	`cú_ch¬buf_ü—‹
();

70 
i
;

71 
»s
;

73 ià(
·th
 =ğ
NULL
 || 
	`cú_Çme_š™
(path) == -1) {

74 
	`årštf
(
¡d”r
, "Failedo‡llocate or initialize content…ath\n");

78 
i
 = 0; i < 
Çme_·th
->
couÁ
; i++) {

79 
	`cú_Çme_­³nd_¡r
(
·th
, 
Çme_·th
->
comps
[
i
]);

82 
»s
 = 
	`cú_’code_CÚ‹ÁObjeù
(
mes§ge
, 
·th
, 
sigÃd_šfo
, 
d©a
, 
Ën
, 
NULL
, 
pkey
);

84 ià(
»s
 != 0) {

85 
	`årštf
(
¡d”r
, "Failedoƒncode ContentObject\n");

88 
	`cú_ch¬buf_de¡roy
(&
·th
);

89  (
»s
);

90 
	}
}

93 
	$decode_mes§ge
(
cú_ch¬buf
 *
mes§ge
, 
·th
 * 
Çme_·th
, *
d©a
, 
size_t
 
Ën
, cÚ¡ *
v”key
) {

94 
cú_·r£d_CÚ‹ÁObjeù
 
cÚ‹Á
;

95 
cú_šdexbuf
 *
comps
 = 
	`cú_šdexbuf_ü—‹
();

96 cÚ¡ * 
cÚ‹Á_v®ue
;

97 
size_t
 
cÚ‹Á_Ëngth
;

99 
»s
 = 0;

100 
i
;

102 
	`mem£t
(&
cÚ‹Á
, 0x33, (content));

104 ià(
	`cú_·r£_CÚ‹ÁObjeù
(
mes§ge
->
buf
, mes§ge->
Ëngth
, &
cÚ‹Á
, 
comps
) != 0) {

105 
	`´štf
("Decode failedo…arse object\n");

106 
»s
 = -1;

109 ià(
comps
->
n
-1 !ğ
Çme_·th
->
couÁ
) {

110 
	`´štf
("Decode got wrong‚umber of…ath components: %d vs. %d\n",

111 ()(
comps
->
n
-1), 
Çme_·th
->
couÁ
);

112 
»s
 = -1;

114 
i
=0; i<
Çme_·th
->
couÁ
; i++) {

115 ià(
	`cú_Çme_comp_¡rcmp
(
mes§ge
->
buf
, 
comps
, 
i
, 
Çme_·th
->comps[i]) != 0) {

116 
	`´štf
("Decodmism©ch oÀ·th compÚ’ˆ%d\n", 
i
);

117 
»s
 = -1;

120 ià(
	`cú_cÚ‹Á_g‘_v®ue
(
mes§ge
->
buf
, mes§ge->
Ëngth
, &
cÚ‹Á
,

121 &
cÚ‹Á_v®ue
, &
cÚ‹Á_Ëngth
) != 0) {

122 
	`´štf
("Cannot„etrieve content value\n");

123 
»s
 = -1;

124 } ià(
cÚ‹Á_Ëngth
 !ğ
Ën
) {

125 
	`´štf
("Decode mismatch on content†ength %d vs. %d\n",

126 ()
cÚ‹Á_Ëngth
, ()
Ën
);

127 
»s
 = -1;

128 } ià(
	`memcmp
(
cÚ‹Á_v®ue
, 
d©a
, 
Ën
) != 0) {

129 
	`´štf
("Decode mismatch of content\n");

130 
»s
 = -1;

133 ià(
	`cú_v”ify_sigÇtu»
(
mes§ge
->
buf
, mes§ge->
Ëngth
, &
cÚ‹Á
, 
v”key
) != 1) {

134 
	`´štf
("Signature did‚ot verify\n");

135 
»s
 = -1;

138 
	`cú_šdexbuf_de¡roy
(&
comps
);

139  
»s
;

141 
	}
}

144 
	$ex³ùed_»s
(
»s
, 
code
)

146 ià(
code
 == '*')

148 ià(
code
 == '-')

149 (
»s
 < 0);

150 ià(
code
 == '+')

151 (
»s
 > 0);

152 ià('0' <ğ
code
 && code <= '9')

153 (
»s
 =ğ(
code
 - '0'));

154 
	`abÜt
();

156 
	}
}

158 
	g®l_ch¬s_³rûÁ_’coded
[256 * 3 + 1];

160 
	$š™_®l_ch¬s_³rûÁ_’coded
() {

161 
cú_ch¬buf
 *
c
;

162 
i
;

163 
c
 = 
	`cú_ch¬buf_ü—‹
();

164 
i
 = 0; i < 256; i+=2) {

165 
	`cú_ch¬buf_putf
(
c
, "%%%02x%%%02X", 
i
, i+1);

167 ià(
c
->
Ëngth
 >ğ(
®l_ch¬s_³rûÁ_’coded
))

168 
c
->
Ëngth
 = (
®l_ch¬s_³rûÁ_’coded
) - 1;

169 
	`memıy
(
®l_ch¬s_³rûÁ_’coded
, 
c
->
buf
, c->
Ëngth
);

170 
	`cú_ch¬buf_de¡roy
(&
c
);

171 
	}
}

173 cÚ¡ *
	g®l_ch¬s_³rûÁ_’coded_ÿnÚ
 =

191 
	$maš
 (
¬gc
, *
¬gv
[]) {

192 
cú_ch¬buf
 *
bufãr
 = 
	`cú_ch¬buf_ü—‹
();

193 
cú_ch¬buf
 *
sigÃd_šfo
 = 
	`cú_ch¬buf_ü—‹
();

194 
cú_sk–‘Ú_decod”
 
dd
 = {0};

195 
ssize_t
 
»s
;

196 *
ouŠame
 = 
NULL
;

197 
fd
;

198 
»suÉ
 = 0;

199 * 
cÚ‹Ás
[] = {"INVITE sip:foo@parc.com SIP/2.0\nVia: SIP/2.0/UDP 127.0.0.1:5060;rport;branch=z9hG4bK519044721\nFrom: <sip:jthornto@13.2.117.52>;tag=2105643453\nTo: Test User <sip:foo@parc.com>\nCall-ID: 119424355@127.0.0.1\nCSeq: 20 INVITE\nContact: <sip:jthornto@127.0.0.1:5060>\nMax-Forwards: 70\nUser-Agent: Linphone-1.7.1/eXosip\nSubject: Phone call\nExpires: 120\nAllow: INVITE, ACK, CANCEL, BYE, OPTIONS, REFER, SUBSCRIBE, NOTIFY, MESSAGE\nContent-Type:‡pplication/sdp\nContent-Length: 448\n\nv=0\no=jthornto 123456 654321 IN IP4 127.0.0.1\ns=A conversation\nc=IN IP4 127.0.0.1\nt=0 0\nm=audio 7078 RTP/AVP 111 110 0 3 8 101\na=rtpmap:111 speex/16000/1\na=rtpmap:110 speex/8000/1\na=rtpmap:0 PCMU/8000/1\na=rtpmap:3 GSM/8000/1\na=rtpmap:8 PCMA/8000/1\na=rtpmap:101elephone-event/8000\na=fmtp:101 0-11\nm=video 9078 RTP/AVP 97 98 99\na=rtpmap:97heora/90000\na=rtpmap:98 H263-1998/90000\na=fmtp:98 CIF=1;QCIF=1\na=rtpmap:99 MP4V-ES/90000\n",

203 
NULL
};

204 * 
·ths
[] = { "/sip/protocol/parc.com/domain/foo/principal/invite/verb/119424355@127.0.0.1/id",

207 
NULL
};

208 
·th
 * 
cur_·th
 = 
NULL
;

209 
cú_key¡Üe
 *
key¡Üe
 = 
	`cú_key¡Üe_ü—‹
();

210 *
home
 = 
	`g‘’v
("HOME");

211 *
key¡Üe_suffix
 = "/.ccnx/.ccnx_keystore";

212 *
key¡Üe_Çme
 = 
NULL
;

214 
i
;

216 ià(
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[1], "-o") == 0) {

217 
ouŠame
 = 
¬gv
[2];

219 
	`´štf
("U§ge: % -Ø<outf’ame>\n", 
¬gv
[0]);

220 
	`ex™
(1);

223 ià(
home
 =ğ
NULL
) {

224 
	`´štf
("Unableo determine home directory for keystore\n");

225 
	`ex™
(1);

227 
key¡Üe_Çme
 = 
	`ÿÎoc
(1, 
	`¡¾’
(
home
è+ sŒËn(
key¡Üe_suffix
) + 1);

229 
	`¡rÿt
(
key¡Üe_Çme
, 
home
);

230 
	`¡rÿt
(
key¡Üe_Çme
, 
key¡Üe_suffix
);

232 ià(0 !ğ
	`cú_key¡Üe_š™
(
key¡Üe
, 
key¡Üe_Çme
, "Th1s1sn0t8g00dp8ssw0rd.")) {

233 
	`´štf
("Failedo initialize keystore\n");

234 
	`ex™
(1);

237 
	`´štf
("Creating signed_info\n");

238 
»s
 = 
	`cú_sigÃd_šfo_ü—‹
(
sigÃd_šfo
,

239  
	`cú_key¡Üe_public_key_dige¡
(
key¡Üe
),

240  
	`cú_key¡Üe_public_key_dige¡_Ëngth
(
key¡Üe
),

241  
NULL
,

242  
CCN_CONTENT_GONE
,

244  
NULL
,

245  
NULL
);

246 ià(
»s
 < 0) {

247 
	`´štf
("Failedo create signed_info!\n");

250 
»s
 = 
	`cú_sk–‘Ú_decode
(&
dd
, 
sigÃd_šfo
->
buf
, sigÃd_šfo->
Ëngth
);

251 ià(!(
»s
 =ğ
sigÃd_šfo
->
Ëngth
 && 
dd
.
¡©e
 == 0)) {

252 
	`´štf
("FaedØdecodsigÃd_šfo! ResuÉ %d S‹ %d\n", ()
»s
, 
dd
.
¡©e
);

253 
»suÉ
 = 1;

255 
	`mem£t
(&
dd
, 0, (dd));

256 
	`´štf
("Done with signed_info\n");

258 
	`´štf
("Encodšg sam¶mes§gd©¨Ëngth %d\n", ()
	`¡¾’
(
cÚ‹Ás
[0]));

259 
cur_·th
 = 
	`·th_ü—‹
(
·ths
[0]);

260 ià(
	`’code_mes§ge
(
bufãr
, 
cur_·th
, 
cÚ‹Ás
[0], 
	`¡¾’
(cÚ‹Ás[0]), 
sigÃd_šfo
, 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
))) {

261 
	`´štf
("Failedoƒncode message!\n");

263 
	`´štf
("Encoded sam¶mes§gËngth i %d\n", ()
bufãr
->
Ëngth
);

265 
»s
 = 
	`cú_sk–‘Ú_decode
(&
dd
, 
bufãr
->
buf
, bufãr->
Ëngth
);

266 ià(!(
»s
 =ğ
bufãr
->
Ëngth
 && 
dd
.
¡©e
 == 0)) {

267 
	`´štf
("FaedØdecode! ResuÉ %d S‹ %d\n", ()
»s
, 
dd
.
¡©e
);

268 
»suÉ
 = 1;

270 ià(
ouŠame
 !ğ
NULL
) {

271 
fd
 = 
	`İ’
(
ouŠame
, 
O_WRONLY
|
O_CREAT
|
O_TRUNC
, 
S_IRWXU
);

272 ià(
fd
 == -1)

273 
	`³¼Ü
(
ouŠame
);

274 ()
	`wr™e
(
fd
, 
bufãr
->
buf
, bufãr->
Ëngth
);

275 
	`şo£
(
fd
);

277 ià(
	`decode_mes§ge
(
bufãr
, 
cur_·th
, 
cÚ‹Ás
[0], 
	`¡¾’
(cÚ‹Ás[0]), 
	`cú_key¡Üe_public_key
(
key¡Üe
)) != 0) {

278 
»suÉ
 = 1;

280 
	`´štf
("Expect signature verification failure: ");

281 ià(
bufãr
->
Ëngth
 >= 20)

282 
bufãr
->
buf
[bufãr->
Ëngth
 - 20] += 1;

283 ià(
	`decode_mes§ge
(
bufãr
, 
cur_·th
, 
cÚ‹Ás
[0], 
	`¡¾’
(cÚ‹Ás[0]), 
	`cú_key¡Üe_public_key
(
key¡Üe
)) == 0) {

284 
»suÉ
 = 1;

287 
	`·th_de¡roy
(&
cur_·th
);

288 
	`cú_ch¬buf_de¡roy
(&
bufãr
);

289 
	`´štf
("Done with sample message\n");

293 
i
 = 0; 
·ths
[i] !ğ
NULL
 && 
cÚ‹Ás
[i] != NULL; i++) {

294 
	`´štf
("Un™e¡ ca£ %d\n", 
i
);

295 
cur_·th
 = 
	`·th_ü—‹
(
·ths
[
i
]);

296 
bufãr
 = 
	`cú_ch¬buf_ü—‹
();

297 ià(
	`’code_mes§ge
(
bufãr
, 
cur_·th
, 
cÚ‹Ás
[
i
], 
	`¡¾’
(cÚ‹Ás[i]), 
sigÃd_šfo
, 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
))) {

298 
	`´štf
("Failedƒncode\n");

299 
»suÉ
 = 1;

300 } ià(
	`decode_mes§ge
(
bufãr
, 
cur_·th
, 
cÚ‹Ás
[
i
], 
	`¡¾’
(cÚ‹Ás[i]), 
	`cú_key¡Üe_public_key
(
key¡Üe
))) {

301 
	`´štf
("Failed decode\n");

302 
»suÉ
 = 1;

304 
	`·th_de¡roy
(&
cur_·th
);

305 
	`cú_ch¬buf_de¡roy
(&
bufãr
);

310 
	`š™_®l_ch¬s_³rûÁ_’coded
();

311 cÚ¡ *
uri_‹¡s
[] = {

317 ".+1", 
®l_ch¬s_³rûÁ_’coded
, "", 
®l_ch¬s_³rûÁ_’coded_ÿnÚ
,

318 "_+1", 
®l_ch¬s_³rûÁ_’coded_ÿnÚ
, "",‡ll_chars_percent_encoded_canon,

324 
NULL
, NULL, NULL, NULL

326 cÚ¡ **
u
;

327 
cú_ch¬buf
 *
uri_out
 = 
	`cú_ch¬buf_ü—‹
();

328 
bufãr
 = 
	`cú_ch¬buf_ü—‹
();

329 
u
 = 
uri_‹¡s
; *u !ğ
NULL
; u +ğ4, 
i
++) {

330 
	`´štf
("Un™e¡ ca£ %d\n", 
i
);

331 ià(
u
[0][0] != '.')

332 
bufãr
->
Ëngth
 = 0;

333 
»s
 = 
	`cú_Çme_äom_uri
(
bufãr
, 
u
[1]);

334 ià(!
	`ex³ùed_»s
(
»s
, 
u
[0][1])) {

335 
	`´štf
("Faed: cú_Çme_äom_ur˜wrÚg„e %d\n", ()
»s
);

336 
»suÉ
 = 1;

338 ià(
»s
 >= 0) {

339 ià(
»s
 > 
	`¡¾’
(
u
[1])) {

340 
	`´štf
("Faed: cú_Çme_äom_ur˜lÚg„e %d\n", ()
»s
);

341 
»suÉ
 = 1;

343 ià(0 !ğ
	`¡rcmp
(
u
[1] + 
»s
, u[2])) {

344 
	`´štf
("Faed: cú_Çme_äom_ur˜ex³ùšg†eáov” '%s', gÙ '%s'\n", 
u
[2], u[1] + 
»s
);

345 
»suÉ
 = 1;

347 
uri_out
->
Ëngth
 = 0;

348 
»s
 = 
	`cú_uri_­³nd
(
uri_out
, 
bufãr
->
buf
, bufãr->
Ëngth
, 1);

349 ià(!
	`ex³ùed_»s
(
»s
, 
u
[0][2])) {

350 
	`´štf
("Faed: cú_uri_­³nd wrÚg„e %d\n", ()
»s
);

351 
»suÉ
 = 1;

353 ià(
»s
 >= 0) {

354 ià(
uri_out
->
Ëngth
 !ğ
	`¡¾’
(
u
[3])) {

355 
	`´štf
("Failed: ccn_uri_append…roduced wrong‚umber of characters\n");

356 
»suÉ
 = 1;

358 
	`cú_ch¬buf_»£rve
(
uri_out
, 1)[0] = 0;

359 ià(0 !ğ
	`¡rcmp
((cÚ¡ *)
uri_out
->
buf
, 
u
[3])) {

360 
	`´štf
("Failed: ccn_uri_append…roduced wrong output\n");

361 
	`´štf
("Ex³ùed: %s\n", 
u
[3]);

362 
	`´štf
(" Aùu®: %s\n", (cÚ¡ *)
uri_out
->
buf
);

363 
»suÉ
 = 1;

368 
	`cú_ch¬buf_de¡roy
(&
bufãr
);

369 
	`cú_ch¬buf_de¡roy
(&
uri_out
);

370 
	`´štf
("Name markerests\n");

372 cÚ¡ *
ex³ùed_uri
 = "ccnx:/example.com/.../%01/%FE/%01%02%03%04%05%06%07%08/%FD%10%10%10%10%1F%FF/%00%81";

373 cÚ¡ *
ex³ùed_chİ³d_uri
 = "ccnx:/example.com/.../%01/%FE";

374 cÚ¡ *
ex³ùed_bum³d_uri
 = "ccnx:/example.com/.../%01/%FF";

375 cÚ¡ *
ex³ùed_bum³d2_uri
 = "ccnx:/example.com/.../%01/%00%00";

377 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

378 
bufãr
 = 
	`cú_ch¬buf_ü—‹
();

379 
uri_out
 = 
	`cú_ch¬buf_ü—‹
();

380 
»s
 = 
	`cú_Çme_š™
(
bufãr
);

381 
»s
 |ğ
	`cú_Çme_­³nd_¡r
(
bufãr
, "example.com");

382 
»s
 |ğ
	`cú_Çme_­³nd_num”ic
(
bufãr
, 
CCN_MARKER_NONE
, 0);

383 
»s
 |ğ
	`cú_Çme_­³nd_num”ic
(
bufãr
, 
CCN_MARKER_NONE
, 1);

384 
»s
 |ğ
	`cú_Çme_­³nd_num”ic
(
bufãr
, 0xFE, 0);

385 
»s
 |ğ
	`cú_Çme_­³nd_num”ic
(
bufãr
, 
CCN_MARKER_NONE
, 0x0102030405060708ULL);

386 
»s
 |ğ
	`cú_Çme_­³nd_num”ic
(
bufãr
, 
CCN_MARKER_VERSION
, 0x101010101FFFULL);

387 
»s
 |ğ
	`cú_Çme_­³nd_num”ic
(
bufãr
, 
CCN_MARKER_SEQNUM
, 129);

388 
»s
 |ğ
	`cú_uri_­³nd
(
uri_out
, 
bufãr
->
buf
, bufãr->
Ëngth
, 1);

389 ià(
»s
 < 0) {

390 
	`´štf
("Failed:‚ame markerests had‚egative„es\n");

391 
»suÉ
 = 1;

393 ià(0 !ğ
	`¡rcmp
(
	`cú_ch¬buf_as_¡ršg
(
uri_out
), 
ex³ùed_uri
)) {

394 
	`´štf
("Failed:‚ame markerests…roduced wrong output\n");

395 
	`´štf
("Ex³ùed: %s\n", 
ex³ùed_uri
);

396 
	`´štf
(" Aùu®: %s\n", (cÚ¡ *)
uri_out
->
buf
);

397 
»suÉ
 = 1;

399 
»s
 = 
	`cú_Çme_chİ
(
bufãr
, 
NULL
, 100);

400 ià(
»s
 != -1) {

401 
	`´štf
("Failed: ccn_name_chop did‚ot…roduceƒrror \n");

402 
»suÉ
 = 1;

404 
»s
 = 
	`cú_Çme_chİ
(
bufãr
, 
NULL
, 4);

405 ià(
»s
 != 4) {

406 
	`´štf
("Failed: ccn_name_chop got wrong†ength\n");

407 
»suÉ
 = 1;

409 
uri_out
->
Ëngth
 = 0;

410 
	`cú_uri_­³nd
(
uri_out
, 
bufãr
->
buf
, bufãr->
Ëngth
, 1);

411 ià(0 !ğ
	`¡rcmp
(
	`cú_ch¬buf_as_¡ršg
(
uri_out
), 
ex³ùed_chİ³d_uri
)) {

412 
	`´štf
("Failed: ccn_name_chop botch\n");

413 
	`´štf
("Ex³ùed: %s\n", 
ex³ùed_chİ³d_uri
);

414 
	`´štf
(" Aùu®: %s\n", (cÚ¡ *)
uri_out
->
buf
);

415 
»suÉ
 = 1;

417 
»s
 = 
	`cú_Çme_Ãxt_siblšg
(
bufãr
);

418 ià(
»s
 != 4) {

419 
	`´štf
("Failed: ccn_name_next_sibling got wrong†ength\n");

420 
»suÉ
 = 1;

422 
uri_out
->
Ëngth
 = 0;

423 
	`cú_uri_­³nd
(
uri_out
, 
bufãr
->
buf
, bufãr->
Ëngth
, 1);

424 ià(0 !ğ
	`¡rcmp
(
	`cú_ch¬buf_as_¡ršg
(
uri_out
), 
ex³ùed_bum³d_uri
)) {

425 
	`´štf
("Failed: ccn_name_next_sibling botch\n");

426 
	`´štf
("Ex³ùed: %s\n", 
ex³ùed_bum³d_uri
);

427 
	`´štf
(" Aùu®: %s\n", (cÚ¡ *)
uri_out
->
buf
);

428 
»suÉ
 = 1;

430 
	`cú_Çme_Ãxt_siblšg
(
bufãr
);

431 
uri_out
->
Ëngth
 = 0;

432 
	`cú_uri_­³nd
(
uri_out
, 
bufãr
->
buf
, bufãr->
Ëngth
, 1);

433 ià(0 !ğ
	`¡rcmp
(
	`cú_ch¬buf_as_¡ršg
(
uri_out
), 
ex³ùed_bum³d2_uri
)) {

434 
	`´štf
("Failed: ccn_name_next_sibling botch\n");

435 
	`´štf
("Ex³ùed: %s\n", 
ex³ùed_bum³d2_uri
);

436 
	`´štf
(" Aùu®: %s\n", (cÚ¡ *)
uri_out
->
buf
);

437 
»suÉ
 = 1;

439 
	`cú_ch¬buf_de¡roy
(&
bufãr
);

440 
	`cú_ch¬buf_de¡roy
(&
uri_out
);

442 
	`´štf
("Message digestests\n");

444 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

445 
cú_dige¡
 *
dg
 = 
	`cú_dige¡_ü—‹
(
CCN_DIGEST_SHA256
);

446 ià(
dg
 =ğ
NULL
) {

447 
	`´štf
("Failed: ccn_digest_create„eturned NULL\n");

448 
»suÉ
 = 1;

451 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

452 cÚ¡ 
ex³ùed_dige¡
[] = {

455 
aùu®_dige¡
[(
ex³ùed_dige¡
)] = {0};

456 cÚ¡ *
d©a
 = "Content-centric";

457 ià(
	`cú_dige¡_size
(
dg
è!ğ(
ex³ùed_dige¡
)) {

458 
	`´štf
("Failed: wrong digest size\n");

459 
»suÉ
 = 1;

462 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

463 
	`cú_dige¡_š™
(
dg
);

464 
»s
 = 
	`cú_dige¡_upd©e
(
dg
, 
d©a
, 
	`¡¾’
(data));

465 ià(
»s
 != 0)

466 
	`´štf
("W¬nšg: check„e %d\n", ()
»s
);

467 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

468 
»s
 = 
	`cú_dige¡_fš®
(
dg
, 
aùu®_dige¡
, (
ex³ùed_dige¡
));

469 ià(
»s
 != 0)

470 
	`´štf
("W¬nšg: check„e %d\n", ()
»s
);

471 ià(0 !ğ
	`memcmp
(
aùu®_dige¡
, 
ex³ùed_dige¡
, (expected_digest))) {

472 
	`´štf
("Failed: wrong digest\n");

473 
»suÉ
 = 1;

477 
	`´štf
("Really basic PRNGest\n");

479 
r1
[42];

480 
r2
[42];

481 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

482 
	`cú_add_’Œİy
(&
i
, (i), 0);

483 
	`cú_¿ndom_by‹s
(
r1
, (r1));

484 
	`memıy
(
r2
, 
r1
, (r2));

485 
	`cú_¿ndom_by‹s
(
r2
, (r2));

486 ià(0 =ğ
	`memcmp
(
r1
, 
r2
, (r2))) {

487 
	`´štf
("Failed: badly broken PRNG\n");

488 
»suÉ
 = 1;

492 
	`´štf
("Bloom filterests\n");

494 
£ed1
[4] = "1492";

495 cÚ¡ *
a
[13] = {

501 
cú_bloom
 *
b1
 = 
NULL
;

502 
cú_bloom
 *
b2
 = 
NULL
;

503 
j
, 
k
, 
t1
, 
t2
;

504 
us
;

506 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

507 
b1
 = 
	`cú_bloom_ü—‹
(13, 
£ed1
);

509 
j
 = 0; j < 13; j++)

510 ià(
	`cú_bloom_m©ch
(
b1
, 
a
[
j
], 
	`¡¾’
(a[j]))) ;

511 ià(
j
 < 13) {

512 
	`´štf
("Faed: \"%s\" m©chedƒm±y Bloom f‹r\n", 
a
[
j
]);

513 
»suÉ
 = 1;

516 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

517 
j
 = 0; j < 13; j++)

518 
	`cú_bloom_š£¹
(
b1
, 
a
[
j
], 
	`¡¾’
(a[j]));

519 
j
 = 0; j < 13; j++)

520 ià(!
	`cú_bloom_m©ch
(
b1
, 
a
[
j
], 
	`¡¾’
(a[j]))) ;

521 ià(
j
 < 13) {

522 
	`´štf
("Faed: \"%s\"‚Ù found wh’ iˆshould havb“n\n", 
a
[
j
]);

523 
»suÉ
 = 1;

526 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

527 
j
 = 0, 
k
 = 0; j < 13; j++)

528 ià(
	`cú_bloom_m©ch
(
b1
, 
a
[
j
]+1, 
	`¡¾’
(a[j]+1)))

529 
k
++;

530 ià(
k
 > 0) {

531 
	`´štf
("Mmm, found %d f®£…os™ives\n", 
k
);

532 ià(
k
 > 2) {

533 
»suÉ
 = 1;

537 
£ed2
[5] = "aqfb\0";

538 ; 
£ed2
[3] <= 'f'; seed2[3]++) {

539 
	`´štf
("Un™e¡ ca£ %d (%4sè ", 
i
++, 
£ed2
);

540 
b2
 = 
	`cú_bloom_ü—‹
(13, 
£ed2
);

541 
j
 = 0; j < 13; j++)

542 
	`cú_bloom_š£¹
(
b2
, 
a
[
j
], 
	`¡¾’
(a[j]));

543 
j
 = 0, 
k
 = 0, 
us
 = ~0; us > 0; us--) {

544 
t1
 = 
	`cú_bloom_m©ch
(
b1
, &
us
, (us));

545 
t2
 = 
	`cú_bloom_m©ch
(
b2
, &
us
, (us));

546 
j
 +ğ(
t1
 | 
t2
);

547 
k
 +ğ(
t1
 & 
t2
);

549 
	`´štf
("e™h”=%d bÙh=%d wœesize=%d\n", 
j
, 
k
, 
	`cú_bloom_wœesize
(
b1
));

550 ià(
k
 > 12) {

551 
	`´štf
("Failed: Bloom seeding may‚ot beƒffective\n");

552 
»suÉ
 = 1;

554 
	`cú_bloom_de¡roy
(&
b2
);

556 
	`cú_bloom_de¡roy
(&
b1
);

558 
	`´štf
("ccn_sign_content()ests\n");

560 
cú
 *
h
 = 
	`cú_ü—‹
();

561 
cú_ch¬buf
 *
co
 = 
	`cú_ch¬buf_ü—‹
();

562 
cú_signšg_·¿ms
 
¥¬m
 = 
CCN_SIGNING_PARAMS_INIT
;

563 
cú_·r£d_CÚ‹ÁObjeù
 
pco
 = {0};

564 
cú_ch¬buf
 *
Çme
 = 
	`cú_ch¬buf_ü—‹
();

566 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

567 
	`cú_Çme_äom_uri
(
Çme
, "ccnx:/test/data/%00%42");

568 
»s
 = 
	`cú_sign_cÚ‹Á
(
h
, 
co
, 
Çme
, 
NULL
, "DATA", 4);

569 ià(
»s
 != 0) {

570 
	`´štf
("Faed:„e =ğ%d\n", ()
»s
);

571 
»suÉ
 = 1;

573 
¥¬m
.
‹m¶©e_cúb
 = 
	`cú_ch¬buf_ü—‹
();

574 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
co
->
buf
, co->
Ëngth
, &
pco
, 
NULL
);

575 ià(
»s
 != 0) {

576 
	`´štf
("Faed: cú_·r£_CÚ‹ÁObjeù„e =ğ%d\n", ()
»s
);

577 
»suÉ
 = 1;

580 
	`cú_ch¬buf_­³nd
(
¥¬m
.
‹m¶©e_cúb
,

581 
co
->
buf
 + 
pco
.
off£t
[
CCN_PCO_B_SigÃdInfo
],

582 
pco
.
off£t
[
CCN_PCO_E_SigÃdInfo
] -…co.off£t[
CCN_PCO_B_SigÃdInfo
]);

583 
¥¬m
.
¥_æags
 = 
CCN_SP_TEMPL_TIMESTAMP
;

584 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

585 
»s
 = 
	`cú_sign_cÚ‹Á
(
h
, 
co
, 
Çme
, &
¥¬m
, "DATA", 4);

586 ià(
»s
 != 0) {

587 
	`´štf
("Faed:„e =ğ%d\n", ()
»s
);

588 
»suÉ
 = 1;

590 
	`´štf
("Un™e¡ ca£ %d\n", 
i
++);

591 
¥¬m
.
¥_æags
 = -1;

592 
»s
 = 
	`cú_sign_cÚ‹Á
(
h
, 
co
, 
Çme
, &
¥¬m
, "DATA", 4);

593 ià(
»s
 != -1) {

594 
	`´štf
("Faed:„e =ğ%d\n", ()
»s
);

595 
»suÉ
 = 1;

597 
	`cú_ch¬buf_de¡roy
(&
Çme
);

598 
	`cú_ch¬buf_de¡roy
(&
¥¬m
.
‹m¶©e_cúb
);

599 
	`cú_ch¬buf_de¡roy
(&
co
);

600 
	`cú_de¡roy
(&
h
);

602 
	`ex™
(
»suÉ
);

603 
	}
}

	@lib/hashtb.c

20 
	~<¡ddef.h
>

21 
	~<¡dšt.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

25 
	~<cú/hashtb.h
>

27 
	gnode
;

28 
	snode
 {

29 
node
* 
	mlšk
;

30 
size_t
 
	mhash
;

31 
size_t
 
	mkeysize
;

32 
size_t
 
	mextsize
;

35 
	#DATA
(
ht
, 
p
è((*)(Õè+ 1))

	)

36 
	#KEY
(
ht
, 
p
è((*)(Õè+ 1è+ ht->
™em_size
)

	)

38 
	#CHECKHTE
(
ht
, 
h‹
è((
ušŒ_t
)((h‹)->
´iv
[1]è=ğ~(ušŒ_t)(ht))

	)

39 
	#MARKHTE
(
ht
, 
h‹
è((h‹)->
´iv
[1] = (*)~(
ušŒ_t
)(ht))

	)

41 
	shashtb
 {

42 
node
 **
	mbuck‘
;

43 
size_t
 
	m™em_size
;

44 
	mn_buck‘s
;

45 
	mn
;

46 
	m»fcouÁ
;

47 
node
 *
	mdeã¼ed
;

48 
hashtb_·¿m
 
	m·¿m
;

51 
size_t


52 
	$hashtb_hash
(cÚ¡ *
key
, 
size_t
 
key_size
)

54 
size_t
 
h
;

55 
size_t
 
i
;

56 
h
 = 
key_size
 + 23, 
i
 = 0; i < key_size; i++)

57 
h
 = ((h << 6è^ (h >> 27)è+ 
key
[
i
];

58 (
h
);

59 
	}
}

61 
hashtb
 *

62 
	$hashtb_ü—‹
(
size_t
 
™em_size
, cÚ¡ 
hashtb_·¿m
 *
·¿m
)

64 
hashtb
 *
ht
;

65 
ht
 = 
	`ÿÎoc
(1, (*ht));

66 ià(
ht
 !ğ
NULL
) {

67 
ht
->
™em_size
 = item_size;

68 
ht
->
n
 = 0;

69 
ht
->
n_buck‘s
 = 7;

70 
ht
->
buck‘
 = 
	`ÿÎoc
(ht->
n_buck‘s
, (ht->bucket[0]));

71 ià(
ht
->
buck‘
 =ğ
NULL
) {

72 
	`ä“
(
ht
);

73  (
NULL
);

75 ià(
·¿m
 !ğ
NULL
)

76 
ht
->
·¿m
 = *param;

78 (
ht
);

79 
	}
}

82 
	$hashtb_g‘_·¿m
(
hashtb
 *
ht
, 
hashtb_·¿m
 *
·¿m
)

84 ià(
·¿m
 !ğ
NULL
)

85 *
·¿m
 = 
ht
->param;

86 (
ht
->
·¿m
.
fš®ize_d©a
);

87 
	}
}

90 
	$hashtb_de¡roy
(
hashtb
 **
h
)

92 ià(*
h
 !ğ
NULL
) {

93 
hashtb_’um”©Ü
 
tmp
;

94 
hashtb_’um”©Ü
 *
e
 = 
	`hashtb_¡¬t
(*
h
, &
tmp
);

95 
e
->
key
 !ğ
NULL
)

96 
	`hashtb_d–‘e
(
e
);

97 
	`hashtb_’d
(&
tmp
);

98 ià((*
h
)->
»fcouÁ
 == 0) {

99 
	`ä“
((*
h
)->
buck‘
);

100 
	`ä“
(*
h
);

101 *
h
 = 
NULL
;

104 
	`abÜt
();

106 
	}
}

109 
	$hashtb_n
(
hashtb
 *
ht
)

111 (
ht
->
n
);

112 
	}
}

115 
	$hashtb_lookup
(
hashtb
 *
ht
, cÚ¡ *
key
, 
size_t
 
keysize
)

117 
node
 *
p
;

118 
size_t
 
h
;

119 ià(
key
 =ğ
NULL
)

120 (
NULL
);

121 
h
 = 
	`hashtb_hash
(
key
, 
keysize
);

122 
p
 = 
ht
->
buck‘
[
h
 % ht->
n_buck‘s
];… !ğ
NULL
;… =…->
lšk
) {

123 ià(
p
->
hash
 < 
h
)

125 ià(
p
->
hash
 > 
h
)

127 ià(
keysize
 =ğ
p
->keysiz&& 0 =ğ
	`memcmp
(
key
, 
	`KEY
(
ht
,…), keysize))

128 (
	`DATA
(
ht
, 
p
));

130 (
NULL
);

131 
	}
}

134 
	$£os
(
hashtb_’um”©Ü
 *
h‹
, 
node
 **
µ
)

136 
hashtb
 *
ht
 = 
h‹
->ht;

137 
node
 *
p
 = 
NULL
;

138 
h‹
->
´iv
[0] = 
µ
;

139 ià(
µ
 !ğ
NULL
)

140 
p
 = *
µ
;

141 ià(
p
 =ğ
NULL
) {

142 
h‹
->
key
 = 
NULL
;

143 
h‹
->
keysize
 = 0;

144 
h‹
->
extsize
 = 0;

145 
h‹
->
d©a
 = 
NULL
;

148 
h‹
->
key
 = 
	`KEY
(
ht
, 
p
);

149 
h‹
->
keysize
 = 
p
->keysize;

150 
h‹
->
extsize
 = 
p
->extsize;

151 
h‹
->
d©a
 = 
	`DATA
(
ht
, 
p
);

153 
	}
}

155 
node
 **

156 
	$sÿn_buck‘s
(
hashtb
 *
ht
, 
b
)

158 ; 
b
 < 
ht
->
n_buck‘s
; b++)

159 ià(
ht
->
buck‘
[
b
] !ğ
NULL
)

160  &(
ht
->
buck‘
[
b
]);

161 (
NULL
);

162 
	}
}

164 
	#MAX_ENUMERATORS
 30

	)

165 
hashtb_’um”©Ü
 *

166 
	$hashtb_¡¬t
(
hashtb
 *
ht
, 
hashtb_’um”©Ü
 *
h‹
)

168 
	`MARKHTE
(
ht
, 
h‹
);

169 
h‹
->
d©asize
 = 
ht
->
™em_size
;

170 
h‹
->
ht
 = ht;

171 
ht
->
»fcouÁ
++;

172 ià(
ht
->
»fcouÁ
 > 
MAX_ENUMERATORS
)

173 
	`abÜt
();

174 
	`£os
(
h‹
, 
	`sÿn_buck‘s
(
ht
, 0));

175 (
h‹
);

176 
	}
}

179 
	$hashtb_’d
(
hashtb_’um”©Ü
 *
h‹
)

181 
hashtb
 *
ht
 = 
h‹
->ht;

182 
node
 *
p
;

183 
hashtb_fš®ize_´oc
 
f
;

184 ià(!
	`CHECKHTE
(
ht
, 
h‹
è|| ht->
»fcouÁ
 <ğ0è
	`abÜt
();

185 ià(
ht
->
»fcouÁ
 == 1) {

187 
f
 = 
ht
->
·¿m
.
fš®ize
;

188 
ht
->
deã¼ed
 !ğ
NULL
) {

189 
	`£os
(
h‹
, &(
ht
->
deã¼ed
));

190 ià(
f
 !ğ
NULL
)

191 (*
f
)(
h‹
);

192 
p
 = 
ht
->
deã¼ed
;

193 
ht
->
deã¼ed
 = 
p
->
lšk
;

194 
	`ä“
(
p
);

197 
h‹
->
´iv
[0] = 0;

198 
h‹
->
´iv
[1] = 0;

199 
ht
->
»fcouÁ
--;

200 
	}
}

203 
	$hashtb_Ãxt
(
hashtb_’um”©Ü
 *
h‹
)

205 
node
 **
µ
 = 
h‹
->
´iv
[0];

206 
node
 **
µp
;

207 ià(
µ
 !ğ
NULL
) {

208 
µp
 = 
µ
;

209 
µ
 = &((*µ)->
lšk
);

210 ià(*
µ
 =ğ
NULL
)

211 
µ
 = 
	`sÿn_buck‘s
(
h‹
->
ht
, ((*
µp
)->
hash
 % h‹->ht->
n_buck‘s
) + 1);

213 
	`£os
(
h‹
, 
µ
);

214 
	}
}

217 
	$hashtb_£ek
(
hashtb_’um”©Ü
 *
h‹
, cÚ¡ *
key
, 
size_t
 
keysize
, size_ˆ
extsize
)

219 
node
 *
p
 = 
NULL
;

220 
hashtb
 *
ht
 = 
h‹
->ht;

221 
node
 **
µ
;

222 
size_t
 
h
;

223 ià(
key
 =ğ
NULL
) {

224 
	`£os
(
h‹
, 
NULL
);

227 ià(
ht
->
»fcouÁ
 =ğ1 && ht->
n
 > ht->
n_buck‘s
 * 3) {

228 
ht
->
»fcouÁ
--;

229 
	`hashtb_»hash
(
ht
, 2 * ht->
n
 + 1);

230 
ht
->
»fcouÁ
++;

232 
h
 = 
	`hashtb_hash
(
key
, 
keysize
);

233 
µ
 = &(
ht
->
buck‘
[
h
 % ht->
n_buck‘s
]);

234 
p
 = *
µ
;… !ğ
NULL
;…°ğ&Õ->
lšk
),… =…->link) {

235 ià(
p
->
hash
 < 
h
)

237 ià(
p
->
hash
 > 
h
)

239 ià(
keysize
 =ğ
p
->keysiz&& 0 =ğ
	`memcmp
(
key
, 
	`KEY
(
ht
,…), keysize)) {

240 
	`£os
(
h‹
, 
µ
);

241 (
HT_OLD_ENTRY
);

244 
p
 = 
	`ÿÎoc
(1, (*pè+ 
ht
->
™em_size
 + 
keysize
 + 
extsize
);

245 ià(
p
 =ğ
NULL
) {

246 
	`£os
(
h‹
, 
NULL
);

249 
	`memıy
(
	`KEY
(
ht
, 
p
), 
key
, 
keysize
 + 
extsize
);

250 
p
->
hash
 = 
h
;

251 
p
->
keysize
 = keysize;

252 
p
->
extsize
 =ƒxtsize;

253 
p
->
lšk
 = *
µ
;

254 *
µ
 = 
p
;

255 
h‹
->
ht
->
n
 += 1;

256 
	`£os
(
h‹
, 
µ
);

257 (
HT_NEW_ENTRY
);

258 
	}
}

261 
	$hashtb_d–‘e
(
hashtb_’um”©Ü
 *
h‹
)

263 
hashtb
 *
ht
 = 
h‹
->ht;

264 
node
 **
µ
 = 
h‹
->
´iv
[0];

265 
node
 *
p
 = *
µ
;

266 ià((
p
 !ğ
NULL
è&& 
	`CHECKHTE
(
ht
, 
h‹
è&& 
	`KEY
(ht,…è=ğh‹->
key
) {

267 *
µ
 = 
p
->
lšk
;

268 ià(*
µ
 =ğ
NULL
)

269 
µ
 = 
	`sÿn_buck‘s
(
h‹
->
ht
, (
p
->
hash
 % h‹->ht->
n_buck‘s
) + 1);

270 
h‹
->
ht
->
n
 -= 1;

271 ià(
ht
->
»fcouÁ
 == 1) {

272 
hashtb_fš®ize_´oc
 
f
 = 
ht
->
·¿m
.
fš®ize
;

273 ià(
f
 !ğ
NULL
)

274 (*
f
)(
h‹
);

275 
	`ä“
(
p
);

278 
p
->
lšk
 = 
ht
->
deã¼ed
;

279 
ht
->
deã¼ed
 = 
p
;

281 
	`£os
(
h‹
, 
µ
);

283 
	}
}

286 
	$hashtb_»hash
(
hashtb
 *
ht
, 
n_buck‘s
)

288 
node
 **
buck‘
 = 
NULL
;

289 
node
 **
µ
;

290 
node
 *
p
;

291 
node
 *
q
;

292 
size_t
 
h
;

293 
i
;

294 
b
;

295 ià(
ht
->
»fcouÁ
 !ğ0 || 
n_buck‘s
 < 1 ||‚_buckets == ht->n_buckets)

297 
buck‘
 = 
	`ÿÎoc
(
n_buck‘s
, (bucket[0]));

298 ià(
buck‘
 =ğ
NULL
) ;

299 
i
 = 0; i < 
ht
->
n_buck‘s
; i++) {

300 
p
 = 
ht
->
buck‘
[
i
];… !ğ
NULL
;… = 
q
) {

301 
q
 = 
p
->
lšk
;

302 
h
 = 
p
->
hash
;

303 
b
 = 
h
 % 
n_buck‘s
;

304 
µ
 = &
buck‘
[
b
]; *µ !ğ
NULL
 && ((*µ)->
hash
 < 
h
);…°ğ&((*µ)->
lšk
))

306 
p
->
lšk
 = *
µ
;

307 *
µ
 = 
p
;

310 
	`ä“
(
ht
->
buck‘
);

311 
ht
->
buck‘
 = bucket;

312 
ht
->
n_buck‘s
 =‚_buckets;

313 
	}
}

	@lib/hashtbtest.c

20 
	~<¡dlib.h
>

21 
	~<¡dšt.h
>

22 
	~<¡dio.h
>

23 
	~<¡ršg.h
>

24 
	~<cú/hashtb.h
>

27 
	$Dump
(
hashtb
 *
h
)

29 
hashtb_’um”©Ü
 
“e
;

30 
hashtb_’um”©Ü
 *
e
 = &
“e
;

31 
	`´štf
("------- %d ------\n", 
	`hashtb_n
(
h
));

32 
	`hashtb_¡¬t
(
h
, 
e
);ƒ->
key
 !ğ
NULL
; 
	`hashtb_Ãxt
(e)) {

33 ià(
e
->
extsize
 !ğ1 || 
	`¡¾’
Ó->
key
è!ğe->
keysize
)

34 
	`abÜt
();

35 
	`´štf
("%u: %s\n", ((*)
e
->
d©a
)[0], (cÚ¡ *ë->
key
);

37 
	`hashtb_’d
(
e
);

38 
	}
}

41 
	$fš®ly
(
hashtb_’um”©Ü
 *
e
)

43 *
who
 = 
	`hashtb_g‘_·¿m
(
e
->
ht
, 
NULL
);

44 
	`årštf
(
¡d”r
, "% d–‘šg %s\n", 
who
, (cÚ¡ *)
e
->
key
);

45 
	}
}

48 
	$maš
(
¬gc
, **
¬gv
)

50 
buf
[1024] = {0};

51 
hashtb_·¿m
 
p
 = { &
fš®ly
, 
¬gv
[1]};

52 
hashtb
 *
h
 = 
	`hashtb_ü—‹
((*), 
p
.
fš®ize_d©a
 ? &°: 
NULL
);

53 
hashtb_’um”©Ü
 
“e
;

54 
hashtb_’um”©Ü
 *
e
 = 
	`hashtb_¡¬t
(
h
, &
“e
);

55 
hashtb_’um”©Ü
 
“e2
;

56 
hashtb_’um”©Ü
 *
e2
 = 
NULL
;

57 
Ã¡
 = 0;

58 
	`fg‘s
(
buf
, (buf), 
¡dš
)) {

59 
i
 = 
	`¡¾’
(
buf
);

60 ià(
i
 > 0 && 
buf
[i-1] == '\n')

61 
buf
[--
i
] = 0;

62 ià(
buf
[0] == '?') {

63 
	`Dump
(
h
);

65 ià(
buf
[0] == '-') {

66 
»s
;

67 *
v
;

68 
v
 = 
	`hashtb_lookup
(
h
, 
buf
+1, 
i
-1);

69 ià(
v
 !ğ
NULL
)

70 
	`´štf
("(%u)", *
v
);

71 
»s
 = 
	`hashtb_£ek
(
e
, 
buf
+1, 
i
-1, 1);

72 
	`hashtb_d–‘e
(
e
);

73 
	`´štf
("%d\n", 
»s
 =ğ
HT_OLD_ENTRY
);

75 ià(
buf
[0] == '.' && buf[1] == '[') {

76 ià((
Ã¡
++) == 0)

77 
e2
 = 
	`hashtb_¡¬t
(
h
, &
“e2
);

79 ià(
buf
[0] == '.' && buf[1] == ']') {

80 ià((--
Ã¡
è=ğ0 && 
e2
 !ğ
NULL
)

81 
	`hashtb_’d
(
e2
);

82 
e2
 = 
NULL
;

85 
	`hashtb_£ek
(
e
, 
buf
, 
i
, 1);

86 ((*)(
e
->
d©a
))[0] += 1;

89 
	`hashtb_’d
(
e
);

90 
	`hashtb_de¡roy
(&
h
);

91 ià(
h
 !ğ
NULL
)

94 
	}
}

	@lib/matrixtest.c

20 
	~<¡dlib.h
>

21 
	~<¡dšt.h
>

22 
	~<¡dio.h
>

23 
	~<¡ršg.h
>

24 
	~<cú/m©rix.h
>

27 
	$Dump
(
cú_m©rix
 *
m
)

29 
cú_m©rix_bounds
 
r
;

30 
»s
 = 
	`cú_m©rix_g‘bounds
(
m
, &
r
);

31 
	`´štf
("ccn_matrix_getbounds„es = %d,„ows [%ld..%ld), cols [%ld..%ld)\n",

32 
»s
,

33 ()
r
.
row_mš
, (ì.
row_max
,

34 ()
r
.
cŞ_mš
, (ì.
cŞ_max
);

35 
	}
}

38 
	$maš
(
¬gc
, **
¬gv
)

41 
cú_m©rix
 *
m
;

43 
m
 = 
	`cú_m©rix_ü—‹
();

45 
	`Dump
(
m
);

46 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 1, 100));

47 
	`Dump
(
m
); 
	`´štf
(" ccn_matrix_store(m, 1, 100, 30);" "\n");

48 
	`cú_m©rix_¡Üe
(
m
, 1, 100, 30);

49 
	`Dump
(
m
);

50 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 31415926, 101));

51 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 1, 100));

52 
	`Dump
(
m
); 
	`´štf
(" ccn_matrix_store(m, 31415926, 101, 43);" "\n");

53 
	`cú_m©rix_¡Üe
(
m
, 31415926, 101, 43);

54 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 31415926, 101));

55 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 1, 100));

56 
	`Dump
(
m
);

57 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 1, 100));

58 
	`Dump
(
m
); 
	`´štf
(" ccn_matrix_store(m, 1, 100, 0);" "\n");

59 
	`cú_m©rix_¡Üe
(
m
, 1, 100, 0);

60 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 31415926, 101));

61 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 1, 100));

62 
	`Dump
(
m
); 
	`´štf
(" ccn_matrix_store(m, 31415926, 101, 0);" "\n");

63 
	`cú_m©rix_¡Üe
(
m
, 31415926, 101, 0);

64 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 31415926, 101));

65 
	`´štf
("%d: %ld\n", 
__LINE__
, ()
	`cú_m©rix_ãtch
(
m
, 1, 100));

66 
	`Dump
(
m
);

67 
	`cú_m©rix_de¡roy
(&
m
);

69 
	}
}

	@lib/signbenchtest.c

19 
	~<¡dlib.h
>

20 
	~<¡dšt.h
>

21 
	~<¡dio.h
>

22 
	~<¡ršg.h
>

23 
	~<cú/cú.h
>

24 
	~<cú/ch¬buf.h
>

25 
	~<cú/key¡Üe.h
>

26 
	~<time.h
>

27 
	~<sys/time.h
>

29 
	#FRESHNESS
 10

	)

30 
	#COUNT
 3000

	)

31 
	#PAYLOAD_SIZE
 51

	)

34 
	$maš
(
¬gc
, **
¬gv
)

37 
cú_key¡Üe
 *
key¡Üe
 = 
NULL
;

38 
»s
 = 0;

39 
cú_ch¬buf
 *
sigÃd_šfo
 = 
	`cú_ch¬buf_ü—‹
();

40 
i
;

41 
£c
, 
u£c
;

42 
msgbuf
[
PAYLOAD_SIZE
];

43 
timev®
 
¡¬t
, 
’d
;

44 
cú_ch¬buf
 *
mes§ge
 = 
	`cú_ch¬buf_ü—‹
();

45 
cú_ch¬buf
 *
·th
 = 
	`cú_ch¬buf_ü—‹
();

46 
cú_ch¬buf
 *
£q
 = 
	`cú_ch¬buf_ü—‹
();

48 
cú_ch¬buf
 *
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

49 
key¡Üe
 = 
	`cú_key¡Üe_ü—‹
();

50 
	`cú_ch¬buf_putf
(
‹mp
, "%s/.cúx/.cúx_key¡Üe", 
	`g‘’v
("HOME"));

51 
»s
 = 
	`cú_key¡Üe_š™
(
key¡Üe
,

52 
	`cú_ch¬buf_as_¡ršg
(
‹mp
),

54 ià(
»s
 != 0) {

55 
	`´štf
("FaedØš™Ÿlizkey¡Ü%s\n", 
	`cú_ch¬buf_as_¡ršg
(
‹mp
));

56 
	`ex™
(1);

58 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

60 
»s
 = 
	`cú_sigÃd_šfo_ü—‹
(
sigÃd_šfo
,

61  
	`cú_key¡Üe_public_key_dige¡
(
key¡Üe
),

62  
	`cú_key¡Üe_public_key_dige¡_Ëngth
(
key¡Üe
),

63  
NULL
,

64  
CCN_CONTENT_DATA
,

65  
FRESHNESS
,

66  
NULL
,

67  
NULL
);

69 
	`¤ªdom
(
	`time
(
NULL
));

70 
i
=0; i<
PAYLOAD_SIZE
; i++) {

71 
msgbuf
[
i
] = 
	`¿ndom
();

74 
	`´štf
("G’”©šg %d sigÃd CÚ‹ÁObjeù (Ú.…” 100)\n", 
COUNT
);

75 
	`g‘timeofday
(&
¡¬t
, 
NULL
);

77 
i
=0; i<
COUNT
; i++) {

79 ià(
i
>0 && (i%100) == 0) {

80 
	`´štf
(".");

81 
	`fæush
(
¡dout
);

83 
	`cú_Çme_š™
(
·th
);

84 
	`cú_Çme_­³nd_¡r
(
·th
, "rtp");

85 
	`cú_Çme_­³nd_¡r
(
·th
, "protocol");

86 
	`cú_Çme_­³nd_¡r
(
·th
, "13.2.117.34");

87 
	`cú_Çme_­³nd_¡r
(
·th
, "domain");

88 
	`cú_Çme_­³nd_¡r
(
·th
, "smetters");

89 
	`cú_Çme_­³nd_¡r
(
·th
, "principal");

90 
	`cú_Çme_­³nd_¡r
(
·th
, "2021915340");

91 
	`cú_Çme_­³nd_¡r
(
·th
, "id");

92 
	`cú_ch¬buf_putf
(
£q
, "%u", 
i
);

93 
	`cú_Çme_­³nd
(
·th
, 
£q
->
buf
, seq->
Ëngth
);

94 
	`cú_Çme_­³nd_¡r
(
·th
, "seq");

96 
»s
 = 
	`cú_’code_CÚ‹ÁObjeù
Ğ
mes§ge
,

97 
·th
, 
sigÃd_šfo
,

98 
msgbuf
, 
PAYLOAD_SIZE
,

99  
NULL
,

100 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
));

102 
	`cú_ch¬buf_»£t
(
mes§ge
);

103 
	`cú_ch¬buf_»£t
(
·th
);

104 
	`cú_ch¬buf_»£t
(
£q
);

106 
	`g‘timeofday
(&
’d
, 
NULL
);

107 
£c
 = 
’d
.
tv_£c
 - 
¡¬t
.tv_sec;

108 
u£c
 = ()
’d
.
tv_u£c
 - ()
¡¬t
.tv_usec;

109 
u£c
 < 0) {

110 
£c
--;

111 
u£c
 += 1000000;

114 
	`´štf
("\nCom¶‘š %d.%06d secs\n", 
£c
, 
u£c
);

117 
	}
}

	@lib/skel_decode_test.c

20 
	~<fú.h
>

21 
	~<lim™s.h
>

22 
	~<¡ddef.h
>

23 
	~<¡dio.h
>

24 
	~<¡dšt.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<uni¡d.h
>

29 
	~<cú/ch¬buf.h
>

30 
	~<cú/codšg.h
>

32 cÚ¡ *
	g‰_Çme
[8] = {

33 [
CCN_EXT
] = "CCN_EXT",

34 [
CCN_TAG
] = "CCN_TAG",

35 [
CCN_DTAG
] = "CCN_DTAG",

36 [
CCN_ATTR
] = "CCN_ATTR",

37 [
CCN_DATTR
] = "CCN_DATTR",

38 [
CCN_BLOB
] = "CCN_BLOB",

39 [
CCN_UDATA
] = "CCN_UDATA",

40 [
CCN_NO_TOKEN
] = "CCN_CLOSE"

43 
	#SHOW_HEX_STATE
 1

	)

46 
	$´oûss_‹¡
(*
d©a
, 
size_t
 
n
, 
æags
)

48 
cú_sk–‘Ú_decod”
 
sk–_decod”
 = {0};

49 
cú_sk–‘Ú_decod”
 *
d
 = &
sk–_decod”
;

50 
»s
 = 0;

51 
size_t
 
s
;

52 
d
->
¡©e
 |ğ
æags
 & 
CCN_DSTATE_PAUSE
;

53 
»Œy
:

54 
s
 = 
	`cú_sk–‘Ú_decode
(
d
, 
d©a
, 
n
);

55 ià(
æags
 & 
SHOW_HEX_STATE
)

56 
	`årštf
(
¡d”r
, "¡©ğ0x%x\n", 
d
->
¡©e
);

57 ià(
d
->
¡©e
 < 0) {

58 
»s
 = 1;

59 
	`årštf
(
¡d”r
, "error state %d‡fter %d of %d chars\n",

60 ()
d
->
¡©e
, ()
s
, ()
n
);

62 ià(
s
 == 0) {

63 
	`årštf
(
¡d”r
, "nothingo do\n");

66 ià(
d
->
¡©e
 & 
CCN_DSTATE_PAUSE
)

67 
	`årštf
(
¡d”r
, "Tokenype %s(%d)‡t index %d;ƒl %d‚est %d; ",

68 
‰_Çme
[
	`CCN_GET_TT_FROM_DSTATE
(
d
->
¡©e
)],

69 ()
d
->
numv®
,

70 ()
d
->
tok’_šdex
,

71 ()
d
->
–em’t_šdex
,

72 ()
d
->
Ã¡
);

73 ià(
s
 < 
n
) {

74 
	`årštf
(
¡d”r
, "»sumšg‡ˆšdex %d\n", ()
d
->
šdex
);

75 
d©a
 +ğ
s
;

76 
n
 -ğ
s
;

77 
»Œy
;

79 
	`årštf
(
¡d”r
, "\n");

81 ià(!
	`CCN_FINAL_DSTATE
(
d
->
¡©e
)) {

82 
»s
 = 1;

83 
	`årštf
(
¡d”r
, "incomplete state %d‡fter %d of %d chars\n",

84 ()
d
->
¡©e
, ()
s
, ()
n
);

86 (
»s
);

87 
	}
}

90 
	$´oûss_fd
(
fd
, 
æags
)

92 
cú_ch¬buf
 *
c
 = 
	`cú_ch¬buf_ü—‹
();

93 
ssize_t
 
Ën
;

94 
»s
 = 0;

96 *
p
 = 
	`cú_ch¬buf_»£rve
(
c
, 80);

97 ià(
p
 =ğ
NULL
) {

98 
	`³¼Ü
("ccn_charbuf_reserve");

99 
»s
 = 1;

102 
Ën
 = 
	`»ad
(
fd
, 
p
, 
c
->
lim™
 - c->
Ëngth
);

103 ià(
Ën
 <= 0) {

104 ià(
Ën
 == -1) {

105 
	`³¼Ü
("read");

106 
»s
 = 1;

110 
c
->
Ëngth
 +ğ
Ën
;

112 
	`årštf
(
¡d”r
, " <!-- iÅuˆi %6lu by‹ -->\n", ()
c
->
Ëngth
);

113 
»s
 |ğ
	`´oûss_‹¡
(
c
->
buf
, c->
Ëngth
, 
æags
);

114 
	`cú_ch¬buf_de¡roy
(&
c
);

115 (
»s
);

116 
	}
}

120 
	$´oûss_fe
(*
·th
, 
æags
)

122 
fd
 = 0;

123 
»s
 = 0;

124 ià(0 !ğ
	`¡rcmp
(
·th
, "-")) {

125 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

126 ià(-1 =ğ
fd
) {

127 
	`³¼Ü
(
·th
);

131 
»s
 = 
	`´oûss_fd
(
fd
, 
æags
);

132 ià(
fd
 > 0)

133 
	`şo£
(
fd
);

134 (
»s
);

135 
	}
}

138 
	$maš
(
¬gc
, **
¬gv
)

140 
i
;

141 
»s
 = 0;

142 
æags
 = 0;

143 
i
 = 1; 
¬gv
[i] != 0; i++) {

144 ià(0 =ğ
	`¡rcmp
(
¬gv
[
i
], "-d")) {

145 
æags
 |ğ
CCN_DSTATE_PAUSE
;

148 ià(0 =ğ
	`¡rcmp
(
¬gv
[
i
], "-D")) {

149 
æags
 |ğ
CCN_DSTATE_PAUSE
 | 
SHOW_HEX_STATE
;

152 
	`årštf
(
¡d”r
, "<!-- Proûssšg % -->\n", 
¬gv
[
i
]);

153 
»s
 |ğ
	`´oûss_fe
(
¬gv
[
i
], 
æags
);

155 (
»s
);

156 
	}
}

	@lib/smoketestclientlib.c

20 
	~<”ºo.h
>

21 
	~<fú.h
>

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/ty³s.h
>

26 
	~<cú/cú.h
>

27 
	~<uni¡d.h
>

29 
	$´šŒaw
(cÚ¡ *
r
, 
n
)

31 
i
, 
l
;

32 cÚ¡ *
p
 = 
r
;

33 
n
 > 0) {

34 
l
 = (
n
 > 40 ? 40 :‚);

35 
i
 = 0; i < 
l
; i++)

36 
	`´štf
(" %c", (' ' <ğ
p
[
i
] &&…[i] <= '~') ?…[i] : '.');

37 
	`´štf
("\n");

38 
i
 = 0; i < 
l
; i++)

39 
	`´štf
("%02X", 
p
[
i
]);

40 
	`´štf
("\n");

41 
p
 +ğ
l
;

42 
n
 -ğ
l
;

44 
	}
}

46 
cú_upÿÎ_»s


47 
	$šcomšg_cÚ‹Á
(
cú_şosu»
 *
£lå
,

48 
cú_upÿÎ_kšd
 
kšd
,

49 
cú_upÿÎ_šfo
 *
šfo
)

51 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
)

52 (
CCN_UPCALL_RESULT_OK
);

53 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST_TIMED_OUT
)

54 (
CCN_UPCALL_RESULT_REEXPRESS
);

55 ià(
kšd
 !ğ
CCN_UPCALL_CONTENT
 && kšd !ğ
CCN_UPCALL_CONTENT_UNVERIFIED
)

56 (
CCN_UPCALL_RESULT_ERR
);

57 
	`´štf
("GÙ cÚ‹Á m©chšg %d compÚ’ts:\n", 
šfo
->
pi
->
´efix_comps
);

58 
	`´šŒaw
(
šfo
->
cÚ‹Á_cúb
, info->
pco
->
off£t
[
CCN_PCO_E
]);

59 (
CCN_UPCALL_RESULT_OK
);

60 
	}
}

63 
cú_şosu»
 
	gšcomšg_cÚ‹Á_aùiÚ
 = {

64 .
p
 = &
šcomšg_cÚ‹Á


67 
	g¿wbuf
[1024*1024];

68 
ssize_t
 
	g¿wËn
;

70 
cú_upÿÎ_»s


71 
	$outgošg_cÚ‹Á
(
cú_şosu»
 *
£lå
,

72 
cú_upÿÎ_kšd
 
kšd
,

73 
cú_upÿÎ_šfo
 *
šfo
)

75 
»s
 = 0;

76 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
) {

77 
	`´štf
("CCN_UPCALL_FINAL for outgoing_content()\n");

78 (
CCN_UPCALL_RESULT_ERR
);

80 
	`´štf
("GÙ iÁ”e¡ m©chšg %d compÚ’ts, kšd = %d\n", 
šfo
->
m©ched_comps
, 
kšd
);

81 ià(
kšd
 =ğ
CCN_UPCALL_INTEREST
) {

82 
»s
 = 
	`cú_put
(
šfo
->
h
, 
¿wbuf
, 
¿wËn
);

83 ià(
»s
 == -1) {

84 
	`årštf
(
¡d”r
, "error sending data");

85 (
CCN_UPCALL_RESULT_ERR
);

88 
	`´štf
("Sent my content:\n");

89 
	`´šŒaw
(
¿wbuf
, 
¿wËn
);

90 (
CCN_UPCALL_RESULT_INTEREST_CONSUMED
);

94 (
CCN_UPCALL_RESULT_ERR
);

95 
	}
}

97 
cú_şosu»
 
	gš‹»¡_f‹r
 = {

98 .
p
 = &
outgošg_cÚ‹Á


102 
	$maš
(
¬gc
, **
¬gv
)

104 
ch
;

105 
»s
;

106 *
f’ame
 = 
NULL
;

107 
»p
 = 1;

108 
cú
 *cú = 
NULL
;

109 
cú_·r£d_š‹»¡
 
š‹»¡
 = {0};

110 
i
;

111 
cú_ch¬buf
 *
c
 = 
	`cú_ch¬buf_ü—‹
();

112 
cú_ch¬buf
 *
‹m¶
 = 
	`cú_ch¬buf_ü—‹
();

113 
cú_šdexbuf
 *
comps
 = 
	`cú_šdexbuf_ü—‹
();

114 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "hf:n:")) != -1) {

115 
ch
) {

118 
	`årštf
(
¡d”r
, "provide‚ames of files containing ccnb format interests‡nd content\n");

119 
	`ex™
(1);

121 
»p
 = 
	`©oi
(
İrg
);

125 
¬gc
 -ğ
İtšd
;

126 
¬gv
 +ğ
İtšd
;

127 
cú
 = 
	`cú_ü—‹
();

128 ià(
	`cú_cÚÃù
(
cú
, 
NULL
) == -1) {

129 
	`³¼Ü
("ccn_connect");

130 
	`ex™
(1);

132 
i
 = 0; 
¬gv
[i] !ğ
NULL
; i++) {

133 
f’ame
 = 
¬gv
[
i
];

134 
	`şo£
(0);

135 
»s
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

136 ià(
»s
 != 0) {

137 
	`³¼Ü
(
f’ame
);

138 
	`ex™
(1);

140 
	`årštf
(
¡d”r
, "R—dšg % ... ", 
f’ame
);

141 
¿wËn
 = 
	`»ad
(0, 
¿wbuf
, (rawbuf));

142 ià(
¿wËn
 < 0) {

143 
	`³¼Ü
("skipping");

146 
»s
 = 
	`cú_·r£_š‹»¡
(
¿wbuf
, 
¿wËn
, &
š‹»¡
, 
NULL
);

147 ià(
»s
 >= 0) {

148 
size_t
 
Çme_¡¬t
 = 
š‹»¡
.
off£t
[
CCN_PI_B_Name
];

149 
size_t
 
Çme_size
 = 
š‹»¡
.
off£t
[
CCN_PI_E_Name
] - 
Çme_¡¬t
;

150 
‹m¶
->
Ëngth
 = 0;

151 
	`cú_ch¬buf_­³nd
(
‹m¶
, 
¿wbuf
, 
¿wËn
);

152 
	`årštf
(
¡d”r
, "Regi¡”šg iÁ”e¡ w™h %d‚amcompÚ’ts\n", 
»s
);

153 
c
->
Ëngth
 = 0;

154 
	`cú_ch¬buf_­³nd
(
c
, 
¿wbuf
 + 
Çme_¡¬t
, 
Çme_size
);

156 
	`cú_ex´ess_š‹»¡
(
cú
, 
c
, &
šcomšg_cÚ‹Á_aùiÚ
, 
‹m¶
);

159 
cú_·r£d_CÚ‹ÁObjeù
 
obj
 = {0};

160 
k
;

161 
»s
 = 
	`cú_·r£_CÚ‹ÁObjeù
(
¿wbuf
, 
¿wËn
, &
obj
, 
comps
);

162 ià(
»s
 >= 0) {

163 
	`årštf
(
¡d”r
, "Offering content\n");

165 
k
 = 
comps
->
n
 - 1; k >= 2; k--) {

166 
c
->
Ëngth
 = 0;

167 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

168 
	`cú_ch¬buf_­³nd
(
c
, 
¿wbuf
+
comps
->
buf
[0], comps->buf[
k
] - comps->buf[0]);

169 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

170 
»s
 = 
	`cú_£t_š‹»¡_f‹r
(
cú
, 
c
, &
š‹»¡_f‹r
);

171 ià(
»s
 < 0è
	`abÜt
();

173 
»s
 = 
	`cú_run
(
cú
, 1000);

175 
k
 = 
comps
->
n
 - 1; k >= 2; k--) {

176 
c
->
Ëngth
 = 0;

177 
	`cú_ch¬buf_­³nd_‰
(
c
, 
CCN_DTAG_Name
, 
CCN_DTAG
);

178 
	`cú_ch¬buf_­³nd
(
c
, 
¿wbuf
+
comps
->
buf
[0], comps->buf[
k
] - comps->buf[0]);

179 
	`cú_ch¬buf_­³nd_şo£r
(
c
);

180 
»s
 = 
	`cú_£t_š‹»¡_f‹r
(
cú
, 
c
, 
NULL
);

181 ià(
»s
 < 0è
	`abÜt
();

185 
	`årštf
(
¡d”r
, "what'shat?\n");

189 
	`årštf
(
¡d”r
, "Running for 8 more seconds\n");

190 
»s
 = 
	`cú_run
(
cú
, 8000);

191 
	`cú_de¡roy
(&
cú
);

192 
	`ex™
(0);

193 
	}
}

	@libexec/ccndc.c

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡d¬g.h
>

23 
	~<lim™s.h
>

24 
	~<¡ršg.h
>

25 
	~<¡ršgs.h
>

26 
	~<uni¡d.h
>

27 
	~<sys/sock‘.h
>

28 
	~<sys/time.h
>

29 
	~<Ãtdb.h
>

30 
	~<Ãtš‘/š.h
>

31 
	#BIND_8_COMPAT


	)

32 
	~<¬·/Çme£r.h
>

33 
	~<»sŞv.h
>

34 
	~<”ºo.h
>

35 
	~<cú/bloom.h
>

36 
	~<cú/cú.h
>

37 
	~<cú/cúd.h
>

38 
	~<cú/ch¬buf.h
>

39 
	~<cú/uri.h
>

40 
	~<cú/çû_mgmt.h
>

41 
	~<cú/»g_mgmt.h
>

42 
	~<cú/sockü—‹.h
>

43 
	~<cú/signšg.h
>

44 
	~<cú/key¡Üe.h
>

46 #ià
defšed
(
NEED_GETADDRINFO_COMPAT
)

47 
	~"g‘addršfo.h
"

48 
	~"dummyš6.h
"

51 #iâdeà
AI_ADDRCONFIG


52 
	#AI_ADDRCONFIG
 0

	)

55 #iâdeà
NS_MAXMSG


56 
	#NS_MAXMSG
 65535

	)

59 #iâdeà
NS_MAXDNAME


60 #ifdeà
MAXDNAME


61 
	#NS_MAXDNAME
 
MAXDNAME


	)

65 #iâdeà
T_SRV


66 
	#T_SRV
 33

	)

69 
	#OP_REG
 0

	)

70 
	#OP_UNREG
 1

	)

75 
	s´efix_çû_li¡_™em
 {

76 
cú_ch¬buf
 *
	m´efix
;

77 
cú_çû_š¡ªû
 *
	mfi
;

78 
	mæags
;

79 
´efix_çû_li¡_™em
 *
	mÃxt
;

85 
cú_ch¬buf
 *
	gloÿl_scİe_‹m¶©e
 = 
NULL
;

86 
cú_ch¬buf
 *
	gno_Çme
 = 
NULL
;

87 
	gcúdid_¡Üage
[32] = {0};

88 cÚ¡ *
	gcúdid
 = 
cúdid_¡Üage
;

89 
size_t
 
	gcúdid_size
;

94 
	gv”bo£
 = 0;

98 
	$u§ge
(cÚ¡ *
´ogÇme
)

100 
	`årštf
(
¡d”r
,

106 
´ogÇme
);

107 
	`ex™
(1);

108 
	}
}

111 
	$cúdc_w¬n
(
lš’o
, *
fÜm©
, ...)

113 
timev®
 
t
;

114 
va_li¡
 
­
;

115 
	`va_¡¬t
(
­
, 
fÜm©
);

116 
	`g‘timeofday
(&
t
, 
NULL
);

117 
	`årštf
(
¡d”r
, "%d.%06d cúdc[%d]:%d: ", ()
t
.
tv_£c
, (é.
tv_u£c
, ()
	`g‘pid
(), 
lš’o
);

118 
	`vårštf
(
¡d”r
, 
fÜm©
, 
­
);

119 
	`va_’d
(
­
);

120 
	}
}

123 
	$cúdc_çl
(
lše
, *
fÜm©
, ...)

125 
timev®
 
t
;

126 
va_li¡
 
­
;

127 
	`va_¡¬t
(
­
, 
fÜm©
);

128 
	`g‘timeofday
(&
t
, 
NULL
);

129 
	`årštf
(
¡d”r
, "%d.%06d cúdc[%d]:%d: ", ()
t
.
tv_£c
, (é.
tv_u£c
, ()
	`g‘pid
(), 
lše
);

130 
	`vårštf
(
¡d”r
, 
fÜm©
, 
­
);

131 
	`va_’d
(
­
);

132 
	`ex™
(1);

133 
	}
}

135 
	#ON_ERROR_EXIT
(
»sv®
è
	`Ú_”rÜ_ex™
(Ôesv®), 
__LINE__
)

	)

138 
	$Ú_”rÜ_ex™
(
»s
, 
lš’o
)

140 ià(
»s
 >= 0)

142 
	`cúdc_çl
(
lš’o
, "çÈ”rÜ,„e ğ%d\n", 
»s
);

143 
	}
}

145 
	#ON_ERROR_CLEANUP
(
»sv®
) \

147 ià((
»sv®
) < 0) { \

148 ià(
v”bo£
 > 0è
	`cúdc_w¬n
 (
__LINE__
, "OnError cleanup\n"); \

149 
CËªup
; \

151 }

	)

153 
	#ON_NULL_CLEANUP
(
»sv®
) \

155 ià((
»sv®
è=ğ
NULL
) { \

156 ià(
v”bo£
 > 0è
	`cúdc_w¬n
(
__LINE__
, "OnNull cleanup\n"); \

157 
CËªup
; \

159 }

	)

162 
	$š™Ÿlize_glob®_d©a
() {

164 
loÿl_scİe_‹m¶©e
 = 
	`cú_ch¬buf_ü—‹
();

165 ià(
loÿl_scİe_‹m¶©e
 =ğ
NULL
) {

166 
	`ON_ERROR_EXIT
(-1);

169 
	`ON_ERROR_EXIT
(
	`cú_ch¬buf_­³nd_‰
(
loÿl_scİe_‹m¶©e
, 
CCN_DTAG_IÁ”e¡
, 
CCN_DTAG
));

170 
	`ON_ERROR_EXIT
(
	`cú_ch¬buf_­³nd_‰
(
loÿl_scİe_‹m¶©e
, 
CCN_DTAG_Name
, 
CCN_DTAG
));

171 
	`ON_ERROR_EXIT
(
	`cú_ch¬buf_­³nd_şo£r
(
loÿl_scİe_‹m¶©e
));

172 
	`ON_ERROR_EXIT
(
	`cúb_gged_putf
(
loÿl_scİe_‹m¶©e
, 
CCN_DTAG_Scİe
, "1"));

173 
	`ON_ERROR_EXIT
(
	`cú_ch¬buf_­³nd_şo£r
(
loÿl_scİe_‹m¶©e
));

176 
no_Çme
 = 
	`cú_ch¬buf_ü—‹
();

177 ià(
no_Çme
 =ğ
NULL
) {

178 
	`ON_ERROR_EXIT
(-1);

180 
	`ON_ERROR_EXIT
(
	`cú_Çme_š™
(
no_Çme
));

181 
	}
}

190 
	$g‘_cúdid
(
cú
 *
h
, cÚ¡ *
cúdid
, 
size_t
 
cúdid_¡Üage_size
)

193 
cú_ch¬buf
 *
Çme
 = 
NULL
;

194 
cú_ch¬buf
 *
»suÉbuf
 = 
NULL
;

195 
cú_·r£d_CÚ‹ÁObjeù
 
pcobuf
 = {0};

196 
pšg_uri
[] = "ccnx:/ccnx/ping";

197 cÚ¡ *
cúdid_»suÉ
;

198 
size_t
 
cúdid_»suÉ_size
;

199 
»s
;

201 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

202 ià(
Çme
 =ğ
NULL
) {

203 
	`ON_ERROR_EXIT
(-1);

206 
»suÉbuf
 = 
	`cú_ch¬buf_ü—‹
();

207 ià(
»suÉbuf
 =ğ
NULL
) {

208 
	`ON_ERROR_EXIT
(-1);

212 
	`ON_ERROR_EXIT
(
	`cú_Çme_äom_uri
(
Çme
, 
pšg_uri
));

213 
	`ON_ERROR_EXIT
(
	`cú_Çme_­³nd_nÚû
(
Çme
));

214 
	`ON_ERROR_EXIT
(
	`cú_g‘
(
h
, 
Çme
, 
loÿl_scİe_‹m¶©e
, 4500, 
»suÉbuf
, &
pcobuf
, 
NULL
, 0));

215 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_Publish”PublicKeyDige¡
,

216 
»suÉbuf
->
buf
,

217 
pcobuf
.
off£t
[
CCN_PCO_B_Publish”PublicKeyDige¡
],

218 
pcobuf
.
off£t
[
CCN_PCO_E_Publish”PublicKeyDige¡
],

219 &
cúdid_»suÉ
, &
cúdid_»suÉ_size
);

220 
	`ON_ERROR_EXIT
(
»s
);

221 ià(
cúdid_»suÉ_size
 > 
cúdid_¡Üage_size
)

222 
	`ON_ERROR_EXIT
(-1);

223 
	`memıy
((*)
cúdid
, 
cúdid_»suÉ
, 
cúdid_»suÉ_size
);

224 
	`cú_ch¬buf_de¡roy
(&
Çme
);

225 
	`cú_ch¬buf_de¡roy
(&
»suÉbuf
);

226  (
cúdid_»suÉ_size
);

227 
	}
}

229 
´efix_çû_li¡_™em
 *
	$´efix_çû_li¡_™em_ü—‹
(
cú_ch¬buf
 *
´efix
,

230 
´Ùo
,

231 
mÿ¡_‰l
,

232 *
ho¡
,

233 *
pÜt
,

234 *
mÿ¡if
,

235 
liãtime
,

236 
æags
)

238 
´efix_çû_li¡_™em
 *
pæ
 = 
	`ÿÎoc
(1, (prefix_face_list_item));

239 
cú_çû_š¡ªû
 *
fi
 = 
	`ÿÎoc
(1, (*fi));

240 
cú_ch¬buf
 *
¡Üe
 = 
	`cú_ch¬buf_ü—‹
();

241 
ho¡_off
 = -1;

242 
pÜt_off
 = -1;

243 
mÿ¡_off
 = -1;

245 ià(
pæ
 =ğ
NULL
 || 
fi
 =ğNULL || 
¡Üe
 == NULL) {

246 ià(
pæ
è
	`ä“
(pfl);

247 ià(
fi
è
	`cú_çû_š¡ªû_de¡roy
(&fi);

248 ià(
¡Üe
è
	`cú_ch¬buf_de¡roy
(&store);

249  (
NULL
);

251 
pæ
->
fi
 = fi;

252 
pæ
->
fi
->
¡Üe
 = store;

254 
pæ
->
´efix
 =…refix;

255 
pæ
->
fi
->
desü
.
´Ùo
 = ipproto;

256 
pæ
->
fi
->
desü
.
mÿ¡_‰l
 = mcast_ttl;

257 
pæ
->
fi
->
liãtime
 =†ifetime;

258 
pæ
->
æags
 = flags;

260 
	`cú_ch¬buf_­³nd
(
¡Üe
, "Ãwçû", 
	`¡¾’
("newface") + 1);

261 
ho¡_off
 = 
¡Üe
->
Ëngth
;

262 
	`cú_ch¬buf_­³nd
(
¡Üe
, 
ho¡
, 
	`¡¾’
(host) + 1);

263 
pÜt_off
 = 
¡Üe
->
Ëngth
;

264 
	`cú_ch¬buf_­³nd
(
¡Üe
, 
pÜt
, 
	`¡¾’
(port) + 1);

265 ià(
mÿ¡if
 !ğ
NULL
) {

266 
mÿ¡_off
 = 
¡Üe
->
Ëngth
;

267 
	`cú_ch¬buf_­³nd
(
¡Üe
, 
mÿ¡if
, 
	`¡¾’
(mcastif) + 1);

271 *
b
 = (*)
¡Üe
->
buf
;

272 
pæ
->
fi
->
aùiÚ
 = 
b
;

273 
pæ
->
fi
->
desü
.
add»ss
 = 
b
 + 
ho¡_off
;

274 
pæ
->
fi
->
desü
.
pÜt
 = 
b
 + 
pÜt_off
;

275 
pæ
->
fi
->
desü
.
sourû_add»ss
 = (
mÿ¡_off
 =ğ-1è? 
NULL
 : 
b
 + mcast_off;

277  (
pæ
);

278 
	}
}

280 
	$´efix_çû_li¡_de¡roy
(
´efix_çû_li¡_™em
 **
pæµ
)

282 
´efix_çû_li¡_™em
 *
pæp
 = *
pæµ
;

283 
´efix_çû_li¡_™em
 *
Ãxt
;

285 ià(
pæp
 =ğ
NULL
) ;

286 
pæp
) {

287 
	`cú_çû_š¡ªû_de¡roy
(&
pæp
->
fi
);

288 
	`cú_ch¬buf_de¡roy
(&
pæp
->
´efix
);

289 
Ãxt
 = 
pæp
->next;

290 
	`ä“
(
pæp
);

291 
pæp
 = 
Ãxt
;

293 *
pæµ
 = 
NULL
;

294 
	}
}

296 
cú_ch¬buf
 *

297 
	$sigÃd_šfo_ü—‹
(
cú_key¡Üe
 *
key¡Üe
)

299 
cú_ch¬buf
 *
keyloÿtÜ
;

300 
cú_ch¬buf
 *
sigÃd_šfo
;

301 
»s
;

304 
keyloÿtÜ
 = 
	`cú_ch¬buf_ü—‹
();

305 
	`ON_ERROR_CLEANUP
(
	`cú_ch¬buf_­³nd_‰
(
keyloÿtÜ
, 
CCN_DTAG_KeyLoÿtÜ
, 
CCN_DTAG
));

306 
	`ON_ERROR_CLEANUP
(
	`cú_ch¬buf_­³nd_‰
(
keyloÿtÜ
, 
CCN_DTAG_Key
, 
CCN_DTAG
));

307 
	`ON_ERROR_CLEANUP
(
	`cú_­³nd_pubkey_blob
(
keyloÿtÜ
, 
	`cú_key¡Üe_public_key
(
key¡Üe
)));

308 
	`ON_ERROR_CLEANUP
(
	`cú_ch¬buf_­³nd_şo£r
(
keyloÿtÜ
));

309 
	`ON_ERROR_CLEANUP
(
	`cú_ch¬buf_­³nd_şo£r
(
keyloÿtÜ
));

311 
sigÃd_šfo
 = 
	`cú_ch¬buf_ü—‹
();

312 
»s
 = 
	`cú_sigÃd_šfo_ü—‹
(
sigÃd_šfo
,

313  
	`cú_key¡Üe_public_key_dige¡
(
key¡Üe
),

314  
	`cú_key¡Üe_public_key_dige¡_Ëngth
(
key¡Üe
),

315  
NULL
,

316  
CCN_CONTENT_DATA
,

318  
NULL
,

319 
keyloÿtÜ
);

320 
	`ON_ERROR_CLEANUP
(
»s
);

321 
	`cú_ch¬buf_de¡roy
(&
keyloÿtÜ
);

322  (
sigÃd_šfo
);

324 
CËªup
:

325 
	`cú_ch¬buf_de¡roy
(&
keyloÿtÜ
);

326 
	`cú_ch¬buf_de¡roy
(&
sigÃd_šfo
);

327  (
NULL
);

328 
	}
}

337 
cú_çû_š¡ªû
 *

338 
	$ü—‹_çû
(
cú
 *
h
, 
cú_key¡Üe
 *
key¡Üe
,

339 
cú_çû_š¡ªû
 *
çû_š¡ªû
)

341 
cú_ch¬buf
 *
Ãwçû
 = 
NULL
;

342 
cú_ch¬buf
 *
sigÃd_šfo
 = 
NULL
;

343 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

344 
cú_ch¬buf
 *
Çme
 = 
NULL
;

345 
cú_ch¬buf
 *
»suÉbuf
 = 
NULL
;

346 
cú_·r£d_CÚ‹ÁObjeù
 
pcobuf
 = {0};

347 
cú_çû_š¡ªû
 *
Ãw_çû_š¡ªû
 = 
NULL
;

348 cÚ¡ *
±r
 = 
NULL
;

349 
size_t
 
Ëngth
 = 0;

350 
»s
 = 0;

353 
Ãwçû
 = 
	`cú_ch¬buf_ü—‹
();

354 
	`ON_NULL_CLEANUP
(
Ãwçû
);

355 
	`ON_ERROR_CLEANUP
(
	`cúb_­³nd_çû_š¡ªû
(
Ãwçû
, 
çû_š¡ªû
));

357 
sigÃd_šfo
 = 
	`sigÃd_šfo_ü—‹
(
key¡Üe
);

358 
	`ON_NULL_CLEANUP
(
sigÃd_šfo
);

360 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

361 
	`ON_NULL_CLEANUP
(
‹mp
);

363 
»s
 = 
	`cú_’code_CÚ‹ÁObjeù
(
‹mp
,

364 
no_Çme
,

365 
sigÃd_šfo
,

366 
Ãwçû
->
buf
,

367 
Ãwçû
->
Ëngth
,

368 
NULL
,

369 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
));

370 
	`ON_ERROR_CLEANUP
(
»s
);

372 
»suÉbuf
 = 
	`cú_ch¬buf_ü—‹
();

373 
	`ON_NULL_CLEANUP
(
»suÉbuf
);

376 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

377 
	`ON_NULL_CLEANUP
(
Çme
);

378 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_š™
(
Çme
));

379 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_­³nd_¡r
(
Çme
, "ccnx"));

380 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_­³nd
(
Çme
, 
çû_š¡ªû
->
cúd_id
, faû_š¡ªû->
cúd_id_size
));

381 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_­³nd_¡r
(
Çme
, 
çû_š¡ªû
->
aùiÚ
));

382 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
));

383 
»s
 = 
	`cú_g‘
(
h
, 
Çme
, 
loÿl_scİe_‹m¶©e
, 1000, 
»suÉbuf
, &
pcobuf
, 
NULL
, 0);

384 
	`ON_ERROR_CLEANUP
(
»s
);

386 
	`ON_ERROR_CLEANUP
(
	`cú_cÚ‹Á_g‘_v®ue
(
»suÉbuf
->
buf
,„esuÉbuf->
Ëngth
, &
pcobuf
, &
±r
, &length));

387 
Ãw_çû_š¡ªû
 = 
	`cú_çû_š¡ªû_·r£
(
±r
, 
Ëngth
);

388 
	`ON_NULL_CLEANUP
(
Ãw_çû_š¡ªû
);

389 
	`cú_ch¬buf_de¡roy
(&
Ãwçû
);

390 
	`cú_ch¬buf_de¡roy
(&
sigÃd_šfo
);

391 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

392 
	`cú_ch¬buf_de¡roy
(&
»suÉbuf
);

393 
	`cú_ch¬buf_de¡roy
(&
Çme
);

394  (
Ãw_çû_š¡ªû
);

396 
CËªup
:

397 
	`cú_ch¬buf_de¡roy
(&
Ãwçû
);

398 
	`cú_ch¬buf_de¡roy
(&
sigÃd_šfo
);

399 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

400 
	`cú_ch¬buf_de¡roy
(&
»suÉbuf
);

401 
	`cú_ch¬buf_de¡roy
(&
Çme
);

402 
	`cú_çû_š¡ªû_de¡roy
(&
Ãw_çû_š¡ªû
);

403  (
NULL
);

404 
	}
}

415 
	$»gi¡”_uÄegi¡”_´efix
(
cú
 *
h
,

416 
cú_key¡Üe
 *
key¡Üe
,

417 
İ”©iÚ
,

418 
cú_ch¬buf
 *
Çme_´efix
,

419 
cú_çû_š¡ªû
 *
çû_š¡ªû
,

420 
æags
)

422 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

423 
cú_ch¬buf
 *
»suÉbuf
 = 
NULL
;

424 
cú_ch¬buf
 *
sigÃd_šfo
 = 
NULL
;

425 
cú_ch¬buf
 *
Çme
 = 
NULL
;

426 
cú_ch¬buf
 *
´efix»g
 = 
NULL
;

427 
cú_·r£d_CÚ‹ÁObjeù
 
pcobuf
 = {0};

428 
cú_fÜw¬dšg_’Œy
 
fÜw¬dšg_’Œy_¡Üage
 = {0};

429 
cú_fÜw¬dšg_’Œy
 *
fÜw¬dšg_’Œy
 = &
fÜw¬dšg_’Œy_¡Üage
;

430 
cú_fÜw¬dšg_’Œy
 *
Ãw_fÜw¬dšg_’Œy
;

431 cÚ¡ *
±r
 = 
NULL
;

432 
size_t
 
Ëngth
 = 0;

433 
»s
;

436 
fÜw¬dšg_’Œy
->
aùiÚ
 = (
İ”©iÚ
 =ğ
OP_REG
) ? "prefixreg" : "unreg";

437 
fÜw¬dšg_’Œy
->
Çme_´efix
 =‚ame_prefix;

438 
fÜw¬dšg_’Œy
->
cúd_id
 = 
çû_š¡ªû
->ccnd_id;

439 
fÜw¬dšg_’Œy
->
cúd_id_size
 = 
çû_š¡ªû
->ccnd_id_size;

440 
fÜw¬dšg_’Œy
->
çûid
 = 
çû_š¡ªû
->faceid;

441 
fÜw¬dšg_’Œy
->
æags
 = flags;

442 
fÜw¬dšg_’Œy
->
liãtime
 = (~0U) >> 1;

444 
´efix»g
 = 
	`cú_ch¬buf_ü—‹
();

445 
	`ON_NULL_CLEANUP
(
´efix»g
);

446 
	`ON_ERROR_CLEANUP
(
	`cúb_­³nd_fÜw¬dšg_’Œy
(
´efix»g
, 
fÜw¬dšg_’Œy
));

447 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

448 
	`ON_NULL_CLEANUP
(
‹mp
);

449 
sigÃd_šfo
 = 
	`sigÃd_šfo_ü—‹
(
key¡Üe
);

450 
	`ON_NULL_CLEANUP
(
sigÃd_šfo
);

451 
»s
 = 
	`cú_’code_CÚ‹ÁObjeù
(
‹mp
,

452 
no_Çme
,

453 
sigÃd_šfo
,

454 
´efix»g
->
buf
,

455 
´efix»g
->
Ëngth
,

456 
NULL
,

457 
	`cú_key¡Üe_´iv©e_key
(
key¡Üe
));

458 
	`ON_ERROR_CLEANUP
(
»s
);

459 
»suÉbuf
 = 
	`cú_ch¬buf_ü—‹
();

460 
	`ON_NULL_CLEANUP
(
»suÉbuf
);

461 
Çme
 = 
	`cú_ch¬buf_ü—‹
();

462 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_š™
(
Çme
));

463 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_­³nd_¡r
(
Çme
, "ccnx"));

464 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_­³nd
(
Çme
, 
çû_š¡ªû
->
cúd_id
, faû_š¡ªû->
cúd_id_size
));

465 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_­³nd_¡r
(
Çme
, (
İ”©iÚ
 =ğ
OP_REG
) ? "prefixreg" : "unreg"));

466 
	`ON_ERROR_CLEANUP
(
	`cú_Çme_­³nd
(
Çme
, 
‹mp
->
buf
,emp->
Ëngth
));

467 
»s
 = 
	`cú_g‘
(
h
, 
Çme
, 
loÿl_scİe_‹m¶©e
, 1000, 
»suÉbuf
, &
pcobuf
, 
NULL
, 0);

468 
	`ON_ERROR_CLEANUP
(
»s
);

469 
	`ON_ERROR_CLEANUP
(
	`cú_cÚ‹Á_g‘_v®ue
(
»suÉbuf
->
buf
,„esuÉbuf->
Ëngth
, &
pcobuf
, &
±r
, &length));

470 
Ãw_fÜw¬dšg_’Œy
 = 
	`cú_fÜw¬dšg_’Œy_·r£
(
±r
, 
Ëngth
);

471 
	`ON_NULL_CLEANUP
(
Ãw_fÜw¬dšg_’Œy
);

473 
»s
 = 
Ãw_fÜw¬dšg_’Œy
->
çûid
;

475 
	`cú_fÜw¬dšg_’Œy_de¡roy
(&
Ãw_fÜw¬dšg_’Œy
);

476 
	`cú_ch¬buf_de¡roy
(&
sigÃd_šfo
);

477 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

478 
	`cú_ch¬buf_de¡roy
(&
»suÉbuf
);

479 
	`cú_ch¬buf_de¡roy
(&
Çme
);

480 
	`cú_ch¬buf_de¡roy
(&
´efix»g
);

482  (
»s
);

487 
CËªup
:

488 
	`cú_ch¬buf_de¡roy
(&
sigÃd_šfo
);

489 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

490 
	`cú_ch¬buf_de¡roy
(&
»suÉbuf
);

491 
	`cú_ch¬buf_de¡roy
(&
Çme
);

492 
	`cú_ch¬buf_de¡roy
(&
´efix»g
);

495 
	}
}

498 
	$´oûss_commªd_tok’s
(
´efix_çû_li¡_™em
 *
pæ
,

499 
lš’o
,

500 *
cmd
,

501 *
uri
,

502 *
´Ùo
,

503 *
ho¡
,

504 *
pÜt
,

505 *
æags
,

506 *
mÿ¡‰l
,

507 *
mÿ¡if
)

509 
liãtime
;

510 
cú_ch¬buf
 *
´efix
;

511 
´Ùo
;

512 
sockty³
;

513 
iæags
;

514 
imÿ¡‰l
;

515 
rho¡Çmebuf
[
NI_MAXHOST
];

516 
rho¡pÜtbuf
[
NI_MAXSERV
];

517 
addršfo
 
hšts
 = {.
ai_çmy
 = 
AF_UNSPEC
, .
ai_æags
 = (
AI_ADDRCONFIG
)};

518 
addršfo
 
mÿ¡hšts
 = {.
ai_çmy
 = 
AF_UNSPEC
, .
ai_æags
 = (
AI_ADDRCONFIG
 | 
AI_NUMERICHOST
)};

519 
addršfo
 *
¿ddršfo
 = 
NULL
;

520 
addršfo
 *
mÿ¡içddršfo
 = 
NULL
;

521 
´efix_çû_li¡_™em
 *
pæp
;

522 
»s
;

524 ià(
cmd
 =ğ
NULL
) {

525 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), missšg commªd\n", 
lš’o
);

528 ià(
	`¡rÿ£cmp
(
cmd
, "add") == 0)

529 
liãtime
 = (~0U) >> 1;

530 ià(
	`¡rÿ£cmp
(
cmd
, "del") == 0)

531 
liãtime
 = 0;

533 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), uÄecognized commªd '%s'\n", 
lš’o
, 
cmd
);

537 ià(
uri
 =ğ
NULL
) {

538 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), missšg CCNx URI\n", 
lš’o
);

541 
´efix
 = 
	`cú_ch¬buf_ü—‹
();

542 
»s
 = 
	`cú_Çme_äom_uri
(
´efix
, 
uri
);

543 ià(
»s
 < 0) {

544 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), bad CCNx URI '%s'\n", 
lš’o
, 
uri
);

548 ià(
´Ùo
 =ğ
NULL
) {

549 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), missšg‡dd»s ty³\n", 
lš’o
);

552 ià(
	`¡rÿ£cmp
(
´Ùo
, "udp") == 0) {

553 
´Ùo
 = 
IPPROTO_UDP
;

554 
sockty³
 = 
SOCK_DGRAM
;

556 ià(
	`¡rÿ£cmp
(
´Ùo
, "tcp") == 0) {

557 
´Ùo
 = 
IPPROTO_TCP
;

558 
sockty³
 = 
SOCK_STREAM
;

561 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), uÄecognized‡dd»s ty³ '%s'\n", 
lš’o
, 
´Ùo
);

565 ià(
ho¡
 =ğ
NULL
) {

566 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), missšg ho¡Çme\n", 
lš’o
);

570 ià(
pÜt
 =ğ
NULL
 ||…ort[0] == 0)

571 
pÜt
 = 
CCN_DEFAULT_UNICAST_PORT
;

573 
hšts
.
ai_sockty³
 = 
sockty³
;

574 
»s
 = 
	`g‘addršfo
(
ho¡
, 
pÜt
, &
hšts
, &
¿ddršfo
);

575 ià(
»s
 !ğ0 || 
¿ddršfo
 =ğ
NULL
) {

576 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), g‘addršfo: %s\n", 
lš’o
, 
	`gai_¡»¼Ü
(
»s
));

579 
»s
 = 
	`g‘Çmešfo
(
¿ddršfo
->
ai_addr
,„addršfo->
ai_add¾’
,

580 
rho¡Çmebuf
, (rhostnamebuf),

581 
rho¡pÜtbuf
, (rhostportbuf),

582 
NI_NUMERICHOST
 | 
NI_NUMERICSERV
);

583 
	`ä“addršfo
(
¿ddršfo
);

584 ià(
»s
 != 0) {

585 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), g‘Çmešfo: %s\n", 
lš’o
, 
	`gai_¡»¼Ü
(
»s
));

589 
iæags
 = -1;

590 ià(
æags
 !ğ
NULL
 && flags[0] != 0) {

591 
iæags
 = 
	`©oi
(
æags
);

592 ià((
iæags
 & ~
CCN_FORW_PUBMASK
) != 0) {

593 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), inv®id fÏg 0x%x\n", 
lš’o
, 
iæags
);

598 
imÿ¡‰l
 = -1;

599 ià(
mÿ¡‰l
 !ğ
NULL
) {

600 
imÿ¡‰l
 = 
	`©oi
(
mÿ¡‰l
);

601 ià(
imÿ¡‰l
 < 0 || imcastttl > 255) {

602 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), inv®id muÉiÿ¡: %s\n", 
lš’o
, 
mÿ¡‰l
);

607 ià(
mÿ¡if
 !ğ
NULL
) {

608 
»s
 = 
	`g‘addršfo
(
mÿ¡if
, 
NULL
, &
mÿ¡hšts
, &
mÿ¡içddršfo
);

609 ià(
»s
 != 0) {

610 
	`cúdc_w¬n
(
__LINE__
, "commªdƒ¼Ü (lš%d), mÿ¡içdd¸g‘addršfo: %s\n", 
lš’o
, 
	`gai_¡»¼Ü
(
»s
));

616 
pæp
 = 
	`´efix_çû_li¡_™em_ü—‹
(
´efix
, 
´Ùo
, 
imÿ¡‰l
, 
rho¡Çmebuf
, 
rho¡pÜtbuf
, 
mÿ¡if
, 
liãtime
, 
iæags
);

617 ià(
pæp
 =ğ
NULL
) {

618 
	`cúdc_çl
(
__LINE__
, "Unableo‡llocate…refix_face_list_item\n");

620 
pæ
->
Ãxt
 = 
pæp
;

622 
	}
}

625 
	$»ad_cÚfigfe
(cÚ¡ *
f’ame
, 
´efix_çû_li¡_™em
 *
pæ
)

627 
cÚfig”rÜs
 = 0;

628 
lš’o
 = 0;

629 *
cmd
;

630 *
uri
;

631 *
´Ùo
;

632 *
ho¡
;

633 *
pÜt
;

634 *
æags
;

635 *
mÿ¡‰l
;

636 *
mÿ¡if
;

637 
FILE
 *
cfg
;

638 
buf
[1024];

639 cÚ¡ *
£ps
 = " \t\n";

640 *
ı
 = 
NULL
;

641 *
Ï¡
 = 
NULL
;

642 
»s
;

644 
cfg
 = 
	`fİ’
(
f’ame
, "r");

645 ià(
cfg
 =ğ
NULL
)

646 
	`cúdc_çl
(
__LINE__
, "% (%s)\n", 
	`¡»¼Ü
(
”ºo
), 
f’ame
);

648 
	`fg‘s
((*)
buf
, (buf), 
cfg
)) {

649 
Ën
;

650 
lš’o
++;

651 
Ën
 = 
	`¡¾’
(
buf
);

652 ià(
buf
[0] =ğ'#' || 
Ën
 == 0)

654 ià(
buf
[
Ën
 - 1] == '\n')

655 
buf
[
Ën
 - 1] = '\0';

656 
ı
 = 
	`šdex
(
buf
, '#');

657 ià(
ı
 !ğ
NULL
)

658 *
ı
 = '\0';

660 
cmd
 = 
	`¡¹ok_r
(
buf
, 
£ps
, &
Ï¡
);

661 ià(
cmd
 =ğ
NULL
)

663 
uri
 = 
	`¡¹ok_r
(
NULL
, 
£ps
, &
Ï¡
);

664 
´Ùo
 = 
	`¡¹ok_r
(
NULL
, 
£ps
, &
Ï¡
);

665 
ho¡
 = 
	`¡¹ok_r
(
NULL
, 
£ps
, &
Ï¡
);

666 
pÜt
 = 
	`¡¹ok_r
(
NULL
, 
£ps
, &
Ï¡
);

667 
æags
 = 
	`¡¹ok_r
(
NULL
, 
£ps
, &
Ï¡
);

668 
mÿ¡‰l
 = 
	`¡¹ok_r
(
NULL
, 
£ps
, &
Ï¡
);

669 
mÿ¡if
 = 
	`¡¹ok_r
(
NULL
, 
£ps
, &
Ï¡
);

670 
»s
 = 
	`´oûss_commªd_tok’s
(
pæ
, 
lš’o
, 
cmd
, 
uri
, 
´Ùo
, 
ho¡
, 
pÜt
, 
æags
, 
mÿ¡‰l
, 
mÿ¡if
);

671 ià(
»s
 < 0) {

672 
cÚfig”rÜs
--;

674 
pæ
 =…æ->
Ãxt
;

677 
	`fşo£
(
cfg
);

678  (
cÚfig”rÜs
);

679 
	}
}

680 
	$qu”y_¤v
(cÚ¡ *
domaš
, 
domaš_size
,

681 **
ho¡p
, *
pÜ
, **
´Ùo
)

684 
HEADER
 
h—d”
;

685 
buf
[
NS_MAXMSG
];

686 } 
ªs
;

687 
ssize_t
 
ªs_size
;

688 
¤v_Çme
[
NS_MAXDNAME
];

689 
qdcouÁ
, 
ªcouÁ
, 
i
;

690 *
msg
, *
msg’d
;

691 *
’d
;

692 
ty³
 = 0, 
şass
 = 0, 
‰l
 = 0, 
size
 = 0, 
´iÜ™y
 = 0, 
weight
 = 0, 
pÜt
 = 0, 
mš´iÜ™y
;

693 
ho¡
[
NS_MAXDNAME
];

695 
	`»s_š™
();

701 *
´Ùo
 = "tcp";

702 
	`¢´štf
(
¤v_Çme
, (¤v_Çme), "_cúx._tı.%.*s", ()
domaš_size
, 
domaš
);

703 
ªs_size
 = 
	`»s_qu”y
(
¤v_Çme
, 
C_IN
, 
T_SRV
, 
ªs
.
buf
, (ans.buf));

704 ià(
ªs_size
 < 0) {

705 *
´Ùo
 = "udp";

706 
	`¢´štf
(
¤v_Çme
, (¤v_Çme), "_cúx._udp.%.*s", ()
domaš_size
, 
domaš
);

707 
ªs_size
 = 
	`»s_qu”y
(
¤v_Çme
, 
C_IN
, 
T_SRV
, 
ªs
.
buf
, (ans.buf));

708 ià(
ªs_size
 < 0)

711 ià(
ªs_size
 > (
ªs
.
buf
))

715 
qdcouÁ
 = 
	`Áohs
(
ªs
.
h—d”
.qdcount);

716 
ªcouÁ
 = 
	`Áohs
(
ªs
.
h—d”
.ancount);

717 
msg
 = 
ªs
.
buf
 + ×ns.
h—d”
);

718 
msg’d
 = 
ªs
.
buf
 + 
ªs_size
;

720 
i
 = 
qdcouÁ
; i > 0; --i) {

721 ià((
size
 = 
	`dn_skÇme
(
msg
, 
msg’d
)) < 0)

723 
msg
 = msg + 
size
 + 
QFIXEDSZ
;

730 
mš´iÜ™y
 = 
INT_MAX
;

731 
i
 = 
ªcouÁ
; i > 0; --i) {

732 
size
 = 
	`dn_ex·nd
(
ªs
.
buf
, 
msg’d
, 
msg
, 
¤v_Çme
,  (srv_name));

733 ià(
size
 < 0)

734  (
CCN_UPCALL_RESULT_ERR
);

735 
msg
 = msg + 
size
;

736 
	`GETSHORT
(
ty³
, 
msg
);

737 
	`GETSHORT
(
şass
, 
msg
);

738 
	`GETLONG
(
‰l
, 
msg
);

739 
	`GETSHORT
(
size
, 
msg
);

740 ià((
’d
 = 
msg
 + 
size
è> 
msg’d
)

743 ià(
ty³
 !ğ
T_SRV
) {

744 
msg
 = 
’d
;

753 
	`GETSHORT
(
´iÜ™y
, 
msg
);

754 ià(
´iÜ™y
 < 
mš´iÜ™y
) {

755 
mš´iÜ™y
 = 
´iÜ™y
;

756 
	`GETSHORT
(
weight
, 
msg
);

757 
	`GETSHORT
(
pÜt
, 
msg
);

758 
size
 = 
	`dn_ex·nd
(
ªs
.
buf
, 
msg’d
, 
msg
, 
ho¡
,  (host));

759 ià(
size
 < 0)

762 
msg
 = 
’d
;

764 ià(
ho¡p
) {

765 
size
 = 
	`¡¾’
(
ho¡
);

766 *
ho¡p
 = 
	`ÿÎoc
(1, 
size
);

767 ià(!*
ho¡p
)

769 
	`¡ºıy
(*
ho¡p
, 
ho¡
, 
size
);

771 ià(
pÜ
) {

772 *
pÜ
 = 
pÜt
;

775 
	}
}

778 
	$´oûss_´efix_çû_li¡_™em
(
cú
 *
h
,

779 
cú_key¡Üe
 *
key¡Üe
,

780 
´efix_çû_li¡_™em
 *
pæ
)

782 
cú_çû_š¡ªû
 *
nfi
;

783 
cú_ch¬buf
 *
‹mp
;

784 
İ
;

785 
»s
;

787 
İ
 = (
pæ
->
fi
->
liãtime
 > 0è? 
OP_REG
 : 
OP_UNREG
;

788 
pæ
->
fi
->
cúd_id
 = 
cúdid
;

789 
pæ
->
fi
->
cúd_id_size
 = 
cúdid_size
;

790 
nfi
 = 
	`ü—‹_çû
(
h
, 
key¡Üe
, 
pæ
->
fi
);

791 ià(
nfi
 =ğ
NULL
) {

792 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

793 
	`cú_uri_­³nd
(
‹mp
, 
pæ
->
´efix
->
buf
,…æ->´efix->
Ëngth
, 1);

794 
	`cúdc_w¬n
(
__LINE__
, "Unableo create face for %s %s %s %s %s\n",

795 (
İ
 =ğ
OP_REG
è? "add" : "d–", 
	`cú_ch¬buf_as_¡ršg
(
‹mp
),

796 (
pæ
->
fi
->
desü
.
´Ùo
 =ğ
IPPROTO_UDP
) ? "udp" : "tcp",

797 
pæ
->
fi
->
desü
.
add»ss
,

798 
pæ
->
fi
->
desü
.
pÜt
);

799 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

803 
»s
 = 
	`»gi¡”_uÄegi¡”_´efix
(
h
, 
key¡Üe
, 
İ
, 
pæ
->
´efix
, 
nfi
,…æ->
æags
);

804 ià(
»s
 < 0) {

805 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

806 
	`cú_uri_­³nd
(
‹mp
, 
pæ
->
´efix
->
buf
,…æ->´efix->
Ëngth
, 1);

807 
	`cúdc_w¬n
(
__LINE__
, "Unableo %sregister…refix on face %d for %s %s %s %s %s\n",

808 (
İ
 =ğ
OP_UNREG
è? "un" : "", 
nfi
->
çûid
,

809 (
İ
 =ğ
OP_REG
) ? "add" : "del",

810 
	`cú_ch¬buf_as_¡ršg
(
‹mp
),

811 (
pæ
->
fi
->
desü
.
´Ùo
 =ğ
IPPROTO_UDP
) ? "udp" : "tcp",

812 
pæ
->
fi
->
desü
.
add»ss
,

813 
pæ
->
fi
->
desü
.
pÜt
);

814 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

817 
	`cú_çû_š¡ªû_de¡roy
(&
nfi
);

819 
	}
}

821 
cú_upÿÎ_»s


822 
	$šcomšg_š‹»¡
(

823 
cú_şosu»
 *
£lå
,

824 
cú_upÿÎ_kšd
 
kšd
,

825 
cú_upÿÎ_šfo
 *
šfo
)

827 cÚ¡ *
cúb
 = 
šfo
->
š‹»¡_cúb
;

828 
cú_šdexbuf
 *
comps
 = 
šfo
->
š‹»¡_comps
;

829 
cú_key¡Üe
 *
key¡Üe
 = 
£lå
->
d©a
;

830 cÚ¡ *
comp0
 = 
NULL
;

831 
size_t
 
comp0_size
 = 0;

832 
´efix_çû_li¡_™em
 
pæ_¡Üage
 = {0};

833 
´efix_çû_li¡_™em
 *
pæh—d
 = &
pæ_¡Üage
;

834 
cú_ch¬buf
 *
uri
;

835 
pÜt
;

836 
pÜt¡ršg
[10];

837 *
ho¡
;

838 *
´Ùo
;

839 
»s
;

841 ià(
kšd
 =ğ
CCN_UPCALL_FINAL
)

842  (
CCN_UPCALL_RESULT_OK
);

843 ià(
kšd
 !ğ
CCN_UPCALL_INTEREST
)

844  (
CCN_UPCALL_RESULT_ERR
);

845 ià(
comps
->
n
 < 1)

846  (
CCN_UPCALL_RESULT_OK
);

849 
»s
 = 
	`cú_»f_gged_BLOB
(
CCN_DTAG_CompÚ’t
, 
cúb
, 
comps
->
buf
[0], comps->buf[1],

850 &
comp0
, &
comp0_size
);

851 ià(
»s
 < 0 || 
comp0_size
 > (
NS_MAXDNAME
 - 12))

852  (
CCN_UPCALL_RESULT_OK
);

853 ià(
	`memchr
(
comp0
, '.', 
comp0_size
è=ğ
NULL
)

854  (
CCN_UPCALL_RESULT_OK
);

856 
ho¡
 = 
NULL
;

857 
pÜt
 = 0;

858 
»s
 = 
	`qu”y_¤v
(
comp0
, 
comp0_size
, &
ho¡
, &
pÜt
, &
´Ùo
);

859 ià(
»s
 < 0) {

860 
	`ä“
(
ho¡
);

861  (
CCN_UPCALL_RESULT_ERR
);

864 
uri
 = 
	`cú_ch¬buf_ü—‹
();

865 
	`cú_ch¬buf_­³nd_¡ršg
(
uri
, "ccnx:/");

866 
	`cú_uri_­³nd_³rûÁesÿ³d
(
uri
, 
comp0
, 
comp0_size
);

867 
	`¢´štf
(
pÜt¡ršg
, ÕÜt¡ršg), "%d", 
pÜt
);

871 
»s
 = 
	`´oûss_commªd_tok’s
(
pæh—d
, 0,

873 
	`cú_ch¬buf_as_¡ršg
(
uri
),

874 
´Ùo
,

875 
ho¡
,

876 
pÜt¡ršg
,

877 
NULL
, NULL, NULL);

878 ià(
»s
 < 0)

879  (
CCN_UPCALL_RESULT_ERR
);

881 
	`´oûss_´efix_çû_li¡_™em
(
šfo
->
h
, 
key¡Üe
, 
pæh—d
->
Ãxt
);

882 
	`´efix_çû_li¡_de¡roy
(&
pæh—d
->
Ãxt
);

883 (
CCN_UPCALL_RESULT_OK
);

884 
	}
}

888 
	$maš
(
¬gc
, **
¬gv
)

890 
cú
 *
h
 = 
NULL
;

891 
cú_ch¬buf
 *
‹mp
 = 
NULL
;

892 cÚ¡ *
´ogÇme
 = 
NULL
;

893 cÚ¡ *
cÚfigfe
 = 
NULL
;

894 
´efix_çû_li¡_™em
 
pæ_¡Üage
 = {0};

895 
´efix_çû_li¡_™em
 *
pæh—d
 = &
pæ_¡Üage
;

896 
´efix_çû_li¡_™em
 *
pæ
;

897 
cú_key¡Üe
 *
key¡Üe
 = 
NULL
;

898 
dyÇmic
 = 0;

899 
cú_şosu»
 
š‹»¡_şosu»
 = {.
p
=&
šcomšg_š‹»¡
};

900 
»s
;

901 
ch
;

903 
	`š™Ÿlize_glob®_d©a
();

905 
´ogÇme
 = 
¬gv
[0];

906 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "hf:dv")) != -1) {

907 
ch
) {

909 
cÚfigfe
 = 
İrg
;

912 
dyÇmic
 = 1;

915 
v”bo£
++;

919 
	`u§ge
(
´ogÇme
);

923 ià(
İtšd
 < 
¬gc
) {

925 ià(
cÚfigfe
 !ğ
NULL
) {

926 
	`u§ge
(
´ogÇme
);

930 ià(
¬gc
 - 
İtšd
 < 4 ||‡rgc - optind > 8)

931 
	`u§ge
(
´ogÇme
);

933 
»s
 = 
	`´oûss_commªd_tok’s
(
pæh—d
, 0,

934 
¬gv
[
İtšd
],

935 
¬gv
[
İtšd
+1],

936 
¬gv
[
İtšd
+2],

937 
¬gv
[
İtšd
+3],

938 (
İtšd
 + 4è< 
¬gc
 ? 
¬gv
[İtšd+4] : 
NULL
,

939 (
İtšd
 + 5è< 
¬gc
 ? 
¬gv
[İtšd+5] : 
NULL
,

940 (
İtšd
 + 6è< 
¬gc
 ? 
¬gv
[İtšd+6] : 
NULL
,

941 (
İtšd
 + 7è< 
¬gc
 ? 
¬gv
[İtšd+7] : 
NULL
);

942 ià(
»s
 < 0)

943 
	`u§ge
(
´ogÇme
);

946 ià(
cÚfigfe
) {

947 
	`»ad_cÚfigfe
(
cÚfigfe
, 
pæh—d
);

950 
h
 = 
	`cú_ü—‹
();

951 
»s
 = 
	`cú_cÚÃù
(
h
, 
NULL
);

952 ià(
»s
 < 0) {

953 
	`cú_³¼Ü
(
h
, "ccn_connect");

954 
	`ex™
(1);

959 
‹mp
 = 
	`cú_ch¬buf_ü—‹
();

960 
key¡Üe
 = 
	`cú_key¡Üe_ü—‹
();

961 
	`ON_ERROR_EXIT
(
	`cú_ch¬buf_putf
(
‹mp
, "%s/.cúx/.cúx_key¡Üe", 
	`g‘’v
("HOME")));

962 
»s
 = 
	`cú_key¡Üe_š™
(
key¡Üe
,

963 
	`cú_ch¬buf_as_¡ršg
(
‹mp
),

965 
	`ON_ERROR_EXIT
(
»s
);

967 
cúdid_size
 = 
	`g‘_cúdid
(
h
, 
cúdid
, (
cúdid_¡Üage
));

968 
pæ
 = 
pæh—d
->
Ãxt
;…æ !ğ
NULL
;…fl =…fl->next) {

969 
	`´oûss_´efix_çû_li¡_™em
(
h
, 
key¡Üe
, 
pæ
);

971 
	`´efix_çû_li¡_de¡roy
(&
pæh—d
->
Ãxt
);

972 ià(
dyÇmic
) {

974 
š‹»¡_şosu»
.
d©a
 = 
key¡Üe
;

975 
	`cú_Çme_š™
(
‹mp
);

976 
	`cú_£t_š‹»¡_f‹r_w™h_æags
(
h
, 
‹mp
, &
š‹»¡_şosu»
,

977 
CCN_FORW_ACTIVE
 | 
CCN_FORW_CHILD_INHERIT
 | 
CCN_FORW_LAST
);

978 
	`cú_ch¬buf_de¡roy
(&
‹mp
);

979 
	`cú_run
(
h
, -1);

981 
	`cú_de¡roy
(&
h
);

982 
	`ex™
(
»s
 < 0);

983 
	}
}

	@libexec/udplink.c

22 
	~<¡dio.h
>

23 
	~<uni¡d.h
>

24 
	~<¡dlib.h
>

25 
	~<¡d¬g.h
>

26 
	~<”ºo.h
>

27 
	~<pŞl.h
>

28 
	~<¡ršg.h
>

29 
	~<sigÇl.h
>

30 
	~<sys/ty³s.h
>

31 
	~<sys/time.h
>

32 
	~<sys/sock‘.h
>

33 
	~<Ãtš‘/š.h
>

34 
	~<¬·/š‘.h
>

35 
	~<Ãt/if.h
>

36 
	~<Ãtdb.h
>

38 #ià
defšed
(
NEED_GETADDRINFO_COMPAT
)

39 
	~"g‘addršfo.h
"

40 
	~"dummyš6.h
"

42 #iâdeà
AI_ADDRCONFIG


43 
	#AI_ADDRCONFIG
 0

	)

46 
	~<cú/cú.h
>

47 
	~<cú/cúd.h
>

49 
ud¶šk_çl
(
lše
, *
fÜm©
, ...);

51 
	#UDPMAXBUF
 8800

	)

53 #ifdeà
__CYGWIN__


55 
	$if_Çm‘ošdex
(cÚ¡ *
iâame
) {

56 
	`ud¶šk_çl
(
__LINE__
, "interface‚ame unsupported on cygwin");

58 
	}
}

61 
	sİtiÚs
 {

62 cÚ¡ *
	mloÿlsockÇme
;

63 cÚ¡ *
	m»mÙeho¡Çme
;

64 
addršfo
 *
	mloÿlif_fÜ_mÿ¡_addršfo
;

65 
	m»mÙ•Üt
[8];

66 
	mloÿÍÜt
[8];

67 
	m»mÙeifšdex
;

68 
	mmuÉiÿ¡‰l
;

69 
	mloggšg
;

70 } 
	gİtiÚs
 = {
NULL
, NULL, NULL, "", "", 0, 0, 0};

81 
	$u§ge
(*
Çme
) {

82 
	`årštf
(
¡d”r
, "U§ge: % [-dÓbug)] [-øcúsock‘] -h„emÙeho¡ -¸»mÙ•Üˆ[-ÈloÿÍÜt] [-m muÉiÿ¡loÿÏdd»ss] [-ˆmuÉiÿ¡‰l]\n", 
Çme
);

83 
	}
}

86 
	$ud¶šk_çl
(
lše
, *
fÜm©
, ...)

88 
timev®
 
t
;

89 
va_li¡
 
­
;

90 
	`va_¡¬t
(
­
, 
fÜm©
);

91 
	`g‘timeofday
(&
t
, 
NULL
);

92 
	`årštf
(
¡d”r
, "%d.%06d ud¶šk[%d]†š%d: ", ()
t
.
tv_£c
, (é.
tv_u£c
, 
	`g‘pid
(), 
lše
);

93 
	`vårštf
(
¡d”r
, 
fÜm©
, 
­
);

94 
	`va_’d
(
­
);

95 
	`ex™
(1);

96 
	}
}

99 
	$ud¶šk_nÙe
(*
fÜm©
, ...)

101 
timev®
 
t
;

102 
va_li¡
 
­
;

103 
	`va_¡¬t
(
­
, 
fÜm©
);

104 
	`g‘timeofday
(&
t
, 
NULL
);

105 
	`årštf
(
¡d”r
, "%d.%06d ud¶šk[%d]: ", ()
t
.
tv_£c
, (é.
tv_u£c
, 
	`g‘pid
());

106 
	`vårštf
(
¡d”r
, 
fÜm©
, 
­
);

107 
	`va_’d
(
­
);

108 
	}
}

111 
	$ud¶šk_´št_d©a
(*
sourû
, *
d©a
, 
¡¬t
, 
Ëngth
, 
loggšg
)

113 
i
;

115 
	`ud¶šk_nÙe
("%d by‹ äom %s", 
Ëngth
, 
sourû
);

116 ià(
loggšg
 > 2) {

117 
	`årštf
(
¡d”r
, ":");

118 
i
 = 0; i < 
Ëngth
; i++) {

119 ià((
i
 % 20è=ğ0è
	`årštf
(
¡d”r
, "\n%4d: ", i);

120 ià(((
i
 + 10è% 20è=ğ0è
	`årštf
(
¡d”r
, "| ");

121 
	`årštf
(
¡d”r
, "%02x ", 
d©a
[
i
 + 
¡¬t
]);

124 
	`årštf
(
¡d”r
, "\n");

125 
	}
}

127 
ssize_t


128 
	$£nd_»mÙe_uÃnÿpsuÏ‹d
(
s
, 
addršfo
 *
r
, *
buf
, 
size_t
 
¡¬t
, size_ˆ
Ëngth
) {

129 
ssize_t
 
»suÉ
;

131 ià(
	`memcmp
(&
buf
[
¡¬t
], 
CCN_EMPTY_PDU
, 
CCN_EMPTY_PDU_LENGTH
 - 1) != 0) {

134 
»suÉ
 = 
	`£ndto
(
s
, 
buf
 + 
CCN_EMPTY_PDU_LENGTH
 - 1 + 
¡¬t
, 
Ëngth
 - CCN_EMPTY_PDU_LENGTH,

135 0, 
r
->
ai_addr
,„->
ai_add¾’
);

136  (
»suÉ
);

137 
	}
}

139 
	$´oûss_İtiÚs
(
¬gc
, * cÚ¡ 
¬gv
[], 
İtiÚs
 *
İt
) {

140 
c
;

141 *
ı
 = 
NULL
;

142 *
½Üt¡r
 = 
NULL
;

143 *
ÍÜt¡r
 = 
NULL
;

144 *
mÿ¡out¡r
 = 
NULL
;

145 *
‰l¡r
 = 
NULL
;

146 
addršfo
 
hšts
 = {0};

147 
»suÉ
;

148 
n
;

150 (
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "dc:h:r:l:m:t:")) != -1) {

151 
c
) {

153 
İt
->
loggšg
++;

156 
İt
->
loÿlsockÇme
 = 
İrg
;

159 
İt
->
»mÙeho¡Çme
 = 
İrg
;

162 
½Üt¡r
 = 
İrg
;

165 
ÍÜt¡r
 = 
İrg
;

168 
mÿ¡out¡r
 = 
İrg
;

171 
‰l¡r
 = 
İrg
;

177 ià(
İt
->
»mÙeho¡Çme
 =ğ
NULL
 || 
½Üt¡r
 == NULL) {

178 
	`u§ge
(
¬gv
[0]);

179 
	`ex™
(1);

182 ià(
	`¡r¥n
(
½Üt¡r
, "0123456789"è!ğ
	`¡¾’
(rportstr)) {

183 
	`u§ge
(
¬gv
[0]);

184 
	`ex™
(1);

187 
n
 = 
	`©oi
(
½Üt¡r
);

188 ià(
n
 <= 0 ||‚ >= 65536) {

189 
	`u§ge
(
¬gv
[0]);

190 
	`ex™
(1);

192 
	`¥rštf
(
İt
->
»mÙ•Üt
, "%d", 
n
);

194 ià(
ÍÜt¡r
 !ğ
NULL
) {

195 ià(
	`¡r¥n
(
ÍÜt¡r
, "0123456789"è!ğ
	`¡¾’
(lportstr)) {

196 
	`u§ge
(
¬gv
[0]);

197 
	`ex™
(1);

199 
n
 = 
	`©oi
(
ÍÜt¡r
);

200 ià(
n
 <= 0 ||‚ >= 65536) {

201 
	`u§ge
(
¬gv
[0]);

202 
	`ex™
(1);

205 
	`¥rštf
(
İt
->
loÿÍÜt
, "%d", 
n
);

207 ià(
mÿ¡out¡r
 !ğ
NULL
) {

208 
hšts
.
ai_çmy
 = 
PF_INET
;

209 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

210 
hšts
.
ai_æags
 = 
AI_NUMERICHOST
;

211 #ifdeà
AI_NUMERICSERV


212 
hšts
.
ai_æags
 |ğ
AI_NUMERICSERV
;

214 
	`ud¶šk_nÙe
("š‹rçû % »que¡ed (pÜˆ%s)\n", 
mÿ¡out¡r
, 
İt
->
loÿÍÜt
);

215 
»suÉ
 = 
	`g‘addršfo
(
mÿ¡out¡r
, 
İt
->
loÿÍÜt
, &
hšts
, &İt->
loÿlif_fÜ_mÿ¡_addršfo
);

216 ià(
»suÉ
 !ğ0 || 
İt
->
loÿlif_fÜ_mÿ¡_addršfo
 =ğ
NULL
) {

217 
	`ud¶šk_çl
(
__LINE__
, "g‘addršfo(\"%s\", ...): %s\n", 
mÿ¡out¡r
, 
	`gai_¡»¼Ü
(
»suÉ
));

221 ià(
‰l¡r
 !ğ
NULL
) {

222 ià(
	`¡r¥n
(
‰l¡r
, "0123456789"è!ğ
	`¡¾’
(ttlstr)) {

223 
	`u§ge
(
¬gv
[0]);

224 
	`ex™
(1);

226 
İt
->
muÉiÿ¡‰l
 = 
	`©oi
(
‰l¡r
);

227 ià(
İt
->
muÉiÿ¡‰l
 < 1 || opt->multicastttl > 255) {

228 
	`u§ge
(
¬gv
[0]);

229 
	`ex™
(1);

233 
ı
 = 
	`¡rchr
(
İt
->
»mÙeho¡Çme
, '%');

234 ià(
ı
 !ğ
NULL
) {

235 
ı
++;

236 
”ºo
 = 0;

237 
İt
->
»mÙeifšdex
 = 
	`©oi
(
ı
);

238 ià(
İt
->
»mÙeifšdex
 == 0) {

239 
İt
->
»mÙeifšdex
 = 
	`if_Çm‘ošdex
(
ı
);

240 ià(
İt
->
»mÙeifšdex
 =ğ0 && 
”ºo
 != 0) {

241 
	`ud¶šk_çl
(
__LINE__
, "Inv®id iÁ”çû‚am%s\n", 
ı
);

245 
	}
}

248 
	$£t_muÉiÿ¡_sockİt
(
sock‘_r
, 
sock‘_w
, 
addršfo
 *
ai
, 
İtiÚs
 *
İt
)

250 
addršfo
 
hšts
;

251 
_m»q
 
m»q
;

252 #ifdeà
IPV6_JOIN_GROUP


253 
v6_m»q
 
m»q6
;

255 
csockİt
;

256 
isockİt
;

257 
»suÉ
;

259 
	`mem£t
((*)&
hšts
, 0, (hints));

260 
	`mem£t
((*)&
m»q
, 0, (mreq));

261 #ifdeà
IPV6_JOIN_GROUP


262 
	`mem£t
((*)&
m»q6
, 0, (mreq6));

265 ià(
ai
->
ai_çmy
 =ğ
PF_INET
 && 
	`IN_MULTICAST
(
	`Áohl
(((
sockaddr_š
 *)×i->
ai_addr
))->
sš_addr
.
s_addr
))) {

266 ià(
İt
->
loggšg
 > 0è
	`ud¶šk_nÙe
("IPv4 multicast\n");

267 #ifdeà
IP_ADD_MEMBERSHIP


268 
	`memıy
((*)&
m»q
.
imr_muÉŸddr
, &((
sockaddr_š
 *)
ai
->
ai_addr
)->
sš_addr
, (mreq.imr_multiaddr));

269 ià(
İt
->
loÿlif_fÜ_mÿ¡_addršfo
 !ğ
NULL
) {

270 
	`memıy
((*)&
m»q
.
imr_š‹rçû
.
s_addr
, &((
sockaddr_š
 *)
İt
->
loÿlif_fÜ_mÿ¡_addršfo
->
ai_addr
)->
sš_addr
, (mreq.imr_interface.s_addr));

272 
»suÉ
 = 
	`£tsockİt
(
sock‘_r
, 
IPPROTO_IP
, 
IP_ADD_MEMBERSHIP
, &
m»q
, (mreq));

273 ià(
»suÉ
 =ğ-1è
	`ud¶šk_çl
(
__LINE__
, "£tsockİt(..., IP_ADD_MEMBERSHIP, ...): %s\n", 
	`¡»¼Ü
(
”ºo
));

275 #ifdeà
IP_MULTICAST_LOOP


276 
csockİt
 = 0;

277 
»suÉ
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IP
, 
IP_MULTICAST_LOOP
, &
csockİt
, (csockopt));

278 ià(
»suÉ
 =ğ-1è
	`ud¶šk_çl
(
__LINE__
, "£tsockİt(..., IP_MULTICAST_LOOP, ...): %s\n", 
	`¡»¼Ü
(
”ºo
));

280 #ifdeà
IP_MULTICAST_TTL


281 ià(
İt
->
muÉiÿ¡‰l
 > 0) {

282 
csockİt
 = 
İt
->
muÉiÿ¡‰l
;

283 
»suÉ
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IP
, 
IP_MULTICAST_TTL
, &
csockİt
, (csockopt));

284 ià(
»suÉ
 == -1) {

285 
	`ud¶šk_çl
(
__LINE__
, "£tsockİt(..., IP_MULTICAST_TTL, ...): %s\n", 
	`¡»¼Ü
(
”ºo
));

289 } ià(
ai
->
ai_çmy
 =ğ
PF_INET6
 && 
	`IN6_IS_ADDR_MULTICAST
((&((
sockaddr_š6
 *ïi->
ai_addr
)->
sš6_addr
))) {

290 ià(
İt
->
loggšg
 > 0è
	`ud¶šk_nÙe
("IPv6 multicast\n");

291 #ifdeà
IPV6_JOIN_GROUP


292 
	`memıy
((*)&
m»q6
.
v6mr_muÉŸddr
, &((
sockaddr_š6
 *)
ai
->
ai_addr
)->
sš6_addr
, (mreq6.ipv6mr_multiaddr));

293 ià(
İt
->
»mÙeifšdex
 > 0) {

294 
m»q6
.
v6mr_š‹rçû
 = 
İt
->
»mÙeifšdex
;

296 
»suÉ
 = 
	`£tsockİt
(
sock‘_r
, 
IPPROTO_IPV6
, 
IPV6_JOIN_GROUP
, &
m»q6
, (mreq6));

297 ià(
»suÉ
 == -1) {

298 
	`ud¶šk_çl
(
__LINE__
, "£tsockİt(..., IPV6_JOIN_GROUP, ...): %s\n", 
	`¡»¼Ü
(
”ºo
));

301 #ifdeà
IPV6_MULTICAST_LOOP


302 
isockİt
 = 0;

303 
»suÉ
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IPV6
, 
IPV6_MULTICAST_LOOP
, &
isockİt
, (isockopt));

304 ià(
»suÉ
 == -1) {

305 
	`ud¶šk_çl
(
__LINE__
, "£tsockİt(..., IPV6_MULTICAST_LOOP, ...): %s\n", 
	`¡»¼Ü
(
”ºo
));

308 #ifdeà
IPV6_MULTICAST_HOPS


309 ià(
İt
->
muÉiÿ¡‰l
 > 0) {

310 
isockİt
 = 
İt
->
muÉiÿ¡‰l
;

311 
»suÉ
 = 
	`£tsockİt
(
sock‘_w
, 
IPPROTO_IPV6
, 
IPV6_MULTICAST_HOPS
, &
isockİt
, (isockopt));

312 ià(
»suÉ
 == -1) {

313 
	`ud¶šk_çl
(
__LINE__
, "£tsockİt(..., IPV6_MULTICAST_LOOP, ...): %s\n", 
	`¡»¼Ü
(
”ºo
));

318 
	}
}

321 
	$chªg–ogËv–
(
s
) {

322 
s
) {

323 
SIGUSR1
:

324 
İtiÚs
.
loggšg
 = 0;

325 
	`ud¶šk_nÙe
("logging disabled\n");

327 
SIGUSR2
:

328 ià(
İtiÚs
.
loggšg
 < 10) options.logging++;

329 
	`ud¶šk_nÙe
("log†ev– %d\n", 
İtiÚs
.
loggšg
);

333 
	}
}

336 
	$maš
 (
¬gc
, * cÚ¡ 
¬gv
[]) {

337 
»suÉ
;

338 
loÿlsock_rw
 = 0;

339 
»mÙesock_w
 = 0;

340 
»mÙesock_r
 = 0;

341 
ÿnÚiÿl_»mÙe
[
NI_MAXHOST
] = "";

342 
addršfo
 *
¿ddršfo
 = 
NULL
;

343 
addršfo
 *
Ïddršfo
 = 
NULL
;

344 
addršfo
 
hšts
 = {0};

345 
pŞlfd
 
fds
[2];

346 
cú
 *ccn;

347 
cú_sk–‘Ú_decod”
 
ldecod”
 = {0};

348 
cú_sk–‘Ú_decod”
 *
ld
 = &
ldecod”
;

349 
cú_sk–‘Ú_decod”
 
rdecod”
 = {0};

350 
cú_sk–‘Ú_decod”
 *
rd
 = &
rdecod”
;

351 
rbuf
[
UDPMAXBUF
];

352 
cú_ch¬buf
 *
ch¬buf
;

353 
ssize_t
 
msg¡¬t
 = 0;

354 
ssize_t
 
d»s
;

355 
sigaùiÚ
 
sigaù_chªg–ogËv–
;

356 *
deã¼edbuf
 = 
NULL
;

357 
size_t
 
deã¼edËn
 = 0;

358 
drİ³d_couÁ
 = 0;

359 
size_t
 
drİ³d_by‹s
 = 0;

360 cÚ¡ 
Úe
 = 1;

362 
	`´oûss_İtiÚs
(
¬gc
, 
¬gv
, &
İtiÚs
);

365 
	`mem£t
(&
sigaù_chªg–ogËv–
, 0, (sigact_changeloglevel));

366 
sigaù_chªg–ogËv–
.
§_hªdËr
 = 
chªg–ogËv–
;

367 
	`sigaùiÚ
(
SIGUSR1
, &
sigaù_chªg–ogËv–
, 
NULL
);

368 
	`sigaùiÚ
(
SIGUSR2
, &
sigaù_chªg–ogËv–
, 
NULL
);

371 
cú
 = 
	`cú_ü—‹
();

372 
loÿlsock_rw
 = 
	`cú_cÚÃù
(
cú
, 
İtiÚs
.
loÿlsockÇme
);

373 ià(
loÿlsock_rw
 == -1) {

374 
	`ud¶šk_çl
(
__LINE__
, "cú_cÚÃù: %s\n", 
	`¡»¼Ü
(
”ºo
));

377 
hšts
.
ai_çmy
 = 
AF_UNSPEC
;

378 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

379 
hšts
.
ai_æags
 = 
AI_ADDRCONFIG
;

380 #ifdeà
AI_NUMERICSERV


381 
hšts
.
ai_æags
 |ğ
AI_NUMERICSERV
;

385 
»suÉ
 = 
	`g‘addršfo
(
İtiÚs
.
»mÙeho¡Çme
, o±iÚs.
»mÙ•Üt
, &
hšts
, &
¿ddršfo
);

386 ià(
»suÉ
 !ğ0 || 
¿ddršfo
 =ğ
NULL
) {

387 
	`ud¶šk_çl
(
__LINE__
, "g‘addršfo(\"%s\", \"%s\", ...): %s\n", 
İtiÚs
.
»mÙeho¡Çme
, o±iÚs.
»mÙ•Üt
, 
	`gai_¡»¼Ü
(
»suÉ
));

390 
	`g‘Çmešfo
(
¿ddršfo
->
ai_addr
,„addršfo->
ai_add¾’
, 
ÿnÚiÿl_»mÙe
, (ÿnÚiÿl_»mÙe), 
NULL
, 0, 0);

393 
hšts
.
ai_çmy
 = 
¿ddršfo
->ai_family;

394 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

395 #ifdeà
AI_NUMERICSERV


396 
hšts
.
ai_æags
 |ğ
AI_NUMERICSERV
;

399 
»suÉ
 = 
	`g‘addršfo
(
NULL
, 
İtiÚs
.
loÿÍÜt
, &
hšts
, &
Ïddršfo
);

400 ià(
»suÉ
 !ğ0 || 
Ïddršfo
 =ğ
NULL
) {

401 
	`ud¶šk_çl
(
__LINE__
, "g‘addršfo(NULL, %s, ...): %s\n", 
İtiÚs
.
loÿÍÜt
, 
	`gai_¡»¼Ü
(
»suÉ
));

418 
»mÙesock_w
 = 
	`sock‘
(
¿ddršfo
->
ai_çmy
,„addršfo->
ai_sockty³
, 0);

419 ià(
»mÙesock_w
 == -1) {

420 
	`ud¶šk_çl
(
__LINE__
, "sock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

422 
»mÙesock_r
 = 
»mÙesock_w
;

424 ià(
İtiÚs
.
loÿlif_fÜ_mÿ¡_addršfo
 !ğ
NULL
) {

428 
»mÙesock_r
 = 
	`sock‘
(
¿ddršfo
->
ai_çmy
,„addršfo->
ai_sockty³
, 0);

429 ià(
»mÙesock_r
 == -1) {

430 
	`ud¶šk_çl
(
__LINE__
, "sock‘: %s\n", 
	`¡»¼Ü
(
”ºo
));

432 
»suÉ
 = 
	`£tsockİt
(
»mÙesock_r
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
Úe
, (one));

433 ià(
»suÉ
 =ğ-1è
	`ud¶šk_çl
(
__LINE__
, "setsockopt(remotesock_r, ..., SO_REUSEADDR, ...)");

436 
»suÉ
 = 
	`bšd
(
»mÙesock_r
, 
¿ddršfo
->
ai_addr
,„addršfo->
ai_add¾’
);

437 ià(
»suÉ
 == -1) {

438 
	`ud¶šk_çl
(
__LINE__
, "bšdÔemÙesock_r,†oÿl...): %s\n", 
	`¡»¼Ü
(
”ºo
));

442 
	`£t_muÉiÿ¡_sockİt
(
»mÙesock_r
, 
»mÙesock_w
, 
¿ddršfo
, &
İtiÚs
);

444 ià(
İtiÚs
.
loÿlif_fÜ_mÿ¡_addršfo
 !ğ
NULL
) {

445 
»suÉ
 = 
	`bšd
(
»mÙesock_w
, 
İtiÚs
.
loÿlif_fÜ_mÿ¡_addršfo
->
ai_addr
, o±iÚs.loÿlif_fÜ_mÿ¡_addršfo->
ai_add¾’
);

447 
»suÉ
 = 
	`bšd
(
»mÙesock_w
, 
Ïddršfo
->
ai_addr
,†addršfo->
ai_add¾’
);

449 ià(
»suÉ
 == -1) {

450 
	`ud¶šk_çl
(
__LINE__
, "bšdÔemÙesock_w,†oÿl...): %s\n", 
	`¡»¼Ü
(
”ºo
));

453 
	`ud¶šk_nÙe
("cÚÃùedØ%s:%s\n", 
ÿnÚiÿl_»mÙe
, 
İtiÚs
.
»mÙ•Üt
);

457 
»suÉ
 = 
	`£nd
(
loÿlsock_rw
, 
CCN_EMPTY_PDU
, 
CCN_EMPTY_PDU_LENGTH
, 0);

458 ià(
»suÉ
 == -1) {

459 
	`ud¶šk_çl
(
__LINE__
, "š™ŸÈ£nd: %s\n", 
	`¡»¼Ü
(
”ºo
));

462 
ch¬buf
 = 
	`cú_ch¬buf_ü—‹
();

464 
fds
[0].
fd
 = 
loÿlsock_rw
;

465 
fds
[0].
ev’ts
 = 
POLLIN
;

466 
fds
[1].
fd
 = 
»mÙesock_r
;

467 
fds
[1].
ev’ts
 = 
POLLIN
;

470 ià(0 =ğ(
»suÉ
 = 
	`pŞl
(
fds
, 2, -1))) ;

471 ià(-1 =ğ
»suÉ
) {

472 ià(
”ºo
 =ğ
EINTR
) ;

473 
	`ud¶šk_çl
(
__LINE__
, "pŞl: %s\n", 
	`¡»¼Ü
(
”ºo
));

476 ià(
fds
[0].
»v’ts
 & (
POLLOUT
)) {

477 
fds
[1].
ev’ts
 |ğ
POLLIN
;

478 
fds
[0].
ev’ts
 &ğ~
POLLOUT
;

479 ià(
deã¼edËn
 > 0) {

480 
»suÉ
 = 
	`£nd
(
loÿlsock_rw
, 
deã¼edbuf
, 
deã¼edËn
, 0);

481 ià(
»suÉ
 =ğ-1 && (
İtiÚs
.
loggšg
 > 1 || 
”ºo
 !ğ
EAGAIN
))

482 
	`ud¶šk_nÙe
("sendto(local, deferredbuf, %ld):"

484 (è
deã¼edËn
, 
	`¡»¼Ü
(
”ºo
));

485 ià(
»suÉ
 =ğ
deã¼edËn
) {

487 ià(
drİ³d_couÁ
 !ğ0 && 
İtiÚs
.
loggšg
 > 0) {

488 
	`ud¶šk_nÙe
("dropped %d from„emote (%ld bytes)\n",

489 
drİ³d_couÁ
, ()
drİ³d_by‹s
);

490 
drİ³d_couÁ
 = 0;

491 
drİ³d_by‹s
 = 0;

493 
deã¼edËn
 = 0;

495 ià(
»suÉ
 > 0) {

496 
	`memmove
(
deã¼edbuf
,

497 
deã¼edbuf
 + 
»suÉ
,

498 
deã¼edËn
 - 
»suÉ
);

499 
deã¼edËn
 -ğ
»suÉ
;

500 
fds
[0].
ev’ts
 |ğ
POLLOUT
;

503 
deã¼edËn
 = 0;

508 ià(
fds
[0].
»v’ts
 & (
POLLIN
)) {

509 *
lbuf
 = 
	`cú_ch¬buf_»£rve
(
ch¬buf
, 32);

510 
ssize_t
 
»cvËn
;

511 
Œ›s
;

512 ià(
ch¬buf
->
Ëngth
 == 0) {

513 
	`mem£t
(
ld
, 0, (*ld));

515 
»cvËn
 = 
	`»cv
(
loÿlsock_rw
, 
lbuf
 , 
ch¬buf
->
lim™
 - ch¬buf->
Ëngth
, 0);

516 ià(
»cvËn
 == -1) {

517 ià(
”ºo
 =ğ
EAGAIN
) ;

518 
	`ud¶šk_çl
(
__LINE__
, "»cvÖoÿlsock_rw, ...): %s\n", 
	`¡»¼Ü
(
”ºo
));

520 ià(
»cvËn
 == 0) {

523 
ch¬buf
->
Ëngth
 +ğ
»cvËn
;

524 
d»s
 = 
	`cú_sk–‘Ú_decode
(
ld
, 
lbuf
, 
»cvËn
);

525 
Œ›s
 = 0;

526 
ld
->
¡©e
 =ğ0 &&†d->
Ã¡
 == 0) {

527 ià(
İtiÚs
.
loggšg
 > 1)

528 
	`ud¶šk_´št_d©a
("loÿl", 
ch¬buf
->
buf
, 
msg¡¬t
, 
ld
->
šdex
 - msg¡¬t, 
İtiÚs
.
loggšg
);

529 
»suÉ
 = 
	`£nd_»mÙe_uÃnÿpsuÏ‹d
(
»mÙesock_w
, 
¿ddršfo
, 
ch¬buf
->
buf
, 
msg¡¬t
, 
ld
->
šdex
 - msgstart);

530 ià(
»suÉ
 == -1) {

531 ià(
”ºo
 =ğ
EAGAIN
) ;

532 ià(
”ºo
 =ğ
EPERM
 && (
Œ›s
++ < 3)) {

534 ià(
İtiÚs
.
loggšg
 > 0)

535 
	`ud¶šk_nÙe
("£ndtoÔemÙesock_w,„buf, %ld): % (wÈ»Œy)\n", (è
ld
->
šdex
 - 
msg¡¬t
, 
	`¡»¼Ü
(
”ºo
));

538 ià(
”ºo
 =ğ
ENOBUFS
) {

540 ià(
İtiÚs
.
loggšg
 > 0)

541 
	`ud¶šk_nÙe
("£ndtoÔemÙesock_w,„buf, %ld): % (mes§gdrİ³d)\n", (è
ld
->
šdex
 - 
msg¡¬t
, 
	`¡»¼Ü
(
”ºo
));

544 
	`ud¶šk_çl
(
__LINE__
, "£ndtoÔemÙesock_w,„buf, %ld): %s\n", ()
ld
->
šdex
 - 
msg¡¬t
, 
	`¡»¼Ü
(
”ºo
));

546 ià(
»suÉ
 == -2) {

547 
	`ud¶šk_nÙe
("protocolƒrror, missing CCNx PDUƒncapsulation. Message dropped\n");

550 
msg¡¬t
 = 
ld
->
šdex
;

551 ià(
msg¡¬t
 =ğ
ch¬buf
->
Ëngth
) {

552 
ch¬buf
->
Ëngth
 = 0;

553 
msg¡¬t
 = 0;

556 
»cvËn
 = 
ch¬buf
->
Ëngth
 - 
msg¡¬t
;

557 
d»s
 = 
	`cú_sk–‘Ú_decode
(
ld
, 
ch¬buf
->
buf
 + 
msg¡¬t
, 
»cvËn
);

559 ià(
ld
->
¡©e
 < 0) {

560 
	`ud¶šk_çl
(
__LINE__
, "local data…rotocolƒrror\n");

563 ià(
msg¡¬t
 < 
ch¬buf
->
Ëngth
 && msgstart > 0) {

564 
	`memmove
(
ch¬buf
->
buf
, ch¬buf->buà+ 
msg¡¬t
, ch¬buf->
Ëngth
 - msgstart);

565 
ch¬buf
->
Ëngth
 -ğ
msg¡¬t
;

566 
ld
->
šdex
 -ğ
msg¡¬t
;

567 
msg¡¬t
 = 0;

572 ià(
fds
[1].
»v’ts
 & (
POLLIN
)) {

573 
sockaddr
 
äom
 = {0};

574 
sockËn_t
 
äomËn
 = (
äom
);

575 
ssize_t
 
»cvËn
;

576 *
»cvbuf
;

577 
addrbuf
[128];

579 
	`memmove
(
rbuf
, 
CCN_EMPTY_PDU
, 
CCN_EMPTY_PDU_LENGTH
 - 1);

580 
»cvbuf
 = &
rbuf
[
CCN_EMPTY_PDU_LENGTH
 - 1];

581 
»cvËn
 = 
	`»cväom
(
»mÙesock_r
, 
»cvbuf
, (
rbuf
è- 
CCN_EMPTY_PDU_LENGTH
,

582 0, &
äom
, &
äomËn
);

583 ià(
İtiÚs
.
loggšg
 > 1) {

584 ià(
äom
.
§_çmy
 =ğ
AF_INET
) {

585 
	`š‘_Áİ
(
AF_INET
, &((
sockaddr_š
 *)&
äom
)->
sš_addr
, 
addrbuf
, (addrbuf));

587 
	`š‘_Áİ
(
AF_INET6
, &((
sockaddr_š6
 *)&
äom
)->
sš6_addr
, 
addrbuf
, (addrbuf));

589 
	`ud¶šk_´št_d©a
(
addrbuf
, 
»cvbuf
, 0, 
»cvËn
, 
İtiÚs
.
loggšg
);

591 ià(
»cvËn
 =ğ(
rbuf
è- 
CCN_EMPTY_PDU_LENGTH
) {

592 
	`ud¶šk_nÙe
("remote…acketoo†arge, discarded\n");

595 ià(
deã¼edËn
 != 0) {

596 
drİ³d_couÁ
++;

597 
drİ³d_by‹s
 +ğ
»cvËn
;

601 
»cvbuf
[
»cvËn
] = 
CCN_EMPTY_PDU
[
CCN_EMPTY_PDU_LENGTH
 - 1];

602 
	`mem£t
(
rd
, 0, (*rd));

603 
d»s
 = 
	`cú_sk–‘Ú_decode
(
rd
, 
rbuf
, 
»cvËn
 + 
CCN_EMPTY_PDU_LENGTH
);

604 ià(
rd
->
¡©e
 !ğ0 || 
d»s
 !ğ(
»cvËn
 + 
CCN_EMPTY_PDU_LENGTH
)) {

605 ià(
»cvËn
 == 1)

606 
	`ud¶šk_nÙe
("remote data…rotocolƒrror (1 byte„ecv):†ikely heartbeat from‡pp sendingo wrong…ort\n");

608 
	`ud¶šk_nÙe
("remote data…rotocolƒrror\n");

612 
»suÉ
 = 
	`£nd
(
loÿlsock_rw
, 
rbuf
, 
»cvËn
 + 
CCN_EMPTY_PDU_LENGTH
, 0);

613 ià(
»suÉ
 == -1) {

614 ià(
”ºo
 =ğ
EAGAIN
) {

619 
fds
[1].
ev’ts
 &ğ~
POLLIN
;

620 
fds
[0].
ev’ts
 |ğ
POLLOUT
;

621 
deã¼edbuf
 = 
	`»®loc
(deã¼edbuf, 
»cvËn
 + 
CCN_EMPTY_PDU_LENGTH
);

622 
deã¼edËn
 = 
»cvËn
 + 
CCN_EMPTY_PDU_LENGTH
;

623 
	`memıy
(
deã¼edbuf
, 
rbuf
, 
deã¼edËn
);

624 ià(
İtiÚs
.
loggšg
 > 1)

625 
	`ud¶šk_nÙe
("£ndtoÖoÿlsock_rw,„buf, %ld): % (deã¼ed)\n", (è
deã¼edËn
, 
	`¡»¼Ü
(
”ºo
));

628 
	`ud¶šk_çl
(
__LINE__
, "£ndtoÖoÿlsock_rw,„buf, %ld): %s\n", (è
»cvËn
 + 
CCN_EMPTY_PDU_LENGTH
, 
	`¡»¼Ü
(
”ºo
));

631 ià(
»suÉ
 !ğ
»cvËn
 + 
CCN_EMPTY_PDU_LENGTH
) {

633 
fds
[0].
ev’ts
 |ğ
POLLOUT
;

634 
deã¼edËn
 = 
»cvËn
 + 
CCN_EMPTY_PDU_LENGTH
 - 
»suÉ
;

635 
deã¼edbuf
 = 
	`»®loc
(deã¼edbuf, 
deã¼edËn
);

636 
	`memıy
(
deã¼edbuf
, 
rbuf
 + 
»suÉ
, 
deã¼edËn
);

637 ià(
İtiÚs
.
loggšg
 > 0)

638 
	`ud¶šk_nÙe
("£ndtoÖoÿlsock_rw,„buf, %ld): % (deã¼ed…¬tŸl)\n", (è
deã¼edËn
, 
	`¡»¼Ü
(
”ºo
));

644 
	`ud¶šk_nÙe
("disconnected\n");

645 
	`cú_de¡roy
(&
cú
);

646 
	`ä“addršfo
(
¿ddršfo
);

647 
	`ä“addršfo
(
Ïddršfo
);

648 ià(
deã¼edbuf
 !ğ
NULL
) {

649 
	`ä“
(
deã¼edbuf
);

650 
deã¼edbuf
 = 
NULL
;

652 
	`ex™
(0);

653 
	}
}

	@
1
.
0
93
1839
ccnd/android_main.c
ccnd/android_msg.c
ccnd/ccnd.c
ccnd/ccnd_internal_client.c
ccnd/ccnd_main.c
ccnd/ccnd_msg.c
ccnd/ccnd_private.h
ccnd/ccnd_stats.c
ccnd/ccndsmoketest.c
cmd/ccn_ccnbtoxml.c
cmd/ccn_splitccnb.c
cmd/ccn_xmltoccnb.c
cmd/ccnbasicconfig.c
cmd/ccnbuzz.c
cmd/ccnbx.c
cmd/ccncat.c
cmd/ccncatchunks.c
cmd/ccncatchunks2.c
cmd/ccndumpnames.c
cmd/ccndumppcap.c
cmd/ccnget.c
cmd/ccnhexdumpdata.c
cmd/ccnls.c
cmd/ccnput.c
cmd/ccnrm.c
cmd/ccnsendchunks.c
cmd/ccnseqwriter.c
cmd/ccnslurp.c
cmd/ccntimefromdatetime.c
cmd/dataresponsetest.c
include/ccn/bloom.h
include/ccn/ccn.h
include/ccn/ccn_private.h
include/ccn/ccnd.h
include/ccn/charbuf.h
include/ccn/coding.h
include/ccn/digest.h
include/ccn/extend_dict.h
include/ccn/face_mgmt.h
include/ccn/hashtb.h
include/ccn/header.h
include/ccn/indexbuf.h
include/ccn/keystore.h
include/ccn/matrix.h
include/ccn/merklepathasn1.h
include/ccn/random.h
include/ccn/reg_mgmt.h
include/ccn/schedule.h
include/ccn/seqwriter.h
include/ccn/signing.h
include/ccn/sockaddrutil.h
include/ccn/sockcreate.h
include/ccn/uri.h
lib/basicparsetest.c
lib/ccn_bloom.c
lib/ccn_buf_decoder.c
lib/ccn_buf_encoder.c
lib/ccn_bulkdata.c
lib/ccn_charbuf.c
lib/ccn_client.c
lib/ccn_coding.c
lib/ccn_digest.c
lib/ccn_dtag_table.c
lib/ccn_extend_dict.c
lib/ccn_face_mgmt.c
lib/ccn_header.c
lib/ccn_indexbuf.c
lib/ccn_interest.c
lib/ccn_keystore.c
lib/ccn_match.c
lib/ccn_matrix.c
lib/ccn_merkle_path_asn1.c
lib/ccn_name_util.c
lib/ccn_reg_mgmt.c
lib/ccn_schedule.c
lib/ccn_seqwriter.c
lib/ccn_setup_sockaddr_un.c
lib/ccn_signing.c
lib/ccn_sockaddrutil.c
lib/ccn_sockcreate.c
lib/ccn_traverse.c
lib/ccn_uri.c
lib/ccn_verifysig.c
lib/ccn_versioning.c
lib/encodedecodetest.c
lib/hashtb.c
lib/hashtbtest.c
lib/matrixtest.c
lib/signbenchtest.c
lib/skel_decode_test.c
lib/smoketestclientlib.c
libexec/ccndc.c
libexec/udplink.c
